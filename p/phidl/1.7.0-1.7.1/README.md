# Comparing `tmp/phidl-1.7.0.tar.gz` & `tmp/phidl-1.7.1.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "phidl-1.7.0.tar", last modified: Tue Apr  9 17:37:42 2024, max compression
+gzip compressed data, was "phidl-1.7.1.tar", last modified: Fri Apr 26 19:32:19 2024, max compression
```

## Comparing `phidl-1.7.0.tar` & `phidl-1.7.1.tar`

### file list

```diff
@@ -1,28 +1,28 @@
-drwxr-xr-x   0 amccaugh   (501) staff       (20)        0 2024-04-09 17:37:42.365909 phidl-1.7.0/
--rw-r--r--   0 amccaugh   (501) staff       (20)     1074 2023-11-07 21:24:35.000000 phidl-1.7.0/LICENSE
--rw-r--r--   0 amccaugh   (501) staff       (20)       16 2023-11-07 21:24:35.000000 phidl-1.7.0/MANIFEST.in
--rw-r--r--   0 amccaugh   (501) staff       (20)     6824 2024-04-09 17:37:42.365797 phidl-1.7.0/PKG-INFO
--rw-r--r--   0 amccaugh   (501) staff       (20)     6641 2024-04-09 17:18:59.000000 phidl-1.7.0/README.md
-drwxr-xr-x   0 amccaugh   (501) staff       (20)        0 2024-04-09 17:37:42.363657 phidl-1.7.0/phidl/
--rw-r--r--   0 amccaugh   (501) staff       (20)      541 2023-11-07 21:24:35.000000 phidl-1.7.0/phidl/__init__.py
--rw-r--r--   0 amccaugh   (501) staff       (20)    38409 2023-11-07 21:24:35.000000 phidl-1.7.0/phidl/constants.py
--rw-r--r--   0 amccaugh   (501) staff       (20)   108173 2024-04-09 17:00:22.000000 phidl-1.7.0/phidl/device_layout.py
--rw-r--r--   0 amccaugh   (501) staff       (20)     8051 2024-04-09 03:53:21.000000 phidl-1.7.0/phidl/font.py
--rw-r--r--   0 amccaugh   (501) staff       (20)   201346 2024-04-09 17:09:17.000000 phidl-1.7.0/phidl/geometry.py
--rw-r--r--   0 amccaugh   (501) staff       (20)    15306 2024-04-09 03:53:21.000000 phidl-1.7.0/phidl/path.py
--rw-r--r--   0 amccaugh   (501) staff       (20)    36526 2024-04-09 16:03:03.000000 phidl-1.7.0/phidl/quickplotter.py
--rw-r--r--   0 amccaugh   (501) staff       (20)    25310 2024-04-09 15:19:38.000000 phidl-1.7.0/phidl/routing.py
--rw-r--r--   0 amccaugh   (501) staff       (20)     8863 2024-04-09 03:53:21.000000 phidl-1.7.0/phidl/utilities.py
-drwxr-xr-x   0 amccaugh   (501) staff       (20)        0 2024-04-09 17:37:42.364370 phidl-1.7.0/phidl.egg-info/
--rw-r--r--   0 amccaugh   (501) staff       (20)     6824 2024-04-09 17:37:42.000000 phidl-1.7.0/phidl.egg-info/PKG-INFO
--rw-r--r--   0 amccaugh   (501) staff       (20)      431 2024-04-09 17:37:42.000000 phidl-1.7.0/phidl.egg-info/SOURCES.txt
--rw-r--r--   0 amccaugh   (501) staff       (20)        1 2024-04-09 17:37:42.000000 phidl-1.7.0/phidl.egg-info/dependency_links.txt
--rw-r--r--   0 amccaugh   (501) staff       (20)       28 2024-04-09 17:37:42.000000 phidl-1.7.0/phidl.egg-info/requires.txt
--rw-r--r--   0 amccaugh   (501) staff       (20)        6 2024-04-09 17:37:42.000000 phidl-1.7.0/phidl.egg-info/top_level.txt
--rw-r--r--   0 amccaugh   (501) staff       (20)       38 2024-04-09 17:37:42.365942 phidl-1.7.0/setup.cfg
--rw-r--r--   0 amccaugh   (501) staff       (20)      765 2024-04-09 16:59:44.000000 phidl-1.7.0/setup.py
-drwxr-xr-x   0 amccaugh   (501) staff       (20)        0 2024-04-09 17:37:42.365482 phidl-1.7.0/tests/
--rw-r--r--   0 amccaugh   (501) staff       (20)    11095 2023-11-07 21:24:35.000000 phidl-1.7.0/tests/test_device.py
--rw-r--r--   0 amccaugh   (501) staff       (20)    11753 2024-04-09 17:30:11.000000 phidl-1.7.0/tests/test_geometry.py
--rw-r--r--   0 amccaugh   (501) staff       (20)     5717 2023-11-07 21:24:35.000000 phidl-1.7.0/tests/test_path.py
--rw-r--r--   0 amccaugh   (501) staff       (20)     5812 2023-11-07 21:24:35.000000 phidl-1.7.0/tests/test_routing.py
+drwxr-xr-x   0 amccaugh   (501) staff       (20)        0 2024-04-26 19:32:19.240963 phidl-1.7.1/
+-rw-r--r--   0 amccaugh   (501) staff       (20)     1074 2023-11-07 21:24:35.000000 phidl-1.7.1/LICENSE
+-rw-r--r--   0 amccaugh   (501) staff       (20)       16 2023-11-07 21:24:35.000000 phidl-1.7.1/MANIFEST.in
+-rw-r--r--   0 amccaugh   (501) staff       (20)     6492 2024-04-26 19:32:19.240852 phidl-1.7.1/PKG-INFO
+-rw-r--r--   0 amccaugh   (501) staff       (20)     6309 2024-04-26 17:50:45.000000 phidl-1.7.1/README.md
+drwxr-xr-x   0 amccaugh   (501) staff       (20)        0 2024-04-26 19:32:19.239000 phidl-1.7.1/phidl/
+-rw-r--r--   0 amccaugh   (501) staff       (20)      567 2024-04-18 14:41:39.000000 phidl-1.7.1/phidl/__init__.py
+-rw-r--r--   0 amccaugh   (501) staff       (20)    38409 2023-11-07 21:24:35.000000 phidl-1.7.1/phidl/constants.py
+-rw-r--r--   0 amccaugh   (501) staff       (20)   111471 2024-04-26 17:50:57.000000 phidl-1.7.1/phidl/device_layout.py
+-rw-r--r--   0 amccaugh   (501) staff       (20)     8051 2024-04-09 03:53:21.000000 phidl-1.7.1/phidl/font.py
+-rw-r--r--   0 amccaugh   (501) staff       (20)   204068 2024-04-26 17:49:39.000000 phidl-1.7.1/phidl/geometry.py
+-rw-r--r--   0 amccaugh   (501) staff       (20)    15306 2024-04-09 03:53:21.000000 phidl-1.7.1/phidl/path.py
+-rw-r--r--   0 amccaugh   (501) staff       (20)    36526 2024-04-20 21:55:49.000000 phidl-1.7.1/phidl/quickplotter.py
+-rw-r--r--   0 amccaugh   (501) staff       (20)    25310 2024-04-09 15:19:38.000000 phidl-1.7.1/phidl/routing.py
+-rw-r--r--   0 amccaugh   (501) staff       (20)     8863 2024-04-09 03:53:21.000000 phidl-1.7.1/phidl/utilities.py
+drwxr-xr-x   0 amccaugh   (501) staff       (20)        0 2024-04-26 19:32:19.239711 phidl-1.7.1/phidl.egg-info/
+-rw-r--r--   0 amccaugh   (501) staff       (20)     6492 2024-04-26 19:32:19.000000 phidl-1.7.1/phidl.egg-info/PKG-INFO
+-rw-r--r--   0 amccaugh   (501) staff       (20)      431 2024-04-26 19:32:19.000000 phidl-1.7.1/phidl.egg-info/SOURCES.txt
+-rw-r--r--   0 amccaugh   (501) staff       (20)        1 2024-04-26 19:32:19.000000 phidl-1.7.1/phidl.egg-info/dependency_links.txt
+-rw-r--r--   0 amccaugh   (501) staff       (20)       28 2024-04-26 19:32:19.000000 phidl-1.7.1/phidl.egg-info/requires.txt
+-rw-r--r--   0 amccaugh   (501) staff       (20)        6 2024-04-26 19:32:19.000000 phidl-1.7.1/phidl.egg-info/top_level.txt
+-rw-r--r--   0 amccaugh   (501) staff       (20)       38 2024-04-26 19:32:19.240999 phidl-1.7.1/setup.cfg
+-rw-r--r--   0 amccaugh   (501) staff       (20)      765 2024-04-26 17:50:52.000000 phidl-1.7.1/setup.py
+drwxr-xr-x   0 amccaugh   (501) staff       (20)        0 2024-04-26 19:32:19.240492 phidl-1.7.1/tests/
+-rw-r--r--   0 amccaugh   (501) staff       (20)    11095 2023-11-07 21:24:35.000000 phidl-1.7.1/tests/test_device.py
+-rw-r--r--   0 amccaugh   (501) staff       (20)    12114 2024-04-18 14:41:39.000000 phidl-1.7.1/tests/test_geometry.py
+-rw-r--r--   0 amccaugh   (501) staff       (20)     5717 2023-11-07 21:24:35.000000 phidl-1.7.1/tests/test_path.py
+-rw-r--r--   0 amccaugh   (501) staff       (20)     5812 2023-11-07 21:24:35.000000 phidl-1.7.1/tests/test_routing.py
```

### Comparing `phidl-1.7.0/LICENSE` & `phidl-1.7.1/LICENSE`

 * *Files identical despite different names*

### Comparing `phidl-1.7.0/PKG-INFO` & `phidl-1.7.1/PKG-INFO`

 * *Files 7% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: phidl
-Version: 1.7.0
+Version: 1.7.1
 Summary: PHIDL
 Author: Adam McCaughan
 Author-email: amccaugh@gmail.com
 Description-Content-Type: text/markdown
 License-File: LICENSE
 
 [![pytest](https://github.com/amccaugh/phidl/actions/workflows/pytest.yml/badge.svg)](https://github.com/amccaugh/phidl/actions/workflows/pytest.yml)
@@ -12,34 +12,32 @@
 
 # PHIDL
 GDS scripting for Python that's intuitive, fast, and powerful.
 
 - [**Installation / requirements**](#installation--requirements)
 - [**Tutorial + examples**](https://phidl.readthedocs.io/en/latest/tutorials.html) (or [try an interactive notebook](https://mybinder.org/v2/gh/amccaugh/phidl/master?filepath=phidl_tutorial_example.ipynb))
 - [**Geometry library + function documentation**](https://phidl.readthedocs.io/en/latest/geometry_reference.html)
-- [Changelog](https://github.com/amccaugh/phidl/blob/master/CHANGELOG.md) (latest update 1.7.0 on April 9, 2024)
--  New KLayout-based boolean/offset/outline functions!  These are under the name `pg.kl_boolean()`, `pg.kl_offset`, `pg.kl_outline()`, `pg.kl_invert()`.  They utilize the excellent KLayout tile processor, which allows breaking down & parallelizing these operations--in a nutshell, these operations should be much, much faster, and they also are more robust than the gdspy/clipper implementation.
--  To use these new functions, you must first `pip install klayout`
+- [Changelog](https://github.com/amccaugh/phidl/blob/master/CHANGELOG.md) (latest update 1.7.1 on April 26, 2024)
+  -  New KLayout-based boolean/offset/outline functions!  These are under the name `pg.kl_boolean()`, `pg.kl_offset`, `pg.kl_outline()`, `pg.kl_invert()`.  They utilize the excellent KLayout tile processor, which allows breaking down & parallelizing these operations--in a nutshell, these operations should be much, much faster, and they also are more robust than the gdspy/clipper implementation. To use these new functions, you must first `pip install klayout`
+  -  `Path.interpolate()` now allows easy placement of objects alongside a path (e.g. for placing vias)
 
 
 # Citation
 
 If you found PHIDL useful, please consider citing it in (just one!) of your publications -- we appreciate it greatly. ([BibTeX](https://raw.githubusercontent.com/amccaugh/phidl/master/CITATION.bib))
  - McCaughan, A. N., et. al. PHIDL: Python-based layout and geometry creation for nanolithography. *J. Vac. Sci. Technol. B* 39, 062601 (2021). http://dx.doi.org/10.1116/6.0001203
 
 # Gallery
 
 <img src="https://amccaugh.github.io/phidl/phidl1.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl2.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl3.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl4.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl5.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl6.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl7.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl8.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl9.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl10.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl11.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl12.png" width="30%"></img>
 
 # Installation / requirements
 - Install or upgrade with `pip install -U phidl`
 - Python version >=3.6
-- If you are on Windows or Mac and don't already have `gdspy` installed, you will need a C++ compiler
-    - For Windows + Python 3, install ["Build Tools for Visual Studio"](https://visualstudio.microsoft.com/downloads/#build-tools-for-visual-studio-2019) (make sure to check the "C++ build tools" checkbox when installing)
-    - For Mac, install "Xcode" from the App Store, then run the command `xcode-select --install` in the terminal
+
 
 # About PHIDL
 
 *fiddle (verb) - /ˈfidl/ - to make minor manual movements, especially to adjust something*
 
 PHIDL is an open-source GDS-based CAD tool for Python that significantly extends the excellent [gdspy](https://github.com/heitzmann/gdspy).  The base installation includes a large library of simple shapes (e.g. rectangles, circles), photonic structures (e.g. sine curve waveguides), and superconducting nanowire shapes (e.g. single photon detectors) that are fully parameterized. It also has a built-in quick-plotting function based on matplotlib (or Qt) that allows you view the state of any GDS object, useful when scripting geometry-making functions. It also has a [__geometry library reference__](https://phidl.readthedocs.io/) and a set of [__very thorough tutorials__](https://phidl.readthedocs.io/en/latest/tutorials.html) that will walk you through the process of getting acquainted with PHIDL.
```

### Comparing `phidl-1.7.0/README.md` & `phidl-1.7.1/phidl.egg-info/PKG-INFO`

 * *Files 5% similar despite different names*

```diff
@@ -1,36 +1,43 @@
+Metadata-Version: 2.1
+Name: phidl
+Version: 1.7.1
+Summary: PHIDL
+Author: Adam McCaughan
+Author-email: amccaugh@gmail.com
+Description-Content-Type: text/markdown
+License-File: LICENSE
+
 [![pytest](https://github.com/amccaugh/phidl/actions/workflows/pytest.yml/badge.svg)](https://github.com/amccaugh/phidl/actions/workflows/pytest.yml)
 [![pre-commit](https://github.com/amccaugh/phidl/actions/workflows/pre-commit.yml/badge.svg)](https://github.com/amccaugh/phidl/actions/workflows/pre-commit.yml)
 
 # PHIDL
 GDS scripting for Python that's intuitive, fast, and powerful.
 
 - [**Installation / requirements**](#installation--requirements)
 - [**Tutorial + examples**](https://phidl.readthedocs.io/en/latest/tutorials.html) (or [try an interactive notebook](https://mybinder.org/v2/gh/amccaugh/phidl/master?filepath=phidl_tutorial_example.ipynb))
 - [**Geometry library + function documentation**](https://phidl.readthedocs.io/en/latest/geometry_reference.html)
-- [Changelog](https://github.com/amccaugh/phidl/blob/master/CHANGELOG.md) (latest update 1.7.0 on April 9, 2024)
--  New KLayout-based boolean/offset/outline functions!  These are under the name `pg.kl_boolean()`, `pg.kl_offset`, `pg.kl_outline()`, `pg.kl_invert()`.  They utilize the excellent KLayout tile processor, which allows breaking down & parallelizing these operations--in a nutshell, these operations should be much, much faster, and they also are more robust than the gdspy/clipper implementation.
--  To use these new functions, you must first `pip install klayout`
+- [Changelog](https://github.com/amccaugh/phidl/blob/master/CHANGELOG.md) (latest update 1.7.1 on April 26, 2024)
+  -  New KLayout-based boolean/offset/outline functions!  These are under the name `pg.kl_boolean()`, `pg.kl_offset`, `pg.kl_outline()`, `pg.kl_invert()`.  They utilize the excellent KLayout tile processor, which allows breaking down & parallelizing these operations--in a nutshell, these operations should be much, much faster, and they also are more robust than the gdspy/clipper implementation. To use these new functions, you must first `pip install klayout`
+  -  `Path.interpolate()` now allows easy placement of objects alongside a path (e.g. for placing vias)
 
 
 # Citation
 
 If you found PHIDL useful, please consider citing it in (just one!) of your publications -- we appreciate it greatly. ([BibTeX](https://raw.githubusercontent.com/amccaugh/phidl/master/CITATION.bib))
  - McCaughan, A. N., et. al. PHIDL: Python-based layout and geometry creation for nanolithography. *J. Vac. Sci. Technol. B* 39, 062601 (2021). http://dx.doi.org/10.1116/6.0001203
 
 # Gallery
 
 <img src="https://amccaugh.github.io/phidl/phidl1.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl2.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl3.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl4.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl5.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl6.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl7.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl8.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl9.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl10.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl11.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl12.png" width="30%"></img>
 
 # Installation / requirements
 - Install or upgrade with `pip install -U phidl`
 - Python version >=3.6
-- If you are on Windows or Mac and don't already have `gdspy` installed, you will need a C++ compiler
-    - For Windows + Python 3, install ["Build Tools for Visual Studio"](https://visualstudio.microsoft.com/downloads/#build-tools-for-visual-studio-2019) (make sure to check the "C++ build tools" checkbox when installing)
-    - For Mac, install "Xcode" from the App Store, then run the command `xcode-select --install` in the terminal
+
 
 # About PHIDL
 
 *fiddle (verb) - /ˈfidl/ - to make minor manual movements, especially to adjust something*
 
 PHIDL is an open-source GDS-based CAD tool for Python that significantly extends the excellent [gdspy](https://github.com/heitzmann/gdspy).  The base installation includes a large library of simple shapes (e.g. rectangles, circles), photonic structures (e.g. sine curve waveguides), and superconducting nanowire shapes (e.g. single photon detectors) that are fully parameterized. It also has a built-in quick-plotting function based on matplotlib (or Qt) that allows you view the state of any GDS object, useful when scripting geometry-making functions. It also has a [__geometry library reference__](https://phidl.readthedocs.io/) and a set of [__very thorough tutorials__](https://phidl.readthedocs.io/en/latest/tutorials.html) that will walk you through the process of getting acquainted with PHIDL.
```

### Comparing `phidl-1.7.0/phidl/__init__.py` & `phidl-1.7.1/phidl/__init__.py`

 * *Files 14% similar despite different names*

```diff
@@ -3,14 +3,15 @@
     Device,
     Group,
     Layer,
     LayerSet,
     Path,
     Port,
     __version__,
+    config,
     make_device,
     reset,
 )
 from phidl.geometry import device_lru_cache
 from phidl.quickplotter import quickplot, quickplot2, set_quickplot_options
 
 __all__ = [
@@ -24,8 +25,9 @@
     "__version__",
     "make_device",
     "reset",
     "device_lru_cache",
     "quickplot",
     "quickplot2",
     "set_quickplot_options",
+    "config",
 ]
```

### Comparing `phidl-1.7.0/phidl/constants.py` & `phidl-1.7.1/phidl/constants.py`

 * *Files identical despite different names*

### Comparing `phidl-1.7.0/phidl/device_layout.py` & `phidl-1.7.1/phidl/device_layout.py`

 * *Files 1% similar despite different names*

```diff
@@ -35,14 +35,15 @@
 
 # ==============================================================================
 # Imports
 # ==============================================================================
 
 
 import hashlib
+import multiprocessing
 import numbers
 import warnings
 from copy import deepcopy as _deepcopy
 
 import gdspy
 
 # Remove this once gdspy fully deprecates current_library
@@ -50,17 +51,19 @@
 import numpy as np
 from numpy import cos, mod, pi, sin, sqrt
 
 from phidl.constants import _CSS3_NAMES_TO_HEX
 
 gdspy.library.use_current_library = False
 
-__version__ = "1.7.0"
+__version__ = "1.7.1"
 
 
+config = dict(NUM_CPU=multiprocessing.cpu_count())
+
 # ==============================================================================
 # Useful transformation functions
 # ==============================================================================
 
 
 def _rotate_points(points, angle=45, center=(0, 0)):
     """Rotates points around a centerpoint defined by ``center``.  ``points``
@@ -198,14 +201,57 @@
     if axis == "y":
         d = (o[0], d[1])
     dx, dy = np.array(d) - o
 
     return dx, dy
 
 
+def _transform_port(
+    point, orientation, origin=(0, 0), rotation=None, x_reflection=False
+):
+    """Applies various transformations to a Port.
+
+    Parameters
+    ----------
+    point : array-like[N][2]
+        Coordinates of the Port.
+    orientation : int, float, or None
+        Orientation of the Port
+    origin : array-like[2] or None
+        If given, shifts the transformed points to the specified origin.
+    rotation : int, float, or None
+        Angle of rotation to apply
+    x_reflection : bool
+        If True, reflects the Port across the x-axis before applying
+        rotation.
+
+    Returns
+    -------
+    new_point : array-like[N][2]
+        Coordinates of the transformed Port.
+    new_orientation : int, float, or None
+
+    """
+    # Apply GDS-type transformations to a port (x_ref)
+    new_point = np.array(point)
+    new_orientation = orientation
+
+    if x_reflection:
+        new_point[1] = -new_point[1]
+        new_orientation = -orientation
+    if rotation is not None:
+        new_point = _rotate_points(new_point, angle=rotation, center=[0, 0])
+        new_orientation += rotation
+    if origin is not None:
+        new_point = new_point + np.array(origin)
+    new_orientation = mod(new_orientation, 360)
+
+    return new_point, new_orientation
+
+
 def _distribute(elements, direction="x", spacing=100, separation=True, edge=None):
     """Takes a list of elements and distributes them either equally along a
     grid or with a fixed spacing between them.
 
     Parameters
     ----------
     elements : array-like of PHIDL objects
@@ -880,14 +926,57 @@
         self.orientation = mod(self.orientation + angle, 360)
         if center is None:
             center = self.midpoint
         self.midpoint = _rotate_points(self.midpoint, angle=angle, center=center)
         return self
 
 
+def _transform_port(
+    point, orientation, origin=(0, 0), rotation=None, x_reflection=False
+):
+    """Applies various transformations to a Port.
+
+    Parameters
+    ----------
+    point : array-like[N][2]
+        Coordinates of the Port.
+    orientation : int, float, or None
+        Orientation of the Port
+    origin : array-like[2] or None
+        If given, shifts the transformed points to the specified origin.
+    rotation : int, float, or None
+        Angle of rotation to apply
+    x_reflection : bool
+        If True, reflects the Port across the x-axis before applying
+        rotation.
+
+    Returns
+    -------
+    new_point : array-like[N][2]
+        Coordinates of the transformed Port.
+    new_orientation : int, float, or None
+
+    """
+    # Apply GDS-type transformations to a port (x_ref)
+    new_point = np.array(point)
+    new_orientation = orientation
+
+    if x_reflection:
+        new_point[1] = -new_point[1]
+        new_orientation = -orientation
+    if rotation is not None:
+        new_point = _rotate_points(new_point, angle=rotation, center=[0, 0])
+        new_orientation += rotation
+    if origin is not None:
+        new_point = new_point + np.array(origin)
+    new_orientation = mod(new_orientation, 360)
+
+    return new_point, new_orientation
+
+
 class Polygon(gdspy.Polygon, _GeometryHelper):
     """Polygonal geometric object.
 
     Parameters
     ----------
     points : array-like[N][2]
         Coordinates of the vertices of the Polygon.
@@ -1652,17 +1741,18 @@
         self.add(reference.parent.paths)
         self.remove(reference)
         return self
 
     def get_ports(self, depth=None):
         """Returns copies of all the ports of the Device, rotated and
         translated so that they're in their top-level position. The Ports
-        returned are copies of the originals, but each copy has the same
-        ``uid`` as the original so that they can be traced back to the
-        original if needed.
+        returned are copies of the originals, but each copy has the same ``uid``
+        as the original so that they can be traced back to the original if
+        needed.  Ports taken from arrays have an additional `array_idx`
+        parameter added to their .info metadata describing the row/column
 
         Parameters
         ----------
         depth : int or None
             If not None, defines from how many reference levels to
             retrieve Ports from.
 
@@ -1676,28 +1766,40 @@
         if depth is None or depth > 0:
             for r in self.references:
                 if depth is None:
                     new_depth = None
                 else:
                     new_depth = depth - 1
                 ref_ports = r.parent.get_ports(depth=new_depth)
+                if isinstance(r, CellArray):
+                    ref_ports_array = []
+                    xs = r.spacing[0]
+                    ys = r.spacing[1]
+                    for i in range(r.rows):
+                        for j in range(r.columns):
+                            for rp in ref_ports:
+                                new_port = rp._copy(new_uid=False)
+                                new_port.midpoint += np.array((xs * j, ys * i))
+                                new_port.info["array_idx"] = (i, j)
+                                ref_ports_array.append(new_port)
+                    ref_ports = ref_ports_array
 
                 # Transform ports that came from a reference
                 ref_ports_transformed = []
                 for rp in ref_ports:
                     new_port = rp._copy(new_uid=False)
-                    new_midpoint, new_orientation = r._transform_port(
+                    new_midpoint, new_orientation = _transform_port(
                         rp.midpoint,
                         rp.orientation,
                         r.origin,
                         r.rotation,
                         r.x_reflection,
                     )
                     new_port.midpoint = new_midpoint
-                    new_port.new_orientation = new_orientation
+                    new_port.orientation = new_orientation
                     ref_ports_transformed.append(new_port)
                 port_list += ref_ports_transformed
 
         return port_list
 
     def get_info(self):
         """Gathers the .info dictionaries from every sub-Device and returns
@@ -2025,15 +2127,15 @@
 
     @property
     def ports(self):
         """This property allows you to access myref.ports, and receive a copy
         of the ports dict which is correctly rotated and translated."""
         for name, port in self.parent.ports.items():
             port = self.parent.ports[name]
-            new_midpoint, new_orientation = self._transform_port(
+            new_midpoint, new_orientation = _transform_port(
                 port.midpoint,
                 port.orientation,
                 self.origin,
                 self.rotation,
                 self.x_reflection,
             )
             if name not in self._local_ports:
@@ -2060,56 +2162,14 @@
     def bbox(self):
         """Returns the bounding box of the DeviceReference."""
         bbox = self.get_bounding_box()
         if bbox is None:
             bbox = ((0, 0), (0, 0))
         return np.array(bbox)
 
-    def _transform_port(
-        self, point, orientation, origin=(0, 0), rotation=None, x_reflection=False
-    ):
-        """Applies various transformations to a Port.
-
-        Parameters
-        ----------
-        point : array-like[N][2]
-            Coordinates of the Port.
-        orientation : int, float, or None
-            Orientation of the Port
-        origin : array-like[2] or None
-            If given, shifts the transformed points to the specified origin.
-        rotation : int, float, or None
-            Angle of rotation to apply
-        x_reflection : bool
-            If True, reflects the Port across the x-axis before applying
-            rotation.
-
-        Returns
-        -------
-        new_point : array-like[N][2]
-            Coordinates of the transformed Port.
-        new_orientation : int, float, or None
-
-        """
-        # Apply GDS-type transformations to a port (x_ref)
-        new_point = np.array(point)
-        new_orientation = orientation
-
-        if x_reflection:
-            new_point[1] = -new_point[1]
-            new_orientation = -orientation
-        if rotation is not None:
-            new_point = _rotate_points(new_point, angle=rotation, center=[0, 0])
-            new_orientation += rotation
-        if origin is not None:
-            new_point = new_point + np.array(origin)
-        new_orientation = mod(new_orientation, 360)
-
-        return new_point, new_orientation
-
     def move(self, origin=(0, 0), destination=None, axis=None):
         """Moves the DeviceReference from the origin point to the
         destination. Both origin and destination can be 1x2 array-like,
         Port, or a key corresponding to one of the Ports in this
         DeviceReference.
 
         Parameters
@@ -2895,14 +2955,53 @@
 
         """
         dx, dy = _parse_move(origin, destination, axis)
         self.points += np.array([dx, dy])
 
         return self
 
+    def interpolate(self, distance, offset=0):
+        """
+        Interpolates points along the length of the Path (with an optional offset)
+        so that it follows the Path centerline plus an offset. Any distance values
+        less than zero or greater than the path length will return NaN
+
+        Parameters
+        ----------
+        distance : float, array-like[N]
+            Distance along the length of the path to interpolate
+        offset : float, array-like[N], callable
+            Magnitude of the offset
+
+        Returns
+        -------
+        points : array-like[N,2]
+            An array of N interpolated (x,y) points
+
+        """
+
+        P = self.copy().offset(offset)
+
+        x = P.points[:, 0]
+        y = P.points[:, 1]
+        dx = np.diff(x)
+        dy = np.diff(y)
+        theta = np.arctan2(dy, dx)
+        theta = np.concatenate([theta, [theta[-1]]])
+        ds = np.sqrt((dx) ** 2 + (dy) ** 2)
+        s = np.cumsum(ds)
+        s = np.concatenate([[0], s])
+
+        interpx = np.interp(distance, s, x, left=np.nan, right=np.nan)
+        interpy = np.interp(distance, s, y, left=np.nan, right=np.nan)
+        interpn = np.interp(distance, s, range(len(x)), left=np.nan, right=np.nan)
+        angle = np.rad2deg(theta[np.floor(interpn).astype(int)])
+
+        return np.vstack([interpx, interpy]).T, angle
+
     def rotate(self, angle=45, center=(0, 0)):
         """Rotates all Polygons in the Device around the specified
         center point. If no center point specified will rotate around (0,0).
 
         Parameters
         ----------
         angle : int or float
```

### Comparing `phidl-1.7.0/phidl/font.py` & `phidl-1.7.1/phidl/font.py`

 * *Files identical despite different names*

### Comparing `phidl-1.7.0/phidl/geometry.py` & `phidl-1.7.1/phidl/geometry.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,12585 +1,12755 @@
-00000000: 696d 706f 7274 2063 6f70 7920 6173 2070  import copy as p
-00000010: 7974 686f 6e5f 636f 7079 0a69 6d70 6f72  ython_copy.impor
-00000020: 7420 6974 6572 746f 6f6c 730a 696d 706f  t itertools.impo
-00000030: 7274 206a 736f 6e0a 696d 706f 7274 206d  rt json.import m
-00000040: 756c 7469 7072 6f63 6573 7369 6e67 0a69  ultiprocessing.i
-00000050: 6d70 6f72 7420 6f73 2e70 6174 680a 696d  mport os.path.im
-00000060: 706f 7274 2070 6963 6b6c 650a 696d 706f  port pickle.impo
-00000070: 7274 2077 6172 6e69 6e67 730a 6672 6f6d  rt warnings.from
-00000080: 2063 6f6c 6c65 6374 696f 6e73 2069 6d70   collections imp
-00000090: 6f72 7420 4f72 6465 7265 6444 6963 740a  ort OrderedDict.
-000000a0: 6672 6f6d 2066 756e 6374 6f6f 6c73 2069  from functools i
-000000b0: 6d70 6f72 7420 7570 6461 7465 5f77 7261  mport update_wra
-000000c0: 7070 6572 0a0a 696d 706f 7274 2067 6473  pper..import gds
-000000d0: 7079 0a69 6d70 6f72 7420 6e75 6d70 7920  py.import numpy 
-000000e0: 6173 206e 700a 6672 6f6d 2067 6473 7079  as np.from gdspy
-000000f0: 2069 6d70 6f72 7420 636c 6970 7065 720a   import clipper.
-00000100: 6672 6f6d 206e 756d 7079 2069 6d70 6f72  from numpy impor
-00000110: 7420 636f 732c 2065 7870 2c20 6c6f 672c  t cos, exp, log,
-00000120: 2070 692c 2073 696e 2c20 7369 6e68 2c20   pi, sin, sinh, 
-00000130: 7371 7274 0a0a 6672 6f6d 2070 6869 646c  sqrt..from phidl
-00000140: 2e63 6f6e 7374 616e 7473 2069 6d70 6f72  .constants impor
-00000150: 7420 5f67 6c79 7068 2c20 5f69 6e64 656e  t _glyph, _inden
-00000160: 742c 205f 7769 6474 680a 6672 6f6d 2070  t, _width.from p
-00000170: 6869 646c 2e64 6576 6963 655f 6c61 796f  hidl.device_layo
-00000180: 7574 2069 6d70 6f72 7420 280a 2020 2020  ut import (.    
-00000190: 4365 6c6c 4172 7261 792c 0a20 2020 2044  CellArray,.    D
-000001a0: 6576 6963 652c 0a20 2020 2044 6576 6963  evice,.    Devic
-000001b0: 6552 6566 6572 656e 6365 2c0a 2020 2020  eReference,.    
-000001c0: 4772 6f75 702c 0a20 2020 2050 6f6c 7967  Group,.    Polyg
-000001d0: 6f6e 2c0a 2020 2020 506f 7274 2c0a 2020  on,.    Port,.  
-000001e0: 2020 5f70 6172 7365 5f6c 6179 6572 2c0a    _parse_layer,.
-000001f0: 2020 2020 6d61 6b65 5f64 6576 6963 652c      make_device,
-00000200: 0a29 0a0a 4e55 4d5f 4350 5520 3d20 6d75  .)..NUM_CPU = mu
-00000210: 6c74 6970 726f 6365 7373 696e 672e 6370  ltiprocessing.cp
-00000220: 755f 636f 756e 7428 290a 0a23 2323 2323  u_count()..#####
-00000230: 2043 6174 6567 6f72 6965 733a 0a23 2050   Categories:.# P
-00000240: 6f6c 7967 6f6e 7320 2f20 7368 6170 6573  olygons / shapes
-00000250: 0a23 2042 6f6f 6c65 616e 2066 756e 6374  .# Boolean funct
-00000260: 696f 6e73 0a23 204c 6974 686f 6772 6170  ions.# Lithograp
-00000270: 6879 2074 6573 7420 7374 7275 6374 7572  hy test structur
-00000280: 6573 0a23 2055 7469 6c69 7479 2066 756e  es.# Utility fun
-00000290: 6374 696f 6e73 2028 636f 7079 696e 672c  ctions (copying,
-000002a0: 2069 6d70 6f72 7469 6e67 2c20 6578 7472   importing, extr
-000002b0: 6163 7469 6e67 290a 2320 5061 6473 0a23  acting).# Pads.#
-000002c0: 2054 6170 6572 0a23 2054 6578 740a 2320   Taper.# Text.# 
-000002d0: 5761 6665 7220 2f20 4469 650a 2320 5761  Wafer / Die.# Wa
-000002e0: 7665 6775 6964 650a 2320 5061 636b 6572  veguide.# Packer
-000002f0: 2074 6f6f 6c20 2f20 4669 6c6c 2074 6f6f   tool / Fill too
-00000300: 6c0a 2320 5068 6f74 6f6e 6963 730a 2320  l.# Photonics.# 
-00000310: 4f70 7469 6d61 6c20 2863 7572 7265 6e74  Optimal (current
-00000320: 2d63 726f 7764 696e 6729 2063 7572 7665  -crowding) curve
-00000330: 730a 2320 5375 7065 7263 6f6e 6475 6374  s.# Superconduct
-00000340: 696e 6720 6465 7669 6365 730a 0a23 203d  ing devices..# =
-00000350: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00000360: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00000370: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000000: 6672 6f6d 205f 5f66 7574 7572 655f 5f20  from __future__ 
+00000010: 696d 706f 7274 2061 6e6e 6f74 6174 696f  import annotatio
+00000020: 6e73 0a0a 696d 706f 7274 2063 6f70 7920  ns..import copy 
+00000030: 6173 2070 7974 686f 6e5f 636f 7079 0a69  as python_copy.i
+00000040: 6d70 6f72 7420 6974 6572 746f 6f6c 730a  mport itertools.
+00000050: 696d 706f 7274 206a 736f 6e0a 696d 706f  import json.impo
+00000060: 7274 206f 732e 7061 7468 0a69 6d70 6f72  rt os.path.impor
+00000070: 7420 7069 636b 6c65 0a69 6d70 6f72 7420  t pickle.import 
+00000080: 7761 726e 696e 6773 0a66 726f 6d20 636f  warnings.from co
+00000090: 6c6c 6563 7469 6f6e 7320 696d 706f 7274  llections import
+000000a0: 204f 7264 6572 6564 4469 6374 0a66 726f   OrderedDict.fro
+000000b0: 6d20 6675 6e63 746f 6f6c 7320 696d 706f  m functools impo
+000000c0: 7274 2075 7064 6174 655f 7772 6170 7065  rt update_wrappe
+000000d0: 720a 0a69 6d70 6f72 7420 6764 7370 790a  r..import gdspy.
+000000e0: 696d 706f 7274 206e 756d 7079 2061 7320  import numpy as 
+000000f0: 6e70 0a66 726f 6d20 6764 7370 7920 696d  np.from gdspy im
+00000100: 706f 7274 2063 6c69 7070 6572 0a66 726f  port clipper.fro
+00000110: 6d20 6e75 6d70 7920 696d 706f 7274 2063  m numpy import c
+00000120: 6f73 2c20 6578 702c 206c 6f67 2c20 7069  os, exp, log, pi
+00000130: 2c20 7369 6e2c 2073 696e 682c 2073 7172  , sin, sinh, sqr
+00000140: 740a 0a66 726f 6d20 7068 6964 6c2e 636f  t..from phidl.co
+00000150: 6e73 7461 6e74 7320 696d 706f 7274 205f  nstants import _
+00000160: 676c 7970 682c 205f 696e 6465 6e74 2c20  glyph, _indent, 
+00000170: 5f77 6964 7468 0a66 726f 6d20 7068 6964  _width.from phid
+00000180: 6c2e 6465 7669 6365 5f6c 6179 6f75 7420  l.device_layout 
+00000190: 696d 706f 7274 2028 0a20 2020 2043 656c  import (.    Cel
+000001a0: 6c41 7272 6179 2c0a 2020 2020 4465 7669  lArray,.    Devi
+000001b0: 6365 2c0a 2020 2020 4465 7669 6365 5265  ce,.    DeviceRe
+000001c0: 6665 7265 6e63 652c 0a20 2020 2047 726f  ference,.    Gro
+000001d0: 7570 2c0a 2020 2020 506f 6c79 676f 6e2c  up,.    Polygon,
+000001e0: 0a20 2020 2050 6f72 742c 0a20 2020 205f  .    Port,.    _
+000001f0: 7061 7273 655f 6c61 7965 722c 0a20 2020  parse_layer,.   
+00000200: 206d 616b 655f 6465 7669 6365 2c0a 290a   make_device,.).
+00000210: 6672 6f6d 2070 6869 646c 2e64 6576 6963  from phidl.devic
+00000220: 655f 6c61 796f 7574 2069 6d70 6f72 7420  e_layout import 
+00000230: 280a 2020 2020 636f 6e66 6967 2061 7320  (.    config as 
+00000240: 7068 6964 6c5f 636f 6e66 6967 2c0a 290a  phidl_config,.).
+00000250: 0a23 2323 2323 2043 6174 6567 6f72 6965  .##### Categorie
+00000260: 733a 0a23 2050 6f6c 7967 6f6e 7320 2f20  s:.# Polygons / 
+00000270: 7368 6170 6573 0a23 2042 6f6f 6c65 616e  shapes.# Boolean
+00000280: 2066 756e 6374 696f 6e73 0a23 204c 6974   functions.# Lit
+00000290: 686f 6772 6170 6879 2074 6573 7420 7374  hography test st
+000002a0: 7275 6374 7572 6573 0a23 2055 7469 6c69  ructures.# Utili
+000002b0: 7479 2066 756e 6374 696f 6e73 2028 636f  ty functions (co
+000002c0: 7079 696e 672c 2069 6d70 6f72 7469 6e67  pying, importing
+000002d0: 2c20 6578 7472 6163 7469 6e67 290a 2320  , extracting).# 
+000002e0: 5061 6473 0a23 2054 6170 6572 0a23 2054  Pads.# Taper.# T
+000002f0: 6578 740a 2320 5761 6665 7220 2f20 4469  ext.# Wafer / Di
+00000300: 650a 2320 5761 7665 6775 6964 650a 2320  e.# Waveguide.# 
+00000310: 5061 636b 6572 2074 6f6f 6c20 2f20 4669  Packer tool / Fi
+00000320: 6c6c 2074 6f6f 6c0a 2320 5068 6f74 6f6e  ll tool.# Photon
+00000330: 6963 730a 2320 4f70 7469 6d61 6c20 2863  ics.# Optimal (c
+00000340: 7572 7265 6e74 2d63 726f 7764 696e 6729  urrent-crowding)
+00000350: 2063 7572 7665 730a 2320 5375 7065 7263   curves.# Superc
+00000360: 6f6e 6475 6374 696e 6720 6465 7669 6365  onducting device
+00000370: 730a 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d  s..# ===========
 00000380: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00000390: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 230a  =============.#.
-000003a0: 2320 506f 6c79 676f 6e73 202f 2053 6861  # Polygons / Sha
-000003b0: 7065 730a 230a 2320 3d3d 3d3d 3d3d 3d3d  pes.#.# ========
-000003c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000003d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000390: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000003a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000003b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000003c0: 3d3d 3d0a 230a 2320 506f 6c79 676f 6e73  ===.#.# Polygons
+000003d0: 202f 2053 6861 7065 730a 230a 2320 3d3d   / Shapes.#.# ==
 000003e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 000003f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00000400: 3d3d 3d3d 3d3d 0a0a 0a64 6566 2072 6563  ======...def rec
-00000410: 7461 6e67 6c65 2873 697a 653d 2834 2c20  tangle(size=(4, 
-00000420: 3229 2c20 6c61 7965 723d 3029 3a0a 2020  2), layer=0):.  
-00000430: 2020 2222 2247 656e 6572 6174 6573 2061    """Generates a
-00000440: 2072 6563 7461 6e67 6c65 2067 656f 6d65   rectangle geome
-00000450: 7472 792e 0a0a 2020 2020 5061 7261 6d65  try...    Parame
-00000460: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-00000470: 2d2d 2d0a 2020 2020 7369 7a65 203a 2074  ---.    size : t
-00000480: 7570 6c65 206f 6620 696e 7420 6f72 2066  uple of int or f
-00000490: 6c6f 6174 0a20 2020 2020 2020 2057 6964  loat.        Wid
-000004a0: 7468 2061 6e64 2068 6569 6768 7420 6f66  th and height of
-000004b0: 2072 6563 7461 6e67 6c65 2e0a 2020 2020   rectangle..    
-000004c0: 6c61 7965 7220 3a20 696e 742c 2061 7272  layer : int, arr
-000004d0: 6179 2d6c 696b 655b 325d 2c20 6f72 2073  ay-like[2], or s
-000004e0: 6574 0a20 2020 2020 2020 2053 7065 6369  et.        Speci
-000004f0: 6669 6320 6c61 7965 7228 7329 2074 6f20  fic layer(s) to 
-00000500: 7075 7420 706f 6c79 676f 6e20 6765 6f6d  put polygon geom
-00000510: 6574 7279 206f 6e2e 0a0a 2020 2020 5265  etry on...    Re
-00000520: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00000530: 2d0a 2020 2020 4420 3a20 4465 7669 6365  -.    D : Device
-00000540: 0a20 2020 2020 2020 2041 2044 6576 6963  .        A Devic
-00000550: 6520 636f 6e74 6169 6e69 6e67 2061 2073  e containing a s
-00000560: 696e 676c 6520 7265 6374 616e 676c 6520  ingle rectangle 
-00000570: 706f 6c79 676f 6e2e 0a20 2020 2022 2222  polygon..    """
-00000580: 0a20 2020 2044 203d 2044 6576 6963 6528  .    D = Device(
-00000590: 6e61 6d65 3d22 7265 6374 616e 676c 6522  name="rectangle"
-000005a0: 290a 2020 2020 706f 696e 7473 203d 205b  ).    points = [
-000005b0: 5b73 697a 655b 305d 2c20 7369 7a65 5b31  [size[0], size[1
-000005c0: 5d5d 2c20 5b73 697a 655b 305d 2c20 305d  ]], [size[0], 0]
-000005d0: 2c20 5b30 2c20 305d 2c20 5b30 2c20 7369  , [0, 0], [0, si
-000005e0: 7a65 5b31 5d5d 5d0a 2020 2020 442e 6164  ze[1]]].    D.ad
-000005f0: 645f 706f 6c79 676f 6e28 706f 696e 7473  d_polygon(points
-00000600: 2c20 6c61 7965 723d 6c61 7965 7229 0a20  , layer=layer). 
-00000610: 2020 2072 6574 7572 6e20 440a 0a0a 6465     return D...de
-00000620: 6620 6262 6f78 2862 626f 783d 5b28 2d31  f bbox(bbox=[(-1
-00000630: 2c20 2d31 292c 2028 332c 2034 295d 2c20  , -1), (3, 4)], 
-00000640: 6c61 7965 723d 3029 3a0a 2020 2020 2222  layer=0):.    ""
-00000650: 2243 7265 6174 6573 2061 2062 6f75 6e64  "Creates a bound
-00000660: 696e 6720 626f 7820 7265 6374 616e 676c  ing box rectangl
-00000670: 6520 6672 6f6d 2063 6f6f 7264 696e 6174  e from coordinat
-00000680: 6573 2c20 746f 2061 6c6c 6f77 0a20 2020  es, to allow.   
-00000690: 2063 7265 6174 696f 6e20 6f66 2061 2072   creation of a r
-000006a0: 6563 7461 6e67 6c65 2062 6f75 6e64 696e  ectangle boundin
-000006b0: 6720 626f 7820 6469 7265 6374 6c79 2066  g box directly f
-000006c0: 6f72 6d20 616e 6f74 6865 7220 7368 6170  orm another shap
-000006d0: 652e 0a0a 2020 2020 5061 7261 6d65 7465  e...    Paramete
-000006e0: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-000006f0: 2d0a 2020 2020 6262 6f78 203a 206c 6973  -.    bbox : lis
-00000700: 7420 6f66 2074 7570 6c65 7320 6f66 2069  t of tuples of i
-00000710: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
-00000720: 2020 2020 436f 6f72 6469 6e61 7465 7320      Coordinates 
-00000730: 6f66 2074 6865 2062 6f78 205b 2878 312c  of the box [(x1,
-00000740: 2079 3129 2c20 2878 322c 2079 3229 5d2e   y1), (x2, y2)].
-00000750: 0a20 2020 206c 6179 6572 203a 2069 6e74  .    layer : int
-00000760: 2c20 6172 7261 792d 6c69 6b65 5b32 5d2c  , array-like[2],
-00000770: 206f 7220 7365 740a 2020 2020 2020 2020   or set.        
-00000780: 5370 6563 6966 6963 206c 6179 6572 2873  Specific layer(s
-00000790: 2920 746f 2070 7574 2070 6f6c 7967 6f6e  ) to put polygon
-000007a0: 2067 656f 6d65 7472 7920 6f6e 2e0a 0a20   geometry on... 
-000007b0: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
-000007c0: 2d2d 2d2d 2d2d 0a20 2020 2044 203a 2044  ------.    D : D
-000007d0: 6576 6963 650a 2020 2020 2020 2020 4120  evice.        A 
-000007e0: 4465 7669 6365 2063 6f6e 7461 696e 696e  Device containin
-000007f0: 6720 6120 7369 6e67 6c65 2072 6563 7461  g a single recta
-00000800: 6e67 6c65 2070 6f6c 7967 6f6e 2e0a 0a20  ngle polygon... 
-00000810: 2020 2045 7861 6d70 6c65 730a 2020 2020     Examples.    
-00000820: 2d2d 2d2d 2d2d 2d2d 0a20 2020 203e 3e3e  --------.    >>>
-00000830: 2044 203d 2070 672e 6262 6f78 2861 6e6f   D = pg.bbox(ano
-00000840: 7468 6572 7368 6170 652e 6262 6f78 290a  thershape.bbox).
-00000850: 2020 2020 2222 220a 2020 2020 4420 3d20      """.    D = 
-00000860: 4465 7669 6365 286e 616d 653d 2262 626f  Device(name="bbo
-00000870: 7822 290a 2020 2020 2861 2c20 6229 2c20  x").    (a, b), 
-00000880: 2863 2c20 6429 203d 2062 626f 780a 2020  (c, d) = bbox.  
-00000890: 2020 706f 696e 7473 203d 2028 2861 2c20    points = ((a, 
-000008a0: 6229 2c20 2863 2c20 6229 2c20 2863 2c20  b), (c, b), (c, 
-000008b0: 6429 2c20 2861 2c20 6429 290a 2020 2020  d), (a, d)).    
-000008c0: 442e 6164 645f 706f 6c79 676f 6e28 706f  D.add_polygon(po
-000008d0: 696e 7473 2c20 6c61 7965 723d 6c61 7965  ints, layer=laye
-000008e0: 7229 0a20 2020 2072 6574 7572 6e20 440a  r).    return D.
-000008f0: 0a0a 6465 6620 6372 6f73 7328 6c65 6e67  ..def cross(leng
-00000900: 7468 3d31 302c 2077 6964 7468 3d33 2c20  th=10, width=3, 
-00000910: 6c61 7965 723d 3029 3a0a 2020 2020 2222  layer=0):.    ""
-00000920: 2247 656e 6572 6174 6573 2061 2072 6967  "Generates a rig
-00000930: 6874 2d61 6e67 6c65 2063 726f 7373 2028  ht-angle cross (
-00000940: 2b20 7368 6170 652c 2073 796d 6d65 7472  + shape, symmetr
-00000950: 6963 2920 6672 6f6d 2074 776f 0a20 2020  ic) from two.   
-00000960: 2072 6563 7461 6e67 6c65 7320 6f66 2073   rectangles of s
-00000970: 7065 6369 6669 6564 206c 656e 6774 6820  pecified length 
-00000980: 616e 6420 7769 6474 682e 0a0a 2020 2020  and width...    
-00000990: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-000009a0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6c65  ---------.    le
-000009b0: 6e67 7468 203a 2069 6e74 206f 7220 666c  ngth : int or fl
-000009c0: 6f61 740a 2020 2020 2020 2020 4c65 6e67  oat.        Leng
-000009d0: 7468 206f 6620 7468 6520 6372 6f73 7320  th of the cross 
-000009e0: 6672 6f6d 206f 6e65 2065 6e64 2074 6f20  from one end to 
-000009f0: 7468 6520 6f74 6865 722e 0a20 2020 2077  the other..    w
-00000a00: 6964 7468 203a 2069 6e74 206f 7220 666c  idth : int or fl
-00000a10: 6f61 740a 2020 2020 2020 2020 5769 6474  oat.        Widt
-00000a20: 6820 6f66 2074 6865 2061 726d 7320 6f66  h of the arms of
-00000a30: 2074 6865 2063 726f 7373 2e0a 2020 2020   the cross..    
-00000a40: 6c61 7965 7220 3a20 696e 742c 2061 7272  layer : int, arr
-00000a50: 6179 2d6c 696b 655b 325d 2c20 6f72 2073  ay-like[2], or s
-00000a60: 6574 0a20 2020 2020 2020 2053 7065 6369  et.        Speci
-00000a70: 6669 6320 6c61 7965 7228 7329 2074 6f20  fic layer(s) to 
-00000a80: 7075 7420 706f 6c79 676f 6e20 6765 6f6d  put polygon geom
-00000a90: 6574 7279 206f 6e2e 0a0a 2020 2020 5265  etry on...    Re
-00000aa0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00000ab0: 2d0a 2020 2020 443a 2044 6576 6963 650a  -.    D: Device.
-00000ac0: 2020 2020 2020 2020 4120 4465 7669 6365          A Device
-00000ad0: 2063 6f6e 7461 696e 696e 6720 6120 6372   containing a cr
-00000ae0: 6f73 7320 706f 6c79 676f 6e2e 0a20 2020  oss polygon..   
-00000af0: 2022 2222 0a20 2020 2044 203d 2044 6576   """.    D = Dev
-00000b00: 6963 6528 6e61 6d65 3d22 6372 6f73 7322  ice(name="cross"
-00000b10: 290a 2020 2020 5220 3d20 7265 6374 616e  ).    R = rectan
-00000b20: 676c 6528 7369 7a65 3d28 7769 6474 682c  gle(size=(width,
-00000b30: 206c 656e 6774 6829 2c20 6c61 7965 723d   length), layer=
-00000b40: 6c61 7965 7229 0a20 2020 2072 3120 3d20  layer).    r1 = 
-00000b50: 442e 6164 645f 7265 6628 5229 2e72 6f74  D.add_ref(R).rot
-00000b60: 6174 6528 3930 290a 2020 2020 7232 203d  ate(90).    r2 =
-00000b70: 2044 2e61 6464 5f72 6566 2852 290a 2020   D.add_ref(R).  
-00000b80: 2020 7231 2e63 656e 7465 7220 3d20 2830    r1.center = (0
-00000b90: 2c20 3029 0a20 2020 2072 322e 6365 6e74  , 0).    r2.cent
-00000ba0: 6572 203d 2028 302c 2030 290a 2020 2020  er = (0, 0).    
-00000bb0: 7265 7475 726e 2044 0a0a 0a64 6566 2065  return D...def e
-00000bc0: 6c6c 6970 7365 2872 6164 6969 3d28 3130  llipse(radii=(10
-00000bd0: 2c20 3529 2c20 616e 676c 655f 7265 736f  , 5), angle_reso
-00000be0: 6c75 7469 6f6e 3d32 2e35 2c20 6c61 7965  lution=2.5, laye
-00000bf0: 723d 3029 3a0a 2020 2020 2222 2247 656e  r=0):.    """Gen
-00000c00: 6572 6174 6573 2061 6e20 656c 6c69 7073  erates an ellips
-00000c10: 6520 6765 6f6d 6574 7279 2e0a 0a20 2020  e geometry...   
-00000c20: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-00000c30: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2072  ----------.    r
-00000c40: 6164 6969 203a 2074 7570 6c65 206f 6620  adii : tuple of 
-00000c50: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
-00000c60: 2020 2020 2053 656d 696d 616a 6f72 2028       Semimajor (
-00000c70: 7829 2061 6e64 2073 656d 696d 696e 6f72  x) and semiminor
-00000c80: 2028 7929 2061 7869 7320 6c65 6e67 7468   (y) axis length
-00000c90: 7320 6f66 2074 6865 2065 6c6c 6970 7365  s of the ellipse
-00000ca0: 2e0a 2020 2020 616e 676c 655f 7265 736f  ..    angle_reso
-00000cb0: 6c75 7469 6f6e 203a 2069 6e74 206f 7220  lution : int or 
-00000cc0: 666c 6f61 740a 2020 2020 2020 2020 5265  float.        Re
-00000cd0: 736f 6c75 7469 6f6e 206f 6620 7468 6520  solution of the 
-00000ce0: 6375 7276 6520 6f66 2074 6865 2072 696e  curve of the rin
-00000cf0: 6720 2823 206f 6620 6465 6772 6565 7320  g (# of degrees 
-00000d00: 7065 7220 706f 696e 7429 2e0a 2020 2020  per point)..    
-00000d10: 6c61 7965 7220 3a20 696e 742c 2061 7272  layer : int, arr
-00000d20: 6179 2d6c 696b 655b 325d 2c20 6f72 2073  ay-like[2], or s
-00000d30: 6574 0a20 2020 2020 2020 2053 7065 6369  et.        Speci
-00000d40: 6669 6320 6c61 7965 7228 7329 2074 6f20  fic layer(s) to 
-00000d50: 7075 7420 706f 6c79 676f 6e20 6765 6f6d  put polygon geom
-00000d60: 6574 7279 206f 6e2e 0a0a 2020 2020 5265  etry on...    Re
-00000d70: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00000d80: 2d0a 2020 2020 4420 3a20 4465 7669 6365  -.    D : Device
-00000d90: 0a20 2020 2020 2020 2041 2044 6576 6963  .        A Devic
-00000da0: 6520 636f 6e74 6169 6e69 6e67 2061 6e20  e containing an 
-00000db0: 656c 6c69 7073 6520 706f 6c79 676f 6e2e  ellipse polygon.
-00000dc0: 0a20 2020 2022 2222 0a20 2020 2044 203d  .    """.    D =
-00000dd0: 2044 6576 6963 6528 6e61 6d65 3d22 656c   Device(name="el
-00000de0: 6c69 7073 6522 290a 2020 2020 6120 3d20  lipse").    a = 
-00000df0: 7261 6469 695b 305d 0a20 2020 2062 203d  radii[0].    b =
-00000e00: 2072 6164 6969 5b31 5d0a 2020 2020 7420   radii[1].    t 
-00000e10: 3d20 6e70 2e6c 696e 7370 6163 6528 302c  = np.linspace(0,
-00000e20: 2033 3630 2c20 696e 7428 6e70 2e63 6569   360, int(np.cei
-00000e30: 6c28 3336 3020 2f20 616e 676c 655f 7265  l(360 / angle_re
-00000e40: 736f 6c75 7469 6f6e 2920 2b20 3129 2920  solution) + 1)) 
-00000e50: 2a20 7069 202f 2031 3830 0a20 2020 2072  * pi / 180.    r
-00000e60: 203d 2061 202a 2062 202f 2028 7371 7274   = a * b / (sqrt
-00000e70: 2828 6220 2a20 636f 7328 7429 2920 2a2a  ((b * cos(t)) **
-00000e80: 2032 202b 2028 6120 2a20 7369 6e28 7429   2 + (a * sin(t)
-00000e90: 2920 2a2a 2032 2929 0a20 2020 2078 7074  ) ** 2)).    xpt
-00000ea0: 7320 3d20 7220 2a20 636f 7328 7429 0a20  s = r * cos(t). 
-00000eb0: 2020 2079 7074 7320 3d20 7220 2a20 7369     ypts = r * si
-00000ec0: 6e28 7429 0a20 2020 2044 2e61 6464 5f70  n(t).    D.add_p
-00000ed0: 6f6c 7967 6f6e 2870 6f69 6e74 733d 2878  olygon(points=(x
-00000ee0: 7074 732c 2079 7074 7329 2c20 6c61 7965  pts, ypts), laye
-00000ef0: 723d 6c61 7965 7229 0a20 2020 2072 6574  r=layer).    ret
-00000f00: 7572 6e20 440a 0a0a 6465 6620 6369 7263  urn D...def circ
-00000f10: 6c65 2872 6164 6975 733d 3130 2c20 616e  le(radius=10, an
-00000f20: 676c 655f 7265 736f 6c75 7469 6f6e 3d32  gle_resolution=2
-00000f30: 2e35 2c20 6c61 7965 723d 3029 3a0a 2020  .5, layer=0):.  
-00000f40: 2020 2222 2247 656e 6572 6174 6573 2061    """Generates a
-00000f50: 2063 6972 636c 6520 6765 6f6d 6574 7279   circle geometry
-00000f60: 2e0a 0a20 2020 2050 6172 616d 6574 6572  ...    Parameter
-00000f70: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-00000f80: 0a20 2020 2072 6164 6975 7320 3a20 696e  .    radius : in
-00000f90: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
-00000fa0: 2020 2052 6164 6975 7320 6f66 2074 6865     Radius of the
-00000fb0: 2063 6972 636c 652e 0a20 2020 2061 6e67   circle..    ang
-00000fc0: 6c65 5f72 6573 6f6c 7574 696f 6e20 3a20  le_resolution : 
-00000fd0: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
-00000fe0: 2020 2020 2052 6573 6f6c 7574 696f 6e20       Resolution 
-00000ff0: 6f66 2074 6865 2063 7572 7665 206f 6620  of the curve of 
-00001000: 7468 6520 7269 6e67 2028 2320 6f66 2064  the ring (# of d
-00001010: 6567 7265 6573 2070 6572 2070 6f69 6e74  egrees per point
-00001020: 292e 0a20 2020 206c 6179 6572 203a 2069  )..    layer : i
-00001030: 6e74 2c20 6172 7261 792d 6c69 6b65 5b32  nt, array-like[2
-00001040: 5d2c 206f 7220 7365 740a 2020 2020 2020  ], or set.      
-00001050: 2020 5370 6563 6966 6963 206c 6179 6572    Specific layer
-00001060: 2873 2920 746f 2070 7574 2070 6f6c 7967  (s) to put polyg
-00001070: 6f6e 2067 656f 6d65 7472 7920 6f6e 2e0a  on geometry on..
-00001080: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
-00001090: 202d 2d2d 2d2d 2d2d 0a20 2020 2044 203a   -------.    D :
-000010a0: 2044 6576 6963 650a 2020 2020 2020 2020   Device.        
-000010b0: 4120 4465 7669 6365 2063 6f6e 7461 696e  A Device contain
-000010c0: 696e 6720 6120 6369 7263 6c65 2070 6f6c  ing a circle pol
-000010d0: 7967 6f6e 2e0a 2020 2020 2222 220a 2020  ygon..    """.  
-000010e0: 2020 4420 3d20 4465 7669 6365 286e 616d    D = Device(nam
-000010f0: 653d 2263 6972 636c 6522 290a 2020 2020  e="circle").    
-00001100: 7420 3d20 6e70 2e6c 696e 7370 6163 6528  t = np.linspace(
-00001110: 302c 2033 3630 2c20 696e 7428 6e70 2e63  0, 360, int(np.c
-00001120: 6569 6c28 3336 3020 2f20 616e 676c 655f  eil(360 / angle_
-00001130: 7265 736f 6c75 7469 6f6e 2920 2b20 3129  resolution) + 1)
-00001140: 2920 2a20 7069 202f 2031 3830 0a20 2020  ) * pi / 180.   
-00001150: 2078 7074 7320 3d20 2872 6164 6975 7320   xpts = (radius 
-00001160: 2a20 636f 7328 7429 292e 746f 6c69 7374  * cos(t)).tolist
-00001170: 2829 0a20 2020 2079 7074 7320 3d20 2872  ().    ypts = (r
-00001180: 6164 6975 7320 2a20 7369 6e28 7429 292e  adius * sin(t)).
-00001190: 746f 6c69 7374 2829 0a20 2020 2044 2e61  tolist().    D.a
-000011a0: 6464 5f70 6f6c 7967 6f6e 2870 6f69 6e74  dd_polygon(point
-000011b0: 733d 2878 7074 732c 2079 7074 7329 2c20  s=(xpts, ypts), 
-000011c0: 6c61 7965 723d 6c61 7965 7229 0a20 2020  layer=layer).   
-000011d0: 2072 6574 7572 6e20 440a 0a0a 6465 6620   return D...def 
-000011e0: 7269 6e67 2872 6164 6975 733d 3130 2c20  ring(radius=10, 
-000011f0: 7769 6474 683d 302e 352c 2061 6e67 6c65  width=0.5, angle
-00001200: 5f72 6573 6f6c 7574 696f 6e3d 322e 352c  _resolution=2.5,
-00001210: 206c 6179 6572 3d30 293a 0a20 2020 2022   layer=0):.    "
-00001220: 2222 4765 6e65 7261 7465 7320 6120 7269  ""Generates a ri
-00001230: 6e67 2067 656f 6d65 7472 792e 0a0a 2020  ng geometry...  
-00001240: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-00001250: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-00001260: 7261 6469 7573 203a 2069 6e74 206f 7220  radius : int or 
-00001270: 666c 6f61 740a 2020 2020 2020 2020 5261  float.        Ra
-00001280: 6469 7573 206f 6620 7468 6520 7269 6e67  dius of the ring
-00001290: 2063 656e 7465 726c 696e 650a 2020 2020   centerline.    
-000012a0: 7769 6474 6820 3a20 696e 7420 6f72 2066  width : int or f
-000012b0: 6c6f 6174 0a20 2020 2020 2020 2057 6964  loat.        Wid
-000012c0: 7468 206f 6620 7468 6520 7269 6e67 2e0a  th of the ring..
-000012d0: 2020 2020 616e 676c 655f 7265 736f 6c75      angle_resolu
-000012e0: 7469 6f6e 203a 2069 6e74 206f 7220 666c  tion : int or fl
-000012f0: 6f61 740a 2020 2020 2020 2020 5265 736f  oat.        Reso
-00001300: 6c75 7469 6f6e 206f 6620 7468 6520 6375  lution of the cu
-00001310: 7276 6520 6f66 2074 6865 2072 696e 6720  rve of the ring 
-00001320: 2823 206f 6620 6465 6772 6565 7320 7065  (# of degrees pe
-00001330: 7220 706f 696e 7429 2e0a 2020 2020 6c61  r point)..    la
-00001340: 7965 7220 3a0a 2020 2020 2020 2020 5370  yer :.        Sp
-00001350: 6563 6966 6963 206c 6179 6572 2873 2920  ecific layer(s) 
-00001360: 746f 2070 7574 2070 6f6c 7967 6f6e 2067  to put polygon g
-00001370: 656f 6d65 7472 7920 6f6e 2e0a 0a20 2020  eometry on...   
-00001380: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
-00001390: 2d2d 2d2d 0a20 2020 2044 203a 2044 6576  ----.    D : Dev
-000013a0: 6963 650a 2020 2020 2020 2020 4120 4465  ice.        A De
-000013b0: 7669 6365 2063 6f6e 7461 696e 696e 6720  vice containing 
-000013c0: 6120 7269 6e67 2070 6f6c 7967 6f6e 2e0a  a ring polygon..
-000013d0: 0a20 2020 204e 6f74 6573 0a20 2020 202d  .    Notes.    -
-000013e0: 2d2d 2d2d 0a20 2020 2054 6865 2072 696e  ----.    The rin
-000013f0: 6720 6973 2066 6f72 6d65 6420 6279 2074  g is formed by t
-00001400: 616b 696e 6720 7468 6520 7261 6469 7573  aking the radius
-00001410: 206f 7574 2074 6f20 7468 6520 7370 6563   out to the spec
-00001420: 6966 6965 6420 7661 6c75 652c 2061 6e64  ified value, and
-00001430: 0a20 2020 2074 6865 6e20 636f 6e73 7472  .    then constr
-00001440: 7563 7469 6e67 2074 6865 2074 6869 636b  ucting the thick
-00001450: 6e65 7373 2062 7920 6469 7669 6469 6e67  ness by dividing
-00001460: 2074 6865 2077 6964 7468 2069 6e20 6861   the width in ha
-00001470: 6c66 2061 6e64 2061 6464 696e 670a 2020  lf and adding.  
-00001480: 2020 7468 6174 2076 616c 7565 2074 6f20    that value to 
-00001490: 6569 7468 6572 2073 6964 6520 6f66 2074  either side of t
-000014a0: 6865 2072 6164 6975 732e 0a0a 2020 2020  he radius...    
-000014b0: 5468 6520 616e 676c 655f 7265 736f 6c75  The angle_resolu
-000014c0: 7469 6f6e 2061 6c74 6572 7320 7468 6520  tion alters the 
-000014d0: 7072 6563 6973 696f 6e20 6f66 2074 6865  precision of the
-000014e0: 2063 7572 7665 206f 6620 7468 6520 7269   curve of the ri
-000014f0: 6e67 2e20 4c61 7267 6572 0a20 2020 2076  ng. Larger.    v
-00001500: 616c 7565 7320 7969 656c 6420 6c6f 7765  alues yield lowe
-00001510: 7220 7265 736f 6c75 7469 6f6e 2e0a 2020  r resolution..  
-00001520: 2020 2222 220a 2020 2020 4420 3d20 4465    """.    D = De
-00001530: 7669 6365 286e 616d 653d 2272 696e 6722  vice(name="ring"
-00001540: 290a 2020 2020 696e 6e65 725f 7261 6469  ).    inner_radi
-00001550: 7573 203d 2072 6164 6975 7320 2d20 7769  us = radius - wi
-00001560: 6474 6820 2f20 320a 2020 2020 6f75 7465  dth / 2.    oute
+00000400: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000410: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000420: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a 0a64  ============...d
+00000430: 6566 2072 6563 7461 6e67 6c65 2873 697a  ef rectangle(siz
+00000440: 653d 2834 2c20 3229 2c20 6c61 7965 723d  e=(4, 2), layer=
+00000450: 3029 3a0a 2020 2020 2222 2247 656e 6572  0):.    """Gener
+00000460: 6174 6573 2061 2072 6563 7461 6e67 6c65  ates a rectangle
+00000470: 2067 656f 6d65 7472 792e 0a0a 2020 2020   geometry...    
+00000480: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+00000490: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7369  ---------.    si
+000004a0: 7a65 203a 2074 7570 6c65 206f 6620 696e  ze : tuple of in
+000004b0: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
+000004c0: 2020 2057 6964 7468 2061 6e64 2068 6569     Width and hei
+000004d0: 6768 7420 6f66 2072 6563 7461 6e67 6c65  ght of rectangle
+000004e0: 2e0a 2020 2020 6c61 7965 7220 3a20 696e  ..    layer : in
+000004f0: 742c 2061 7272 6179 2d6c 696b 655b 325d  t, array-like[2]
+00000500: 2c20 6f72 2073 6574 0a20 2020 2020 2020  , or set.       
+00000510: 2053 7065 6369 6669 6320 6c61 7965 7228   Specific layer(
+00000520: 7329 2074 6f20 7075 7420 706f 6c79 676f  s) to put polygo
+00000530: 6e20 6765 6f6d 6574 7279 206f 6e2e 0a0a  n geometry on...
+00000540: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00000550: 2d2d 2d2d 2d2d 2d0a 2020 2020 4420 3a20  -------.    D : 
+00000560: 4465 7669 6365 0a20 2020 2020 2020 2041  Device.        A
+00000570: 2044 6576 6963 6520 636f 6e74 6169 6e69   Device containi
+00000580: 6e67 2061 2073 696e 676c 6520 7265 6374  ng a single rect
+00000590: 616e 676c 6520 706f 6c79 676f 6e2e 0a20  angle polygon.. 
+000005a0: 2020 2022 2222 0a20 2020 2044 203d 2044     """.    D = D
+000005b0: 6576 6963 6528 6e61 6d65 3d22 7265 6374  evice(name="rect
+000005c0: 616e 676c 6522 290a 2020 2020 706f 696e  angle").    poin
+000005d0: 7473 203d 205b 5b73 697a 655b 305d 2c20  ts = [[size[0], 
+000005e0: 7369 7a65 5b31 5d5d 2c20 5b73 697a 655b  size[1]], [size[
+000005f0: 305d 2c20 305d 2c20 5b30 2c20 305d 2c20  0], 0], [0, 0], 
+00000600: 5b30 2c20 7369 7a65 5b31 5d5d 5d0a 2020  [0, size[1]]].  
+00000610: 2020 442e 6164 645f 706f 6c79 676f 6e28    D.add_polygon(
+00000620: 706f 696e 7473 2c20 6c61 7965 723d 6c61  points, layer=la
+00000630: 7965 7229 0a20 2020 2072 6574 7572 6e20  yer).    return 
+00000640: 440a 0a0a 6465 6620 6262 6f78 2862 626f  D...def bbox(bbo
+00000650: 783d 5b28 2d31 2c20 2d31 292c 2028 332c  x=[(-1, -1), (3,
+00000660: 2034 295d 2c20 6c61 7965 723d 3029 3a0a   4)], layer=0):.
+00000670: 2020 2020 2222 2243 7265 6174 6573 2061      """Creates a
+00000680: 2062 6f75 6e64 696e 6720 626f 7820 7265   bounding box re
+00000690: 6374 616e 676c 6520 6672 6f6d 2063 6f6f  ctangle from coo
+000006a0: 7264 696e 6174 6573 2c20 746f 2061 6c6c  rdinates, to all
+000006b0: 6f77 0a20 2020 2063 7265 6174 696f 6e20  ow.    creation 
+000006c0: 6f66 2061 2072 6563 7461 6e67 6c65 2062  of a rectangle b
+000006d0: 6f75 6e64 696e 6720 626f 7820 6469 7265  ounding box dire
+000006e0: 6374 6c79 2066 6f72 6d20 616e 6f74 6865  ctly form anothe
+000006f0: 7220 7368 6170 652e 0a0a 2020 2020 5061  r shape...    Pa
+00000700: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00000710: 2d2d 2d2d 2d2d 2d0a 2020 2020 6262 6f78  -------.    bbox
+00000720: 203a 206c 6973 7420 6f66 2074 7570 6c65   : list of tuple
+00000730: 7320 6f66 2069 6e74 206f 7220 666c 6f61  s of int or floa
+00000740: 740a 2020 2020 2020 2020 436f 6f72 6469  t.        Coordi
+00000750: 6e61 7465 7320 6f66 2074 6865 2062 6f78  nates of the box
+00000760: 205b 2878 312c 2079 3129 2c20 2878 322c   [(x1, y1), (x2,
+00000770: 2079 3229 5d2e 0a20 2020 206c 6179 6572   y2)]..    layer
+00000780: 203a 2069 6e74 2c20 6172 7261 792d 6c69   : int, array-li
+00000790: 6b65 5b32 5d2c 206f 7220 7365 740a 2020  ke[2], or set.  
+000007a0: 2020 2020 2020 5370 6563 6966 6963 206c        Specific l
+000007b0: 6179 6572 2873 2920 746f 2070 7574 2070  ayer(s) to put p
+000007c0: 6f6c 7967 6f6e 2067 656f 6d65 7472 7920  olygon geometry 
+000007d0: 6f6e 2e0a 0a20 2020 2052 6574 7572 6e73  on...    Returns
+000007e0: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+000007f0: 2044 203a 2044 6576 6963 650a 2020 2020   D : Device.    
+00000800: 2020 2020 4120 4465 7669 6365 2063 6f6e      A Device con
+00000810: 7461 696e 696e 6720 6120 7369 6e67 6c65  taining a single
+00000820: 2072 6563 7461 6e67 6c65 2070 6f6c 7967   rectangle polyg
+00000830: 6f6e 2e0a 0a20 2020 2045 7861 6d70 6c65  on...    Example
+00000840: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20  s.    --------. 
+00000850: 2020 203e 3e3e 2044 203d 2070 672e 6262     >>> D = pg.bb
+00000860: 6f78 2861 6e6f 7468 6572 7368 6170 652e  ox(anothershape.
+00000870: 6262 6f78 290a 2020 2020 2222 220a 2020  bbox).    """.  
+00000880: 2020 4420 3d20 4465 7669 6365 286e 616d    D = Device(nam
+00000890: 653d 2262 626f 7822 290a 2020 2020 2861  e="bbox").    (a
+000008a0: 2c20 6229 2c20 2863 2c20 6429 203d 2062  , b), (c, d) = b
+000008b0: 626f 780a 2020 2020 706f 696e 7473 203d  box.    points =
+000008c0: 2028 2861 2c20 6229 2c20 2863 2c20 6229   ((a, b), (c, b)
+000008d0: 2c20 2863 2c20 6429 2c20 2861 2c20 6429  , (c, d), (a, d)
+000008e0: 290a 2020 2020 442e 6164 645f 706f 6c79  ).    D.add_poly
+000008f0: 676f 6e28 706f 696e 7473 2c20 6c61 7965  gon(points, laye
+00000900: 723d 6c61 7965 7229 0a20 2020 2072 6574  r=layer).    ret
+00000910: 7572 6e20 440a 0a0a 6465 6620 6372 6f73  urn D...def cros
+00000920: 7328 6c65 6e67 7468 3d31 302c 2077 6964  s(length=10, wid
+00000930: 7468 3d33 2c20 6c61 7965 723d 3029 3a0a  th=3, layer=0):.
+00000940: 2020 2020 2222 2247 656e 6572 6174 6573      """Generates
+00000950: 2061 2072 6967 6874 2d61 6e67 6c65 2063   a right-angle c
+00000960: 726f 7373 2028 2b20 7368 6170 652c 2073  ross (+ shape, s
+00000970: 796d 6d65 7472 6963 2920 6672 6f6d 2074  ymmetric) from t
+00000980: 776f 0a20 2020 2072 6563 7461 6e67 6c65  wo.    rectangle
+00000990: 7320 6f66 2073 7065 6369 6669 6564 206c  s of specified l
+000009a0: 656e 6774 6820 616e 6420 7769 6474 682e  ength and width.
+000009b0: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+000009c0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+000009d0: 2020 2020 6c65 6e67 7468 203a 2069 6e74      length : int
+000009e0: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
+000009f0: 2020 4c65 6e67 7468 206f 6620 7468 6520    Length of the 
+00000a00: 6372 6f73 7320 6672 6f6d 206f 6e65 2065  cross from one e
+00000a10: 6e64 2074 6f20 7468 6520 6f74 6865 722e  nd to the other.
+00000a20: 0a20 2020 2077 6964 7468 203a 2069 6e74  .    width : int
+00000a30: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
+00000a40: 2020 5769 6474 6820 6f66 2074 6865 2061    Width of the a
+00000a50: 726d 7320 6f66 2074 6865 2063 726f 7373  rms of the cross
+00000a60: 2e0a 2020 2020 6c61 7965 7220 3a20 696e  ..    layer : in
+00000a70: 742c 2061 7272 6179 2d6c 696b 655b 325d  t, array-like[2]
+00000a80: 2c20 6f72 2073 6574 0a20 2020 2020 2020  , or set.       
+00000a90: 2053 7065 6369 6669 6320 6c61 7965 7228   Specific layer(
+00000aa0: 7329 2074 6f20 7075 7420 706f 6c79 676f  s) to put polygo
+00000ab0: 6e20 6765 6f6d 6574 7279 206f 6e2e 0a0a  n geometry on...
+00000ac0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00000ad0: 2d2d 2d2d 2d2d 2d0a 2020 2020 443a 2044  -------.    D: D
+00000ae0: 6576 6963 650a 2020 2020 2020 2020 4120  evice.        A 
+00000af0: 4465 7669 6365 2063 6f6e 7461 696e 696e  Device containin
+00000b00: 6720 6120 6372 6f73 7320 706f 6c79 676f  g a cross polygo
+00000b10: 6e2e 0a20 2020 2022 2222 0a20 2020 2044  n..    """.    D
+00000b20: 203d 2044 6576 6963 6528 6e61 6d65 3d22   = Device(name="
+00000b30: 6372 6f73 7322 290a 2020 2020 5220 3d20  cross").    R = 
+00000b40: 7265 6374 616e 676c 6528 7369 7a65 3d28  rectangle(size=(
+00000b50: 7769 6474 682c 206c 656e 6774 6829 2c20  width, length), 
+00000b60: 6c61 7965 723d 6c61 7965 7229 0a20 2020  layer=layer).   
+00000b70: 2072 3120 3d20 442e 6164 645f 7265 6628   r1 = D.add_ref(
+00000b80: 5229 2e72 6f74 6174 6528 3930 290a 2020  R).rotate(90).  
+00000b90: 2020 7232 203d 2044 2e61 6464 5f72 6566    r2 = D.add_ref
+00000ba0: 2852 290a 2020 2020 7231 2e63 656e 7465  (R).    r1.cente
+00000bb0: 7220 3d20 2830 2c20 3029 0a20 2020 2072  r = (0, 0).    r
+00000bc0: 322e 6365 6e74 6572 203d 2028 302c 2030  2.center = (0, 0
+00000bd0: 290a 2020 2020 7265 7475 726e 2044 0a0a  ).    return D..
+00000be0: 0a64 6566 2065 6c6c 6970 7365 2872 6164  .def ellipse(rad
+00000bf0: 6969 3d28 3130 2c20 3529 2c20 616e 676c  ii=(10, 5), angl
+00000c00: 655f 7265 736f 6c75 7469 6f6e 3d32 2e35  e_resolution=2.5
+00000c10: 2c20 6c61 7965 723d 3029 3a0a 2020 2020  , layer=0):.    
+00000c20: 2222 2247 656e 6572 6174 6573 2061 6e20  """Generates an 
+00000c30: 656c 6c69 7073 6520 6765 6f6d 6574 7279  ellipse geometry
+00000c40: 2e0a 0a20 2020 2050 6172 616d 6574 6572  ...    Parameter
+00000c50: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+00000c60: 0a20 2020 2072 6164 6969 203a 2074 7570  .    radii : tup
+00000c70: 6c65 206f 6620 696e 7420 6f72 2066 6c6f  le of int or flo
+00000c80: 6174 0a20 2020 2020 2020 2053 656d 696d  at.        Semim
+00000c90: 616a 6f72 2028 7829 2061 6e64 2073 656d  ajor (x) and sem
+00000ca0: 696d 696e 6f72 2028 7929 2061 7869 7320  iminor (y) axis 
+00000cb0: 6c65 6e67 7468 7320 6f66 2074 6865 2065  lengths of the e
+00000cc0: 6c6c 6970 7365 2e0a 2020 2020 616e 676c  llipse..    angl
+00000cd0: 655f 7265 736f 6c75 7469 6f6e 203a 2069  e_resolution : i
+00000ce0: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
+00000cf0: 2020 2020 5265 736f 6c75 7469 6f6e 206f      Resolution o
+00000d00: 6620 7468 6520 6375 7276 6520 6f66 2074  f the curve of t
+00000d10: 6865 2072 696e 6720 2823 206f 6620 6465  he ring (# of de
+00000d20: 6772 6565 7320 7065 7220 706f 696e 7429  grees per point)
+00000d30: 2e0a 2020 2020 6c61 7965 7220 3a20 696e  ..    layer : in
+00000d40: 742c 2061 7272 6179 2d6c 696b 655b 325d  t, array-like[2]
+00000d50: 2c20 6f72 2073 6574 0a20 2020 2020 2020  , or set.       
+00000d60: 2053 7065 6369 6669 6320 6c61 7965 7228   Specific layer(
+00000d70: 7329 2074 6f20 7075 7420 706f 6c79 676f  s) to put polygo
+00000d80: 6e20 6765 6f6d 6574 7279 206f 6e2e 0a0a  n geometry on...
+00000d90: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00000da0: 2d2d 2d2d 2d2d 2d0a 2020 2020 4420 3a20  -------.    D : 
+00000db0: 4465 7669 6365 0a20 2020 2020 2020 2041  Device.        A
+00000dc0: 2044 6576 6963 6520 636f 6e74 6169 6e69   Device containi
+00000dd0: 6e67 2061 6e20 656c 6c69 7073 6520 706f  ng an ellipse po
+00000de0: 6c79 676f 6e2e 0a20 2020 2022 2222 0a20  lygon..    """. 
+00000df0: 2020 2044 203d 2044 6576 6963 6528 6e61     D = Device(na
+00000e00: 6d65 3d22 656c 6c69 7073 6522 290a 2020  me="ellipse").  
+00000e10: 2020 6120 3d20 7261 6469 695b 305d 0a20    a = radii[0]. 
+00000e20: 2020 2062 203d 2072 6164 6969 5b31 5d0a     b = radii[1].
+00000e30: 2020 2020 7420 3d20 6e70 2e6c 696e 7370      t = np.linsp
+00000e40: 6163 6528 302c 2033 3630 2c20 696e 7428  ace(0, 360, int(
+00000e50: 6e70 2e63 6569 6c28 3336 3020 2f20 616e  np.ceil(360 / an
+00000e60: 676c 655f 7265 736f 6c75 7469 6f6e 2920  gle_resolution) 
+00000e70: 2b20 3129 2920 2a20 7069 202f 2031 3830  + 1)) * pi / 180
+00000e80: 0a20 2020 2072 203d 2061 202a 2062 202f  .    r = a * b /
+00000e90: 2028 7371 7274 2828 6220 2a20 636f 7328   (sqrt((b * cos(
+00000ea0: 7429 2920 2a2a 2032 202b 2028 6120 2a20  t)) ** 2 + (a * 
+00000eb0: 7369 6e28 7429 2920 2a2a 2032 2929 0a20  sin(t)) ** 2)). 
+00000ec0: 2020 2078 7074 7320 3d20 7220 2a20 636f     xpts = r * co
+00000ed0: 7328 7429 0a20 2020 2079 7074 7320 3d20  s(t).    ypts = 
+00000ee0: 7220 2a20 7369 6e28 7429 0a20 2020 2044  r * sin(t).    D
+00000ef0: 2e61 6464 5f70 6f6c 7967 6f6e 2870 6f69  .add_polygon(poi
+00000f00: 6e74 733d 2878 7074 732c 2079 7074 7329  nts=(xpts, ypts)
+00000f10: 2c20 6c61 7965 723d 6c61 7965 7229 0a20  , layer=layer). 
+00000f20: 2020 2072 6574 7572 6e20 440a 0a0a 6465     return D...de
+00000f30: 6620 6369 7263 6c65 2872 6164 6975 733d  f circle(radius=
+00000f40: 3130 2c20 616e 676c 655f 7265 736f 6c75  10, angle_resolu
+00000f50: 7469 6f6e 3d32 2e35 2c20 6c61 7965 723d  tion=2.5, layer=
+00000f60: 3029 3a0a 2020 2020 2222 2247 656e 6572  0):.    """Gener
+00000f70: 6174 6573 2061 2063 6972 636c 6520 6765  ates a circle ge
+00000f80: 6f6d 6574 7279 2e0a 0a20 2020 2050 6172  ometry...    Par
+00000f90: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+00000fa0: 2d2d 2d2d 2d2d 0a20 2020 2072 6164 6975  ------.    radiu
+00000fb0: 7320 3a20 696e 7420 6f72 2066 6c6f 6174  s : int or float
+00000fc0: 0a20 2020 2020 2020 2052 6164 6975 7320  .        Radius 
+00000fd0: 6f66 2074 6865 2063 6972 636c 652e 0a20  of the circle.. 
+00000fe0: 2020 2061 6e67 6c65 5f72 6573 6f6c 7574     angle_resolut
+00000ff0: 696f 6e20 3a20 696e 7420 6f72 2066 6c6f  ion : int or flo
+00001000: 6174 0a20 2020 2020 2020 2052 6573 6f6c  at.        Resol
+00001010: 7574 696f 6e20 6f66 2074 6865 2063 7572  ution of the cur
+00001020: 7665 206f 6620 7468 6520 7269 6e67 2028  ve of the ring (
+00001030: 2320 6f66 2064 6567 7265 6573 2070 6572  # of degrees per
+00001040: 2070 6f69 6e74 292e 0a20 2020 206c 6179   point)..    lay
+00001050: 6572 203a 2069 6e74 2c20 6172 7261 792d  er : int, array-
+00001060: 6c69 6b65 5b32 5d2c 206f 7220 7365 740a  like[2], or set.
+00001070: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
+00001080: 206c 6179 6572 2873 2920 746f 2070 7574   layer(s) to put
+00001090: 2070 6f6c 7967 6f6e 2067 656f 6d65 7472   polygon geometr
+000010a0: 7920 6f6e 2e0a 0a20 2020 2052 6574 7572  y on...    Retur
+000010b0: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+000010c0: 2020 2044 203a 2044 6576 6963 650a 2020     D : Device.  
+000010d0: 2020 2020 2020 4120 4465 7669 6365 2063        A Device c
+000010e0: 6f6e 7461 696e 696e 6720 6120 6369 7263  ontaining a circ
+000010f0: 6c65 2070 6f6c 7967 6f6e 2e0a 2020 2020  le polygon..    
+00001100: 2222 220a 2020 2020 4420 3d20 4465 7669  """.    D = Devi
+00001110: 6365 286e 616d 653d 2263 6972 636c 6522  ce(name="circle"
+00001120: 290a 2020 2020 7420 3d20 6e70 2e6c 696e  ).    t = np.lin
+00001130: 7370 6163 6528 302c 2033 3630 2c20 696e  space(0, 360, in
+00001140: 7428 6e70 2e63 6569 6c28 3336 3020 2f20  t(np.ceil(360 / 
+00001150: 616e 676c 655f 7265 736f 6c75 7469 6f6e  angle_resolution
+00001160: 2920 2b20 3129 2920 2a20 7069 202f 2031  ) + 1)) * pi / 1
+00001170: 3830 0a20 2020 2078 7074 7320 3d20 2872  80.    xpts = (r
+00001180: 6164 6975 7320 2a20 636f 7328 7429 292e  adius * cos(t)).
+00001190: 746f 6c69 7374 2829 0a20 2020 2079 7074  tolist().    ypt
+000011a0: 7320 3d20 2872 6164 6975 7320 2a20 7369  s = (radius * si
+000011b0: 6e28 7429 292e 746f 6c69 7374 2829 0a20  n(t)).tolist(). 
+000011c0: 2020 2044 2e61 6464 5f70 6f6c 7967 6f6e     D.add_polygon
+000011d0: 2870 6f69 6e74 733d 2878 7074 732c 2079  (points=(xpts, y
+000011e0: 7074 7329 2c20 6c61 7965 723d 6c61 7965  pts), layer=laye
+000011f0: 7229 0a20 2020 2072 6574 7572 6e20 440a  r).    return D.
+00001200: 0a0a 6465 6620 7269 6e67 2872 6164 6975  ..def ring(radiu
+00001210: 733d 3130 2c20 7769 6474 683d 302e 352c  s=10, width=0.5,
+00001220: 2061 6e67 6c65 5f72 6573 6f6c 7574 696f   angle_resolutio
+00001230: 6e3d 322e 352c 206c 6179 6572 3d30 293a  n=2.5, layer=0):
+00001240: 0a20 2020 2022 2222 4765 6e65 7261 7465  .    """Generate
+00001250: 7320 6120 7269 6e67 2067 656f 6d65 7472  s a ring geometr
+00001260: 792e 0a0a 2020 2020 5061 7261 6d65 7465  y...    Paramete
+00001270: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+00001280: 2d0a 2020 2020 7261 6469 7573 203a 2069  -.    radius : i
+00001290: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
+000012a0: 2020 2020 5261 6469 7573 206f 6620 7468      Radius of th
+000012b0: 6520 7269 6e67 2063 656e 7465 726c 696e  e ring centerlin
+000012c0: 650a 2020 2020 7769 6474 6820 3a20 696e  e.    width : in
+000012d0: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
+000012e0: 2020 2057 6964 7468 206f 6620 7468 6520     Width of the 
+000012f0: 7269 6e67 2e0a 2020 2020 616e 676c 655f  ring..    angle_
+00001300: 7265 736f 6c75 7469 6f6e 203a 2069 6e74  resolution : int
+00001310: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
+00001320: 2020 5265 736f 6c75 7469 6f6e 206f 6620    Resolution of 
+00001330: 7468 6520 6375 7276 6520 6f66 2074 6865  the curve of the
+00001340: 2072 696e 6720 2823 206f 6620 6465 6772   ring (# of degr
+00001350: 6565 7320 7065 7220 706f 696e 7429 2e0a  ees per point)..
+00001360: 2020 2020 6c61 7965 7220 3a0a 2020 2020      layer :.    
+00001370: 2020 2020 5370 6563 6966 6963 206c 6179      Specific lay
+00001380: 6572 2873 2920 746f 2070 7574 2070 6f6c  er(s) to put pol
+00001390: 7967 6f6e 2067 656f 6d65 7472 7920 6f6e  ygon geometry on
+000013a0: 2e0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
+000013b0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2044     -------.    D
+000013c0: 203a 2044 6576 6963 650a 2020 2020 2020   : Device.      
+000013d0: 2020 4120 4465 7669 6365 2063 6f6e 7461    A Device conta
+000013e0: 696e 696e 6720 6120 7269 6e67 2070 6f6c  ining a ring pol
+000013f0: 7967 6f6e 2e0a 0a20 2020 204e 6f74 6573  ygon...    Notes
+00001400: 0a20 2020 202d 2d2d 2d2d 0a20 2020 2054  .    -----.    T
+00001410: 6865 2072 696e 6720 6973 2066 6f72 6d65  he ring is forme
+00001420: 6420 6279 2074 616b 696e 6720 7468 6520  d by taking the 
+00001430: 7261 6469 7573 206f 7574 2074 6f20 7468  radius out to th
+00001440: 6520 7370 6563 6966 6965 6420 7661 6c75  e specified valu
+00001450: 652c 2061 6e64 0a20 2020 2074 6865 6e20  e, and.    then 
+00001460: 636f 6e73 7472 7563 7469 6e67 2074 6865  constructing the
+00001470: 2074 6869 636b 6e65 7373 2062 7920 6469   thickness by di
+00001480: 7669 6469 6e67 2074 6865 2077 6964 7468  viding the width
+00001490: 2069 6e20 6861 6c66 2061 6e64 2061 6464   in half and add
+000014a0: 696e 670a 2020 2020 7468 6174 2076 616c  ing.    that val
+000014b0: 7565 2074 6f20 6569 7468 6572 2073 6964  ue to either sid
+000014c0: 6520 6f66 2074 6865 2072 6164 6975 732e  e of the radius.
+000014d0: 0a0a 2020 2020 5468 6520 616e 676c 655f  ..    The angle_
+000014e0: 7265 736f 6c75 7469 6f6e 2061 6c74 6572  resolution alter
+000014f0: 7320 7468 6520 7072 6563 6973 696f 6e20  s the precision 
+00001500: 6f66 2074 6865 2063 7572 7665 206f 6620  of the curve of 
+00001510: 7468 6520 7269 6e67 2e20 4c61 7267 6572  the ring. Larger
+00001520: 0a20 2020 2076 616c 7565 7320 7969 656c  .    values yiel
+00001530: 6420 6c6f 7765 7220 7265 736f 6c75 7469  d lower resoluti
+00001540: 6f6e 2e0a 2020 2020 2222 220a 2020 2020  on..    """.    
+00001550: 4420 3d20 4465 7669 6365 286e 616d 653d  D = Device(name=
+00001560: 2272 696e 6722 290a 2020 2020 696e 6e65  "ring").    inne
 00001570: 725f 7261 6469 7573 203d 2072 6164 6975  r_radius = radiu
-00001580: 7320 2b20 7769 6474 6820 2f20 320a 2020  s + width / 2.  
-00001590: 2020 6e20 3d20 696e 7428 6e70 2e72 6f75    n = int(np.rou
-000015a0: 6e64 2833 3630 202f 2061 6e67 6c65 5f72  nd(360 / angle_r
-000015b0: 6573 6f6c 7574 696f 6e29 290a 2020 2020  esolution)).    
-000015c0: 7420 3d20 6e70 2e6c 696e 7370 6163 6528  t = np.linspace(
-000015d0: 302c 2033 3630 2c20 6e20 2b20 3129 202a  0, 360, n + 1) *
-000015e0: 2070 6920 2f20 3138 300a 2020 2020 696e   pi / 180.    in
-000015f0: 6e65 725f 706f 696e 7473 5f78 203d 2028  ner_points_x = (
-00001600: 696e 6e65 725f 7261 6469 7573 202a 2063  inner_radius * c
-00001610: 6f73 2874 2929 2e74 6f6c 6973 7428 290a  os(t)).tolist().
-00001620: 2020 2020 696e 6e65 725f 706f 696e 7473      inner_points
-00001630: 5f79 203d 2028 696e 6e65 725f 7261 6469  _y = (inner_radi
-00001640: 7573 202a 2073 696e 2874 2929 2e74 6f6c  us * sin(t)).tol
-00001650: 6973 7428 290a 2020 2020 6f75 7465 725f  ist().    outer_
-00001660: 706f 696e 7473 5f78 203d 2028 6f75 7465  points_x = (oute
-00001670: 725f 7261 6469 7573 202a 2063 6f73 2874  r_radius * cos(t
-00001680: 2929 2e74 6f6c 6973 7428 290a 2020 2020  )).tolist().    
-00001690: 6f75 7465 725f 706f 696e 7473 5f79 203d  outer_points_y =
-000016a0: 2028 6f75 7465 725f 7261 6469 7573 202a   (outer_radius *
-000016b0: 2073 696e 2874 2929 2e74 6f6c 6973 7428   sin(t)).tolist(
-000016c0: 290a 2020 2020 7870 7473 203d 2069 6e6e  ).    xpts = inn
-000016d0: 6572 5f70 6f69 6e74 735f 7820 2b20 6f75  er_points_x + ou
-000016e0: 7465 725f 706f 696e 7473 5f78 5b3a 3a2d  ter_points_x[::-
-000016f0: 315d 0a20 2020 2079 7074 7320 3d20 696e  1].    ypts = in
-00001700: 6e65 725f 706f 696e 7473 5f79 202b 206f  ner_points_y + o
-00001710: 7574 6572 5f70 6f69 6e74 735f 795b 3a3a  uter_points_y[::
-00001720: 2d31 5d0a 2020 2020 442e 6164 645f 706f  -1].    D.add_po
-00001730: 6c79 676f 6e28 706f 696e 7473 3d28 7870  lygon(points=(xp
-00001740: 7473 2c20 7970 7473 292c 206c 6179 6572  ts, ypts), layer
-00001750: 3d6c 6179 6572 290a 2020 2020 7265 7475  =layer).    retu
-00001760: 726e 2044 0a0a 0a64 6566 2061 7263 2872  rn D...def arc(r
-00001770: 6164 6975 733d 3130 2c20 7769 6474 683d  adius=10, width=
-00001780: 302e 352c 2074 6865 7461 3d34 352c 2073  0.5, theta=45, s
-00001790: 7461 7274 5f61 6e67 6c65 3d30 2c20 616e  tart_angle=0, an
-000017a0: 676c 655f 7265 736f 6c75 7469 6f6e 3d32  gle_resolution=2
-000017b0: 2e35 2c20 6c61 7965 723d 3029 3a0a 2020  .5, layer=0):.  
-000017c0: 2020 2222 2243 7265 6174 6573 2061 6e20    """Creates an 
-000017d0: 6172 6320 6f66 2061 7263 6c65 6e67 7468  arc of arclength
-000017e0: 2060 6074 6865 7461 6060 2073 7461 7274   ``theta`` start
-000017f0: 696e 6720 6174 2061 6e67 6c65 0a20 2020  ing at angle.   
-00001800: 2060 6073 7461 7274 5f61 6e67 6c65 6060   ``start_angle``
-00001810: 2e0a 0a20 2020 2050 6172 616d 6574 6572  ...    Parameter
-00001820: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-00001830: 0a20 2020 2072 6164 6975 7320 3a20 696e  .    radius : in
-00001840: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
-00001850: 2020 2052 6164 6975 7320 6f66 2074 6865     Radius of the
-00001860: 2061 7263 2063 656e 7465 726c 696e 652e   arc centerline.
-00001870: 0a20 2020 2077 6964 7468 203a 2069 6e74  .    width : int
-00001880: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
-00001890: 2020 5769 6474 6820 6f66 2074 6865 2061    Width of the a
-000018a0: 7263 2e0a 2020 2020 7468 6574 6120 3a20  rc..    theta : 
-000018b0: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
-000018c0: 2020 2020 2054 6f74 616c 2061 6e67 6c65       Total angle
-000018d0: 2063 6f76 6572 6167 6520 6f66 2074 6865   coverage of the
-000018e0: 2061 7263 2e0a 2020 2020 7374 6172 745f   arc..    start_
-000018f0: 616e 676c 6520 3a20 696e 7420 6f72 2066  angle : int or f
-00001900: 6c6f 6174 0a20 2020 2020 2020 2053 7461  loat.        Sta
-00001910: 7274 696e 6720 616e 676c 652e 0a20 2020  rting angle..   
-00001920: 2061 6e67 6c65 5f72 6573 6f6c 7574 696f   angle_resolutio
-00001930: 6e20 3a20 696e 7420 6f72 2066 6c6f 6174  n : int or float
-00001940: 0a20 2020 2020 2020 2052 6573 6f6c 7574  .        Resolut
-00001950: 696f 6e20 6f66 2074 6865 2063 7572 7665  ion of the curve
-00001960: 206f 6620 7468 6520 6172 632e 0a20 2020   of the arc..   
-00001970: 206c 6179 6572 203a 2069 6e74 2c20 6172   layer : int, ar
-00001980: 7261 792d 6c69 6b65 5b32 5d2c 206f 7220  ray-like[2], or 
-00001990: 7365 740a 2020 2020 2020 2020 5370 6563  set.        Spec
-000019a0: 6966 6963 206c 6179 6572 2873 2920 746f  ific layer(s) to
-000019b0: 2070 7574 2070 6f6c 7967 6f6e 2067 656f   put polygon geo
-000019c0: 6d65 7472 7920 6f6e 2e0a 0a20 2020 2052  metry on...    R
-000019d0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-000019e0: 2d2d 0a20 2020 2044 203a 2044 6576 6963  --.    D : Devic
-000019f0: 650a 2020 2020 2020 2020 4120 4465 7669  e.        A Devi
-00001a00: 6365 2063 6f6e 7461 696e 696e 6720 616e  ce containing an
-00001a10: 2061 7263 2070 6f6c 7967 6f6e 2061 6e64   arc polygon and
-00001a20: 2074 776f 2070 6f72 7473 2028 6031 6020   two ports (`1` 
-00001a30: 616e 6420 6032 6029 206f 6e0a 2020 2020  and `2`) on.    
-00001a40: 2020 2020 6569 7468 6572 2065 6e64 2e0a      either end..
-00001a50: 0a20 2020 204e 6f74 6573 0a20 2020 202d  .    Notes.    -
-00001a60: 2d2d 2d2d 0a20 2020 2054 6865 7461 203d  ----.    Theta =
-00001a70: 2030 2069 7320 6c6f 6361 7465 6420 616c   0 is located al
-00001a80: 6f6e 6720 7468 6520 706f 7369 7469 7665  ong the positive
-00001a90: 2078 2d61 7869 7320 7265 6c61 7469 7665   x-axis relative
-00001aa0: 2074 6f20 7468 6520 6365 6e74 6572 206f   to the center o
-00001ab0: 660a 2020 2020 7468 6520 6172 632e 0a0a  f.    the arc...
-00001ac0: 2020 2020 506f 7274 7320 6172 6520 6164      Ports are ad
-00001ad0: 6465 6420 746f 2065 6163 6820 656e 6420  ded to each end 
-00001ae0: 6f66 2074 6865 2061 7263 2074 6f20 6661  of the arc to fa
-00001af0: 6369 6c69 7461 7465 2063 6f6e 6e65 6374  cilitate connect
-00001b00: 696e 6720 7468 6f73 6520 656e 6473 0a20  ing those ends. 
-00001b10: 2020 2074 6f20 6f74 6865 7220 6765 6f6d     to other geom
-00001b20: 6574 7269 6573 2e0a 2020 2020 2222 220a  etries..    """.
-00001b30: 2020 2020 696e 6e65 725f 7261 6469 7573      inner_radius
-00001b40: 203d 2072 6164 6975 7320 2d20 7769 6474   = radius - widt
-00001b50: 6820 2f20 320a 2020 2020 6f75 7465 725f  h / 2.    outer_
+00001580: 7320 2d20 7769 6474 6820 2f20 320a 2020  s - width / 2.  
+00001590: 2020 6f75 7465 725f 7261 6469 7573 203d    outer_radius =
+000015a0: 2072 6164 6975 7320 2b20 7769 6474 6820   radius + width 
+000015b0: 2f20 320a 2020 2020 6e20 3d20 696e 7428  / 2.    n = int(
+000015c0: 6e70 2e72 6f75 6e64 2833 3630 202f 2061  np.round(360 / a
+000015d0: 6e67 6c65 5f72 6573 6f6c 7574 696f 6e29  ngle_resolution)
+000015e0: 290a 2020 2020 7420 3d20 6e70 2e6c 696e  ).    t = np.lin
+000015f0: 7370 6163 6528 302c 2033 3630 2c20 6e20  space(0, 360, n 
+00001600: 2b20 3129 202a 2070 6920 2f20 3138 300a  + 1) * pi / 180.
+00001610: 2020 2020 696e 6e65 725f 706f 696e 7473      inner_points
+00001620: 5f78 203d 2028 696e 6e65 725f 7261 6469  _x = (inner_radi
+00001630: 7573 202a 2063 6f73 2874 2929 2e74 6f6c  us * cos(t)).tol
+00001640: 6973 7428 290a 2020 2020 696e 6e65 725f  ist().    inner_
+00001650: 706f 696e 7473 5f79 203d 2028 696e 6e65  points_y = (inne
+00001660: 725f 7261 6469 7573 202a 2073 696e 2874  r_radius * sin(t
+00001670: 2929 2e74 6f6c 6973 7428 290a 2020 2020  )).tolist().    
+00001680: 6f75 7465 725f 706f 696e 7473 5f78 203d  outer_points_x =
+00001690: 2028 6f75 7465 725f 7261 6469 7573 202a   (outer_radius *
+000016a0: 2063 6f73 2874 2929 2e74 6f6c 6973 7428   cos(t)).tolist(
+000016b0: 290a 2020 2020 6f75 7465 725f 706f 696e  ).    outer_poin
+000016c0: 7473 5f79 203d 2028 6f75 7465 725f 7261  ts_y = (outer_ra
+000016d0: 6469 7573 202a 2073 696e 2874 2929 2e74  dius * sin(t)).t
+000016e0: 6f6c 6973 7428 290a 2020 2020 7870 7473  olist().    xpts
+000016f0: 203d 2069 6e6e 6572 5f70 6f69 6e74 735f   = inner_points_
+00001700: 7820 2b20 6f75 7465 725f 706f 696e 7473  x + outer_points
+00001710: 5f78 5b3a 3a2d 315d 0a20 2020 2079 7074  _x[::-1].    ypt
+00001720: 7320 3d20 696e 6e65 725f 706f 696e 7473  s = inner_points
+00001730: 5f79 202b 206f 7574 6572 5f70 6f69 6e74  _y + outer_point
+00001740: 735f 795b 3a3a 2d31 5d0a 2020 2020 442e  s_y[::-1].    D.
+00001750: 6164 645f 706f 6c79 676f 6e28 706f 696e  add_polygon(poin
+00001760: 7473 3d28 7870 7473 2c20 7970 7473 292c  ts=(xpts, ypts),
+00001770: 206c 6179 6572 3d6c 6179 6572 290a 2020   layer=layer).  
+00001780: 2020 7265 7475 726e 2044 0a0a 0a64 6566    return D...def
+00001790: 2061 7263 2872 6164 6975 733d 3130 2c20   arc(radius=10, 
+000017a0: 7769 6474 683d 302e 352c 2074 6865 7461  width=0.5, theta
+000017b0: 3d34 352c 2073 7461 7274 5f61 6e67 6c65  =45, start_angle
+000017c0: 3d30 2c20 616e 676c 655f 7265 736f 6c75  =0, angle_resolu
+000017d0: 7469 6f6e 3d32 2e35 2c20 6c61 7965 723d  tion=2.5, layer=
+000017e0: 3029 3a0a 2020 2020 2222 2243 7265 6174  0):.    """Creat
+000017f0: 6573 2061 6e20 6172 6320 6f66 2061 7263  es an arc of arc
+00001800: 6c65 6e67 7468 2060 6074 6865 7461 6060  length ``theta``
+00001810: 2073 7461 7274 696e 6720 6174 2061 6e67   starting at ang
+00001820: 6c65 0a20 2020 2060 6073 7461 7274 5f61  le.    ``start_a
+00001830: 6e67 6c65 6060 2e0a 0a20 2020 2050 6172  ngle``...    Par
+00001840: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+00001850: 2d2d 2d2d 2d2d 0a20 2020 2072 6164 6975  ------.    radiu
+00001860: 7320 3a20 696e 7420 6f72 2066 6c6f 6174  s : int or float
+00001870: 0a20 2020 2020 2020 2052 6164 6975 7320  .        Radius 
+00001880: 6f66 2074 6865 2061 7263 2063 656e 7465  of the arc cente
+00001890: 726c 696e 652e 0a20 2020 2077 6964 7468  rline..    width
+000018a0: 203a 2069 6e74 206f 7220 666c 6f61 740a   : int or float.
+000018b0: 2020 2020 2020 2020 5769 6474 6820 6f66          Width of
+000018c0: 2074 6865 2061 7263 2e0a 2020 2020 7468   the arc..    th
+000018d0: 6574 6120 3a20 696e 7420 6f72 2066 6c6f  eta : int or flo
+000018e0: 6174 0a20 2020 2020 2020 2054 6f74 616c  at.        Total
+000018f0: 2061 6e67 6c65 2063 6f76 6572 6167 6520   angle coverage 
+00001900: 6f66 2074 6865 2061 7263 2e0a 2020 2020  of the arc..    
+00001910: 7374 6172 745f 616e 676c 6520 3a20 696e  start_angle : in
+00001920: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
+00001930: 2020 2053 7461 7274 696e 6720 616e 676c     Starting angl
+00001940: 652e 0a20 2020 2061 6e67 6c65 5f72 6573  e..    angle_res
+00001950: 6f6c 7574 696f 6e20 3a20 696e 7420 6f72  olution : int or
+00001960: 2066 6c6f 6174 0a20 2020 2020 2020 2052   float.        R
+00001970: 6573 6f6c 7574 696f 6e20 6f66 2074 6865  esolution of the
+00001980: 2063 7572 7665 206f 6620 7468 6520 6172   curve of the ar
+00001990: 632e 0a20 2020 206c 6179 6572 203a 2069  c..    layer : i
+000019a0: 6e74 2c20 6172 7261 792d 6c69 6b65 5b32  nt, array-like[2
+000019b0: 5d2c 206f 7220 7365 740a 2020 2020 2020  ], or set.      
+000019c0: 2020 5370 6563 6966 6963 206c 6179 6572    Specific layer
+000019d0: 2873 2920 746f 2070 7574 2070 6f6c 7967  (s) to put polyg
+000019e0: 6f6e 2067 656f 6d65 7472 7920 6f6e 2e0a  on geometry on..
+000019f0: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
+00001a00: 202d 2d2d 2d2d 2d2d 0a20 2020 2044 203a   -------.    D :
+00001a10: 2044 6576 6963 650a 2020 2020 2020 2020   Device.        
+00001a20: 4120 4465 7669 6365 2063 6f6e 7461 696e  A Device contain
+00001a30: 696e 6720 616e 2061 7263 2070 6f6c 7967  ing an arc polyg
+00001a40: 6f6e 2061 6e64 2074 776f 2070 6f72 7473  on and two ports
+00001a50: 2028 6031 6020 616e 6420 6032 6029 206f   (`1` and `2`) o
+00001a60: 6e0a 2020 2020 2020 2020 6569 7468 6572  n.        either
+00001a70: 2065 6e64 2e0a 0a20 2020 204e 6f74 6573   end...    Notes
+00001a80: 0a20 2020 202d 2d2d 2d2d 0a20 2020 2054  .    -----.    T
+00001a90: 6865 7461 203d 2030 2069 7320 6c6f 6361  heta = 0 is loca
+00001aa0: 7465 6420 616c 6f6e 6720 7468 6520 706f  ted along the po
+00001ab0: 7369 7469 7665 2078 2d61 7869 7320 7265  sitive x-axis re
+00001ac0: 6c61 7469 7665 2074 6f20 7468 6520 6365  lative to the ce
+00001ad0: 6e74 6572 206f 660a 2020 2020 7468 6520  nter of.    the 
+00001ae0: 6172 632e 0a0a 2020 2020 506f 7274 7320  arc...    Ports 
+00001af0: 6172 6520 6164 6465 6420 746f 2065 6163  are added to eac
+00001b00: 6820 656e 6420 6f66 2074 6865 2061 7263  h end of the arc
+00001b10: 2074 6f20 6661 6369 6c69 7461 7465 2063   to facilitate c
+00001b20: 6f6e 6e65 6374 696e 6720 7468 6f73 6520  onnecting those 
+00001b30: 656e 6473 0a20 2020 2074 6f20 6f74 6865  ends.    to othe
+00001b40: 7220 6765 6f6d 6574 7269 6573 2e0a 2020  r geometries..  
+00001b50: 2020 2222 220a 2020 2020 696e 6e65 725f    """.    inner_
 00001b60: 7261 6469 7573 203d 2072 6164 6975 7320  radius = radius 
-00001b70: 2b20 7769 6474 6820 2f20 320a 2020 2020  + width / 2.    
-00001b80: 616e 676c 6531 203d 2028 7374 6172 745f  angle1 = (start_
-00001b90: 616e 676c 6529 202a 2070 6920 2f20 3138  angle) * pi / 18
-00001ba0: 300a 2020 2020 616e 676c 6532 203d 2028  0.    angle2 = (
-00001bb0: 7374 6172 745f 616e 676c 6520 2b20 7468  start_angle + th
-00001bc0: 6574 6129 202a 2070 6920 2f20 3138 300a  eta) * pi / 180.
-00001bd0: 2020 2020 7420 3d20 6e70 2e6c 696e 7370      t = np.linsp
-00001be0: 6163 6528 616e 676c 6531 2c20 616e 676c  ace(angle1, angl
-00001bf0: 6532 2c20 696e 7428 6e70 2e63 6569 6c28  e2, int(np.ceil(
-00001c00: 6162 7328 7468 6574 6129 202f 2061 6e67  abs(theta) / ang
-00001c10: 6c65 5f72 6573 6f6c 7574 696f 6e29 2929  le_resolution)))
-00001c20: 0a20 2020 2069 6e6e 6572 5f70 6f69 6e74  .    inner_point
-00001c30: 735f 7820 3d20 2869 6e6e 6572 5f72 6164  s_x = (inner_rad
-00001c40: 6975 7320 2a20 636f 7328 7429 292e 746f  ius * cos(t)).to
-00001c50: 6c69 7374 2829 0a20 2020 2069 6e6e 6572  list().    inner
-00001c60: 5f70 6f69 6e74 735f 7920 3d20 2869 6e6e  _points_y = (inn
-00001c70: 6572 5f72 6164 6975 7320 2a20 7369 6e28  er_radius * sin(
-00001c80: 7429 292e 746f 6c69 7374 2829 0a20 2020  t)).tolist().   
-00001c90: 206f 7574 6572 5f70 6f69 6e74 735f 7820   outer_points_x 
-00001ca0: 3d20 286f 7574 6572 5f72 6164 6975 7320  = (outer_radius 
-00001cb0: 2a20 636f 7328 7429 292e 746f 6c69 7374  * cos(t)).tolist
-00001cc0: 2829 0a20 2020 206f 7574 6572 5f70 6f69  ().    outer_poi
-00001cd0: 6e74 735f 7920 3d20 286f 7574 6572 5f72  nts_y = (outer_r
-00001ce0: 6164 6975 7320 2a20 7369 6e28 7429 292e  adius * sin(t)).
-00001cf0: 746f 6c69 7374 2829 0a20 2020 2078 7074  tolist().    xpt
-00001d00: 7320 3d20 696e 6e65 725f 706f 696e 7473  s = inner_points
-00001d10: 5f78 202b 206f 7574 6572 5f70 6f69 6e74  _x + outer_point
-00001d20: 735f 785b 3a3a 2d31 5d0a 2020 2020 7970  s_x[::-1].    yp
-00001d30: 7473 203d 2069 6e6e 6572 5f70 6f69 6e74  ts = inner_point
-00001d40: 735f 7920 2b20 6f75 7465 725f 706f 696e  s_y + outer_poin
-00001d50: 7473 5f79 5b3a 3a2d 315d 0a0a 2020 2020  ts_y[::-1]..    
-00001d60: 4420 3d20 4465 7669 6365 2822 6172 6322  D = Device("arc"
-00001d70: 290a 2020 2020 442e 6164 645f 706f 6c79  ).    D.add_poly
-00001d80: 676f 6e28 706f 696e 7473 3d28 7870 7473  gon(points=(xpts
-00001d90: 2c20 7970 7473 292c 206c 6179 6572 3d6c  , ypts), layer=l
-00001da0: 6179 6572 290a 2020 2020 442e 6164 645f  ayer).    D.add_
-00001db0: 706f 7274 280a 2020 2020 2020 2020 6e61  port(.        na
-00001dc0: 6d65 3d31 2c0a 2020 2020 2020 2020 6d69  me=1,.        mi
-00001dd0: 6470 6f69 6e74 3d28 7261 6469 7573 202a  dpoint=(radius *
-00001de0: 2063 6f73 2861 6e67 6c65 3129 2c20 7261   cos(angle1), ra
-00001df0: 6469 7573 202a 2073 696e 2861 6e67 6c65  dius * sin(angle
-00001e00: 3129 292c 0a20 2020 2020 2020 2077 6964  1)),.        wid
-00001e10: 7468 3d77 6964 7468 2c0a 2020 2020 2020  th=width,.      
-00001e20: 2020 6f72 6965 6e74 6174 696f 6e3d 7374    orientation=st
-00001e30: 6172 745f 616e 676c 6520 2d20 3930 202b  art_angle - 90 +
-00001e40: 2031 3830 202a 2028 7468 6574 6120 3c20   180 * (theta < 
-00001e50: 3029 2c0a 2020 2020 290a 2020 2020 442e  0),.    ).    D.
-00001e60: 6164 645f 706f 7274 280a 2020 2020 2020  add_port(.      
-00001e70: 2020 6e61 6d65 3d32 2c0a 2020 2020 2020    name=2,.      
-00001e80: 2020 6d69 6470 6f69 6e74 3d28 7261 6469    midpoint=(radi
-00001e90: 7573 202a 2063 6f73 2861 6e67 6c65 3229  us * cos(angle2)
-00001ea0: 2c20 7261 6469 7573 202a 2073 696e 2861  , radius * sin(a
-00001eb0: 6e67 6c65 3229 292c 0a20 2020 2020 2020  ngle2)),.       
-00001ec0: 2077 6964 7468 3d77 6964 7468 2c0a 2020   width=width,.  
-00001ed0: 2020 2020 2020 6f72 6965 6e74 6174 696f        orientatio
-00001ee0: 6e3d 7374 6172 745f 616e 676c 6520 2b20  n=start_angle + 
-00001ef0: 7468 6574 6120 2b20 3930 202d 2031 3830  theta + 90 - 180
-00001f00: 202a 2028 7468 6574 6120 3c20 3029 2c0a   * (theta < 0),.
-00001f10: 2020 2020 290a 2020 2020 442e 696e 666f      ).    D.info
-00001f20: 5b22 6c65 6e67 7468 225d 203d 2028 6162  ["length"] = (ab
-00001f30: 7328 7468 6574 6129 202a 2070 6920 2f20  s(theta) * pi / 
-00001f40: 3138 3029 202a 2072 6164 6975 730a 2020  180) * radius.  
-00001f50: 2020 7265 7475 726e 2044 0a0a 0a64 6566    return D...def
-00001f60: 2074 7572 6e28 706f 7274 2c20 7261 6469   turn(port, radi
-00001f70: 7573 3d31 302c 2061 6e67 6c65 3d32 3730  us=10, angle=270
-00001f80: 2c20 616e 676c 655f 7265 736f 6c75 7469  , angle_resoluti
-00001f90: 6f6e 3d32 2e35 2c20 6c61 7965 723d 3029  on=2.5, layer=0)
-00001fa0: 3a0a 2020 2020 2222 2253 7461 7274 696e  :.    """Startin
-00001fb0: 6720 6672 6f6d 2061 2070 6f72 742c 2063  g from a port, c
-00001fc0: 7265 6174 6573 2061 6e20 6172 6320 7768  reates an arc wh
-00001fd0: 6963 6820 636f 6e6e 6563 7473 2074 6f20  ich connects to 
-00001fe0: 7468 6520 7370 6563 6966 6965 640a 2020  the specified.  
-00001ff0: 2020 706f 7274 206f 6e20 6f6e 6520 656e    port on one en
-00002000: 642e 0a0a 2020 2020 5061 7261 6d65 7465  d...    Paramete
-00002010: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-00002020: 2d0a 2020 2020 706f 7274 203a 2050 6f72  -.    port : Por
-00002030: 740a 2020 2020 2020 2020 506f 7274 2074  t.        Port t
-00002040: 6f20 616e 6368 6f72 2061 7263 2074 6f2e  o anchor arc to.
-00002050: 0a20 2020 2072 6164 6975 7320 3a20 696e  .    radius : in
-00002060: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
-00002070: 2020 2052 6164 6975 7320 6f66 2074 6865     Radius of the
-00002080: 2061 7263 2063 656e 7465 726c 696e 652e   arc centerline.
-00002090: 0a20 2020 2061 6e67 6c65 203a 2069 6e74  .    angle : int
-000020a0: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
-000020b0: 2020 546f 7461 6c20 616e 676c 6520 636f    Total angle co
-000020c0: 7665 7261 6765 206f 6620 7468 6520 6172  verage of the ar
-000020d0: 632e 0a20 2020 2061 6e67 6c65 5f72 6573  c..    angle_res
-000020e0: 6f6c 7574 696f 6e20 3a20 696e 7420 6f72  olution : int or
-000020f0: 2066 6c6f 6174 0a20 2020 2020 2020 2052   float.        R
-00002100: 6573 6f6c 7574 696f 6e20 6f66 2074 6865  esolution of the
-00002110: 2063 7572 7665 206f 6620 7468 6520 6172   curve of the ar
-00002120: 632e 0a20 2020 206c 6179 6572 203a 2069  c..    layer : i
-00002130: 6e74 2c20 6172 7261 792d 6c69 6b65 5b32  nt, array-like[2
-00002140: 5d2c 206f 7220 7365 740a 2020 2020 2020  ], or set.      
-00002150: 2020 5370 6563 6966 6963 206c 6179 6572    Specific layer
-00002160: 2873 2920 746f 2070 7574 2074 6865 2070  (s) to put the p
-00002170: 6f6c 7967 6f6e 2067 656f 6d65 7472 7920  olygon geometry 
-00002180: 6f6e 2e0a 0a20 2020 2052 6574 7572 6e73  on...    Returns
-00002190: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-000021a0: 2044 203a 2044 6576 6963 650a 2020 2020   D : Device.    
-000021b0: 2020 2020 4120 4465 7669 6365 2063 6f6e      A Device con
-000021c0: 7461 696e 696e 6720 616e 2061 7263 2070  taining an arc p
-000021d0: 6f6c 7967 6f6e 2061 6e64 2074 776f 2070  olygon and two p
-000021e0: 6f72 7473 2028 6031 6020 616e 6420 6032  orts (`1` and `2
-000021f0: 6029 206f 6e0a 2020 2020 2020 2020 6569  `) on.        ei
-00002200: 7468 6572 2065 6e64 2e0a 0a20 2020 204e  ther end...    N
-00002210: 6f74 6573 0a20 2020 202d 2d2d 2d2d 0a20  otes.    -----. 
-00002220: 2020 2041 6e67 6c65 203d 2030 2069 7320     Angle = 0 is 
-00002230: 6c6f 6361 7465 6420 616c 6f6e 6720 7468  located along th
-00002240: 6520 706f 7369 7469 7665 2078 2d61 7869  e positive x-axi
-00002250: 7320 7265 6c61 7469 7665 2074 6f20 7468  s relative to th
-00002260: 6520 6365 6e74 6572 206f 660a 2020 2020  e center of.    
-00002270: 7468 6520 6172 632e 0a20 2020 2050 6f72  the arc..    Por
-00002280: 7473 2061 7265 2061 6464 6564 2074 6f20  ts are added to 
-00002290: 6561 6368 2065 6e64 206f 6620 7468 6520  each end of the 
-000022a0: 6172 6320 746f 2066 6163 696c 6974 6174  arc to facilitat
-000022b0: 6520 636f 6e6e 6563 7469 6e67 2074 686f  e connecting tho
-000022c0: 7365 2065 6e64 730a 2020 2020 746f 206f  se ends.    to o
-000022d0: 7468 6572 2067 656f 6d65 7472 6965 732e  ther geometries.
-000022e0: 0a20 2020 2050 6f72 7420 6032 6020 6973  .    Port `2` is
-000022f0: 2061 6c69 676e 6564 2074 6f20 636f 6e6e   aligned to conn
-00002300: 6563 7420 746f 2074 6865 2073 7065 6369  ect to the speci
-00002310: 6669 6564 2070 6f72 742e 0a20 2020 2022  fied port..    "
-00002320: 2222 0a20 2020 2044 203d 2061 7263 280a  "".    D = arc(.
-00002330: 2020 2020 2020 2020 7261 6469 7573 3d72          radius=r
-00002340: 6164 6975 732c 0a20 2020 2020 2020 2077  adius,.        w
-00002350: 6964 7468 3d70 6f72 742e 7769 6474 682c  idth=port.width,
-00002360: 0a20 2020 2020 2020 2074 6865 7461 3d61  .        theta=a
-00002370: 6e67 6c65 2c0a 2020 2020 2020 2020 7374  ngle,.        st
-00002380: 6172 745f 616e 676c 653d 302c 0a20 2020  art_angle=0,.   
-00002390: 2020 2020 2061 6e67 6c65 5f72 6573 6f6c       angle_resol
-000023a0: 7574 696f 6e3d 616e 676c 655f 7265 736f  ution=angle_reso
-000023b0: 6c75 7469 6f6e 2c0a 2020 2020 2020 2020  lution,.        
-000023c0: 6c61 7965 723d 6c61 7965 722c 0a20 2020  layer=layer,.   
-000023d0: 2029 0a20 2020 2044 2e72 6f74 6174 6528   ).    D.rotate(
-000023e0: 0a20 2020 2020 2020 2061 6e67 6c65 3d31  .        angle=1
-000023f0: 3830 202b 2070 6f72 742e 6f72 6965 6e74  80 + port.orient
-00002400: 6174 696f 6e20 2d20 442e 706f 7274 735b  ation - D.ports[
-00002410: 315d 2e6f 7269 656e 7461 7469 6f6e 2c0a  1].orientation,.
-00002420: 2020 2020 2020 2020 6365 6e74 6572 3d44          center=D
-00002430: 2e70 6f72 7473 5b31 5d2e 6d69 6470 6f69  .ports[1].midpoi
-00002440: 6e74 2c0a 2020 2020 290a 2020 2020 442e  nt,.    ).    D.
-00002450: 6d6f 7665 286f 7269 6769 6e3d 442e 706f  move(origin=D.po
-00002460: 7274 735b 315d 2c20 6465 7374 696e 6174  rts[1], destinat
-00002470: 696f 6e3d 706f 7274 290a 2020 2020 7265  ion=port).    re
-00002480: 7475 726e 2044 0a0a 0a64 6566 2073 7472  turn D...def str
-00002490: 6169 6768 7428 7369 7a65 3d28 342c 2032  aight(size=(4, 2
-000024a0: 292c 206c 6179 6572 3d30 293a 0a20 2020  ), layer=0):.   
-000024b0: 2022 2222 4765 6e65 7261 7465 7320 6120   """Generates a 
-000024c0: 7265 6374 616e 6775 6c61 7220 7769 7265  rectangular wire
-000024d0: 2067 656f 6d65 7472 7920 7769 7468 2070   geometry with p
-000024e0: 6f72 7473 206f 6e20 7468 6520 6c65 6e67  orts on the leng
-000024f0: 7468 2065 6467 6573 2e0a 0a20 2020 2050  th edges...    P
-00002500: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-00002510: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2073 697a  --------.    siz
-00002520: 6520 3a20 7475 706c 6520 6f66 2069 6e74  e : tuple of int
-00002530: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
-00002540: 2020 5468 6520 6c65 6e67 7468 2061 6e64    The length and
-00002550: 2077 6964 7468 206f 6620 7468 6520 7265   width of the re
-00002560: 6374 616e 676c 652e 0a20 2020 206c 6179  ctangle..    lay
-00002570: 6572 203a 2069 6e74 2c20 6172 7261 792d  er : int, array-
-00002580: 6c69 6b65 5b32 5d2c 206f 7220 7365 740a  like[2], or set.
-00002590: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
-000025a0: 206c 6179 6572 2873 2920 746f 2070 7574   layer(s) to put
-000025b0: 2070 6f6c 7967 6f6e 2067 656f 6d65 7472   polygon geometr
-000025c0: 7920 6f6e 2e0a 0a20 2020 2052 6574 7572  y on...    Retur
-000025d0: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-000025e0: 2020 2044 203a 2044 6576 6963 650a 2020     D : Device.  
-000025f0: 2020 2020 2020 4120 4465 7669 6365 2063        A Device c
-00002600: 6f6e 7461 696e 696e 6720 6120 7265 6374  ontaining a rect
-00002610: 616e 676c 6520 706f 6c79 676f 6e20 616e  angle polygon an
-00002620: 6420 7477 6f20 706f 7274 7320 2860 3160  d two ports (`1`
-00002630: 2061 6e64 2060 3260 2920 6f6e 0a20 2020   and `2`) on.   
-00002640: 2020 2020 2065 6974 6865 7220 656e 642e       either end.
-00002650: 0a0a 2020 2020 4e6f 7465 730a 2020 2020  ..    Notes.    
-00002660: 2d2d 2d2d 2d0a 2020 2020 506f 7274 7320  -----.    Ports 
-00002670: 6172 6520 696e 636c 7564 6564 206f 6e20  are included on 
-00002680: 626f 7468 2073 6964 6573 206f 6620 7468  both sides of th
-00002690: 6520 6c65 6e67 7468 2065 6467 6520 2869  e length edge (i
-000026a0: 2e65 2e20 7369 7a65 5b30 5d29 206f 6620  .e. size[0]) of 
-000026b0: 7468 650a 2020 2020 6765 6f6d 6574 7279  the.    geometry
-000026c0: 2e0a 2020 2020 2222 220a 2020 2020 4420  ..    """.    D 
-000026d0: 3d20 4465 7669 6365 286e 616d 653d 2277  = Device(name="w
-000026e0: 6972 6522 290a 2020 2020 706f 696e 7473  ire").    points
-000026f0: 203d 205b 5b73 697a 655b 305d 2c20 7369   = [[size[0], si
-00002700: 7a65 5b31 5d5d 2c20 5b73 697a 655b 305d  ze[1]], [size[0]
-00002710: 2c20 305d 2c20 5b30 2c20 305d 2c20 5b30  , 0], [0, 0], [0
-00002720: 2c20 7369 7a65 5b31 5d5d 5d0a 2020 2020  , size[1]]].    
-00002730: 442e 6164 645f 706f 6c79 676f 6e28 706f  D.add_polygon(po
-00002740: 696e 7473 2c20 6c61 7965 723d 6c61 7965  ints, layer=laye
-00002750: 7229 0a20 2020 2044 2e61 6464 5f70 6f72  r).    D.add_por
-00002760: 7428 6e61 6d65 3d31 2c20 6d69 6470 6f69  t(name=1, midpoi
-00002770: 6e74 3d28 7369 7a65 5b30 5d20 2f20 322c  nt=(size[0] / 2,
-00002780: 2073 697a 655b 315d 292c 2077 6964 7468   size[1]), width
-00002790: 3d73 697a 655b 305d 2c20 6f72 6965 6e74  =size[0], orient
-000027a0: 6174 696f 6e3d 3930 290a 2020 2020 442e  ation=90).    D.
-000027b0: 6164 645f 706f 7274 286e 616d 653d 322c  add_port(name=2,
-000027c0: 206d 6964 706f 696e 743d 2873 697a 655b   midpoint=(size[
-000027d0: 305d 202f 2032 2c20 3029 2c20 7769 6474  0] / 2, 0), widt
-000027e0: 683d 7369 7a65 5b30 5d2c 206f 7269 656e  h=size[0], orien
-000027f0: 7461 7469 6f6e 3d2d 3930 290a 2020 2020  tation=-90).    
-00002800: 7265 7475 726e 2044 0a0a 0a64 6566 204c  return D...def L
-00002810: 2877 6964 7468 3d31 2c20 7369 7a65 3d28  (width=1, size=(
-00002820: 3130 2c20 3230 292c 206c 6179 6572 3d30  10, 20), layer=0
-00002830: 293a 0a20 2020 2022 2222 4765 6e65 7261  ):.    """Genera
-00002840: 7465 7320 616e 2027 4c27 2067 656f 6d65  tes an 'L' geome
-00002850: 7472 7920 7769 7468 2070 6f72 7473 206f  try with ports o
-00002860: 6e20 626f 7468 2065 6e64 732e 0a0a 2020  n both ends...  
-00002870: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-00002880: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-00002890: 7769 6474 6820 3a20 696e 7420 6f72 2066  width : int or f
-000028a0: 6c6f 6174 0a20 2020 2020 2020 2054 6869  loat.        Thi
-000028b0: 636b 6e65 7373 206f 6620 7468 6520 6c69  ckness of the li
-000028c0: 6e65 2066 6f72 6d69 6e67 2074 6865 204c  ne forming the L
-000028d0: 2e0a 2020 2020 7369 7a65 203a 2074 7570  ..    size : tup
-000028e0: 6c65 206f 6620 696e 7420 6f72 2066 6c6f  le of int or flo
-000028f0: 6174 0a20 2020 2020 2020 204c 656e 6774  at.        Lengt
-00002900: 6873 206f 6620 7468 6520 6261 7365 2061  hs of the base a
-00002910: 6e64 2068 6569 6768 7420 6f66 2074 6865  nd height of the
-00002920: 204c 2c20 7265 7370 6563 7469 7665 6c79   L, respectively
-00002930: 2e0a 2020 2020 6c61 7965 7220 3a20 696e  ..    layer : in
-00002940: 742c 2061 7272 6179 2d6c 696b 655b 325d  t, array-like[2]
-00002950: 2c20 6f72 2073 6574 0a20 2020 2020 2020  , or set.       
-00002960: 2053 7065 6369 6669 6320 6c61 7965 7228   Specific layer(
-00002970: 7329 2074 6f20 7075 7420 706f 6c79 676f  s) to put polygo
-00002980: 6e20 6765 6f6d 6574 7279 206f 6e2e 0a0a  n geometry on...
-00002990: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-000029a0: 2d2d 2d2d 2d2d 2d0a 2020 2020 4420 3a20  -------.    D : 
-000029b0: 4465 7669 6365 0a20 2020 2020 2020 2041  Device.        A
-000029c0: 2044 6576 6963 6520 636f 6e74 6169 6e69   Device containi
-000029d0: 6e67 2061 6e20 4c2d 7368 6170 6564 2070  ng an L-shaped p
-000029e0: 6f6c 7967 6f6e 2061 6e64 2074 776f 2070  olygon and two p
-000029f0: 6f72 7473 2028 6031 6020 616e 6420 6032  orts (`1` and `2
-00002a00: 6029 206f 6e0a 2020 2020 2020 2020 6569  `) on.        ei
-00002a10: 7468 6572 2065 6e64 206f 6620 7468 6520  ther end of the 
-00002a20: 4c2e 0a20 2020 2022 2222 0a20 2020 2044  L..    """.    D
-00002a30: 203d 2044 6576 6963 6528 6e61 6d65 3d22   = Device(name="
-00002a40: 4c22 290a 2020 2020 7720 3d20 7769 6474  L").    w = widt
-00002a50: 6820 2f20 320a 2020 2020 7331 2c20 7332  h / 2.    s1, s2
-00002a60: 203d 2073 697a 650a 2020 2020 706f 696e   = size.    poin
-00002a70: 7473 203d 205b 282d 772c 202d 7729 2c20  ts = [(-w, -w), 
-00002a80: 2873 312c 202d 7729 2c20 2873 312c 2077  (s1, -w), (s1, w
-00002a90: 292c 2028 772c 2077 292c 2028 772c 2073  ), (w, w), (w, s
-00002aa0: 3229 2c20 282d 772c 2073 3229 2c20 282d  2), (-w, s2), (-
-00002ab0: 772c 202d 7729 5d0a 2020 2020 442e 6164  w, -w)].    D.ad
-00002ac0: 645f 706f 6c79 676f 6e28 706f 696e 7473  d_polygon(points
-00002ad0: 2c20 6c61 7965 723d 6c61 7965 7229 0a20  , layer=layer). 
-00002ae0: 2020 2044 2e61 6464 5f70 6f72 7428 6e61     D.add_port(na
-00002af0: 6d65 3d31 2c20 6d69 6470 6f69 6e74 3d28  me=1, midpoint=(
-00002b00: 302c 2073 3229 2c20 7769 6474 683d 7769  0, s2), width=wi
-00002b10: 6474 682c 206f 7269 656e 7461 7469 6f6e  dth, orientation
-00002b20: 3d39 3029 0a20 2020 2044 2e61 6464 5f70  =90).    D.add_p
-00002b30: 6f72 7428 6e61 6d65 3d32 2c20 6d69 6470  ort(name=2, midp
-00002b40: 6f69 6e74 3d28 7331 2c20 3029 2c20 7769  oint=(s1, 0), wi
-00002b50: 6474 683d 7769 6474 682c 206f 7269 656e  dth=width, orien
-00002b60: 7461 7469 6f6e 3d30 290a 2020 2020 7265  tation=0).    re
-00002b70: 7475 726e 2044 0a0a 0a64 6566 2043 2877  turn D...def C(w
-00002b80: 6964 7468 3d31 2c20 7369 7a65 3d28 3130  idth=1, size=(10
-00002b90: 2c20 3230 292c 206c 6179 6572 3d30 293a  , 20), layer=0):
-00002ba0: 0a20 2020 2022 2222 4765 6e65 7261 7465  .    """Generate
-00002bb0: 7320 6120 2743 2720 6765 6f6d 6574 7279  s a 'C' geometry
-00002bc0: 2077 6974 6820 706f 7274 7320 6f6e 2062   with ports on b
-00002bd0: 6f74 6820 656e 6473 2e0a 0a20 2020 2050  oth ends...    P
-00002be0: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-00002bf0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2077 6964  --------.    wid
-00002c00: 7468 203a 2069 6e74 206f 7220 666c 6f61  th : int or floa
-00002c10: 740a 2020 2020 2020 2020 5468 6963 6b6e  t.        Thickn
-00002c20: 6573 7320 6f66 2074 6865 206c 696e 6520  ess of the line 
-00002c30: 666f 726d 696e 6720 7468 6520 432e 0a20  forming the C.. 
-00002c40: 2020 2073 697a 6520 3a20 7475 706c 6520     size : tuple 
-00002c50: 6f66 2069 6e74 206f 7220 666c 6f61 740a  of int or float.
-00002c60: 2020 2020 2020 2020 4c65 6e67 7468 7320          Lengths 
-00002c70: 6f66 2074 6865 2062 6173 6520 2b20 746f  of the base + to
-00002c80: 7020 6564 6765 7320 616e 6420 7468 6520  p edges and the 
-00002c90: 6865 6967 6874 206f 6620 7468 6520 432c  height of the C,
-00002ca0: 2072 6573 7065 6374 6976 656c 792e 0a20   respectively.. 
-00002cb0: 2020 206c 6179 6572 203a 2069 6e74 2c20     layer : int, 
-00002cc0: 6172 7261 792d 6c69 6b65 5b32 5d2c 206f  array-like[2], o
-00002cd0: 7220 7365 740a 2020 2020 2020 2020 5370  r set.        Sp
-00002ce0: 6563 6966 6963 206c 6179 6572 2873 2920  ecific layer(s) 
-00002cf0: 746f 2070 7574 2070 6f6c 7967 6f6e 2067  to put polygon g
-00002d00: 656f 6d65 7472 7920 6f6e 2e0a 0a20 2020  eometry on...   
-00002d10: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
-00002d20: 2d2d 2d2d 0a20 2020 2044 203a 2044 6576  ----.    D : Dev
-00002d30: 6963 650a 2020 2020 2020 2020 4120 4465  ice.        A De
-00002d40: 7669 6365 2063 6f6e 7461 696e 696e 6720  vice containing 
-00002d50: 6120 5b2d 6272 6163 6b65 742d 7368 6170  a [-bracket-shap
-00002d60: 6564 2070 6f6c 7967 6f6e 2061 6e64 2074  ed polygon and t
-00002d70: 776f 2070 6f72 7473 2028 6031 6020 616e  wo ports (`1` an
-00002d80: 640a 2020 2020 2020 2020 6032 6029 206f  d.        `2`) o
-00002d90: 6e20 6569 7468 6572 2065 6e64 206f 6620  n either end of 
-00002da0: 7468 6520 5b20 7368 6170 652e 0a20 2020  the [ shape..   
-00002db0: 2022 2222 0a20 2020 2044 203d 2044 6576   """.    D = Dev
-00002dc0: 6963 6528 6e61 6d65 3d22 4322 290a 2020  ice(name="C").  
-00002dd0: 2020 7720 3d20 7769 6474 6820 2f20 320a    w = width / 2.
-00002de0: 2020 2020 7331 2c20 7332 203d 2073 697a      s1, s2 = siz
-00002df0: 650a 2020 2020 706f 696e 7473 203d 205b  e.    points = [
-00002e00: 0a20 2020 2020 2020 2028 2d77 2c20 2d77  .        (-w, -w
-00002e10: 292c 0a20 2020 2020 2020 2028 7331 2c20  ),.        (s1, 
-00002e20: 2d77 292c 0a20 2020 2020 2020 2028 7331  -w),.        (s1
-00002e30: 2c20 7729 2c0a 2020 2020 2020 2020 2877  , w),.        (w
-00002e40: 2c20 7729 2c0a 2020 2020 2020 2020 2877  , w),.        (w
-00002e50: 2c20 7332 202d 2077 292c 0a20 2020 2020  , s2 - w),.     
-00002e60: 2020 2028 7331 2c20 7332 202d 2077 292c     (s1, s2 - w),
-00002e70: 0a20 2020 2020 2020 2028 7331 2c20 7332  .        (s1, s2
-00002e80: 202b 2077 292c 0a20 2020 2020 2020 2028   + w),.        (
-00002e90: 2d77 2c20 7332 202b 2077 292c 0a20 2020  -w, s2 + w),.   
-00002ea0: 2020 2020 2028 2d77 2c20 2d77 292c 0a20       (-w, -w),. 
-00002eb0: 2020 205d 0a20 2020 2044 2e61 6464 5f70     ].    D.add_p
-00002ec0: 6f6c 7967 6f6e 2870 6f69 6e74 732c 206c  olygon(points, l
-00002ed0: 6179 6572 3d6c 6179 6572 290a 2020 2020  ayer=layer).    
-00002ee0: 442e 6164 645f 706f 7274 286e 616d 653d  D.add_port(name=
-00002ef0: 312c 206d 6964 706f 696e 743d 2873 312c  1, midpoint=(s1,
-00002f00: 2073 3229 2c20 7769 6474 683d 7769 6474   s2), width=widt
-00002f10: 682c 206f 7269 656e 7461 7469 6f6e 3d30  h, orientation=0
-00002f20: 290a 2020 2020 442e 6164 645f 706f 7274  ).    D.add_port
-00002f30: 286e 616d 653d 322c 206d 6964 706f 696e  (name=2, midpoin
-00002f40: 743d 2873 312c 2030 292c 2077 6964 7468  t=(s1, 0), width
-00002f50: 3d77 6964 7468 2c20 6f72 6965 6e74 6174  =width, orientat
-00002f60: 696f 6e3d 3029 0a20 2020 2072 6574 7572  ion=0).    retur
-00002f70: 6e20 440a 0a0a 2320 3d3d 3d3d 3d3d 3d3d  n D...# ========
-00002f80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00002f90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00001b70: 2d20 7769 6474 6820 2f20 320a 2020 2020  - width / 2.    
+00001b80: 6f75 7465 725f 7261 6469 7573 203d 2072  outer_radius = r
+00001b90: 6164 6975 7320 2b20 7769 6474 6820 2f20  adius + width / 
+00001ba0: 320a 2020 2020 616e 676c 6531 203d 2028  2.    angle1 = (
+00001bb0: 7374 6172 745f 616e 676c 6529 202a 2070  start_angle) * p
+00001bc0: 6920 2f20 3138 300a 2020 2020 616e 676c  i / 180.    angl
+00001bd0: 6532 203d 2028 7374 6172 745f 616e 676c  e2 = (start_angl
+00001be0: 6520 2b20 7468 6574 6129 202a 2070 6920  e + theta) * pi 
+00001bf0: 2f20 3138 300a 2020 2020 7420 3d20 6e70  / 180.    t = np
+00001c00: 2e6c 696e 7370 6163 6528 616e 676c 6531  .linspace(angle1
+00001c10: 2c20 616e 676c 6532 2c20 696e 7428 6e70  , angle2, int(np
+00001c20: 2e63 6569 6c28 6162 7328 7468 6574 6129  .ceil(abs(theta)
+00001c30: 202f 2061 6e67 6c65 5f72 6573 6f6c 7574   / angle_resolut
+00001c40: 696f 6e29 2929 0a20 2020 2069 6e6e 6572  ion))).    inner
+00001c50: 5f70 6f69 6e74 735f 7820 3d20 2869 6e6e  _points_x = (inn
+00001c60: 6572 5f72 6164 6975 7320 2a20 636f 7328  er_radius * cos(
+00001c70: 7429 292e 746f 6c69 7374 2829 0a20 2020  t)).tolist().   
+00001c80: 2069 6e6e 6572 5f70 6f69 6e74 735f 7920   inner_points_y 
+00001c90: 3d20 2869 6e6e 6572 5f72 6164 6975 7320  = (inner_radius 
+00001ca0: 2a20 7369 6e28 7429 292e 746f 6c69 7374  * sin(t)).tolist
+00001cb0: 2829 0a20 2020 206f 7574 6572 5f70 6f69  ().    outer_poi
+00001cc0: 6e74 735f 7820 3d20 286f 7574 6572 5f72  nts_x = (outer_r
+00001cd0: 6164 6975 7320 2a20 636f 7328 7429 292e  adius * cos(t)).
+00001ce0: 746f 6c69 7374 2829 0a20 2020 206f 7574  tolist().    out
+00001cf0: 6572 5f70 6f69 6e74 735f 7920 3d20 286f  er_points_y = (o
+00001d00: 7574 6572 5f72 6164 6975 7320 2a20 7369  uter_radius * si
+00001d10: 6e28 7429 292e 746f 6c69 7374 2829 0a20  n(t)).tolist(). 
+00001d20: 2020 2078 7074 7320 3d20 696e 6e65 725f     xpts = inner_
+00001d30: 706f 696e 7473 5f78 202b 206f 7574 6572  points_x + outer
+00001d40: 5f70 6f69 6e74 735f 785b 3a3a 2d31 5d0a  _points_x[::-1].
+00001d50: 2020 2020 7970 7473 203d 2069 6e6e 6572      ypts = inner
+00001d60: 5f70 6f69 6e74 735f 7920 2b20 6f75 7465  _points_y + oute
+00001d70: 725f 706f 696e 7473 5f79 5b3a 3a2d 315d  r_points_y[::-1]
+00001d80: 0a0a 2020 2020 4420 3d20 4465 7669 6365  ..    D = Device
+00001d90: 2822 6172 6322 290a 2020 2020 442e 6164  ("arc").    D.ad
+00001da0: 645f 706f 6c79 676f 6e28 706f 696e 7473  d_polygon(points
+00001db0: 3d28 7870 7473 2c20 7970 7473 292c 206c  =(xpts, ypts), l
+00001dc0: 6179 6572 3d6c 6179 6572 290a 2020 2020  ayer=layer).    
+00001dd0: 442e 6164 645f 706f 7274 280a 2020 2020  D.add_port(.    
+00001de0: 2020 2020 6e61 6d65 3d31 2c0a 2020 2020      name=1,.    
+00001df0: 2020 2020 6d69 6470 6f69 6e74 3d28 7261      midpoint=(ra
+00001e00: 6469 7573 202a 2063 6f73 2861 6e67 6c65  dius * cos(angle
+00001e10: 3129 2c20 7261 6469 7573 202a 2073 696e  1), radius * sin
+00001e20: 2861 6e67 6c65 3129 292c 0a20 2020 2020  (angle1)),.     
+00001e30: 2020 2077 6964 7468 3d77 6964 7468 2c0a     width=width,.
+00001e40: 2020 2020 2020 2020 6f72 6965 6e74 6174          orientat
+00001e50: 696f 6e3d 7374 6172 745f 616e 676c 6520  ion=start_angle 
+00001e60: 2d20 3930 202b 2031 3830 202a 2028 7468  - 90 + 180 * (th
+00001e70: 6574 6120 3c20 3029 2c0a 2020 2020 290a  eta < 0),.    ).
+00001e80: 2020 2020 442e 6164 645f 706f 7274 280a      D.add_port(.
+00001e90: 2020 2020 2020 2020 6e61 6d65 3d32 2c0a          name=2,.
+00001ea0: 2020 2020 2020 2020 6d69 6470 6f69 6e74          midpoint
+00001eb0: 3d28 7261 6469 7573 202a 2063 6f73 2861  =(radius * cos(a
+00001ec0: 6e67 6c65 3229 2c20 7261 6469 7573 202a  ngle2), radius *
+00001ed0: 2073 696e 2861 6e67 6c65 3229 292c 0a20   sin(angle2)),. 
+00001ee0: 2020 2020 2020 2077 6964 7468 3d77 6964         width=wid
+00001ef0: 7468 2c0a 2020 2020 2020 2020 6f72 6965  th,.        orie
+00001f00: 6e74 6174 696f 6e3d 7374 6172 745f 616e  ntation=start_an
+00001f10: 676c 6520 2b20 7468 6574 6120 2b20 3930  gle + theta + 90
+00001f20: 202d 2031 3830 202a 2028 7468 6574 6120   - 180 * (theta 
+00001f30: 3c20 3029 2c0a 2020 2020 290a 2020 2020  < 0),.    ).    
+00001f40: 442e 696e 666f 5b22 6c65 6e67 7468 225d  D.info["length"]
+00001f50: 203d 2028 6162 7328 7468 6574 6129 202a   = (abs(theta) *
+00001f60: 2070 6920 2f20 3138 3029 202a 2072 6164   pi / 180) * rad
+00001f70: 6975 730a 2020 2020 7265 7475 726e 2044  ius.    return D
+00001f80: 0a0a 0a64 6566 2074 7572 6e28 706f 7274  ...def turn(port
+00001f90: 2c20 7261 6469 7573 3d31 302c 2061 6e67  , radius=10, ang
+00001fa0: 6c65 3d32 3730 2c20 616e 676c 655f 7265  le=270, angle_re
+00001fb0: 736f 6c75 7469 6f6e 3d32 2e35 2c20 6c61  solution=2.5, la
+00001fc0: 7965 723d 3029 3a0a 2020 2020 2222 2253  yer=0):.    """S
+00001fd0: 7461 7274 696e 6720 6672 6f6d 2061 2070  tarting from a p
+00001fe0: 6f72 742c 2063 7265 6174 6573 2061 6e20  ort, creates an 
+00001ff0: 6172 6320 7768 6963 6820 636f 6e6e 6563  arc which connec
+00002000: 7473 2074 6f20 7468 6520 7370 6563 6966  ts to the specif
+00002010: 6965 640a 2020 2020 706f 7274 206f 6e20  ied.    port on 
+00002020: 6f6e 6520 656e 642e 0a0a 2020 2020 5061  one end...    Pa
+00002030: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00002040: 2d2d 2d2d 2d2d 2d0a 2020 2020 706f 7274  -------.    port
+00002050: 203a 2050 6f72 740a 2020 2020 2020 2020   : Port.        
+00002060: 506f 7274 2074 6f20 616e 6368 6f72 2061  Port to anchor a
+00002070: 7263 2074 6f2e 0a20 2020 2072 6164 6975  rc to..    radiu
+00002080: 7320 3a20 696e 7420 6f72 2066 6c6f 6174  s : int or float
+00002090: 0a20 2020 2020 2020 2052 6164 6975 7320  .        Radius 
+000020a0: 6f66 2074 6865 2061 7263 2063 656e 7465  of the arc cente
+000020b0: 726c 696e 652e 0a20 2020 2061 6e67 6c65  rline..    angle
+000020c0: 203a 2069 6e74 206f 7220 666c 6f61 740a   : int or float.
+000020d0: 2020 2020 2020 2020 546f 7461 6c20 616e          Total an
+000020e0: 676c 6520 636f 7665 7261 6765 206f 6620  gle coverage of 
+000020f0: 7468 6520 6172 632e 0a20 2020 2061 6e67  the arc..    ang
+00002100: 6c65 5f72 6573 6f6c 7574 696f 6e20 3a20  le_resolution : 
+00002110: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
+00002120: 2020 2020 2052 6573 6f6c 7574 696f 6e20       Resolution 
+00002130: 6f66 2074 6865 2063 7572 7665 206f 6620  of the curve of 
+00002140: 7468 6520 6172 632e 0a20 2020 206c 6179  the arc..    lay
+00002150: 6572 203a 2069 6e74 2c20 6172 7261 792d  er : int, array-
+00002160: 6c69 6b65 5b32 5d2c 206f 7220 7365 740a  like[2], or set.
+00002170: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
+00002180: 206c 6179 6572 2873 2920 746f 2070 7574   layer(s) to put
+00002190: 2074 6865 2070 6f6c 7967 6f6e 2067 656f   the polygon geo
+000021a0: 6d65 7472 7920 6f6e 2e0a 0a20 2020 2052  metry on...    R
+000021b0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
+000021c0: 2d2d 0a20 2020 2044 203a 2044 6576 6963  --.    D : Devic
+000021d0: 650a 2020 2020 2020 2020 4120 4465 7669  e.        A Devi
+000021e0: 6365 2063 6f6e 7461 696e 696e 6720 616e  ce containing an
+000021f0: 2061 7263 2070 6f6c 7967 6f6e 2061 6e64   arc polygon and
+00002200: 2074 776f 2070 6f72 7473 2028 6031 6020   two ports (`1` 
+00002210: 616e 6420 6032 6029 206f 6e0a 2020 2020  and `2`) on.    
+00002220: 2020 2020 6569 7468 6572 2065 6e64 2e0a      either end..
+00002230: 0a20 2020 204e 6f74 6573 0a20 2020 202d  .    Notes.    -
+00002240: 2d2d 2d2d 0a20 2020 2041 6e67 6c65 203d  ----.    Angle =
+00002250: 2030 2069 7320 6c6f 6361 7465 6420 616c   0 is located al
+00002260: 6f6e 6720 7468 6520 706f 7369 7469 7665  ong the positive
+00002270: 2078 2d61 7869 7320 7265 6c61 7469 7665   x-axis relative
+00002280: 2074 6f20 7468 6520 6365 6e74 6572 206f   to the center o
+00002290: 660a 2020 2020 7468 6520 6172 632e 0a20  f.    the arc.. 
+000022a0: 2020 2050 6f72 7473 2061 7265 2061 6464     Ports are add
+000022b0: 6564 2074 6f20 6561 6368 2065 6e64 206f  ed to each end o
+000022c0: 6620 7468 6520 6172 6320 746f 2066 6163  f the arc to fac
+000022d0: 696c 6974 6174 6520 636f 6e6e 6563 7469  ilitate connecti
+000022e0: 6e67 2074 686f 7365 2065 6e64 730a 2020  ng those ends.  
+000022f0: 2020 746f 206f 7468 6572 2067 656f 6d65    to other geome
+00002300: 7472 6965 732e 0a20 2020 2050 6f72 7420  tries..    Port 
+00002310: 6032 6020 6973 2061 6c69 676e 6564 2074  `2` is aligned t
+00002320: 6f20 636f 6e6e 6563 7420 746f 2074 6865  o connect to the
+00002330: 2073 7065 6369 6669 6564 2070 6f72 742e   specified port.
+00002340: 0a20 2020 2022 2222 0a20 2020 2044 203d  .    """.    D =
+00002350: 2061 7263 280a 2020 2020 2020 2020 7261   arc(.        ra
+00002360: 6469 7573 3d72 6164 6975 732c 0a20 2020  dius=radius,.   
+00002370: 2020 2020 2077 6964 7468 3d70 6f72 742e       width=port.
+00002380: 7769 6474 682c 0a20 2020 2020 2020 2074  width,.        t
+00002390: 6865 7461 3d61 6e67 6c65 2c0a 2020 2020  heta=angle,.    
+000023a0: 2020 2020 7374 6172 745f 616e 676c 653d      start_angle=
+000023b0: 302c 0a20 2020 2020 2020 2061 6e67 6c65  0,.        angle
+000023c0: 5f72 6573 6f6c 7574 696f 6e3d 616e 676c  _resolution=angl
+000023d0: 655f 7265 736f 6c75 7469 6f6e 2c0a 2020  e_resolution,.  
+000023e0: 2020 2020 2020 6c61 7965 723d 6c61 7965        layer=laye
+000023f0: 722c 0a20 2020 2029 0a20 2020 2044 2e72  r,.    ).    D.r
+00002400: 6f74 6174 6528 0a20 2020 2020 2020 2061  otate(.        a
+00002410: 6e67 6c65 3d31 3830 202b 2070 6f72 742e  ngle=180 + port.
+00002420: 6f72 6965 6e74 6174 696f 6e20 2d20 442e  orientation - D.
+00002430: 706f 7274 735b 315d 2e6f 7269 656e 7461  ports[1].orienta
+00002440: 7469 6f6e 2c0a 2020 2020 2020 2020 6365  tion,.        ce
+00002450: 6e74 6572 3d44 2e70 6f72 7473 5b31 5d2e  nter=D.ports[1].
+00002460: 6d69 6470 6f69 6e74 2c0a 2020 2020 290a  midpoint,.    ).
+00002470: 2020 2020 442e 6d6f 7665 286f 7269 6769      D.move(origi
+00002480: 6e3d 442e 706f 7274 735b 315d 2c20 6465  n=D.ports[1], de
+00002490: 7374 696e 6174 696f 6e3d 706f 7274 290a  stination=port).
+000024a0: 2020 2020 7265 7475 726e 2044 0a0a 0a64      return D...d
+000024b0: 6566 2073 7472 6169 6768 7428 7369 7a65  ef straight(size
+000024c0: 3d28 342c 2032 292c 206c 6179 6572 3d30  =(4, 2), layer=0
+000024d0: 293a 0a20 2020 2022 2222 4765 6e65 7261  ):.    """Genera
+000024e0: 7465 7320 6120 7265 6374 616e 6775 6c61  tes a rectangula
+000024f0: 7220 7769 7265 2067 656f 6d65 7472 7920  r wire geometry 
+00002500: 7769 7468 2070 6f72 7473 206f 6e20 7468  with ports on th
+00002510: 6520 6c65 6e67 7468 2065 6467 6573 2e0a  e length edges..
+00002520: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00002530: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00002540: 2020 2073 697a 6520 3a20 7475 706c 6520     size : tuple 
+00002550: 6f66 2069 6e74 206f 7220 666c 6f61 740a  of int or float.
+00002560: 2020 2020 2020 2020 5468 6520 6c65 6e67          The leng
+00002570: 7468 2061 6e64 2077 6964 7468 206f 6620  th and width of 
+00002580: 7468 6520 7265 6374 616e 676c 652e 0a20  the rectangle.. 
+00002590: 2020 206c 6179 6572 203a 2069 6e74 2c20     layer : int, 
+000025a0: 6172 7261 792d 6c69 6b65 5b32 5d2c 206f  array-like[2], o
+000025b0: 7220 7365 740a 2020 2020 2020 2020 5370  r set.        Sp
+000025c0: 6563 6966 6963 206c 6179 6572 2873 2920  ecific layer(s) 
+000025d0: 746f 2070 7574 2070 6f6c 7967 6f6e 2067  to put polygon g
+000025e0: 656f 6d65 7472 7920 6f6e 2e0a 0a20 2020  eometry on...   
+000025f0: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
+00002600: 2d2d 2d2d 0a20 2020 2044 203a 2044 6576  ----.    D : Dev
+00002610: 6963 650a 2020 2020 2020 2020 4120 4465  ice.        A De
+00002620: 7669 6365 2063 6f6e 7461 696e 696e 6720  vice containing 
+00002630: 6120 7265 6374 616e 676c 6520 706f 6c79  a rectangle poly
+00002640: 676f 6e20 616e 6420 7477 6f20 706f 7274  gon and two port
+00002650: 7320 2860 3160 2061 6e64 2060 3260 2920  s (`1` and `2`) 
+00002660: 6f6e 0a20 2020 2020 2020 2065 6974 6865  on.        eithe
+00002670: 7220 656e 642e 0a0a 2020 2020 4e6f 7465  r end...    Note
+00002680: 730a 2020 2020 2d2d 2d2d 2d0a 2020 2020  s.    -----.    
+00002690: 506f 7274 7320 6172 6520 696e 636c 7564  Ports are includ
+000026a0: 6564 206f 6e20 626f 7468 2073 6964 6573  ed on both sides
+000026b0: 206f 6620 7468 6520 6c65 6e67 7468 2065   of the length e
+000026c0: 6467 6520 2869 2e65 2e20 7369 7a65 5b30  dge (i.e. size[0
+000026d0: 5d29 206f 6620 7468 650a 2020 2020 6765  ]) of the.    ge
+000026e0: 6f6d 6574 7279 2e0a 2020 2020 2222 220a  ometry..    """.
+000026f0: 2020 2020 4420 3d20 4465 7669 6365 286e      D = Device(n
+00002700: 616d 653d 2277 6972 6522 290a 2020 2020  ame="wire").    
+00002710: 706f 696e 7473 203d 205b 5b73 697a 655b  points = [[size[
+00002720: 305d 2c20 7369 7a65 5b31 5d5d 2c20 5b73  0], size[1]], [s
+00002730: 697a 655b 305d 2c20 305d 2c20 5b30 2c20  ize[0], 0], [0, 
+00002740: 305d 2c20 5b30 2c20 7369 7a65 5b31 5d5d  0], [0, size[1]]
+00002750: 5d0a 2020 2020 442e 6164 645f 706f 6c79  ].    D.add_poly
+00002760: 676f 6e28 706f 696e 7473 2c20 6c61 7965  gon(points, laye
+00002770: 723d 6c61 7965 7229 0a20 2020 2044 2e61  r=layer).    D.a
+00002780: 6464 5f70 6f72 7428 6e61 6d65 3d31 2c20  dd_port(name=1, 
+00002790: 6d69 6470 6f69 6e74 3d28 7369 7a65 5b30  midpoint=(size[0
+000027a0: 5d20 2f20 322c 2073 697a 655b 315d 292c  ] / 2, size[1]),
+000027b0: 2077 6964 7468 3d73 697a 655b 305d 2c20   width=size[0], 
+000027c0: 6f72 6965 6e74 6174 696f 6e3d 3930 290a  orientation=90).
+000027d0: 2020 2020 442e 6164 645f 706f 7274 286e      D.add_port(n
+000027e0: 616d 653d 322c 206d 6964 706f 696e 743d  ame=2, midpoint=
+000027f0: 2873 697a 655b 305d 202f 2032 2c20 3029  (size[0] / 2, 0)
+00002800: 2c20 7769 6474 683d 7369 7a65 5b30 5d2c  , width=size[0],
+00002810: 206f 7269 656e 7461 7469 6f6e 3d2d 3930   orientation=-90
+00002820: 290a 2020 2020 7265 7475 726e 2044 0a0a  ).    return D..
+00002830: 0a64 6566 204c 2877 6964 7468 3d31 2c20  .def L(width=1, 
+00002840: 7369 7a65 3d28 3130 2c20 3230 292c 206c  size=(10, 20), l
+00002850: 6179 6572 3d30 293a 0a20 2020 2022 2222  ayer=0):.    """
+00002860: 4765 6e65 7261 7465 7320 616e 2027 4c27  Generates an 'L'
+00002870: 2067 656f 6d65 7472 7920 7769 7468 2070   geometry with p
+00002880: 6f72 7473 206f 6e20 626f 7468 2065 6e64  orts on both end
+00002890: 732e 0a0a 2020 2020 5061 7261 6d65 7465  s...    Paramete
+000028a0: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+000028b0: 2d0a 2020 2020 7769 6474 6820 3a20 696e  -.    width : in
+000028c0: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
+000028d0: 2020 2054 6869 636b 6e65 7373 206f 6620     Thickness of 
+000028e0: 7468 6520 6c69 6e65 2066 6f72 6d69 6e67  the line forming
+000028f0: 2074 6865 204c 2e0a 2020 2020 7369 7a65   the L..    size
+00002900: 203a 2074 7570 6c65 206f 6620 696e 7420   : tuple of int 
+00002910: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
+00002920: 204c 656e 6774 6873 206f 6620 7468 6520   Lengths of the 
+00002930: 6261 7365 2061 6e64 2068 6569 6768 7420  base and height 
+00002940: 6f66 2074 6865 204c 2c20 7265 7370 6563  of the L, respec
+00002950: 7469 7665 6c79 2e0a 2020 2020 6c61 7965  tively..    laye
+00002960: 7220 3a20 696e 742c 2061 7272 6179 2d6c  r : int, array-l
+00002970: 696b 655b 325d 2c20 6f72 2073 6574 0a20  ike[2], or set. 
+00002980: 2020 2020 2020 2053 7065 6369 6669 6320         Specific 
+00002990: 6c61 7965 7228 7329 2074 6f20 7075 7420  layer(s) to put 
+000029a0: 706f 6c79 676f 6e20 6765 6f6d 6574 7279  polygon geometry
+000029b0: 206f 6e2e 0a0a 2020 2020 5265 7475 726e   on...    Return
+000029c0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
+000029d0: 2020 4420 3a20 4465 7669 6365 0a20 2020    D : Device.   
+000029e0: 2020 2020 2041 2044 6576 6963 6520 636f       A Device co
+000029f0: 6e74 6169 6e69 6e67 2061 6e20 4c2d 7368  ntaining an L-sh
+00002a00: 6170 6564 2070 6f6c 7967 6f6e 2061 6e64  aped polygon and
+00002a10: 2074 776f 2070 6f72 7473 2028 6031 6020   two ports (`1` 
+00002a20: 616e 6420 6032 6029 206f 6e0a 2020 2020  and `2`) on.    
+00002a30: 2020 2020 6569 7468 6572 2065 6e64 206f      either end o
+00002a40: 6620 7468 6520 4c2e 0a20 2020 2022 2222  f the L..    """
+00002a50: 0a20 2020 2044 203d 2044 6576 6963 6528  .    D = Device(
+00002a60: 6e61 6d65 3d22 4c22 290a 2020 2020 7720  name="L").    w 
+00002a70: 3d20 7769 6474 6820 2f20 320a 2020 2020  = width / 2.    
+00002a80: 7331 2c20 7332 203d 2073 697a 650a 2020  s1, s2 = size.  
+00002a90: 2020 706f 696e 7473 203d 205b 282d 772c    points = [(-w,
+00002aa0: 202d 7729 2c20 2873 312c 202d 7729 2c20   -w), (s1, -w), 
+00002ab0: 2873 312c 2077 292c 2028 772c 2077 292c  (s1, w), (w, w),
+00002ac0: 2028 772c 2073 3229 2c20 282d 772c 2073   (w, s2), (-w, s
+00002ad0: 3229 2c20 282d 772c 202d 7729 5d0a 2020  2), (-w, -w)].  
+00002ae0: 2020 442e 6164 645f 706f 6c79 676f 6e28    D.add_polygon(
+00002af0: 706f 696e 7473 2c20 6c61 7965 723d 6c61  points, layer=la
+00002b00: 7965 7229 0a20 2020 2044 2e61 6464 5f70  yer).    D.add_p
+00002b10: 6f72 7428 6e61 6d65 3d31 2c20 6d69 6470  ort(name=1, midp
+00002b20: 6f69 6e74 3d28 302c 2073 3229 2c20 7769  oint=(0, s2), wi
+00002b30: 6474 683d 7769 6474 682c 206f 7269 656e  dth=width, orien
+00002b40: 7461 7469 6f6e 3d39 3029 0a20 2020 2044  tation=90).    D
+00002b50: 2e61 6464 5f70 6f72 7428 6e61 6d65 3d32  .add_port(name=2
+00002b60: 2c20 6d69 6470 6f69 6e74 3d28 7331 2c20  , midpoint=(s1, 
+00002b70: 3029 2c20 7769 6474 683d 7769 6474 682c  0), width=width,
+00002b80: 206f 7269 656e 7461 7469 6f6e 3d30 290a   orientation=0).
+00002b90: 2020 2020 7265 7475 726e 2044 0a0a 0a64      return D...d
+00002ba0: 6566 2043 2877 6964 7468 3d31 2c20 7369  ef C(width=1, si
+00002bb0: 7a65 3d28 3130 2c20 3230 292c 206c 6179  ze=(10, 20), lay
+00002bc0: 6572 3d30 293a 0a20 2020 2022 2222 4765  er=0):.    """Ge
+00002bd0: 6e65 7261 7465 7320 6120 2743 2720 6765  nerates a 'C' ge
+00002be0: 6f6d 6574 7279 2077 6974 6820 706f 7274  ometry with port
+00002bf0: 7320 6f6e 2062 6f74 6820 656e 6473 2e0a  s on both ends..
+00002c00: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00002c10: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00002c20: 2020 2077 6964 7468 203a 2069 6e74 206f     width : int o
+00002c30: 7220 666c 6f61 740a 2020 2020 2020 2020  r float.        
+00002c40: 5468 6963 6b6e 6573 7320 6f66 2074 6865  Thickness of the
+00002c50: 206c 696e 6520 666f 726d 696e 6720 7468   line forming th
+00002c60: 6520 432e 0a20 2020 2073 697a 6520 3a20  e C..    size : 
+00002c70: 7475 706c 6520 6f66 2069 6e74 206f 7220  tuple of int or 
+00002c80: 666c 6f61 740a 2020 2020 2020 2020 4c65  float.        Le
+00002c90: 6e67 7468 7320 6f66 2074 6865 2062 6173  ngths of the bas
+00002ca0: 6520 2b20 746f 7020 6564 6765 7320 616e  e + top edges an
+00002cb0: 6420 7468 6520 6865 6967 6874 206f 6620  d the height of 
+00002cc0: 7468 6520 432c 2072 6573 7065 6374 6976  the C, respectiv
+00002cd0: 656c 792e 0a20 2020 206c 6179 6572 203a  ely..    layer :
+00002ce0: 2069 6e74 2c20 6172 7261 792d 6c69 6b65   int, array-like
+00002cf0: 5b32 5d2c 206f 7220 7365 740a 2020 2020  [2], or set.    
+00002d00: 2020 2020 5370 6563 6966 6963 206c 6179      Specific lay
+00002d10: 6572 2873 2920 746f 2070 7574 2070 6f6c  er(s) to put pol
+00002d20: 7967 6f6e 2067 656f 6d65 7472 7920 6f6e  ygon geometry on
+00002d30: 2e0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
+00002d40: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2044     -------.    D
+00002d50: 203a 2044 6576 6963 650a 2020 2020 2020   : Device.      
+00002d60: 2020 4120 4465 7669 6365 2063 6f6e 7461    A Device conta
+00002d70: 696e 696e 6720 6120 5b2d 6272 6163 6b65  ining a [-bracke
+00002d80: 742d 7368 6170 6564 2070 6f6c 7967 6f6e  t-shaped polygon
+00002d90: 2061 6e64 2074 776f 2070 6f72 7473 2028   and two ports (
+00002da0: 6031 6020 616e 640a 2020 2020 2020 2020  `1` and.        
+00002db0: 6032 6029 206f 6e20 6569 7468 6572 2065  `2`) on either e
+00002dc0: 6e64 206f 6620 7468 6520 5b20 7368 6170  nd of the [ shap
+00002dd0: 652e 0a20 2020 2022 2222 0a20 2020 2044  e..    """.    D
+00002de0: 203d 2044 6576 6963 6528 6e61 6d65 3d22   = Device(name="
+00002df0: 4322 290a 2020 2020 7720 3d20 7769 6474  C").    w = widt
+00002e00: 6820 2f20 320a 2020 2020 7331 2c20 7332  h / 2.    s1, s2
+00002e10: 203d 2073 697a 650a 2020 2020 706f 696e   = size.    poin
+00002e20: 7473 203d 205b 0a20 2020 2020 2020 2028  ts = [.        (
+00002e30: 2d77 2c20 2d77 292c 0a20 2020 2020 2020  -w, -w),.       
+00002e40: 2028 7331 2c20 2d77 292c 0a20 2020 2020   (s1, -w),.     
+00002e50: 2020 2028 7331 2c20 7729 2c0a 2020 2020     (s1, w),.    
+00002e60: 2020 2020 2877 2c20 7729 2c0a 2020 2020      (w, w),.    
+00002e70: 2020 2020 2877 2c20 7332 202d 2077 292c      (w, s2 - w),
+00002e80: 0a20 2020 2020 2020 2028 7331 2c20 7332  .        (s1, s2
+00002e90: 202d 2077 292c 0a20 2020 2020 2020 2028   - w),.        (
+00002ea0: 7331 2c20 7332 202b 2077 292c 0a20 2020  s1, s2 + w),.   
+00002eb0: 2020 2020 2028 2d77 2c20 7332 202b 2077       (-w, s2 + w
+00002ec0: 292c 0a20 2020 2020 2020 2028 2d77 2c20  ),.        (-w, 
+00002ed0: 2d77 292c 0a20 2020 205d 0a20 2020 2044  -w),.    ].    D
+00002ee0: 2e61 6464 5f70 6f6c 7967 6f6e 2870 6f69  .add_polygon(poi
+00002ef0: 6e74 732c 206c 6179 6572 3d6c 6179 6572  nts, layer=layer
+00002f00: 290a 2020 2020 442e 6164 645f 706f 7274  ).    D.add_port
+00002f10: 286e 616d 653d 312c 206d 6964 706f 696e  (name=1, midpoin
+00002f20: 743d 2873 312c 2073 3229 2c20 7769 6474  t=(s1, s2), widt
+00002f30: 683d 7769 6474 682c 206f 7269 656e 7461  h=width, orienta
+00002f40: 7469 6f6e 3d30 290a 2020 2020 442e 6164  tion=0).    D.ad
+00002f50: 645f 706f 7274 286e 616d 653d 322c 206d  d_port(name=2, m
+00002f60: 6964 706f 696e 743d 2873 312c 2030 292c  idpoint=(s1, 0),
+00002f70: 2077 6964 7468 3d77 6964 7468 2c20 6f72   width=width, or
+00002f80: 6965 6e74 6174 696f 6e3d 3029 0a20 2020  ientation=0).   
+00002f90: 2072 6574 7572 6e20 440a 0a0a 2320 3d3d   return D...# ==
 00002fa0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 00002fb0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00002fc0: 3d3d 3d3d 3d3d 0a23 0a23 2042 6f6f 6c65  ======.#.# Boole
-00002fd0: 616e 2066 756e 6374 696f 6e73 0a23 0a23  an functions.#.#
-00002fe0: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
-00002ff0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00003000: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00002fc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00002fd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00002fe0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a23 0a23  ============.#.#
+00002ff0: 2042 6f6f 6c65 616e 2066 756e 6374 696f   Boolean functio
+00003000: 6e73 0a23 0a23 203d 3d3d 3d3d 3d3d 3d3d  ns.#.# =========
 00003010: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00003020: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
-00003030: 0a0a 6465 6620 6f66 6673 6574 280a 2020  ..def offset(.  
-00003040: 2020 656c 656d 656e 7473 2c0a 2020 2020    elements,.    
-00003050: 6469 7374 616e 6365 3d30 2e31 2c0a 2020  distance=0.1,.  
-00003060: 2020 6a6f 696e 5f66 6972 7374 3d54 7275    join_first=Tru
-00003070: 652c 0a20 2020 2070 7265 6369 7369 6f6e  e,.    precision
-00003080: 3d31 652d 342c 0a20 2020 206e 756d 5f64  =1e-4,.    num_d
-00003090: 6976 6973 696f 6e73 3d5b 312c 2031 5d2c  ivisions=[1, 1],
-000030a0: 0a20 2020 206a 6f69 6e3d 226d 6974 6572  .    join="miter
-000030b0: 222c 0a20 2020 2074 6f6c 6572 616e 6365  ",.    tolerance
-000030c0: 3d32 2c0a 2020 2020 6d61 785f 706f 696e  =2,.    max_poin
-000030d0: 7473 3d34 3030 302c 0a20 2020 206c 6179  ts=4000,.    lay
-000030e0: 6572 3d30 2c0a 293a 0a20 2020 2022 2222  er=0,.):.    """
-000030f0: 5368 7269 6e6b 7320 6f72 2065 7870 616e  Shrinks or expan
-00003100: 6473 2061 2070 6f6c 7967 6f6e 206f 7220  ds a polygon or 
-00003110: 7365 7420 6f66 2070 6f6c 7967 6f6e 732e  set of polygons.
-00003120: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
-00003130: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-00003140: 2020 2020 656c 656d 656e 7473 203a 2044      elements : D
-00003150: 6576 6963 6528 2f52 6566 6572 656e 6365  evice(/Reference
-00003160: 292c 206c 6973 7420 6f66 2044 6576 6963  ), list of Devic
-00003170: 6528 2f52 6566 6572 656e 6365 292c 206f  e(/Reference), o
-00003180: 7220 506f 6c79 676f 6e0a 2020 2020 2020  r Polygon.      
-00003190: 2020 506f 6c79 676f 6e73 2074 6f20 6f66    Polygons to of
-000031a0: 6673 6574 206f 7220 4465 7669 6365 2063  fset or Device c
-000031b0: 6f6e 7461 696e 696e 6720 706f 6c79 676f  ontaining polygo
-000031c0: 6e73 2074 6f20 6f66 6673 6574 2e0a 2020  ns to offset..  
-000031d0: 2020 6469 7374 616e 6365 203a 2069 6e74    distance : int
-000031e0: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
-000031f0: 2020 4469 7374 616e 6365 2074 6f20 6f66    Distance to of
-00003200: 6673 6574 2070 6f6c 7967 6f6e 732e 2050  fset polygons. P
-00003210: 6f73 6974 6976 6520 7661 6c75 6573 2065  ositive values e
-00003220: 7870 616e 642c 206e 6567 6174 6976 6520  xpand, negative 
-00003230: 7368 7269 6e6b 2e0a 2020 2020 6a6f 696e  shrink..    join
-00003240: 2066 6972 7374 3a20 626f 6f6c 0a20 2020   first: bool.   
-00003250: 2020 2020 2053 6574 7320 7768 6574 6865       Sets whethe
-00003260: 7220 746f 206d 6572 6765 2061 6c6c 2074  r to merge all t
-00003270: 6865 2070 6f6c 7967 6f6e 7320 6265 666f  he polygons befo
-00003280: 7265 2070 6572 666f 726d 696e 670a 2020  re performing.  
-00003290: 2020 2020 2020 7468 6520 6f66 6673 6574        the offset
-000032a0: 206f 7065 7261 7469 6f6e 2c20 6f72 206f   operation, or o
-000032b0: 6666 7365 7420 6561 6368 2070 6f6c 7967  ffset each polyg
-000032c0: 6f6e 2069 6e64 6976 6964 7561 6c6c 790a  on individually.
-000032d0: 2020 2020 7072 6563 6973 696f 6e20 3a20      precision : 
-000032e0: 666c 6f61 740a 2020 2020 2020 2020 4465  float.        De
-000032f0: 7369 7265 6420 7072 6563 6973 696f 6e20  sired precision 
-00003300: 666f 7220 726f 756e 6469 6e67 2076 6572  for rounding ver
-00003310: 7465 7820 636f 6f72 6469 6e61 7465 732e  tex coordinates.
-00003320: 0a20 2020 206e 756d 5f64 6976 6973 696f  .    num_divisio
-00003330: 6e73 203a 2061 7272 6179 2d6c 696b 655b  ns : array-like[
-00003340: 325d 206f 6620 696e 740a 2020 2020 2020  2] of int.      
-00003350: 2020 5468 6520 6e75 6d62 6572 206f 6620    The number of 
-00003360: 6469 7669 7369 6f6e 7320 7769 7468 2077  divisions with w
-00003370: 6869 6368 2074 6865 2067 656f 6d65 7472  hich the geometr
-00003380: 7920 6973 2064 6976 6964 6564 2069 6e74  y is divided int
-00003390: 6f0a 2020 2020 2020 2020 6d75 6c74 6970  o.        multip
-000033a0: 6c65 2072 6563 7461 6e67 756c 6172 2072  le rectangular r
-000033b0: 6567 696f 6e73 2e20 5468 6973 2061 6c6c  egions. This all
-000033c0: 6f77 7320 666f 7220 6561 6368 2072 6567  ows for each reg
-000033d0: 696f 6e20 746f 2062 650a 2020 2020 2020  ion to be.      
-000033e0: 2020 7072 6f63 6573 7365 6420 7365 7175    processed sequ
-000033f0: 656e 7469 616c 6c79 2c20 7768 6963 6820  entially, which 
-00003400: 6973 206d 6f72 6520 636f 6d70 7574 6174  is more computat
-00003410: 696f 6e61 6c6c 7920 6566 6669 6369 656e  ionally efficien
-00003420: 742e 0a20 2020 206a 6f69 6e20 3a20 7b27  t..    join : {'
-00003430: 6d69 7465 7227 2c20 2762 6576 656c 272c  miter', 'bevel',
-00003440: 2027 726f 756e 6427 7d0a 2020 2020 2020   'round'}.      
-00003450: 2020 5479 7065 206f 6620 6a6f 696e 2075    Type of join u
-00003460: 7365 6420 746f 2063 7265 6174 6520 7468  sed to create th
-00003470: 6520 6f66 6673 6574 2070 6f6c 7967 6f6e  e offset polygon
-00003480: 2e0a 2020 2020 746f 6c65 7261 6e63 6520  ..    tolerance 
-00003490: 3a20 696e 7420 6f72 2066 6c6f 6174 0a20  : int or float. 
-000034a0: 2020 2020 2020 2046 6f72 206d 6974 6572         For miter
-000034b0: 206a 6f69 6e74 732c 2074 6869 7320 6e75   joints, this nu
-000034c0: 6d62 6572 206d 7573 7420 6265 2061 7420  mber must be at 
-000034d0: 6c65 6173 7420 3220 616e 6420 6974 2072  least 2 and it r
-000034e0: 6570 7265 7365 6e74 7320 7468 650a 2020  epresents the.  
-000034f0: 2020 2020 2020 6d61 7869 6d61 6c20 6469        maximal di
-00003500: 7374 616e 6365 2069 6e20 6d75 6c74 6970  stance in multip
-00003510: 6c65 7320 6f66 206f 6666 7365 7420 6265  les of offset be
-00003520: 7477 6565 6e20 6e65 7720 7665 7274 6963  tween new vertic
-00003530: 6573 2061 6e64 2074 6865 6972 0a20 2020  es and their.   
-00003540: 2020 2020 206f 7269 6769 6e61 6c20 706f       original po
-00003550: 7369 7469 6f6e 2062 6566 6f72 6520 6265  sition before be
-00003560: 7665 6c69 6e67 2074 6f20 6176 6f69 6420  veling to avoid 
-00003570: 7370 696b 6573 2061 7420 6163 7574 6520  spikes at acute 
-00003580: 6a6f 696e 7473 2e20 466f 720a 2020 2020  joints. For.    
-00003590: 2020 2020 726f 756e 6420 6a6f 696e 7473      round joints
-000035a0: 2c20 6974 2069 6e64 6963 6174 6573 2074  , it indicates t
-000035b0: 6865 2063 7572 7661 7475 7265 2072 6573  he curvature res
-000035c0: 6f6c 7574 696f 6e20 696e 206e 756d 6265  olution in numbe
-000035d0: 7220 6f66 0a20 2020 2020 2020 2070 6f69  r of.        poi
-000035e0: 6e74 7320 7065 7220 6675 6c6c 2063 6972  nts per full cir
-000035f0: 636c 652e 0a20 2020 206d 6178 5f70 6f69  cle..    max_poi
-00003600: 6e74 7320 3a20 696e 740a 2020 2020 2020  nts : int.      
-00003610: 2020 5468 6520 6d61 7869 6d75 6d20 6e75    The maximum nu
-00003620: 6d62 6572 206f 6620 7665 7274 6963 6573  mber of vertices
-00003630: 2077 6974 6869 6e20 7468 6520 7265 7375   within the resu
-00003640: 6c74 696e 6720 706f 6c79 676f 6e2e 0a20  lting polygon.. 
-00003650: 2020 206c 6179 6572 203a 2069 6e74 2c20     layer : int, 
-00003660: 6172 7261 792d 6c69 6b65 5b32 5d2c 206f  array-like[2], o
-00003670: 7220 7365 740a 2020 2020 2020 2020 5370  r set.        Sp
-00003680: 6563 6966 6963 206c 6179 6572 2873 2920  ecific layer(s) 
-00003690: 746f 2070 7574 2070 6f6c 7967 6f6e 2067  to put polygon g
-000036a0: 656f 6d65 7472 7920 6f6e 2e0a 0a20 2020  eometry on...   
-000036b0: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
-000036c0: 2d2d 2d2d 0a20 2020 2044 203a 2044 6576  ----.    D : Dev
-000036d0: 6963 650a 2020 2020 2020 2020 4120 4465  ice.        A De
-000036e0: 7669 6365 2063 6f6e 7461 696e 696e 6720  vice containing 
-000036f0: 6120 706f 6c79 676f 6e28 7329 2077 6974  a polygon(s) wit
-00003700: 6820 7468 6520 7370 6563 6966 6965 6420  h the specified 
-00003710: 6f66 6673 6574 2061 7070 6c69 6564 2e0a  offset applied..
-00003720: 2020 2020 2222 220a 2020 2020 6966 206e      """.    if n
-00003730: 6f74 2069 7369 6e73 7461 6e63 6528 656c  ot isinstance(el
-00003740: 656d 656e 7473 2c20 6c69 7374 293a 0a20  ements, list):. 
-00003750: 2020 2020 2020 2065 6c65 6d65 6e74 7320         elements 
-00003760: 3d20 5b65 6c65 6d65 6e74 735d 0a20 2020  = [elements].   
-00003770: 2070 6f6c 7967 6f6e 735f 746f 5f6f 6666   polygons_to_off
-00003780: 7365 7420 3d20 5b5d 0a20 2020 2066 6f72  set = [].    for
-00003790: 2065 2069 6e20 656c 656d 656e 7473 3a0a   e in elements:.
-000037a0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-000037b0: 7461 6e63 6528 652c 2028 4465 7669 6365  tance(e, (Device
-000037c0: 2c20 4465 7669 6365 5265 6665 7265 6e63  , DeviceReferenc
-000037d0: 6529 293a 0a20 2020 2020 2020 2020 2020  e)):.           
-000037e0: 2070 6f6c 7967 6f6e 735f 746f 5f6f 6666   polygons_to_off
-000037f0: 7365 7420 2b3d 2065 2e67 6574 5f70 6f6c  set += e.get_pol
-00003800: 7967 6f6e 7328 6279 5f73 7065 633d 4661  ygons(by_spec=Fa
-00003810: 6c73 6529 0a20 2020 2020 2020 2065 6c69  lse).        eli
-00003820: 6620 6973 696e 7374 616e 6365 2865 2c20  f isinstance(e, 
-00003830: 2850 6f6c 7967 6f6e 2c20 6764 7370 792e  (Polygon, gdspy.
-00003840: 506f 6c79 676f 6e29 293a 0a20 2020 2020  Polygon)):.     
-00003850: 2020 2020 2020 2070 6f6c 7967 6f6e 735f         polygons_
-00003860: 746f 5f6f 6666 7365 742e 6170 7065 6e64  to_offset.append
-00003870: 2865 290a 2020 2020 6966 206c 656e 2870  (e).    if len(p
-00003880: 6f6c 7967 6f6e 735f 746f 5f6f 6666 7365  olygons_to_offse
-00003890: 7429 203d 3d20 303a 0a20 2020 2020 2020  t) == 0:.       
-000038a0: 2072 6574 7572 6e20 4465 7669 6365 2822   return Device("
-000038b0: 6f66 6673 6574 2229 0a0a 2020 2020 706f  offset")..    po
-000038c0: 6c79 676f 6e73 5f74 6f5f 6f66 6673 6574  lygons_to_offset
-000038d0: 203d 205f 6d65 7267 655f 666c 6f61 7469   = _merge_floati
-000038e0: 6e67 5f70 6f69 6e74 5f65 7272 6f72 7328  ng_point_errors(
-000038f0: 0a20 2020 2020 2020 2070 6f6c 7967 6f6e  .        polygon
-00003900: 735f 746f 5f6f 6666 7365 742c 2074 6f6c  s_to_offset, tol
-00003910: 3d70 7265 6369 7369 6f6e 202f 2031 3030  =precision / 100
-00003920: 300a 2020 2020 290a 2020 2020 6764 735f  0.    ).    gds_
-00003930: 6c61 7965 722c 2067 6473 5f64 6174 6174  layer, gds_datat
-00003940: 7970 6520 3d20 5f70 6172 7365 5f6c 6179  ype = _parse_lay
-00003950: 6572 286c 6179 6572 290a 2020 2020 6966  er(layer).    if
-00003960: 2061 6c6c 286e 702e 6172 7261 7928 6e75   all(np.array(nu
-00003970: 6d5f 6469 7669 7369 6f6e 7329 203d 3d20  m_divisions) == 
-00003980: 6e70 2e61 7272 6179 285b 312c 2031 5d29  np.array([1, 1])
-00003990: 293a 0a20 2020 2020 2020 2070 203d 2067  ):.        p = g
-000039a0: 6473 7079 2e6f 6666 7365 7428 0a20 2020  dspy.offset(.   
-000039b0: 2020 2020 2020 2020 2070 6f6c 7967 6f6e           polygon
-000039c0: 735f 746f 5f6f 6666 7365 742c 0a20 2020  s_to_offset,.   
-000039d0: 2020 2020 2020 2020 2064 6973 7461 6e63           distanc
-000039e0: 653d 6469 7374 616e 6365 2c0a 2020 2020  e=distance,.    
-000039f0: 2020 2020 2020 2020 6a6f 696e 3d6a 6f69          join=joi
-00003a00: 6e2c 0a20 2020 2020 2020 2020 2020 2074  n,.            t
-00003a10: 6f6c 6572 616e 6365 3d74 6f6c 6572 616e  olerance=toleran
-00003a20: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
-00003a30: 7072 6563 6973 696f 6e3d 7072 6563 6973  precision=precis
-00003a40: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
-00003a50: 206a 6f69 6e5f 6669 7273 743d 6a6f 696e   join_first=join
-00003a60: 5f66 6972 7374 2c0a 2020 2020 2020 2020  _first,.        
-00003a70: 2020 2020 6d61 785f 706f 696e 7473 3d6d      max_points=m
-00003a80: 6178 5f70 6f69 6e74 732c 0a20 2020 2020  ax_points,.     
-00003a90: 2020 2020 2020 206c 6179 6572 3d67 6473         layer=gds
-00003aa0: 5f6c 6179 6572 2c0a 2020 2020 2020 2020  _layer,.        
-00003ab0: 2020 2020 6461 7461 7479 7065 3d67 6473      datatype=gds
-00003ac0: 5f64 6174 6174 7970 652c 0a20 2020 2020  _datatype,.     
-00003ad0: 2020 2029 0a20 2020 2065 6c73 653a 0a20     ).    else:. 
-00003ae0: 2020 2020 2020 2070 203d 205f 6f66 6673         p = _offs
-00003af0: 6574 5f70 6f6c 7967 6f6e 735f 7061 7261  et_polygons_para
-00003b00: 6c6c 656c 280a 2020 2020 2020 2020 2020  llel(.          
-00003b10: 2020 706f 6c79 676f 6e73 5f74 6f5f 6f66    polygons_to_of
-00003b20: 6673 6574 2c0a 2020 2020 2020 2020 2020  fset,.          
-00003b30: 2020 6469 7374 616e 6365 3d64 6973 7461    distance=dista
-00003b40: 6e63 652c 0a20 2020 2020 2020 2020 2020  nce,.           
-00003b50: 206e 756d 5f64 6976 6973 696f 6e73 3d6e   num_divisions=n
-00003b60: 756d 5f64 6976 6973 696f 6e73 2c0a 2020  um_divisions,.  
-00003b70: 2020 2020 2020 2020 2020 6a6f 696e 5f66            join_f
-00003b80: 6972 7374 3d6a 6f69 6e5f 6669 7273 742c  irst=join_first,
-00003b90: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
-00003ba0: 6369 7369 6f6e 3d70 7265 6369 7369 6f6e  cision=precision
-00003bb0: 2c0a 2020 2020 2020 2020 2020 2020 6a6f  ,.            jo
-00003bc0: 696e 3d6a 6f69 6e2c 0a20 2020 2020 2020  in=join,.       
-00003bd0: 2020 2020 2074 6f6c 6572 616e 6365 3d74       tolerance=t
-00003be0: 6f6c 6572 616e 6365 2c0a 2020 2020 2020  olerance,.      
-00003bf0: 2020 290a 0a20 2020 2044 203d 2044 6576    )..    D = Dev
-00003c00: 6963 6528 226f 6666 7365 7422 290a 2020  ice("offset").  
-00003c10: 2020 706f 6c79 676f 6e73 203d 2044 2e61    polygons = D.a
-00003c20: 6464 5f70 6f6c 7967 6f6e 2870 2c20 6c61  dd_polygon(p, la
-00003c30: 7965 723d 6c61 7965 7229 0a20 2020 205b  yer=layer).    [
-00003c40: 0a20 2020 2020 2020 2070 6f6c 7967 6f6e  .        polygon
-00003c50: 2e66 7261 6374 7572 6528 6d61 785f 706f  .fracture(max_po
-00003c60: 696e 7473 3d6d 6178 5f70 6f69 6e74 732c  ints=max_points,
-00003c70: 2070 7265 6369 7369 6f6e 3d70 7265 6369   precision=preci
-00003c80: 7369 6f6e 290a 2020 2020 2020 2020 666f  sion).        fo
-00003c90: 7220 706f 6c79 676f 6e20 696e 2070 6f6c  r polygon in pol
-00003ca0: 7967 6f6e 730a 2020 2020 5d0a 2020 2020  ygons.    ].    
-00003cb0: 7265 7475 726e 2044 0a0a 0a64 6566 2062  return D...def b
-00003cc0: 6f6f 6c65 616e 2820 2023 206e 6f71 613a  oolean(  # noqa:
-00003cd0: 2043 3930 310a 2020 2020 412c 2042 2c20   C901.    A, B, 
-00003ce0: 6f70 6572 6174 696f 6e2c 2070 7265 6369  operation, preci
-00003cf0: 7369 6f6e 3d31 652d 342c 206e 756d 5f64  sion=1e-4, num_d
-00003d00: 6976 6973 696f 6e73 3d5b 312c 2031 5d2c  ivisions=[1, 1],
-00003d10: 206d 6178 5f70 6f69 6e74 733d 3430 3030   max_points=4000
-00003d20: 2c20 6c61 7965 723d 300a 293a 0a20 2020  , layer=0.):.   
-00003d30: 2022 2222 5065 7266 6f72 6d73 2062 6f6f   """Performs boo
-00003d40: 6c65 616e 206f 7065 7261 7469 6f6e 7320  lean operations 
-00003d50: 6265 7477 6565 6e20 3220 4465 7669 6365  between 2 Device
-00003d60: 2f44 6576 6963 6552 6566 6572 656e 6365  /DeviceReference
-00003d70: 206f 626a 6563 7473 0a20 2020 206f 7220   objects.    or 
-00003d80: 6c69 7374 7320 6f66 2044 6576 6963 6573  lists of Devices
-00003d90: 2f44 6576 6963 6552 6566 6572 656e 6365  /DeviceReference
-00003da0: 732e 0a0a 2020 2020 5061 7261 6d65 7465  s...    Paramete
-00003db0: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-00003dc0: 2d0a 2020 2020 4120 3a20 4465 7669 6365  -.    A : Device
-00003dd0: 282f 5265 6665 7265 6e63 6529 206f 7220  (/Reference) or 
-00003de0: 6c69 7374 206f 6620 4465 7669 6365 282f  list of Device(/
-00003df0: 5265 6665 7265 6e63 6529 206f 7220 506f  Reference) or Po
-00003e00: 6c79 676f 6e0a 2020 2020 2020 2020 496e  lygon.        In
-00003e10: 7075 7420 4465 7669 6365 732e 0a20 2020  put Devices..   
-00003e20: 2042 203a 2044 6576 6963 6528 2f52 6566   B : Device(/Ref
-00003e30: 6572 656e 6365 2920 6f72 206c 6973 7420  erence) or list 
-00003e40: 6f66 2044 6576 6963 6528 2f52 6566 6572  of Device(/Refer
-00003e50: 656e 6365 2920 6f72 2050 6f6c 7967 6f6e  ence) or Polygon
-00003e60: 0a20 2020 2020 2020 2049 6e70 7574 2044  .        Input D
-00003e70: 6576 6963 6573 2e0a 2020 2020 6f70 6572  evices..    oper
-00003e80: 6174 696f 6e20 3a20 7b27 6e6f 7427 2c20  ation : {'not', 
-00003e90: 2761 6e64 272c 2027 6f72 272c 2027 786f  'and', 'or', 'xo
-00003ea0: 7227 2c20 2741 2d42 272c 2027 422d 4127  r', 'A-B', 'B-A'
-00003eb0: 2c20 2741 2b42 277d 0a20 2020 2020 2020  , 'A+B'}.       
-00003ec0: 2042 6f6f 6c65 616e 206f 7065 7261 7469   Boolean operati
-00003ed0: 6f6e 2074 6f20 7065 7266 6f72 6d2e 0a20  on to perform.. 
-00003ee0: 2020 2070 7265 6369 7369 6f6e 203a 2066     precision : f
-00003ef0: 6c6f 6174 0a20 2020 2020 2020 2044 6573  loat.        Des
-00003f00: 6972 6564 2070 7265 6369 7369 6f6e 2066  ired precision f
-00003f10: 6f72 2072 6f75 6e64 696e 6720 7665 7274  or rounding vert
-00003f20: 6578 2063 6f6f 7264 696e 6174 6573 2e0a  ex coordinates..
-00003f30: 2020 2020 6e75 6d5f 6469 7669 7369 6f6e      num_division
-00003f40: 7320 3a20 6172 7261 792d 6c69 6b65 5b32  s : array-like[2
-00003f50: 5d20 6f66 2069 6e74 0a20 2020 2020 2020  ] of int.       
-00003f60: 2054 6865 206e 756d 6265 7220 6f66 2064   The number of d
-00003f70: 6976 6973 696f 6e73 2077 6974 6820 7768  ivisions with wh
-00003f80: 6963 6820 7468 6520 6765 6f6d 6574 7279  ich the geometry
-00003f90: 2069 7320 6469 7669 6465 6420 696e 746f   is divided into
-00003fa0: 0a20 2020 2020 2020 206d 756c 7469 706c  .        multipl
-00003fb0: 6520 7265 6374 616e 6775 6c61 7220 7265  e rectangular re
-00003fc0: 6769 6f6e 732e 2054 6869 7320 616c 6c6f  gions. This allo
-00003fd0: 7773 2066 6f72 2065 6163 6820 7265 6769  ws for each regi
-00003fe0: 6f6e 2074 6f20 6265 0a20 2020 2020 2020  on to be.       
-00003ff0: 2070 726f 6365 7373 6564 2073 6571 7565   processed seque
-00004000: 6e74 6961 6c6c 792c 2077 6869 6368 2069  ntially, which i
-00004010: 7320 6d6f 7265 2063 6f6d 7075 7461 7469  s more computati
-00004020: 6f6e 616c 6c79 2065 6666 6963 6965 6e74  onally efficient
-00004030: 2e0a 2020 2020 6d61 785f 706f 696e 7473  ..    max_points
-00004040: 203a 2069 6e74 0a20 2020 2020 2020 2054   : int.        T
-00004050: 6865 206d 6178 696d 756d 206e 756d 6265  he maximum numbe
-00004060: 7220 6f66 2076 6572 7469 6365 7320 7769  r of vertices wi
-00004070: 7468 696e 2074 6865 2072 6573 756c 7469  thin the resulti
-00004080: 6e67 2070 6f6c 7967 6f6e 2e0a 2020 2020  ng polygon..    
-00004090: 6c61 7965 7220 3a20 696e 742c 2061 7272  layer : int, arr
-000040a0: 6179 2d6c 696b 655b 325d 2c20 6f72 2073  ay-like[2], or s
-000040b0: 6574 0a20 2020 2020 2020 2053 7065 6369  et.        Speci
-000040c0: 6669 6320 6c61 7965 7228 7329 2074 6f20  fic layer(s) to 
-000040d0: 7075 7420 706f 6c79 676f 6e20 6765 6f6d  put polygon geom
-000040e0: 6574 7279 206f 6e2e 0a0a 2020 2020 5265  etry on...    Re
-000040f0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00004100: 2d0a 2020 2020 443a 2044 6576 6963 650a  -.    D: Device.
-00004110: 2020 2020 2020 2020 4120 4465 7669 6365          A Device
-00004120: 2063 6f6e 7461 696e 696e 6720 6120 706f   containing a po
-00004130: 6c79 676f 6e28 7329 2077 6974 6820 7468  lygon(s) with th
-00004140: 6520 626f 6f6c 6561 6e20 6f70 6572 6174  e boolean operat
-00004150: 696f 6e73 2062 6574 7765 656e 0a20 2020  ions between.   
-00004160: 2020 2020 2074 6865 2032 2069 6e70 7574       the 2 input
-00004170: 2044 6576 6963 6573 2070 6572 666f 726d   Devices perform
-00004180: 6564 2e0a 0a20 2020 204e 6f74 6573 0a20  ed...    Notes. 
-00004190: 2020 202d 2d2d 2d2d 0a20 2020 2027 412b     -----.    'A+
-000041a0: 4227 2069 7320 6571 7569 7661 6c65 6e74  B' is equivalent
-000041b0: 2074 6f20 276f 7227 2e0a 2020 2020 2741   to 'or'..    'A
-000041c0: 2d42 2720 6973 2065 7175 6976 616c 656e  -B' is equivalen
-000041d0: 7420 746f 2027 6e6f 7427 2e0a 2020 2020  t to 'not'..    
-000041e0: 2742 2d41 2720 6973 2065 7175 6976 616c  'B-A' is equival
-000041f0: 656e 7420 746f 2027 6e6f 7427 2077 6974  ent to 'not' wit
-00004200: 6820 7468 6520 6f70 6572 616e 6473 2073  h the operands s
-00004210: 7769 7463 6865 642e 0a20 2020 2022 2222  witched..    """
-00004220: 0a20 2020 2044 203d 2044 6576 6963 6528  .    D = Device(
-00004230: 2262 6f6f 6c65 616e 2229 0a0a 2020 2020  "boolean")..    
-00004240: 415f 706f 6c79 7320 3d20 5b5d 0a20 2020  A_polys = [].   
-00004250: 2042 5f70 6f6c 7973 203d 205b 5d0a 2020   B_polys = [].  
-00004260: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
-00004270: 6e63 6528 412c 206c 6973 7429 3a0a 2020  nce(A, list):.  
-00004280: 2020 2020 2020 4120 3d20 5b41 5d0a 2020        A = [A].  
-00004290: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
-000042a0: 6e63 6528 422c 206c 6973 7429 3a0a 2020  nce(B, list):.  
-000042b0: 2020 2020 2020 4220 3d20 5b42 5d0a 0a20        B = [B].. 
-000042c0: 2020 2066 6f72 2058 2c20 706f 6c79 7320     for X, polys 
-000042d0: 696e 2028 2841 2c20 415f 706f 6c79 7329  in ((A, A_polys)
-000042e0: 2c20 2842 2c20 425f 706f 6c79 7329 293a  , (B, B_polys)):
-000042f0: 0a20 2020 2020 2020 2066 6f72 2065 2069  .        for e i
-00004300: 6e20 583a 0a20 2020 2020 2020 2020 2020  n X:.           
-00004310: 2069 6620 6973 696e 7374 616e 6365 2865   if isinstance(e
-00004320: 2c20 2844 6576 6963 652c 2044 6576 6963  , (Device, Devic
-00004330: 6552 6566 6572 656e 6365 2929 3a0a 2020  eReference)):.  
-00004340: 2020 2020 2020 2020 2020 2020 2020 706f                po
-00004350: 6c79 732e 6578 7465 6e64 2865 2e67 6574  lys.extend(e.get
-00004360: 5f70 6f6c 7967 6f6e 7328 2929 0a20 2020  _polygons()).   
-00004370: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-00004380: 696e 7374 616e 6365 2865 2c20 506f 6c79  instance(e, Poly
-00004390: 676f 6e29 3a0a 2020 2020 2020 2020 2020  gon):.          
-000043a0: 2020 2020 2020 706f 6c79 732e 6578 7465        polys.exte
-000043b0: 6e64 2865 2e70 6f6c 7967 6f6e 7329 0a0a  nd(e.polygons)..
-000043c0: 2020 2020 6764 735f 6c61 7965 722c 2067      gds_layer, g
-000043d0: 6473 5f64 6174 6174 7970 6520 3d20 5f70  ds_datatype = _p
-000043e0: 6172 7365 5f6c 6179 6572 286c 6179 6572  arse_layer(layer
-000043f0: 290a 0a20 2020 206f 7065 7261 7469 6f6e  )..    operation
-00004400: 203d 206f 7065 7261 7469 6f6e 2e6c 6f77   = operation.low
-00004410: 6572 2829 2e72 6570 6c61 6365 2822 2022  er().replace(" "
-00004420: 2c20 2222 290a 2020 2020 6966 206f 7065  , "").    if ope
-00004430: 7261 7469 6f6e 203d 3d20 2261 2d62 223a  ration == "a-b":
-00004440: 0a20 2020 2020 2020 206f 7065 7261 7469  .        operati
-00004450: 6f6e 203d 2022 6e6f 7422 0a20 2020 2065  on = "not".    e
-00004460: 6c69 6620 6f70 6572 6174 696f 6e20 3d3d  lif operation ==
-00004470: 2022 622d 6122 3a0a 2020 2020 2020 2020   "b-a":.        
-00004480: 6f70 6572 6174 696f 6e20 3d20 226e 6f74  operation = "not
-00004490: 220a 2020 2020 2020 2020 415f 706f 6c79  ".        A_poly
-000044a0: 732c 2042 5f70 6f6c 7973 203d 2042 5f70  s, B_polys = B_p
-000044b0: 6f6c 7973 2c20 415f 706f 6c79 730a 2020  olys, A_polys.  
-000044c0: 2020 656c 6966 206f 7065 7261 7469 6f6e    elif operation
-000044d0: 203d 3d20 2261 2b62 223a 0a20 2020 2020   == "a+b":.     
-000044e0: 2020 206f 7065 7261 7469 6f6e 203d 2022     operation = "
-000044f0: 6f72 220a 2020 2020 656c 6966 206f 7065  or".    elif ope
-00004500: 7261 7469 6f6e 206e 6f74 2069 6e20 5b22  ration not in ["
-00004510: 6e6f 7422 2c20 2261 6e64 222c 2022 6f72  not", "and", "or
-00004520: 222c 2022 786f 7222 2c20 2261 2d62 222c  ", "xor", "a-b",
-00004530: 2022 622d 6122 2c20 2261 2b62 225d 3a0a   "b-a", "a+b"]:.
-00004540: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00004550: 6c75 6545 7272 6f72 280a 2020 2020 2020  lueError(.      
-00004560: 2020 2020 2020 225b 5048 4944 4c5d 2070        "[PHIDL] p
-00004570: 6869 646c 2e67 656f 6d65 7472 792e 626f  hidl.geometry.bo
-00004580: 6f6c 6561 6e28 2920 606f 7065 7261 7469  olean() `operati
-00004590: 6f6e 6020 220a 2020 2020 2020 2020 2020  on` ".          
-000045a0: 2020 2270 6172 616d 6574 6572 206e 6f74    "parameter not
-000045b0: 2072 6563 6f67 6e69 7a65 642c 206d 7573   recognized, mus
-000045c0: 7420 6265 206f 6e65 206f 6620 7468 6520  t be one of the 
-000045d0: 220a 2020 2020 2020 2020 2020 2020 2266  ".            "f
-000045e0: 6f6c 6c6f 7769 6e67 3a20 2027 6e6f 7427  ollowing:  'not'
-000045f0: 2c20 2761 6e64 272c 2027 6f72 272c 2027  , 'and', 'or', '
-00004600: 786f 7227 2c20 2741 2d42 272c 2022 0a20  xor', 'A-B', ". 
-00004610: 2020 2020 2020 2020 2020 2022 2742 2d41             "'B-A
-00004620: 272c 2027 412b 4227 220a 2020 2020 2020  ', 'A+B'".      
-00004630: 2020 290a 0a20 2020 2023 2043 6865 636b    )..    # Check
-00004640: 2066 6f72 2074 7269 7669 616c 2073 6f6c   for trivial sol
-00004650: 7574 696f 6e73 0a20 2020 2069 6620 2828  utions.    if ((
-00004660: 6c65 6e28 415f 706f 6c79 7329 203d 3d20  len(A_polys) == 
-00004670: 3029 206f 7220 286c 656e 2842 5f70 6f6c  0) or (len(B_pol
-00004680: 7973 2920 3d3d 2030 2929 2061 6e64 2028  ys) == 0)) and (
-00004690: 6f70 6572 6174 696f 6e20 213d 2022 6f72  operation != "or
-000046a0: 2229 3a0a 2020 2020 2020 2020 6966 206f  "):.        if o
-000046b0: 7065 7261 7469 6f6e 203d 3d20 226e 6f74  peration == "not
-000046c0: 223a 0a20 2020 2020 2020 2020 2020 2069  ":.            i
-000046d0: 6620 6c65 6e28 415f 706f 6c79 7329 203d  f len(A_polys) =
-000046e0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-000046f0: 2020 2020 2070 203d 204e 6f6e 650a 2020       p = None.  
-00004700: 2020 2020 2020 2020 2020 656c 6966 206c            elif l
-00004710: 656e 2842 5f70 6f6c 7973 2920 3d3d 2030  en(B_polys) == 0
-00004720: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00004730: 2020 7020 3d20 415f 706f 6c79 730a 2020    p = A_polys.  
-00004740: 2020 2020 2020 656c 6966 206f 7065 7261        elif opera
-00004750: 7469 6f6e 203d 3d20 2261 6e64 223a 0a20  tion == "and":. 
-00004760: 2020 2020 2020 2020 2020 2070 203d 204e             p = N
-00004770: 6f6e 650a 2020 2020 2020 2020 656c 6966  one.        elif
-00004780: 206f 7065 7261 7469 6f6e 203d 3d20 2278   operation == "x
-00004790: 6f72 223a 0a20 2020 2020 2020 2020 2020  or":.           
-000047a0: 2069 6620 286c 656e 2841 5f70 6f6c 7973   if (len(A_polys
-000047b0: 2920 3d3d 2030 2920 616e 6420 286c 656e  ) == 0) and (len
-000047c0: 2842 5f70 6f6c 7973 2920 3d3d 2030 293a  (B_polys) == 0):
-000047d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000047e0: 2070 203d 204e 6f6e 650a 2020 2020 2020   p = None.      
-000047f0: 2020 2020 2020 656c 6966 206c 656e 2841        elif len(A
-00004800: 5f70 6f6c 7973 2920 3d3d 2030 3a0a 2020  _polys) == 0:.  
-00004810: 2020 2020 2020 2020 2020 2020 2020 7020                p 
-00004820: 3d20 425f 706f 6c79 730a 2020 2020 2020  = B_polys.      
-00004830: 2020 2020 2020 656c 6966 206c 656e 2842        elif len(B
-00004840: 5f70 6f6c 7973 2920 3d3d 2030 3a0a 2020  _polys) == 0:.  
-00004850: 2020 2020 2020 2020 2020 2020 2020 7020                p 
-00004860: 3d20 415f 706f 6c79 730a 2020 2020 656c  = A_polys.    el
-00004870: 6966 2028 6c65 6e28 415f 706f 6c79 7329  if (len(A_polys)
-00004880: 203d 3d20 3029 2061 6e64 2028 6c65 6e28   == 0) and (len(
-00004890: 425f 706f 6c79 7329 203d 3d20 3029 2061  B_polys) == 0) a
-000048a0: 6e64 2028 6f70 6572 6174 696f 6e20 3d3d  nd (operation ==
-000048b0: 2022 6f72 2229 3a0a 2020 2020 2020 2020   "or"):.        
-000048c0: 7020 3d20 4e6f 6e65 0a20 2020 2065 6c73  p = None.    els
-000048d0: 653a 0a20 2020 2020 2020 2023 2049 6620  e:.        # If 
-000048e0: 6e6f 2074 7269 7669 616c 2073 6f6c 7574  no trivial solut
-000048f0: 696f 6e73 2c20 7275 6e20 626f 6f6c 6561  ions, run boolea
-00004900: 6e20 6f70 6572 6174 696f 6e20 6569 7468  n operation eith
-00004910: 6572 2069 6e20 7061 7261 6c6c 656c 206f  er in parallel o
-00004920: 720a 2020 2020 2020 2020 2320 7374 7261  r.        # stra
-00004930: 6967 6874 0a20 2020 2020 2020 2069 6620  ight.        if 
-00004940: 616c 6c28 6e70 2e61 7272 6179 286e 756d  all(np.array(num
-00004950: 5f64 6976 6973 696f 6e73 2920 3d3d 206e  _divisions) == n
-00004960: 702e 6172 7261 7928 5b31 2c20 315d 2929  p.array([1, 1]))
-00004970: 3a0a 2020 2020 2020 2020 2020 2020 7020  :.            p 
-00004980: 3d20 6764 7370 792e 626f 6f6c 6561 6e28  = gdspy.boolean(
-00004990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000049a0: 206f 7065 7261 6e64 313d 415f 706f 6c79   operand1=A_poly
-000049b0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-000049c0: 2020 206f 7065 7261 6e64 323d 425f 706f     operand2=B_po
-000049d0: 6c79 732c 0a20 2020 2020 2020 2020 2020  lys,.           
-000049e0: 2020 2020 206f 7065 7261 7469 6f6e 3d6f       operation=o
-000049f0: 7065 7261 7469 6f6e 2c0a 2020 2020 2020  peration,.      
-00004a00: 2020 2020 2020 2020 2020 7072 6563 6973            precis
-00004a10: 696f 6e3d 7072 6563 6973 696f 6e2c 0a20  ion=precision,. 
-00004a20: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00004a30: 6178 5f70 6f69 6e74 733d 6d61 785f 706f  ax_points=max_po
-00004a40: 696e 7473 2c0a 2020 2020 2020 2020 2020  ints,.          
-00004a50: 2020 2020 2020 6c61 7965 723d 6764 735f        layer=gds_
-00004a60: 6c61 7965 722c 0a20 2020 2020 2020 2020  layer,.         
-00004a70: 2020 2020 2020 2064 6174 6174 7970 653d         datatype=
-00004a80: 6764 735f 6461 7461 7479 7065 2c0a 2020  gds_datatype,.  
-00004a90: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00004aa0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00004ab0: 2020 2020 2020 7020 3d20 5f62 6f6f 6c65        p = _boole
-00004ac0: 616e 5f70 6f6c 7967 6f6e 735f 7061 7261  an_polygons_para
-00004ad0: 6c6c 656c 280a 2020 2020 2020 2020 2020  llel(.          
-00004ae0: 2020 2020 2020 706f 6c79 676f 6e73 5f41        polygons_A
-00004af0: 3d41 5f70 6f6c 7973 2c0a 2020 2020 2020  =A_polys,.      
-00004b00: 2020 2020 2020 2020 2020 706f 6c79 676f            polygo
-00004b10: 6e73 5f42 3d42 5f70 6f6c 7973 2c0a 2020  ns_B=B_polys,.  
-00004b20: 2020 2020 2020 2020 2020 2020 2020 6e75                nu
-00004b30: 6d5f 6469 7669 7369 6f6e 733d 6e75 6d5f  m_divisions=num_
-00004b40: 6469 7669 7369 6f6e 732c 0a20 2020 2020  divisions,.     
-00004b50: 2020 2020 2020 2020 2020 206f 7065 7261             opera
-00004b60: 7469 6f6e 3d6f 7065 7261 7469 6f6e 2c0a  tion=operation,.
-00004b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004b80: 7072 6563 6973 696f 6e3d 7072 6563 6973  precision=precis
-00004b90: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
-00004ba0: 2029 0a0a 2020 2020 6966 2070 2069 7320   )..    if p is 
-00004bb0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00004bc0: 2020 706f 6c79 676f 6e73 203d 2044 2e61    polygons = D.a
-00004bd0: 6464 5f70 6f6c 7967 6f6e 2870 2c20 6c61  dd_polygon(p, la
-00004be0: 7965 723d 6c61 7965 7229 0a20 2020 2020  yer=layer).     
-00004bf0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00004c00: 2070 6f6c 7967 6f6e 2e66 7261 6374 7572   polygon.fractur
-00004c10: 6528 6d61 785f 706f 696e 7473 3d6d 6178  e(max_points=max
-00004c20: 5f70 6f69 6e74 732c 2070 7265 6369 7369  _points, precisi
-00004c30: 6f6e 3d70 7265 6369 7369 6f6e 290a 2020  on=precision).  
-00004c40: 2020 2020 2020 2020 2020 666f 7220 706f            for po
-00004c50: 6c79 676f 6e20 696e 2070 6f6c 7967 6f6e  lygon in polygon
-00004c60: 730a 2020 2020 2020 2020 5d0a 2020 2020  s.        ].    
-00004c70: 7265 7475 726e 2044 0a0a 0a64 6566 206f  return D...def o
-00004c80: 7574 6c69 6e65 280a 2020 2020 656c 656d  utline(.    elem
-00004c90: 656e 7473 2c0a 2020 2020 6469 7374 616e  ents,.    distan
-00004ca0: 6365 3d31 2c0a 2020 2020 7072 6563 6973  ce=1,.    precis
-00004cb0: 696f 6e3d 3165 2d34 2c0a 2020 2020 6e75  ion=1e-4,.    nu
-00004cc0: 6d5f 6469 7669 7369 6f6e 733d 5b31 2c20  m_divisions=[1, 
-00004cd0: 315d 2c0a 2020 2020 6a6f 696e 3d22 6d69  1],.    join="mi
-00004ce0: 7465 7222 2c0a 2020 2020 746f 6c65 7261  ter",.    tolera
-00004cf0: 6e63 653d 322c 0a20 2020 206a 6f69 6e5f  nce=2,.    join_
-00004d00: 6669 7273 743d 5472 7565 2c0a 2020 2020  first=True,.    
-00004d10: 6d61 785f 706f 696e 7473 3d34 3030 302c  max_points=4000,
-00004d20: 0a20 2020 206f 7065 6e5f 706f 7274 733d  .    open_ports=
-00004d30: 4661 6c73 652c 0a20 2020 206c 6179 6572  False,.    layer
-00004d40: 3d30 2c0a 293a 0a20 2020 2022 2222 4372  =0,.):.    """Cr
-00004d50: 6561 7465 7320 616e 206f 7574 6c69 6e65  eates an outline
-00004d60: 2061 726f 756e 6420 616c 6c20 7468 6520   around all the 
-00004d70: 706f 6c79 676f 6e73 2070 6173 7365 6420  polygons passed 
-00004d80: 696e 2074 6865 2060 656c 656d 656e 7473  in the `elements
-00004d90: 600a 2020 2020 6172 6775 6d65 6e74 2e20  `.    argument. 
-00004da0: 6065 6c65 6d65 6e74 7360 206d 6179 2062  `elements` may b
-00004db0: 6520 6120 4465 7669 6365 2c20 506f 6c79  e a Device, Poly
-00004dc0: 676f 6e2c 206f 7220 6c69 7374 206f 6620  gon, or list of 
-00004dd0: 4465 7669 6365 732e 0a0a 2020 2020 5061  Devices...    Pa
-00004de0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-00004df0: 2d2d 2d2d 2d2d 2d0a 2020 2020 656c 656d  -------.    elem
-00004e00: 656e 7473 203a 2044 6576 6963 6528 2f52  ents : Device(/R
-00004e10: 6566 6572 656e 6365 292c 206c 6973 7420  eference), list 
-00004e20: 6f66 2044 6576 6963 6528 2f52 6566 6572  of Device(/Refer
-00004e30: 656e 6365 292c 206f 7220 506f 6c79 676f  ence), or Polygo
-00004e40: 6e0a 2020 2020 2020 2020 506f 6c79 676f  n.        Polygo
-00004e50: 6e73 2074 6f20 6f75 746c 696e 6520 6f72  ns to outline or
-00004e60: 2044 6576 6963 6520 636f 6e74 6169 6e69   Device containi
-00004e70: 6e67 2070 6f6c 7967 6f6e 7320 746f 206f  ng polygons to o
-00004e80: 7574 6c69 6e65 2e0a 2020 2020 6469 7374  utline..    dist
-00004e90: 616e 6365 203a 2069 6e74 206f 7220 666c  ance : int or fl
-00004ea0: 6f61 740a 2020 2020 2020 2020 4469 7374  oat.        Dist
-00004eb0: 616e 6365 2074 6f20 6f66 6673 6574 2070  ance to offset p
-00004ec0: 6f6c 7967 6f6e 732e 2050 6f73 6974 6976  olygons. Positiv
-00004ed0: 6520 7661 6c75 6573 2065 7870 616e 642c  e values expand,
-00004ee0: 206e 6567 6174 6976 6520 7368 7269 6e6b   negative shrink
-00004ef0: 2e0a 2020 2020 7072 6563 6973 696f 6e20  ..    precision 
-00004f00: 3a20 666c 6f61 740a 2020 2020 2020 2020  : float.        
-00004f10: 4465 7369 7265 6420 7072 6563 6973 696f  Desired precisio
-00004f20: 6e20 666f 7220 726f 756e 6469 6e67 2076  n for rounding v
-00004f30: 6572 7465 7820 636f 6f72 6469 6e61 7465  ertex coordinate
-00004f40: 732e 0a20 2020 206e 756d 5f64 6976 6973  s..    num_divis
-00004f50: 696f 6e73 203a 2061 7272 6179 2d6c 696b  ions : array-lik
-00004f60: 655b 325d 206f 6620 696e 740a 2020 2020  e[2] of int.    
-00004f70: 2020 2020 5468 6520 6e75 6d62 6572 206f      The number o
-00004f80: 6620 6469 7669 7369 6f6e 7320 7769 7468  f divisions with
-00004f90: 2077 6869 6368 2074 6865 2067 656f 6d65   which the geome
-00004fa0: 7472 7920 6973 2064 6976 6964 6564 2069  try is divided i
-00004fb0: 6e74 6f0a 2020 2020 2020 2020 6d75 6c74  nto.        mult
-00004fc0: 6970 6c65 2072 6563 7461 6e67 756c 6172  iple rectangular
-00004fd0: 2072 6567 696f 6e73 2e20 5468 6973 2061   regions. This a
-00004fe0: 6c6c 6f77 7320 666f 7220 6561 6368 2072  llows for each r
-00004ff0: 6567 696f 6e20 746f 2062 650a 2020 2020  egion to be.    
-00005000: 2020 2020 7072 6f63 6573 7365 6420 7365      processed se
-00005010: 7175 656e 7469 616c 6c79 2c20 7768 6963  quentially, whic
-00005020: 6820 6973 206d 6f72 6520 636f 6d70 7574  h is more comput
-00005030: 6174 696f 6e61 6c6c 7920 6566 6669 6369  ationally effici
-00005040: 656e 742e 0a20 2020 206a 6f69 6e20 3a20  ent..    join : 
-00005050: 7b27 6d69 7465 7227 2c20 2762 6576 656c  {'miter', 'bevel
-00005060: 272c 2027 726f 756e 6427 7d0a 2020 2020  ', 'round'}.    
-00005070: 2020 2020 5479 7065 206f 6620 6a6f 696e      Type of join
-00005080: 2075 7365 6420 746f 2063 7265 6174 6520   used to create 
-00005090: 7468 6520 6f66 6673 6574 2070 6f6c 7967  the offset polyg
-000050a0: 6f6e 2e0a 2020 2020 746f 6c65 7261 6e63  on..    toleranc
-000050b0: 6520 3a20 696e 7420 6f72 2066 6c6f 6174  e : int or float
-000050c0: 0a20 2020 2020 2020 2046 6f72 206d 6974  .        For mit
-000050d0: 6572 206a 6f69 6e74 732c 2074 6869 7320  er joints, this 
-000050e0: 6e75 6d62 6572 206d 7573 7420 6265 2061  number must be a
-000050f0: 7420 6c65 6173 7420 3220 616e 6420 6974  t least 2 and it
-00005100: 2072 6570 7265 7365 6e74 7320 7468 650a   represents the.
-00005110: 2020 2020 2020 2020 6d61 7869 6d61 6c20          maximal 
-00005120: 6469 7374 616e 6365 2069 6e20 6d75 6c74  distance in mult
-00005130: 6970 6c65 7320 6f66 206f 6666 7365 7420  iples of offset 
-00005140: 6265 7477 6565 6e20 6e65 7720 7665 7274  between new vert
-00005150: 6963 6573 2061 6e64 2074 6865 6972 0a20  ices and their. 
-00005160: 2020 2020 2020 206f 7269 6769 6e61 6c20         original 
-00005170: 706f 7369 7469 6f6e 2062 6566 6f72 6520  position before 
-00005180: 6265 7665 6c69 6e67 2074 6f20 6176 6f69  beveling to avoi
-00005190: 6420 7370 696b 6573 2061 7420 6163 7574  d spikes at acut
-000051a0: 6520 6a6f 696e 7473 2e20 466f 720a 2020  e joints. For.  
-000051b0: 2020 2020 2020 726f 756e 6420 6a6f 696e        round join
-000051c0: 7473 2c20 6974 2069 6e64 6963 6174 6573  ts, it indicates
-000051d0: 2074 6865 2063 7572 7661 7475 7265 2072   the curvature r
-000051e0: 6573 6f6c 7574 696f 6e20 696e 206e 756d  esolution in num
-000051f0: 6265 7220 6f66 0a20 2020 2020 2020 2070  ber of.        p
-00005200: 6f69 6e74 7320 7065 7220 6675 6c6c 2063  oints per full c
-00005210: 6972 636c 652e 0a20 2020 206a 6f69 6e5f  ircle..    join_
-00005220: 6669 7273 7420 3a20 626f 6f6c 0a20 2020  first : bool.   
-00005230: 2020 2020 204a 6f69 6e20 616c 6c20 7061       Join all pa
-00005240: 7468 7320 6265 666f 7265 206f 6666 7365  ths before offse
-00005250: 7474 696e 6720 746f 2061 766f 6964 2075  tting to avoid u
-00005260: 6e6e 6563 6573 7361 7279 206a 6f69 6e73  nnecessary joins
-00005270: 2069 6e0a 2020 2020 2020 2020 6164 6a61   in.        adja
-00005280: 6365 6e74 2070 6f6c 7967 6f6e 2073 6964  cent polygon sid
-00005290: 6573 2e0a 2020 2020 6d61 785f 706f 696e  es..    max_poin
-000052a0: 7473 203a 2069 6e74 0a20 2020 2020 2020  ts : int.       
-000052b0: 2054 6865 206d 6178 696d 756d 206e 756d   The maximum num
-000052c0: 6265 7220 6f66 2076 6572 7469 6365 7320  ber of vertices 
-000052d0: 7769 7468 696e 2074 6865 2072 6573 756c  within the resul
-000052e0: 7469 6e67 2070 6f6c 7967 6f6e 2e0a 2020  ting polygon..  
-000052f0: 2020 6f70 656e 5f70 6f72 7473 203a 2062    open_ports : b
-00005300: 6f6f 6c20 6f72 2066 6c6f 6174 0a20 2020  ool or float.   
-00005310: 2020 2020 2049 6620 6e6f 7420 4661 6c73       If not Fals
-00005320: 652c 2068 6f6c 6573 2077 696c 6c20 6265  e, holes will be
-00005330: 2063 7574 2069 6e20 7468 6520 6f75 746c   cut in the outl
-00005340: 696e 6520 7375 6368 2074 6861 7420 7468  ine such that th
-00005350: 6520 506f 7274 7320 6172 650a 2020 2020  e Ports are.    
-00005360: 2020 2020 6e6f 7420 636f 7665 7265 642e      not covered.
-00005370: 2049 6620 5472 7565 2c20 7468 6520 686f   If True, the ho
-00005380: 6c65 7320 7769 6c6c 2068 6176 6520 7468  les will have th
-00005390: 6520 7361 6d65 2077 6964 7468 2061 7320  e same width as 
-000053a0: 7468 6520 506f 7274 732e 0a20 2020 2020  the Ports..     
-000053b0: 2020 2049 6620 6120 666c 6f61 742c 2074     If a float, t
-000053c0: 6865 2068 6f6c 6573 2077 696c 6c20 6265  he holes will be
-000053d0: 2062 6520 7769 6465 6e65 6420 6279 2074   be widened by t
-000053e0: 6861 7420 7661 6c75 6520 2875 7365 6675  hat value (usefu
-000053f0: 6c20 666f 7220 6675 6c6c 790a 2020 2020  l for fully.    
-00005400: 2020 2020 636c 6561 7269 6e67 2074 6865      clearing the
-00005410: 206f 7574 6c69 6e65 2061 726f 756e 6420   outline around 
-00005420: 7468 6520 506f 7274 7320 666f 7220 706f  the Ports for po
-00005430: 7369 7469 7665 2d74 6f6e 6520 7072 6f63  sitive-tone proc
-00005440: 6573 7365 730a 2020 2020 6c61 7965 7220  esses.    layer 
-00005450: 3a20 696e 742c 2061 7272 6179 2d6c 696b  : int, array-lik
-00005460: 655b 325d 2c20 6f72 2073 6574 0a20 2020  e[2], or set.   
-00005470: 2020 2020 2053 7065 6369 6669 6320 6c61       Specific la
-00005480: 7965 7228 7329 2074 6f20 7075 7420 706f  yer(s) to put po
-00005490: 6c79 676f 6e20 6765 6f6d 6574 7279 206f  lygon geometry o
-000054a0: 6e2e 290a 0a20 2020 2052 6574 7572 6e73  n.)..    Returns
-000054b0: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-000054c0: 2044 203a 2044 6576 6963 650a 2020 2020   D : Device.    
-000054d0: 2020 2020 4120 4465 7669 6365 2063 6f6e      A Device con
-000054e0: 7461 696e 696e 6720 7468 6520 6f75 746c  taining the outl
-000054f0: 696e 6564 2070 6f6c 7967 6f6e 2873 292e  ined polygon(s).
-00005500: 0a20 2020 2022 2222 0a20 2020 2044 203d  .    """.    D =
-00005510: 2044 6576 6963 6528 226f 7574 6c69 6e65   Device("outline
-00005520: 2229 0a20 2020 2069 6620 6e6f 7420 6973  ").    if not is
-00005530: 696e 7374 616e 6365 2865 6c65 6d65 6e74  instance(element
-00005540: 732c 206c 6973 7429 3a0a 2020 2020 2020  s, list):.      
-00005550: 2020 656c 656d 656e 7473 203d 205b 656c    elements = [el
-00005560: 656d 656e 7473 5d0a 2020 2020 706f 7274  ements].    port
-00005570: 5f6c 6973 7420 3d20 5b5d 0a20 2020 2066  _list = [].    f
-00005580: 6f72 2065 2069 6e20 656c 656d 656e 7473  or e in elements
-00005590: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
-000055a0: 6e73 7461 6e63 6528 652c 2044 6576 6963  nstance(e, Devic
-000055b0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-000055c0: 442e 6164 645f 7265 6628 6529 0a20 2020  D.add_ref(e).   
-000055d0: 2020 2020 2020 2020 2070 6f72 745f 6c69           port_li
-000055e0: 7374 202b 3d20 6c69 7374 2865 2e70 6f72  st += list(e.por
-000055f0: 7473 2e76 616c 7565 7328 2929 0a20 2020  ts.values()).   
-00005600: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00005610: 2020 2020 2020 2044 2e61 6464 2865 290a         D.add(e).
-00005620: 2020 2020 6764 735f 6c61 7965 722c 2067      gds_layer, g
-00005630: 6473 5f64 6174 6174 7970 6520 3d20 5f70  ds_datatype = _p
-00005640: 6172 7365 5f6c 6179 6572 286c 6179 6572  arse_layer(layer
-00005650: 290a 0a20 2020 2044 5f62 6c6f 6174 6564  )..    D_bloated
-00005660: 203d 206f 6666 7365 7428 0a20 2020 2020   = offset(.     
-00005670: 2020 2044 2c0a 2020 2020 2020 2020 6469     D,.        di
-00005680: 7374 616e 6365 3d64 6973 7461 6e63 652c  stance=distance,
-00005690: 0a20 2020 2020 2020 206a 6f69 6e5f 6669  .        join_fi
-000056a0: 7273 743d 6a6f 696e 5f66 6972 7374 2c0a  rst=join_first,.
-000056b0: 2020 2020 2020 2020 6e75 6d5f 6469 7669          num_divi
-000056c0: 7369 6f6e 733d 6e75 6d5f 6469 7669 7369  sions=num_divisi
-000056d0: 6f6e 732c 0a20 2020 2020 2020 2070 7265  ons,.        pre
-000056e0: 6369 7369 6f6e 3d70 7265 6369 7369 6f6e  cision=precision
-000056f0: 2c0a 2020 2020 2020 2020 6d61 785f 706f  ,.        max_po
-00005700: 696e 7473 3d6d 6178 5f70 6f69 6e74 732c  ints=max_points,
-00005710: 0a20 2020 2020 2020 206a 6f69 6e3d 6a6f  .        join=jo
-00005720: 696e 2c0a 2020 2020 2020 2020 746f 6c65  in,.        tole
-00005730: 7261 6e63 653d 746f 6c65 7261 6e63 652c  rance=tolerance,
-00005740: 0a20 2020 2020 2020 206c 6179 6572 3d6c  .        layer=l
-00005750: 6179 6572 2c0a 2020 2020 290a 0a20 2020  ayer,.    )..   
-00005760: 2054 7269 6d20 3d20 4465 7669 6365 2829   Trim = Device()
-00005770: 0a20 2020 2069 6620 6f70 656e 5f70 6f72  .    if open_por
-00005780: 7473 2069 7320 6e6f 7420 4661 6c73 653a  ts is not False:
-00005790: 0a20 2020 2020 2020 2069 6620 6f70 656e  .        if open
-000057a0: 5f70 6f72 7473 2069 7320 5472 7565 3a0a  _ports is True:.
-000057b0: 2020 2020 2020 2020 2020 2020 7472 696d              trim
-000057c0: 5f77 6964 7468 203d 2030 0a20 2020 2020  _width = 0.     
-000057d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000057e0: 2020 2020 2074 7269 6d5f 7769 6474 6820       trim_width 
-000057f0: 3d20 6f70 656e 5f70 6f72 7473 202a 2032  = open_ports * 2
-00005800: 0a20 2020 2020 2020 2066 6f72 2070 6f72  .        for por
-00005810: 7420 696e 2070 6f72 745f 6c69 7374 3a0a  t in port_list:.
-00005820: 2020 2020 2020 2020 2020 2020 7472 696d              trim
-00005830: 203d 2063 6f6d 7061 7373 2873 697a 653d   = compass(size=
-00005840: 2864 6973 7461 6e63 6520 2b20 3620 2a20  (distance + 6 * 
-00005850: 7072 6563 6973 696f 6e2c 2070 6f72 742e  precision, port.
-00005860: 7769 6474 6820 2b20 7472 696d 5f77 6964  width + trim_wid
-00005870: 7468 2929 0a20 2020 2020 2020 2020 2020  th)).           
-00005880: 2074 7269 6d5f 7265 6620 3d20 5472 696d   trim_ref = Trim
-00005890: 203c 3c20 7472 696d 0a20 2020 2020 2020   << trim.       
-000058a0: 2020 2020 2074 7269 6d5f 7265 662e 636f       trim_ref.co
-000058b0: 6e6e 6563 7428 2245 222c 2070 6f72 742c  nnect("E", port,
-000058c0: 206f 7665 726c 6170 3d32 202a 2070 7265   overlap=2 * pre
-000058d0: 6369 7369 6f6e 290a 0a20 2020 204f 7574  cision)..    Out
-000058e0: 6c69 6e65 203d 2062 6f6f 6c65 616e 280a  line = boolean(.
-000058f0: 2020 2020 2020 2020 413d 445f 626c 6f61          A=D_bloa
-00005900: 7465 642c 0a20 2020 2020 2020 2042 3d5b  ted,.        B=[
-00005910: 442c 2054 7269 6d5d 2c0a 2020 2020 2020  D, Trim],.      
-00005920: 2020 6f70 6572 6174 696f 6e3d 2241 2d42    operation="A-B
-00005930: 2220 6966 2064 6973 7461 6e63 6520 3e20  " if distance > 
-00005940: 3020 656c 7365 2022 422d 4122 2c0a 2020  0 else "B-A",.  
-00005950: 2020 2020 2020 6e75 6d5f 6469 7669 7369        num_divisi
-00005960: 6f6e 733d 6e75 6d5f 6469 7669 7369 6f6e  ons=num_division
-00005970: 732c 0a20 2020 2020 2020 206d 6178 5f70  s,.        max_p
-00005980: 6f69 6e74 733d 6d61 785f 706f 696e 7473  oints=max_points
-00005990: 2c0a 2020 2020 2020 2020 7072 6563 6973  ,.        precis
-000059a0: 696f 6e3d 7072 6563 6973 696f 6e2c 0a20  ion=precision,. 
-000059b0: 2020 2020 2020 206c 6179 6572 3d6c 6179         layer=lay
-000059c0: 6572 2c0a 2020 2020 290a 2020 2020 6966  er,.    ).    if
-000059d0: 206f 7065 6e5f 706f 7274 7320 6973 206e   open_ports is n
-000059e0: 6f74 2046 616c 7365 2061 6e64 206c 656e  ot False and len
-000059f0: 2865 6c65 6d65 6e74 7329 203d 3d20 313a  (elements) == 1:
-00005a00: 0a20 2020 2020 2020 2066 6f72 2070 6f72  .        for por
-00005a10: 7420 696e 2070 6f72 745f 6c69 7374 3a0a  t in port_list:.
-00005a20: 2020 2020 2020 2020 2020 2020 4f75 746c              Outl
-00005a30: 696e 652e 6164 645f 706f 7274 2870 6f72  ine.add_port(por
-00005a40: 743d 706f 7274 290a 2020 2020 7265 7475  t=port).    retu
-00005a50: 726e 204f 7574 6c69 6e65 0a0a 0a64 6566  rn Outline...def
-00005a60: 2069 6e76 6572 7428 0a20 2020 2065 6c65   invert(.    ele
-00005a70: 6d65 6e74 732c 2062 6f72 6465 723d 3130  ments, border=10
-00005a80: 2c20 7072 6563 6973 696f 6e3d 3165 2d34  , precision=1e-4
-00005a90: 2c20 6e75 6d5f 6469 7669 7369 6f6e 733d  , num_divisions=
-00005aa0: 5b31 2c20 315d 2c20 6d61 785f 706f 696e  [1, 1], max_poin
-00005ab0: 7473 3d34 3030 302c 206c 6179 6572 3d30  ts=4000, layer=0
-00005ac0: 0a29 3a0a 2020 2020 2222 2243 7265 6174  .):.    """Creat
-00005ad0: 6573 2061 6e20 696e 7665 7274 6564 2076  es an inverted v
-00005ae0: 6572 7369 6f6e 206f 6620 7468 6520 696e  ersion of the in
-00005af0: 7075 7420 7368 6170 6573 2077 6974 6820  put shapes with 
-00005b00: 616e 2061 6464 6974 696f 6e61 6c0a 2020  an additional.  
-00005b10: 2020 626f 7264 6572 2061 726f 756e 6420    border around 
-00005b20: 7468 6520 6564 6765 732e 0a0a 2020 2020  the edges...    
-00005b30: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-00005b40: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 656c  ---------.    el
-00005b50: 656d 656e 7473 203a 2044 6576 6963 6528  ements : Device(
-00005b60: 2f52 6566 6572 656e 6365 292c 206c 6973  /Reference), lis
-00005b70: 7420 6f66 2044 6576 6963 6528 2f52 6566  t of Device(/Ref
-00005b80: 6572 656e 6365 292c 206f 7220 506f 6c79  erence), or Poly
-00005b90: 676f 6e0a 2020 2020 2020 2020 4120 4465  gon.        A De
-00005ba0: 7669 6365 2063 6f6e 7461 696e 696e 6720  vice containing 
-00005bb0: 7468 6520 706f 6c79 676f 6e73 2074 6f20  the polygons to 
-00005bc0: 696e 7665 7274 2e0a 2020 2020 626f 7264  invert..    bord
-00005bd0: 6572 203a 2069 6e74 206f 7220 666c 6f61  er : int or floa
-00005be0: 740a 2020 2020 2020 2020 5369 7a65 206f  t.        Size o
-00005bf0: 6620 7468 6520 626f 7264 6572 2061 726f  f the border aro
-00005c00: 756e 6420 7468 6520 696e 7665 7274 6564  und the inverted
-00005c10: 2073 6861 7065 2028 626f 7264 6572 2076   shape (border v
-00005c20: 616c 7565 2069 7320 7468 650a 2020 2020  alue is the.    
-00005c30: 2020 2020 6469 7374 616e 6365 2066 726f      distance fro
-00005c40: 6d20 7468 6520 6564 6765 7320 6f66 2074  m the edges of t
-00005c50: 6865 2062 6f75 6e64 6172 7920 626f 7820  he boundary box 
-00005c60: 6465 6669 6e69 6e67 2074 6865 2069 6e76  defining the inv
-00005c70: 6572 7465 640a 2020 2020 2020 2020 7368  erted.        sh
-00005c80: 6170 6520 746f 2074 6865 2062 6f72 6465  ape to the borde
-00005c90: 722c 2061 6e64 2069 7320 6170 706c 6965  r, and is applie
-00005ca0: 6420 746f 2061 6c6c 2034 2073 6964 6573  d to all 4 sides
-00005cb0: 206f 6620 7468 6520 7368 6170 6529 2e0a   of the shape)..
-00005cc0: 2020 2020 7072 6563 6973 696f 6e20 3a20      precision : 
-00005cd0: 666c 6f61 740a 2020 2020 2020 2020 4465  float.        De
-00005ce0: 7369 7265 6420 7072 6563 6973 696f 6e20  sired precision 
-00005cf0: 666f 7220 726f 756e 6469 6e67 2076 6572  for rounding ver
-00005d00: 7465 7820 636f 6f72 6469 6e61 7465 732e  tex coordinates.
-00005d10: 0a20 2020 206e 756d 5f64 6976 6973 696f  .    num_divisio
-00005d20: 6e73 203a 2061 7272 6179 2d6c 696b 655b  ns : array-like[
-00005d30: 325d 206f 6620 696e 740a 2020 2020 2020  2] of int.      
-00005d40: 2020 5468 6520 6e75 6d62 6572 206f 6620    The number of 
-00005d50: 6469 7669 7369 6f6e 7320 7769 7468 2077  divisions with w
-00005d60: 6869 6368 2074 6865 2067 656f 6d65 7472  hich the geometr
-00005d70: 7920 6973 2064 6976 6964 6564 2069 6e74  y is divided int
-00005d80: 6f0a 2020 2020 2020 2020 6d75 6c74 6970  o.        multip
-00005d90: 6c65 2072 6563 7461 6e67 756c 6172 2072  le rectangular r
-00005da0: 6567 696f 6e73 2e20 5468 6973 2061 6c6c  egions. This all
-00005db0: 6f77 7320 666f 7220 6561 6368 2072 6567  ows for each reg
-00005dc0: 696f 6e20 746f 2062 650a 2020 2020 2020  ion to be.      
-00005dd0: 2020 7072 6f63 6573 7365 6420 7365 7175    processed sequ
-00005de0: 656e 7469 616c 6c79 2c20 7768 6963 6820  entially, which 
-00005df0: 6973 206d 6f72 6520 636f 6d70 7574 6174  is more computat
-00005e00: 696f 6e61 6c6c 7920 6566 6669 6369 656e  ionally efficien
-00005e10: 742e 0a20 2020 206d 6178 5f70 6f69 6e74  t..    max_point
-00005e20: 7320 3a20 696e 740a 2020 2020 2020 2020  s : int.        
-00005e30: 5468 6520 6d61 7869 6d75 6d20 6e75 6d62  The maximum numb
-00005e40: 6572 206f 6620 7665 7274 6963 6573 2077  er of vertices w
-00005e50: 6974 6869 6e20 7468 6520 7265 7375 6c74  ithin the result
-00005e60: 696e 6720 706f 6c79 676f 6e2e 0a20 2020  ing polygon..   
-00005e70: 206c 6179 6572 203a 2069 6e74 2c20 6172   layer : int, ar
-00005e80: 7261 792d 6c69 6b65 5b32 5d2c 206f 7220  ray-like[2], or 
-00005e90: 7365 740a 2020 2020 2020 2020 5370 6563  set.        Spec
-00005ea0: 6966 6963 206c 6179 6572 2873 2920 746f  ific layer(s) to
-00005eb0: 2070 7574 2070 6f6c 7967 6f6e 2067 656f   put polygon geo
-00005ec0: 6d65 7472 7920 6f6e 2e0a 0a20 2020 2052  metry on...    R
-00005ed0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-00005ee0: 2d2d 0a20 2020 2044 203a 2044 6576 6963  --.    D : Devic
-00005ef0: 650a 2020 2020 2020 2020 4120 4465 7669  e.        A Devi
-00005f00: 6365 2063 6f6e 7461 696e 696e 6720 7468  ce containing th
-00005f10: 6520 696e 7665 7274 6564 2076 6572 7369  e inverted versi
-00005f20: 6f6e 206f 6620 7468 6520 696e 7075 7420  on of the input 
-00005f30: 7368 6170 6528 7329 2061 6e64 2074 6865  shape(s) and the
-00005f40: 0a20 2020 2020 2020 2063 6f72 7265 7370  .        corresp
-00005f50: 6f6e 6469 6e67 2062 6f72 6465 7228 7329  onding border(s)
-00005f60: 2e0a 2020 2020 2222 220a 2020 2020 5465  ..    """.    Te
-00005f70: 6d70 203d 2044 6576 6963 6528 290a 2020  mp = Device().  
-00005f80: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
-00005f90: 6e63 6528 656c 656d 656e 7473 2c20 6c69  nce(elements, li
-00005fa0: 7374 293a 0a20 2020 2020 2020 2065 6c65  st):.        ele
-00005fb0: 6d65 6e74 7320 3d20 5b65 6c65 6d65 6e74  ments = [element
-00005fc0: 735d 0a20 2020 2066 6f72 2065 2069 6e20  s].    for e in 
-00005fd0: 656c 656d 656e 7473 3a0a 2020 2020 2020  elements:.      
-00005fe0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00005ff0: 652c 2044 6576 6963 6529 3a0a 2020 2020  e, Device):.    
-00006000: 2020 2020 2020 2020 5465 6d70 2e61 6464          Temp.add
-00006010: 5f72 6566 2865 290a 2020 2020 2020 2020  _ref(e).        
-00006020: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00006030: 2020 5465 6d70 2e61 6464 2865 290a 2020    Temp.add(e).  
-00006040: 2020 6764 735f 6c61 7965 722c 2067 6473    gds_layer, gds
-00006050: 5f64 6174 6174 7970 6520 3d20 5f70 6172  _datatype = _par
-00006060: 7365 5f6c 6179 6572 286c 6179 6572 290a  se_layer(layer).
-00006070: 0a20 2020 2023 2042 7569 6c64 2074 6865  .    # Build the
-00006080: 2072 6563 7461 6e67 6c65 2061 726f 756e   rectangle aroun
-00006090: 6420 7468 6520 6465 7669 6365 2044 0a20  d the device D. 
-000060a0: 2020 2052 203d 2072 6563 7461 6e67 6c65     R = rectangle
-000060b0: 2873 697a 653d 2854 656d 702e 7873 697a  (size=(Temp.xsiz
-000060c0: 6520 2b20 3220 2a20 626f 7264 6572 2c20  e + 2 * border, 
-000060d0: 5465 6d70 2e79 7369 7a65 202b 2032 202a  Temp.ysize + 2 *
-000060e0: 2062 6f72 6465 7229 290a 2020 2020 522e   border)).    R.
-000060f0: 6365 6e74 6572 203d 2054 656d 702e 6365  center = Temp.ce
-00006100: 6e74 6572 0a0a 2020 2020 4420 3d20 626f  nter..    D = bo
-00006110: 6f6c 6561 6e28 0a20 2020 2020 2020 2041  olean(.        A
-00006120: 3d52 2c0a 2020 2020 2020 2020 423d 5465  =R,.        B=Te
-00006130: 6d70 2c0a 2020 2020 2020 2020 6f70 6572  mp,.        oper
-00006140: 6174 696f 6e3d 2241 2d42 222c 0a20 2020  ation="A-B",.   
-00006150: 2020 2020 2070 7265 6369 7369 6f6e 3d70       precision=p
-00006160: 7265 6369 7369 6f6e 2c0a 2020 2020 2020  recision,.      
-00006170: 2020 6e75 6d5f 6469 7669 7369 6f6e 733d    num_divisions=
-00006180: 6e75 6d5f 6469 7669 7369 6f6e 732c 0a20  num_divisions,. 
-00006190: 2020 2020 2020 206d 6178 5f70 6f69 6e74         max_point
-000061a0: 733d 6d61 785f 706f 696e 7473 2c0a 2020  s=max_points,.  
-000061b0: 2020 2020 2020 6c61 7965 723d 6c61 7965        layer=laye
-000061c0: 722c 0a20 2020 2029 0a20 2020 2072 6574  r,.    ).    ret
-000061d0: 7572 6e20 440a 0a0a 6465 6620 786f 725f  urn D...def xor_
-000061e0: 6469 6666 2841 2c20 422c 2070 7265 6369  diff(A, B, preci
-000061f0: 7369 6f6e 3d31 652d 3429 3a0a 2020 2020  sion=1e-4):.    
-00006200: 2222 2247 6976 656e 2074 776f 2044 6576  """Given two Dev
-00006210: 6963 6573 2041 2061 6e64 2042 2c20 7065  ices A and B, pe
-00006220: 7266 6f72 6d73 2074 6865 206c 6179 6572  rforms the layer
-00006230: 2d62 792d 6c61 7965 7220 584f 520a 2020  -by-layer XOR.  
-00006240: 2020 6469 6666 6572 656e 6365 2062 6574    difference bet
-00006250: 7765 656e 2041 2061 6e64 2042 2061 6e64  ween A and B and
-00006260: 2072 6574 7572 6e73 2070 6f6c 7967 6f6e   returns polygon
-00006270: 7320 7265 7072 6573 656e 7469 6e67 2074  s representing t
-00006280: 6865 0a20 2020 2064 6966 6665 7265 6e63  he.    differenc
-00006290: 6573 2062 6574 7765 656e 2041 2061 6e64  es between A and
-000062a0: 2042 2e0a 0a20 2020 2050 6172 616d 6574   B...    Paramet
-000062b0: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-000062c0: 2d2d 0a20 2020 2041 203a 2044 6576 6963  --.    A : Devic
-000062d0: 6528 2f52 6566 6572 656e 6365 2920 6f72  e(/Reference) or
-000062e0: 206c 6973 7420 6f66 2044 6576 6963 6528   list of Device(
-000062f0: 2f52 6566 6572 656e 6365 290a 2020 2020  /Reference).    
-00006300: 2020 2020 4120 4465 7669 6365 2063 6f6e      A Device con
-00006310: 7461 696e 696e 6720 6120 706f 6c79 676f  taining a polygo
-00006320: 6e28 7329 2e0a 2020 2020 4220 3a20 4465  n(s)..    B : De
-00006330: 7669 6365 282f 5265 6665 7265 6e63 6529  vice(/Reference)
-00006340: 206f 7220 6c69 7374 206f 6620 4465 7669   or list of Devi
-00006350: 6365 282f 5265 6665 7265 6e63 6529 0a20  ce(/Reference). 
-00006360: 2020 2020 2020 2041 2044 6576 6963 6520         A Device 
-00006370: 636f 6e74 6169 6e69 6e67 2061 2070 6f6c  containing a pol
-00006380: 7967 6f6e 2873 292e 0a20 2020 2070 7265  ygon(s)..    pre
-00006390: 6369 7369 6f6e 203a 2066 6c6f 6174 0a20  cision : float. 
-000063a0: 2020 2020 2020 2044 6573 6972 6564 2070         Desired p
-000063b0: 7265 6369 7369 6f6e 2066 6f72 2072 6f75  recision for rou
-000063c0: 6e64 696e 6720 7665 7274 6578 2063 6f6f  nding vertex coo
-000063d0: 7264 696e 6174 6573 2e0a 0a20 2020 2052  rdinates...    R
-000063e0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-000063f0: 2d0a 2020 2020 443a 2044 6576 6963 650a  -.    D: Device.
-00006400: 2020 2020 2020 2020 4120 4465 7669 6365          A Device
-00006410: 2063 6f6e 7461 696e 696e 6720 6120 706f   containing a po
-00006420: 6c79 676f 6e28 7329 2064 6566 696e 6564  lygon(s) defined
-00006430: 2062 7920 7468 6520 584f 5220 6469 6666   by the XOR diff
-00006440: 6572 656e 6365 2072 6573 756c 740a 2020  erence result.  
-00006450: 2020 2020 2020 6265 7477 6565 6e20 4120        between A 
-00006460: 616e 6420 422e 0a20 2020 2022 2222 0a0a  and B..    """..
-00006470: 2020 2020 4420 3d20 4465 7669 6365 2822      D = Device("
-00006480: 786f 725f 6469 6666 2229 0a20 2020 2041  xor_diff").    A
-00006490: 5f70 6f6c 7973 203d 2041 2e67 6574 5f70  _polys = A.get_p
-000064a0: 6f6c 7967 6f6e 7328 6279 5f73 7065 633d  olygons(by_spec=
-000064b0: 5472 7565 290a 2020 2020 425f 706f 6c79  True).    B_poly
-000064c0: 7320 3d20 422e 6765 745f 706f 6c79 676f  s = B.get_polygo
-000064d0: 6e73 2862 795f 7370 6563 3d54 7275 6529  ns(by_spec=True)
-000064e0: 0a20 2020 2041 5f6c 6179 6572 7320 3d20  .    A_layers = 
-000064f0: 415f 706f 6c79 732e 6b65 7973 2829 0a20  A_polys.keys(). 
-00006500: 2020 2042 5f6c 6179 6572 7320 3d20 425f     B_layers = B_
-00006510: 706f 6c79 732e 6b65 7973 2829 0a20 2020  polys.keys().   
-00006520: 2061 6c6c 5f6c 6179 6572 7320 3d20 7365   all_layers = se
-00006530: 7428 290a 2020 2020 616c 6c5f 6c61 7965  t().    all_laye
-00006540: 7273 2e75 7064 6174 6528 415f 6c61 7965  rs.update(A_laye
-00006550: 7273 290a 2020 2020 616c 6c5f 6c61 7965  rs).    all_laye
-00006560: 7273 2e75 7064 6174 6528 425f 6c61 7965  rs.update(B_laye
-00006570: 7273 290a 2020 2020 666f 7220 6c61 7965  rs).    for laye
-00006580: 7220 696e 2061 6c6c 5f6c 6179 6572 733a  r in all_layers:
-00006590: 0a20 2020 2020 2020 2069 6620 286c 6179  .        if (lay
-000065a0: 6572 2069 6e20 415f 6c61 7965 7273 2920  er in A_layers) 
-000065b0: 616e 6420 286c 6179 6572 2069 6e20 425f  and (layer in B_
-000065c0: 6c61 7965 7273 293a 0a20 2020 2020 2020  layers):.       
-000065d0: 2020 2020 2070 203d 2067 6473 7079 2e62       p = gdspy.b
-000065e0: 6f6f 6c65 616e 280a 2020 2020 2020 2020  oolean(.        
-000065f0: 2020 2020 2020 2020 6f70 6572 616e 6431          operand1
-00006600: 3d41 5f70 6f6c 7973 5b6c 6179 6572 5d2c  =A_polys[layer],
-00006610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006620: 206f 7065 7261 6e64 323d 425f 706f 6c79   operand2=B_poly
-00006630: 735b 6c61 7965 725d 2c0a 2020 2020 2020  s[layer],.      
-00006640: 2020 2020 2020 2020 2020 6f70 6572 6174            operat
-00006650: 696f 6e3d 2278 6f72 222c 0a20 2020 2020  ion="xor",.     
-00006660: 2020 2020 2020 2020 2020 2070 7265 6369             preci
-00006670: 7369 6f6e 3d70 7265 6369 7369 6f6e 2c0a  sion=precision,.
-00006680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006690: 6d61 785f 706f 696e 7473 3d34 3030 302c  max_points=4000,
-000066a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000066b0: 206c 6179 6572 3d6c 6179 6572 5b30 5d2c   layer=layer[0],
-000066c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000066d0: 2064 6174 6174 7970 653d 6c61 7965 725b   datatype=layer[
-000066e0: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
-000066f0: 290a 2020 2020 2020 2020 656c 6966 206c  ).        elif l
-00006700: 6179 6572 2069 6e20 415f 6c61 7965 7273  ayer in A_layers
-00006710: 3a0a 2020 2020 2020 2020 2020 2020 7020  :.            p 
-00006720: 3d20 415f 706f 6c79 735b 6c61 7965 725d  = A_polys[layer]
-00006730: 0a20 2020 2020 2020 2065 6c69 6620 6c61  .        elif la
-00006740: 7965 7220 696e 2042 5f6c 6179 6572 733a  yer in B_layers:
-00006750: 0a20 2020 2020 2020 2020 2020 2070 203d  .            p =
-00006760: 2042 5f70 6f6c 7973 5b6c 6179 6572 5d0a   B_polys[layer].
-00006770: 2020 2020 2020 2020 6966 2070 2069 7320          if p is 
-00006780: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00006790: 2020 2020 2020 442e 6164 645f 706f 6c79        D.add_poly
-000067a0: 676f 6e28 702c 206c 6179 6572 3d6c 6179  gon(p, layer=lay
-000067b0: 6572 290a 2020 2020 7265 7475 726e 2044  er).    return D
-000067c0: 0a0a 0a64 6566 2075 6e69 6f6e 2844 2c20  ...def union(D, 
-000067d0: 6279 5f6c 6179 6572 3d46 616c 7365 2c20  by_layer=False, 
-000067e0: 7072 6563 6973 696f 6e3d 3165 2d34 2c20  precision=1e-4, 
-000067f0: 6a6f 696e 5f66 6972 7374 3d54 7275 652c  join_first=True,
-00006800: 206d 6178 5f70 6f69 6e74 733d 3430 3030   max_points=4000
-00006810: 2c20 6c61 7965 723d 3029 3a0a 2020 2020  , layer=0):.    
-00006820: 2222 2250 6572 666f 726d 7320 7468 6520  """Performs the 
-00006830: 756e 696f 6e20 6f66 2061 6c6c 2070 6f6c  union of all pol
-00006840: 7967 6f6e 7320 7769 7468 696e 2061 2044  ygons within a D
-00006850: 6576 6963 652e 0a0a 2020 2020 5061 7261  evice...    Para
-00006860: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-00006870: 2d2d 2d2d 2d0a 2020 2020 4420 3a20 4465  -----.    D : De
-00006880: 7669 6365 282f 5265 6665 7265 6e63 6529  vice(/Reference)
-00006890: 0a20 2020 2020 2020 2041 2044 6576 6963  .        A Devic
-000068a0: 6520 636f 6e74 6169 6e69 6e67 2070 6f6c  e containing pol
-000068b0: 7967 6f6e 7320 746f 2070 6572 666f 726d  ygons to perform
-000068c0: 2061 2075 6e69 6f6e 206f 6e2e 0a20 2020   a union on..   
-000068d0: 2062 795f 4c61 7965 7220 3a20 626f 6f6c   by_Layer : bool
-000068e0: 0a20 2020 2020 2020 2049 6620 7472 7565  .        If true
-000068f0: 2c20 7065 7266 6f72 6d73 2074 6865 2075  , performs the u
-00006900: 6e69 6f6e 206f 7065 7261 7469 6f6e 206c  nion operation l
-00006910: 6179 6572 2d77 6973 6520 736f 2065 6163  ayer-wise so eac
-00006920: 6820 6c61 7965 7220 6361 6e20 6265 0a20  h layer can be. 
-00006930: 2020 2020 2020 2069 6e64 6976 6964 7561         individua
-00006940: 6c6c 7920 636f 6d62 696e 6564 2e0a 2020  lly combined..  
-00006950: 2020 7072 6563 6973 696f 6e20 3a20 666c    precision : fl
-00006960: 6f61 740a 2020 2020 2020 2020 4465 7369  oat.        Desi
-00006970: 7265 6420 7072 6563 6973 696f 6e20 666f  red precision fo
-00006980: 7220 726f 756e 6469 6e67 2076 6572 7465  r rounding verte
-00006990: 7820 636f 6f72 6469 6e61 7465 732e 0a20  x coordinates.. 
-000069a0: 2020 206a 6f69 6e5f 6669 7273 7420 3a20     join_first : 
-000069b0: 626f 6f6c 0a20 2020 2020 2020 204a 6f69  bool.        Joi
-000069c0: 6e20 616c 6c20 7061 7468 7320 6265 666f  n all paths befo
-000069d0: 7265 206f 6666 7365 7474 696e 6720 746f  re offsetting to
-000069e0: 2061 766f 6964 2075 6e6e 6563 6573 7361   avoid unnecessa
-000069f0: 7279 206a 6f69 6e73 2069 6e0a 2020 2020  ry joins in.    
-00006a00: 2020 2020 6164 6a61 6365 6e74 2070 6f6c      adjacent pol
-00006a10: 7967 6f6e 2073 6964 6573 2e0a 2020 2020  ygon sides..    
-00006a20: 6d61 785f 706f 696e 7473 203a 2069 6e74  max_points : int
-00006a30: 0a20 2020 2020 2020 2054 6865 206d 6178  .        The max
-00006a40: 696d 756d 206e 756d 6265 7220 6f66 2076  imum number of v
-00006a50: 6572 7469 6365 7320 7769 7468 696e 2074  ertices within t
-00006a60: 6865 2072 6573 756c 7469 6e67 2070 6f6c  he resulting pol
-00006a70: 7967 6f6e 2e0a 2020 2020 6c61 7965 7220  ygon..    layer 
-00006a80: 3a20 696e 742c 2061 7272 6179 2d6c 696b  : int, array-lik
-00006a90: 655b 325d 2c20 6f72 2073 6574 0a20 2020  e[2], or set.   
-00006aa0: 2020 2020 2053 7065 6369 6669 6320 6c61       Specific la
-00006ab0: 7965 7228 7329 2074 6f20 7075 7420 706f  yer(s) to put po
-00006ac0: 6c79 676f 6e20 6765 6f6d 6574 7279 206f  lygon geometry o
-00006ad0: 6e2e 0a0a 2020 2020 5265 7475 726e 730a  n...    Returns.
-00006ae0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-00006af0: 5520 3a20 4465 7669 6365 0a20 2020 2020  U : Device.     
-00006b00: 2020 2041 2044 6576 6963 6520 636f 6e74     A Device cont
-00006b10: 6169 6e69 6e67 2074 6865 2075 6e69 6f6e  aining the union
-00006b20: 206f 6620 7468 6520 706f 6c79 676f 6e73   of the polygons
-00006b30: 2077 6974 6869 6e20 7468 6520 696e 7075   within the inpu
-00006b40: 7420 4465 7669 6365 2e0a 2020 2020 2222  t Device..    ""
-00006b50: 220a 2020 2020 5520 3d20 4465 7669 6365  ".    U = Device
-00006b60: 2822 756e 696f 6e22 290a 0a20 2020 2069  ("union")..    i
-00006b70: 6620 6279 5f6c 6179 6572 3a0a 2020 2020  f by_layer:.    
-00006b80: 2020 2020 616c 6c5f 706f 6c79 676f 6e73      all_polygons
-00006b90: 203d 2044 2e67 6574 5f70 6f6c 7967 6f6e   = D.get_polygon
-00006ba0: 7328 6279 5f73 7065 633d 5472 7565 290a  s(by_spec=True).
-00006bb0: 2020 2020 2020 2020 666f 7220 6c61 7965          for laye
-00006bc0: 722c 2070 6f6c 7967 6f6e 7320 696e 2061  r, polygons in a
-00006bd0: 6c6c 5f70 6f6c 7967 6f6e 732e 6974 656d  ll_polygons.item
-00006be0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00006bf0: 2075 6e69 6f6e 6564 5f70 6f6c 7967 6f6e   unioned_polygon
-00006c00: 7320 3d20 5f75 6e69 6f6e 5f70 6f6c 7967  s = _union_polyg
-00006c10: 6f6e 7328 0a20 2020 2020 2020 2020 2020  ons(.           
-00006c20: 2020 2020 2070 6f6c 7967 6f6e 732c 2070       polygons, p
-00006c30: 7265 6369 7369 6f6e 3d70 7265 6369 7369  recision=precisi
-00006c40: 6f6e 2c20 6d61 785f 706f 696e 7473 3d6d  on, max_points=m
-00006c50: 6178 5f70 6f69 6e74 730a 2020 2020 2020  ax_points.      
-00006c60: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00006c70: 2020 2020 552e 6164 645f 706f 6c79 676f      U.add_polygo
-00006c80: 6e28 756e 696f 6e65 645f 706f 6c79 676f  n(unioned_polygo
-00006c90: 6e73 2c20 6c61 7965 723d 6c61 7965 7229  ns, layer=layer)
-00006ca0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00006cb0: 2020 2061 6c6c 5f70 6f6c 7967 6f6e 7320     all_polygons 
-00006cc0: 3d20 442e 6765 745f 706f 6c79 676f 6e73  = D.get_polygons
-00006cd0: 2862 795f 7370 6563 3d46 616c 7365 290a  (by_spec=False).
-00006ce0: 2020 2020 2020 2020 756e 696f 6e65 645f          unioned_
-00006cf0: 706f 6c79 676f 6e73 203d 205f 756e 696f  polygons = _unio
-00006d00: 6e5f 706f 6c79 676f 6e73 280a 2020 2020  n_polygons(.    
-00006d10: 2020 2020 2020 2020 616c 6c5f 706f 6c79          all_poly
-00006d20: 676f 6e73 2c20 7072 6563 6973 696f 6e3d  gons, precision=
-00006d30: 7072 6563 6973 696f 6e2c 206d 6178 5f70  precision, max_p
-00006d40: 6f69 6e74 733d 6d61 785f 706f 696e 7473  oints=max_points
-00006d50: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00006d60: 2020 2055 2e61 6464 5f70 6f6c 7967 6f6e     U.add_polygon
-00006d70: 2875 6e69 6f6e 6564 5f70 6f6c 7967 6f6e  (unioned_polygon
-00006d80: 732c 206c 6179 6572 3d6c 6179 6572 290a  s, layer=layer).
-00006d90: 2020 2020 7265 7475 726e 2055 0a0a 0a64      return U...d
-00006da0: 6566 205f 756e 696f 6e5f 706f 6c79 676f  ef _union_polygo
-00006db0: 6e73 2870 6f6c 7967 6f6e 732c 2070 7265  ns(polygons, pre
-00006dc0: 6369 7369 6f6e 3d31 652d 342c 206d 6178  cision=1e-4, max
-00006dd0: 5f70 6f69 6e74 733d 3430 3030 293a 0a20  _points=4000):. 
-00006de0: 2020 2022 2222 5065 7266 6f72 6d73 2074     """Performs t
-00006df0: 6865 2075 6e69 6f6e 206f 6620 616c 6c20  he union of all 
-00006e00: 706f 6c79 676f 6e73 2077 6974 6869 6e20  polygons within 
-00006e10: 6120 506f 6c79 676f 6e53 6574 206f 7220  a PolygonSet or 
-00006e20: 6c69 7374 206f 660a 2020 2020 706f 6c79  list of.    poly
-00006e30: 676f 6e73 2e0a 0a20 2020 2050 6172 616d  gons...    Param
-00006e40: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
-00006e50: 2d2d 2d2d 0a20 2020 2070 6f6c 7967 6f6e  ----.    polygon
-00006e60: 7320 3a20 506f 6c79 676f 6e53 6574 206f  s : PolygonSet o
-00006e70: 7220 6c69 7374 206f 6620 706f 6c79 676f  r list of polygo
-00006e80: 6e73 0a20 2020 2020 2020 2041 2073 6574  ns.        A set
-00006e90: 2063 6f6e 7461 696e 696e 6720 7468 6520   containing the 
-00006ea0: 696e 7075 7420 706f 6c79 676f 6e73 2e0a  input polygons..
-00006eb0: 2020 2020 7072 6563 6973 696f 6e20 3a20      precision : 
-00006ec0: 666c 6f61 740a 2020 2020 2020 2020 4465  float.        De
-00006ed0: 7369 7265 6420 7072 6563 6973 696f 6e20  sired precision 
-00006ee0: 666f 7220 726f 756e 6469 6e67 2076 6572  for rounding ver
-00006ef0: 7465 7820 636f 6f72 6469 6e61 7465 732e  tex coordinates.
-00006f00: 0a20 2020 206d 6178 5f70 6f69 6e74 7320  .    max_points 
-00006f10: 3a20 696e 740a 2020 2020 2020 2020 5468  : int.        Th
-00006f20: 6520 6d61 7869 6d75 6d20 6e75 6d62 6572  e maximum number
-00006f30: 206f 6620 7665 7274 6963 6573 2077 6974   of vertices wit
-00006f40: 6869 6e20 7468 6520 7265 7375 6c74 696e  hin the resultin
-00006f50: 6720 706f 6c79 676f 6e2e 0a0a 2020 2020  g polygon...    
-00006f60: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
-00006f70: 2d2d 2d0a 2020 2020 756e 696f 6e65 6420  ---.    unioned 
-00006f80: 3a20 706f 6c79 676f 6e0a 2020 2020 2020  : polygon.      
-00006f90: 2020 5468 6520 7265 7375 6c74 206f 6620    The result of 
-00006fa0: 7468 6520 756e 696f 6e20 6f66 2061 6c6c  the union of all
-00006fb0: 2074 6865 2070 6f6c 7967 6f6e 7320 7769   the polygons wi
-00006fc0: 7468 696e 2074 6865 2069 6e70 7574 0a20  thin the input. 
-00006fd0: 2020 2020 2020 2050 6f6c 7967 6f6e 5365         PolygonSe
-00006fe0: 742e 0a20 2020 2022 2222 0a20 2020 2070  t..    """.    p
-00006ff0: 6f6c 7967 6f6e 7320 3d20 5f6d 6572 6765  olygons = _merge
-00007000: 5f66 6c6f 6174 696e 675f 706f 696e 745f  _floating_point_
-00007010: 6572 726f 7273 2870 6f6c 7967 6f6e 732c  errors(polygons,
-00007020: 2074 6f6c 3d70 7265 6369 7369 6f6e 202f   tol=precision /
-00007030: 2031 3030 3029 0a20 2020 2075 6e69 6f6e   1000).    union
-00007040: 6564 203d 2067 6473 7079 2e62 6f6f 6c65  ed = gdspy.boole
-00007050: 616e 280a 2020 2020 2020 2020 706f 6c79  an(.        poly
-00007060: 676f 6e73 2c20 5b5d 2c20 6f70 6572 6174  gons, [], operat
-00007070: 696f 6e3d 226f 7222 2c20 7072 6563 6973  ion="or", precis
-00007080: 696f 6e3d 7072 6563 6973 696f 6e2c 206d  ion=precision, m
-00007090: 6178 5f70 6f69 6e74 733d 6d61 785f 706f  ax_points=max_po
-000070a0: 696e 7473 0a20 2020 2029 0a20 2020 2072  ints.    ).    r
-000070b0: 6574 7572 6e20 756e 696f 6e65 640a 0a0a  eturn unioned...
-000070c0: 6465 6620 5f6d 6572 6765 5f66 6c6f 6174  def _merge_float
-000070d0: 696e 675f 706f 696e 745f 6572 726f 7273  ing_point_errors
-000070e0: 2870 6f6c 7967 6f6e 732c 2074 6f6c 3d31  (polygons, tol=1
-000070f0: 652d 3130 293a 0a20 2020 2022 2222 4669  e-10):.    """Fi
-00007100: 7865 7320 666c 6f61 7469 6e67 2070 6f69  xes floating poi
-00007110: 6e74 2065 7272 6f72 7320 696e 2074 6865  nt errors in the
-00007120: 2069 6e70 7574 2070 6f6c 7967 6f6e 2873   input polygon(s
-00007130: 2920 6279 206d 6572 6769 6e67 2076 616c  ) by merging val
-00007140: 7565 730a 2020 2020 7769 7468 696e 2074  ues.    within t
-00007150: 6865 2074 6f6c 6572 616e 6365 2060 746f  he tolerance `to
-00007160: 6c60 2e20 5365 6520 5f6d 6572 6765 5f6e  l`. See _merge_n
-00007170: 6561 7262 795f 666c 6f61 7469 6e67 5f70  earby_floating_p
-00007180: 6f69 6e74 7320 666f 720a 2020 2020 7370  oints for.    sp
-00007190: 6563 6966 6963 732e 0a0a 2020 2020 5061  ecifics...    Pa
-000071a0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-000071b0: 2d2d 2d2d 2d2d 2d0a 2020 2020 706f 6c79  -------.    poly
-000071c0: 676f 6e73 203a 2050 6f6c 7967 6f6e 5365  gons : PolygonSe
-000071d0: 7420 6f72 206c 6973 7420 6f66 2070 6f6c  t or list of pol
-000071e0: 7967 6f6e 730a 2020 2020 2020 2020 5365  ygons.        Se
-000071f0: 7420 6f66 2070 6f6c 7967 6f6e 7320 7769  t of polygons wi
-00007200: 7468 2066 6c6f 6174 696e 6720 706f 696e  th floating poin
-00007210: 7420 6572 726f 7273 2e0a 2020 2020 746f  t errors..    to
-00007220: 6c20 3a20 666c 6f61 740a 2020 2020 2020  l : float.      
-00007230: 2020 546f 6c65 7261 6e63 6520 7769 7468    Tolerance with
-00007240: 696e 2077 6869 6368 2070 6f69 6e74 7320  in which points 
-00007250: 7769 6c6c 2062 6520 6d65 7267 6564 2e0a  will be merged..
-00007260: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
-00007270: 202d 2d2d 2d2d 2d2d 0a20 2020 2070 6f6c   -------.    pol
-00007280: 7967 6f6e 735f 6669 7865 6420 3a20 506f  ygons_fixed : Po
-00007290: 6c79 676f 6e53 6574 0a20 2020 2020 2020  lygonSet.       
-000072a0: 2053 6574 206f 6620 636f 7272 6563 7465   Set of correcte
-000072b0: 6420 706f 6c79 676f 6e73 2e0a 2020 2020  d polygons..    
-000072c0: 2222 220a 2020 2020 6966 206c 656e 2870  """.    if len(p
-000072d0: 6f6c 7967 6f6e 7329 203d 3d20 303a 0a20  olygons) == 0:. 
-000072e0: 2020 2020 2020 2072 6574 7572 6e20 6e70         return np
-000072f0: 2e61 7366 6172 7261 7928 5b5d 290a 2020  .asfarray([]).  
-00007300: 2020 7374 6163 6b65 645f 706f 6c79 676f    stacked_polygo
-00007310: 6e73 203d 206e 702e 7673 7461 636b 2870  ns = np.vstack(p
-00007320: 6f6c 7967 6f6e 7329 0a20 2020 2078 203d  olygons).    x =
-00007330: 2073 7461 636b 6564 5f70 6f6c 7967 6f6e   stacked_polygon
-00007340: 735b 3a2c 2030 5d0a 2020 2020 7920 3d20  s[:, 0].    y = 
-00007350: 7374 6163 6b65 645f 706f 6c79 676f 6e73  stacked_polygons
-00007360: 5b3a 2c20 315d 0a20 2020 2070 6f6c 7967  [:, 1].    polyg
-00007370: 6f6e 5f69 6e64 6963 6573 203d 206e 702e  on_indices = np.
-00007380: 6375 6d73 756d 285b 6c65 6e28 7029 2066  cumsum([len(p) f
-00007390: 6f72 2070 2069 6e20 706f 6c79 676f 6e73  or p in polygons
-000073a0: 5d29 0a0a 2020 2020 7866 6978 6564 203d  ])..    xfixed =
-000073b0: 205f 6d65 7267 655f 6e65 6172 6279 5f66   _merge_nearby_f
-000073c0: 6c6f 6174 696e 675f 706f 696e 7473 2878  loating_points(x
-000073d0: 2c20 746f 6c3d 746f 6c29 0a20 2020 2079  , tol=tol).    y
-000073e0: 6669 7865 6420 3d20 5f6d 6572 6765 5f6e  fixed = _merge_n
-000073f0: 6561 7262 795f 666c 6f61 7469 6e67 5f70  earby_floating_p
-00007400: 6f69 6e74 7328 792c 2074 6f6c 3d74 6f6c  oints(y, tol=tol
-00007410: 290a 2020 2020 7374 6163 6b65 645f 706f  ).    stacked_po
-00007420: 6c79 676f 6e73 5f66 6978 6564 203d 206e  lygons_fixed = n
-00007430: 702e 7673 7461 636b 285b 7866 6978 6564  p.vstack([xfixed
-00007440: 2c20 7966 6978 6564 5d29 2e54 0a20 2020  , yfixed]).T.   
-00007450: 2070 6f6c 7967 6f6e 735f 6669 7865 6420   polygons_fixed 
-00007460: 3d20 6e70 2e76 7370 6c69 7428 7374 6163  = np.vsplit(stac
-00007470: 6b65 645f 706f 6c79 676f 6e73 5f66 6978  ked_polygons_fix
-00007480: 6564 2c20 706f 6c79 676f 6e5f 696e 6469  ed, polygon_indi
-00007490: 6365 735b 3a2d 315d 290a 2020 2020 7265  ces[:-1]).    re
-000074a0: 7475 726e 2070 6f6c 7967 6f6e 735f 6669  turn polygons_fi
-000074b0: 7865 640a 0a0a 6465 6620 5f6d 6572 6765  xed...def _merge
-000074c0: 5f6e 6561 7262 795f 666c 6f61 7469 6e67  _nearby_floating
-000074d0: 5f70 6f69 6e74 7328 782c 2074 6f6c 3d31  _points(x, tol=1
-000074e0: 652d 3130 293a 0a20 2020 2022 2222 5461  e-10):.    """Ta
-000074f0: 6b65 7320 616e 2061 7272 6179 2060 7860  kes an array `x`
-00007500: 2061 6e64 206d 6572 6765 7320 616e 7920   and merges any 
-00007510: 7661 6c75 6573 2077 6974 6869 6e20 7468  values within th
-00007520: 6520 746f 6c65 7261 6e63 6520 6074 6f6c  e tolerance `tol
-00007530: 602e 0a0a 2020 2020 5061 7261 6d65 7465  `...    Paramete
-00007540: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-00007550: 2d0a 2020 2020 7820 3a20 6c69 7374 206f  -.    x : list o
-00007560: 6620 696e 7420 6f72 2066 6c6f 6174 0a20  f int or float. 
-00007570: 2020 2020 2020 2041 7272 6179 206f 6620         Array of 
-00007580: 7661 6c75 6573 2077 6974 6820 666c 6f61  values with floa
-00007590: 7469 6e67 2070 6f69 6e74 2065 7272 6f72  ting point error
-000075a0: 732e 0a20 2020 2074 6f6c 203a 2066 6c6f  s..    tol : flo
-000075b0: 6174 0a20 2020 2020 2020 2054 6f6c 6572  at.        Toler
-000075c0: 616e 6365 2077 6974 6869 6e20 7768 6963  ance within whic
-000075d0: 6820 706f 696e 7473 2077 696c 6c20 6265  h points will be
-000075e0: 206d 6572 6765 642e 0a0a 2020 2020 5265   merged...    Re
-000075f0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00007600: 2d0a 2020 2020 7873 6f72 7420 3a20 6c69  -.    xsort : li
-00007610: 7374 206f 6620 696e 7420 6f72 2066 6c6f  st of int or flo
-00007620: 6174 0a20 2020 2020 2020 2043 6f72 7265  at.        Corre
-00007630: 6374 6564 2061 6e64 2073 6f72 7465 6420  cted and sorted 
-00007640: 6172 7261 792e 0a0a 2020 2020 4578 616d  array...    Exam
-00007650: 706c 6573 0a20 2020 202d 2d2d 2d2d 2d2d  ples.    -------
-00007660: 2d0a 2020 2020 4966 2067 6976 656e 3a0a  -.    If given:.
-00007670: 2020 2020 3e3e 3e20 7820 3d20 5b2d 322c      >>> x = [-2,
-00007680: 202d 312c 2030 2c20 312e 3030 3031 2c20   -1, 0, 1.0001, 
-00007690: 312e 3030 3032 2c20 312e 3030 3033 2c20  1.0002, 1.0003, 
-000076a0: 342c 2035 2c20 352e 3030 332c 2036 2c20  4, 5, 5.003, 6, 
-000076b0: 372c 2038 5d0a 2020 2020 3e3e 3e20 5f6d  7, 8].    >>> _m
-000076c0: 6572 6765 5f6e 6561 7262 795f 666c 6f61  erge_nearby_floa
-000076d0: 7469 6e67 5f70 6f69 6e74 7328 782c 2074  ting_points(x, t
-000076e0: 6f6c 203d 2031 652d 3329 0a20 2020 2057  ol = 1e-3).    W
-000076f0: 696c 6c20 7265 7475 726e 3a0a 2020 2020  ill return:.    
-00007700: 3e3e 3e20 5b2d 322c 202d 312c 2030 2c20  >>> [-2, -1, 0, 
-00007710: 312e 3030 3031 2c20 312e 3030 3031 2c20  1.0001, 1.0001, 
-00007720: 312e 3030 3031 2c20 342c 2035 2c20 352e  1.0001, 4, 5, 5.
-00007730: 3030 332c 2036 2c20 372c 2038 5d2e 0a20  003, 6, 7, 8].. 
-00007740: 2020 2022 2222 0a20 2020 2078 6172 6773     """.    xargs
-00007750: 6f72 7420 3d20 6e70 2e61 7267 736f 7274  ort = np.argsort
-00007760: 2878 290a 2020 2020 7861 7267 756e 736f  (x).    xargunso
-00007770: 7274 203d 206e 702e 6172 6773 6f72 7428  rt = np.argsort(
-00007780: 7861 7267 736f 7274 290a 2020 2020 7873  xargsort).    xs
-00007790: 6f72 7420 3d20 785b 7861 7267 736f 7274  ort = x[xargsort
-000077a0: 5d0a 2020 2020 6478 203d 206e 702e 6469  ].    dx = np.di
-000077b0: 6666 2878 736f 7274 290a 2020 2020 7873  ff(xsort).    xs
-000077c0: 6f72 7474 6872 6573 686f 6c64 203d 206e  ortthreshold = n
-000077d0: 702e 6c6f 6769 6361 6c5f 616e 6428 6478  p.logical_and(dx
-000077e0: 203c 2074 6f6c 2c20 6478 203e 2030 290a   < tol, dx > 0).
-000077f0: 2020 2020 7873 6f72 7474 6872 6573 686f      xsortthresho
-00007800: 6c64 696e 6420 3d20 6e70 2e61 7267 7768  ldind = np.argwh
-00007810: 6572 6528 7873 6f72 7474 6872 6573 686f  ere(xsortthresho
-00007820: 6c64 290a 0a20 2020 2023 204d 6572 6765  ld)..    # Merge
-00007830: 206e 6561 7262 7920 666c 6f61 7469 6e67   nearby floating
-00007840: 2070 6f69 6e74 2076 616c 7565 730a 2020   point values.  
-00007850: 2020 666f 7220 7869 2069 6e20 7873 6f72    for xi in xsor
-00007860: 7474 6872 6573 686f 6c64 696e 643a 0a20  tthresholdind:. 
-00007870: 2020 2020 2020 2078 736f 7274 5b78 6920         xsort[xi 
-00007880: 2b20 315d 203d 2078 736f 7274 5b78 695d  + 1] = xsort[xi]
-00007890: 0a20 2020 2072 6574 7572 6e20 7873 6f72  .    return xsor
-000078a0: 745b 7861 7267 756e 736f 7274 5d0a 0a0a  t[xargunsort]...
-000078b0: 6465 6620 5f63 726f 705f 7265 6769 6f6e  def _crop_region
-000078c0: 2870 6f6c 7967 6f6e 732c 206c 6566 742c  (polygons, left,
-000078d0: 2062 6f74 746f 6d2c 2072 6967 6874 2c20   bottom, right, 
-000078e0: 746f 702c 2070 7265 6369 7369 6f6e 293a  top, precision):
-000078f0: 0a20 2020 2022 2222 4769 7665 6e20 6120  .    """Given a 
-00007900: 7265 6374 616e 6775 6c61 7220 626f 756e  rectangular boun
-00007910: 6461 7279 2064 6566 696e 6564 2062 7920  dary defined by 
-00007920: 6c65 6674 2f62 6f74 746f 6d2f 7269 6768  left/bottom/righ
-00007930: 742f 746f 702c 2074 6869 730a 2020 2020  t/top, this.    
-00007940: 7461 6b65 7320 6120 6c69 7374 206f 6620  takes a list of 
-00007950: 706f 6c79 676f 6e73 2061 6e64 2063 7574  polygons and cut
-00007960: 7320 7468 656d 2061 7420 7468 6520 626f  s them at the bo
-00007970: 756e 6461 7279 2c20 6469 7363 6172 6469  undary, discardi
-00007980: 6e67 2070 6172 7473 0a20 2020 206f 6620  ng parts.    of 
-00007990: 7468 6520 706f 6c79 676f 6e73 206f 7574  the polygons out
-000079a0: 7369 6465 2074 6865 2072 6563 7461 6e67  side the rectang
-000079b0: 6c65 2e0a 0a20 2020 2050 6172 616d 6574  le...    Paramet
-000079c0: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-000079d0: 2d2d 0a20 2020 2070 6f6c 7967 6f6e 7320  --.    polygons 
-000079e0: 3a20 506f 6c79 676f 6e53 6574 206f 7220  : PolygonSet or 
-000079f0: 6c69 7374 206f 6620 706f 6c79 676f 6e73  list of polygons
-00007a00: 0a20 2020 2020 2020 2053 6574 206f 7220  .        Set or 
-00007a10: 6c69 7374 206f 6620 706f 6c79 676f 6e73  list of polygons
-00007a20: 2074 6f20 6265 2063 726f 7070 6564 2e0a   to be cropped..
-00007a30: 2020 2020 6c65 6674 203a 2069 6e74 206f      left : int o
-00007a40: 7220 666c 6f61 740a 2020 2020 2020 2020  r float.        
-00007a50: 5468 6520 782d 636f 6f72 6469 6e61 7465  The x-coordinate
-00007a60: 206f 6620 7468 6520 6c65 6674 6861 6e64   of the lefthand
-00007a70: 2062 6f75 6e64 6172 792e 0a20 2020 2062   boundary..    b
-00007a80: 6f74 746f 6d20 3a20 696e 7420 6f72 2066  ottom : int or f
-00007a90: 6c6f 6174 0a20 2020 2020 2020 2054 6865  loat.        The
-00007aa0: 2079 2d63 6f6f 7264 696e 6174 6520 6f66   y-coordinate of
-00007ab0: 2074 6865 2062 6f74 746f 6d20 626f 756e   the bottom boun
-00007ac0: 6461 7279 2e0a 2020 2020 7269 6768 7420  dary..    right 
-00007ad0: 3a20 696e 7420 6f72 2066 6c6f 6174 0a20  : int or float. 
-00007ae0: 2020 2020 2020 2054 6865 2078 2d63 6f6f         The x-coo
-00007af0: 7264 696e 6174 6520 6f66 2074 6865 2072  rdinate of the r
-00007b00: 6967 6874 6861 6e64 2062 6f75 6e64 6172  ighthand boundar
-00007b10: 792e 0a20 2020 2074 6f70 203a 2069 6e74  y..    top : int
-00007b20: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
-00007b30: 2020 5468 6520 792d 636f 6f72 6469 6e61    The y-coordina
-00007b40: 7465 206f 6620 7468 6520 746f 7020 626f  te of the top bo
-00007b50: 756e 6461 7279 2e0a 2020 2020 7072 6563  undary..    prec
-00007b60: 6973 696f 6e20 3a20 666c 6f61 740a 2020  ision : float.  
-00007b70: 2020 2020 2020 4465 7369 7265 6420 7072        Desired pr
-00007b80: 6563 6973 696f 6e20 666f 7220 726f 756e  ecision for roun
-00007b90: 6469 6e67 2076 6572 7465 7820 636f 6f72  ding vertex coor
-00007ba0: 6469 6e61 7465 732e 0a0a 2020 2020 5265  dinates...    Re
-00007bb0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00007bc0: 2d0a 2020 2020 6372 6f70 7065 645f 706f  -.    cropped_po
-00007bd0: 6c79 676f 6e73 203a 2050 6f6c 7967 6f6e  lygons : Polygon
-00007be0: 5365 7420 6f72 206c 6973 7420 6f66 2070  Set or list of p
-00007bf0: 6f6c 7967 6f6e 730a 2020 2020 2020 2020  olygons.        
-00007c00: 5365 7420 6f72 206c 6973 7420 6f66 2070  Set or list of p
-00007c10: 6f6c 7967 6f6e 7320 7468 6174 2061 7265  olygons that are
-00007c20: 2063 726f 7070 6564 2061 6363 6f72 6469   cropped accordi
-00007c30: 6e67 2074 6f20 7468 6520 7370 6563 6966  ng to the specif
-00007c40: 6965 640a 2020 2020 2020 2020 626f 756e  ied.        boun
-00007c50: 6461 7279 2e0a 2020 2020 2222 220a 2020  dary..    """.  
-00007c60: 2020 6372 6f70 7065 645f 706f 6c79 676f    cropped_polygo
-00007c70: 6e73 203d 205b 5d0a 2020 2020 666f 7220  ns = [].    for 
-00007c80: 7020 696e 2070 6f6c 7967 6f6e 733a 0a20  p in polygons:. 
-00007c90: 2020 2020 2020 2063 6c69 7070 6564 5f70         clipped_p
-00007ca0: 6f6c 7973 203d 2063 6c69 7070 6572 2e5f  olys = clipper._
-00007cb0: 6368 6f70 2870 2c20 5b74 6f70 2c20 626f  chop(p, [top, bo
-00007cc0: 7474 6f6d 5d2c 2031 2c20 3120 2f20 7072  ttom], 1, 1 / pr
-00007cd0: 6563 6973 696f 6e29 0a20 2020 2020 2020  ecision).       
-00007ce0: 2023 2070 6f6c 7967 6f6e 2c20 5b63 7574   # polygon, [cut
-00007cf0: 735d 2c20 6178 6973 2c20 7363 616c 650a  s], axis, scale.
-00007d00: 2020 2020 2020 2020 666f 7220 6370 2069          for cp i
-00007d10: 6e20 636c 6970 7065 645f 706f 6c79 735b  n clipped_polys[
-00007d20: 315d 3a0a 2020 2020 2020 2020 2020 2020  1]:.            
-00007d30: 7265 7375 6c74 203d 2063 6c69 7070 6572  result = clipper
-00007d40: 2e5f 6368 6f70 2863 702c 205b 6c65 6674  ._chop(cp, [left
-00007d50: 2c20 7269 6768 745d 2c20 302c 2031 202f  , right], 0, 1 /
-00007d60: 2070 7265 6369 7369 6f6e 290a 2020 2020   precision).    
-00007d70: 2020 2020 2020 2020 6372 6f70 7065 645f          cropped_
-00007d80: 706f 6c79 676f 6e73 202b 3d20 6c69 7374  polygons += list
-00007d90: 2872 6573 756c 745b 315d 290a 2020 2020  (result[1]).    
-00007da0: 7265 7475 726e 2063 726f 7070 6564 5f70  return cropped_p
-00007db0: 6f6c 7967 6f6e 730a 0a0a 6465 6620 5f63  olygons...def _c
-00007dc0: 726f 705f 6564 6765 5f70 6f6c 7967 6f6e  rop_edge_polygon
-00007dd0: 7328 616c 6c5f 706f 6c79 676f 6e73 2c20  s(all_polygons, 
-00007de0: 6262 6f78 6573 2c20 6c65 6674 2c20 626f  bboxes, left, bo
-00007df0: 7474 6f6d 2c20 7269 6768 742c 2074 6f70  ttom, right, top
-00007e00: 2c20 7072 6563 6973 696f 6e29 3a0a 2020  , precision):.  
-00007e10: 2020 2222 2250 6172 7365 7320 6f75 7420    """Parses out 
-00007e20: 7768 6963 6820 706f 6c79 676f 6e73 2061  which polygons a
-00007e30: 7265 2061 6c6f 6e67 2074 6865 2065 6467  re along the edg
-00007e40: 6520 6f66 2074 6865 2072 6563 7461 6e67  e of the rectang
-00007e50: 6c65 2061 6e64 206e 6565 640a 2020 2020  le and need.    
-00007e60: 746f 2062 6520 6372 6f70 7065 6420 616e  to be cropped an
-00007e70: 6420 7768 6963 6820 6172 6520 6465 6570  d which are deep
-00007e80: 2069 6e73 6964 6520 7468 6520 7265 6374   inside the rect
-00007e90: 616e 676c 6520 7265 6769 6f6e 2061 6e64  angle region and
-00007ea0: 2063 616e 2062 650a 2020 2020 6c65 6674   can be.    left
-00007eb0: 2061 6c6f 6e65 2c20 7468 656e 2063 726f   alone, then cro
-00007ec0: 7073 206f 6e6c 7920 7468 6f73 6520 706f  ps only those po
-00007ed0: 6c79 676f 6e73 2061 6c6f 6e67 2074 6865  lygons along the
-00007ee0: 2065 6467 652e 0a0a 2020 2020 5061 7261   edge...    Para
-00007ef0: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-00007f00: 2d2d 2d2d 2d0a 2020 2020 616c 6c5f 706f  -----.    all_po
-00007f10: 6c79 676f 6e73 203a 2050 6f6c 7967 6f6e  lygons : Polygon
-00007f20: 5365 7420 6f72 206c 6973 7420 6f66 2070  Set or list of p
-00007f30: 6f6c 7967 6f6e 730a 2020 2020 2020 2020  olygons.        
-00007f40: 5365 7420 6f72 206c 6973 7420 6f66 2070  Set or list of p
-00007f50: 6f6c 7967 6f6e 7320 746f 2062 6520 6372  olygons to be cr
-00007f60: 6f70 7065 642e 0a20 2020 2062 626f 7865  opped..    bboxe
-00007f70: 7320 3a20 6c69 7374 0a20 2020 2020 2020  s : list.       
-00007f80: 204c 6973 7420 6f66 2061 6c6c 2070 6f6c   List of all pol
-00007f90: 7967 6f6e 2062 626f 7865 7320 696e 2061  ygon bboxes in a
-00007fa0: 6c6c 5f70 6f6c 7967 6f6e 732e 0a20 2020  ll_polygons..   
-00007fb0: 206c 6566 7420 3a20 696e 7420 6f72 2066   left : int or f
-00007fc0: 6c6f 6174 0a20 2020 2020 2020 2054 6865  loat.        The
-00007fd0: 2078 2d63 6f6f 7264 696e 6174 6520 6f66   x-coordinate of
-00007fe0: 2074 6865 206c 6566 7468 616e 6420 626f   the lefthand bo
-00007ff0: 756e 6461 7279 2e0a 2020 2020 626f 7474  undary..    bott
-00008000: 6f6d 203a 2069 6e74 206f 7220 666c 6f61  om : int or floa
-00008010: 740a 2020 2020 2020 2020 5468 6520 792d  t.        The y-
-00008020: 636f 6f72 6469 6e61 7465 206f 6620 7468  coordinate of th
-00008030: 6520 626f 7474 6f6d 2062 6f75 6e64 6172  e bottom boundar
-00008040: 792e 0a20 2020 2072 6967 6874 203a 2069  y..    right : i
-00008050: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
-00008060: 2020 2020 5468 6520 782d 636f 6f72 6469      The x-coordi
-00008070: 6e61 7465 206f 6620 7468 6520 7269 6768  nate of the righ
-00008080: 7468 616e 6420 626f 756e 6461 7279 2e0a  thand boundary..
-00008090: 2020 2020 746f 7020 3a20 696e 7420 6f72      top : int or
-000080a0: 2066 6c6f 6174 0a20 2020 2020 2020 2054   float.        T
-000080b0: 6865 2079 2d63 6f6f 7264 696e 6174 6520  he y-coordinate 
-000080c0: 6f66 2074 6865 2074 6f70 2062 6f75 6e64  of the top bound
-000080d0: 6172 792e 0a20 2020 2070 7265 6369 7369  ary..    precisi
-000080e0: 6f6e 203a 2066 6c6f 6174 0a20 2020 2020  on : float.     
-000080f0: 2020 2044 6573 6972 6564 2070 7265 6369     Desired preci
-00008100: 7369 6f6e 2066 6f72 2072 6f75 6e64 696e  sion for roundin
-00008110: 6720 7665 7274 6578 2063 6f6f 7264 696e  g vertex coordin
-00008120: 6174 6573 2e0a 0a20 2020 2052 6574 7572  ates...    Retur
-00008130: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-00008140: 2020 2070 6f6c 7967 6f6e 735f 746f 5f70     polygons_to_p
-00008150: 726f 6365 7373 203a 2050 6f6c 7967 6f6e  rocess : Polygon
-00008160: 5365 7420 6f72 206c 6973 7420 6f66 2070  Set or list of p
-00008170: 6f6c 7967 6f6e 730a 2020 2020 2020 2020  olygons.        
-00008180: 5365 7420 6f72 206c 6973 7420 6f66 2070  Set or list of p
-00008190: 6f6c 7967 6f6e 7320 7769 7468 2063 726f  olygons with cro
-000081a0: 7020 6170 706c 6965 6420 746f 2065 6467  p applied to edg
-000081b0: 6520 706f 6c79 676f 6e73 2e0a 2020 2020  e polygons..    
-000081c0: 2222 220a 2020 2020 706f 6c79 676f 6e73  """.    polygons
-000081d0: 5f69 6e5f 7265 6374 5f69 203d 205f 6669  _in_rect_i = _fi
-000081e0: 6e64 5f62 626f 7865 735f 696e 5f72 6563  nd_bboxes_in_rec
-000081f0: 7428 6262 6f78 6573 2c20 6c65 6674 2c20  t(bboxes, left, 
-00008200: 626f 7474 6f6d 2c20 7269 6768 742c 2074  bottom, right, t
-00008210: 6f70 290a 2020 2020 706f 6c79 676f 6e73  op).    polygons
-00008220: 5f65 6467 655f 6920 3d20 5f66 696e 645f  _edge_i = _find_
-00008230: 6262 6f78 6573 5f6f 6e5f 7265 6374 5f65  bboxes_on_rect_e
-00008240: 6467 6528 6262 6f78 6573 2c20 6c65 6674  dge(bboxes, left
-00008250: 2c20 626f 7474 6f6d 2c20 7269 6768 742c  , bottom, right,
-00008260: 2074 6f70 290a 2020 2020 706f 6c79 676f   top).    polygo
-00008270: 6e73 5f69 6e5f 7265 6374 5f6e 6f5f 6564  ns_in_rect_no_ed
-00008280: 6765 5f69 203d 2070 6f6c 7967 6f6e 735f  ge_i = polygons_
-00008290: 696e 5f72 6563 745f 6920 2620 287e 706f  in_rect_i & (~po
-000082a0: 6c79 676f 6e73 5f65 6467 655f 6929 0a0a  lygons_edge_i)..
-000082b0: 2020 2020 2320 4372 6f70 2070 6f6c 7967      # Crop polyg
-000082c0: 6f6e 7320 616c 6f6e 6720 7468 6520 6564  ons along the ed
-000082d0: 6765 2061 6e64 2072 6563 6f6d 6269 6e65  ge and recombine
-000082e0: 2074 6865 6d20 7769 7468 2070 6f6c 7967   them with polyg
-000082f0: 6f6e 7320 696e 7369 6465 2074 6865 0a20  ons inside the. 
-00008300: 2020 2023 2072 6563 7461 6e67 6c65 0a20     # rectangle. 
-00008310: 2020 2070 6f6c 7967 6f6e 735f 6564 6765     polygons_edge
-00008320: 203d 2061 6c6c 5f70 6f6c 7967 6f6e 735b   = all_polygons[
-00008330: 706f 6c79 676f 6e73 5f65 6467 655f 695d  polygons_edge_i]
-00008340: 0a20 2020 2070 6f6c 7967 6f6e 735f 696e  .    polygons_in
-00008350: 5f72 6563 745f 6e6f 5f65 6467 6520 3d20  _rect_no_edge = 
-00008360: 616c 6c5f 706f 6c79 676f 6e73 5b70 6f6c  all_polygons[pol
-00008370: 7967 6f6e 735f 696e 5f72 6563 745f 6e6f  ygons_in_rect_no
-00008380: 5f65 6467 655f 695d 2e74 6f6c 6973 7428  _edge_i].tolist(
-00008390: 290a 2020 2020 706f 6c79 676f 6e73 5f65  ).    polygons_e
-000083a0: 6467 655f 6372 6f70 7065 6420 3d20 5f63  dge_cropped = _c
-000083b0: 726f 705f 7265 6769 6f6e 280a 2020 2020  rop_region(.    
-000083c0: 2020 2020 706f 6c79 676f 6e73 5f65 6467      polygons_edg
-000083d0: 652c 206c 6566 742c 2062 6f74 746f 6d2c  e, left, bottom,
-000083e0: 2072 6967 6874 2c20 746f 702c 2070 7265   right, top, pre
-000083f0: 6369 7369 6f6e 3d70 7265 6369 7369 6f6e  cision=precision
-00008400: 0a20 2020 2029 0a20 2020 2070 6f6c 7967  .    ).    polyg
-00008410: 6f6e 735f 746f 5f70 726f 6365 7373 203d  ons_to_process =
-00008420: 2070 6f6c 7967 6f6e 735f 696e 5f72 6563   polygons_in_rec
-00008430: 745f 6e6f 5f65 6467 6520 2b20 706f 6c79  t_no_edge + poly
-00008440: 676f 6e73 5f65 6467 655f 6372 6f70 7065  gons_edge_croppe
-00008450: 640a 0a20 2020 2072 6574 7572 6e20 706f  d..    return po
-00008460: 6c79 676f 6e73 5f74 6f5f 7072 6f63 6573  lygons_to_proces
-00008470: 730a 0a0a 6465 6620 5f66 696e 645f 6262  s...def _find_bb
-00008480: 6f78 6573 5f69 6e5f 7265 6374 2862 626f  oxes_in_rect(bbo
-00008490: 7865 732c 206c 6566 742c 2062 6f74 746f  xes, left, botto
-000084a0: 6d2c 2072 6967 6874 2c20 746f 7029 3a0a  m, right, top):.
-000084b0: 2020 2020 2222 2247 6976 656e 2061 206c      """Given a l
-000084c0: 6973 7420 6f66 2070 6f6c 7967 6f6e 2062  ist of polygon b
-000084d0: 6f75 6e64 696e 6720 626f 7865 7320 616e  ounding boxes an
-000084e0: 6420 6120 7265 6374 616e 676c 6520 6465  d a rectangle de
-000084f0: 6669 6e65 6420 6279 0a20 2020 206c 6566  fined by.    lef
-00008500: 742f 626f 7474 6f6d 2f72 6967 6874 2f74  t/bottom/right/t
-00008510: 6f70 2c20 7468 6973 2066 756e 6374 696f  op, this functio
-00008520: 6e20 7265 7475 726e 7320 7468 6f73 6520  n returns those 
-00008530: 706f 6c79 676f 6e73 2077 6869 6368 206f  polygons which o
-00008540: 7665 726c 6170 0a20 2020 2074 6865 2072  verlap.    the r
-00008550: 6563 7461 6e67 6c65 2e0a 0a20 2020 2050  ectangle...    P
-00008560: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-00008570: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2062 626f  --------.    bbo
-00008580: 7865 7320 3a20 6c69 7374 0a20 2020 2020  xes : list.     
-00008590: 2020 204c 6973 7420 6f66 2061 6c6c 2070     List of all p
-000085a0: 6f6c 7967 6f6e 2062 626f 7865 732e 0a20  olygon bboxes.. 
-000085b0: 2020 206c 6566 7420 3a20 696e 7420 6f72     left : int or
-000085c0: 2066 6c6f 6174 0a20 2020 2020 2020 2054   float.        T
-000085d0: 6865 2078 2d63 6f6f 7264 696e 6174 6520  he x-coordinate 
-000085e0: 6f66 2074 6865 206c 6566 7468 616e 6420  of the lefthand 
-000085f0: 626f 756e 6461 7279 2e0a 2020 2020 626f  boundary..    bo
-00008600: 7474 6f6d 203a 2069 6e74 206f 7220 666c  ttom : int or fl
-00008610: 6f61 740a 2020 2020 2020 2020 5468 6520  oat.        The 
-00008620: 792d 636f 6f72 6469 6e61 7465 206f 6620  y-coordinate of 
-00008630: 7468 6520 626f 7474 6f6d 2062 6f75 6e64  the bottom bound
-00008640: 6172 792e 0a20 2020 2072 6967 6874 203a  ary..    right :
-00008650: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
-00008660: 2020 2020 2020 5468 6520 782d 636f 6f72        The x-coor
-00008670: 6469 6e61 7465 206f 6620 7468 6520 7269  dinate of the ri
-00008680: 6768 7468 616e 6420 626f 756e 6461 7279  ghthand boundary
-00008690: 2e0a 2020 2020 746f 7020 3a20 696e 7420  ..    top : int 
-000086a0: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
-000086b0: 2054 6865 2079 2d63 6f6f 7264 696e 6174   The y-coordinat
-000086c0: 6520 6f66 2074 6865 2074 6f70 2062 6f75  e of the top bou
-000086d0: 6e64 6172 792e 0a0a 2020 2020 5265 7475  ndary...    Retu
-000086e0: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-000086f0: 2020 2020 7265 7375 6c74 203a 206c 6973      result : lis
-00008700: 740a 2020 2020 2020 2020 4c69 7374 206f  t.        List o
-00008710: 6620 616c 6c20 706f 6c79 676f 6e20 6262  f all polygon bb
-00008720: 6f78 6573 2074 6861 7420 6f76 6572 6c61  oxes that overla
-00008730: 7020 7769 7468 2074 6865 2064 6566 696e  p with the defin
-00008740: 6564 2072 6563 7461 6e67 6c65 2e0a 2020  ed rectangle..  
-00008750: 2020 2222 220a 2020 2020 7265 7375 6c74    """.    result
-00008760: 203d 2028 0a20 2020 2020 2020 2028 6262   = (.        (bb
-00008770: 6f78 6573 5b3a 2c20 305d 203c 3d20 7269  oxes[:, 0] <= ri
-00008780: 6768 7429 0a20 2020 2020 2020 2026 2028  ght).        & (
-00008790: 6262 6f78 6573 5b3a 2c20 325d 203e 3d20  bboxes[:, 2] >= 
-000087a0: 6c65 6674 290a 2020 2020 2020 2020 2620  left).        & 
-000087b0: 2862 626f 7865 735b 3a2c 2031 5d20 3c3d  (bboxes[:, 1] <=
-000087c0: 2074 6f70 290a 2020 2020 2020 2020 2620   top).        & 
-000087d0: 2862 626f 7865 735b 3a2c 2033 5d20 3e3d  (bboxes[:, 3] >=
-000087e0: 2062 6f74 746f 6d29 0a20 2020 2029 0a20   bottom).    ). 
-000087f0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-00008800: 0a0a 0a23 205f 6669 6e64 5f62 626f 7865  ...# _find_bboxe
-00008810: 735f 6f6e 5f72 6563 745f 6564 6765 0a64  s_on_rect_edge.d
-00008820: 6566 205f 6669 6e64 5f62 626f 7865 735f  ef _find_bboxes_
-00008830: 6f6e 5f72 6563 745f 6564 6765 2862 626f  on_rect_edge(bbo
-00008840: 7865 732c 206c 6566 742c 2062 6f74 746f  xes, left, botto
-00008850: 6d2c 2072 6967 6874 2c20 746f 7029 3a0a  m, right, top):.
-00008860: 2020 2020 2222 2247 6976 656e 2061 206c      """Given a l
-00008870: 6973 7420 6f66 2070 6f6c 7967 6f6e 2062  ist of polygon b
-00008880: 6f75 6e64 696e 6720 626f 7865 7320 616e  ounding boxes an
-00008890: 6420 6120 7265 6374 616e 6775 6c61 7220  d a rectangular 
-000088a0: 626f 756e 6461 7279 0a20 2020 2064 6566  boundary.    def
-000088b0: 696e 6564 2062 7920 6c65 6674 2f62 6f74  ined by left/bot
-000088c0: 746f 6d2f 7269 6768 742f 746f 702c 2074  tom/right/top, t
-000088d0: 6869 7320 6675 6e63 7469 6f6e 2072 6574  his function ret
-000088e0: 7572 6e73 2074 686f 7365 2070 6f6c 7967  urns those polyg
-000088f0: 6f6e 730a 2020 2020 7768 6963 6820 696e  ons.    which in
-00008900: 7465 7273 6563 7420 7468 6520 7265 6374  tersect the rect
-00008910: 616e 6775 6c61 7220 626f 756e 6461 7279  angular boundary
-00008920: 2e0a 0a20 2020 2050 6172 616d 6574 6572  ...    Parameter
-00008930: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-00008940: 0a20 2020 2062 626f 7865 7320 3a20 6c69  .    bboxes : li
-00008950: 7374 0a20 2020 2020 2020 204c 6973 7420  st.        List 
-00008960: 6f66 2061 6c6c 2070 6f6c 7967 6f6e 2062  of all polygon b
-00008970: 626f 7865 732e 0a20 2020 206c 6566 7420  boxes..    left 
-00008980: 3a20 696e 7420 6f72 2066 6c6f 6174 0a20  : int or float. 
-00008990: 2020 2020 2020 2054 6865 2078 2d63 6f6f         The x-coo
-000089a0: 7264 696e 6174 6520 6f66 2074 6865 206c  rdinate of the l
-000089b0: 6566 7468 616e 6420 626f 756e 6461 7279  efthand boundary
-000089c0: 2e0a 2020 2020 626f 7474 6f6d 203a 2069  ..    bottom : i
-000089d0: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
-000089e0: 2020 2020 5468 6520 792d 636f 6f72 6469      The y-coordi
-000089f0: 6e61 7465 206f 6620 7468 6520 626f 7474  nate of the bott
-00008a00: 6f6d 2062 6f75 6e64 6172 792e 0a20 2020  om boundary..   
-00008a10: 2072 6967 6874 203a 2069 6e74 206f 7220   right : int or 
-00008a20: 666c 6f61 740a 2020 2020 2020 2020 5468  float.        Th
-00008a30: 6520 782d 636f 6f72 6469 6e61 7465 206f  e x-coordinate o
-00008a40: 6620 7468 6520 7269 6768 7468 616e 6420  f the righthand 
-00008a50: 626f 756e 6461 7279 2e0a 2020 2020 746f  boundary..    to
-00008a60: 7020 3a20 696e 7420 6f72 2066 6c6f 6174  p : int or float
-00008a70: 0a20 2020 2020 2020 2054 6865 2079 2d63  .        The y-c
-00008a80: 6f6f 7264 696e 6174 6520 6f66 2074 6865  oordinate of the
-00008a90: 2074 6f70 2062 6f75 6e64 6172 792e 0a0a   top boundary...
-00008aa0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-00008ab0: 2d2d 2d2d 2d2d 2d0a 2020 2020 7265 7375  -------.    resu
-00008ac0: 6c74 203a 206c 6973 740a 2020 2020 2020  lt : list.      
-00008ad0: 2020 4c69 7374 206f 6620 616c 6c20 706f    List of all po
-00008ae0: 6c79 676f 6e20 6262 6f78 6573 2074 6861  lygon bboxes tha
-00008af0: 7420 696e 7465 7273 6563 7420 7468 6520  t intersect the 
-00008b00: 6465 6669 6e65 6420 7265 6374 616e 6775  defined rectangu
-00008b10: 6c61 720a 2020 2020 2020 2020 626f 756e  lar.        boun
-00008b20: 6461 7279 2e0a 2020 2020 2222 220a 2020  dary..    """.  
-00008b30: 2020 6262 6f78 6573 5f6c 6566 7420 3d20    bboxes_left = 
-00008b40: 5f66 696e 645f 6262 6f78 6573 5f69 6e5f  _find_bboxes_in_
-00008b50: 7265 6374 2862 626f 7865 732c 206c 6566  rect(bboxes, lef
-00008b60: 742c 2062 6f74 746f 6d2c 206c 6566 742c  t, bottom, left,
-00008b70: 2074 6f70 290a 2020 2020 6262 6f78 6573   top).    bboxes
-00008b80: 5f72 6967 6874 203d 205f 6669 6e64 5f62  _right = _find_b
-00008b90: 626f 7865 735f 696e 5f72 6563 7428 6262  boxes_in_rect(bb
-00008ba0: 6f78 6573 2c20 7269 6768 742c 2062 6f74  oxes, right, bot
-00008bb0: 746f 6d2c 2072 6967 6874 2c20 746f 7029  tom, right, top)
-00008bc0: 0a20 2020 2062 626f 7865 735f 746f 7020  .    bboxes_top 
-00008bd0: 3d20 5f66 696e 645f 6262 6f78 6573 5f69  = _find_bboxes_i
-00008be0: 6e5f 7265 6374 2862 626f 7865 732c 206c  n_rect(bboxes, l
-00008bf0: 6566 742c 2074 6f70 2c20 7269 6768 742c  eft, top, right,
-00008c00: 2074 6f70 290a 2020 2020 6262 6f78 6573   top).    bboxes
-00008c10: 5f62 6f74 746f 6d20 3d20 5f66 696e 645f  _bottom = _find_
-00008c20: 6262 6f78 6573 5f69 6e5f 7265 6374 2862  bboxes_in_rect(b
-00008c30: 626f 7865 732c 206c 6566 742c 2062 6f74  boxes, left, bot
-00008c40: 746f 6d2c 2072 6967 6874 2c20 626f 7474  tom, right, bott
-00008c50: 6f6d 290a 2020 2020 7265 7375 6c74 203d  om).    result =
-00008c60: 2062 626f 7865 735f 6c65 6674 207c 2062   bboxes_left | b
-00008c70: 626f 7865 735f 7269 6768 7420 7c20 6262  boxes_right | bb
-00008c80: 6f78 6573 5f74 6f70 207c 2062 626f 7865  oxes_top | bboxe
-00008c90: 735f 626f 7474 6f6d 0a20 2020 2072 6574  s_bottom.    ret
-00008ca0: 7572 6e20 7265 7375 6c74 0a0a 0a64 6566  urn result...def
-00008cb0: 205f 6f66 6673 6574 5f72 6567 696f 6e28   _offset_region(
-00008cc0: 0a20 2020 2061 6c6c 5f70 6f6c 7967 6f6e  .    all_polygon
-00008cd0: 732c 0a20 2020 2062 626f 7865 732c 0a20  s,.    bboxes,. 
-00008ce0: 2020 206c 6566 742c 0a20 2020 2062 6f74     left,.    bot
-00008cf0: 746f 6d2c 0a20 2020 2072 6967 6874 2c0a  tom,.    right,.
-00008d00: 2020 2020 746f 702c 0a20 2020 2064 6973      top,.    dis
-00008d10: 7461 6e63 653d 352c 0a20 2020 206a 6f69  tance=5,.    joi
-00008d20: 6e5f 6669 7273 743d 5472 7565 2c0a 2020  n_first=True,.  
-00008d30: 2020 7072 6563 6973 696f 6e3d 3165 2d34    precision=1e-4
-00008d40: 2c0a 2020 2020 6a6f 696e 3d22 6d69 7465  ,.    join="mite
-00008d50: 7222 2c0a 2020 2020 746f 6c65 7261 6e63  r",.    toleranc
-00008d60: 653d 322c 0a29 3a0a 2020 2020 2222 2254  e=2,.):.    """T
-00008d70: 616b 696e 6720 6120 7265 6769 6f6e 206f  aking a region o
-00008d80: 6620 652e 672e 2073 697a 6520 2878 2c20  f e.g. size (x, 
-00008d90: 7929 2077 6869 6368 206e 6565 6473 2074  y) which needs t
-00008da0: 6f20 6265 206f 6666 7365 7420 6279 0a20  o be offset by. 
-00008db0: 2020 2064 6973 7461 6e63 6520 642c 2074     distance d, t
-00008dc0: 6869 7320 6675 6e63 7469 6f6e 2063 726f  his function cro
-00008dd0: 7073 206f 7574 2061 2072 6567 696f 6e20  ps out a region 
-00008de0: 2878 2b32 2a64 2c20 792b 322a 6429 206c  (x+2*d, y+2*d) l
-00008df0: 6172 6765 2c20 6f66 6673 6574 730a 2020  arge, offsets.  
-00008e00: 2020 7468 6174 2072 6567 696f 6e2c 2074    that region, t
-00008e10: 6865 6e20 6372 6f70 7320 6974 2062 6163  hen crops it bac
-00008e20: 6b20 746f 2073 697a 6520 2878 2c20 7929  k to size (x, y)
-00008e30: 2074 6f20 6372 6561 7465 2061 2076 616c   to create a val
-00008e40: 6964 2072 6573 756c 742e 0a0a 2020 2020  id result...    
-00008e50: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-00008e60: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 616c  ---------.    al
-00008e70: 6c5f 706f 6c79 676f 6e73 203a 2050 6f6c  l_polygons : Pol
-00008e80: 7967 6f6e 5365 7420 6f72 206c 6973 7420  ygonSet or list 
-00008e90: 6f66 2070 6f6c 7967 6f6e 730a 2020 2020  of polygons.    
-00008ea0: 2020 2020 5365 7420 6f72 206c 6973 7420      Set or list 
-00008eb0: 6f66 2070 6f6c 7967 6f6e 7320 746f 2062  of polygons to b
-00008ec0: 6520 6372 6f70 7065 6420 616e 6420 6f66  e cropped and of
-00008ed0: 6673 6574 2e0a 2020 2020 6262 6f78 6573  fset..    bboxes
-00008ee0: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
-00008ef0: 4c69 7374 206f 6620 616c 6c20 706f 6c79  List of all poly
-00008f00: 676f 6e20 6262 6f78 6573 2069 6e20 616c  gon bboxes in al
-00008f10: 6c5f 706f 6c79 676f 6e73 2e0a 2020 2020  l_polygons..    
-00008f20: 6c65 6674 203a 2069 6e74 206f 7220 666c  left : int or fl
-00008f30: 6f61 740a 2020 2020 2020 2020 5468 6520  oat.        The 
-00008f40: 782d 636f 6f72 6469 6e61 7465 206f 6620  x-coordinate of 
-00008f50: 7468 6520 6c65 6674 6861 6e64 2062 6f75  the lefthand bou
-00008f60: 6e64 6172 792e 0a20 2020 2062 6f74 746f  ndary..    botto
-00008f70: 6d20 3a20 696e 7420 6f72 2066 6c6f 6174  m : int or float
-00008f80: 0a20 2020 2020 2020 2054 6865 2079 2d63  .        The y-c
-00008f90: 6f6f 7264 696e 6174 6520 6f66 2074 6865  oordinate of the
-00008fa0: 2062 6f74 746f 6d20 626f 756e 6461 7279   bottom boundary
-00008fb0: 2e0a 2020 2020 7269 6768 7420 3a20 696e  ..    right : in
-00008fc0: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
-00008fd0: 2020 2054 6865 2078 2d63 6f6f 7264 696e     The x-coordin
-00008fe0: 6174 6520 6f66 2074 6865 2072 6967 6874  ate of the right
-00008ff0: 6861 6e64 2062 6f75 6e64 6172 792e 0a20  hand boundary.. 
-00009000: 2020 2074 6f70 203a 2069 6e74 206f 7220     top : int or 
-00009010: 666c 6f61 740a 2020 2020 2020 2020 5468  float.        Th
-00009020: 6520 792d 636f 6f72 6469 6e61 7465 206f  e y-coordinate o
-00009030: 6620 7468 6520 746f 7020 626f 756e 6461  f the top bounda
-00009040: 7279 2e0a 2020 2020 6469 7374 616e 6365  ry..    distance
-00009050: 203a 2069 6e74 206f 7220 666c 6f61 740a   : int or float.
-00009060: 2020 2020 2020 2020 4469 7374 616e 6365          Distance
-00009070: 2074 6f20 6f66 6673 6574 2070 6f6c 7967   to offset polyg
-00009080: 6f6e 732e 2050 6f73 6974 6976 6520 7661  ons. Positive va
-00009090: 6c75 6573 2065 7870 616e 642c 206e 6567  lues expand, neg
-000090a0: 6174 6976 6520 7368 7269 6e6b 2e0a 2020  ative shrink..  
-000090b0: 2020 6a6f 696e 5f66 6972 7374 203a 2062    join_first : b
-000090c0: 6f6f 6c0a 2020 2020 2020 2020 4a6f 696e  ool.        Join
-000090d0: 2061 6c6c 2070 6174 6873 2062 6566 6f72   all paths befor
-000090e0: 6520 6f66 6673 6574 7469 6e67 2074 6f20  e offsetting to 
-000090f0: 6176 6f69 6420 756e 6e65 6365 7373 6172  avoid unnecessar
-00009100: 7920 6a6f 696e 7320 696e 0a20 2020 2020  y joins in.     
-00009110: 2020 2061 646a 6163 656e 7420 706f 6c79     adjacent poly
-00009120: 676f 6e20 7369 6465 732e 0a20 2020 2070  gon sides..    p
-00009130: 7265 6369 7369 6f6e 203a 2066 6c6f 6174  recision : float
-00009140: 0a20 2020 2020 2020 2044 6573 6972 6564  .        Desired
-00009150: 2070 7265 6369 7369 6f6e 2066 6f72 2072   precision for r
-00009160: 6f75 6e64 696e 6720 7665 7274 6578 2063  ounding vertex c
-00009170: 6f6f 7264 696e 6174 6573 2e0a 2020 2020  oordinates..    
-00009180: 6a6f 696e 203a 207b 276d 6974 6572 272c  join : {'miter',
-00009190: 2027 6265 7665 6c27 2c20 2772 6f75 6e64   'bevel', 'round
-000091a0: 277d 0a20 2020 2020 2020 2054 7970 6520  '}.        Type 
-000091b0: 6f66 206a 6f69 6e20 7573 6564 2074 6f20  of join used to 
-000091c0: 6372 6561 7465 2074 6865 206f 6666 7365  create the offse
-000091d0: 7420 706f 6c79 676f 6e2e 0a20 2020 2074  t polygon..    t
-000091e0: 6f6c 6572 616e 6365 203a 2069 6e74 206f  olerance : int o
-000091f0: 7220 666c 6f61 740a 2020 2020 2020 2020  r float.        
-00009200: 466f 7220 6d69 7465 7220 6a6f 696e 7473  For miter joints
-00009210: 2c20 7468 6973 206e 756d 6265 7220 6d75  , this number mu
-00009220: 7374 2062 6520 6174 206c 6561 7374 2032  st be at least 2
-00009230: 2061 6e64 2069 7420 7265 7072 6573 656e   and it represen
-00009240: 7473 2074 6865 0a20 2020 2020 2020 206d  ts the.        m
-00009250: 6178 696d 616c 2064 6973 7461 6e63 6520  aximal distance 
-00009260: 696e 206d 756c 7469 706c 6573 206f 6620  in multiples of 
-00009270: 6f66 6673 6574 2062 6574 7765 656e 206e  offset between n
-00009280: 6577 2076 6572 7469 6365 7320 616e 6420  ew vertices and 
-00009290: 7468 6569 720a 2020 2020 2020 2020 6f72  their.        or
-000092a0: 6967 696e 616c 2070 6f73 6974 696f 6e20  iginal position 
-000092b0: 6265 666f 7265 2062 6576 656c 696e 6720  before beveling 
-000092c0: 746f 2061 766f 6964 2073 7069 6b65 7320  to avoid spikes 
-000092d0: 6174 2061 6375 7465 206a 6f69 6e74 732e  at acute joints.
-000092e0: 2046 6f72 0a20 2020 2020 2020 2072 6f75   For.        rou
-000092f0: 6e64 206a 6f69 6e74 732c 2069 7420 696e  nd joints, it in
-00009300: 6469 6361 7465 7320 7468 6520 6375 7276  dicates the curv
-00009310: 6174 7572 6520 7265 736f 6c75 7469 6f6e  ature resolution
-00009320: 2069 6e20 6e75 6d62 6572 206f 660a 2020   in number of.  
-00009330: 2020 2020 2020 706f 696e 7473 2070 6572        points per
-00009340: 2066 756c 6c20 6369 7263 6c65 2e0a 0a20   full circle... 
-00009350: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
-00009360: 2d2d 2d2d 2d2d 0a20 2020 2070 6f6c 7967  ------.    polyg
-00009370: 6f6e 735f 6f66 6673 6574 5f63 726f 7070  ons_offset_cropp
-00009380: 6564 203a 0a20 2020 2020 2020 2054 6865  ed :.        The
-00009390: 2072 6573 756c 7469 6e67 2069 6e70 7574   resulting input
-000093a0: 2070 6f6c 7967 6f6e 7320 7468 6174 2061   polygons that a
-000093b0: 7265 2063 726f 7070 6564 2074 6f20 6265  re cropped to be
-000093c0: 2062 6574 7765 656e 2074 6865 0a20 2020   between the.   
-000093d0: 2020 2020 2063 6f6f 7264 696e 6174 6573       coordinates
-000093e0: 2028 6c65 6674 2c20 626f 7474 6f6d 2c20   (left, bottom, 
-000093f0: 7269 6768 742c 2074 6f70 290a 0a20 2020  right, top)..   
-00009400: 2022 2222 0a0a 2020 2020 2320 4d61 726b   """..    # Mark
-00009410: 206f 7574 2061 2072 6567 696f 6e20 736c   out a region sl
-00009420: 6967 6874 6c79 206c 6172 6765 7220 7468  ightly larger th
-00009430: 616e 2074 6865 2066 696e 616c 2064 6573  an the final des
-00009440: 6972 6564 2072 6567 696f 6e0a 2020 2020  ired region.    
-00009450: 6420 3d20 6469 7374 616e 6365 202a 2031  d = distance * 1
-00009460: 2e30 310a 0a20 2020 2070 6f6c 7967 6f6e  .01..    polygon
-00009470: 735f 746f 5f6f 6666 7365 7420 3d20 5f63  s_to_offset = _c
-00009480: 726f 705f 6564 6765 5f70 6f6c 7967 6f6e  rop_edge_polygon
-00009490: 7328 0a20 2020 2020 2020 2061 6c6c 5f70  s(.        all_p
-000094a0: 6f6c 7967 6f6e 732c 0a20 2020 2020 2020  olygons,.       
-000094b0: 2062 626f 7865 732c 0a20 2020 2020 2020   bboxes,.       
-000094c0: 206c 6566 7420 2d20 642c 0a20 2020 2020   left - d,.     
-000094d0: 2020 2062 6f74 746f 6d20 2d20 642c 0a20     bottom - d,. 
-000094e0: 2020 2020 2020 2072 6967 6874 202b 2064         right + d
-000094f0: 2c0a 2020 2020 2020 2020 746f 7020 2b20  ,.        top + 
-00009500: 642c 0a20 2020 2020 2020 2070 7265 6369  d,.        preci
-00009510: 7369 6f6e 3d70 7265 6369 7369 6f6e 2c0a  sion=precision,.
-00009520: 2020 2020 290a 0a20 2020 2023 204f 6666      )..    # Off
-00009530: 7365 7420 7468 6520 7265 7375 6c74 696e  set the resultin
-00009540: 6720 6372 6f70 7065 6420 706f 6c79 676f  g cropped polygo
-00009550: 6e73 2061 6e64 2072 6563 726f 7020 746f  ns and recrop to
-00009560: 2066 696e 616c 2064 6573 6972 6564 2073   final desired s
-00009570: 697a 650a 2020 2020 706f 6c79 676f 6e73  ize.    polygons
-00009580: 5f6f 6666 7365 7420 3d20 636c 6970 7065  _offset = clippe
-00009590: 722e 6f66 6673 6574 280a 2020 2020 2020  r.offset(.      
-000095a0: 2020 706f 6c79 676f 6e73 5f74 6f5f 6f66    polygons_to_of
-000095b0: 6673 6574 2c20 6469 7374 616e 6365 2c20  fset, distance, 
-000095c0: 6a6f 696e 2c20 746f 6c65 7261 6e63 652c  join, tolerance,
-000095d0: 2031 202f 2070 7265 6369 7369 6f6e 2c20   1 / precision, 
-000095e0: 696e 7428 6a6f 696e 5f66 6972 7374 290a  int(join_first).
-000095f0: 2020 2020 290a 2020 2020 706f 6c79 676f      ).    polygo
-00009600: 6e73 5f6f 6666 7365 745f 6372 6f70 7065  ns_offset_croppe
-00009610: 6420 3d20 5f63 726f 705f 7265 6769 6f6e  d = _crop_region
-00009620: 280a 2020 2020 2020 2020 706f 6c79 676f  (.        polygo
-00009630: 6e73 5f6f 6666 7365 742c 206c 6566 742c  ns_offset, left,
-00009640: 2062 6f74 746f 6d2c 2072 6967 6874 2c20   bottom, right, 
-00009650: 746f 702c 2070 7265 6369 7369 6f6e 3d70  top, precision=p
-00009660: 7265 6369 7369 6f6e 0a20 2020 2029 0a0a  recision.    )..
-00009670: 2020 2020 7265 7475 726e 2070 6f6c 7967      return polyg
-00009680: 6f6e 735f 6f66 6673 6574 5f63 726f 7070  ons_offset_cropp
-00009690: 6564 0a0a 0a64 6566 205f 706f 6c79 676f  ed...def _polygo
-000096a0: 6e73 5f74 6f5f 6262 6f78 6573 2870 6f6c  ns_to_bboxes(pol
-000096b0: 7967 6f6e 7329 3a0a 2020 2020 2222 2247  ygons):.    """G
-000096c0: 656e 6572 6174 6573 2074 6865 2062 626f  enerates the bbo
-000096d0: 7865 7320 6f66 2061 6c6c 2069 6e70 7574  xes of all input
-000096e0: 2070 6f6c 7967 6f6e 732e 0a0a 2020 2020   polygons...    
-000096f0: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-00009700: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 706f  ---------.    po
-00009710: 6c79 676f 6e73 203a 2050 6f6c 7967 6f6e  lygons : Polygon
-00009720: 5365 7420 6f72 206c 6973 7420 6f66 2070  Set or list of p
-00009730: 6f6c 7967 6f6e 730a 2020 2020 2020 2020  olygons.        
-00009740: 5365 7420 6f72 206c 6973 7420 6f66 2070  Set or list of p
-00009750: 6f6c 7967 6f6e 7320 746f 2067 656e 6572  olygons to gener
-00009760: 6174 6520 6262 6f78 6573 206f 662e 0a0a  ate bboxes of...
-00009770: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-00009780: 2d2d 2d2d 2d2d 2d0a 2020 2020 6262 6f78  -------.    bbox
-00009790: 6573 203a 206c 6973 740a 2020 2020 2020  es : list.      
-000097a0: 2020 4c69 7374 206f 6620 616c 6c20 706f    List of all po
-000097b0: 6c79 676f 6e20 6262 6f78 6573 2069 6e20  lygon bboxes in 
-000097c0: 706f 6c79 676f 6e73 2e0a 2020 2020 2222  polygons..    ""
-000097d0: 220a 2020 2020 2320 2020 2042 7569 6c64  ".    #    Build
-000097e0: 2062 6f75 6e64 696e 6720 626f 7865 730a   bounding boxes.
-000097f0: 2020 2020 6262 6f78 6573 203d 206e 702e      bboxes = np.
-00009800: 656d 7074 7928 5b6c 656e 2870 6f6c 7967  empty([len(polyg
-00009810: 6f6e 7329 2c20 345d 290a 2020 2020 666f  ons), 4]).    fo
-00009820: 7220 6e2c 2070 2069 6e20 656e 756d 6572  r n, p in enumer
-00009830: 6174 6528 706f 6c79 676f 6e73 293a 0a20  ate(polygons):. 
-00009840: 2020 2020 2020 206c 6566 742c 2062 6f74         left, bot
-00009850: 746f 6d20 3d20 6e70 2e6d 696e 2870 2c20  tom = np.min(p, 
-00009860: 6178 6973 3d30 290a 2020 2020 2020 2020  axis=0).        
-00009870: 7269 6768 742c 2074 6f70 203d 206e 702e  right, top = np.
-00009880: 6d61 7828 702c 2061 7869 733d 3029 0a20  max(p, axis=0). 
-00009890: 2020 2020 2020 2062 626f 7865 735b 6e5d         bboxes[n]
-000098a0: 203d 205b 6c65 6674 2c20 626f 7474 6f6d   = [left, bottom
-000098b0: 2c20 7269 6768 742c 2074 6f70 5d0a 2020  , right, top].  
-000098c0: 2020 7265 7475 726e 2062 626f 7865 730a    return bboxes.
-000098d0: 0a0a 6465 6620 5f6f 6666 7365 745f 706f  ..def _offset_po
-000098e0: 6c79 676f 6e73 5f70 6172 616c 6c65 6c28  lygons_parallel(
-000098f0: 0a20 2020 2070 6f6c 7967 6f6e 732c 0a20  .    polygons,. 
-00009900: 2020 2064 6973 7461 6e63 653d 352c 0a20     distance=5,. 
-00009910: 2020 206e 756d 5f64 6976 6973 696f 6e73     num_divisions
-00009920: 3d5b 3130 2c20 3130 5d2c 0a20 2020 206a  =[10, 10],.    j
-00009930: 6f69 6e5f 6669 7273 743d 5472 7565 2c0a  oin_first=True,.
-00009940: 2020 2020 7072 6563 6973 696f 6e3d 3165      precision=1e
-00009950: 2d34 2c0a 2020 2020 6a6f 696e 3d22 6d69  -4,.    join="mi
-00009960: 7465 7222 2c0a 2020 2020 746f 6c65 7261  ter",.    tolera
-00009970: 6e63 653d 322c 0a29 3a0a 2020 2020 2222  nce=2,.):.    ""
-00009980: 2250 6572 666f 726d 7320 7468 6520 6f66  "Performs the of
-00009990: 6673 6574 2066 756e 6374 696f 6e20 6f6e  fset function on
-000099a0: 2061 206c 6973 7420 6f66 2073 7562 7365   a list of subse
-000099b0: 6374 696f 6e73 206f 6620 7468 6520 6f72  ctions of the or
-000099c0: 6967 696e 616c 0a20 2020 2067 656f 6d65  iginal.    geome
-000099d0: 7472 790a 0a20 2020 2050 6172 616d 6574  try..    Paramet
-000099e0: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-000099f0: 2d2d 0a20 2020 2070 6f6c 7967 6f6e 7320  --.    polygons 
-00009a00: 3a20 506f 6c79 676f 6e53 6574 206f 7220  : PolygonSet or 
-00009a10: 6c69 7374 206f 6620 706f 6c79 676f 6e73  list of polygons
-00009a20: 0a0a 2020 2020 6469 7374 616e 6365 203a  ..    distance :
-00009a30: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
-00009a40: 2020 2020 2020 4469 7374 616e 6365 2074        Distance t
-00009a50: 6f20 6f66 6673 6574 2070 6f6c 7967 6f6e  o offset polygon
-00009a60: 732e 2050 6f73 6974 6976 6520 7661 6c75  s. Positive valu
-00009a70: 6573 2065 7870 616e 642c 206e 6567 6174  es expand, negat
-00009a80: 6976 6520 7368 7269 6e6b 2e0a 2020 2020  ive shrink..    
-00009a90: 6e75 6d5f 6469 7669 7369 6f6e 7320 3a20  num_divisions : 
-00009aa0: 6172 7261 792d 6c69 6b65 5b32 5d20 6f66  array-like[2] of
-00009ab0: 2069 6e74 0a20 2020 2020 2020 2054 6865   int.        The
-00009ac0: 206e 756d 6265 7220 6f66 2064 6976 6973   number of divis
-00009ad0: 696f 6e73 2077 6974 6820 7768 6963 6820  ions with which 
-00009ae0: 7468 6520 6765 6f6d 6574 7279 2069 7320  the geometry is 
-00009af0: 6469 7669 6465 6420 696e 746f 0a20 2020  divided into.   
-00009b00: 2020 2020 206d 756c 7469 706c 6520 7265       multiple re
-00009b10: 6374 616e 6775 6c61 7220 7265 6769 6f6e  ctangular region
-00009b20: 732e 2054 6869 7320 616c 6c6f 7773 2066  s. This allows f
-00009b30: 6f72 2065 6163 6820 7265 6769 6f6e 2074  or each region t
-00009b40: 6f20 6265 0a20 2020 2020 2020 2070 726f  o be.        pro
-00009b50: 6365 7373 6564 2073 6571 7565 6e74 6961  cessed sequentia
-00009b60: 6c6c 792c 2077 6869 6368 2069 7320 6d6f  lly, which is mo
-00009b70: 7265 2063 6f6d 7075 7461 7469 6f6e 616c  re computational
-00009b80: 6c79 2065 6666 6963 6965 6e74 2e0a 2020  ly efficient..  
-00009b90: 2020 6a6f 696e 5f66 6972 7374 203a 2062    join_first : b
-00009ba0: 6f6f 6c0a 2020 2020 2020 2020 4a6f 696e  ool.        Join
-00009bb0: 2061 6c6c 2070 6174 6873 2062 6566 6f72   all paths befor
-00009bc0: 6520 6f66 6673 6574 7469 6e67 2074 6f20  e offsetting to 
-00009bd0: 6176 6f69 6420 756e 6e65 6365 7373 6172  avoid unnecessar
-00009be0: 7920 6a6f 696e 7320 696e 0a20 2020 2020  y joins in.     
-00009bf0: 2020 2061 646a 6163 656e 7420 706f 6c79     adjacent poly
-00009c00: 676f 6e20 7369 6465 732e 0a20 2020 2070  gon sides..    p
-00009c10: 7265 6369 7369 6f6e 203a 2066 6c6f 6174  recision : float
-00009c20: 0a20 2020 2020 2020 2044 6573 6972 6564  .        Desired
-00009c30: 2070 7265 6369 7369 6f6e 2066 6f72 2072   precision for r
-00009c40: 6f75 6e64 696e 6720 7665 7274 6578 2063  ounding vertex c
-00009c50: 6f6f 7264 696e 6174 6573 2e0a 2020 2020  oordinates..    
-00009c60: 6a6f 696e 203a 207b 276d 6974 6572 272c  join : {'miter',
-00009c70: 2027 6265 7665 6c27 2c20 2772 6f75 6e64   'bevel', 'round
-00009c80: 277d 0a20 2020 2020 2020 2054 7970 6520  '}.        Type 
-00009c90: 6f66 206a 6f69 6e20 7573 6564 2074 6f20  of join used to 
-00009ca0: 6372 6561 7465 2074 6865 206f 6666 7365  create the offse
-00009cb0: 7420 706f 6c79 676f 6e2e 0a20 2020 2074  t polygon..    t
-00009cc0: 6f6c 6572 616e 6365 203a 2069 6e74 206f  olerance : int o
-00009cd0: 7220 666c 6f61 740a 2020 2020 2020 2020  r float.        
-00009ce0: 466f 7220 6d69 7465 7220 6a6f 696e 7473  For miter joints
-00009cf0: 2c20 7468 6973 206e 756d 6265 7220 6d75  , this number mu
-00009d00: 7374 2062 6520 6174 206c 6561 7374 2032  st be at least 2
-00009d10: 2061 6e64 2069 7420 7265 7072 6573 656e   and it represen
-00009d20: 7473 2074 6865 0a20 2020 2020 2020 206d  ts the.        m
-00009d30: 6178 696d 616c 2064 6973 7461 6e63 6520  aximal distance 
-00009d40: 696e 206d 756c 7469 706c 6573 206f 6620  in multiples of 
-00009d50: 6f66 6673 6574 2062 6574 7765 656e 206e  offset between n
-00009d60: 6577 2076 6572 7469 6365 7320 616e 6420  ew vertices and 
-00009d70: 7468 6569 720a 2020 2020 2020 2020 6f72  their.        or
-00009d80: 6967 696e 616c 2070 6f73 6974 696f 6e20  iginal position 
-00009d90: 6265 666f 7265 2062 6576 656c 696e 6720  before beveling 
-00009da0: 746f 2061 766f 6964 2073 7069 6b65 7320  to avoid spikes 
-00009db0: 6174 2061 6375 7465 206a 6f69 6e74 732e  at acute joints.
-00009dc0: 2046 6f72 0a20 2020 2020 2020 2072 6f75   For.        rou
-00009dd0: 6e64 206a 6f69 6e74 732c 2069 7420 696e  nd joints, it in
-00009de0: 6469 6361 7465 7320 7468 6520 6375 7276  dicates the curv
-00009df0: 6174 7572 6520 7265 736f 6c75 7469 6f6e  ature resolution
-00009e00: 2069 6e20 6e75 6d62 6572 206f 660a 2020   in number of.  
-00009e10: 2020 2020 2020 706f 696e 7473 2070 6572        points per
-00009e20: 2066 756c 6c20 6369 7263 6c65 2e0a 0a20   full circle... 
-00009e30: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
-00009e40: 2d2d 2d2d 2d2d 0a20 2020 206f 6666 7365  ------.    offse
-00009e50: 745f 706f 6c79 676f 6e73 203a 0a0a 2020  t_polygons :..  
-00009e60: 2020 2222 220a 2020 2020 2320 4275 696c    """.    # Buil
-00009e70: 6420 626f 756e 6469 6e67 2062 6f78 6573  d bounding boxes
-00009e80: 0a20 2020 2070 6f6c 7967 6f6e 7320 3d20  .    polygons = 
-00009e90: 6e70 2e61 7361 7272 6179 2870 6f6c 7967  np.asarray(polyg
-00009ea0: 6f6e 7329 0a20 2020 2062 626f 7865 7320  ons).    bboxes 
-00009eb0: 3d20 5f70 6f6c 7967 6f6e 735f 746f 5f62  = _polygons_to_b
-00009ec0: 626f 7865 7328 706f 6c79 676f 6e73 290a  boxes(polygons).
-00009ed0: 0a20 2020 2078 6d69 6e2c 2079 6d69 6e20  .    xmin, ymin 
-00009ee0: 3d20 6e70 2e6d 696e 2862 626f 7865 735b  = np.min(bboxes[
-00009ef0: 3a2c 2030 3a32 5d2c 2061 7869 733d 3029  :, 0:2], axis=0)
-00009f00: 202d 2064 6973 7461 6e63 650a 2020 2020   - distance.    
-00009f10: 786d 6178 2c20 796d 6178 203d 206e 702e  xmax, ymax = np.
-00009f20: 6d61 7828 6262 6f78 6573 5b3a 2c20 323a  max(bboxes[:, 2:
-00009f30: 345d 2c20 6178 6973 3d30 2920 2b20 6469  4], axis=0) + di
-00009f40: 7374 616e 6365 0a0a 2020 2020 7873 697a  stance..    xsiz
-00009f50: 6520 3d20 786d 6178 202d 2078 6d69 6e0a  e = xmax - xmin.
-00009f60: 2020 2020 7973 697a 6520 3d20 796d 6178      ysize = ymax
-00009f70: 202d 2079 6d69 6e0a 2020 2020 7864 656c   - ymin.    xdel
-00009f80: 7461 203d 2078 7369 7a65 202f 206e 756d  ta = xsize / num
-00009f90: 5f64 6976 6973 696f 6e73 5b30 5d0a 2020  _divisions[0].  
-00009fa0: 2020 7964 656c 7461 203d 2079 7369 7a65    ydelta = ysize
+00003020: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00003030: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00003040: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00003050: 3d3d 3d3d 3d0a 0a0a 6465 6620 6f66 6673  =====...def offs
+00003060: 6574 280a 2020 2020 656c 656d 656e 7473  et(.    elements
+00003070: 2c0a 2020 2020 6469 7374 616e 6365 3d30  ,.    distance=0
+00003080: 2e31 2c0a 2020 2020 6a6f 696e 5f66 6972  .1,.    join_fir
+00003090: 7374 3d54 7275 652c 0a20 2020 2070 7265  st=True,.    pre
+000030a0: 6369 7369 6f6e 3d31 652d 342c 0a20 2020  cision=1e-4,.   
+000030b0: 206e 756d 5f64 6976 6973 696f 6e73 3d5b   num_divisions=[
+000030c0: 312c 2031 5d2c 0a20 2020 206a 6f69 6e3d  1, 1],.    join=
+000030d0: 226d 6974 6572 222c 0a20 2020 2074 6f6c  "miter",.    tol
+000030e0: 6572 616e 6365 3d32 2c0a 2020 2020 6d61  erance=2,.    ma
+000030f0: 785f 706f 696e 7473 3d34 3030 302c 0a20  x_points=4000,. 
+00003100: 2020 206c 6179 6572 3d30 2c0a 293a 0a20     layer=0,.):. 
+00003110: 2020 2022 2222 5368 7269 6e6b 7320 6f72     """Shrinks or
+00003120: 2065 7870 616e 6473 2061 2070 6f6c 7967   expands a polyg
+00003130: 6f6e 206f 7220 7365 7420 6f66 2070 6f6c  on or set of pol
+00003140: 7967 6f6e 732e 0a0a 2020 2020 5061 7261  ygons...    Para
+00003150: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
+00003160: 2d2d 2d2d 2d0a 2020 2020 656c 656d 656e  -----.    elemen
+00003170: 7473 203a 2044 6576 6963 6528 2f52 6566  ts : Device(/Ref
+00003180: 6572 656e 6365 292c 206c 6973 7420 6f66  erence), list of
+00003190: 2044 6576 6963 6528 2f52 6566 6572 656e   Device(/Referen
+000031a0: 6365 292c 206f 7220 506f 6c79 676f 6e0a  ce), or Polygon.
+000031b0: 2020 2020 2020 2020 506f 6c79 676f 6e73          Polygons
+000031c0: 2074 6f20 6f66 6673 6574 206f 7220 4465   to offset or De
+000031d0: 7669 6365 2063 6f6e 7461 696e 696e 6720  vice containing 
+000031e0: 706f 6c79 676f 6e73 2074 6f20 6f66 6673  polygons to offs
+000031f0: 6574 2e0a 2020 2020 6469 7374 616e 6365  et..    distance
+00003200: 203a 2069 6e74 206f 7220 666c 6f61 740a   : int or float.
+00003210: 2020 2020 2020 2020 4469 7374 616e 6365          Distance
+00003220: 2074 6f20 6f66 6673 6574 2070 6f6c 7967   to offset polyg
+00003230: 6f6e 732e 2050 6f73 6974 6976 6520 7661  ons. Positive va
+00003240: 6c75 6573 2065 7870 616e 642c 206e 6567  lues expand, neg
+00003250: 6174 6976 6520 7368 7269 6e6b 2e0a 2020  ative shrink..  
+00003260: 2020 6a6f 696e 2066 6972 7374 3a20 626f    join first: bo
+00003270: 6f6c 0a20 2020 2020 2020 2053 6574 7320  ol.        Sets 
+00003280: 7768 6574 6865 7220 746f 206d 6572 6765  whether to merge
+00003290: 2061 6c6c 2074 6865 2070 6f6c 7967 6f6e   all the polygon
+000032a0: 7320 6265 666f 7265 2070 6572 666f 726d  s before perform
+000032b0: 696e 670a 2020 2020 2020 2020 7468 6520  ing.        the 
+000032c0: 6f66 6673 6574 206f 7065 7261 7469 6f6e  offset operation
+000032d0: 2c20 6f72 206f 6666 7365 7420 6561 6368  , or offset each
+000032e0: 2070 6f6c 7967 6f6e 2069 6e64 6976 6964   polygon individ
+000032f0: 7561 6c6c 790a 2020 2020 7072 6563 6973  ually.    precis
+00003300: 696f 6e20 3a20 666c 6f61 740a 2020 2020  ion : float.    
+00003310: 2020 2020 4465 7369 7265 6420 7072 6563      Desired prec
+00003320: 6973 696f 6e20 666f 7220 726f 756e 6469  ision for roundi
+00003330: 6e67 2076 6572 7465 7820 636f 6f72 6469  ng vertex coordi
+00003340: 6e61 7465 732e 0a20 2020 206e 756d 5f64  nates..    num_d
+00003350: 6976 6973 696f 6e73 203a 2061 7272 6179  ivisions : array
+00003360: 2d6c 696b 655b 325d 206f 6620 696e 740a  -like[2] of int.
+00003370: 2020 2020 2020 2020 5468 6520 6e75 6d62          The numb
+00003380: 6572 206f 6620 6469 7669 7369 6f6e 7320  er of divisions 
+00003390: 7769 7468 2077 6869 6368 2074 6865 2067  with which the g
+000033a0: 656f 6d65 7472 7920 6973 2064 6976 6964  eometry is divid
+000033b0: 6564 2069 6e74 6f0a 2020 2020 2020 2020  ed into.        
+000033c0: 6d75 6c74 6970 6c65 2072 6563 7461 6e67  multiple rectang
+000033d0: 756c 6172 2072 6567 696f 6e73 2e20 5468  ular regions. Th
+000033e0: 6973 2061 6c6c 6f77 7320 666f 7220 6561  is allows for ea
+000033f0: 6368 2072 6567 696f 6e20 746f 2062 650a  ch region to be.
+00003400: 2020 2020 2020 2020 7072 6f63 6573 7365          processe
+00003410: 6420 7365 7175 656e 7469 616c 6c79 2c20  d sequentially, 
+00003420: 7768 6963 6820 6973 206d 6f72 6520 636f  which is more co
+00003430: 6d70 7574 6174 696f 6e61 6c6c 7920 6566  mputationally ef
+00003440: 6669 6369 656e 742e 0a20 2020 206a 6f69  ficient..    joi
+00003450: 6e20 3a20 7b27 6d69 7465 7227 2c20 2762  n : {'miter', 'b
+00003460: 6576 656c 272c 2027 726f 756e 6427 7d0a  evel', 'round'}.
+00003470: 2020 2020 2020 2020 5479 7065 206f 6620          Type of 
+00003480: 6a6f 696e 2075 7365 6420 746f 2063 7265  join used to cre
+00003490: 6174 6520 7468 6520 6f66 6673 6574 2070  ate the offset p
+000034a0: 6f6c 7967 6f6e 2e0a 2020 2020 746f 6c65  olygon..    tole
+000034b0: 7261 6e63 6520 3a20 696e 7420 6f72 2066  rance : int or f
+000034c0: 6c6f 6174 0a20 2020 2020 2020 2046 6f72  loat.        For
+000034d0: 206d 6974 6572 206a 6f69 6e74 732c 2074   miter joints, t
+000034e0: 6869 7320 6e75 6d62 6572 206d 7573 7420  his number must 
+000034f0: 6265 2061 7420 6c65 6173 7420 3220 616e  be at least 2 an
+00003500: 6420 6974 2072 6570 7265 7365 6e74 7320  d it represents 
+00003510: 7468 650a 2020 2020 2020 2020 6d61 7869  the.        maxi
+00003520: 6d61 6c20 6469 7374 616e 6365 2069 6e20  mal distance in 
+00003530: 6d75 6c74 6970 6c65 7320 6f66 206f 6666  multiples of off
+00003540: 7365 7420 6265 7477 6565 6e20 6e65 7720  set between new 
+00003550: 7665 7274 6963 6573 2061 6e64 2074 6865  vertices and the
+00003560: 6972 0a20 2020 2020 2020 206f 7269 6769  ir.        origi
+00003570: 6e61 6c20 706f 7369 7469 6f6e 2062 6566  nal position bef
+00003580: 6f72 6520 6265 7665 6c69 6e67 2074 6f20  ore beveling to 
+00003590: 6176 6f69 6420 7370 696b 6573 2061 7420  avoid spikes at 
+000035a0: 6163 7574 6520 6a6f 696e 7473 2e20 466f  acute joints. Fo
+000035b0: 720a 2020 2020 2020 2020 726f 756e 6420  r.        round 
+000035c0: 6a6f 696e 7473 2c20 6974 2069 6e64 6963  joints, it indic
+000035d0: 6174 6573 2074 6865 2063 7572 7661 7475  ates the curvatu
+000035e0: 7265 2072 6573 6f6c 7574 696f 6e20 696e  re resolution in
+000035f0: 206e 756d 6265 7220 6f66 0a20 2020 2020   number of.     
+00003600: 2020 2070 6f69 6e74 7320 7065 7220 6675     points per fu
+00003610: 6c6c 2063 6972 636c 652e 0a20 2020 206d  ll circle..    m
+00003620: 6178 5f70 6f69 6e74 7320 3a20 696e 740a  ax_points : int.
+00003630: 2020 2020 2020 2020 5468 6520 6d61 7869          The maxi
+00003640: 6d75 6d20 6e75 6d62 6572 206f 6620 7665  mum number of ve
+00003650: 7274 6963 6573 2077 6974 6869 6e20 7468  rtices within th
+00003660: 6520 7265 7375 6c74 696e 6720 706f 6c79  e resulting poly
+00003670: 676f 6e2e 0a20 2020 206c 6179 6572 203a  gon..    layer :
+00003680: 2069 6e74 2c20 6172 7261 792d 6c69 6b65   int, array-like
+00003690: 5b32 5d2c 206f 7220 7365 740a 2020 2020  [2], or set.    
+000036a0: 2020 2020 5370 6563 6966 6963 206c 6179      Specific lay
+000036b0: 6572 2873 2920 746f 2070 7574 2070 6f6c  er(s) to put pol
+000036c0: 7967 6f6e 2067 656f 6d65 7472 7920 6f6e  ygon geometry on
+000036d0: 2e0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
+000036e0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2044     -------.    D
+000036f0: 203a 2044 6576 6963 650a 2020 2020 2020   : Device.      
+00003700: 2020 4120 4465 7669 6365 2063 6f6e 7461    A Device conta
+00003710: 696e 696e 6720 6120 706f 6c79 676f 6e28  ining a polygon(
+00003720: 7329 2077 6974 6820 7468 6520 7370 6563  s) with the spec
+00003730: 6966 6965 6420 6f66 6673 6574 2061 7070  ified offset app
+00003740: 6c69 6564 2e0a 2020 2020 2222 220a 2020  lied..    """.  
+00003750: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
+00003760: 6e63 6528 656c 656d 656e 7473 2c20 6c69  nce(elements, li
+00003770: 7374 293a 0a20 2020 2020 2020 2065 6c65  st):.        ele
+00003780: 6d65 6e74 7320 3d20 5b65 6c65 6d65 6e74  ments = [element
+00003790: 735d 0a20 2020 2070 6f6c 7967 6f6e 735f  s].    polygons_
+000037a0: 746f 5f6f 6666 7365 7420 3d20 5b5d 0a20  to_offset = []. 
+000037b0: 2020 2066 6f72 2065 2069 6e20 656c 656d     for e in elem
+000037c0: 656e 7473 3a0a 2020 2020 2020 2020 6966  ents:.        if
+000037d0: 2069 7369 6e73 7461 6e63 6528 652c 2028   isinstance(e, (
+000037e0: 4465 7669 6365 2c20 4465 7669 6365 5265  Device, DeviceRe
+000037f0: 6665 7265 6e63 6529 293a 0a20 2020 2020  ference)):.     
+00003800: 2020 2020 2020 2070 6f6c 7967 6f6e 735f         polygons_
+00003810: 746f 5f6f 6666 7365 7420 2b3d 2065 2e67  to_offset += e.g
+00003820: 6574 5f70 6f6c 7967 6f6e 7328 6279 5f73  et_polygons(by_s
+00003830: 7065 633d 4661 6c73 6529 0a20 2020 2020  pec=False).     
+00003840: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+00003850: 6365 2865 2c20 2850 6f6c 7967 6f6e 2c20  ce(e, (Polygon, 
+00003860: 6764 7370 792e 506f 6c79 676f 6e29 293a  gdspy.Polygon)):
+00003870: 0a20 2020 2020 2020 2020 2020 2070 6f6c  .            pol
+00003880: 7967 6f6e 735f 746f 5f6f 6666 7365 742e  ygons_to_offset.
+00003890: 6170 7065 6e64 2865 290a 2020 2020 6966  append(e).    if
+000038a0: 206c 656e 2870 6f6c 7967 6f6e 735f 746f   len(polygons_to
+000038b0: 5f6f 6666 7365 7429 203d 3d20 303a 0a20  _offset) == 0:. 
+000038c0: 2020 2020 2020 2072 6574 7572 6e20 4465         return De
+000038d0: 7669 6365 2822 6f66 6673 6574 2229 0a0a  vice("offset")..
+000038e0: 2020 2020 706f 6c79 676f 6e73 5f74 6f5f      polygons_to_
+000038f0: 6f66 6673 6574 203d 205f 6d65 7267 655f  offset = _merge_
+00003900: 666c 6f61 7469 6e67 5f70 6f69 6e74 5f65  floating_point_e
+00003910: 7272 6f72 7328 0a20 2020 2020 2020 2070  rrors(.        p
+00003920: 6f6c 7967 6f6e 735f 746f 5f6f 6666 7365  olygons_to_offse
+00003930: 742c 2074 6f6c 3d70 7265 6369 7369 6f6e  t, tol=precision
+00003940: 202f 2031 3030 300a 2020 2020 290a 2020   / 1000.    ).  
+00003950: 2020 6764 735f 6c61 7965 722c 2067 6473    gds_layer, gds
+00003960: 5f64 6174 6174 7970 6520 3d20 5f70 6172  _datatype = _par
+00003970: 7365 5f6c 6179 6572 286c 6179 6572 290a  se_layer(layer).
+00003980: 2020 2020 6966 2061 6c6c 286e 702e 6172      if all(np.ar
+00003990: 7261 7928 6e75 6d5f 6469 7669 7369 6f6e  ray(num_division
+000039a0: 7329 203d 3d20 6e70 2e61 7272 6179 285b  s) == np.array([
+000039b0: 312c 2031 5d29 293a 0a20 2020 2020 2020  1, 1])):.       
+000039c0: 2070 203d 2067 6473 7079 2e6f 6666 7365   p = gdspy.offse
+000039d0: 7428 0a20 2020 2020 2020 2020 2020 2070  t(.            p
+000039e0: 6f6c 7967 6f6e 735f 746f 5f6f 6666 7365  olygons_to_offse
+000039f0: 742c 0a20 2020 2020 2020 2020 2020 2064  t,.            d
+00003a00: 6973 7461 6e63 653d 6469 7374 616e 6365  istance=distance
+00003a10: 2c0a 2020 2020 2020 2020 2020 2020 6a6f  ,.            jo
+00003a20: 696e 3d6a 6f69 6e2c 0a20 2020 2020 2020  in=join,.       
+00003a30: 2020 2020 2074 6f6c 6572 616e 6365 3d74       tolerance=t
+00003a40: 6f6c 6572 616e 6365 2c0a 2020 2020 2020  olerance,.      
+00003a50: 2020 2020 2020 7072 6563 6973 696f 6e3d        precision=
+00003a60: 7072 6563 6973 696f 6e2c 0a20 2020 2020  precision,.     
+00003a70: 2020 2020 2020 206a 6f69 6e5f 6669 7273         join_firs
+00003a80: 743d 6a6f 696e 5f66 6972 7374 2c0a 2020  t=join_first,.  
+00003a90: 2020 2020 2020 2020 2020 6d61 785f 706f            max_po
+00003aa0: 696e 7473 3d6d 6178 5f70 6f69 6e74 732c  ints=max_points,
+00003ab0: 0a20 2020 2020 2020 2020 2020 206c 6179  .            lay
+00003ac0: 6572 3d67 6473 5f6c 6179 6572 2c0a 2020  er=gds_layer,.  
+00003ad0: 2020 2020 2020 2020 2020 6461 7461 7479            dataty
+00003ae0: 7065 3d67 6473 5f64 6174 6174 7970 652c  pe=gds_datatype,
+00003af0: 0a20 2020 2020 2020 2029 0a20 2020 2065  .        ).    e
+00003b00: 6c73 653a 0a20 2020 2020 2020 2070 203d  lse:.        p =
+00003b10: 205f 6f66 6673 6574 5f70 6f6c 7967 6f6e   _offset_polygon
+00003b20: 735f 7061 7261 6c6c 656c 280a 2020 2020  s_parallel(.    
+00003b30: 2020 2020 2020 2020 706f 6c79 676f 6e73          polygons
+00003b40: 5f74 6f5f 6f66 6673 6574 2c0a 2020 2020  _to_offset,.    
+00003b50: 2020 2020 2020 2020 6469 7374 616e 6365          distance
+00003b60: 3d64 6973 7461 6e63 652c 0a20 2020 2020  =distance,.     
+00003b70: 2020 2020 2020 206e 756d 5f64 6976 6973         num_divis
+00003b80: 696f 6e73 3d6e 756d 5f64 6976 6973 696f  ions=num_divisio
+00003b90: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+00003ba0: 6a6f 696e 5f66 6972 7374 3d6a 6f69 6e5f  join_first=join_
+00003bb0: 6669 7273 742c 0a20 2020 2020 2020 2020  first,.         
+00003bc0: 2020 2070 7265 6369 7369 6f6e 3d70 7265     precision=pre
+00003bd0: 6369 7369 6f6e 2c0a 2020 2020 2020 2020  cision,.        
+00003be0: 2020 2020 6a6f 696e 3d6a 6f69 6e2c 0a20      join=join,. 
+00003bf0: 2020 2020 2020 2020 2020 2074 6f6c 6572             toler
+00003c00: 616e 6365 3d74 6f6c 6572 616e 6365 2c0a  ance=tolerance,.
+00003c10: 2020 2020 2020 2020 290a 0a20 2020 2044          )..    D
+00003c20: 203d 2044 6576 6963 6528 226f 6666 7365   = Device("offse
+00003c30: 7422 290a 2020 2020 706f 6c79 676f 6e73  t").    polygons
+00003c40: 203d 2044 2e61 6464 5f70 6f6c 7967 6f6e   = D.add_polygon
+00003c50: 2870 2c20 6c61 7965 723d 6c61 7965 7229  (p, layer=layer)
+00003c60: 0a20 2020 205b 0a20 2020 2020 2020 2070  .    [.        p
+00003c70: 6f6c 7967 6f6e 2e66 7261 6374 7572 6528  olygon.fracture(
+00003c80: 6d61 785f 706f 696e 7473 3d6d 6178 5f70  max_points=max_p
+00003c90: 6f69 6e74 732c 2070 7265 6369 7369 6f6e  oints, precision
+00003ca0: 3d70 7265 6369 7369 6f6e 290a 2020 2020  =precision).    
+00003cb0: 2020 2020 666f 7220 706f 6c79 676f 6e20      for polygon 
+00003cc0: 696e 2070 6f6c 7967 6f6e 730a 2020 2020  in polygons.    
+00003cd0: 5d0a 2020 2020 7265 7475 726e 2044 0a0a  ].    return D..
+00003ce0: 0a64 6566 2062 6f6f 6c65 616e 2820 2023  .def boolean(  #
+00003cf0: 206e 6f71 613a 2043 3930 310a 2020 2020   noqa: C901.    
+00003d00: 412c 2042 2c20 6f70 6572 6174 696f 6e2c  A, B, operation,
+00003d10: 2070 7265 6369 7369 6f6e 3d31 652d 342c   precision=1e-4,
+00003d20: 206e 756d 5f64 6976 6973 696f 6e73 3d5b   num_divisions=[
+00003d30: 312c 2031 5d2c 206d 6178 5f70 6f69 6e74  1, 1], max_point
+00003d40: 733d 3430 3030 2c20 6c61 7965 723d 300a  s=4000, layer=0.
+00003d50: 293a 0a20 2020 2022 2222 5065 7266 6f72  ):.    """Perfor
+00003d60: 6d73 2062 6f6f 6c65 616e 206f 7065 7261  ms boolean opera
+00003d70: 7469 6f6e 7320 6265 7477 6565 6e20 3220  tions between 2 
+00003d80: 4465 7669 6365 2f44 6576 6963 6552 6566  Device/DeviceRef
+00003d90: 6572 656e 6365 206f 626a 6563 7473 0a20  erence objects. 
+00003da0: 2020 206f 7220 6c69 7374 7320 6f66 2044     or lists of D
+00003db0: 6576 6963 6573 2f44 6576 6963 6552 6566  evices/DeviceRef
+00003dc0: 6572 656e 6365 732e 0a0a 2020 2020 5061  erences...    Pa
+00003dd0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00003de0: 2d2d 2d2d 2d2d 2d0a 2020 2020 4120 3a20  -------.    A : 
+00003df0: 4465 7669 6365 282f 5265 6665 7265 6e63  Device(/Referenc
+00003e00: 6529 206f 7220 6c69 7374 206f 6620 4465  e) or list of De
+00003e10: 7669 6365 282f 5265 6665 7265 6e63 6529  vice(/Reference)
+00003e20: 206f 7220 506f 6c79 676f 6e0a 2020 2020   or Polygon.    
+00003e30: 2020 2020 496e 7075 7420 4465 7669 6365      Input Device
+00003e40: 732e 0a20 2020 2042 203a 2044 6576 6963  s..    B : Devic
+00003e50: 6528 2f52 6566 6572 656e 6365 2920 6f72  e(/Reference) or
+00003e60: 206c 6973 7420 6f66 2044 6576 6963 6528   list of Device(
+00003e70: 2f52 6566 6572 656e 6365 2920 6f72 2050  /Reference) or P
+00003e80: 6f6c 7967 6f6e 0a20 2020 2020 2020 2049  olygon.        I
+00003e90: 6e70 7574 2044 6576 6963 6573 2e0a 2020  nput Devices..  
+00003ea0: 2020 6f70 6572 6174 696f 6e20 3a20 7b27    operation : {'
+00003eb0: 6e6f 7427 2c20 2761 6e64 272c 2027 6f72  not', 'and', 'or
+00003ec0: 272c 2027 786f 7227 2c20 2741 2d42 272c  ', 'xor', 'A-B',
+00003ed0: 2027 422d 4127 2c20 2741 2b42 277d 0a20   'B-A', 'A+B'}. 
+00003ee0: 2020 2020 2020 2042 6f6f 6c65 616e 206f         Boolean o
+00003ef0: 7065 7261 7469 6f6e 2074 6f20 7065 7266  peration to perf
+00003f00: 6f72 6d2e 0a20 2020 2070 7265 6369 7369  orm..    precisi
+00003f10: 6f6e 203a 2066 6c6f 6174 0a20 2020 2020  on : float.     
+00003f20: 2020 2044 6573 6972 6564 2070 7265 6369     Desired preci
+00003f30: 7369 6f6e 2066 6f72 2072 6f75 6e64 696e  sion for roundin
+00003f40: 6720 7665 7274 6578 2063 6f6f 7264 696e  g vertex coordin
+00003f50: 6174 6573 2e0a 2020 2020 6e75 6d5f 6469  ates..    num_di
+00003f60: 7669 7369 6f6e 7320 3a20 6172 7261 792d  visions : array-
+00003f70: 6c69 6b65 5b32 5d20 6f66 2069 6e74 0a20  like[2] of int. 
+00003f80: 2020 2020 2020 2054 6865 206e 756d 6265         The numbe
+00003f90: 7220 6f66 2064 6976 6973 696f 6e73 2077  r of divisions w
+00003fa0: 6974 6820 7768 6963 6820 7468 6520 6765  ith which the ge
+00003fb0: 6f6d 6574 7279 2069 7320 6469 7669 6465  ometry is divide
+00003fc0: 6420 696e 746f 0a20 2020 2020 2020 206d  d into.        m
+00003fd0: 756c 7469 706c 6520 7265 6374 616e 6775  ultiple rectangu
+00003fe0: 6c61 7220 7265 6769 6f6e 732e 2054 6869  lar regions. Thi
+00003ff0: 7320 616c 6c6f 7773 2066 6f72 2065 6163  s allows for eac
+00004000: 6820 7265 6769 6f6e 2074 6f20 6265 0a20  h region to be. 
+00004010: 2020 2020 2020 2070 726f 6365 7373 6564         processed
+00004020: 2073 6571 7565 6e74 6961 6c6c 792c 2077   sequentially, w
+00004030: 6869 6368 2069 7320 6d6f 7265 2063 6f6d  hich is more com
+00004040: 7075 7461 7469 6f6e 616c 6c79 2065 6666  putationally eff
+00004050: 6963 6965 6e74 2e0a 2020 2020 6d61 785f  icient..    max_
+00004060: 706f 696e 7473 203a 2069 6e74 0a20 2020  points : int.   
+00004070: 2020 2020 2054 6865 206d 6178 696d 756d       The maximum
+00004080: 206e 756d 6265 7220 6f66 2076 6572 7469   number of verti
+00004090: 6365 7320 7769 7468 696e 2074 6865 2072  ces within the r
+000040a0: 6573 756c 7469 6e67 2070 6f6c 7967 6f6e  esulting polygon
+000040b0: 2e0a 2020 2020 6c61 7965 7220 3a20 696e  ..    layer : in
+000040c0: 742c 2061 7272 6179 2d6c 696b 655b 325d  t, array-like[2]
+000040d0: 2c20 6f72 2073 6574 0a20 2020 2020 2020  , or set.       
+000040e0: 2053 7065 6369 6669 6320 6c61 7965 7228   Specific layer(
+000040f0: 7329 2074 6f20 7075 7420 706f 6c79 676f  s) to put polygo
+00004100: 6e20 6765 6f6d 6574 7279 206f 6e2e 0a0a  n geometry on...
+00004110: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00004120: 2d2d 2d2d 2d2d 2d0a 2020 2020 443a 2044  -------.    D: D
+00004130: 6576 6963 650a 2020 2020 2020 2020 4120  evice.        A 
+00004140: 4465 7669 6365 2063 6f6e 7461 696e 696e  Device containin
+00004150: 6720 6120 706f 6c79 676f 6e28 7329 2077  g a polygon(s) w
+00004160: 6974 6820 7468 6520 626f 6f6c 6561 6e20  ith the boolean 
+00004170: 6f70 6572 6174 696f 6e73 2062 6574 7765  operations betwe
+00004180: 656e 0a20 2020 2020 2020 2074 6865 2032  en.        the 2
+00004190: 2069 6e70 7574 2044 6576 6963 6573 2070   input Devices p
+000041a0: 6572 666f 726d 6564 2e0a 0a20 2020 204e  erformed...    N
+000041b0: 6f74 6573 0a20 2020 202d 2d2d 2d2d 0a20  otes.    -----. 
+000041c0: 2020 2027 412b 4227 2069 7320 6571 7569     'A+B' is equi
+000041d0: 7661 6c65 6e74 2074 6f20 276f 7227 2e0a  valent to 'or'..
+000041e0: 2020 2020 2741 2d42 2720 6973 2065 7175      'A-B' is equ
+000041f0: 6976 616c 656e 7420 746f 2027 6e6f 7427  ivalent to 'not'
+00004200: 2e0a 2020 2020 2742 2d41 2720 6973 2065  ..    'B-A' is e
+00004210: 7175 6976 616c 656e 7420 746f 2027 6e6f  quivalent to 'no
+00004220: 7427 2077 6974 6820 7468 6520 6f70 6572  t' with the oper
+00004230: 616e 6473 2073 7769 7463 6865 642e 0a20  ands switched.. 
+00004240: 2020 2022 2222 0a20 2020 2044 203d 2044     """.    D = D
+00004250: 6576 6963 6528 2262 6f6f 6c65 616e 2229  evice("boolean")
+00004260: 0a0a 2020 2020 415f 706f 6c79 7320 3d20  ..    A_polys = 
+00004270: 5b5d 0a20 2020 2042 5f70 6f6c 7973 203d  [].    B_polys =
+00004280: 205b 5d0a 2020 2020 6966 206e 6f74 2069   [].    if not i
+00004290: 7369 6e73 7461 6e63 6528 412c 206c 6973  sinstance(A, lis
+000042a0: 7429 3a0a 2020 2020 2020 2020 4120 3d20  t):.        A = 
+000042b0: 5b41 5d0a 2020 2020 6966 206e 6f74 2069  [A].    if not i
+000042c0: 7369 6e73 7461 6e63 6528 422c 206c 6973  sinstance(B, lis
+000042d0: 7429 3a0a 2020 2020 2020 2020 4220 3d20  t):.        B = 
+000042e0: 5b42 5d0a 0a20 2020 2066 6f72 2058 2c20  [B]..    for X, 
+000042f0: 706f 6c79 7320 696e 2028 2841 2c20 415f  polys in ((A, A_
+00004300: 706f 6c79 7329 2c20 2842 2c20 425f 706f  polys), (B, B_po
+00004310: 6c79 7329 293a 0a20 2020 2020 2020 2066  lys)):.        f
+00004320: 6f72 2065 2069 6e20 583a 0a20 2020 2020  or e in X:.     
+00004330: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00004340: 616e 6365 2865 2c20 2844 6576 6963 652c  ance(e, (Device,
+00004350: 2044 6576 6963 6552 6566 6572 656e 6365   DeviceReference
+00004360: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00004370: 2020 2020 706f 6c79 732e 6578 7465 6e64      polys.extend
+00004380: 2865 2e67 6574 5f70 6f6c 7967 6f6e 7328  (e.get_polygons(
+00004390: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
+000043a0: 6c69 6620 6973 696e 7374 616e 6365 2865  lif isinstance(e
+000043b0: 2c20 506f 6c79 676f 6e29 3a0a 2020 2020  , Polygon):.    
+000043c0: 2020 2020 2020 2020 2020 2020 706f 6c79              poly
+000043d0: 732e 6578 7465 6e64 2865 2e70 6f6c 7967  s.extend(e.polyg
+000043e0: 6f6e 7329 0a0a 2020 2020 6764 735f 6c61  ons)..    gds_la
+000043f0: 7965 722c 2067 6473 5f64 6174 6174 7970  yer, gds_datatyp
+00004400: 6520 3d20 5f70 6172 7365 5f6c 6179 6572  e = _parse_layer
+00004410: 286c 6179 6572 290a 0a20 2020 206f 7065  (layer)..    ope
+00004420: 7261 7469 6f6e 203d 206f 7065 7261 7469  ration = operati
+00004430: 6f6e 2e6c 6f77 6572 2829 2e72 6570 6c61  on.lower().repla
+00004440: 6365 2822 2022 2c20 2222 290a 2020 2020  ce(" ", "").    
+00004450: 6966 206f 7065 7261 7469 6f6e 203d 3d20  if operation == 
+00004460: 2261 2d62 223a 0a20 2020 2020 2020 206f  "a-b":.        o
+00004470: 7065 7261 7469 6f6e 203d 2022 6e6f 7422  peration = "not"
+00004480: 0a20 2020 2065 6c69 6620 6f70 6572 6174  .    elif operat
+00004490: 696f 6e20 3d3d 2022 622d 6122 3a0a 2020  ion == "b-a":.  
+000044a0: 2020 2020 2020 6f70 6572 6174 696f 6e20        operation 
+000044b0: 3d20 226e 6f74 220a 2020 2020 2020 2020  = "not".        
+000044c0: 415f 706f 6c79 732c 2042 5f70 6f6c 7973  A_polys, B_polys
+000044d0: 203d 2042 5f70 6f6c 7973 2c20 415f 706f   = B_polys, A_po
+000044e0: 6c79 730a 2020 2020 656c 6966 206f 7065  lys.    elif ope
+000044f0: 7261 7469 6f6e 203d 3d20 2261 2b62 223a  ration == "a+b":
+00004500: 0a20 2020 2020 2020 206f 7065 7261 7469  .        operati
+00004510: 6f6e 203d 2022 6f72 220a 2020 2020 656c  on = "or".    el
+00004520: 6966 206f 7065 7261 7469 6f6e 206e 6f74  if operation not
+00004530: 2069 6e20 5b22 6e6f 7422 2c20 2261 6e64   in ["not", "and
+00004540: 222c 2022 6f72 222c 2022 786f 7222 2c20  ", "or", "xor", 
+00004550: 2261 2d62 222c 2022 622d 6122 2c20 2261  "a-b", "b-a", "a
+00004560: 2b62 225d 3a0a 2020 2020 2020 2020 7261  +b"]:.        ra
+00004570: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
+00004580: 2020 2020 2020 2020 2020 2020 225b 5048              "[PH
+00004590: 4944 4c5d 2070 6869 646c 2e67 656f 6d65  IDL] phidl.geome
+000045a0: 7472 792e 626f 6f6c 6561 6e28 2920 606f  try.boolean() `o
+000045b0: 7065 7261 7469 6f6e 6020 220a 2020 2020  peration` ".    
+000045c0: 2020 2020 2020 2020 2270 6172 616d 6574          "paramet
+000045d0: 6572 206e 6f74 2072 6563 6f67 6e69 7a65  er not recognize
+000045e0: 642c 206d 7573 7420 6265 206f 6e65 206f  d, must be one o
+000045f0: 6620 7468 6520 220a 2020 2020 2020 2020  f the ".        
+00004600: 2020 2020 2266 6f6c 6c6f 7769 6e67 3a20      "following: 
+00004610: 2027 6e6f 7427 2c20 2761 6e64 272c 2027   'not', 'and', '
+00004620: 6f72 272c 2027 786f 7227 2c20 2741 2d42  or', 'xor', 'A-B
+00004630: 272c 2022 0a20 2020 2020 2020 2020 2020  ', ".           
+00004640: 2022 2742 2d41 272c 2027 412b 4227 220a   "'B-A', 'A+B'".
+00004650: 2020 2020 2020 2020 290a 0a20 2020 2023          )..    #
+00004660: 2043 6865 636b 2066 6f72 2074 7269 7669   Check for trivi
+00004670: 616c 2073 6f6c 7574 696f 6e73 0a20 2020  al solutions.   
+00004680: 2069 6620 2828 6c65 6e28 415f 706f 6c79   if ((len(A_poly
+00004690: 7329 203d 3d20 3029 206f 7220 286c 656e  s) == 0) or (len
+000046a0: 2842 5f70 6f6c 7973 2920 3d3d 2030 2929  (B_polys) == 0))
+000046b0: 2061 6e64 2028 6f70 6572 6174 696f 6e20   and (operation 
+000046c0: 213d 2022 6f72 2229 3a0a 2020 2020 2020  != "or"):.      
+000046d0: 2020 6966 206f 7065 7261 7469 6f6e 203d    if operation =
+000046e0: 3d20 226e 6f74 223a 0a20 2020 2020 2020  = "not":.       
+000046f0: 2020 2020 2069 6620 6c65 6e28 415f 706f       if len(A_po
+00004700: 6c79 7329 203d 3d20 303a 0a20 2020 2020  lys) == 0:.     
+00004710: 2020 2020 2020 2020 2020 2070 203d 204e             p = N
+00004720: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00004730: 656c 6966 206c 656e 2842 5f70 6f6c 7973  elif len(B_polys
+00004740: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
+00004750: 2020 2020 2020 2020 7020 3d20 415f 706f          p = A_po
+00004760: 6c79 730a 2020 2020 2020 2020 656c 6966  lys.        elif
+00004770: 206f 7065 7261 7469 6f6e 203d 3d20 2261   operation == "a
+00004780: 6e64 223a 0a20 2020 2020 2020 2020 2020  nd":.           
+00004790: 2070 203d 204e 6f6e 650a 2020 2020 2020   p = None.      
+000047a0: 2020 656c 6966 206f 7065 7261 7469 6f6e    elif operation
+000047b0: 203d 3d20 2278 6f72 223a 0a20 2020 2020   == "xor":.     
+000047c0: 2020 2020 2020 2069 6620 286c 656e 2841         if (len(A
+000047d0: 5f70 6f6c 7973 2920 3d3d 2030 2920 616e  _polys) == 0) an
+000047e0: 6420 286c 656e 2842 5f70 6f6c 7973 2920  d (len(B_polys) 
+000047f0: 3d3d 2030 293a 0a20 2020 2020 2020 2020  == 0):.         
+00004800: 2020 2020 2020 2070 203d 204e 6f6e 650a         p = None.
+00004810: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00004820: 206c 656e 2841 5f70 6f6c 7973 2920 3d3d   len(A_polys) ==
+00004830: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00004840: 2020 2020 7020 3d20 425f 706f 6c79 730a      p = B_polys.
+00004850: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00004860: 206c 656e 2842 5f70 6f6c 7973 2920 3d3d   len(B_polys) ==
+00004870: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00004880: 2020 2020 7020 3d20 415f 706f 6c79 730a      p = A_polys.
+00004890: 2020 2020 656c 6966 2028 6c65 6e28 415f      elif (len(A_
+000048a0: 706f 6c79 7329 203d 3d20 3029 2061 6e64  polys) == 0) and
+000048b0: 2028 6c65 6e28 425f 706f 6c79 7329 203d   (len(B_polys) =
+000048c0: 3d20 3029 2061 6e64 2028 6f70 6572 6174  = 0) and (operat
+000048d0: 696f 6e20 3d3d 2022 6f72 2229 3a0a 2020  ion == "or"):.  
+000048e0: 2020 2020 2020 7020 3d20 4e6f 6e65 0a20        p = None. 
+000048f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00004900: 2023 2049 6620 6e6f 2074 7269 7669 616c   # If no trivial
+00004910: 2073 6f6c 7574 696f 6e73 2c20 7275 6e20   solutions, run 
+00004920: 626f 6f6c 6561 6e20 6f70 6572 6174 696f  boolean operatio
+00004930: 6e20 6569 7468 6572 2069 6e20 7061 7261  n either in para
+00004940: 6c6c 656c 206f 720a 2020 2020 2020 2020  llel or.        
+00004950: 2320 7374 7261 6967 6874 0a20 2020 2020  # straight.     
+00004960: 2020 2069 6620 616c 6c28 6e70 2e61 7272     if all(np.arr
+00004970: 6179 286e 756d 5f64 6976 6973 696f 6e73  ay(num_divisions
+00004980: 2920 3d3d 206e 702e 6172 7261 7928 5b31  ) == np.array([1
+00004990: 2c20 315d 2929 3a0a 2020 2020 2020 2020  , 1])):.        
+000049a0: 2020 2020 7020 3d20 6764 7370 792e 626f      p = gdspy.bo
+000049b0: 6f6c 6561 6e28 0a20 2020 2020 2020 2020  olean(.         
+000049c0: 2020 2020 2020 206f 7065 7261 6e64 313d         operand1=
+000049d0: 415f 706f 6c79 732c 0a20 2020 2020 2020  A_polys,.       
+000049e0: 2020 2020 2020 2020 206f 7065 7261 6e64           operand
+000049f0: 323d 425f 706f 6c79 732c 0a20 2020 2020  2=B_polys,.     
+00004a00: 2020 2020 2020 2020 2020 206f 7065 7261             opera
+00004a10: 7469 6f6e 3d6f 7065 7261 7469 6f6e 2c0a  tion=operation,.
+00004a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004a30: 7072 6563 6973 696f 6e3d 7072 6563 6973  precision=precis
+00004a40: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
+00004a50: 2020 2020 206d 6178 5f70 6f69 6e74 733d       max_points=
+00004a60: 6d61 785f 706f 696e 7473 2c0a 2020 2020  max_points,.    
+00004a70: 2020 2020 2020 2020 2020 2020 6c61 7965              laye
+00004a80: 723d 6764 735f 6c61 7965 722c 0a20 2020  r=gds_layer,.   
+00004a90: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+00004aa0: 6174 7970 653d 6764 735f 6461 7461 7479  atype=gds_dataty
+00004ab0: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
+00004ac0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00004ad0: 2020 2020 2020 2020 2020 2020 7020 3d20              p = 
+00004ae0: 5f62 6f6f 6c65 616e 5f70 6f6c 7967 6f6e  _boolean_polygon
+00004af0: 735f 7061 7261 6c6c 656c 280a 2020 2020  s_parallel(.    
+00004b00: 2020 2020 2020 2020 2020 2020 706f 6c79              poly
+00004b10: 676f 6e73 5f41 3d41 5f70 6f6c 7973 2c0a  gons_A=A_polys,.
+00004b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b30: 706f 6c79 676f 6e73 5f42 3d42 5f70 6f6c  polygons_B=B_pol
+00004b40: 7973 2c0a 2020 2020 2020 2020 2020 2020  ys,.            
+00004b50: 2020 2020 6e75 6d5f 6469 7669 7369 6f6e      num_division
+00004b60: 733d 6e75 6d5f 6469 7669 7369 6f6e 732c  s=num_divisions,
+00004b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004b80: 206f 7065 7261 7469 6f6e 3d6f 7065 7261   operation=opera
+00004b90: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+00004ba0: 2020 2020 2020 7072 6563 6973 696f 6e3d        precision=
+00004bb0: 7072 6563 6973 696f 6e2c 0a20 2020 2020  precision,.     
+00004bc0: 2020 2020 2020 2029 0a0a 2020 2020 6966         )..    if
+00004bd0: 2070 2069 7320 6e6f 7420 4e6f 6e65 3a0a   p is not None:.
+00004be0: 2020 2020 2020 2020 706f 6c79 676f 6e73          polygons
+00004bf0: 203d 2044 2e61 6464 5f70 6f6c 7967 6f6e   = D.add_polygon
+00004c00: 2870 2c20 6c61 7965 723d 6c61 7965 7229  (p, layer=layer)
+00004c10: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00004c20: 2020 2020 2020 2070 6f6c 7967 6f6e 2e66         polygon.f
+00004c30: 7261 6374 7572 6528 6d61 785f 706f 696e  racture(max_poin
+00004c40: 7473 3d6d 6178 5f70 6f69 6e74 732c 2070  ts=max_points, p
+00004c50: 7265 6369 7369 6f6e 3d70 7265 6369 7369  recision=precisi
+00004c60: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
+00004c70: 666f 7220 706f 6c79 676f 6e20 696e 2070  for polygon in p
+00004c80: 6f6c 7967 6f6e 730a 2020 2020 2020 2020  olygons.        
+00004c90: 5d0a 2020 2020 7265 7475 726e 2044 0a0a  ].    return D..
+00004ca0: 0a64 6566 206f 7574 6c69 6e65 280a 2020  .def outline(.  
+00004cb0: 2020 656c 656d 656e 7473 2c0a 2020 2020    elements,.    
+00004cc0: 6469 7374 616e 6365 3d31 2c0a 2020 2020  distance=1,.    
+00004cd0: 7072 6563 6973 696f 6e3d 3165 2d34 2c0a  precision=1e-4,.
+00004ce0: 2020 2020 6e75 6d5f 6469 7669 7369 6f6e      num_division
+00004cf0: 733d 5b31 2c20 315d 2c0a 2020 2020 6a6f  s=[1, 1],.    jo
+00004d00: 696e 3d22 6d69 7465 7222 2c0a 2020 2020  in="miter",.    
+00004d10: 746f 6c65 7261 6e63 653d 322c 0a20 2020  tolerance=2,.   
+00004d20: 206a 6f69 6e5f 6669 7273 743d 5472 7565   join_first=True
+00004d30: 2c0a 2020 2020 6d61 785f 706f 696e 7473  ,.    max_points
+00004d40: 3d34 3030 302c 0a20 2020 206f 7065 6e5f  =4000,.    open_
+00004d50: 706f 7274 733d 4661 6c73 652c 0a20 2020  ports=False,.   
+00004d60: 206c 6179 6572 3d30 2c0a 293a 0a20 2020   layer=0,.):.   
+00004d70: 2022 2222 4372 6561 7465 7320 616e 206f   """Creates an o
+00004d80: 7574 6c69 6e65 2061 726f 756e 6420 616c  utline around al
+00004d90: 6c20 7468 6520 706f 6c79 676f 6e73 2070  l the polygons p
+00004da0: 6173 7365 6420 696e 2074 6865 2060 656c  assed in the `el
+00004db0: 656d 656e 7473 600a 2020 2020 6172 6775  ements`.    argu
+00004dc0: 6d65 6e74 2e20 6065 6c65 6d65 6e74 7360  ment. `elements`
+00004dd0: 206d 6179 2062 6520 6120 4465 7669 6365   may be a Device
+00004de0: 2c20 506f 6c79 676f 6e2c 206f 7220 6c69  , Polygon, or li
+00004df0: 7374 206f 6620 4465 7669 6365 732e 0a0a  st of Devices...
+00004e00: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+00004e10: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+00004e20: 2020 656c 656d 656e 7473 203a 2044 6576    elements : Dev
+00004e30: 6963 6528 2f52 6566 6572 656e 6365 292c  ice(/Reference),
+00004e40: 206c 6973 7420 6f66 2044 6576 6963 6528   list of Device(
+00004e50: 2f52 6566 6572 656e 6365 292c 206f 7220  /Reference), or 
+00004e60: 506f 6c79 676f 6e0a 2020 2020 2020 2020  Polygon.        
+00004e70: 506f 6c79 676f 6e73 2074 6f20 6f75 746c  Polygons to outl
+00004e80: 696e 6520 6f72 2044 6576 6963 6520 636f  ine or Device co
+00004e90: 6e74 6169 6e69 6e67 2070 6f6c 7967 6f6e  ntaining polygon
+00004ea0: 7320 746f 206f 7574 6c69 6e65 2e0a 2020  s to outline..  
+00004eb0: 2020 6469 7374 616e 6365 203a 2069 6e74    distance : int
+00004ec0: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
+00004ed0: 2020 4469 7374 616e 6365 2074 6f20 6f66    Distance to of
+00004ee0: 6673 6574 2070 6f6c 7967 6f6e 732e 2050  fset polygons. P
+00004ef0: 6f73 6974 6976 6520 7661 6c75 6573 2065  ositive values e
+00004f00: 7870 616e 642c 206e 6567 6174 6976 6520  xpand, negative 
+00004f10: 7368 7269 6e6b 2e0a 2020 2020 7072 6563  shrink..    prec
+00004f20: 6973 696f 6e20 3a20 666c 6f61 740a 2020  ision : float.  
+00004f30: 2020 2020 2020 4465 7369 7265 6420 7072        Desired pr
+00004f40: 6563 6973 696f 6e20 666f 7220 726f 756e  ecision for roun
+00004f50: 6469 6e67 2076 6572 7465 7820 636f 6f72  ding vertex coor
+00004f60: 6469 6e61 7465 732e 0a20 2020 206e 756d  dinates..    num
+00004f70: 5f64 6976 6973 696f 6e73 203a 2061 7272  _divisions : arr
+00004f80: 6179 2d6c 696b 655b 325d 206f 6620 696e  ay-like[2] of in
+00004f90: 740a 2020 2020 2020 2020 5468 6520 6e75  t.        The nu
+00004fa0: 6d62 6572 206f 6620 6469 7669 7369 6f6e  mber of division
+00004fb0: 7320 7769 7468 2077 6869 6368 2074 6865  s with which the
+00004fc0: 2067 656f 6d65 7472 7920 6973 2064 6976   geometry is div
+00004fd0: 6964 6564 2069 6e74 6f0a 2020 2020 2020  ided into.      
+00004fe0: 2020 6d75 6c74 6970 6c65 2072 6563 7461    multiple recta
+00004ff0: 6e67 756c 6172 2072 6567 696f 6e73 2e20  ngular regions. 
+00005000: 5468 6973 2061 6c6c 6f77 7320 666f 7220  This allows for 
+00005010: 6561 6368 2072 6567 696f 6e20 746f 2062  each region to b
+00005020: 650a 2020 2020 2020 2020 7072 6f63 6573  e.        proces
+00005030: 7365 6420 7365 7175 656e 7469 616c 6c79  sed sequentially
+00005040: 2c20 7768 6963 6820 6973 206d 6f72 6520  , which is more 
+00005050: 636f 6d70 7574 6174 696f 6e61 6c6c 7920  computationally 
+00005060: 6566 6669 6369 656e 742e 0a20 2020 206a  efficient..    j
+00005070: 6f69 6e20 3a20 7b27 6d69 7465 7227 2c20  oin : {'miter', 
+00005080: 2762 6576 656c 272c 2027 726f 756e 6427  'bevel', 'round'
+00005090: 7d0a 2020 2020 2020 2020 5479 7065 206f  }.        Type o
+000050a0: 6620 6a6f 696e 2075 7365 6420 746f 2063  f join used to c
+000050b0: 7265 6174 6520 7468 6520 6f66 6673 6574  reate the offset
+000050c0: 2070 6f6c 7967 6f6e 2e0a 2020 2020 746f   polygon..    to
+000050d0: 6c65 7261 6e63 6520 3a20 696e 7420 6f72  lerance : int or
+000050e0: 2066 6c6f 6174 0a20 2020 2020 2020 2046   float.        F
+000050f0: 6f72 206d 6974 6572 206a 6f69 6e74 732c  or miter joints,
+00005100: 2074 6869 7320 6e75 6d62 6572 206d 7573   this number mus
+00005110: 7420 6265 2061 7420 6c65 6173 7420 3220  t be at least 2 
+00005120: 616e 6420 6974 2072 6570 7265 7365 6e74  and it represent
+00005130: 7320 7468 650a 2020 2020 2020 2020 6d61  s the.        ma
+00005140: 7869 6d61 6c20 6469 7374 616e 6365 2069  ximal distance i
+00005150: 6e20 6d75 6c74 6970 6c65 7320 6f66 206f  n multiples of o
+00005160: 6666 7365 7420 6265 7477 6565 6e20 6e65  ffset between ne
+00005170: 7720 7665 7274 6963 6573 2061 6e64 2074  w vertices and t
+00005180: 6865 6972 0a20 2020 2020 2020 206f 7269  heir.        ori
+00005190: 6769 6e61 6c20 706f 7369 7469 6f6e 2062  ginal position b
+000051a0: 6566 6f72 6520 6265 7665 6c69 6e67 2074  efore beveling t
+000051b0: 6f20 6176 6f69 6420 7370 696b 6573 2061  o avoid spikes a
+000051c0: 7420 6163 7574 6520 6a6f 696e 7473 2e20  t acute joints. 
+000051d0: 466f 720a 2020 2020 2020 2020 726f 756e  For.        roun
+000051e0: 6420 6a6f 696e 7473 2c20 6974 2069 6e64  d joints, it ind
+000051f0: 6963 6174 6573 2074 6865 2063 7572 7661  icates the curva
+00005200: 7475 7265 2072 6573 6f6c 7574 696f 6e20  ture resolution 
+00005210: 696e 206e 756d 6265 7220 6f66 0a20 2020  in number of.   
+00005220: 2020 2020 2070 6f69 6e74 7320 7065 7220       points per 
+00005230: 6675 6c6c 2063 6972 636c 652e 0a20 2020  full circle..   
+00005240: 206a 6f69 6e5f 6669 7273 7420 3a20 626f   join_first : bo
+00005250: 6f6c 0a20 2020 2020 2020 204a 6f69 6e20  ol.        Join 
+00005260: 616c 6c20 7061 7468 7320 6265 666f 7265  all paths before
+00005270: 206f 6666 7365 7474 696e 6720 746f 2061   offsetting to a
+00005280: 766f 6964 2075 6e6e 6563 6573 7361 7279  void unnecessary
+00005290: 206a 6f69 6e73 2069 6e0a 2020 2020 2020   joins in.      
+000052a0: 2020 6164 6a61 6365 6e74 2070 6f6c 7967    adjacent polyg
+000052b0: 6f6e 2073 6964 6573 2e0a 2020 2020 6d61  on sides..    ma
+000052c0: 785f 706f 696e 7473 203a 2069 6e74 0a20  x_points : int. 
+000052d0: 2020 2020 2020 2054 6865 206d 6178 696d         The maxim
+000052e0: 756d 206e 756d 6265 7220 6f66 2076 6572  um number of ver
+000052f0: 7469 6365 7320 7769 7468 696e 2074 6865  tices within the
+00005300: 2072 6573 756c 7469 6e67 2070 6f6c 7967   resulting polyg
+00005310: 6f6e 2e0a 2020 2020 6f70 656e 5f70 6f72  on..    open_por
+00005320: 7473 203a 2062 6f6f 6c20 6f72 2066 6c6f  ts : bool or flo
+00005330: 6174 0a20 2020 2020 2020 2049 6620 6e6f  at.        If no
+00005340: 7420 4661 6c73 652c 2068 6f6c 6573 2077  t False, holes w
+00005350: 696c 6c20 6265 2063 7574 2069 6e20 7468  ill be cut in th
+00005360: 6520 6f75 746c 696e 6520 7375 6368 2074  e outline such t
+00005370: 6861 7420 7468 6520 506f 7274 7320 6172  hat the Ports ar
+00005380: 650a 2020 2020 2020 2020 6e6f 7420 636f  e.        not co
+00005390: 7665 7265 642e 2049 6620 5472 7565 2c20  vered. If True, 
+000053a0: 7468 6520 686f 6c65 7320 7769 6c6c 2068  the holes will h
+000053b0: 6176 6520 7468 6520 7361 6d65 2077 6964  ave the same wid
+000053c0: 7468 2061 7320 7468 6520 506f 7274 732e  th as the Ports.
+000053d0: 0a20 2020 2020 2020 2049 6620 6120 666c  .        If a fl
+000053e0: 6f61 742c 2074 6865 2068 6f6c 6573 2077  oat, the holes w
+000053f0: 696c 6c20 6265 2062 6520 7769 6465 6e65  ill be be widene
+00005400: 6420 6279 2074 6861 7420 7661 6c75 6520  d by that value 
+00005410: 2875 7365 6675 6c20 666f 7220 6675 6c6c  (useful for full
+00005420: 790a 2020 2020 2020 2020 636c 6561 7269  y.        cleari
+00005430: 6e67 2074 6865 206f 7574 6c69 6e65 2061  ng the outline a
+00005440: 726f 756e 6420 7468 6520 506f 7274 7320  round the Ports 
+00005450: 666f 7220 706f 7369 7469 7665 2d74 6f6e  for positive-ton
+00005460: 6520 7072 6f63 6573 7365 730a 2020 2020  e processes.    
+00005470: 6c61 7965 7220 3a20 696e 742c 2061 7272  layer : int, arr
+00005480: 6179 2d6c 696b 655b 325d 2c20 6f72 2073  ay-like[2], or s
+00005490: 6574 0a20 2020 2020 2020 2053 7065 6369  et.        Speci
+000054a0: 6669 6320 6c61 7965 7228 7329 2074 6f20  fic layer(s) to 
+000054b0: 7075 7420 706f 6c79 676f 6e20 6765 6f6d  put polygon geom
+000054c0: 6574 7279 206f 6e2e 290a 0a20 2020 2052  etry on.)..    R
+000054d0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
+000054e0: 2d2d 0a20 2020 2044 203a 2044 6576 6963  --.    D : Devic
+000054f0: 650a 2020 2020 2020 2020 4120 4465 7669  e.        A Devi
+00005500: 6365 2063 6f6e 7461 696e 696e 6720 7468  ce containing th
+00005510: 6520 6f75 746c 696e 6564 2070 6f6c 7967  e outlined polyg
+00005520: 6f6e 2873 292e 0a20 2020 2022 2222 0a20  on(s)..    """. 
+00005530: 2020 2044 203d 2044 6576 6963 6528 226f     D = Device("o
+00005540: 7574 6c69 6e65 2229 0a20 2020 2069 6620  utline").    if 
+00005550: 6e6f 7420 6973 696e 7374 616e 6365 2865  not isinstance(e
+00005560: 6c65 6d65 6e74 732c 206c 6973 7429 3a0a  lements, list):.
+00005570: 2020 2020 2020 2020 656c 656d 656e 7473          elements
+00005580: 203d 205b 656c 656d 656e 7473 5d0a 2020   = [elements].  
+00005590: 2020 706f 7274 5f6c 6973 7420 3d20 5b5d    port_list = []
+000055a0: 0a20 2020 2066 6f72 2065 2069 6e20 656c  .    for e in el
+000055b0: 656d 656e 7473 3a0a 2020 2020 2020 2020  ements:.        
+000055c0: 6966 2069 7369 6e73 7461 6e63 6528 652c  if isinstance(e,
+000055d0: 2044 6576 6963 6529 3a0a 2020 2020 2020   Device):.      
+000055e0: 2020 2020 2020 442e 6164 645f 7265 6628        D.add_ref(
+000055f0: 6529 0a20 2020 2020 2020 2020 2020 2070  e).            p
+00005600: 6f72 745f 6c69 7374 202b 3d20 6c69 7374  ort_list += list
+00005610: 2865 2e70 6f72 7473 2e76 616c 7565 7328  (e.ports.values(
+00005620: 2929 0a20 2020 2020 2020 2065 6c73 653a  )).        else:
+00005630: 0a20 2020 2020 2020 2020 2020 2044 2e61  .            D.a
+00005640: 6464 2865 290a 2020 2020 6764 735f 6c61  dd(e).    gds_la
+00005650: 7965 722c 2067 6473 5f64 6174 6174 7970  yer, gds_datatyp
+00005660: 6520 3d20 5f70 6172 7365 5f6c 6179 6572  e = _parse_layer
+00005670: 286c 6179 6572 290a 0a20 2020 2044 5f62  (layer)..    D_b
+00005680: 6c6f 6174 6564 203d 206f 6666 7365 7428  loated = offset(
+00005690: 0a20 2020 2020 2020 2044 2c0a 2020 2020  .        D,.    
+000056a0: 2020 2020 6469 7374 616e 6365 3d64 6973      distance=dis
+000056b0: 7461 6e63 652c 0a20 2020 2020 2020 206a  tance,.        j
+000056c0: 6f69 6e5f 6669 7273 743d 6a6f 696e 5f66  oin_first=join_f
+000056d0: 6972 7374 2c0a 2020 2020 2020 2020 6e75  irst,.        nu
+000056e0: 6d5f 6469 7669 7369 6f6e 733d 6e75 6d5f  m_divisions=num_
+000056f0: 6469 7669 7369 6f6e 732c 0a20 2020 2020  divisions,.     
+00005700: 2020 2070 7265 6369 7369 6f6e 3d70 7265     precision=pre
+00005710: 6369 7369 6f6e 2c0a 2020 2020 2020 2020  cision,.        
+00005720: 6d61 785f 706f 696e 7473 3d6d 6178 5f70  max_points=max_p
+00005730: 6f69 6e74 732c 0a20 2020 2020 2020 206a  oints,.        j
+00005740: 6f69 6e3d 6a6f 696e 2c0a 2020 2020 2020  oin=join,.      
+00005750: 2020 746f 6c65 7261 6e63 653d 746f 6c65    tolerance=tole
+00005760: 7261 6e63 652c 0a20 2020 2020 2020 206c  rance,.        l
+00005770: 6179 6572 3d6c 6179 6572 2c0a 2020 2020  ayer=layer,.    
+00005780: 290a 0a20 2020 2054 7269 6d20 3d20 4465  )..    Trim = De
+00005790: 7669 6365 2829 0a20 2020 2069 6620 6f70  vice().    if op
+000057a0: 656e 5f70 6f72 7473 2069 7320 6e6f 7420  en_ports is not 
+000057b0: 4661 6c73 653a 0a20 2020 2020 2020 2069  False:.        i
+000057c0: 6620 6f70 656e 5f70 6f72 7473 2069 7320  f open_ports is 
+000057d0: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
+000057e0: 2020 7472 696d 5f77 6964 7468 203d 2030    trim_width = 0
+000057f0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00005800: 2020 2020 2020 2020 2020 2074 7269 6d5f             trim_
+00005810: 7769 6474 6820 3d20 6f70 656e 5f70 6f72  width = open_por
+00005820: 7473 202a 2032 0a20 2020 2020 2020 2066  ts * 2.        f
+00005830: 6f72 2070 6f72 7420 696e 2070 6f72 745f  or port in port_
+00005840: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
+00005850: 2020 7472 696d 203d 2063 6f6d 7061 7373    trim = compass
+00005860: 2873 697a 653d 2864 6973 7461 6e63 6520  (size=(distance 
+00005870: 2b20 3620 2a20 7072 6563 6973 696f 6e2c  + 6 * precision,
+00005880: 2070 6f72 742e 7769 6474 6820 2b20 7472   port.width + tr
+00005890: 696d 5f77 6964 7468 2929 0a20 2020 2020  im_width)).     
+000058a0: 2020 2020 2020 2074 7269 6d5f 7265 6620         trim_ref 
+000058b0: 3d20 5472 696d 203c 3c20 7472 696d 0a20  = Trim << trim. 
+000058c0: 2020 2020 2020 2020 2020 2074 7269 6d5f             trim_
+000058d0: 7265 662e 636f 6e6e 6563 7428 2245 222c  ref.connect("E",
+000058e0: 2070 6f72 742c 206f 7665 726c 6170 3d32   port, overlap=2
+000058f0: 202a 2070 7265 6369 7369 6f6e 290a 0a20   * precision).. 
+00005900: 2020 204f 7574 6c69 6e65 203d 2062 6f6f     Outline = boo
+00005910: 6c65 616e 280a 2020 2020 2020 2020 413d  lean(.        A=
+00005920: 445f 626c 6f61 7465 642c 0a20 2020 2020  D_bloated,.     
+00005930: 2020 2042 3d5b 442c 2054 7269 6d5d 2c0a     B=[D, Trim],.
+00005940: 2020 2020 2020 2020 6f70 6572 6174 696f          operatio
+00005950: 6e3d 2241 2d42 2220 6966 2064 6973 7461  n="A-B" if dista
+00005960: 6e63 6520 3e20 3020 656c 7365 2022 422d  nce > 0 else "B-
+00005970: 4122 2c0a 2020 2020 2020 2020 6e75 6d5f  A",.        num_
+00005980: 6469 7669 7369 6f6e 733d 6e75 6d5f 6469  divisions=num_di
+00005990: 7669 7369 6f6e 732c 0a20 2020 2020 2020  visions,.       
+000059a0: 206d 6178 5f70 6f69 6e74 733d 6d61 785f   max_points=max_
+000059b0: 706f 696e 7473 2c0a 2020 2020 2020 2020  points,.        
+000059c0: 7072 6563 6973 696f 6e3d 7072 6563 6973  precision=precis
+000059d0: 696f 6e2c 0a20 2020 2020 2020 206c 6179  ion,.        lay
+000059e0: 6572 3d6c 6179 6572 2c0a 2020 2020 290a  er=layer,.    ).
+000059f0: 2020 2020 6966 206f 7065 6e5f 706f 7274      if open_port
+00005a00: 7320 6973 206e 6f74 2046 616c 7365 2061  s is not False a
+00005a10: 6e64 206c 656e 2865 6c65 6d65 6e74 7329  nd len(elements)
+00005a20: 203d 3d20 313a 0a20 2020 2020 2020 2066   == 1:.        f
+00005a30: 6f72 2070 6f72 7420 696e 2070 6f72 745f  or port in port_
+00005a40: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
+00005a50: 2020 4f75 746c 696e 652e 6164 645f 706f    Outline.add_po
+00005a60: 7274 2870 6f72 743d 706f 7274 290a 2020  rt(port=port).  
+00005a70: 2020 7265 7475 726e 204f 7574 6c69 6e65    return Outline
+00005a80: 0a0a 0a64 6566 2069 6e76 6572 7428 0a20  ...def invert(. 
+00005a90: 2020 2065 6c65 6d65 6e74 732c 2062 6f72     elements, bor
+00005aa0: 6465 723d 3130 2c20 7072 6563 6973 696f  der=10, precisio
+00005ab0: 6e3d 3165 2d34 2c20 6e75 6d5f 6469 7669  n=1e-4, num_divi
+00005ac0: 7369 6f6e 733d 5b31 2c20 315d 2c20 6d61  sions=[1, 1], ma
+00005ad0: 785f 706f 696e 7473 3d34 3030 302c 206c  x_points=4000, l
+00005ae0: 6179 6572 3d30 0a29 3a0a 2020 2020 2222  ayer=0.):.    ""
+00005af0: 2243 7265 6174 6573 2061 6e20 696e 7665  "Creates an inve
+00005b00: 7274 6564 2076 6572 7369 6f6e 206f 6620  rted version of 
+00005b10: 7468 6520 696e 7075 7420 7368 6170 6573  the input shapes
+00005b20: 2077 6974 6820 616e 2061 6464 6974 696f   with an additio
+00005b30: 6e61 6c0a 2020 2020 626f 7264 6572 2061  nal.    border a
+00005b40: 726f 756e 6420 7468 6520 6564 6765 732e  round the edges.
+00005b50: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00005b60: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+00005b70: 2020 2020 656c 656d 656e 7473 203a 2044      elements : D
+00005b80: 6576 6963 6528 2f52 6566 6572 656e 6365  evice(/Reference
+00005b90: 292c 206c 6973 7420 6f66 2044 6576 6963  ), list of Devic
+00005ba0: 6528 2f52 6566 6572 656e 6365 292c 206f  e(/Reference), o
+00005bb0: 7220 506f 6c79 676f 6e0a 2020 2020 2020  r Polygon.      
+00005bc0: 2020 4120 4465 7669 6365 2063 6f6e 7461    A Device conta
+00005bd0: 696e 696e 6720 7468 6520 706f 6c79 676f  ining the polygo
+00005be0: 6e73 2074 6f20 696e 7665 7274 2e0a 2020  ns to invert..  
+00005bf0: 2020 626f 7264 6572 203a 2069 6e74 206f    border : int o
+00005c00: 7220 666c 6f61 740a 2020 2020 2020 2020  r float.        
+00005c10: 5369 7a65 206f 6620 7468 6520 626f 7264  Size of the bord
+00005c20: 6572 2061 726f 756e 6420 7468 6520 696e  er around the in
+00005c30: 7665 7274 6564 2073 6861 7065 2028 626f  verted shape (bo
+00005c40: 7264 6572 2076 616c 7565 2069 7320 7468  rder value is th
+00005c50: 650a 2020 2020 2020 2020 6469 7374 616e  e.        distan
+00005c60: 6365 2066 726f 6d20 7468 6520 6564 6765  ce from the edge
+00005c70: 7320 6f66 2074 6865 2062 6f75 6e64 6172  s of the boundar
+00005c80: 7920 626f 7820 6465 6669 6e69 6e67 2074  y box defining t
+00005c90: 6865 2069 6e76 6572 7465 640a 2020 2020  he inverted.    
+00005ca0: 2020 2020 7368 6170 6520 746f 2074 6865      shape to the
+00005cb0: 2062 6f72 6465 722c 2061 6e64 2069 7320   border, and is 
+00005cc0: 6170 706c 6965 6420 746f 2061 6c6c 2034  applied to all 4
+00005cd0: 2073 6964 6573 206f 6620 7468 6520 7368   sides of the sh
+00005ce0: 6170 6529 2e0a 2020 2020 7072 6563 6973  ape)..    precis
+00005cf0: 696f 6e20 3a20 666c 6f61 740a 2020 2020  ion : float.    
+00005d00: 2020 2020 4465 7369 7265 6420 7072 6563      Desired prec
+00005d10: 6973 696f 6e20 666f 7220 726f 756e 6469  ision for roundi
+00005d20: 6e67 2076 6572 7465 7820 636f 6f72 6469  ng vertex coordi
+00005d30: 6e61 7465 732e 0a20 2020 206e 756d 5f64  nates..    num_d
+00005d40: 6976 6973 696f 6e73 203a 2061 7272 6179  ivisions : array
+00005d50: 2d6c 696b 655b 325d 206f 6620 696e 740a  -like[2] of int.
+00005d60: 2020 2020 2020 2020 5468 6520 6e75 6d62          The numb
+00005d70: 6572 206f 6620 6469 7669 7369 6f6e 7320  er of divisions 
+00005d80: 7769 7468 2077 6869 6368 2074 6865 2067  with which the g
+00005d90: 656f 6d65 7472 7920 6973 2064 6976 6964  eometry is divid
+00005da0: 6564 2069 6e74 6f0a 2020 2020 2020 2020  ed into.        
+00005db0: 6d75 6c74 6970 6c65 2072 6563 7461 6e67  multiple rectang
+00005dc0: 756c 6172 2072 6567 696f 6e73 2e20 5468  ular regions. Th
+00005dd0: 6973 2061 6c6c 6f77 7320 666f 7220 6561  is allows for ea
+00005de0: 6368 2072 6567 696f 6e20 746f 2062 650a  ch region to be.
+00005df0: 2020 2020 2020 2020 7072 6f63 6573 7365          processe
+00005e00: 6420 7365 7175 656e 7469 616c 6c79 2c20  d sequentially, 
+00005e10: 7768 6963 6820 6973 206d 6f72 6520 636f  which is more co
+00005e20: 6d70 7574 6174 696f 6e61 6c6c 7920 6566  mputationally ef
+00005e30: 6669 6369 656e 742e 0a20 2020 206d 6178  ficient..    max
+00005e40: 5f70 6f69 6e74 7320 3a20 696e 740a 2020  _points : int.  
+00005e50: 2020 2020 2020 5468 6520 6d61 7869 6d75        The maximu
+00005e60: 6d20 6e75 6d62 6572 206f 6620 7665 7274  m number of vert
+00005e70: 6963 6573 2077 6974 6869 6e20 7468 6520  ices within the 
+00005e80: 7265 7375 6c74 696e 6720 706f 6c79 676f  resulting polygo
+00005e90: 6e2e 0a20 2020 206c 6179 6572 203a 2069  n..    layer : i
+00005ea0: 6e74 2c20 6172 7261 792d 6c69 6b65 5b32  nt, array-like[2
+00005eb0: 5d2c 206f 7220 7365 740a 2020 2020 2020  ], or set.      
+00005ec0: 2020 5370 6563 6966 6963 206c 6179 6572    Specific layer
+00005ed0: 2873 2920 746f 2070 7574 2070 6f6c 7967  (s) to put polyg
+00005ee0: 6f6e 2067 656f 6d65 7472 7920 6f6e 2e0a  on geometry on..
+00005ef0: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
+00005f00: 202d 2d2d 2d2d 2d2d 0a20 2020 2044 203a   -------.    D :
+00005f10: 2044 6576 6963 650a 2020 2020 2020 2020   Device.        
+00005f20: 4120 4465 7669 6365 2063 6f6e 7461 696e  A Device contain
+00005f30: 696e 6720 7468 6520 696e 7665 7274 6564  ing the inverted
+00005f40: 2076 6572 7369 6f6e 206f 6620 7468 6520   version of the 
+00005f50: 696e 7075 7420 7368 6170 6528 7329 2061  input shape(s) a
+00005f60: 6e64 2074 6865 0a20 2020 2020 2020 2063  nd the.        c
+00005f70: 6f72 7265 7370 6f6e 6469 6e67 2062 6f72  orresponding bor
+00005f80: 6465 7228 7329 2e0a 2020 2020 2222 220a  der(s)..    """.
+00005f90: 2020 2020 5465 6d70 203d 2044 6576 6963      Temp = Devic
+00005fa0: 6528 290a 2020 2020 6966 206e 6f74 2069  e().    if not i
+00005fb0: 7369 6e73 7461 6e63 6528 656c 656d 656e  sinstance(elemen
+00005fc0: 7473 2c20 6c69 7374 293a 0a20 2020 2020  ts, list):.     
+00005fd0: 2020 2065 6c65 6d65 6e74 7320 3d20 5b65     elements = [e
+00005fe0: 6c65 6d65 6e74 735d 0a20 2020 2066 6f72  lements].    for
+00005ff0: 2065 2069 6e20 656c 656d 656e 7473 3a0a   e in elements:.
+00006000: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00006010: 7461 6e63 6528 652c 2044 6576 6963 6529  tance(e, Device)
+00006020: 3a0a 2020 2020 2020 2020 2020 2020 5465  :.            Te
+00006030: 6d70 2e61 6464 5f72 6566 2865 290a 2020  mp.add_ref(e).  
+00006040: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00006050: 2020 2020 2020 2020 5465 6d70 2e61 6464          Temp.add
+00006060: 2865 290a 2020 2020 6764 735f 6c61 7965  (e).    gds_laye
+00006070: 722c 2067 6473 5f64 6174 6174 7970 6520  r, gds_datatype 
+00006080: 3d20 5f70 6172 7365 5f6c 6179 6572 286c  = _parse_layer(l
+00006090: 6179 6572 290a 0a20 2020 2023 2042 7569  ayer)..    # Bui
+000060a0: 6c64 2074 6865 2072 6563 7461 6e67 6c65  ld the rectangle
+000060b0: 2061 726f 756e 6420 7468 6520 6465 7669   around the devi
+000060c0: 6365 2044 0a20 2020 2052 203d 2072 6563  ce D.    R = rec
+000060d0: 7461 6e67 6c65 2873 697a 653d 2854 656d  tangle(size=(Tem
+000060e0: 702e 7873 697a 6520 2b20 3220 2a20 626f  p.xsize + 2 * bo
+000060f0: 7264 6572 2c20 5465 6d70 2e79 7369 7a65  rder, Temp.ysize
+00006100: 202b 2032 202a 2062 6f72 6465 7229 290a   + 2 * border)).
+00006110: 2020 2020 522e 6365 6e74 6572 203d 2054      R.center = T
+00006120: 656d 702e 6365 6e74 6572 0a0a 2020 2020  emp.center..    
+00006130: 4420 3d20 626f 6f6c 6561 6e28 0a20 2020  D = boolean(.   
+00006140: 2020 2020 2041 3d52 2c0a 2020 2020 2020       A=R,.      
+00006150: 2020 423d 5465 6d70 2c0a 2020 2020 2020    B=Temp,.      
+00006160: 2020 6f70 6572 6174 696f 6e3d 2241 2d42    operation="A-B
+00006170: 222c 0a20 2020 2020 2020 2070 7265 6369  ",.        preci
+00006180: 7369 6f6e 3d70 7265 6369 7369 6f6e 2c0a  sion=precision,.
+00006190: 2020 2020 2020 2020 6e75 6d5f 6469 7669          num_divi
+000061a0: 7369 6f6e 733d 6e75 6d5f 6469 7669 7369  sions=num_divisi
+000061b0: 6f6e 732c 0a20 2020 2020 2020 206d 6178  ons,.        max
+000061c0: 5f70 6f69 6e74 733d 6d61 785f 706f 696e  _points=max_poin
+000061d0: 7473 2c0a 2020 2020 2020 2020 6c61 7965  ts,.        laye
+000061e0: 723d 6c61 7965 722c 0a20 2020 2029 0a20  r=layer,.    ). 
+000061f0: 2020 2072 6574 7572 6e20 440a 0a0a 6465     return D...de
+00006200: 6620 786f 725f 6469 6666 2841 2c20 422c  f xor_diff(A, B,
+00006210: 2070 7265 6369 7369 6f6e 3d31 652d 3429   precision=1e-4)
+00006220: 3a0a 2020 2020 2222 2247 6976 656e 2074  :.    """Given t
+00006230: 776f 2044 6576 6963 6573 2041 2061 6e64  wo Devices A and
+00006240: 2042 2c20 7065 7266 6f72 6d73 2074 6865   B, performs the
+00006250: 206c 6179 6572 2d62 792d 6c61 7965 7220   layer-by-layer 
+00006260: 584f 520a 2020 2020 6469 6666 6572 656e  XOR.    differen
+00006270: 6365 2062 6574 7765 656e 2041 2061 6e64  ce between A and
+00006280: 2042 2061 6e64 2072 6574 7572 6e73 2070   B and returns p
+00006290: 6f6c 7967 6f6e 7320 7265 7072 6573 656e  olygons represen
+000062a0: 7469 6e67 2074 6865 0a20 2020 2064 6966  ting the.    dif
+000062b0: 6665 7265 6e63 6573 2062 6574 7765 656e  ferences between
+000062c0: 2041 2061 6e64 2042 2e0a 0a20 2020 2050   A and B...    P
+000062d0: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+000062e0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2041 203a  --------.    A :
+000062f0: 2044 6576 6963 6528 2f52 6566 6572 656e   Device(/Referen
+00006300: 6365 2920 6f72 206c 6973 7420 6f66 2044  ce) or list of D
+00006310: 6576 6963 6528 2f52 6566 6572 656e 6365  evice(/Reference
+00006320: 290a 2020 2020 2020 2020 4120 4465 7669  ).        A Devi
+00006330: 6365 2063 6f6e 7461 696e 696e 6720 6120  ce containing a 
+00006340: 706f 6c79 676f 6e28 7329 2e0a 2020 2020  polygon(s)..    
+00006350: 4220 3a20 4465 7669 6365 282f 5265 6665  B : Device(/Refe
+00006360: 7265 6e63 6529 206f 7220 6c69 7374 206f  rence) or list o
+00006370: 6620 4465 7669 6365 282f 5265 6665 7265  f Device(/Refere
+00006380: 6e63 6529 0a20 2020 2020 2020 2041 2044  nce).        A D
+00006390: 6576 6963 6520 636f 6e74 6169 6e69 6e67  evice containing
+000063a0: 2061 2070 6f6c 7967 6f6e 2873 292e 0a20   a polygon(s).. 
+000063b0: 2020 2070 7265 6369 7369 6f6e 203a 2066     precision : f
+000063c0: 6c6f 6174 0a20 2020 2020 2020 2044 6573  loat.        Des
+000063d0: 6972 6564 2070 7265 6369 7369 6f6e 2066  ired precision f
+000063e0: 6f72 2072 6f75 6e64 696e 6720 7665 7274  or rounding vert
+000063f0: 6578 2063 6f6f 7264 696e 6174 6573 2e0a  ex coordinates..
+00006400: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
+00006410: 202d 2d2d 2d2d 2d0a 2020 2020 443a 2044   ------.    D: D
+00006420: 6576 6963 650a 2020 2020 2020 2020 4120  evice.        A 
+00006430: 4465 7669 6365 2063 6f6e 7461 696e 696e  Device containin
+00006440: 6720 6120 706f 6c79 676f 6e28 7329 2064  g a polygon(s) d
+00006450: 6566 696e 6564 2062 7920 7468 6520 584f  efined by the XO
+00006460: 5220 6469 6666 6572 656e 6365 2072 6573  R difference res
+00006470: 756c 740a 2020 2020 2020 2020 6265 7477  ult.        betw
+00006480: 6565 6e20 4120 616e 6420 422e 0a20 2020  een A and B..   
+00006490: 2022 2222 0a0a 2020 2020 4420 3d20 4465   """..    D = De
+000064a0: 7669 6365 2822 786f 725f 6469 6666 2229  vice("xor_diff")
+000064b0: 0a20 2020 2041 5f70 6f6c 7973 203d 2041  .    A_polys = A
+000064c0: 2e67 6574 5f70 6f6c 7967 6f6e 7328 6279  .get_polygons(by
+000064d0: 5f73 7065 633d 5472 7565 290a 2020 2020  _spec=True).    
+000064e0: 425f 706f 6c79 7320 3d20 422e 6765 745f  B_polys = B.get_
+000064f0: 706f 6c79 676f 6e73 2862 795f 7370 6563  polygons(by_spec
+00006500: 3d54 7275 6529 0a20 2020 2041 5f6c 6179  =True).    A_lay
+00006510: 6572 7320 3d20 415f 706f 6c79 732e 6b65  ers = A_polys.ke
+00006520: 7973 2829 0a20 2020 2042 5f6c 6179 6572  ys().    B_layer
+00006530: 7320 3d20 425f 706f 6c79 732e 6b65 7973  s = B_polys.keys
+00006540: 2829 0a20 2020 2061 6c6c 5f6c 6179 6572  ().    all_layer
+00006550: 7320 3d20 7365 7428 290a 2020 2020 616c  s = set().    al
+00006560: 6c5f 6c61 7965 7273 2e75 7064 6174 6528  l_layers.update(
+00006570: 415f 6c61 7965 7273 290a 2020 2020 616c  A_layers).    al
+00006580: 6c5f 6c61 7965 7273 2e75 7064 6174 6528  l_layers.update(
+00006590: 425f 6c61 7965 7273 290a 2020 2020 666f  B_layers).    fo
+000065a0: 7220 6c61 7965 7220 696e 2061 6c6c 5f6c  r layer in all_l
+000065b0: 6179 6572 733a 0a20 2020 2020 2020 2069  ayers:.        i
+000065c0: 6620 286c 6179 6572 2069 6e20 415f 6c61  f (layer in A_la
+000065d0: 7965 7273 2920 616e 6420 286c 6179 6572  yers) and (layer
+000065e0: 2069 6e20 425f 6c61 7965 7273 293a 0a20   in B_layers):. 
+000065f0: 2020 2020 2020 2020 2020 2070 203d 2067             p = g
+00006600: 6473 7079 2e62 6f6f 6c65 616e 280a 2020  dspy.boolean(.  
+00006610: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+00006620: 6572 616e 6431 3d41 5f70 6f6c 7973 5b6c  erand1=A_polys[l
+00006630: 6179 6572 5d2c 0a20 2020 2020 2020 2020  ayer],.         
+00006640: 2020 2020 2020 206f 7065 7261 6e64 323d         operand2=
+00006650: 425f 706f 6c79 735b 6c61 7965 725d 2c0a  B_polys[layer],.
+00006660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006670: 6f70 6572 6174 696f 6e3d 2278 6f72 222c  operation="xor",
+00006680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006690: 2070 7265 6369 7369 6f6e 3d70 7265 6369   precision=preci
+000066a0: 7369 6f6e 2c0a 2020 2020 2020 2020 2020  sion,.          
+000066b0: 2020 2020 2020 6d61 785f 706f 696e 7473        max_points
+000066c0: 3d34 3030 302c 0a20 2020 2020 2020 2020  =4000,.         
+000066d0: 2020 2020 2020 206c 6179 6572 3d6c 6179         layer=lay
+000066e0: 6572 5b30 5d2c 0a20 2020 2020 2020 2020  er[0],.         
+000066f0: 2020 2020 2020 2064 6174 6174 7970 653d         datatype=
+00006700: 6c61 7965 725b 315d 2c0a 2020 2020 2020  layer[1],.      
+00006710: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00006720: 656c 6966 206c 6179 6572 2069 6e20 415f  elif layer in A_
+00006730: 6c61 7965 7273 3a0a 2020 2020 2020 2020  layers:.        
+00006740: 2020 2020 7020 3d20 415f 706f 6c79 735b      p = A_polys[
+00006750: 6c61 7965 725d 0a20 2020 2020 2020 2065  layer].        e
+00006760: 6c69 6620 6c61 7965 7220 696e 2042 5f6c  lif layer in B_l
+00006770: 6179 6572 733a 0a20 2020 2020 2020 2020  ayers:.         
+00006780: 2020 2070 203d 2042 5f70 6f6c 7973 5b6c     p = B_polys[l
+00006790: 6179 6572 5d0a 2020 2020 2020 2020 6966  ayer].        if
+000067a0: 2070 2069 7320 6e6f 7420 4e6f 6e65 3a0a   p is not None:.
+000067b0: 2020 2020 2020 2020 2020 2020 442e 6164              D.ad
+000067c0: 645f 706f 6c79 676f 6e28 702c 206c 6179  d_polygon(p, lay
+000067d0: 6572 3d6c 6179 6572 290a 2020 2020 7265  er=layer).    re
+000067e0: 7475 726e 2044 0a0a 0a64 6566 2075 6e69  turn D...def uni
+000067f0: 6f6e 2844 2c20 6279 5f6c 6179 6572 3d46  on(D, by_layer=F
+00006800: 616c 7365 2c20 7072 6563 6973 696f 6e3d  alse, precision=
+00006810: 3165 2d34 2c20 6a6f 696e 5f66 6972 7374  1e-4, join_first
+00006820: 3d54 7275 652c 206d 6178 5f70 6f69 6e74  =True, max_point
+00006830: 733d 3430 3030 2c20 6c61 7965 723d 3029  s=4000, layer=0)
+00006840: 3a0a 2020 2020 2222 2250 6572 666f 726d  :.    """Perform
+00006850: 7320 7468 6520 756e 696f 6e20 6f66 2061  s the union of a
+00006860: 6c6c 2070 6f6c 7967 6f6e 7320 7769 7468  ll polygons with
+00006870: 696e 2061 2044 6576 6963 652e 0a0a 2020  in a Device...  
+00006880: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00006890: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+000068a0: 4420 3a20 4465 7669 6365 282f 5265 6665  D : Device(/Refe
+000068b0: 7265 6e63 6529 0a20 2020 2020 2020 2041  rence).        A
+000068c0: 2044 6576 6963 6520 636f 6e74 6169 6e69   Device containi
+000068d0: 6e67 2070 6f6c 7967 6f6e 7320 746f 2070  ng polygons to p
+000068e0: 6572 666f 726d 2061 2075 6e69 6f6e 206f  erform a union o
+000068f0: 6e2e 0a20 2020 2062 795f 4c61 7965 7220  n..    by_Layer 
+00006900: 3a20 626f 6f6c 0a20 2020 2020 2020 2049  : bool.        I
+00006910: 6620 7472 7565 2c20 7065 7266 6f72 6d73  f true, performs
+00006920: 2074 6865 2075 6e69 6f6e 206f 7065 7261   the union opera
+00006930: 7469 6f6e 206c 6179 6572 2d77 6973 6520  tion layer-wise 
+00006940: 736f 2065 6163 6820 6c61 7965 7220 6361  so each layer ca
+00006950: 6e20 6265 0a20 2020 2020 2020 2069 6e64  n be.        ind
+00006960: 6976 6964 7561 6c6c 7920 636f 6d62 696e  ividually combin
+00006970: 6564 2e0a 2020 2020 7072 6563 6973 696f  ed..    precisio
+00006980: 6e20 3a20 666c 6f61 740a 2020 2020 2020  n : float.      
+00006990: 2020 4465 7369 7265 6420 7072 6563 6973    Desired precis
+000069a0: 696f 6e20 666f 7220 726f 756e 6469 6e67  ion for rounding
+000069b0: 2076 6572 7465 7820 636f 6f72 6469 6e61   vertex coordina
+000069c0: 7465 732e 0a20 2020 206a 6f69 6e5f 6669  tes..    join_fi
+000069d0: 7273 7420 3a20 626f 6f6c 0a20 2020 2020  rst : bool.     
+000069e0: 2020 204a 6f69 6e20 616c 6c20 7061 7468     Join all path
+000069f0: 7320 6265 666f 7265 206f 6666 7365 7474  s before offsett
+00006a00: 696e 6720 746f 2061 766f 6964 2075 6e6e  ing to avoid unn
+00006a10: 6563 6573 7361 7279 206a 6f69 6e73 2069  ecessary joins i
+00006a20: 6e0a 2020 2020 2020 2020 6164 6a61 6365  n.        adjace
+00006a30: 6e74 2070 6f6c 7967 6f6e 2073 6964 6573  nt polygon sides
+00006a40: 2e0a 2020 2020 6d61 785f 706f 696e 7473  ..    max_points
+00006a50: 203a 2069 6e74 0a20 2020 2020 2020 2054   : int.        T
+00006a60: 6865 206d 6178 696d 756d 206e 756d 6265  he maximum numbe
+00006a70: 7220 6f66 2076 6572 7469 6365 7320 7769  r of vertices wi
+00006a80: 7468 696e 2074 6865 2072 6573 756c 7469  thin the resulti
+00006a90: 6e67 2070 6f6c 7967 6f6e 2e0a 2020 2020  ng polygon..    
+00006aa0: 6c61 7965 7220 3a20 696e 742c 2061 7272  layer : int, arr
+00006ab0: 6179 2d6c 696b 655b 325d 2c20 6f72 2073  ay-like[2], or s
+00006ac0: 6574 0a20 2020 2020 2020 2053 7065 6369  et.        Speci
+00006ad0: 6669 6320 6c61 7965 7228 7329 2074 6f20  fic layer(s) to 
+00006ae0: 7075 7420 706f 6c79 676f 6e20 6765 6f6d  put polygon geom
+00006af0: 6574 7279 206f 6e2e 0a0a 2020 2020 5265  etry on...    Re
+00006b00: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+00006b10: 2d0a 2020 2020 5520 3a20 4465 7669 6365  -.    U : Device
+00006b20: 0a20 2020 2020 2020 2041 2044 6576 6963  .        A Devic
+00006b30: 6520 636f 6e74 6169 6e69 6e67 2074 6865  e containing the
+00006b40: 2075 6e69 6f6e 206f 6620 7468 6520 706f   union of the po
+00006b50: 6c79 676f 6e73 2077 6974 6869 6e20 7468  lygons within th
+00006b60: 6520 696e 7075 7420 4465 7669 6365 2e0a  e input Device..
+00006b70: 2020 2020 2222 220a 2020 2020 5520 3d20      """.    U = 
+00006b80: 4465 7669 6365 2822 756e 696f 6e22 290a  Device("union").
+00006b90: 0a20 2020 2069 6620 6279 5f6c 6179 6572  .    if by_layer
+00006ba0: 3a0a 2020 2020 2020 2020 616c 6c5f 706f  :.        all_po
+00006bb0: 6c79 676f 6e73 203d 2044 2e67 6574 5f70  lygons = D.get_p
+00006bc0: 6f6c 7967 6f6e 7328 6279 5f73 7065 633d  olygons(by_spec=
+00006bd0: 5472 7565 290a 2020 2020 2020 2020 666f  True).        fo
+00006be0: 7220 6c61 7965 722c 2070 6f6c 7967 6f6e  r layer, polygon
+00006bf0: 7320 696e 2061 6c6c 5f70 6f6c 7967 6f6e  s in all_polygon
+00006c00: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+00006c10: 2020 2020 2020 2075 6e69 6f6e 6564 5f70         unioned_p
+00006c20: 6f6c 7967 6f6e 7320 3d20 5f75 6e69 6f6e  olygons = _union
+00006c30: 5f70 6f6c 7967 6f6e 7328 0a20 2020 2020  _polygons(.     
+00006c40: 2020 2020 2020 2020 2020 2070 6f6c 7967             polyg
+00006c50: 6f6e 732c 2070 7265 6369 7369 6f6e 3d70  ons, precision=p
+00006c60: 7265 6369 7369 6f6e 2c20 6d61 785f 706f  recision, max_po
+00006c70: 696e 7473 3d6d 6178 5f70 6f69 6e74 730a  ints=max_points.
+00006c80: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00006c90: 2020 2020 2020 2020 2020 552e 6164 645f            U.add_
+00006ca0: 706f 6c79 676f 6e28 756e 696f 6e65 645f  polygon(unioned_
+00006cb0: 706f 6c79 676f 6e73 2c20 6c61 7965 723d  polygons, layer=
+00006cc0: 6c61 7965 7229 0a20 2020 2065 6c73 653a  layer).    else:
+00006cd0: 0a20 2020 2020 2020 2061 6c6c 5f70 6f6c  .        all_pol
+00006ce0: 7967 6f6e 7320 3d20 442e 6765 745f 706f  ygons = D.get_po
+00006cf0: 6c79 676f 6e73 2862 795f 7370 6563 3d46  lygons(by_spec=F
+00006d00: 616c 7365 290a 2020 2020 2020 2020 756e  alse).        un
+00006d10: 696f 6e65 645f 706f 6c79 676f 6e73 203d  ioned_polygons =
+00006d20: 205f 756e 696f 6e5f 706f 6c79 676f 6e73   _union_polygons
+00006d30: 280a 2020 2020 2020 2020 2020 2020 616c  (.            al
+00006d40: 6c5f 706f 6c79 676f 6e73 2c20 7072 6563  l_polygons, prec
+00006d50: 6973 696f 6e3d 7072 6563 6973 696f 6e2c  ision=precision,
+00006d60: 206d 6178 5f70 6f69 6e74 733d 6d61 785f   max_points=max_
+00006d70: 706f 696e 7473 0a20 2020 2020 2020 2029  points.        )
+00006d80: 0a20 2020 2020 2020 2055 2e61 6464 5f70  .        U.add_p
+00006d90: 6f6c 7967 6f6e 2875 6e69 6f6e 6564 5f70  olygon(unioned_p
+00006da0: 6f6c 7967 6f6e 732c 206c 6179 6572 3d6c  olygons, layer=l
+00006db0: 6179 6572 290a 2020 2020 7265 7475 726e  ayer).    return
+00006dc0: 2055 0a0a 0a64 6566 205f 756e 696f 6e5f   U...def _union_
+00006dd0: 706f 6c79 676f 6e73 2870 6f6c 7967 6f6e  polygons(polygon
+00006de0: 732c 2070 7265 6369 7369 6f6e 3d31 652d  s, precision=1e-
+00006df0: 342c 206d 6178 5f70 6f69 6e74 733d 3430  4, max_points=40
+00006e00: 3030 293a 0a20 2020 2022 2222 5065 7266  00):.    """Perf
+00006e10: 6f72 6d73 2074 6865 2075 6e69 6f6e 206f  orms the union o
+00006e20: 6620 616c 6c20 706f 6c79 676f 6e73 2077  f all polygons w
+00006e30: 6974 6869 6e20 6120 506f 6c79 676f 6e53  ithin a PolygonS
+00006e40: 6574 206f 7220 6c69 7374 206f 660a 2020  et or list of.  
+00006e50: 2020 706f 6c79 676f 6e73 2e0a 0a20 2020    polygons...   
+00006e60: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+00006e70: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2070  ----------.    p
+00006e80: 6f6c 7967 6f6e 7320 3a20 506f 6c79 676f  olygons : Polygo
+00006e90: 6e53 6574 206f 7220 6c69 7374 206f 6620  nSet or list of 
+00006ea0: 706f 6c79 676f 6e73 0a20 2020 2020 2020  polygons.       
+00006eb0: 2041 2073 6574 2063 6f6e 7461 696e 696e   A set containin
+00006ec0: 6720 7468 6520 696e 7075 7420 706f 6c79  g the input poly
+00006ed0: 676f 6e73 2e0a 2020 2020 7072 6563 6973  gons..    precis
+00006ee0: 696f 6e20 3a20 666c 6f61 740a 2020 2020  ion : float.    
+00006ef0: 2020 2020 4465 7369 7265 6420 7072 6563      Desired prec
+00006f00: 6973 696f 6e20 666f 7220 726f 756e 6469  ision for roundi
+00006f10: 6e67 2076 6572 7465 7820 636f 6f72 6469  ng vertex coordi
+00006f20: 6e61 7465 732e 0a20 2020 206d 6178 5f70  nates..    max_p
+00006f30: 6f69 6e74 7320 3a20 696e 740a 2020 2020  oints : int.    
+00006f40: 2020 2020 5468 6520 6d61 7869 6d75 6d20      The maximum 
+00006f50: 6e75 6d62 6572 206f 6620 7665 7274 6963  number of vertic
+00006f60: 6573 2077 6974 6869 6e20 7468 6520 7265  es within the re
+00006f70: 7375 6c74 696e 6720 706f 6c79 676f 6e2e  sulting polygon.
+00006f80: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+00006f90: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 756e    -------.    un
+00006fa0: 696f 6e65 6420 3a20 706f 6c79 676f 6e0a  ioned : polygon.
+00006fb0: 2020 2020 2020 2020 5468 6520 7265 7375          The resu
+00006fc0: 6c74 206f 6620 7468 6520 756e 696f 6e20  lt of the union 
+00006fd0: 6f66 2061 6c6c 2074 6865 2070 6f6c 7967  of all the polyg
+00006fe0: 6f6e 7320 7769 7468 696e 2074 6865 2069  ons within the i
+00006ff0: 6e70 7574 0a20 2020 2020 2020 2050 6f6c  nput.        Pol
+00007000: 7967 6f6e 5365 742e 0a20 2020 2022 2222  ygonSet..    """
+00007010: 0a20 2020 2070 6f6c 7967 6f6e 7320 3d20  .    polygons = 
+00007020: 5f6d 6572 6765 5f66 6c6f 6174 696e 675f  _merge_floating_
+00007030: 706f 696e 745f 6572 726f 7273 2870 6f6c  point_errors(pol
+00007040: 7967 6f6e 732c 2074 6f6c 3d70 7265 6369  ygons, tol=preci
+00007050: 7369 6f6e 202f 2031 3030 3029 0a20 2020  sion / 1000).   
+00007060: 2075 6e69 6f6e 6564 203d 2067 6473 7079   unioned = gdspy
+00007070: 2e62 6f6f 6c65 616e 280a 2020 2020 2020  .boolean(.      
+00007080: 2020 706f 6c79 676f 6e73 2c20 5b5d 2c20    polygons, [], 
+00007090: 6f70 6572 6174 696f 6e3d 226f 7222 2c20  operation="or", 
+000070a0: 7072 6563 6973 696f 6e3d 7072 6563 6973  precision=precis
+000070b0: 696f 6e2c 206d 6178 5f70 6f69 6e74 733d  ion, max_points=
+000070c0: 6d61 785f 706f 696e 7473 0a20 2020 2029  max_points.    )
+000070d0: 0a20 2020 2072 6574 7572 6e20 756e 696f  .    return unio
+000070e0: 6e65 640a 0a0a 6465 6620 5f6d 6572 6765  ned...def _merge
+000070f0: 5f66 6c6f 6174 696e 675f 706f 696e 745f  _floating_point_
+00007100: 6572 726f 7273 2870 6f6c 7967 6f6e 732c  errors(polygons,
+00007110: 2074 6f6c 3d31 652d 3130 293a 0a20 2020   tol=1e-10):.   
+00007120: 2022 2222 4669 7865 7320 666c 6f61 7469   """Fixes floati
+00007130: 6e67 2070 6f69 6e74 2065 7272 6f72 7320  ng point errors 
+00007140: 696e 2074 6865 2069 6e70 7574 2070 6f6c  in the input pol
+00007150: 7967 6f6e 2873 2920 6279 206d 6572 6769  ygon(s) by mergi
+00007160: 6e67 2076 616c 7565 730a 2020 2020 7769  ng values.    wi
+00007170: 7468 696e 2074 6865 2074 6f6c 6572 616e  thin the toleran
+00007180: 6365 2060 746f 6c60 2e20 5365 6520 5f6d  ce `tol`. See _m
+00007190: 6572 6765 5f6e 6561 7262 795f 666c 6f61  erge_nearby_floa
+000071a0: 7469 6e67 5f70 6f69 6e74 7320 666f 720a  ting_points for.
+000071b0: 2020 2020 7370 6563 6966 6963 732e 0a0a      specifics...
+000071c0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+000071d0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+000071e0: 2020 706f 6c79 676f 6e73 203a 2050 6f6c    polygons : Pol
+000071f0: 7967 6f6e 5365 7420 6f72 206c 6973 7420  ygonSet or list 
+00007200: 6f66 2070 6f6c 7967 6f6e 730a 2020 2020  of polygons.    
+00007210: 2020 2020 5365 7420 6f66 2070 6f6c 7967      Set of polyg
+00007220: 6f6e 7320 7769 7468 2066 6c6f 6174 696e  ons with floatin
+00007230: 6720 706f 696e 7420 6572 726f 7273 2e0a  g point errors..
+00007240: 2020 2020 746f 6c20 3a20 666c 6f61 740a      tol : float.
+00007250: 2020 2020 2020 2020 546f 6c65 7261 6e63          Toleranc
+00007260: 6520 7769 7468 696e 2077 6869 6368 2070  e within which p
+00007270: 6f69 6e74 7320 7769 6c6c 2062 6520 6d65  oints will be me
+00007280: 7267 6564 2e0a 0a20 2020 2052 6574 7572  rged...    Retur
+00007290: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+000072a0: 2020 2070 6f6c 7967 6f6e 735f 6669 7865     polygons_fixe
+000072b0: 6420 3a20 506f 6c79 676f 6e53 6574 0a20  d : PolygonSet. 
+000072c0: 2020 2020 2020 2053 6574 206f 6620 636f         Set of co
+000072d0: 7272 6563 7465 6420 706f 6c79 676f 6e73  rrected polygons
+000072e0: 2e0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
+000072f0: 206c 656e 2870 6f6c 7967 6f6e 7329 203d   len(polygons) =
+00007300: 3d20 303a 0a20 2020 2020 2020 2072 6574  = 0:.        ret
+00007310: 7572 6e20 6e70 2e61 7366 6172 7261 7928  urn np.asfarray(
+00007320: 5b5d 290a 2020 2020 7374 6163 6b65 645f  []).    stacked_
+00007330: 706f 6c79 676f 6e73 203d 206e 702e 7673  polygons = np.vs
+00007340: 7461 636b 2870 6f6c 7967 6f6e 7329 0a20  tack(polygons). 
+00007350: 2020 2078 203d 2073 7461 636b 6564 5f70     x = stacked_p
+00007360: 6f6c 7967 6f6e 735b 3a2c 2030 5d0a 2020  olygons[:, 0].  
+00007370: 2020 7920 3d20 7374 6163 6b65 645f 706f    y = stacked_po
+00007380: 6c79 676f 6e73 5b3a 2c20 315d 0a20 2020  lygons[:, 1].   
+00007390: 2070 6f6c 7967 6f6e 5f69 6e64 6963 6573   polygon_indices
+000073a0: 203d 206e 702e 6375 6d73 756d 285b 6c65   = np.cumsum([le
+000073b0: 6e28 7029 2066 6f72 2070 2069 6e20 706f  n(p) for p in po
+000073c0: 6c79 676f 6e73 5d29 0a0a 2020 2020 7866  lygons])..    xf
+000073d0: 6978 6564 203d 205f 6d65 7267 655f 6e65  ixed = _merge_ne
+000073e0: 6172 6279 5f66 6c6f 6174 696e 675f 706f  arby_floating_po
+000073f0: 696e 7473 2878 2c20 746f 6c3d 746f 6c29  ints(x, tol=tol)
+00007400: 0a20 2020 2079 6669 7865 6420 3d20 5f6d  .    yfixed = _m
+00007410: 6572 6765 5f6e 6561 7262 795f 666c 6f61  erge_nearby_floa
+00007420: 7469 6e67 5f70 6f69 6e74 7328 792c 2074  ting_points(y, t
+00007430: 6f6c 3d74 6f6c 290a 2020 2020 7374 6163  ol=tol).    stac
+00007440: 6b65 645f 706f 6c79 676f 6e73 5f66 6978  ked_polygons_fix
+00007450: 6564 203d 206e 702e 7673 7461 636b 285b  ed = np.vstack([
+00007460: 7866 6978 6564 2c20 7966 6978 6564 5d29  xfixed, yfixed])
+00007470: 2e54 0a20 2020 2070 6f6c 7967 6f6e 735f  .T.    polygons_
+00007480: 6669 7865 6420 3d20 6e70 2e76 7370 6c69  fixed = np.vspli
+00007490: 7428 7374 6163 6b65 645f 706f 6c79 676f  t(stacked_polygo
+000074a0: 6e73 5f66 6978 6564 2c20 706f 6c79 676f  ns_fixed, polygo
+000074b0: 6e5f 696e 6469 6365 735b 3a2d 315d 290a  n_indices[:-1]).
+000074c0: 2020 2020 7265 7475 726e 2070 6f6c 7967      return polyg
+000074d0: 6f6e 735f 6669 7865 640a 0a0a 6465 6620  ons_fixed...def 
+000074e0: 5f6d 6572 6765 5f6e 6561 7262 795f 666c  _merge_nearby_fl
+000074f0: 6f61 7469 6e67 5f70 6f69 6e74 7328 782c  oating_points(x,
+00007500: 2074 6f6c 3d31 652d 3130 293a 0a20 2020   tol=1e-10):.   
+00007510: 2022 2222 5461 6b65 7320 616e 2061 7272   """Takes an arr
+00007520: 6179 2060 7860 2061 6e64 206d 6572 6765  ay `x` and merge
+00007530: 7320 616e 7920 7661 6c75 6573 2077 6974  s any values wit
+00007540: 6869 6e20 7468 6520 746f 6c65 7261 6e63  hin the toleranc
+00007550: 6520 6074 6f6c 602e 0a0a 2020 2020 5061  e `tol`...    Pa
+00007560: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00007570: 2d2d 2d2d 2d2d 2d0a 2020 2020 7820 3a20  -------.    x : 
+00007580: 6c69 7374 206f 6620 696e 7420 6f72 2066  list of int or f
+00007590: 6c6f 6174 0a20 2020 2020 2020 2041 7272  loat.        Arr
+000075a0: 6179 206f 6620 7661 6c75 6573 2077 6974  ay of values wit
+000075b0: 6820 666c 6f61 7469 6e67 2070 6f69 6e74  h floating point
+000075c0: 2065 7272 6f72 732e 0a20 2020 2074 6f6c   errors..    tol
+000075d0: 203a 2066 6c6f 6174 0a20 2020 2020 2020   : float.       
+000075e0: 2054 6f6c 6572 616e 6365 2077 6974 6869   Tolerance withi
+000075f0: 6e20 7768 6963 6820 706f 696e 7473 2077  n which points w
+00007600: 696c 6c20 6265 206d 6572 6765 642e 0a0a  ill be merged...
+00007610: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00007620: 2d2d 2d2d 2d2d 2d0a 2020 2020 7873 6f72  -------.    xsor
+00007630: 7420 3a20 6c69 7374 206f 6620 696e 7420  t : list of int 
+00007640: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
+00007650: 2043 6f72 7265 6374 6564 2061 6e64 2073   Corrected and s
+00007660: 6f72 7465 6420 6172 7261 792e 0a0a 2020  orted array...  
+00007670: 2020 4578 616d 706c 6573 0a20 2020 202d    Examples.    -
+00007680: 2d2d 2d2d 2d2d 2d0a 2020 2020 4966 2067  -------.    If g
+00007690: 6976 656e 3a0a 2020 2020 3e3e 3e20 7820  iven:.    >>> x 
+000076a0: 3d20 5b2d 322c 202d 312c 2030 2c20 312e  = [-2, -1, 0, 1.
+000076b0: 3030 3031 2c20 312e 3030 3032 2c20 312e  0001, 1.0002, 1.
+000076c0: 3030 3033 2c20 342c 2035 2c20 352e 3030  0003, 4, 5, 5.00
+000076d0: 332c 2036 2c20 372c 2038 5d0a 2020 2020  3, 6, 7, 8].    
+000076e0: 3e3e 3e20 5f6d 6572 6765 5f6e 6561 7262  >>> _merge_nearb
+000076f0: 795f 666c 6f61 7469 6e67 5f70 6f69 6e74  y_floating_point
+00007700: 7328 782c 2074 6f6c 203d 2031 652d 3329  s(x, tol = 1e-3)
+00007710: 0a20 2020 2057 696c 6c20 7265 7475 726e  .    Will return
+00007720: 3a0a 2020 2020 3e3e 3e20 5b2d 322c 202d  :.    >>> [-2, -
+00007730: 312c 2030 2c20 312e 3030 3031 2c20 312e  1, 0, 1.0001, 1.
+00007740: 3030 3031 2c20 312e 3030 3031 2c20 342c  0001, 1.0001, 4,
+00007750: 2035 2c20 352e 3030 332c 2036 2c20 372c   5, 5.003, 6, 7,
+00007760: 2038 5d2e 0a20 2020 2022 2222 0a20 2020   8]..    """.   
+00007770: 2078 6172 6773 6f72 7420 3d20 6e70 2e61   xargsort = np.a
+00007780: 7267 736f 7274 2878 290a 2020 2020 7861  rgsort(x).    xa
+00007790: 7267 756e 736f 7274 203d 206e 702e 6172  rgunsort = np.ar
+000077a0: 6773 6f72 7428 7861 7267 736f 7274 290a  gsort(xargsort).
+000077b0: 2020 2020 7873 6f72 7420 3d20 785b 7861      xsort = x[xa
+000077c0: 7267 736f 7274 5d0a 2020 2020 6478 203d  rgsort].    dx =
+000077d0: 206e 702e 6469 6666 2878 736f 7274 290a   np.diff(xsort).
+000077e0: 2020 2020 7873 6f72 7474 6872 6573 686f      xsortthresho
+000077f0: 6c64 203d 206e 702e 6c6f 6769 6361 6c5f  ld = np.logical_
+00007800: 616e 6428 6478 203c 2074 6f6c 2c20 6478  and(dx < tol, dx
+00007810: 203e 2030 290a 2020 2020 7873 6f72 7474   > 0).    xsortt
+00007820: 6872 6573 686f 6c64 696e 6420 3d20 6e70  hresholdind = np
+00007830: 2e61 7267 7768 6572 6528 7873 6f72 7474  .argwhere(xsortt
+00007840: 6872 6573 686f 6c64 290a 0a20 2020 2023  hreshold)..    #
+00007850: 204d 6572 6765 206e 6561 7262 7920 666c   Merge nearby fl
+00007860: 6f61 7469 6e67 2070 6f69 6e74 2076 616c  oating point val
+00007870: 7565 730a 2020 2020 666f 7220 7869 2069  ues.    for xi i
+00007880: 6e20 7873 6f72 7474 6872 6573 686f 6c64  n xsortthreshold
+00007890: 696e 643a 0a20 2020 2020 2020 2078 736f  ind:.        xso
+000078a0: 7274 5b78 6920 2b20 315d 203d 2078 736f  rt[xi + 1] = xso
+000078b0: 7274 5b78 695d 0a20 2020 2072 6574 7572  rt[xi].    retur
+000078c0: 6e20 7873 6f72 745b 7861 7267 756e 736f  n xsort[xargunso
+000078d0: 7274 5d0a 0a0a 6465 6620 5f63 726f 705f  rt]...def _crop_
+000078e0: 7265 6769 6f6e 2870 6f6c 7967 6f6e 732c  region(polygons,
+000078f0: 206c 6566 742c 2062 6f74 746f 6d2c 2072   left, bottom, r
+00007900: 6967 6874 2c20 746f 702c 2070 7265 6369  ight, top, preci
+00007910: 7369 6f6e 293a 0a20 2020 2022 2222 4769  sion):.    """Gi
+00007920: 7665 6e20 6120 7265 6374 616e 6775 6c61  ven a rectangula
+00007930: 7220 626f 756e 6461 7279 2064 6566 696e  r boundary defin
+00007940: 6564 2062 7920 6c65 6674 2f62 6f74 746f  ed by left/botto
+00007950: 6d2f 7269 6768 742f 746f 702c 2074 6869  m/right/top, thi
+00007960: 730a 2020 2020 7461 6b65 7320 6120 6c69  s.    takes a li
+00007970: 7374 206f 6620 706f 6c79 676f 6e73 2061  st of polygons a
+00007980: 6e64 2063 7574 7320 7468 656d 2061 7420  nd cuts them at 
+00007990: 7468 6520 626f 756e 6461 7279 2c20 6469  the boundary, di
+000079a0: 7363 6172 6469 6e67 2070 6172 7473 0a20  scarding parts. 
+000079b0: 2020 206f 6620 7468 6520 706f 6c79 676f     of the polygo
+000079c0: 6e73 206f 7574 7369 6465 2074 6865 2072  ns outside the r
+000079d0: 6563 7461 6e67 6c65 2e0a 0a20 2020 2050  ectangle...    P
+000079e0: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+000079f0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2070 6f6c  --------.    pol
+00007a00: 7967 6f6e 7320 3a20 506f 6c79 676f 6e53  ygons : PolygonS
+00007a10: 6574 206f 7220 6c69 7374 206f 6620 706f  et or list of po
+00007a20: 6c79 676f 6e73 0a20 2020 2020 2020 2053  lygons.        S
+00007a30: 6574 206f 7220 6c69 7374 206f 6620 706f  et or list of po
+00007a40: 6c79 676f 6e73 2074 6f20 6265 2063 726f  lygons to be cro
+00007a50: 7070 6564 2e0a 2020 2020 6c65 6674 203a  pped..    left :
+00007a60: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
+00007a70: 2020 2020 2020 5468 6520 782d 636f 6f72        The x-coor
+00007a80: 6469 6e61 7465 206f 6620 7468 6520 6c65  dinate of the le
+00007a90: 6674 6861 6e64 2062 6f75 6e64 6172 792e  fthand boundary.
+00007aa0: 0a20 2020 2062 6f74 746f 6d20 3a20 696e  .    bottom : in
+00007ab0: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
+00007ac0: 2020 2054 6865 2079 2d63 6f6f 7264 696e     The y-coordin
+00007ad0: 6174 6520 6f66 2074 6865 2062 6f74 746f  ate of the botto
+00007ae0: 6d20 626f 756e 6461 7279 2e0a 2020 2020  m boundary..    
+00007af0: 7269 6768 7420 3a20 696e 7420 6f72 2066  right : int or f
+00007b00: 6c6f 6174 0a20 2020 2020 2020 2054 6865  loat.        The
+00007b10: 2078 2d63 6f6f 7264 696e 6174 6520 6f66   x-coordinate of
+00007b20: 2074 6865 2072 6967 6874 6861 6e64 2062   the righthand b
+00007b30: 6f75 6e64 6172 792e 0a20 2020 2074 6f70  oundary..    top
+00007b40: 203a 2069 6e74 206f 7220 666c 6f61 740a   : int or float.
+00007b50: 2020 2020 2020 2020 5468 6520 792d 636f          The y-co
+00007b60: 6f72 6469 6e61 7465 206f 6620 7468 6520  ordinate of the 
+00007b70: 746f 7020 626f 756e 6461 7279 2e0a 2020  top boundary..  
+00007b80: 2020 7072 6563 6973 696f 6e20 3a20 666c    precision : fl
+00007b90: 6f61 740a 2020 2020 2020 2020 4465 7369  oat.        Desi
+00007ba0: 7265 6420 7072 6563 6973 696f 6e20 666f  red precision fo
+00007bb0: 7220 726f 756e 6469 6e67 2076 6572 7465  r rounding verte
+00007bc0: 7820 636f 6f72 6469 6e61 7465 732e 0a0a  x coordinates...
+00007bd0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00007be0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6372 6f70  -------.    crop
+00007bf0: 7065 645f 706f 6c79 676f 6e73 203a 2050  ped_polygons : P
+00007c00: 6f6c 7967 6f6e 5365 7420 6f72 206c 6973  olygonSet or lis
+00007c10: 7420 6f66 2070 6f6c 7967 6f6e 730a 2020  t of polygons.  
+00007c20: 2020 2020 2020 5365 7420 6f72 206c 6973        Set or lis
+00007c30: 7420 6f66 2070 6f6c 7967 6f6e 7320 7468  t of polygons th
+00007c40: 6174 2061 7265 2063 726f 7070 6564 2061  at are cropped a
+00007c50: 6363 6f72 6469 6e67 2074 6f20 7468 6520  ccording to the 
+00007c60: 7370 6563 6966 6965 640a 2020 2020 2020  specified.      
+00007c70: 2020 626f 756e 6461 7279 2e0a 2020 2020    boundary..    
+00007c80: 2222 220a 2020 2020 6372 6f70 7065 645f  """.    cropped_
+00007c90: 706f 6c79 676f 6e73 203d 205b 5d0a 2020  polygons = [].  
+00007ca0: 2020 666f 7220 7020 696e 2070 6f6c 7967    for p in polyg
+00007cb0: 6f6e 733a 0a20 2020 2020 2020 2063 6c69  ons:.        cli
+00007cc0: 7070 6564 5f70 6f6c 7973 203d 2063 6c69  pped_polys = cli
+00007cd0: 7070 6572 2e5f 6368 6f70 2870 2c20 5b74  pper._chop(p, [t
+00007ce0: 6f70 2c20 626f 7474 6f6d 5d2c 2031 2c20  op, bottom], 1, 
+00007cf0: 3120 2f20 7072 6563 6973 696f 6e29 0a20  1 / precision). 
+00007d00: 2020 2020 2020 2023 2070 6f6c 7967 6f6e         # polygon
+00007d10: 2c20 5b63 7574 735d 2c20 6178 6973 2c20  , [cuts], axis, 
+00007d20: 7363 616c 650a 2020 2020 2020 2020 666f  scale.        fo
+00007d30: 7220 6370 2069 6e20 636c 6970 7065 645f  r cp in clipped_
+00007d40: 706f 6c79 735b 315d 3a0a 2020 2020 2020  polys[1]:.      
+00007d50: 2020 2020 2020 7265 7375 6c74 203d 2063        result = c
+00007d60: 6c69 7070 6572 2e5f 6368 6f70 2863 702c  lipper._chop(cp,
+00007d70: 205b 6c65 6674 2c20 7269 6768 745d 2c20   [left, right], 
+00007d80: 302c 2031 202f 2070 7265 6369 7369 6f6e  0, 1 / precision
+00007d90: 290a 2020 2020 2020 2020 2020 2020 6372  ).            cr
+00007da0: 6f70 7065 645f 706f 6c79 676f 6e73 202b  opped_polygons +
+00007db0: 3d20 6c69 7374 2872 6573 756c 745b 315d  = list(result[1]
+00007dc0: 290a 2020 2020 7265 7475 726e 2063 726f  ).    return cro
+00007dd0: 7070 6564 5f70 6f6c 7967 6f6e 730a 0a0a  pped_polygons...
+00007de0: 6465 6620 5f63 726f 705f 6564 6765 5f70  def _crop_edge_p
+00007df0: 6f6c 7967 6f6e 7328 616c 6c5f 706f 6c79  olygons(all_poly
+00007e00: 676f 6e73 2c20 6262 6f78 6573 2c20 6c65  gons, bboxes, le
+00007e10: 6674 2c20 626f 7474 6f6d 2c20 7269 6768  ft, bottom, righ
+00007e20: 742c 2074 6f70 2c20 7072 6563 6973 696f  t, top, precisio
+00007e30: 6e29 3a0a 2020 2020 2222 2250 6172 7365  n):.    """Parse
+00007e40: 7320 6f75 7420 7768 6963 6820 706f 6c79  s out which poly
+00007e50: 676f 6e73 2061 7265 2061 6c6f 6e67 2074  gons are along t
+00007e60: 6865 2065 6467 6520 6f66 2074 6865 2072  he edge of the r
+00007e70: 6563 7461 6e67 6c65 2061 6e64 206e 6565  ectangle and nee
+00007e80: 640a 2020 2020 746f 2062 6520 6372 6f70  d.    to be crop
+00007e90: 7065 6420 616e 6420 7768 6963 6820 6172  ped and which ar
+00007ea0: 6520 6465 6570 2069 6e73 6964 6520 7468  e deep inside th
+00007eb0: 6520 7265 6374 616e 676c 6520 7265 6769  e rectangle regi
+00007ec0: 6f6e 2061 6e64 2063 616e 2062 650a 2020  on and can be.  
+00007ed0: 2020 6c65 6674 2061 6c6f 6e65 2c20 7468    left alone, th
+00007ee0: 656e 2063 726f 7073 206f 6e6c 7920 7468  en crops only th
+00007ef0: 6f73 6520 706f 6c79 676f 6e73 2061 6c6f  ose polygons alo
+00007f00: 6e67 2074 6865 2065 6467 652e 0a0a 2020  ng the edge...  
+00007f10: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00007f20: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00007f30: 616c 6c5f 706f 6c79 676f 6e73 203a 2050  all_polygons : P
+00007f40: 6f6c 7967 6f6e 5365 7420 6f72 206c 6973  olygonSet or lis
+00007f50: 7420 6f66 2070 6f6c 7967 6f6e 730a 2020  t of polygons.  
+00007f60: 2020 2020 2020 5365 7420 6f72 206c 6973        Set or lis
+00007f70: 7420 6f66 2070 6f6c 7967 6f6e 7320 746f  t of polygons to
+00007f80: 2062 6520 6372 6f70 7065 642e 0a20 2020   be cropped..   
+00007f90: 2062 626f 7865 7320 3a20 6c69 7374 0a20   bboxes : list. 
+00007fa0: 2020 2020 2020 204c 6973 7420 6f66 2061         List of a
+00007fb0: 6c6c 2070 6f6c 7967 6f6e 2062 626f 7865  ll polygon bboxe
+00007fc0: 7320 696e 2061 6c6c 5f70 6f6c 7967 6f6e  s in all_polygon
+00007fd0: 732e 0a20 2020 206c 6566 7420 3a20 696e  s..    left : in
+00007fe0: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
+00007ff0: 2020 2054 6865 2078 2d63 6f6f 7264 696e     The x-coordin
+00008000: 6174 6520 6f66 2074 6865 206c 6566 7468  ate of the lefth
+00008010: 616e 6420 626f 756e 6461 7279 2e0a 2020  and boundary..  
+00008020: 2020 626f 7474 6f6d 203a 2069 6e74 206f    bottom : int o
+00008030: 7220 666c 6f61 740a 2020 2020 2020 2020  r float.        
+00008040: 5468 6520 792d 636f 6f72 6469 6e61 7465  The y-coordinate
+00008050: 206f 6620 7468 6520 626f 7474 6f6d 2062   of the bottom b
+00008060: 6f75 6e64 6172 792e 0a20 2020 2072 6967  oundary..    rig
+00008070: 6874 203a 2069 6e74 206f 7220 666c 6f61  ht : int or floa
+00008080: 740a 2020 2020 2020 2020 5468 6520 782d  t.        The x-
+00008090: 636f 6f72 6469 6e61 7465 206f 6620 7468  coordinate of th
+000080a0: 6520 7269 6768 7468 616e 6420 626f 756e  e righthand boun
+000080b0: 6461 7279 2e0a 2020 2020 746f 7020 3a20  dary..    top : 
+000080c0: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
+000080d0: 2020 2020 2054 6865 2079 2d63 6f6f 7264       The y-coord
+000080e0: 696e 6174 6520 6f66 2074 6865 2074 6f70  inate of the top
+000080f0: 2062 6f75 6e64 6172 792e 0a20 2020 2070   boundary..    p
+00008100: 7265 6369 7369 6f6e 203a 2066 6c6f 6174  recision : float
+00008110: 0a20 2020 2020 2020 2044 6573 6972 6564  .        Desired
+00008120: 2070 7265 6369 7369 6f6e 2066 6f72 2072   precision for r
+00008130: 6f75 6e64 696e 6720 7665 7274 6578 2063  ounding vertex c
+00008140: 6f6f 7264 696e 6174 6573 2e0a 0a20 2020  oordinates...   
+00008150: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
+00008160: 2d2d 2d2d 0a20 2020 2070 6f6c 7967 6f6e  ----.    polygon
+00008170: 735f 746f 5f70 726f 6365 7373 203a 2050  s_to_process : P
+00008180: 6f6c 7967 6f6e 5365 7420 6f72 206c 6973  olygonSet or lis
+00008190: 7420 6f66 2070 6f6c 7967 6f6e 730a 2020  t of polygons.  
+000081a0: 2020 2020 2020 5365 7420 6f72 206c 6973        Set or lis
+000081b0: 7420 6f66 2070 6f6c 7967 6f6e 7320 7769  t of polygons wi
+000081c0: 7468 2063 726f 7020 6170 706c 6965 6420  th crop applied 
+000081d0: 746f 2065 6467 6520 706f 6c79 676f 6e73  to edge polygons
+000081e0: 2e0a 2020 2020 2222 220a 2020 2020 706f  ..    """.    po
+000081f0: 6c79 676f 6e73 5f69 6e5f 7265 6374 5f69  lygons_in_rect_i
+00008200: 203d 205f 6669 6e64 5f62 626f 7865 735f   = _find_bboxes_
+00008210: 696e 5f72 6563 7428 6262 6f78 6573 2c20  in_rect(bboxes, 
+00008220: 6c65 6674 2c20 626f 7474 6f6d 2c20 7269  left, bottom, ri
+00008230: 6768 742c 2074 6f70 290a 2020 2020 706f  ght, top).    po
+00008240: 6c79 676f 6e73 5f65 6467 655f 6920 3d20  lygons_edge_i = 
+00008250: 5f66 696e 645f 6262 6f78 6573 5f6f 6e5f  _find_bboxes_on_
+00008260: 7265 6374 5f65 6467 6528 6262 6f78 6573  rect_edge(bboxes
+00008270: 2c20 6c65 6674 2c20 626f 7474 6f6d 2c20  , left, bottom, 
+00008280: 7269 6768 742c 2074 6f70 290a 2020 2020  right, top).    
+00008290: 706f 6c79 676f 6e73 5f69 6e5f 7265 6374  polygons_in_rect
+000082a0: 5f6e 6f5f 6564 6765 5f69 203d 2070 6f6c  _no_edge_i = pol
+000082b0: 7967 6f6e 735f 696e 5f72 6563 745f 6920  ygons_in_rect_i 
+000082c0: 2620 287e 706f 6c79 676f 6e73 5f65 6467  & (~polygons_edg
+000082d0: 655f 6929 0a0a 2020 2020 2320 4372 6f70  e_i)..    # Crop
+000082e0: 2070 6f6c 7967 6f6e 7320 616c 6f6e 6720   polygons along 
+000082f0: 7468 6520 6564 6765 2061 6e64 2072 6563  the edge and rec
+00008300: 6f6d 6269 6e65 2074 6865 6d20 7769 7468  ombine them with
+00008310: 2070 6f6c 7967 6f6e 7320 696e 7369 6465   polygons inside
+00008320: 2074 6865 0a20 2020 2023 2072 6563 7461   the.    # recta
+00008330: 6e67 6c65 0a20 2020 2070 6f6c 7967 6f6e  ngle.    polygon
+00008340: 735f 6564 6765 203d 2061 6c6c 5f70 6f6c  s_edge = all_pol
+00008350: 7967 6f6e 735b 706f 6c79 676f 6e73 5f65  ygons[polygons_e
+00008360: 6467 655f 695d 0a20 2020 2070 6f6c 7967  dge_i].    polyg
+00008370: 6f6e 735f 696e 5f72 6563 745f 6e6f 5f65  ons_in_rect_no_e
+00008380: 6467 6520 3d20 616c 6c5f 706f 6c79 676f  dge = all_polygo
+00008390: 6e73 5b70 6f6c 7967 6f6e 735f 696e 5f72  ns[polygons_in_r
+000083a0: 6563 745f 6e6f 5f65 6467 655f 695d 2e74  ect_no_edge_i].t
+000083b0: 6f6c 6973 7428 290a 2020 2020 706f 6c79  olist().    poly
+000083c0: 676f 6e73 5f65 6467 655f 6372 6f70 7065  gons_edge_croppe
+000083d0: 6420 3d20 5f63 726f 705f 7265 6769 6f6e  d = _crop_region
+000083e0: 280a 2020 2020 2020 2020 706f 6c79 676f  (.        polygo
+000083f0: 6e73 5f65 6467 652c 206c 6566 742c 2062  ns_edge, left, b
+00008400: 6f74 746f 6d2c 2072 6967 6874 2c20 746f  ottom, right, to
+00008410: 702c 2070 7265 6369 7369 6f6e 3d70 7265  p, precision=pre
+00008420: 6369 7369 6f6e 0a20 2020 2029 0a20 2020  cision.    ).   
+00008430: 2070 6f6c 7967 6f6e 735f 746f 5f70 726f   polygons_to_pro
+00008440: 6365 7373 203d 2070 6f6c 7967 6f6e 735f  cess = polygons_
+00008450: 696e 5f72 6563 745f 6e6f 5f65 6467 6520  in_rect_no_edge 
+00008460: 2b20 706f 6c79 676f 6e73 5f65 6467 655f  + polygons_edge_
+00008470: 6372 6f70 7065 640a 0a20 2020 2072 6574  cropped..    ret
+00008480: 7572 6e20 706f 6c79 676f 6e73 5f74 6f5f  urn polygons_to_
+00008490: 7072 6f63 6573 730a 0a0a 6465 6620 5f66  process...def _f
+000084a0: 696e 645f 6262 6f78 6573 5f69 6e5f 7265  ind_bboxes_in_re
+000084b0: 6374 2862 626f 7865 732c 206c 6566 742c  ct(bboxes, left,
+000084c0: 2062 6f74 746f 6d2c 2072 6967 6874 2c20   bottom, right, 
+000084d0: 746f 7029 3a0a 2020 2020 2222 2247 6976  top):.    """Giv
+000084e0: 656e 2061 206c 6973 7420 6f66 2070 6f6c  en a list of pol
+000084f0: 7967 6f6e 2062 6f75 6e64 696e 6720 626f  ygon bounding bo
+00008500: 7865 7320 616e 6420 6120 7265 6374 616e  xes and a rectan
+00008510: 676c 6520 6465 6669 6e65 6420 6279 0a20  gle defined by. 
+00008520: 2020 206c 6566 742f 626f 7474 6f6d 2f72     left/bottom/r
+00008530: 6967 6874 2f74 6f70 2c20 7468 6973 2066  ight/top, this f
+00008540: 756e 6374 696f 6e20 7265 7475 726e 7320  unction returns 
+00008550: 7468 6f73 6520 706f 6c79 676f 6e73 2077  those polygons w
+00008560: 6869 6368 206f 7665 726c 6170 0a20 2020  hich overlap.   
+00008570: 2074 6865 2072 6563 7461 6e67 6c65 2e0a   the rectangle..
+00008580: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00008590: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+000085a0: 2020 2062 626f 7865 7320 3a20 6c69 7374     bboxes : list
+000085b0: 0a20 2020 2020 2020 204c 6973 7420 6f66  .        List of
+000085c0: 2061 6c6c 2070 6f6c 7967 6f6e 2062 626f   all polygon bbo
+000085d0: 7865 732e 0a20 2020 206c 6566 7420 3a20  xes..    left : 
+000085e0: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
+000085f0: 2020 2020 2054 6865 2078 2d63 6f6f 7264       The x-coord
+00008600: 696e 6174 6520 6f66 2074 6865 206c 6566  inate of the lef
+00008610: 7468 616e 6420 626f 756e 6461 7279 2e0a  thand boundary..
+00008620: 2020 2020 626f 7474 6f6d 203a 2069 6e74      bottom : int
+00008630: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
+00008640: 2020 5468 6520 792d 636f 6f72 6469 6e61    The y-coordina
+00008650: 7465 206f 6620 7468 6520 626f 7474 6f6d  te of the bottom
+00008660: 2062 6f75 6e64 6172 792e 0a20 2020 2072   boundary..    r
+00008670: 6967 6874 203a 2069 6e74 206f 7220 666c  ight : int or fl
+00008680: 6f61 740a 2020 2020 2020 2020 5468 6520  oat.        The 
+00008690: 782d 636f 6f72 6469 6e61 7465 206f 6620  x-coordinate of 
+000086a0: 7468 6520 7269 6768 7468 616e 6420 626f  the righthand bo
+000086b0: 756e 6461 7279 2e0a 2020 2020 746f 7020  undary..    top 
+000086c0: 3a20 696e 7420 6f72 2066 6c6f 6174 0a20  : int or float. 
+000086d0: 2020 2020 2020 2054 6865 2079 2d63 6f6f         The y-coo
+000086e0: 7264 696e 6174 6520 6f66 2074 6865 2074  rdinate of the t
+000086f0: 6f70 2062 6f75 6e64 6172 792e 0a0a 2020  op boundary...  
+00008700: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+00008710: 2d2d 2d2d 2d0a 2020 2020 7265 7375 6c74  -----.    result
+00008720: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
+00008730: 4c69 7374 206f 6620 616c 6c20 706f 6c79  List of all poly
+00008740: 676f 6e20 6262 6f78 6573 2074 6861 7420  gon bboxes that 
+00008750: 6f76 6572 6c61 7020 7769 7468 2074 6865  overlap with the
+00008760: 2064 6566 696e 6564 2072 6563 7461 6e67   defined rectang
+00008770: 6c65 2e0a 2020 2020 2222 220a 2020 2020  le..    """.    
+00008780: 7265 7375 6c74 203d 2028 0a20 2020 2020  result = (.     
+00008790: 2020 2028 6262 6f78 6573 5b3a 2c20 305d     (bboxes[:, 0]
+000087a0: 203c 3d20 7269 6768 7429 0a20 2020 2020   <= right).     
+000087b0: 2020 2026 2028 6262 6f78 6573 5b3a 2c20     & (bboxes[:, 
+000087c0: 325d 203e 3d20 6c65 6674 290a 2020 2020  2] >= left).    
+000087d0: 2020 2020 2620 2862 626f 7865 735b 3a2c      & (bboxes[:,
+000087e0: 2031 5d20 3c3d 2074 6f70 290a 2020 2020   1] <= top).    
+000087f0: 2020 2020 2620 2862 626f 7865 735b 3a2c      & (bboxes[:,
+00008800: 2033 5d20 3e3d 2062 6f74 746f 6d29 0a20   3] >= bottom). 
+00008810: 2020 2029 0a20 2020 2072 6574 7572 6e20     ).    return 
+00008820: 7265 7375 6c74 0a0a 0a23 205f 6669 6e64  result...# _find
+00008830: 5f62 626f 7865 735f 6f6e 5f72 6563 745f  _bboxes_on_rect_
+00008840: 6564 6765 0a64 6566 205f 6669 6e64 5f62  edge.def _find_b
+00008850: 626f 7865 735f 6f6e 5f72 6563 745f 6564  boxes_on_rect_ed
+00008860: 6765 2862 626f 7865 732c 206c 6566 742c  ge(bboxes, left,
+00008870: 2062 6f74 746f 6d2c 2072 6967 6874 2c20   bottom, right, 
+00008880: 746f 7029 3a0a 2020 2020 2222 2247 6976  top):.    """Giv
+00008890: 656e 2061 206c 6973 7420 6f66 2070 6f6c  en a list of pol
+000088a0: 7967 6f6e 2062 6f75 6e64 696e 6720 626f  ygon bounding bo
+000088b0: 7865 7320 616e 6420 6120 7265 6374 616e  xes and a rectan
+000088c0: 6775 6c61 7220 626f 756e 6461 7279 0a20  gular boundary. 
+000088d0: 2020 2064 6566 696e 6564 2062 7920 6c65     defined by le
+000088e0: 6674 2f62 6f74 746f 6d2f 7269 6768 742f  ft/bottom/right/
+000088f0: 746f 702c 2074 6869 7320 6675 6e63 7469  top, this functi
+00008900: 6f6e 2072 6574 7572 6e73 2074 686f 7365  on returns those
+00008910: 2070 6f6c 7967 6f6e 730a 2020 2020 7768   polygons.    wh
+00008920: 6963 6820 696e 7465 7273 6563 7420 7468  ich intersect th
+00008930: 6520 7265 6374 616e 6775 6c61 7220 626f  e rectangular bo
+00008940: 756e 6461 7279 2e0a 0a20 2020 2050 6172  undary...    Par
+00008950: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+00008960: 2d2d 2d2d 2d2d 0a20 2020 2062 626f 7865  ------.    bboxe
+00008970: 7320 3a20 6c69 7374 0a20 2020 2020 2020  s : list.       
+00008980: 204c 6973 7420 6f66 2061 6c6c 2070 6f6c   List of all pol
+00008990: 7967 6f6e 2062 626f 7865 732e 0a20 2020  ygon bboxes..   
+000089a0: 206c 6566 7420 3a20 696e 7420 6f72 2066   left : int or f
+000089b0: 6c6f 6174 0a20 2020 2020 2020 2054 6865  loat.        The
+000089c0: 2078 2d63 6f6f 7264 696e 6174 6520 6f66   x-coordinate of
+000089d0: 2074 6865 206c 6566 7468 616e 6420 626f   the lefthand bo
+000089e0: 756e 6461 7279 2e0a 2020 2020 626f 7474  undary..    bott
+000089f0: 6f6d 203a 2069 6e74 206f 7220 666c 6f61  om : int or floa
+00008a00: 740a 2020 2020 2020 2020 5468 6520 792d  t.        The y-
+00008a10: 636f 6f72 6469 6e61 7465 206f 6620 7468  coordinate of th
+00008a20: 6520 626f 7474 6f6d 2062 6f75 6e64 6172  e bottom boundar
+00008a30: 792e 0a20 2020 2072 6967 6874 203a 2069  y..    right : i
+00008a40: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
+00008a50: 2020 2020 5468 6520 782d 636f 6f72 6469      The x-coordi
+00008a60: 6e61 7465 206f 6620 7468 6520 7269 6768  nate of the righ
+00008a70: 7468 616e 6420 626f 756e 6461 7279 2e0a  thand boundary..
+00008a80: 2020 2020 746f 7020 3a20 696e 7420 6f72      top : int or
+00008a90: 2066 6c6f 6174 0a20 2020 2020 2020 2054   float.        T
+00008aa0: 6865 2079 2d63 6f6f 7264 696e 6174 6520  he y-coordinate 
+00008ab0: 6f66 2074 6865 2074 6f70 2062 6f75 6e64  of the top bound
+00008ac0: 6172 792e 0a0a 2020 2020 5265 7475 726e  ary...    Return
+00008ad0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
+00008ae0: 2020 7265 7375 6c74 203a 206c 6973 740a    result : list.
+00008af0: 2020 2020 2020 2020 4c69 7374 206f 6620          List of 
+00008b00: 616c 6c20 706f 6c79 676f 6e20 6262 6f78  all polygon bbox
+00008b10: 6573 2074 6861 7420 696e 7465 7273 6563  es that intersec
+00008b20: 7420 7468 6520 6465 6669 6e65 6420 7265  t the defined re
+00008b30: 6374 616e 6775 6c61 720a 2020 2020 2020  ctangular.      
+00008b40: 2020 626f 756e 6461 7279 2e0a 2020 2020    boundary..    
+00008b50: 2222 220a 2020 2020 6262 6f78 6573 5f6c  """.    bboxes_l
+00008b60: 6566 7420 3d20 5f66 696e 645f 6262 6f78  eft = _find_bbox
+00008b70: 6573 5f69 6e5f 7265 6374 2862 626f 7865  es_in_rect(bboxe
+00008b80: 732c 206c 6566 742c 2062 6f74 746f 6d2c  s, left, bottom,
+00008b90: 206c 6566 742c 2074 6f70 290a 2020 2020   left, top).    
+00008ba0: 6262 6f78 6573 5f72 6967 6874 203d 205f  bboxes_right = _
+00008bb0: 6669 6e64 5f62 626f 7865 735f 696e 5f72  find_bboxes_in_r
+00008bc0: 6563 7428 6262 6f78 6573 2c20 7269 6768  ect(bboxes, righ
+00008bd0: 742c 2062 6f74 746f 6d2c 2072 6967 6874  t, bottom, right
+00008be0: 2c20 746f 7029 0a20 2020 2062 626f 7865  , top).    bboxe
+00008bf0: 735f 746f 7020 3d20 5f66 696e 645f 6262  s_top = _find_bb
+00008c00: 6f78 6573 5f69 6e5f 7265 6374 2862 626f  oxes_in_rect(bbo
+00008c10: 7865 732c 206c 6566 742c 2074 6f70 2c20  xes, left, top, 
+00008c20: 7269 6768 742c 2074 6f70 290a 2020 2020  right, top).    
+00008c30: 6262 6f78 6573 5f62 6f74 746f 6d20 3d20  bboxes_bottom = 
+00008c40: 5f66 696e 645f 6262 6f78 6573 5f69 6e5f  _find_bboxes_in_
+00008c50: 7265 6374 2862 626f 7865 732c 206c 6566  rect(bboxes, lef
+00008c60: 742c 2062 6f74 746f 6d2c 2072 6967 6874  t, bottom, right
+00008c70: 2c20 626f 7474 6f6d 290a 2020 2020 7265  , bottom).    re
+00008c80: 7375 6c74 203d 2062 626f 7865 735f 6c65  sult = bboxes_le
+00008c90: 6674 207c 2062 626f 7865 735f 7269 6768  ft | bboxes_righ
+00008ca0: 7420 7c20 6262 6f78 6573 5f74 6f70 207c  t | bboxes_top |
+00008cb0: 2062 626f 7865 735f 626f 7474 6f6d 0a20   bboxes_bottom. 
+00008cc0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+00008cd0: 0a0a 0a64 6566 205f 6f66 6673 6574 5f72  ...def _offset_r
+00008ce0: 6567 696f 6e28 0a20 2020 2061 6c6c 5f70  egion(.    all_p
+00008cf0: 6f6c 7967 6f6e 732c 0a20 2020 2062 626f  olygons,.    bbo
+00008d00: 7865 732c 0a20 2020 206c 6566 742c 0a20  xes,.    left,. 
+00008d10: 2020 2062 6f74 746f 6d2c 0a20 2020 2072     bottom,.    r
+00008d20: 6967 6874 2c0a 2020 2020 746f 702c 0a20  ight,.    top,. 
+00008d30: 2020 2064 6973 7461 6e63 653d 352c 0a20     distance=5,. 
+00008d40: 2020 206a 6f69 6e5f 6669 7273 743d 5472     join_first=Tr
+00008d50: 7565 2c0a 2020 2020 7072 6563 6973 696f  ue,.    precisio
+00008d60: 6e3d 3165 2d34 2c0a 2020 2020 6a6f 696e  n=1e-4,.    join
+00008d70: 3d22 6d69 7465 7222 2c0a 2020 2020 746f  ="miter",.    to
+00008d80: 6c65 7261 6e63 653d 322c 0a29 3a0a 2020  lerance=2,.):.  
+00008d90: 2020 2222 2254 616b 696e 6720 6120 7265    """Taking a re
+00008da0: 6769 6f6e 206f 6620 652e 672e 2073 697a  gion of e.g. siz
+00008db0: 6520 2878 2c20 7929 2077 6869 6368 206e  e (x, y) which n
+00008dc0: 6565 6473 2074 6f20 6265 206f 6666 7365  eeds to be offse
+00008dd0: 7420 6279 0a20 2020 2064 6973 7461 6e63  t by.    distanc
+00008de0: 6520 642c 2074 6869 7320 6675 6e63 7469  e d, this functi
+00008df0: 6f6e 2063 726f 7073 206f 7574 2061 2072  on crops out a r
+00008e00: 6567 696f 6e20 2878 2b32 2a64 2c20 792b  egion (x+2*d, y+
+00008e10: 322a 6429 206c 6172 6765 2c20 6f66 6673  2*d) large, offs
+00008e20: 6574 730a 2020 2020 7468 6174 2072 6567  ets.    that reg
+00008e30: 696f 6e2c 2074 6865 6e20 6372 6f70 7320  ion, then crops 
+00008e40: 6974 2062 6163 6b20 746f 2073 697a 6520  it back to size 
+00008e50: 2878 2c20 7929 2074 6f20 6372 6561 7465  (x, y) to create
+00008e60: 2061 2076 616c 6964 2072 6573 756c 742e   a valid result.
+00008e70: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00008e80: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+00008e90: 2020 2020 616c 6c5f 706f 6c79 676f 6e73      all_polygons
+00008ea0: 203a 2050 6f6c 7967 6f6e 5365 7420 6f72   : PolygonSet or
+00008eb0: 206c 6973 7420 6f66 2070 6f6c 7967 6f6e   list of polygon
+00008ec0: 730a 2020 2020 2020 2020 5365 7420 6f72  s.        Set or
+00008ed0: 206c 6973 7420 6f66 2070 6f6c 7967 6f6e   list of polygon
+00008ee0: 7320 746f 2062 6520 6372 6f70 7065 6420  s to be cropped 
+00008ef0: 616e 6420 6f66 6673 6574 2e0a 2020 2020  and offset..    
+00008f00: 6262 6f78 6573 203a 206c 6973 740a 2020  bboxes : list.  
+00008f10: 2020 2020 2020 4c69 7374 206f 6620 616c        List of al
+00008f20: 6c20 706f 6c79 676f 6e20 6262 6f78 6573  l polygon bboxes
+00008f30: 2069 6e20 616c 6c5f 706f 6c79 676f 6e73   in all_polygons
+00008f40: 2e0a 2020 2020 6c65 6674 203a 2069 6e74  ..    left : int
+00008f50: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
+00008f60: 2020 5468 6520 782d 636f 6f72 6469 6e61    The x-coordina
+00008f70: 7465 206f 6620 7468 6520 6c65 6674 6861  te of the leftha
+00008f80: 6e64 2062 6f75 6e64 6172 792e 0a20 2020  nd boundary..   
+00008f90: 2062 6f74 746f 6d20 3a20 696e 7420 6f72   bottom : int or
+00008fa0: 2066 6c6f 6174 0a20 2020 2020 2020 2054   float.        T
+00008fb0: 6865 2079 2d63 6f6f 7264 696e 6174 6520  he y-coordinate 
+00008fc0: 6f66 2074 6865 2062 6f74 746f 6d20 626f  of the bottom bo
+00008fd0: 756e 6461 7279 2e0a 2020 2020 7269 6768  undary..    righ
+00008fe0: 7420 3a20 696e 7420 6f72 2066 6c6f 6174  t : int or float
+00008ff0: 0a20 2020 2020 2020 2054 6865 2078 2d63  .        The x-c
+00009000: 6f6f 7264 696e 6174 6520 6f66 2074 6865  oordinate of the
+00009010: 2072 6967 6874 6861 6e64 2062 6f75 6e64   righthand bound
+00009020: 6172 792e 0a20 2020 2074 6f70 203a 2069  ary..    top : i
+00009030: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
+00009040: 2020 2020 5468 6520 792d 636f 6f72 6469      The y-coordi
+00009050: 6e61 7465 206f 6620 7468 6520 746f 7020  nate of the top 
+00009060: 626f 756e 6461 7279 2e0a 2020 2020 6469  boundary..    di
+00009070: 7374 616e 6365 203a 2069 6e74 206f 7220  stance : int or 
+00009080: 666c 6f61 740a 2020 2020 2020 2020 4469  float.        Di
+00009090: 7374 616e 6365 2074 6f20 6f66 6673 6574  stance to offset
+000090a0: 2070 6f6c 7967 6f6e 732e 2050 6f73 6974   polygons. Posit
+000090b0: 6976 6520 7661 6c75 6573 2065 7870 616e  ive values expan
+000090c0: 642c 206e 6567 6174 6976 6520 7368 7269  d, negative shri
+000090d0: 6e6b 2e0a 2020 2020 6a6f 696e 5f66 6972  nk..    join_fir
+000090e0: 7374 203a 2062 6f6f 6c0a 2020 2020 2020  st : bool.      
+000090f0: 2020 4a6f 696e 2061 6c6c 2070 6174 6873    Join all paths
+00009100: 2062 6566 6f72 6520 6f66 6673 6574 7469   before offsetti
+00009110: 6e67 2074 6f20 6176 6f69 6420 756e 6e65  ng to avoid unne
+00009120: 6365 7373 6172 7920 6a6f 696e 7320 696e  cessary joins in
+00009130: 0a20 2020 2020 2020 2061 646a 6163 656e  .        adjacen
+00009140: 7420 706f 6c79 676f 6e20 7369 6465 732e  t polygon sides.
+00009150: 0a20 2020 2070 7265 6369 7369 6f6e 203a  .    precision :
+00009160: 2066 6c6f 6174 0a20 2020 2020 2020 2044   float.        D
+00009170: 6573 6972 6564 2070 7265 6369 7369 6f6e  esired precision
+00009180: 2066 6f72 2072 6f75 6e64 696e 6720 7665   for rounding ve
+00009190: 7274 6578 2063 6f6f 7264 696e 6174 6573  rtex coordinates
+000091a0: 2e0a 2020 2020 6a6f 696e 203a 207b 276d  ..    join : {'m
+000091b0: 6974 6572 272c 2027 6265 7665 6c27 2c20  iter', 'bevel', 
+000091c0: 2772 6f75 6e64 277d 0a20 2020 2020 2020  'round'}.       
+000091d0: 2054 7970 6520 6f66 206a 6f69 6e20 7573   Type of join us
+000091e0: 6564 2074 6f20 6372 6561 7465 2074 6865  ed to create the
+000091f0: 206f 6666 7365 7420 706f 6c79 676f 6e2e   offset polygon.
+00009200: 0a20 2020 2074 6f6c 6572 616e 6365 203a  .    tolerance :
+00009210: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
+00009220: 2020 2020 2020 466f 7220 6d69 7465 7220        For miter 
+00009230: 6a6f 696e 7473 2c20 7468 6973 206e 756d  joints, this num
+00009240: 6265 7220 6d75 7374 2062 6520 6174 206c  ber must be at l
+00009250: 6561 7374 2032 2061 6e64 2069 7420 7265  east 2 and it re
+00009260: 7072 6573 656e 7473 2074 6865 0a20 2020  presents the.   
+00009270: 2020 2020 206d 6178 696d 616c 2064 6973       maximal dis
+00009280: 7461 6e63 6520 696e 206d 756c 7469 706c  tance in multipl
+00009290: 6573 206f 6620 6f66 6673 6574 2062 6574  es of offset bet
+000092a0: 7765 656e 206e 6577 2076 6572 7469 6365  ween new vertice
+000092b0: 7320 616e 6420 7468 6569 720a 2020 2020  s and their.    
+000092c0: 2020 2020 6f72 6967 696e 616c 2070 6f73      original pos
+000092d0: 6974 696f 6e20 6265 666f 7265 2062 6576  ition before bev
+000092e0: 656c 696e 6720 746f 2061 766f 6964 2073  eling to avoid s
+000092f0: 7069 6b65 7320 6174 2061 6375 7465 206a  pikes at acute j
+00009300: 6f69 6e74 732e 2046 6f72 0a20 2020 2020  oints. For.     
+00009310: 2020 2072 6f75 6e64 206a 6f69 6e74 732c     round joints,
+00009320: 2069 7420 696e 6469 6361 7465 7320 7468   it indicates th
+00009330: 6520 6375 7276 6174 7572 6520 7265 736f  e curvature reso
+00009340: 6c75 7469 6f6e 2069 6e20 6e75 6d62 6572  lution in number
+00009350: 206f 660a 2020 2020 2020 2020 706f 696e   of.        poin
+00009360: 7473 2070 6572 2066 756c 6c20 6369 7263  ts per full circ
+00009370: 6c65 2e0a 0a20 2020 2052 6574 7572 6e73  le...    Returns
+00009380: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+00009390: 2070 6f6c 7967 6f6e 735f 6f66 6673 6574   polygons_offset
+000093a0: 5f63 726f 7070 6564 203a 0a20 2020 2020  _cropped :.     
+000093b0: 2020 2054 6865 2072 6573 756c 7469 6e67     The resulting
+000093c0: 2069 6e70 7574 2070 6f6c 7967 6f6e 7320   input polygons 
+000093d0: 7468 6174 2061 7265 2063 726f 7070 6564  that are cropped
+000093e0: 2074 6f20 6265 2062 6574 7765 656e 2074   to be between t
+000093f0: 6865 0a20 2020 2020 2020 2063 6f6f 7264  he.        coord
+00009400: 696e 6174 6573 2028 6c65 6674 2c20 626f  inates (left, bo
+00009410: 7474 6f6d 2c20 7269 6768 742c 2074 6f70  ttom, right, top
+00009420: 290a 0a20 2020 2022 2222 0a0a 2020 2020  )..    """..    
+00009430: 2320 4d61 726b 206f 7574 2061 2072 6567  # Mark out a reg
+00009440: 696f 6e20 736c 6967 6874 6c79 206c 6172  ion slightly lar
+00009450: 6765 7220 7468 616e 2074 6865 2066 696e  ger than the fin
+00009460: 616c 2064 6573 6972 6564 2072 6567 696f  al desired regio
+00009470: 6e0a 2020 2020 6420 3d20 6469 7374 616e  n.    d = distan
+00009480: 6365 202a 2031 2e30 310a 0a20 2020 2070  ce * 1.01..    p
+00009490: 6f6c 7967 6f6e 735f 746f 5f6f 6666 7365  olygons_to_offse
+000094a0: 7420 3d20 5f63 726f 705f 6564 6765 5f70  t = _crop_edge_p
+000094b0: 6f6c 7967 6f6e 7328 0a20 2020 2020 2020  olygons(.       
+000094c0: 2061 6c6c 5f70 6f6c 7967 6f6e 732c 0a20   all_polygons,. 
+000094d0: 2020 2020 2020 2062 626f 7865 732c 0a20         bboxes,. 
+000094e0: 2020 2020 2020 206c 6566 7420 2d20 642c         left - d,
+000094f0: 0a20 2020 2020 2020 2062 6f74 746f 6d20  .        bottom 
+00009500: 2d20 642c 0a20 2020 2020 2020 2072 6967  - d,.        rig
+00009510: 6874 202b 2064 2c0a 2020 2020 2020 2020  ht + d,.        
+00009520: 746f 7020 2b20 642c 0a20 2020 2020 2020  top + d,.       
+00009530: 2070 7265 6369 7369 6f6e 3d70 7265 6369   precision=preci
+00009540: 7369 6f6e 2c0a 2020 2020 290a 0a20 2020  sion,.    )..   
+00009550: 2023 204f 6666 7365 7420 7468 6520 7265   # Offset the re
+00009560: 7375 6c74 696e 6720 6372 6f70 7065 6420  sulting cropped 
+00009570: 706f 6c79 676f 6e73 2061 6e64 2072 6563  polygons and rec
+00009580: 726f 7020 746f 2066 696e 616c 2064 6573  rop to final des
+00009590: 6972 6564 2073 697a 650a 2020 2020 706f  ired size.    po
+000095a0: 6c79 676f 6e73 5f6f 6666 7365 7420 3d20  lygons_offset = 
+000095b0: 636c 6970 7065 722e 6f66 6673 6574 280a  clipper.offset(.
+000095c0: 2020 2020 2020 2020 706f 6c79 676f 6e73          polygons
+000095d0: 5f74 6f5f 6f66 6673 6574 2c20 6469 7374  _to_offset, dist
+000095e0: 616e 6365 2c20 6a6f 696e 2c20 746f 6c65  ance, join, tole
+000095f0: 7261 6e63 652c 2031 202f 2070 7265 6369  rance, 1 / preci
+00009600: 7369 6f6e 2c20 696e 7428 6a6f 696e 5f66  sion, int(join_f
+00009610: 6972 7374 290a 2020 2020 290a 2020 2020  irst).    ).    
+00009620: 706f 6c79 676f 6e73 5f6f 6666 7365 745f  polygons_offset_
+00009630: 6372 6f70 7065 6420 3d20 5f63 726f 705f  cropped = _crop_
+00009640: 7265 6769 6f6e 280a 2020 2020 2020 2020  region(.        
+00009650: 706f 6c79 676f 6e73 5f6f 6666 7365 742c  polygons_offset,
+00009660: 206c 6566 742c 2062 6f74 746f 6d2c 2072   left, bottom, r
+00009670: 6967 6874 2c20 746f 702c 2070 7265 6369  ight, top, preci
+00009680: 7369 6f6e 3d70 7265 6369 7369 6f6e 0a20  sion=precision. 
+00009690: 2020 2029 0a0a 2020 2020 7265 7475 726e     )..    return
+000096a0: 2070 6f6c 7967 6f6e 735f 6f66 6673 6574   polygons_offset
+000096b0: 5f63 726f 7070 6564 0a0a 0a64 6566 205f  _cropped...def _
+000096c0: 706f 6c79 676f 6e73 5f74 6f5f 6262 6f78  polygons_to_bbox
+000096d0: 6573 2870 6f6c 7967 6f6e 7329 3a0a 2020  es(polygons):.  
+000096e0: 2020 2222 2247 656e 6572 6174 6573 2074    """Generates t
+000096f0: 6865 2062 626f 7865 7320 6f66 2061 6c6c  he bboxes of all
+00009700: 2069 6e70 7574 2070 6f6c 7967 6f6e 732e   input polygons.
+00009710: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00009720: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+00009730: 2020 2020 706f 6c79 676f 6e73 203a 2050      polygons : P
+00009740: 6f6c 7967 6f6e 5365 7420 6f72 206c 6973  olygonSet or lis
+00009750: 7420 6f66 2070 6f6c 7967 6f6e 730a 2020  t of polygons.  
+00009760: 2020 2020 2020 5365 7420 6f72 206c 6973        Set or lis
+00009770: 7420 6f66 2070 6f6c 7967 6f6e 7320 746f  t of polygons to
+00009780: 2067 656e 6572 6174 6520 6262 6f78 6573   generate bboxes
+00009790: 206f 662e 0a0a 2020 2020 5265 7475 726e   of...    Return
+000097a0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
+000097b0: 2020 6262 6f78 6573 203a 206c 6973 740a    bboxes : list.
+000097c0: 2020 2020 2020 2020 4c69 7374 206f 6620          List of 
+000097d0: 616c 6c20 706f 6c79 676f 6e20 6262 6f78  all polygon bbox
+000097e0: 6573 2069 6e20 706f 6c79 676f 6e73 2e0a  es in polygons..
+000097f0: 2020 2020 2222 220a 2020 2020 2320 2020      """.    #   
+00009800: 2042 7569 6c64 2062 6f75 6e64 696e 6720   Build bounding 
+00009810: 626f 7865 730a 2020 2020 6262 6f78 6573  boxes.    bboxes
+00009820: 203d 206e 702e 656d 7074 7928 5b6c 656e   = np.empty([len
+00009830: 2870 6f6c 7967 6f6e 7329 2c20 345d 290a  (polygons), 4]).
+00009840: 2020 2020 666f 7220 6e2c 2070 2069 6e20      for n, p in 
+00009850: 656e 756d 6572 6174 6528 706f 6c79 676f  enumerate(polygo
+00009860: 6e73 293a 0a20 2020 2020 2020 206c 6566  ns):.        lef
+00009870: 742c 2062 6f74 746f 6d20 3d20 6e70 2e6d  t, bottom = np.m
+00009880: 696e 2870 2c20 6178 6973 3d30 290a 2020  in(p, axis=0).  
+00009890: 2020 2020 2020 7269 6768 742c 2074 6f70        right, top
+000098a0: 203d 206e 702e 6d61 7828 702c 2061 7869   = np.max(p, axi
+000098b0: 733d 3029 0a20 2020 2020 2020 2062 626f  s=0).        bbo
+000098c0: 7865 735b 6e5d 203d 205b 6c65 6674 2c20  xes[n] = [left, 
+000098d0: 626f 7474 6f6d 2c20 7269 6768 742c 2074  bottom, right, t
+000098e0: 6f70 5d0a 2020 2020 7265 7475 726e 2062  op].    return b
+000098f0: 626f 7865 730a 0a0a 6465 6620 5f6f 6666  boxes...def _off
+00009900: 7365 745f 706f 6c79 676f 6e73 5f70 6172  set_polygons_par
+00009910: 616c 6c65 6c28 0a20 2020 2070 6f6c 7967  allel(.    polyg
+00009920: 6f6e 732c 0a20 2020 2064 6973 7461 6e63  ons,.    distanc
+00009930: 653d 352c 0a20 2020 206e 756d 5f64 6976  e=5,.    num_div
+00009940: 6973 696f 6e73 3d5b 3130 2c20 3130 5d2c  isions=[10, 10],
+00009950: 0a20 2020 206a 6f69 6e5f 6669 7273 743d  .    join_first=
+00009960: 5472 7565 2c0a 2020 2020 7072 6563 6973  True,.    precis
+00009970: 696f 6e3d 3165 2d34 2c0a 2020 2020 6a6f  ion=1e-4,.    jo
+00009980: 696e 3d22 6d69 7465 7222 2c0a 2020 2020  in="miter",.    
+00009990: 746f 6c65 7261 6e63 653d 322c 0a29 3a0a  tolerance=2,.):.
+000099a0: 2020 2020 2222 2250 6572 666f 726d 7320      """Performs 
+000099b0: 7468 6520 6f66 6673 6574 2066 756e 6374  the offset funct
+000099c0: 696f 6e20 6f6e 2061 206c 6973 7420 6f66  ion on a list of
+000099d0: 2073 7562 7365 6374 696f 6e73 206f 6620   subsections of 
+000099e0: 7468 6520 6f72 6967 696e 616c 0a20 2020  the original.   
+000099f0: 2067 656f 6d65 7472 790a 0a20 2020 2050   geometry..    P
+00009a00: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+00009a10: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2070 6f6c  --------.    pol
+00009a20: 7967 6f6e 7320 3a20 506f 6c79 676f 6e53  ygons : PolygonS
+00009a30: 6574 206f 7220 6c69 7374 206f 6620 706f  et or list of po
+00009a40: 6c79 676f 6e73 0a0a 2020 2020 6469 7374  lygons..    dist
+00009a50: 616e 6365 203a 2069 6e74 206f 7220 666c  ance : int or fl
+00009a60: 6f61 740a 2020 2020 2020 2020 4469 7374  oat.        Dist
+00009a70: 616e 6365 2074 6f20 6f66 6673 6574 2070  ance to offset p
+00009a80: 6f6c 7967 6f6e 732e 2050 6f73 6974 6976  olygons. Positiv
+00009a90: 6520 7661 6c75 6573 2065 7870 616e 642c  e values expand,
+00009aa0: 206e 6567 6174 6976 6520 7368 7269 6e6b   negative shrink
+00009ab0: 2e0a 2020 2020 6e75 6d5f 6469 7669 7369  ..    num_divisi
+00009ac0: 6f6e 7320 3a20 6172 7261 792d 6c69 6b65  ons : array-like
+00009ad0: 5b32 5d20 6f66 2069 6e74 0a20 2020 2020  [2] of int.     
+00009ae0: 2020 2054 6865 206e 756d 6265 7220 6f66     The number of
+00009af0: 2064 6976 6973 696f 6e73 2077 6974 6820   divisions with 
+00009b00: 7768 6963 6820 7468 6520 6765 6f6d 6574  which the geomet
+00009b10: 7279 2069 7320 6469 7669 6465 6420 696e  ry is divided in
+00009b20: 746f 0a20 2020 2020 2020 206d 756c 7469  to.        multi
+00009b30: 706c 6520 7265 6374 616e 6775 6c61 7220  ple rectangular 
+00009b40: 7265 6769 6f6e 732e 2054 6869 7320 616c  regions. This al
+00009b50: 6c6f 7773 2066 6f72 2065 6163 6820 7265  lows for each re
+00009b60: 6769 6f6e 2074 6f20 6265 0a20 2020 2020  gion to be.     
+00009b70: 2020 2070 726f 6365 7373 6564 2073 6571     processed seq
+00009b80: 7565 6e74 6961 6c6c 792c 2077 6869 6368  uentially, which
+00009b90: 2069 7320 6d6f 7265 2063 6f6d 7075 7461   is more computa
+00009ba0: 7469 6f6e 616c 6c79 2065 6666 6963 6965  tionally efficie
+00009bb0: 6e74 2e0a 2020 2020 6a6f 696e 5f66 6972  nt..    join_fir
+00009bc0: 7374 203a 2062 6f6f 6c0a 2020 2020 2020  st : bool.      
+00009bd0: 2020 4a6f 696e 2061 6c6c 2070 6174 6873    Join all paths
+00009be0: 2062 6566 6f72 6520 6f66 6673 6574 7469   before offsetti
+00009bf0: 6e67 2074 6f20 6176 6f69 6420 756e 6e65  ng to avoid unne
+00009c00: 6365 7373 6172 7920 6a6f 696e 7320 696e  cessary joins in
+00009c10: 0a20 2020 2020 2020 2061 646a 6163 656e  .        adjacen
+00009c20: 7420 706f 6c79 676f 6e20 7369 6465 732e  t polygon sides.
+00009c30: 0a20 2020 2070 7265 6369 7369 6f6e 203a  .    precision :
+00009c40: 2066 6c6f 6174 0a20 2020 2020 2020 2044   float.        D
+00009c50: 6573 6972 6564 2070 7265 6369 7369 6f6e  esired precision
+00009c60: 2066 6f72 2072 6f75 6e64 696e 6720 7665   for rounding ve
+00009c70: 7274 6578 2063 6f6f 7264 696e 6174 6573  rtex coordinates
+00009c80: 2e0a 2020 2020 6a6f 696e 203a 207b 276d  ..    join : {'m
+00009c90: 6974 6572 272c 2027 6265 7665 6c27 2c20  iter', 'bevel', 
+00009ca0: 2772 6f75 6e64 277d 0a20 2020 2020 2020  'round'}.       
+00009cb0: 2054 7970 6520 6f66 206a 6f69 6e20 7573   Type of join us
+00009cc0: 6564 2074 6f20 6372 6561 7465 2074 6865  ed to create the
+00009cd0: 206f 6666 7365 7420 706f 6c79 676f 6e2e   offset polygon.
+00009ce0: 0a20 2020 2074 6f6c 6572 616e 6365 203a  .    tolerance :
+00009cf0: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
+00009d00: 2020 2020 2020 466f 7220 6d69 7465 7220        For miter 
+00009d10: 6a6f 696e 7473 2c20 7468 6973 206e 756d  joints, this num
+00009d20: 6265 7220 6d75 7374 2062 6520 6174 206c  ber must be at l
+00009d30: 6561 7374 2032 2061 6e64 2069 7420 7265  east 2 and it re
+00009d40: 7072 6573 656e 7473 2074 6865 0a20 2020  presents the.   
+00009d50: 2020 2020 206d 6178 696d 616c 2064 6973       maximal dis
+00009d60: 7461 6e63 6520 696e 206d 756c 7469 706c  tance in multipl
+00009d70: 6573 206f 6620 6f66 6673 6574 2062 6574  es of offset bet
+00009d80: 7765 656e 206e 6577 2076 6572 7469 6365  ween new vertice
+00009d90: 7320 616e 6420 7468 6569 720a 2020 2020  s and their.    
+00009da0: 2020 2020 6f72 6967 696e 616c 2070 6f73      original pos
+00009db0: 6974 696f 6e20 6265 666f 7265 2062 6576  ition before bev
+00009dc0: 656c 696e 6720 746f 2061 766f 6964 2073  eling to avoid s
+00009dd0: 7069 6b65 7320 6174 2061 6375 7465 206a  pikes at acute j
+00009de0: 6f69 6e74 732e 2046 6f72 0a20 2020 2020  oints. For.     
+00009df0: 2020 2072 6f75 6e64 206a 6f69 6e74 732c     round joints,
+00009e00: 2069 7420 696e 6469 6361 7465 7320 7468   it indicates th
+00009e10: 6520 6375 7276 6174 7572 6520 7265 736f  e curvature reso
+00009e20: 6c75 7469 6f6e 2069 6e20 6e75 6d62 6572  lution in number
+00009e30: 206f 660a 2020 2020 2020 2020 706f 696e   of.        poin
+00009e40: 7473 2070 6572 2066 756c 6c20 6369 7263  ts per full circ
+00009e50: 6c65 2e0a 0a20 2020 2052 6574 7572 6e73  le...    Returns
+00009e60: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+00009e70: 206f 6666 7365 745f 706f 6c79 676f 6e73   offset_polygons
+00009e80: 203a 0a0a 2020 2020 2222 220a 2020 2020   :..    """.    
+00009e90: 2320 4275 696c 6420 626f 756e 6469 6e67  # Build bounding
+00009ea0: 2062 6f78 6573 0a20 2020 2070 6f6c 7967   boxes.    polyg
+00009eb0: 6f6e 7320 3d20 6e70 2e61 7361 7272 6179  ons = np.asarray
+00009ec0: 2870 6f6c 7967 6f6e 7329 0a20 2020 2062  (polygons).    b
+00009ed0: 626f 7865 7320 3d20 5f70 6f6c 7967 6f6e  boxes = _polygon
+00009ee0: 735f 746f 5f62 626f 7865 7328 706f 6c79  s_to_bboxes(poly
+00009ef0: 676f 6e73 290a 0a20 2020 2078 6d69 6e2c  gons)..    xmin,
+00009f00: 2079 6d69 6e20 3d20 6e70 2e6d 696e 2862   ymin = np.min(b
+00009f10: 626f 7865 735b 3a2c 2030 3a32 5d2c 2061  boxes[:, 0:2], a
+00009f20: 7869 733d 3029 202d 2064 6973 7461 6e63  xis=0) - distanc
+00009f30: 650a 2020 2020 786d 6178 2c20 796d 6178  e.    xmax, ymax
+00009f40: 203d 206e 702e 6d61 7828 6262 6f78 6573   = np.max(bboxes
+00009f50: 5b3a 2c20 323a 345d 2c20 6178 6973 3d30  [:, 2:4], axis=0
+00009f60: 2920 2b20 6469 7374 616e 6365 0a0a 2020  ) + distance..  
+00009f70: 2020 7873 697a 6520 3d20 786d 6178 202d    xsize = xmax -
+00009f80: 2078 6d69 6e0a 2020 2020 7973 697a 6520   xmin.    ysize 
+00009f90: 3d20 796d 6178 202d 2079 6d69 6e0a 2020  = ymax - ymin.  
+00009fa0: 2020 7864 656c 7461 203d 2078 7369 7a65    xdelta = xsize
 00009fb0: 202f 206e 756d 5f64 6976 6973 696f 6e73   / num_divisions
-00009fc0: 5b31 5d0a 2020 2020 7863 6f72 6e65 7273  [1].    xcorners
-00009fd0: 203d 2078 6d69 6e20 2b20 6e70 2e61 7261   = xmin + np.ara
-00009fe0: 6e67 6528 6e75 6d5f 6469 7669 7369 6f6e  nge(num_division
-00009ff0: 735b 305d 2920 2a20 7864 656c 7461 0a20  s[0]) * xdelta. 
-0000a000: 2020 2079 636f 726e 6572 7320 3d20 796d     ycorners = ym
-0000a010: 696e 202b 206e 702e 6172 616e 6765 286e  in + np.arange(n
-0000a020: 756d 5f64 6976 6973 696f 6e73 5b31 5d29  um_divisions[1])
-0000a030: 202a 2079 6465 6c74 610a 0a20 2020 206f   * ydelta..    o
-0000a040: 6666 7365 745f 706f 6c79 676f 6e73 203d  ffset_polygons =
-0000a050: 205b 5d0a 2020 2020 666f 7220 6e2c 2078   [].    for n, x
-0000a060: 6320 696e 2065 6e75 6d65 7261 7465 2878  c in enumerate(x
-0000a070: 636f 726e 6572 7329 3a0a 2020 2020 2020  corners):.      
-0000a080: 2020 666f 7220 6d2c 2079 6320 696e 2065    for m, yc in e
-0000a090: 6e75 6d65 7261 7465 2879 636f 726e 6572  numerate(ycorner
-0000a0a0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0000a0b0: 6c65 6674 203d 2078 630a 2020 2020 2020  left = xc.      
-0000a0c0: 2020 2020 2020 7269 6768 7420 3d20 7863        right = xc
-0000a0d0: 202b 2078 6465 6c74 610a 2020 2020 2020   + xdelta.      
-0000a0e0: 2020 2020 2020 626f 7474 6f6d 203d 2079        bottom = y
-0000a0f0: 630a 2020 2020 2020 2020 2020 2020 746f  c.            to
-0000a100: 7020 3d20 7963 202b 2079 6465 6c74 610a  p = yc + ydelta.
-0000a110: 2020 2020 2020 2020 2020 2020 5f6f 6666              _off
-0000a120: 7365 745f 7265 6769 6f6e 5f70 6f6c 7967  set_region_polyg
-0000a130: 6f6e 7320 3d20 5f6f 6666 7365 745f 7265  ons = _offset_re
-0000a140: 6769 6f6e 280a 2020 2020 2020 2020 2020  gion(.          
-0000a150: 2020 2020 2020 706f 6c79 676f 6e73 2c0a        polygons,.
-0000a160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a170: 6262 6f78 6573 2c0a 2020 2020 2020 2020  bboxes,.        
-0000a180: 2020 2020 2020 2020 6c65 6674 2c0a 2020          left,.  
-0000a190: 2020 2020 2020 2020 2020 2020 2020 626f                bo
-0000a1a0: 7474 6f6d 2c0a 2020 2020 2020 2020 2020  ttom,.          
-0000a1b0: 2020 2020 2020 7269 6768 742c 0a20 2020        right,.   
-0000a1c0: 2020 2020 2020 2020 2020 2020 2074 6f70               top
-0000a1d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a1e0: 2020 6469 7374 616e 6365 3d64 6973 7461    distance=dista
-0000a1f0: 6e63 652c 0a20 2020 2020 2020 2020 2020  nce,.           
-0000a200: 2020 2020 206a 6f69 6e5f 6669 7273 743d       join_first=
-0000a210: 6a6f 696e 5f66 6972 7374 2c0a 2020 2020  join_first,.    
-0000a220: 2020 2020 2020 2020 2020 2020 7072 6563              prec
-0000a230: 6973 696f 6e3d 7072 6563 6973 696f 6e2c  ision=precision,
-0000a240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a250: 206a 6f69 6e3d 6a6f 696e 2c0a 2020 2020   join=join,.    
-0000a260: 2020 2020 2020 2020 2020 2020 746f 6c65              tole
-0000a270: 7261 6e63 653d 746f 6c65 7261 6e63 652c  rance=tolerance,
-0000a280: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0000a290: 2020 2020 2020 2020 2020 206f 6666 7365             offse
-0000a2a0: 745f 706f 6c79 676f 6e73 202b 3d20 5f6f  t_polygons += _o
-0000a2b0: 6666 7365 745f 7265 6769 6f6e 5f70 6f6c  ffset_region_pol
-0000a2c0: 7967 6f6e 730a 0a20 2020 2072 6574 7572  ygons..    retur
-0000a2d0: 6e20 6f66 6673 6574 5f70 6f6c 7967 6f6e  n offset_polygon
-0000a2e0: 730a 0a0a 6465 6620 5f62 6f6f 6c65 616e  s...def _boolean
-0000a2f0: 5f72 6567 696f 6e28 0a20 2020 2061 6c6c  _region(.    all
-0000a300: 5f70 6f6c 7967 6f6e 735f 412c 0a20 2020  _polygons_A,.   
-0000a310: 2061 6c6c 5f70 6f6c 7967 6f6e 735f 422c   all_polygons_B,
-0000a320: 0a20 2020 2062 626f 7865 735f 412c 0a20  .    bboxes_A,. 
-0000a330: 2020 2062 626f 7865 735f 422c 0a20 2020     bboxes_B,.   
-0000a340: 206c 6566 742c 0a20 2020 2062 6f74 746f   left,.    botto
-0000a350: 6d2c 0a20 2020 2072 6967 6874 2c0a 2020  m,.    right,.  
-0000a360: 2020 746f 702c 0a20 2020 206f 7065 7261    top,.    opera
-0000a370: 7469 6f6e 3d22 616e 6422 2c0a 2020 2020  tion="and",.    
-0000a380: 7072 6563 6973 696f 6e3d 3165 2d34 2c0a  precision=1e-4,.
-0000a390: 293a 0a20 2020 2022 2222 5461 6b69 6e67  ):.    """Taking
-0000a3a0: 2061 2072 6567 696f 6e20 6f66 2065 2e67   a region of e.g
-0000a3b0: 2e20 7369 7a65 2028 782c 2079 2920 7768  . size (x, y) wh
-0000a3c0: 6963 6820 6e65 6564 7320 746f 2062 6520  ich needs to be 
-0000a3d0: 626f 6f6c 6561 6e65 642c 0a20 2020 2074  booleaned,.    t
-0000a3e0: 6869 7320 6675 6e63 7469 6f6e 2063 726f  his function cro
-0000a3f0: 7073 206f 7574 2061 2072 6567 696f 6e20  ps out a region 
-0000a400: 2878 2c20 7929 206c 6172 6765 2066 726f  (x, y) large fro
-0000a410: 6d20 6561 6368 2073 6574 206f 6620 706f  m each set of po
-0000a420: 6c79 676f 6e73 0a20 2020 2028 4120 616e  lygons.    (A an
-0000a430: 6420 4229 2c20 626f 6f6c 6561 6e73 2074  d B), booleans t
-0000a440: 6861 7420 6372 6f70 7065 6420 7265 6769  hat cropped regi
-0000a450: 6f6e 2061 6e64 2072 6574 7572 6e73 2074  on and returns t
-0000a460: 6865 2072 6573 756c 742e 0a0a 2020 2020  he result...    
-0000a470: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-0000a480: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 616c  ---------.    al
-0000a490: 6c5f 706f 6c79 676f 6e73 5f41 203a 2050  l_polygons_A : P
-0000a4a0: 6f6c 7967 6f6e 5365 7420 6f72 206c 6973  olygonSet or lis
-0000a4b0: 7420 6f66 2070 6f6c 7967 6f6e 730a 2020  t of polygons.  
-0000a4c0: 2020 2020 2020 5365 7420 6f72 206c 6973        Set or lis
-0000a4d0: 7420 6f66 2070 6f6c 7967 6f6e 7320 746f  t of polygons to
-0000a4e0: 2062 6520 626f 6f6c 6561 6e65 642e 0a20   be booleaned.. 
-0000a4f0: 2020 2061 6c6c 5f70 6f6c 7967 6f6e 735f     all_polygons_
-0000a500: 4220 3a20 506f 6c79 676f 6e53 6574 206f  B : PolygonSet o
-0000a510: 7220 6c69 7374 206f 6620 706f 6c79 676f  r list of polygo
-0000a520: 6e73 0a20 2020 2020 2020 2053 6574 206f  ns.        Set o
-0000a530: 7220 6c69 7374 206f 6620 706f 6c79 676f  r list of polygo
-0000a540: 6e73 2074 6f20 6265 2062 6f6f 6c65 616e  ns to be boolean
-0000a550: 6564 2e0a 2020 2020 6262 6f78 6573 5f41  ed..    bboxes_A
-0000a560: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
-0000a570: 4c69 7374 206f 6620 616c 6c20 706f 6c79  List of all poly
-0000a580: 676f 6e20 6262 6f78 6573 2069 6e20 616c  gon bboxes in al
-0000a590: 6c5f 706f 6c79 676f 6e73 5f41 0a20 2020  l_polygons_A.   
-0000a5a0: 2062 626f 7865 735f 4220 3a20 6c69 7374   bboxes_B : list
-0000a5b0: 0a20 2020 2020 2020 204c 6973 7420 6f66  .        List of
-0000a5c0: 2061 6c6c 2070 6f6c 7967 6f6e 2062 626f   all polygon bbo
-0000a5d0: 7865 7320 696e 2061 6c6c 5f70 6f6c 7967  xes in all_polyg
-0000a5e0: 6f6e 735f 420a 2020 2020 6c65 6674 203a  ons_B.    left :
-0000a5f0: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
-0000a600: 2020 2020 2020 5468 6520 782d 636f 6f72        The x-coor
-0000a610: 6469 6e61 7465 206f 6620 7468 6520 6c65  dinate of the le
-0000a620: 6674 6861 6e64 2062 6f75 6e64 6172 792e  fthand boundary.
-0000a630: 0a20 2020 2062 6f74 746f 6d20 3a20 696e  .    bottom : in
-0000a640: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
-0000a650: 2020 2054 6865 2079 2d63 6f6f 7264 696e     The y-coordin
-0000a660: 6174 6520 6f66 2074 6865 2062 6f74 746f  ate of the botto
-0000a670: 6d20 626f 756e 6461 7279 2e0a 2020 2020  m boundary..    
-0000a680: 7269 6768 7420 3a20 696e 7420 6f72 2066  right : int or f
-0000a690: 6c6f 6174 0a20 2020 2020 2020 2054 6865  loat.        The
-0000a6a0: 2078 2d63 6f6f 7264 696e 6174 6520 6f66   x-coordinate of
-0000a6b0: 2074 6865 2072 6967 6874 6861 6e64 2062   the righthand b
-0000a6c0: 6f75 6e64 6172 792e 0a20 2020 2074 6f70  oundary..    top
-0000a6d0: 203a 2069 6e74 206f 7220 666c 6f61 740a   : int or float.
-0000a6e0: 2020 2020 2020 2020 5468 6520 792d 636f          The y-co
-0000a6f0: 6f72 6469 6e61 7465 206f 6620 7468 6520  ordinate of the 
-0000a700: 746f 7020 626f 756e 6461 7279 2e0a 2020  top boundary..  
-0000a710: 2020 6f70 6572 6174 696f 6e20 3a20 7b27    operation : {'
-0000a720: 6e6f 7427 2c20 2761 6e64 272c 2027 6f72  not', 'and', 'or
-0000a730: 272c 2027 786f 7227 2c20 2741 2d42 272c  ', 'xor', 'A-B',
-0000a740: 2027 422d 4127 2c20 2741 2b42 277d 0a20   'B-A', 'A+B'}. 
-0000a750: 2020 2020 2020 2042 6f6f 6c65 616e 206f         Boolean o
-0000a760: 7065 7261 7469 6f6e 2074 6f20 7065 7266  peration to perf
-0000a770: 6f72 6d2e 0a20 2020 2070 7265 6369 7369  orm..    precisi
-0000a780: 6f6e 203a 2066 6c6f 6174 0a20 2020 2020  on : float.     
-0000a790: 2020 2044 6573 6972 6564 2070 7265 6369     Desired preci
-0000a7a0: 7369 6f6e 2066 6f72 2072 6f75 6e64 696e  sion for roundin
-0000a7b0: 6720 7665 7274 6578 2063 6f6f 7264 696e  g vertex coordin
-0000a7c0: 6174 6573 2e0a 0a20 2020 2052 6574 7572  ates...    Retur
-0000a7d0: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-0000a7e0: 2020 2070 6f6c 7967 6f6e 735f 626f 6f6c     polygons_bool
-0000a7f0: 6561 6e20 3a20 506f 6c79 676f 6e53 6574  ean : PolygonSet
-0000a800: 206f 7220 6c69 7374 206f 6620 706f 6c79   or list of poly
-0000a810: 676f 6e73 0a20 2020 2020 2020 2053 6574  gons.        Set
-0000a820: 206f 7220 6c69 7374 206f 6620 706f 6c79   or list of poly
-0000a830: 676f 6e73 2077 6974 6820 626f 6f6c 6561  gons with boolea
-0000a840: 6e20 6f70 6572 6174 696f 6e20 6170 706c  n operation appl
-0000a850: 6965 642e 0a20 2020 2022 2222 0a0a 2020  ied..    """..  
-0000a860: 2020 706f 6c79 676f 6e73 5f74 6f5f 626f    polygons_to_bo
-0000a870: 6f6c 6561 6e5f 4120 3d20 5f63 726f 705f  olean_A = _crop_
-0000a880: 6564 6765 5f70 6f6c 7967 6f6e 7328 0a20  edge_polygons(. 
-0000a890: 2020 2020 2020 2061 6c6c 5f70 6f6c 7967         all_polyg
-0000a8a0: 6f6e 735f 412c 2062 626f 7865 735f 412c  ons_A, bboxes_A,
-0000a8b0: 206c 6566 742c 2062 6f74 746f 6d2c 2072   left, bottom, r
-0000a8c0: 6967 6874 2c20 746f 702c 2070 7265 6369  ight, top, preci
-0000a8d0: 7369 6f6e 0a20 2020 2029 0a20 2020 2070  sion.    ).    p
-0000a8e0: 6f6c 7967 6f6e 735f 746f 5f62 6f6f 6c65  olygons_to_boole
-0000a8f0: 616e 5f42 203d 205f 6372 6f70 5f65 6467  an_B = _crop_edg
-0000a900: 655f 706f 6c79 676f 6e73 280a 2020 2020  e_polygons(.    
-0000a910: 2020 2020 616c 6c5f 706f 6c79 676f 6e73      all_polygons
-0000a920: 5f42 2c20 6262 6f78 6573 5f42 2c20 6c65  _B, bboxes_B, le
-0000a930: 6674 2c20 626f 7474 6f6d 2c20 7269 6768  ft, bottom, righ
-0000a940: 742c 2074 6f70 2c20 7072 6563 6973 696f  t, top, precisio
-0000a950: 6e0a 2020 2020 290a 2020 2020 706f 6c79  n.    ).    poly
-0000a960: 676f 6e73 5f62 6f6f 6c65 616e 203d 2063  gons_boolean = c
-0000a970: 6c69 7070 6572 2e63 6c69 7028 0a20 2020  lipper.clip(.   
-0000a980: 2020 2020 2070 6f6c 7967 6f6e 735f 746f       polygons_to
-0000a990: 5f62 6f6f 6c65 616e 5f41 2c20 706f 6c79  _boolean_A, poly
-0000a9a0: 676f 6e73 5f74 6f5f 626f 6f6c 6561 6e5f  gons_to_boolean_
-0000a9b0: 422c 206f 7065 7261 7469 6f6e 2c20 3120  B, operation, 1 
-0000a9c0: 2f20 7072 6563 6973 696f 6e0a 2020 2020  / precision.    
-0000a9d0: 290a 2020 2020 7265 7475 726e 2070 6f6c  ).    return pol
-0000a9e0: 7967 6f6e 735f 626f 6f6c 6561 6e0a 0a0a  ygons_boolean...
-0000a9f0: 6465 6620 5f62 6f6f 6c65 616e 5f70 6f6c  def _boolean_pol
-0000aa00: 7967 6f6e 735f 7061 7261 6c6c 656c 280a  ygons_parallel(.
-0000aa10: 2020 2020 706f 6c79 676f 6e73 5f41 2c20      polygons_A, 
-0000aa20: 706f 6c79 676f 6e73 5f42 2c20 6e75 6d5f  polygons_B, num_
-0000aa30: 6469 7669 7369 6f6e 733d 5b31 302c 2031  divisions=[10, 1
-0000aa40: 305d 2c20 6f70 6572 6174 696f 6e3d 2261  0], operation="a
-0000aa50: 6e64 222c 2070 7265 6369 7369 6f6e 3d31  nd", precision=1
-0000aa60: 652d 340a 293a 0a20 2020 2022 2222 5065  e-4.):.    """Pe
-0000aa70: 7266 6f72 6d73 2074 6865 2062 6f6f 6c65  rforms the boole
-0000aa80: 616e 2066 756e 6374 696f 6e20 6f6e 2061  an function on a
-0000aa90: 206c 6973 7420 6f66 2073 7562 7365 6374   list of subsect
-0000aaa0: 696f 6e73 206f 6620 7468 6520 6f72 6967  ions of the orig
-0000aab0: 696e 616c 0a20 2020 2067 656f 6d65 7472  inal.    geometr
-0000aac0: 790a 0a20 2020 2050 6172 616d 6574 6572  y..    Parameter
-0000aad0: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-0000aae0: 0a20 2020 2070 6f6c 7967 6f6e 735f 4120  .    polygons_A 
-0000aaf0: 3a20 506f 6c79 676f 6e53 6574 206f 7220  : PolygonSet or 
-0000ab00: 6c69 7374 206f 6620 706f 6c79 676f 6e73  list of polygons
-0000ab10: 0a20 2020 2020 2020 2053 6574 206f 7220  .        Set or 
-0000ab20: 6c69 7374 206f 6620 706f 6c79 676f 6e73  list of polygons
-0000ab30: 2074 6f20 6265 2062 6f6f 6c65 616e 6564   to be booleaned
-0000ab40: 2e0a 2020 2020 706f 6c79 676f 6e73 5f42  ..    polygons_B
-0000ab50: 203a 2050 6f6c 7967 6f6e 5365 7420 6f72   : PolygonSet or
-0000ab60: 206c 6973 7420 6f66 2070 6f6c 7967 6f6e   list of polygon
-0000ab70: 730a 2020 2020 2020 2020 5365 7420 6f72  s.        Set or
-0000ab80: 206c 6973 7420 6f66 2070 6f6c 7967 6f6e   list of polygon
-0000ab90: 7320 746f 2062 6520 626f 6f6c 6561 6e65  s to be booleane
-0000aba0: 642e 0a20 2020 206e 756d 5f64 6976 6973  d..    num_divis
-0000abb0: 696f 6e73 203a 2061 7272 6179 2d6c 696b  ions : array-lik
-0000abc0: 655b 325d 206f 6620 696e 740a 2020 2020  e[2] of int.    
-0000abd0: 2020 2020 5468 6520 6e75 6d62 6572 206f      The number o
-0000abe0: 6620 6469 7669 7369 6f6e 7320 7769 7468  f divisions with
-0000abf0: 2077 6869 6368 2074 6865 2067 656f 6d65   which the geome
-0000ac00: 7472 7920 6973 2064 6976 6964 6564 2069  try is divided i
-0000ac10: 6e74 6f0a 2020 2020 2020 2020 6d75 6c74  nto.        mult
-0000ac20: 6970 6c65 2072 6563 7461 6e67 756c 6172  iple rectangular
-0000ac30: 2072 6567 696f 6e73 2e20 5468 6973 2061   regions. This a
-0000ac40: 6c6c 6f77 7320 666f 7220 6561 6368 2072  llows for each r
-0000ac50: 6567 696f 6e20 746f 2062 650a 2020 2020  egion to be.    
-0000ac60: 2020 2020 7072 6f63 6573 7365 6420 7365      processed se
-0000ac70: 7175 656e 7469 616c 6c79 2c20 7768 6963  quentially, whic
-0000ac80: 6820 6973 206d 6f72 6520 636f 6d70 7574  h is more comput
-0000ac90: 6174 696f 6e61 6c6c 7920 6566 6669 6369  ationally effici
-0000aca0: 656e 742e 0a20 2020 206f 7065 7261 7469  ent..    operati
-0000acb0: 6f6e 203a 207b 276e 6f74 272c 2027 616e  on : {'not', 'an
-0000acc0: 6427 2c20 276f 7227 2c20 2778 6f72 272c  d', 'or', 'xor',
-0000acd0: 2027 412d 4227 2c20 2742 2d41 272c 2027   'A-B', 'B-A', '
-0000ace0: 412b 4227 7d0a 2020 2020 2020 2020 426f  A+B'}.        Bo
-0000acf0: 6f6c 6561 6e20 6f70 6572 6174 696f 6e20  olean operation 
-0000ad00: 746f 2070 6572 666f 726d 2e0a 2020 2020  to perform..    
-0000ad10: 7072 6563 6973 696f 6e20 3a20 666c 6f61  precision : floa
-0000ad20: 740a 2020 2020 2020 2020 4465 7369 7265  t.        Desire
-0000ad30: 6420 7072 6563 6973 696f 6e20 666f 7220  d precision for 
-0000ad40: 726f 756e 6469 6e67 2076 6572 7465 7820  rounding vertex 
-0000ad50: 636f 6f72 6469 6e61 7465 732e 0a0a 2020  coordinates...  
-0000ad60: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
-0000ad70: 2d2d 2d2d 2d0a 2020 2020 626f 6f6c 6561  -----.    boolea
-0000ad80: 6e5f 706f 6c79 676f 6e73 203a 206c 6973  n_polygons : lis
-0000ad90: 7420 6f66 2070 6f6c 7967 6f6e 730a 2020  t of polygons.  
-0000ada0: 2020 2020 2020 416c 6c20 7468 6520 626f        All the bo
-0000adb0: 6f6c 6561 6e65 6420 706f 6c79 676f 6e73  oleaned polygons
-0000adc0: 2066 726f 6d20 6561 6368 206f 6620 7468   from each of th
-0000add0: 6520 7375 6273 6563 7469 6f6e 730a 0a20  e subsections.. 
-0000ade0: 2020 2022 2222 0a20 2020 2023 2042 7569     """.    # Bui
-0000adf0: 6c64 2062 6f75 6e64 696e 6720 626f 7865  ld bounding boxe
-0000ae00: 730a 2020 2020 706f 6c79 676f 6e73 5f41  s.    polygons_A
-0000ae10: 203d 206e 702e 6173 6172 7261 7928 706f   = np.asarray(po
-0000ae20: 6c79 676f 6e73 5f41 2c20 6474 7970 653d  lygons_A, dtype=
-0000ae30: 6f62 6a65 6374 290a 2020 2020 706f 6c79  object).    poly
-0000ae40: 676f 6e73 5f42 203d 206e 702e 6173 6172  gons_B = np.asar
-0000ae50: 7261 7928 706f 6c79 676f 6e73 5f42 2c20  ray(polygons_B, 
-0000ae60: 6474 7970 653d 6f62 6a65 6374 290a 2020  dtype=object).  
-0000ae70: 2020 6262 6f78 6573 5f41 203d 205f 706f    bboxes_A = _po
-0000ae80: 6c79 676f 6e73 5f74 6f5f 6262 6f78 6573  lygons_to_bboxes
-0000ae90: 2870 6f6c 7967 6f6e 735f 4129 0a20 2020  (polygons_A).   
-0000aea0: 2062 626f 7865 735f 4220 3d20 5f70 6f6c   bboxes_B = _pol
-0000aeb0: 7967 6f6e 735f 746f 5f62 626f 7865 7328  ygons_to_bboxes(
-0000aec0: 706f 6c79 676f 6e73 5f42 290a 0a20 2020  polygons_B)..   
-0000aed0: 2078 6d69 6e2c 2079 6d69 6e20 3d20 6e70   xmin, ymin = np
-0000aee0: 2e6d 696e 280a 2020 2020 2020 2020 5b6e  .min(.        [n
-0000aef0: 702e 6d69 6e28 6262 6f78 6573 5f41 5b3a  p.min(bboxes_A[:
-0000af00: 2c20 303a 325d 2c20 6178 6973 3d30 292c  , 0:2], axis=0),
-0000af10: 206e 702e 6d69 6e28 6262 6f78 6573 5f42   np.min(bboxes_B
-0000af20: 5b3a 2c20 303a 325d 2c20 6178 6973 3d30  [:, 0:2], axis=0
-0000af30: 295d 2c20 6178 6973 3d30 0a20 2020 2029  )], axis=0.    )
-0000af40: 0a20 2020 2078 6d61 782c 2079 6d61 7820  .    xmax, ymax 
-0000af50: 3d20 6e70 2e6d 6178 280a 2020 2020 2020  = np.max(.      
-0000af60: 2020 5b6e 702e 6d61 7828 6262 6f78 6573    [np.max(bboxes
-0000af70: 5f41 5b3a 2c20 323a 345d 2c20 6178 6973  _A[:, 2:4], axis
-0000af80: 3d30 292c 206e 702e 6d61 7828 6262 6f78  =0), np.max(bbox
-0000af90: 6573 5f42 5b3a 2c20 323a 345d 2c20 6178  es_B[:, 2:4], ax
-0000afa0: 6973 3d30 295d 2c20 6178 6973 3d30 0a20  is=0)], axis=0. 
-0000afb0: 2020 2029 0a0a 2020 2020 7873 697a 6520     )..    xsize 
-0000afc0: 3d20 786d 6178 202d 2078 6d69 6e0a 2020  = xmax - xmin.  
-0000afd0: 2020 7973 697a 6520 3d20 796d 6178 202d    ysize = ymax -
-0000afe0: 2079 6d69 6e0a 2020 2020 7864 656c 7461   ymin.    xdelta
-0000aff0: 203d 2078 7369 7a65 202f 206e 756d 5f64   = xsize / num_d
-0000b000: 6976 6973 696f 6e73 5b30 5d0a 2020 2020  ivisions[0].    
-0000b010: 7964 656c 7461 203d 2079 7369 7a65 202f  ydelta = ysize /
-0000b020: 206e 756d 5f64 6976 6973 696f 6e73 5b31   num_divisions[1
-0000b030: 5d0a 2020 2020 7863 6f72 6e65 7273 203d  ].    xcorners =
-0000b040: 2078 6d69 6e20 2b20 6e70 2e61 7261 6e67   xmin + np.arang
-0000b050: 6528 6e75 6d5f 6469 7669 7369 6f6e 735b  e(num_divisions[
-0000b060: 305d 2920 2a20 7864 656c 7461 0a20 2020  0]) * xdelta.   
-0000b070: 2079 636f 726e 6572 7320 3d20 796d 696e   ycorners = ymin
-0000b080: 202b 206e 702e 6172 616e 6765 286e 756d   + np.arange(num
-0000b090: 5f64 6976 6973 696f 6e73 5b31 5d29 202a  _divisions[1]) *
-0000b0a0: 2079 6465 6c74 610a 0a20 2020 2062 6f6f   ydelta..    boo
-0000b0b0: 6c65 616e 5f70 6f6c 7967 6f6e 7320 3d20  lean_polygons = 
-0000b0c0: 5b5d 0a20 2020 2066 6f72 206e 2c20 7863  [].    for n, xc
-0000b0d0: 2069 6e20 656e 756d 6572 6174 6528 7863   in enumerate(xc
-0000b0e0: 6f72 6e65 7273 293a 0a20 2020 2020 2020  orners):.       
-0000b0f0: 2066 6f72 206d 2c20 7963 2069 6e20 656e   for m, yc in en
-0000b100: 756d 6572 6174 6528 7963 6f72 6e65 7273  umerate(ycorners
-0000b110: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
-0000b120: 6566 7420 3d20 7863 0a20 2020 2020 2020  eft = xc.       
-0000b130: 2020 2020 2072 6967 6874 203d 2078 6320       right = xc 
-0000b140: 2b20 7864 656c 7461 0a20 2020 2020 2020  + xdelta.       
-0000b150: 2020 2020 2062 6f74 746f 6d20 3d20 7963       bottom = yc
-0000b160: 0a20 2020 2020 2020 2020 2020 2074 6f70  .            top
-0000b170: 203d 2079 6320 2b20 7964 656c 7461 0a20   = yc + ydelta. 
-0000b180: 2020 2020 2020 2020 2020 205f 626f 6f6c             _bool
-0000b190: 6561 6e5f 7265 6769 6f6e 5f70 6f6c 7967  ean_region_polyg
-0000b1a0: 6f6e 7320 3d20 5f62 6f6f 6c65 616e 5f72  ons = _boolean_r
-0000b1b0: 6567 696f 6e28 0a20 2020 2020 2020 2020  egion(.         
-0000b1c0: 2020 2020 2020 2070 6f6c 7967 6f6e 735f         polygons_
-0000b1d0: 412c 0a20 2020 2020 2020 2020 2020 2020  A,.             
-0000b1e0: 2020 2070 6f6c 7967 6f6e 735f 422c 0a20     polygons_B,. 
-0000b1f0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0000b200: 626f 7865 735f 412c 0a20 2020 2020 2020  boxes_A,.       
-0000b210: 2020 2020 2020 2020 2062 626f 7865 735f           bboxes_
-0000b220: 422c 0a20 2020 2020 2020 2020 2020 2020  B,.             
-0000b230: 2020 206c 6566 742c 0a20 2020 2020 2020     left,.       
-0000b240: 2020 2020 2020 2020 2062 6f74 746f 6d2c           bottom,
-0000b250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b260: 2072 6967 6874 2c0a 2020 2020 2020 2020   right,.        
-0000b270: 2020 2020 2020 2020 746f 702c 0a20 2020          top,.   
-0000b280: 2020 2020 2020 2020 2020 2020 206f 7065               ope
-0000b290: 7261 7469 6f6e 3d6f 7065 7261 7469 6f6e  ration=operation
-0000b2a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000b2b0: 2020 7072 6563 6973 696f 6e3d 7072 6563    precision=prec
-0000b2c0: 6973 696f 6e2c 0a20 2020 2020 2020 2020  ision,.         
-0000b2d0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0000b2e0: 2062 6f6f 6c65 616e 5f70 6f6c 7967 6f6e   boolean_polygon
-0000b2f0: 7320 2b3d 205f 626f 6f6c 6561 6e5f 7265  s += _boolean_re
-0000b300: 6769 6f6e 5f70 6f6c 7967 6f6e 730a 0a20  gion_polygons.. 
-0000b310: 2020 2072 6574 7572 6e20 626f 6f6c 6561     return boolea
-0000b320: 6e5f 706f 6c79 676f 6e73 0a0a 0a23 203d  n_polygons...# =
-0000b330: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000b340: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000b350: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00009fc0: 5b30 5d0a 2020 2020 7964 656c 7461 203d  [0].    ydelta =
+00009fd0: 2079 7369 7a65 202f 206e 756d 5f64 6976   ysize / num_div
+00009fe0: 6973 696f 6e73 5b31 5d0a 2020 2020 7863  isions[1].    xc
+00009ff0: 6f72 6e65 7273 203d 2078 6d69 6e20 2b20  orners = xmin + 
+0000a000: 6e70 2e61 7261 6e67 6528 6e75 6d5f 6469  np.arange(num_di
+0000a010: 7669 7369 6f6e 735b 305d 2920 2a20 7864  visions[0]) * xd
+0000a020: 656c 7461 0a20 2020 2079 636f 726e 6572  elta.    ycorner
+0000a030: 7320 3d20 796d 696e 202b 206e 702e 6172  s = ymin + np.ar
+0000a040: 616e 6765 286e 756d 5f64 6976 6973 696f  ange(num_divisio
+0000a050: 6e73 5b31 5d29 202a 2079 6465 6c74 610a  ns[1]) * ydelta.
+0000a060: 0a20 2020 206f 6666 7365 745f 706f 6c79  .    offset_poly
+0000a070: 676f 6e73 203d 205b 5d0a 2020 2020 666f  gons = [].    fo
+0000a080: 7220 6e2c 2078 6320 696e 2065 6e75 6d65  r n, xc in enume
+0000a090: 7261 7465 2878 636f 726e 6572 7329 3a0a  rate(xcorners):.
+0000a0a0: 2020 2020 2020 2020 666f 7220 6d2c 2079          for m, y
+0000a0b0: 6320 696e 2065 6e75 6d65 7261 7465 2879  c in enumerate(y
+0000a0c0: 636f 726e 6572 7329 3a0a 2020 2020 2020  corners):.      
+0000a0d0: 2020 2020 2020 6c65 6674 203d 2078 630a        left = xc.
+0000a0e0: 2020 2020 2020 2020 2020 2020 7269 6768              righ
+0000a0f0: 7420 3d20 7863 202b 2078 6465 6c74 610a  t = xc + xdelta.
+0000a100: 2020 2020 2020 2020 2020 2020 626f 7474              bott
+0000a110: 6f6d 203d 2079 630a 2020 2020 2020 2020  om = yc.        
+0000a120: 2020 2020 746f 7020 3d20 7963 202b 2079      top = yc + y
+0000a130: 6465 6c74 610a 2020 2020 2020 2020 2020  delta.          
+0000a140: 2020 5f6f 6666 7365 745f 7265 6769 6f6e    _offset_region
+0000a150: 5f70 6f6c 7967 6f6e 7320 3d20 5f6f 6666  _polygons = _off
+0000a160: 7365 745f 7265 6769 6f6e 280a 2020 2020  set_region(.    
+0000a170: 2020 2020 2020 2020 2020 2020 706f 6c79              poly
+0000a180: 676f 6e73 2c0a 2020 2020 2020 2020 2020  gons,.          
+0000a190: 2020 2020 2020 6262 6f78 6573 2c0a 2020        bboxes,.  
+0000a1a0: 2020 2020 2020 2020 2020 2020 2020 6c65                le
+0000a1b0: 6674 2c0a 2020 2020 2020 2020 2020 2020  ft,.            
+0000a1c0: 2020 2020 626f 7474 6f6d 2c0a 2020 2020      bottom,.    
+0000a1d0: 2020 2020 2020 2020 2020 2020 7269 6768              righ
+0000a1e0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0000a1f0: 2020 2074 6f70 2c0a 2020 2020 2020 2020     top,.        
+0000a200: 2020 2020 2020 2020 6469 7374 616e 6365          distance
+0000a210: 3d64 6973 7461 6e63 652c 0a20 2020 2020  =distance,.     
+0000a220: 2020 2020 2020 2020 2020 206a 6f69 6e5f             join_
+0000a230: 6669 7273 743d 6a6f 696e 5f66 6972 7374  first=join_first
+0000a240: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a250: 2020 7072 6563 6973 696f 6e3d 7072 6563    precision=prec
+0000a260: 6973 696f 6e2c 0a20 2020 2020 2020 2020  ision,.         
+0000a270: 2020 2020 2020 206a 6f69 6e3d 6a6f 696e         join=join
+0000a280: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a290: 2020 746f 6c65 7261 6e63 653d 746f 6c65    tolerance=tole
+0000a2a0: 7261 6e63 652c 0a20 2020 2020 2020 2020  rance,.         
+0000a2b0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0000a2c0: 206f 6666 7365 745f 706f 6c79 676f 6e73   offset_polygons
+0000a2d0: 202b 3d20 5f6f 6666 7365 745f 7265 6769   += _offset_regi
+0000a2e0: 6f6e 5f70 6f6c 7967 6f6e 730a 0a20 2020  on_polygons..   
+0000a2f0: 2072 6574 7572 6e20 6f66 6673 6574 5f70   return offset_p
+0000a300: 6f6c 7967 6f6e 730a 0a0a 6465 6620 5f62  olygons...def _b
+0000a310: 6f6f 6c65 616e 5f72 6567 696f 6e28 0a20  oolean_region(. 
+0000a320: 2020 2061 6c6c 5f70 6f6c 7967 6f6e 735f     all_polygons_
+0000a330: 412c 0a20 2020 2061 6c6c 5f70 6f6c 7967  A,.    all_polyg
+0000a340: 6f6e 735f 422c 0a20 2020 2062 626f 7865  ons_B,.    bboxe
+0000a350: 735f 412c 0a20 2020 2062 626f 7865 735f  s_A,.    bboxes_
+0000a360: 422c 0a20 2020 206c 6566 742c 0a20 2020  B,.    left,.   
+0000a370: 2062 6f74 746f 6d2c 0a20 2020 2072 6967   bottom,.    rig
+0000a380: 6874 2c0a 2020 2020 746f 702c 0a20 2020  ht,.    top,.   
+0000a390: 206f 7065 7261 7469 6f6e 3d22 616e 6422   operation="and"
+0000a3a0: 2c0a 2020 2020 7072 6563 6973 696f 6e3d  ,.    precision=
+0000a3b0: 3165 2d34 2c0a 293a 0a20 2020 2022 2222  1e-4,.):.    """
+0000a3c0: 5461 6b69 6e67 2061 2072 6567 696f 6e20  Taking a region 
+0000a3d0: 6f66 2065 2e67 2e20 7369 7a65 2028 782c  of e.g. size (x,
+0000a3e0: 2079 2920 7768 6963 6820 6e65 6564 7320   y) which needs 
+0000a3f0: 746f 2062 6520 626f 6f6c 6561 6e65 642c  to be booleaned,
+0000a400: 0a20 2020 2074 6869 7320 6675 6e63 7469  .    this functi
+0000a410: 6f6e 2063 726f 7073 206f 7574 2061 2072  on crops out a r
+0000a420: 6567 696f 6e20 2878 2c20 7929 206c 6172  egion (x, y) lar
+0000a430: 6765 2066 726f 6d20 6561 6368 2073 6574  ge from each set
+0000a440: 206f 6620 706f 6c79 676f 6e73 0a20 2020   of polygons.   
+0000a450: 2028 4120 616e 6420 4229 2c20 626f 6f6c   (A and B), bool
+0000a460: 6561 6e73 2074 6861 7420 6372 6f70 7065  eans that croppe
+0000a470: 6420 7265 6769 6f6e 2061 6e64 2072 6574  d region and ret
+0000a480: 7572 6e73 2074 6865 2072 6573 756c 742e  urns the result.
+0000a490: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+0000a4a0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+0000a4b0: 2020 2020 616c 6c5f 706f 6c79 676f 6e73      all_polygons
+0000a4c0: 5f41 203a 2050 6f6c 7967 6f6e 5365 7420  _A : PolygonSet 
+0000a4d0: 6f72 206c 6973 7420 6f66 2070 6f6c 7967  or list of polyg
+0000a4e0: 6f6e 730a 2020 2020 2020 2020 5365 7420  ons.        Set 
+0000a4f0: 6f72 206c 6973 7420 6f66 2070 6f6c 7967  or list of polyg
+0000a500: 6f6e 7320 746f 2062 6520 626f 6f6c 6561  ons to be boolea
+0000a510: 6e65 642e 0a20 2020 2061 6c6c 5f70 6f6c  ned..    all_pol
+0000a520: 7967 6f6e 735f 4220 3a20 506f 6c79 676f  ygons_B : Polygo
+0000a530: 6e53 6574 206f 7220 6c69 7374 206f 6620  nSet or list of 
+0000a540: 706f 6c79 676f 6e73 0a20 2020 2020 2020  polygons.       
+0000a550: 2053 6574 206f 7220 6c69 7374 206f 6620   Set or list of 
+0000a560: 706f 6c79 676f 6e73 2074 6f20 6265 2062  polygons to be b
+0000a570: 6f6f 6c65 616e 6564 2e0a 2020 2020 6262  ooleaned..    bb
+0000a580: 6f78 6573 5f41 203a 206c 6973 740a 2020  oxes_A : list.  
+0000a590: 2020 2020 2020 4c69 7374 206f 6620 616c        List of al
+0000a5a0: 6c20 706f 6c79 676f 6e20 6262 6f78 6573  l polygon bboxes
+0000a5b0: 2069 6e20 616c 6c5f 706f 6c79 676f 6e73   in all_polygons
+0000a5c0: 5f41 0a20 2020 2062 626f 7865 735f 4220  _A.    bboxes_B 
+0000a5d0: 3a20 6c69 7374 0a20 2020 2020 2020 204c  : list.        L
+0000a5e0: 6973 7420 6f66 2061 6c6c 2070 6f6c 7967  ist of all polyg
+0000a5f0: 6f6e 2062 626f 7865 7320 696e 2061 6c6c  on bboxes in all
+0000a600: 5f70 6f6c 7967 6f6e 735f 420a 2020 2020  _polygons_B.    
+0000a610: 6c65 6674 203a 2069 6e74 206f 7220 666c  left : int or fl
+0000a620: 6f61 740a 2020 2020 2020 2020 5468 6520  oat.        The 
+0000a630: 782d 636f 6f72 6469 6e61 7465 206f 6620  x-coordinate of 
+0000a640: 7468 6520 6c65 6674 6861 6e64 2062 6f75  the lefthand bou
+0000a650: 6e64 6172 792e 0a20 2020 2062 6f74 746f  ndary..    botto
+0000a660: 6d20 3a20 696e 7420 6f72 2066 6c6f 6174  m : int or float
+0000a670: 0a20 2020 2020 2020 2054 6865 2079 2d63  .        The y-c
+0000a680: 6f6f 7264 696e 6174 6520 6f66 2074 6865  oordinate of the
+0000a690: 2062 6f74 746f 6d20 626f 756e 6461 7279   bottom boundary
+0000a6a0: 2e0a 2020 2020 7269 6768 7420 3a20 696e  ..    right : in
+0000a6b0: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
+0000a6c0: 2020 2054 6865 2078 2d63 6f6f 7264 696e     The x-coordin
+0000a6d0: 6174 6520 6f66 2074 6865 2072 6967 6874  ate of the right
+0000a6e0: 6861 6e64 2062 6f75 6e64 6172 792e 0a20  hand boundary.. 
+0000a6f0: 2020 2074 6f70 203a 2069 6e74 206f 7220     top : int or 
+0000a700: 666c 6f61 740a 2020 2020 2020 2020 5468  float.        Th
+0000a710: 6520 792d 636f 6f72 6469 6e61 7465 206f  e y-coordinate o
+0000a720: 6620 7468 6520 746f 7020 626f 756e 6461  f the top bounda
+0000a730: 7279 2e0a 2020 2020 6f70 6572 6174 696f  ry..    operatio
+0000a740: 6e20 3a20 7b27 6e6f 7427 2c20 2761 6e64  n : {'not', 'and
+0000a750: 272c 2027 6f72 272c 2027 786f 7227 2c20  ', 'or', 'xor', 
+0000a760: 2741 2d42 272c 2027 422d 4127 2c20 2741  'A-B', 'B-A', 'A
+0000a770: 2b42 277d 0a20 2020 2020 2020 2042 6f6f  +B'}.        Boo
+0000a780: 6c65 616e 206f 7065 7261 7469 6f6e 2074  lean operation t
+0000a790: 6f20 7065 7266 6f72 6d2e 0a20 2020 2070  o perform..    p
+0000a7a0: 7265 6369 7369 6f6e 203a 2066 6c6f 6174  recision : float
+0000a7b0: 0a20 2020 2020 2020 2044 6573 6972 6564  .        Desired
+0000a7c0: 2070 7265 6369 7369 6f6e 2066 6f72 2072   precision for r
+0000a7d0: 6f75 6e64 696e 6720 7665 7274 6578 2063  ounding vertex c
+0000a7e0: 6f6f 7264 696e 6174 6573 2e0a 0a20 2020  oordinates...   
+0000a7f0: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
+0000a800: 2d2d 2d2d 0a20 2020 2070 6f6c 7967 6f6e  ----.    polygon
+0000a810: 735f 626f 6f6c 6561 6e20 3a20 506f 6c79  s_boolean : Poly
+0000a820: 676f 6e53 6574 206f 7220 6c69 7374 206f  gonSet or list o
+0000a830: 6620 706f 6c79 676f 6e73 0a20 2020 2020  f polygons.     
+0000a840: 2020 2053 6574 206f 7220 6c69 7374 206f     Set or list o
+0000a850: 6620 706f 6c79 676f 6e73 2077 6974 6820  f polygons with 
+0000a860: 626f 6f6c 6561 6e20 6f70 6572 6174 696f  boolean operatio
+0000a870: 6e20 6170 706c 6965 642e 0a20 2020 2022  n applied..    "
+0000a880: 2222 0a0a 2020 2020 706f 6c79 676f 6e73  ""..    polygons
+0000a890: 5f74 6f5f 626f 6f6c 6561 6e5f 4120 3d20  _to_boolean_A = 
+0000a8a0: 5f63 726f 705f 6564 6765 5f70 6f6c 7967  _crop_edge_polyg
+0000a8b0: 6f6e 7328 0a20 2020 2020 2020 2061 6c6c  ons(.        all
+0000a8c0: 5f70 6f6c 7967 6f6e 735f 412c 2062 626f  _polygons_A, bbo
+0000a8d0: 7865 735f 412c 206c 6566 742c 2062 6f74  xes_A, left, bot
+0000a8e0: 746f 6d2c 2072 6967 6874 2c20 746f 702c  tom, right, top,
+0000a8f0: 2070 7265 6369 7369 6f6e 0a20 2020 2029   precision.    )
+0000a900: 0a20 2020 2070 6f6c 7967 6f6e 735f 746f  .    polygons_to
+0000a910: 5f62 6f6f 6c65 616e 5f42 203d 205f 6372  _boolean_B = _cr
+0000a920: 6f70 5f65 6467 655f 706f 6c79 676f 6e73  op_edge_polygons
+0000a930: 280a 2020 2020 2020 2020 616c 6c5f 706f  (.        all_po
+0000a940: 6c79 676f 6e73 5f42 2c20 6262 6f78 6573  lygons_B, bboxes
+0000a950: 5f42 2c20 6c65 6674 2c20 626f 7474 6f6d  _B, left, bottom
+0000a960: 2c20 7269 6768 742c 2074 6f70 2c20 7072  , right, top, pr
+0000a970: 6563 6973 696f 6e0a 2020 2020 290a 2020  ecision.    ).  
+0000a980: 2020 706f 6c79 676f 6e73 5f62 6f6f 6c65    polygons_boole
+0000a990: 616e 203d 2063 6c69 7070 6572 2e63 6c69  an = clipper.cli
+0000a9a0: 7028 0a20 2020 2020 2020 2070 6f6c 7967  p(.        polyg
+0000a9b0: 6f6e 735f 746f 5f62 6f6f 6c65 616e 5f41  ons_to_boolean_A
+0000a9c0: 2c20 706f 6c79 676f 6e73 5f74 6f5f 626f  , polygons_to_bo
+0000a9d0: 6f6c 6561 6e5f 422c 206f 7065 7261 7469  olean_B, operati
+0000a9e0: 6f6e 2c20 3120 2f20 7072 6563 6973 696f  on, 1 / precisio
+0000a9f0: 6e0a 2020 2020 290a 2020 2020 7265 7475  n.    ).    retu
+0000aa00: 726e 2070 6f6c 7967 6f6e 735f 626f 6f6c  rn polygons_bool
+0000aa10: 6561 6e0a 0a0a 6465 6620 5f62 6f6f 6c65  ean...def _boole
+0000aa20: 616e 5f70 6f6c 7967 6f6e 735f 7061 7261  an_polygons_para
+0000aa30: 6c6c 656c 280a 2020 2020 706f 6c79 676f  llel(.    polygo
+0000aa40: 6e73 5f41 2c20 706f 6c79 676f 6e73 5f42  ns_A, polygons_B
+0000aa50: 2c20 6e75 6d5f 6469 7669 7369 6f6e 733d  , num_divisions=
+0000aa60: 5b31 302c 2031 305d 2c20 6f70 6572 6174  [10, 10], operat
+0000aa70: 696f 6e3d 2261 6e64 222c 2070 7265 6369  ion="and", preci
+0000aa80: 7369 6f6e 3d31 652d 340a 293a 0a20 2020  sion=1e-4.):.   
+0000aa90: 2022 2222 5065 7266 6f72 6d73 2074 6865   """Performs the
+0000aaa0: 2062 6f6f 6c65 616e 2066 756e 6374 696f   boolean functio
+0000aab0: 6e20 6f6e 2061 206c 6973 7420 6f66 2073  n on a list of s
+0000aac0: 7562 7365 6374 696f 6e73 206f 6620 7468  ubsections of th
+0000aad0: 6520 6f72 6967 696e 616c 0a20 2020 2067  e original.    g
+0000aae0: 656f 6d65 7472 790a 0a20 2020 2050 6172  eometry..    Par
+0000aaf0: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+0000ab00: 2d2d 2d2d 2d2d 0a20 2020 2070 6f6c 7967  ------.    polyg
+0000ab10: 6f6e 735f 4120 3a20 506f 6c79 676f 6e53  ons_A : PolygonS
+0000ab20: 6574 206f 7220 6c69 7374 206f 6620 706f  et or list of po
+0000ab30: 6c79 676f 6e73 0a20 2020 2020 2020 2053  lygons.        S
+0000ab40: 6574 206f 7220 6c69 7374 206f 6620 706f  et or list of po
+0000ab50: 6c79 676f 6e73 2074 6f20 6265 2062 6f6f  lygons to be boo
+0000ab60: 6c65 616e 6564 2e0a 2020 2020 706f 6c79  leaned..    poly
+0000ab70: 676f 6e73 5f42 203a 2050 6f6c 7967 6f6e  gons_B : Polygon
+0000ab80: 5365 7420 6f72 206c 6973 7420 6f66 2070  Set or list of p
+0000ab90: 6f6c 7967 6f6e 730a 2020 2020 2020 2020  olygons.        
+0000aba0: 5365 7420 6f72 206c 6973 7420 6f66 2070  Set or list of p
+0000abb0: 6f6c 7967 6f6e 7320 746f 2062 6520 626f  olygons to be bo
+0000abc0: 6f6c 6561 6e65 642e 0a20 2020 206e 756d  oleaned..    num
+0000abd0: 5f64 6976 6973 696f 6e73 203a 2061 7272  _divisions : arr
+0000abe0: 6179 2d6c 696b 655b 325d 206f 6620 696e  ay-like[2] of in
+0000abf0: 740a 2020 2020 2020 2020 5468 6520 6e75  t.        The nu
+0000ac00: 6d62 6572 206f 6620 6469 7669 7369 6f6e  mber of division
+0000ac10: 7320 7769 7468 2077 6869 6368 2074 6865  s with which the
+0000ac20: 2067 656f 6d65 7472 7920 6973 2064 6976   geometry is div
+0000ac30: 6964 6564 2069 6e74 6f0a 2020 2020 2020  ided into.      
+0000ac40: 2020 6d75 6c74 6970 6c65 2072 6563 7461    multiple recta
+0000ac50: 6e67 756c 6172 2072 6567 696f 6e73 2e20  ngular regions. 
+0000ac60: 5468 6973 2061 6c6c 6f77 7320 666f 7220  This allows for 
+0000ac70: 6561 6368 2072 6567 696f 6e20 746f 2062  each region to b
+0000ac80: 650a 2020 2020 2020 2020 7072 6f63 6573  e.        proces
+0000ac90: 7365 6420 7365 7175 656e 7469 616c 6c79  sed sequentially
+0000aca0: 2c20 7768 6963 6820 6973 206d 6f72 6520  , which is more 
+0000acb0: 636f 6d70 7574 6174 696f 6e61 6c6c 7920  computationally 
+0000acc0: 6566 6669 6369 656e 742e 0a20 2020 206f  efficient..    o
+0000acd0: 7065 7261 7469 6f6e 203a 207b 276e 6f74  peration : {'not
+0000ace0: 272c 2027 616e 6427 2c20 276f 7227 2c20  ', 'and', 'or', 
+0000acf0: 2778 6f72 272c 2027 412d 4227 2c20 2742  'xor', 'A-B', 'B
+0000ad00: 2d41 272c 2027 412b 4227 7d0a 2020 2020  -A', 'A+B'}.    
+0000ad10: 2020 2020 426f 6f6c 6561 6e20 6f70 6572      Boolean oper
+0000ad20: 6174 696f 6e20 746f 2070 6572 666f 726d  ation to perform
+0000ad30: 2e0a 2020 2020 7072 6563 6973 696f 6e20  ..    precision 
+0000ad40: 3a20 666c 6f61 740a 2020 2020 2020 2020  : float.        
+0000ad50: 4465 7369 7265 6420 7072 6563 6973 696f  Desired precisio
+0000ad60: 6e20 666f 7220 726f 756e 6469 6e67 2076  n for rounding v
+0000ad70: 6572 7465 7820 636f 6f72 6469 6e61 7465  ertex coordinate
+0000ad80: 732e 0a0a 2020 2020 5265 7475 726e 730a  s...    Returns.
+0000ad90: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+0000ada0: 626f 6f6c 6561 6e5f 706f 6c79 676f 6e73  boolean_polygons
+0000adb0: 203a 206c 6973 7420 6f66 2070 6f6c 7967   : list of polyg
+0000adc0: 6f6e 730a 2020 2020 2020 2020 416c 6c20  ons.        All 
+0000add0: 7468 6520 626f 6f6c 6561 6e65 6420 706f  the booleaned po
+0000ade0: 6c79 676f 6e73 2066 726f 6d20 6561 6368  lygons from each
+0000adf0: 206f 6620 7468 6520 7375 6273 6563 7469   of the subsecti
+0000ae00: 6f6e 730a 0a20 2020 2022 2222 0a20 2020  ons..    """.   
+0000ae10: 2023 2042 7569 6c64 2062 6f75 6e64 696e   # Build boundin
+0000ae20: 6720 626f 7865 730a 2020 2020 706f 6c79  g boxes.    poly
+0000ae30: 676f 6e73 5f41 203d 206e 702e 6173 6172  gons_A = np.asar
+0000ae40: 7261 7928 706f 6c79 676f 6e73 5f41 2c20  ray(polygons_A, 
+0000ae50: 6474 7970 653d 6f62 6a65 6374 290a 2020  dtype=object).  
+0000ae60: 2020 706f 6c79 676f 6e73 5f42 203d 206e    polygons_B = n
+0000ae70: 702e 6173 6172 7261 7928 706f 6c79 676f  p.asarray(polygo
+0000ae80: 6e73 5f42 2c20 6474 7970 653d 6f62 6a65  ns_B, dtype=obje
+0000ae90: 6374 290a 2020 2020 6262 6f78 6573 5f41  ct).    bboxes_A
+0000aea0: 203d 205f 706f 6c79 676f 6e73 5f74 6f5f   = _polygons_to_
+0000aeb0: 6262 6f78 6573 2870 6f6c 7967 6f6e 735f  bboxes(polygons_
+0000aec0: 4129 0a20 2020 2062 626f 7865 735f 4220  A).    bboxes_B 
+0000aed0: 3d20 5f70 6f6c 7967 6f6e 735f 746f 5f62  = _polygons_to_b
+0000aee0: 626f 7865 7328 706f 6c79 676f 6e73 5f42  boxes(polygons_B
+0000aef0: 290a 0a20 2020 2078 6d69 6e2c 2079 6d69  )..    xmin, ymi
+0000af00: 6e20 3d20 6e70 2e6d 696e 280a 2020 2020  n = np.min(.    
+0000af10: 2020 2020 5b6e 702e 6d69 6e28 6262 6f78      [np.min(bbox
+0000af20: 6573 5f41 5b3a 2c20 303a 325d 2c20 6178  es_A[:, 0:2], ax
+0000af30: 6973 3d30 292c 206e 702e 6d69 6e28 6262  is=0), np.min(bb
+0000af40: 6f78 6573 5f42 5b3a 2c20 303a 325d 2c20  oxes_B[:, 0:2], 
+0000af50: 6178 6973 3d30 295d 2c20 6178 6973 3d30  axis=0)], axis=0
+0000af60: 0a20 2020 2029 0a20 2020 2078 6d61 782c  .    ).    xmax,
+0000af70: 2079 6d61 7820 3d20 6e70 2e6d 6178 280a   ymax = np.max(.
+0000af80: 2020 2020 2020 2020 5b6e 702e 6d61 7828          [np.max(
+0000af90: 6262 6f78 6573 5f41 5b3a 2c20 323a 345d  bboxes_A[:, 2:4]
+0000afa0: 2c20 6178 6973 3d30 292c 206e 702e 6d61  , axis=0), np.ma
+0000afb0: 7828 6262 6f78 6573 5f42 5b3a 2c20 323a  x(bboxes_B[:, 2:
+0000afc0: 345d 2c20 6178 6973 3d30 295d 2c20 6178  4], axis=0)], ax
+0000afd0: 6973 3d30 0a20 2020 2029 0a0a 2020 2020  is=0.    )..    
+0000afe0: 7873 697a 6520 3d20 786d 6178 202d 2078  xsize = xmax - x
+0000aff0: 6d69 6e0a 2020 2020 7973 697a 6520 3d20  min.    ysize = 
+0000b000: 796d 6178 202d 2079 6d69 6e0a 2020 2020  ymax - ymin.    
+0000b010: 7864 656c 7461 203d 2078 7369 7a65 202f  xdelta = xsize /
+0000b020: 206e 756d 5f64 6976 6973 696f 6e73 5b30   num_divisions[0
+0000b030: 5d0a 2020 2020 7964 656c 7461 203d 2079  ].    ydelta = y
+0000b040: 7369 7a65 202f 206e 756d 5f64 6976 6973  size / num_divis
+0000b050: 696f 6e73 5b31 5d0a 2020 2020 7863 6f72  ions[1].    xcor
+0000b060: 6e65 7273 203d 2078 6d69 6e20 2b20 6e70  ners = xmin + np
+0000b070: 2e61 7261 6e67 6528 6e75 6d5f 6469 7669  .arange(num_divi
+0000b080: 7369 6f6e 735b 305d 2920 2a20 7864 656c  sions[0]) * xdel
+0000b090: 7461 0a20 2020 2079 636f 726e 6572 7320  ta.    ycorners 
+0000b0a0: 3d20 796d 696e 202b 206e 702e 6172 616e  = ymin + np.aran
+0000b0b0: 6765 286e 756d 5f64 6976 6973 696f 6e73  ge(num_divisions
+0000b0c0: 5b31 5d29 202a 2079 6465 6c74 610a 0a20  [1]) * ydelta.. 
+0000b0d0: 2020 2062 6f6f 6c65 616e 5f70 6f6c 7967     boolean_polyg
+0000b0e0: 6f6e 7320 3d20 5b5d 0a20 2020 2066 6f72  ons = [].    for
+0000b0f0: 206e 2c20 7863 2069 6e20 656e 756d 6572   n, xc in enumer
+0000b100: 6174 6528 7863 6f72 6e65 7273 293a 0a20  ate(xcorners):. 
+0000b110: 2020 2020 2020 2066 6f72 206d 2c20 7963         for m, yc
+0000b120: 2069 6e20 656e 756d 6572 6174 6528 7963   in enumerate(yc
+0000b130: 6f72 6e65 7273 293a 0a20 2020 2020 2020  orners):.       
+0000b140: 2020 2020 206c 6566 7420 3d20 7863 0a20       left = xc. 
+0000b150: 2020 2020 2020 2020 2020 2072 6967 6874             right
+0000b160: 203d 2078 6320 2b20 7864 656c 7461 0a20   = xc + xdelta. 
+0000b170: 2020 2020 2020 2020 2020 2062 6f74 746f             botto
+0000b180: 6d20 3d20 7963 0a20 2020 2020 2020 2020  m = yc.         
+0000b190: 2020 2074 6f70 203d 2079 6320 2b20 7964     top = yc + yd
+0000b1a0: 656c 7461 0a20 2020 2020 2020 2020 2020  elta.           
+0000b1b0: 205f 626f 6f6c 6561 6e5f 7265 6769 6f6e   _boolean_region
+0000b1c0: 5f70 6f6c 7967 6f6e 7320 3d20 5f62 6f6f  _polygons = _boo
+0000b1d0: 6c65 616e 5f72 6567 696f 6e28 0a20 2020  lean_region(.   
+0000b1e0: 2020 2020 2020 2020 2020 2020 2070 6f6c               pol
+0000b1f0: 7967 6f6e 735f 412c 0a20 2020 2020 2020  ygons_A,.       
+0000b200: 2020 2020 2020 2020 2070 6f6c 7967 6f6e           polygon
+0000b210: 735f 422c 0a20 2020 2020 2020 2020 2020  s_B,.           
+0000b220: 2020 2020 2062 626f 7865 735f 412c 0a20       bboxes_A,. 
+0000b230: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000b240: 626f 7865 735f 422c 0a20 2020 2020 2020  boxes_B,.       
+0000b250: 2020 2020 2020 2020 206c 6566 742c 0a20           left,. 
+0000b260: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000b270: 6f74 746f 6d2c 0a20 2020 2020 2020 2020  ottom,.         
+0000b280: 2020 2020 2020 2072 6967 6874 2c0a 2020         right,.  
+0000b290: 2020 2020 2020 2020 2020 2020 2020 746f                to
+0000b2a0: 702c 0a20 2020 2020 2020 2020 2020 2020  p,.             
+0000b2b0: 2020 206f 7065 7261 7469 6f6e 3d6f 7065     operation=ope
+0000b2c0: 7261 7469 6f6e 2c0a 2020 2020 2020 2020  ration,.        
+0000b2d0: 2020 2020 2020 2020 7072 6563 6973 696f          precisio
+0000b2e0: 6e3d 7072 6563 6973 696f 6e2c 0a20 2020  n=precision,.   
+0000b2f0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000b300: 2020 2020 2020 2062 6f6f 6c65 616e 5f70         boolean_p
+0000b310: 6f6c 7967 6f6e 7320 2b3d 205f 626f 6f6c  olygons += _bool
+0000b320: 6561 6e5f 7265 6769 6f6e 5f70 6f6c 7967  ean_region_polyg
+0000b330: 6f6e 730a 0a20 2020 2072 6574 7572 6e20  ons..    return 
+0000b340: 626f 6f6c 6561 6e5f 706f 6c79 676f 6e73  boolean_polygons
+0000b350: 0a0a 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d  ...# ===========
 0000b360: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000b370: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2320  =============.# 
-0000b380: 4b4c 6179 6f75 7420 7574 696c 6974 7920  KLayout utility 
-0000b390: 6675 6e63 7469 6f6e 730a 2320 3d3d 3d3d  functions.# ====
-0000b3a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000b3b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000b3c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000b370: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000b380: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000b390: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000b3a0: 3d3d 3d0a 2320 4b4c 6179 6f75 7420 7574  ===.# KLayout ut
+0000b3b0: 696c 6974 7920 6675 6e63 7469 6f6e 730a  ility functions.
+0000b3c0: 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  # ==============
 0000b3d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000b3e0: 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a 0a64 6566  ==========...def
-0000b3f0: 205f 6b6c 5f70 6f6c 7967 6f6e 5f74 6f5f   _kl_polygon_to_
-0000b400: 6172 7261 7928 6b6c 5f70 6f6c 7967 6f6e  array(kl_polygon
-0000b410: 293a 0a20 2020 2072 6574 7572 6e20 5b28  ):.    return [(
-0000b420: 7074 2e78 2c20 7074 2e79 2920 666f 7220  pt.x, pt.y) for 
-0000b430: 7074 2069 6e20 6b6c 5f70 6f6c 7967 6f6e  pt in kl_polygon
-0000b440: 2e65 6163 685f 706f 696e 7428 295d 0a0a  .each_point()]..
-0000b450: 0a64 6566 205f 6f62 6a65 6374 735f 746f  .def _objects_to
-0000b460: 5f6b 6c5f 7265 6769 6f6e 2865 6c65 6d65  _kl_region(eleme
-0000b470: 6e74 732c 2070 7265 6369 7369 6f6e 293a  nts, precision):
-0000b480: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
-0000b490: 2020 696d 706f 7274 206b 6c61 796f 7574    import klayout
-0000b4a0: 2e64 6220 6173 206b 6462 0a20 2020 2065  .db as kdb.    e
-0000b4b0: 7863 6570 7420 496d 706f 7274 4572 726f  xcept ImportErro
-0000b4c0: 723a 0a20 2020 2020 2020 2072 6169 7365  r:.        raise
-0000b4d0: 2049 6d70 6f72 7445 7272 6f72 280a 2020   ImportError(.  
-0000b4e0: 2020 2020 2020 2020 2020 2250 4849 444c            "PHIDL
-0000b4f0: 2074 7269 6564 2074 6f20 696d 706f 7274   tried to import
-0000b500: 2074 6865 206b 6c61 796f 7574 206d 6f64   the klayout mod
-0000b510: 756c 6520 6275 7420 6974 2066 6169 6c65  ule but it faile
-0000b520: 642e 2050 6c65 6173 6520 220a 2020 2020  d. Please ".    
-0000b530: 2020 2020 2020 2020 2b20 2269 6e73 7461          + "insta
-0000b540: 6c6c 2074 6865 206b 6c61 796f 7574 2050  ll the klayout P
-0000b550: 7974 686f 6e20 7061 636b 6167 6520 7769  ython package wi
-0000b560: 7468 2022 0a20 2020 2020 2020 2020 2020  th ".           
-0000b570: 202b 2022 7069 7020 696e 7374 616c 6c20   + "pip install 
-0000b580: 6b6c 6179 6f75 7422 0a20 2020 2020 2020  klayout".       
-0000b590: 2029 0a20 2020 206b 6c5f 7265 6769 6f6e   ).    kl_region
-0000b5a0: 203d 206b 6462 2e52 6567 696f 6e28 290a   = kdb.Region().
-0000b5b0: 2020 2020 6966 2074 7970 6528 656c 656d      if type(elem
-0000b5c0: 656e 7473 2920 6e6f 7420 696e 2028 6c69  ents) not in (li
-0000b5d0: 7374 2c20 7475 706c 6529 3a0a 2020 2020  st, tuple):.    
-0000b5e0: 2020 2020 656c 656d 656e 7473 203d 205b      elements = [
-0000b5f0: 656c 656d 656e 7473 5d0a 2020 2020 706f  elements].    po
-0000b600: 6c79 676f 6e73 203d 205b 5d0a 2020 2020  lygons = [].    
-0000b610: 666f 7220 6520 696e 2065 6c65 6d65 6e74  for e in element
-0000b620: 733a 0a20 2020 2020 2020 2069 6620 6973  s:.        if is
-0000b630: 696e 7374 616e 6365 2865 2c20 4465 7669  instance(e, Devi
-0000b640: 6365 2920 6f72 2069 7369 6e73 7461 6e63  ce) or isinstanc
-0000b650: 6528 652c 2044 6576 6963 6552 6566 6572  e(e, DeviceRefer
-0000b660: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
-0000b670: 2020 2070 6f6c 7967 6f6e 732e 6578 7465     polygons.exte
-0000b680: 6e64 2865 2e67 6574 5f70 6f6c 7967 6f6e  nd(e.get_polygon
-0000b690: 7328 6279 5f73 7065 633d 4661 6c73 6529  s(by_spec=False)
-0000b6a0: 290a 2020 2020 2020 2020 656c 6966 2069  ).        elif i
-0000b6b0: 7369 6e73 7461 6e63 6528 652c 2050 6f6c  sinstance(e, Pol
-0000b6c0: 7967 6f6e 293a 0a20 2020 2020 2020 2020  ygon):.         
-0000b6d0: 2020 2070 6f6c 7967 6f6e 732e 6578 7465     polygons.exte
-0000b6e0: 6e64 285b 652e 706f 696e 7473 5d29 0a20  nd([e.points]). 
-0000b6f0: 2020 2070 6f6c 7967 6f6e 7320 3d20 5f6d     polygons = _m
-0000b700: 6572 6765 5f66 6c6f 6174 696e 675f 706f  erge_floating_po
-0000b710: 696e 745f 6572 726f 7273 2870 6f6c 7967  int_errors(polyg
-0000b720: 6f6e 732c 2074 6f6c 3d31 652d 3130 290a  ons, tol=1e-10).
-0000b730: 2020 2020 666f 7220 706f 696e 7473 2069      for points i
-0000b740: 6e20 706f 6c79 676f 6e73 3a0a 2020 2020  n polygons:.    
-0000b750: 2020 2020 7020 3d20 6b64 622e 5369 6d70      p = kdb.Simp
-0000b760: 6c65 506f 6c79 676f 6e28 0a20 2020 2020  lePolygon(.     
-0000b770: 2020 2020 2020 205b 6b64 622e 506f 696e         [kdb.Poin
-0000b780: 7428 7820 2f20 7072 6563 6973 696f 6e2c  t(x / precision,
-0000b790: 2079 202f 2070 7265 6369 7369 6f6e 2920   y / precision) 
-0000b7a0: 666f 7220 782c 2079 2069 6e20 706f 696e  for x, y in poin
-0000b7b0: 7473 5d0a 2020 2020 2020 2020 2920 2023  ts].        )  #
-0000b7c0: 2078 2061 6e64 2079 206d 7573 7420 6265   x and y must be
-0000b7d0: 2066 6c6f 6174 730a 2020 2020 2020 2020   floats.        
-0000b7e0: 6b6c 5f72 6567 696f 6e2e 696e 7365 7274  kl_region.insert
-0000b7f0: 2870 290a 2020 2020 7265 7475 726e 206b  (p).    return k
-0000b800: 6c5f 7265 6769 6f6e 0a0a 0a64 6566 205f  l_region...def _
-0000b810: 6b6c 5f72 6567 696f 6e5f 746f 5f64 6576  kl_region_to_dev
-0000b820: 6963 6528 6b6c 5f72 6567 696f 6e2c 206c  ice(kl_region, l
-0000b830: 6179 6572 2c20 6e61 6d65 2c20 7072 6563  ayer, name, prec
-0000b840: 6973 696f 6e29 3a0a 2020 2020 4420 3d20  ision):.    D = 
-0000b850: 4465 7669 6365 286e 616d 6529 0a20 2020  Device(name).   
-0000b860: 2066 6f72 2070 6f6c 7967 6f6e 2069 6e20   for polygon in 
-0000b870: 6b6c 5f72 6567 696f 6e2e 6561 6368 2829  kl_region.each()
-0000b880: 3a0a 2020 2020 2020 2020 706f 6c79 676f  :.        polygo
-0000b890: 6e20 3d20 706f 6c79 676f 6e2e 746f 5f73  n = polygon.to_s
-0000b8a0: 696d 706c 655f 706f 6c79 676f 6e28 290a  imple_polygon().
-0000b8b0: 2020 2020 2020 2020 706f 696e 7473 203d          points =
-0000b8c0: 205f 6b6c 5f70 6f6c 7967 6f6e 5f74 6f5f   _kl_polygon_to_
-0000b8d0: 6172 7261 7928 706f 6c79 676f 6e29 0a20  array(polygon). 
-0000b8e0: 2020 2020 2020 2070 6f69 6e74 7320 3d20         points = 
-0000b8f0: 6e70 2e61 7366 6172 7261 7928 706f 696e  np.asfarray(poin
-0000b900: 7473 2920 2a20 7072 6563 6973 696f 6e0a  ts) * precision.
-0000b910: 2020 2020 2020 2020 442e 6164 645f 706f          D.add_po
-0000b920: 6c79 676f 6e28 706f 696e 7473 2c20 6c61  lygon(points, la
-0000b930: 7965 723d 6c61 7965 7229 0a20 2020 2072  yer=layer).    r
-0000b940: 6574 7572 6e20 440a 0a0a 2320 3d3d 3d3d  eturn D...# ====
-0000b950: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000b960: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000b970: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000b980: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000b990: 3d3d 3d3d 3d3d 3d3d 3d3d 0a23 0a23 204b  ==========.#.# K
-0000b9a0: 4c61 796f 7574 2062 6f6f 6c65 616e 2066  Layout boolean f
-0000b9b0: 756e 6374 696f 6e73 0a23 0a23 203d 3d3d  unctions.#.# ===
+0000b3e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000b3f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000b400: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000b410: 0a0a 0a64 6566 205f 6b6c 5f70 6f6c 7967  ...def _kl_polyg
+0000b420: 6f6e 5f74 6f5f 6172 7261 7928 6b6c 5f70  on_to_array(kl_p
+0000b430: 6f6c 7967 6f6e 293a 0a20 2020 2072 6574  olygon):.    ret
+0000b440: 7572 6e20 5b28 7074 2e78 2c20 7074 2e79  urn [(pt.x, pt.y
+0000b450: 2920 666f 7220 7074 2069 6e20 6b6c 5f70  ) for pt in kl_p
+0000b460: 6f6c 7967 6f6e 2e65 6163 685f 706f 696e  olygon.each_poin
+0000b470: 7428 295d 0a0a 0a64 6566 205f 6f62 6a65  t()]...def _obje
+0000b480: 6374 735f 746f 5f6b 6c5f 7265 6769 6f6e  cts_to_kl_region
+0000b490: 2865 6c65 6d65 6e74 732c 2070 7265 6369  (elements, preci
+0000b4a0: 7369 6f6e 293a 0a20 2020 2074 7279 3a0a  sion):.    try:.
+0000b4b0: 2020 2020 2020 2020 696d 706f 7274 206b          import k
+0000b4c0: 6c61 796f 7574 2e64 6220 6173 206b 6462  layout.db as kdb
+0000b4d0: 0a20 2020 2065 7863 6570 7420 496d 706f  .    except Impo
+0000b4e0: 7274 4572 726f 723a 0a20 2020 2020 2020  rtError:.       
+0000b4f0: 2072 6169 7365 2049 6d70 6f72 7445 7272   raise ImportErr
+0000b500: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0000b510: 2250 4849 444c 2074 7269 6564 2074 6f20  "PHIDL tried to 
+0000b520: 696d 706f 7274 2074 6865 206b 6c61 796f  import the klayo
+0000b530: 7574 206d 6f64 756c 6520 6275 7420 6974  ut module but it
+0000b540: 2066 6169 6c65 642e 2050 6c65 6173 6520   failed. Please 
+0000b550: 220a 2020 2020 2020 2020 2020 2020 2b20  ".            + 
+0000b560: 2269 6e73 7461 6c6c 2074 6865 206b 6c61  "install the kla
+0000b570: 796f 7574 2050 7974 686f 6e20 7061 636b  yout Python pack
+0000b580: 6167 6520 7769 7468 2022 0a20 2020 2020  age with ".     
+0000b590: 2020 2020 2020 202b 2022 7069 7020 696e         + "pip in
+0000b5a0: 7374 616c 6c20 6b6c 6179 6f75 7422 0a20  stall klayout". 
+0000b5b0: 2020 2020 2020 2029 0a20 2020 2069 6620         ).    if 
+0000b5c0: 6973 696e 7374 616e 6365 2865 6c65 6d65  isinstance(eleme
+0000b5d0: 6e74 732c 206b 6462 2e52 6567 696f 6e29  nts, kdb.Region)
+0000b5e0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000b5f0: 2065 6c65 6d65 6e74 730a 2020 2020 6b6c   elements.    kl
+0000b600: 5f72 6567 696f 6e20 3d20 6b64 622e 5265  _region = kdb.Re
+0000b610: 6769 6f6e 2829 0a20 2020 2069 6620 7479  gion().    if ty
+0000b620: 7065 2865 6c65 6d65 6e74 7329 206e 6f74  pe(elements) not
+0000b630: 2069 6e20 286c 6973 742c 2074 7570 6c65   in (list, tuple
+0000b640: 293a 0a20 2020 2020 2020 2065 6c65 6d65  ):.        eleme
+0000b650: 6e74 7320 3d20 5b65 6c65 6d65 6e74 735d  nts = [elements]
+0000b660: 0a20 2020 2070 6f6c 7967 6f6e 7320 3d20  .    polygons = 
+0000b670: 5b5d 0a20 2020 2066 6f72 2065 2069 6e20  [].    for e in 
+0000b680: 656c 656d 656e 7473 3a0a 2020 2020 2020  elements:.      
+0000b690: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0000b6a0: 652c 2044 6576 6963 6529 206f 7220 6973  e, Device) or is
+0000b6b0: 696e 7374 616e 6365 2865 2c20 4465 7669  instance(e, Devi
+0000b6c0: 6365 5265 6665 7265 6e63 6529 3a0a 2020  ceReference):.  
+0000b6d0: 2020 2020 2020 2020 2020 706f 6c79 676f            polygo
+0000b6e0: 6e73 2e65 7874 656e 6428 652e 6765 745f  ns.extend(e.get_
+0000b6f0: 706f 6c79 676f 6e73 2862 795f 7370 6563  polygons(by_spec
+0000b700: 3d46 616c 7365 2929 0a20 2020 2020 2020  =False)).       
+0000b710: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+0000b720: 2865 2c20 506f 6c79 676f 6e29 3a0a 2020  (e, Polygon):.  
+0000b730: 2020 2020 2020 2020 2020 706f 6c79 676f            polygo
+0000b740: 6e73 2e65 7874 656e 6428 5b65 2e70 6f69  ns.extend([e.poi
+0000b750: 6e74 735d 290a 2020 2020 706f 6c79 676f  nts]).    polygo
+0000b760: 6e73 203d 205f 6d65 7267 655f 666c 6f61  ns = _merge_floa
+0000b770: 7469 6e67 5f70 6f69 6e74 5f65 7272 6f72  ting_point_error
+0000b780: 7328 706f 6c79 676f 6e73 2c20 746f 6c3d  s(polygons, tol=
+0000b790: 3165 2d31 3029 0a20 2020 2066 6f72 2070  1e-10).    for p
+0000b7a0: 6f69 6e74 7320 696e 2070 6f6c 7967 6f6e  oints in polygon
+0000b7b0: 733a 0a20 2020 2020 2020 2070 203d 206b  s:.        p = k
+0000b7c0: 6462 2e53 696d 706c 6550 6f6c 7967 6f6e  db.SimplePolygon
+0000b7d0: 280a 2020 2020 2020 2020 2020 2020 5b6b  (.            [k
+0000b7e0: 6462 2e50 6f69 6e74 2878 202f 2070 7265  db.Point(x / pre
+0000b7f0: 6369 7369 6f6e 2c20 7920 2f20 7072 6563  cision, y / prec
+0000b800: 6973 696f 6e29 2066 6f72 2078 2c20 7920  ision) for x, y 
+0000b810: 696e 2070 6f69 6e74 735d 0a20 2020 2020  in points].     
+0000b820: 2020 2029 2020 2320 7820 616e 6420 7920     )  # x and y 
+0000b830: 6d75 7374 2062 6520 666c 6f61 7473 0a20  must be floats. 
+0000b840: 2020 2020 2020 206b 6c5f 7265 6769 6f6e         kl_region
+0000b850: 2e69 6e73 6572 7428 7029 0a20 2020 2072  .insert(p).    r
+0000b860: 6574 7572 6e20 6b6c 5f72 6567 696f 6e0a  eturn kl_region.
+0000b870: 0a0a 6465 6620 5f6b 6c5f 7265 6769 6f6e  ..def _kl_region
+0000b880: 5f74 6f5f 6465 7669 6365 286b 6c5f 7265  _to_device(kl_re
+0000b890: 6769 6f6e 2c20 6c61 7965 722c 206e 616d  gion, layer, nam
+0000b8a0: 652c 2070 7265 6369 7369 6f6e 293a 0a20  e, precision):. 
+0000b8b0: 2020 2044 203d 2044 6576 6963 6528 6e61     D = Device(na
+0000b8c0: 6d65 290a 2020 2020 666f 7220 706f 6c79  me).    for poly
+0000b8d0: 676f 6e20 696e 206b 6c5f 7265 6769 6f6e  gon in kl_region
+0000b8e0: 2e65 6163 6828 293a 0a20 2020 2020 2020  .each():.       
+0000b8f0: 2070 6f6c 7967 6f6e 203d 2070 6f6c 7967   polygon = polyg
+0000b900: 6f6e 2e74 6f5f 7369 6d70 6c65 5f70 6f6c  on.to_simple_pol
+0000b910: 7967 6f6e 2829 0a20 2020 2020 2020 2070  ygon().        p
+0000b920: 6f69 6e74 7320 3d20 5f6b 6c5f 706f 6c79  oints = _kl_poly
+0000b930: 676f 6e5f 746f 5f61 7272 6179 2870 6f6c  gon_to_array(pol
+0000b940: 7967 6f6e 290a 2020 2020 2020 2020 706f  ygon).        po
+0000b950: 696e 7473 203d 206e 702e 6173 6661 7272  ints = np.asfarr
+0000b960: 6179 2870 6f69 6e74 7329 202a 2070 7265  ay(points) * pre
+0000b970: 6369 7369 6f6e 0a20 2020 2020 2020 2044  cision.        D
+0000b980: 2e61 6464 5f70 6f6c 7967 6f6e 2870 6f69  .add_polygon(poi
+0000b990: 6e74 732c 206c 6179 6572 3d6c 6179 6572  nts, layer=layer
+0000b9a0: 290a 2020 2020 7265 7475 726e 2044 0a0a  ).    return D..
+0000b9b0: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
 0000b9c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 0000b9d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 0000b9e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 0000b9f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000ba00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a0a 6465  ===========...de
-0000ba10: 6620 5f6b 6c5f 6578 7072 6573 7369 6f6e  f _kl_expression
-0000ba20: 280a 2020 2020 656c 656d 656e 745f 6469  (.    element_di
-0000ba30: 6374 2c20 2023 2065 2e67 2e20 6469 6374  ct,  # e.g. dict
-0000ba40: 2841 203d 2073 6e73 7064 2829 2c20 4220  (A = snspd(), B 
-0000ba50: 3d20 7067 2e65 6c6c 6970 7365 2829 290a  = pg.ellipse()).
-0000ba60: 2020 2020 6578 7072 6573 7369 6f6e 2c20      expression, 
-0000ba70: 2023 2065 2e67 2e20 2741 2e73 697a 6564   # e.g. 'A.sized
-0000ba80: 282d 3530 302c 2032 2920 2d20 4227 2c0a  (-500, 2) - B',.
-0000ba90: 2020 2020 7072 6563 6973 696f 6e3d 3165      precision=1e
-0000baa0: 2d34 2c0a 2020 2020 7469 6c65 5f73 697a  -4,.    tile_siz
-0000bab0: 653d 2831 3030 302c 2031 3030 3029 2c0a  e=(1000, 1000),.
-0000bac0: 2020 2020 6d65 7267 655f 6669 7273 743d      merge_first=
-0000bad0: 5472 7565 2c0a 2020 2020 6d65 7267 655f  True,.    merge_
-0000bae0: 6166 7465 723d 5472 7565 2c0a 2020 2020  after=True,.    
-0000baf0: 6f75 7470 7574 5f6e 616d 653d 2275 6e6e  output_name="unn
-0000bb00: 616d 6564 222c 0a20 2020 206e 756d 5f63  amed",.    num_c
-0000bb10: 7075 3d4e 554d 5f43 5055 2c0a 2020 2020  pu=NUM_CPU,.    
-0000bb20: 6c61 7965 723d 302c 0a29 3a0a 2020 2020  layer=0,.):.    
-0000bb30: 6c61 7965 7220 3d20 5f70 6172 7365 5f6c  layer = _parse_l
-0000bb40: 6179 6572 286c 6179 6572 290a 2020 2020  ayer(layer).    
-0000bb50: 6b6c 5f72 6567 696f 6e5f 6469 6374 203d  kl_region_dict =
-0000bb60: 207b 0a20 2020 2020 2020 206b 3a20 5f6f   {.        k: _o
-0000bb70: 626a 6563 7473 5f74 6f5f 6b6c 5f72 6567  bjects_to_kl_reg
-0000bb80: 696f 6e28 762c 2070 7265 6369 7369 6f6e  ion(v, precision
-0000bb90: 3d70 7265 6369 7369 6f6e 290a 2020 2020  =precision).    
-0000bba0: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
-0000bbb0: 656c 656d 656e 745f 6469 6374 2e69 7465  element_dict.ite
-0000bbc0: 6d73 2829 0a20 2020 207d 0a20 2020 2066  ms().    }.    f
-0000bbd0: 6f72 206b 6c5f 7265 6769 6f6e 2069 6e20  or kl_region in 
-0000bbe0: 6b6c 5f72 6567 696f 6e5f 6469 6374 2e76  kl_region_dict.v
-0000bbf0: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
-0000bc00: 206b 6c5f 7265 6769 6f6e 2e6d 6572 6765   kl_region.merge
-0000bc10: 645f 7365 6d61 6e74 6963 7320 3d20 6d65  d_semantics = me
-0000bc20: 7267 655f 6669 7273 740a 0a20 2020 2069  rge_first..    i
-0000bc30: 6d70 6f72 7420 6b6c 6179 6f75 742e 6462  mport klayout.db
-0000bc40: 2061 7320 6b64 620a 0a20 2020 2074 7020   as kdb..    tp 
-0000bc50: 3d20 6b64 622e 5469 6c69 6e67 5072 6f63  = kdb.TilingProc
-0000bc60: 6573 736f 7228 290a 2020 2020 7470 2e74  essor().    tp.t
-0000bc70: 6872 6561 6473 203d 206e 756d 5f63 7075  hreads = num_cpu
-0000bc80: 0a20 2020 2074 702e 7469 6c65 5f73 697a  .    tp.tile_siz
-0000bc90: 6528 7469 6c65 5f73 697a 655b 305d 202a  e(tile_size[0] *
-0000bca0: 2074 702e 6462 7520 2f20 7072 6563 6973   tp.dbu / precis
-0000bcb0: 696f 6e2c 2074 696c 655f 7369 7a65 5b30  ion, tile_size[0
-0000bcc0: 5d20 2a20 7470 2e64 6275 202f 2070 7265  ] * tp.dbu / pre
-0000bcd0: 6369 7369 6f6e 290a 2020 2020 666f 7220  cision).    for 
-0000bce0: 6e61 6d65 2c20 6b6c 5f72 6567 696f 6e20  name, kl_region 
-0000bcf0: 696e 206b 6c5f 7265 6769 6f6e 5f64 6963  in kl_region_dic
-0000bd00: 742e 6974 656d 7328 293a 0a20 2020 2020  t.items():.     
-0000bd10: 2020 2074 702e 696e 7075 7428 6e61 6d65     tp.input(name
-0000bd20: 2c20 6b6c 5f72 6567 696f 6e29 0a20 2020  , kl_region).   
-0000bd30: 206f 7574 7075 745f 7265 6769 6f6e 203d   output_region =
-0000bd40: 206b 6462 2e52 6567 696f 6e28 290a 2020   kdb.Region().  
-0000bd50: 2020 7470 2e6f 7574 7075 7428 226f 7574    tp.output("out
-0000bd60: 222c 206f 7574 7075 745f 7265 6769 6f6e  ", output_region
-0000bd70: 290a 2020 2020 7470 2e71 7565 7565 2866  ).    tp.queue(f
-0000bd80: 225f 6f75 7470 7574 286f 7574 2c20 7b65  "_output(out, {e
-0000bd90: 7870 7265 7373 696f 6e7d 2922 290a 2020  xpression})").  
-0000bda0: 2020 7470 2e65 7865 6375 7465 2822 7469    tp.execute("ti
-0000bdb0: 6c65 6420 6f70 6572 6174 696f 6e22 290a  led operation").
-0000bdc0: 0a20 2020 2069 6620 6d65 7267 655f 6166  .    if merge_af
-0000bdd0: 7465 7220 6973 2054 7275 653a 0a20 2020  ter is True:.   
-0000bde0: 2020 2020 206f 7574 7075 745f 7265 6769       output_regi
-0000bdf0: 6f6e 2e6d 6572 6765 2829 0a0a 2020 2020  on.merge()..    
-0000be00: 2320 4372 6561 7465 2074 6865 2044 6576  # Create the Dev
-0000be10: 6963 6520 616e 6420 6164 6420 7468 6520  ice and add the 
-0000be20: 7265 7375 6c74 696e 6720 6f66 6673 6574  resulting offset
-0000be30: 2072 6567 696f 6e20 746f 2069 740a 2020   region to it.  
-0000be40: 2020 4420 3d20 5f6b 6c5f 7265 6769 6f6e    D = _kl_region
-0000be50: 5f74 6f5f 6465 7669 6365 280a 2020 2020  _to_device(.    
-0000be60: 2020 2020 6f75 7470 7574 5f72 6567 696f      output_regio
-0000be70: 6e2c 206c 6179 6572 3d6c 6179 6572 2c20  n, layer=layer, 
-0000be80: 6e61 6d65 3d6f 7574 7075 745f 6e61 6d65  name=output_name
-0000be90: 2c20 7072 6563 6973 696f 6e3d 7072 6563  , precision=prec
-0000bea0: 6973 696f 6e0a 2020 2020 290a 0a20 2020  ision.    )..   
-0000beb0: 2023 2044 656c 6574 6520 7468 6520 7265   # Delete the re
-0000bec0: 6769 6f6e 7320 736f 2074 6865 7920 646f  gions so they do
-0000bed0: 6e27 7420 6861 6e67 2061 726f 756e 6420  n't hang around 
-0000bee0: 696e 206d 656d 6f72 790a 2020 2020 666f  in memory.    fo
-0000bef0: 7220 6b6c 5f72 6567 696f 6e20 696e 206b  r kl_region in k
-0000bf00: 6c5f 7265 6769 6f6e 5f64 6963 742e 7661  l_region_dict.va
-0000bf10: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
-0000bf20: 6b6c 5f72 6567 696f 6e2e 636c 6561 7228  kl_region.clear(
-0000bf30: 290a 2020 2020 2020 2020 6b6c 5f72 6567  ).        kl_reg
-0000bf40: 696f 6e2e 5f64 6573 7472 6f79 2829 0a0a  ion._destroy()..
-0000bf50: 2020 2020 7265 7475 726e 2044 0a0a 0a64      return D...d
-0000bf60: 6566 206b 6c5f 6f66 6673 6574 280a 2020  ef kl_offset(.  
-0000bf70: 2020 656c 656d 656e 7473 2c0a 2020 2020    elements,.    
-0000bf80: 6469 7374 616e 6365 3d30 2e31 2c0a 2020  distance=0.1,.  
-0000bf90: 2020 7072 6563 6973 696f 6e3d 3165 2d34    precision=1e-4
-0000bfa0: 2c0a 2020 2020 6d69 7465 725f 6d6f 6465  ,.    miter_mode
-0000bfb0: 3d32 2c0a 2020 2020 7469 6c65 5f73 697a  =2,.    tile_siz
-0000bfc0: 653d 2831 3030 302c 2031 3030 3029 2c0a  e=(1000, 1000),.
-0000bfd0: 2020 2020 6d65 7267 655f 6166 7465 723d      merge_after=
-0000bfe0: 5472 7565 2c0a 2020 2020 6c61 7965 723d  True,.    layer=
-0000bff0: 302c 0a29 3a0a 2020 2020 2222 2253 6872  0,.):.    """Shr
-0000c000: 696e 6b73 206f 7220 6578 7061 6e64 7320  inks or expands 
-0000c010: 6120 706f 6c79 676f 6e20 6f72 2073 6574  a polygon or set
-0000c020: 206f 6620 706f 6c79 676f 6e73 2075 7369   of polygons usi
-0000c030: 6e67 204b 4c61 796f 7574 0a0a 2020 2020  ng KLayout..    
-0000c040: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-0000c050: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 656c  ---------.    el
-0000c060: 656d 656e 7473 203a 2044 6576 6963 6528  ements : Device(
-0000c070: 2f52 6566 6572 656e 6365 292c 206c 6973  /Reference), lis
-0000c080: 7420 6f66 2044 6576 6963 6528 2f52 6566  t of Device(/Ref
-0000c090: 6572 656e 6365 292c 206f 7220 506f 6c79  erence), or Poly
-0000c0a0: 676f 6e0a 2020 2020 2020 2020 506f 6c79  gon.        Poly
-0000c0b0: 676f 6e73 2074 6f20 6f66 6673 6574 206f  gons to offset o
-0000c0c0: 7220 4465 7669 6365 2063 6f6e 7461 696e  r Device contain
-0000c0d0: 696e 6720 706f 6c79 676f 6e73 2074 6f20  ing polygons to 
-0000c0e0: 6f66 6673 6574 2e0a 2020 2020 6469 7374  offset..    dist
-0000c0f0: 616e 6365 203a 2069 6e74 206f 7220 666c  ance : int or fl
-0000c100: 6f61 740a 2020 2020 2020 2020 4469 7374  oat.        Dist
-0000c110: 616e 6365 2074 6f20 6f66 6673 6574 2070  ance to offset p
-0000c120: 6f6c 7967 6f6e 732e 2050 6f73 6974 6976  olygons. Positiv
-0000c130: 6520 7661 6c75 6573 2065 7870 616e 642c  e values expand,
-0000c140: 206e 6567 6174 6976 6520 7368 7269 6e6b   negative shrink
-0000c150: 2e0a 2020 2020 7072 6563 6973 696f 6e20  ..    precision 
-0000c160: 3a20 666c 6f61 740a 2020 2020 2020 2020  : float.        
-0000c170: 4465 7369 7265 6420 7072 6563 6973 696f  Desired precisio
-0000c180: 6e20 666f 7220 726f 756e 6469 6e67 2076  n for rounding v
-0000c190: 6572 7465 7820 636f 6f72 6469 6e61 7465  ertex coordinate
-0000c1a0: 732e 0a20 2020 206d 6974 6572 5f6d 6f64  s..    miter_mod
-0000c1b0: 6520 3a20 696e 740a 2020 2020 2020 2020  e : int.        
-0000c1c0: 5479 7065 206f 6620 636f 726e 6572 7320  Type of corners 
-0000c1d0: 6765 6e65 7261 7465 6420 6475 7269 6e67  generated during
-0000c1e0: 2074 6865 206f 6666 7365 7420 6f70 6572   the offset oper
-0000c1f0: 6174 696f 6e2c 2073 6565 0a20 2020 2020  ation, see.     
-0000c200: 2020 2068 7474 7073 3a2f 2f77 7777 2e6b     https://www.k
-0000c210: 6c61 796f 7574 2e64 652f 646f 632f 636f  layout.de/doc/co
-0000c220: 6465 2f63 6c61 7373 5f45 6467 6550 726f  de/class_EdgePro
-0000c230: 6365 7373 6f72 2e68 746d 6c23 6d65 7468  cessor.html#meth
-0000c240: 6f64 3535 0a20 2020 2074 696c 655f 7369  od55.    tile_si
-0000c250: 7a65 203a 2061 7272 6179 2d6c 696b 655b  ze : array-like[
-0000c260: 325d 0a20 2020 2020 2020 2054 6865 2074  2].        The t
-0000c270: 696c 6520 7369 7a65 2077 6974 6820 7768  ile size with wh
-0000c280: 6963 6820 7468 6520 6765 6f6d 6574 7279  ich the geometry
-0000c290: 2069 7320 6469 7669 6465 642e 2054 6869   is divided. Thi
-0000c2a0: 7320 616c 6c6f 7773 2066 6f72 2065 6163  s allows for eac
-0000c2b0: 680a 2020 2020 2020 2020 7265 6769 6f6e  h.        region
-0000c2c0: 2074 6f20 6265 7072 6f63 6573 7365 6420   to beprocessed 
-0000c2d0: 7365 7175 656e 7469 616c 6c79 2c20 7768  sequentially, wh
-0000c2e0: 6963 6820 6973 206d 6f72 6520 636f 6d70  ich is more comp
-0000c2f0: 7574 6174 696f 6e61 6c6c 790a 2020 2020  utationally.    
-0000c300: 2020 2020 6566 6669 6369 656e 7420 2861      efficient (a
-0000c310: 6e64 2063 616e 2062 6520 7275 6e20 696e  nd can be run in
-0000c320: 2070 6172 616c 6c65 6c20 6f6e 206d 756c   parallel on mul
-0000c330: 7469 706c 6520 4350 5520 636f 7265 7329  tiple CPU cores)
-0000c340: 2e0a 2020 2020 6d65 7267 655f 6166 7465  ..    merge_afte
-0000c350: 723a 2062 6f6f 6c0a 2020 2020 2020 2020  r: bool.        
-0000c360: 4d65 7267 6520 616c 6c20 7468 6520 706f  Merge all the po
-0000c370: 6c79 676f 6e73 2061 6674 6572 2070 6572  lygons after per
-0000c380: 666f 726d 696e 6720 7468 6520 6f66 6673  forming the offs
-0000c390: 6574 206f 7065 7261 7469 6f6e 0a20 2020  et operation.   
-0000c3a0: 206c 6179 6572 203a 2069 6e74 2c20 6172   layer : int, ar
-0000c3b0: 7261 792d 6c69 6b65 5b32 5d2c 206f 7220  ray-like[2], or 
-0000c3c0: 7365 740a 2020 2020 2020 2020 5370 6563  set.        Spec
-0000c3d0: 6966 6963 206c 6179 6572 2873 2920 746f  ific layer(s) to
-0000c3e0: 2070 7574 2070 6f6c 7967 6f6e 2067 656f   put polygon geo
-0000c3f0: 6d65 7472 7920 6f6e 2e0a 0a20 2020 2052  metry on...    R
-0000c400: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-0000c410: 2d2d 0a20 2020 2044 203a 2044 6576 6963  --.    D : Devic
-0000c420: 650a 2020 2020 2020 2020 4120 4465 7669  e.        A Devi
-0000c430: 6365 2063 6f6e 7461 696e 696e 6720 6120  ce containing a 
-0000c440: 706f 6c79 676f 6e28 7329 2077 6974 6820  polygon(s) with 
-0000c450: 7468 6520 7370 6563 6966 6965 6420 6f66  the specified of
-0000c460: 6673 6574 2061 7070 6c69 6564 2e0a 2020  fset applied..  
-0000c470: 2020 2222 220a 0a20 2020 2064 203d 2072    """..    d = r
-0000c480: 6f75 6e64 2864 6973 7461 6e63 6520 2f20  ound(distance / 
-0000c490: 7072 6563 6973 696f 6e29 2020 2320 5468  precision)  # Th
-0000c4a0: 6520 6469 7374 616e 6365 2069 6e20 6461  e distance in da
-0000c4b0: 7461 6261 7365 2075 6e69 7473 0a20 2020  tabase units.   
-0000c4c0: 2044 203d 205f 6b6c 5f65 7870 7265 7373   D = _kl_express
-0000c4d0: 696f 6e28 0a20 2020 2020 2020 2065 6c65  ion(.        ele
-0000c4e0: 6d65 6e74 5f64 6963 743d 6469 6374 2841  ment_dict=dict(A
-0000c4f0: 3d65 6c65 6d65 6e74 7329 2c0a 2020 2020  =elements),.    
-0000c500: 2020 2020 6578 7072 6573 7369 6f6e 3d66      expression=f
-0000c510: 2241 2e73 697a 6564 287b 647d 2c20 7b6d  "A.sized({d}, {m
-0000c520: 6974 6572 5f6d 6f64 657d 2922 2c0a 2020  iter_mode})",.  
-0000c530: 2020 2020 2020 7072 6563 6973 696f 6e3d        precision=
-0000c540: 7072 6563 6973 696f 6e2c 0a20 2020 2020  precision,.     
-0000c550: 2020 2074 696c 655f 7369 7a65 3d74 696c     tile_size=til
-0000c560: 655f 7369 7a65 2c0a 2020 2020 2020 2020  e_size,.        
-0000c570: 6d65 7267 655f 6669 7273 743d 5472 7565  merge_first=True
-0000c580: 2c0a 2020 2020 2020 2020 6d65 7267 655f  ,.        merge_
-0000c590: 6166 7465 723d 6d65 7267 655f 6166 7465  after=merge_afte
-0000c5a0: 722c 0a20 2020 2020 2020 206f 7574 7075  r,.        outpu
-0000c5b0: 745f 6e61 6d65 3d22 6f66 6673 6574 222c  t_name="offset",
-0000c5c0: 0a20 2020 2020 2020 206e 756d 5f63 7075  .        num_cpu
-0000c5d0: 3d4e 554d 5f43 5055 2c0a 2020 2020 2020  =NUM_CPU,.      
-0000c5e0: 2020 6c61 7965 723d 6c61 7965 722c 0a20    layer=layer,. 
-0000c5f0: 2020 2029 0a0a 2020 2020 7265 7475 726e     )..    return
-0000c600: 2044 0a0a 0a64 6566 206b 6c5f 626f 6f6c   D...def kl_bool
-0000c610: 6561 6e28 0a20 2020 2041 2c0a 2020 2020  ean(.    A,.    
-0000c620: 422c 0a20 2020 206f 7065 7261 7469 6f6e  B,.    operation
-0000c630: 2c0a 2020 2020 7072 6563 6973 696f 6e3d  ,.    precision=
-0000c640: 3165 2d34 2c0a 2020 2020 7469 6c65 5f73  1e-4,.    tile_s
-0000c650: 697a 653d 2831 3030 302c 2031 3030 3029  ize=(1000, 1000)
-0000c660: 2c0a 2020 2020 6d65 7267 655f 6166 7465  ,.    merge_afte
-0000c670: 723d 5472 7565 2c0a 2020 2020 6c61 7965  r=True,.    laye
-0000c680: 723d 302c 0a29 3a0a 2020 2020 2222 220a  r=0,.):.    """.
-0000c690: 2020 2020 5065 7266 6f72 6d73 2062 6f6f      Performs boo
-0000c6a0: 6c65 616e 206f 7065 7261 7469 6f6e 7320  lean operations 
-0000c6b0: 6265 7477 6565 6e20 3220 4465 7669 6365  between 2 Device
-0000c6c0: 2f44 6576 6963 6552 6566 6572 656e 6365  /DeviceReference
-0000c6d0: 206f 626a 6563 7473 2c0a 2020 2020 6f72   objects,.    or
-0000c6e0: 206c 6973 7473 206f 6620 4465 7669 6365   lists of Device
-0000c6f0: 732f 4465 7669 6365 5265 6665 7265 6e63  s/DeviceReferenc
-0000c700: 6573 2e0a 0a20 2020 2060 606f 7065 7261  es...    ``opera
-0000c710: 7469 6f6e 6060 2073 686f 756c 6420 6265  tion`` should be
-0000c720: 206f 6e65 206f 6620 7b27 6e6f 7427 2c20   one of {'not', 
-0000c730: 2761 6e64 272c 2027 6f72 272c 2027 786f  'and', 'or', 'xo
-0000c740: 7227 2c20 2741 2d42 272c 2027 422d 4127  r', 'A-B', 'B-A'
-0000c750: 2c20 2741 2b42 277d 2e0a 2020 2020 4e6f  , 'A+B'}..    No
-0000c760: 7465 2074 6861 7420 2741 2b42 2720 6973  te that 'A+B' is
-0000c770: 2065 7175 6976 616c 656e 7420 746f 2027   equivalent to '
-0000c780: 6f72 272c 2027 412d 4227 2069 7320 6571  or', 'A-B' is eq
-0000c790: 7569 7661 6c65 6e74 2074 6f20 276e 6f74  uivalent to 'not
-0000c7a0: 272c 2061 6e64 0a20 2020 2027 422d 4127  ', and.    'B-A'
-0000c7b0: 2069 7320 6571 7569 7661 6c65 6e74 2074   is equivalent t
-0000c7c0: 6f20 276e 6f74 2720 7769 7468 2074 6865  o 'not' with the
-0000c7d0: 206f 7065 7261 6e64 7320 7377 6974 6368   operands switch
-0000c7e0: 6564 0a0a 2020 2020 5061 7261 6d65 7465  ed..    Paramete
-0000c7f0: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-0000c800: 2d0a 2020 2020 4120 3a20 4465 7669 6365  -.    A : Device
-0000c810: 282f 5265 6665 7265 6e63 6529 206f 7220  (/Reference) or 
-0000c820: 6c69 7374 206f 6620 4465 7669 6365 282f  list of Device(/
-0000c830: 5265 6665 7265 6e63 6529 206f 7220 506f  Reference) or Po
-0000c840: 6c79 676f 6e0a 2020 2020 2020 2020 496e  lygon.        In
-0000c850: 7075 7420 4465 7669 6365 732e 0a20 2020  put Devices..   
-0000c860: 2042 203a 2044 6576 6963 6528 2f52 6566   B : Device(/Ref
-0000c870: 6572 656e 6365 2920 6f72 206c 6973 7420  erence) or list 
-0000c880: 6f66 2044 6576 6963 6528 2f52 6566 6572  of Device(/Refer
-0000c890: 656e 6365 2920 6f72 2050 6f6c 7967 6f6e  ence) or Polygon
-0000c8a0: 0a20 2020 2020 2020 2049 6e70 7574 2044  .        Input D
-0000c8b0: 6576 6963 6573 2e0a 2020 2020 6f70 6572  evices..    oper
-0000c8c0: 6174 696f 6e20 3a20 7b27 6e6f 7427 2c20  ation : {'not', 
-0000c8d0: 2761 6e64 272c 2027 6f72 272c 2027 786f  'and', 'or', 'xo
-0000c8e0: 7227 2c20 2741 2d42 272c 2027 422d 4127  r', 'A-B', 'B-A'
-0000c8f0: 2c20 2741 2b42 277d 0a20 2020 2020 2020  , 'A+B'}.       
-0000c900: 2042 6f6f 6c65 616e 206f 7065 7261 7469   Boolean operati
-0000c910: 6f6e 2074 6f20 7065 7266 6f72 6d2e 0a20  on to perform.. 
-0000c920: 2020 2070 7265 6369 7369 6f6e 203a 2066     precision : f
-0000c930: 6c6f 6174 0a20 2020 2020 2020 2044 6573  loat.        Des
-0000c940: 6972 6564 2070 7265 6369 7369 6f6e 2066  ired precision f
-0000c950: 6f72 2072 6f75 6e64 696e 6720 7665 7274  or rounding vert
-0000c960: 6578 2063 6f6f 7264 696e 6174 6573 2e0a  ex coordinates..
-0000c970: 2020 2020 7469 6c65 5f73 697a 6520 3a20      tile_size : 
-0000c980: 6172 7261 792d 6c69 6b65 5b32 5d0a 2020  array-like[2].  
-0000c990: 2020 2020 2020 5468 6520 7469 6c65 2073        The tile s
-0000c9a0: 697a 6520 7769 7468 2077 6869 6368 2074  ize with which t
-0000c9b0: 6865 2067 656f 6d65 7472 7920 6973 2064  he geometry is d
-0000c9c0: 6976 6964 6564 2e20 5468 6973 2061 6c6c  ivided. This all
-0000c9d0: 6f77 7320 666f 7220 6561 6368 0a20 2020  ows for each.   
-0000c9e0: 2020 2020 2072 6567 696f 6e20 746f 2062       region to b
-0000c9f0: 6570 726f 6365 7373 6564 2073 6571 7565  eprocessed seque
-0000ca00: 6e74 6961 6c6c 792c 2077 6869 6368 2069  ntially, which i
-0000ca10: 7320 6d6f 7265 2063 6f6d 7075 7461 7469  s more computati
-0000ca20: 6f6e 616c 6c79 0a20 2020 2020 2020 2065  onally.        e
-0000ca30: 6666 6963 6965 6e74 2028 616e 6420 6361  fficient (and ca
-0000ca40: 6e20 6265 2072 756e 2069 6e20 7061 7261  n be run in para
-0000ca50: 6c6c 656c 206f 6e20 6d75 6c74 6970 6c65  llel on multiple
-0000ca60: 2043 5055 2063 6f72 6573 292e 0a20 2020   CPU cores)..   
-0000ca70: 206d 6572 6765 5f61 6674 6572 3a20 626f   merge_after: bo
-0000ca80: 6f6c 0a20 2020 2020 2020 204d 6572 6765  ol.        Merge
-0000ca90: 2061 6c6c 2074 6865 2070 6f6c 7967 6f6e   all the polygon
-0000caa0: 7320 6166 7465 7220 7065 7266 6f72 6d69  s after performi
-0000cab0: 6e67 2074 6865 2074 696c 6564 2062 6f6f  ng the tiled boo
-0000cac0: 6c65 616e 206f 7065 7261 7469 6f6e 0a20  lean operation. 
-0000cad0: 2020 206c 6179 6572 203a 2069 6e74 2c20     layer : int, 
-0000cae0: 6172 7261 792d 6c69 6b65 5b32 5d2c 206f  array-like[2], o
-0000caf0: 7220 7365 740a 2020 2020 2020 2020 5370  r set.        Sp
-0000cb00: 6563 6966 6963 206c 6179 6572 2873 2920  ecific layer(s) 
-0000cb10: 746f 2070 7574 2070 6f6c 7967 6f6e 2067  to put polygon g
-0000cb20: 656f 6d65 7472 7920 6f6e 2e0a 0a20 2020  eometry on...   
-0000cb30: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
-0000cb40: 2d2d 2d2d 0a20 2020 2044 203a 2044 6576  ----.    D : Dev
-0000cb50: 6963 650a 2020 2020 2020 2020 4120 4465  ice.        A De
-0000cb60: 7669 6365 2063 6f6e 7461 696e 696e 6720  vice containing 
-0000cb70: 6120 706f 6c79 676f 6e28 7329 2077 6974  a polygon(s) wit
-0000cb80: 6820 7468 6520 626f 6f6c 6561 6e20 6f70  h the boolean op
-0000cb90: 6572 6174 696f 6e20 6170 706c 6965 642e  eration applied.
-0000cba0: 0a20 2020 2022 2222 0a0a 2020 2020 6f70  .    """..    op
-0000cbb0: 6572 6174 696f 6e20 3d20 6f70 6572 6174  eration = operat
-0000cbc0: 696f 6e2e 6c6f 7765 7228 292e 7265 706c  ion.lower().repl
-0000cbd0: 6163 6528 2220 222c 2022 2229 0a20 2020  ace(" ", "").   
-0000cbe0: 2069 6620 6f70 6572 6174 696f 6e20 696e   if operation in
-0000cbf0: 207b 2261 2d62 222c 2022 6e6f 7422 7d3a   {"a-b", "not"}:
-0000cc00: 0a20 2020 2020 2020 206f 7065 7261 7469  .        operati
-0000cc10: 6f6e 5f6b 6c20 3d20 222d 220a 2020 2020  on_kl = "-".    
-0000cc20: 656c 6966 206f 7065 7261 7469 6f6e 2069  elif operation i
-0000cc30: 6e20 7b22 622d 6122 7d3a 0a20 2020 2020  n {"b-a"}:.     
-0000cc40: 2020 206f 7065 7261 7469 6f6e 5f6b 6c20     operation_kl 
-0000cc50: 3d20 222d 220a 2020 2020 656c 6966 206f  = "-".    elif o
-0000cc60: 7065 7261 7469 6f6e 2069 6e20 7b22 612b  peration in {"a+
-0000cc70: 6222 2c20 226f 7222 7d3a 0a20 2020 2020  b", "or"}:.     
-0000cc80: 2020 206f 7065 7261 7469 6f6e 5f6b 6c20     operation_kl 
-0000cc90: 3d20 222b 220a 2020 2020 656c 6966 206f  = "+".    elif o
-0000cca0: 7065 7261 7469 6f6e 2069 6e20 7b22 615e  peration in {"a^
-0000ccb0: 6222 2c20 2278 6f72 227d 3a0a 2020 2020  b", "xor"}:.    
-0000ccc0: 2020 2020 6f70 6572 6174 696f 6e5f 6b6c      operation_kl
-0000ccd0: 203d 2022 5e22 0a20 2020 2065 6c69 6620   = "^".    elif 
-0000cce0: 6f70 6572 6174 696f 6e20 696e 207b 2261  operation in {"a
-0000ccf0: 2662 222c 2022 616e 6422 7d3a 0a20 2020  &b", "and"}:.   
-0000cd00: 2020 2020 206f 7065 7261 7469 6f6e 5f6b       operation_k
-0000cd10: 6c20 3d20 2226 220a 2020 2020 656c 7365  l = "&".    else
-0000cd20: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-0000cd30: 5661 6c75 6545 7272 6f72 280a 2020 2020  ValueError(.    
-0000cd40: 2020 2020 2020 2020 225b 5048 4944 4c5d          "[PHIDL]
-0000cd50: 2070 6869 646c 2e67 656f 6d65 7472 792e   phidl.geometry.
-0000cd60: 626f 6f6c 6561 6e28 2920 606f 7065 7261  boolean() `opera
-0000cd70: 7469 6f6e 6020 7061 7261 6d65 7465 7222  tion` parameter"
-0000cd80: 0a20 2020 2020 2020 2020 2020 202b 2022  .            + "
-0000cd90: 206e 6f74 2072 6563 6f67 6e69 7a65 642c   not recognized,
-0000cda0: 206d 7573 7420 6265 206f 6e65 206f 6620   must be one of 
-0000cdb0: 7468 6520 666f 6c6c 6f77 696e 673a 2020  the following:  
-0000cdc0: 276e 6f74 272c 220a 2020 2020 2020 2020  'not',".        
-0000cdd0: 2020 2020 2b20 2220 2761 6e64 272c 2027      + " 'and', '
-0000cde0: 6f72 272c 2027 786f 7227 2c20 2741 2d42  or', 'xor', 'A-B
-0000cdf0: 272c 2027 422d 4127 2c20 2741 2b42 272c  ', 'B-A', 'A+B',
-0000ce00: 2020 2741 2642 272c 2027 415e 4227 220a    'A&B', 'A^B'".
-0000ce10: 2020 2020 2020 2020 290a 0a20 2020 2044          )..    D
-0000ce20: 203d 205f 6b6c 5f65 7870 7265 7373 696f   = _kl_expressio
-0000ce30: 6e28 0a20 2020 2020 2020 2065 6c65 6d65  n(.        eleme
-0000ce40: 6e74 5f64 6963 743d 6469 6374 2841 3d41  nt_dict=dict(A=A
-0000ce50: 2c20 423d 4229 2c0a 2020 2020 2020 2020  , B=B),.        
-0000ce60: 6578 7072 6573 7369 6f6e 3d66 2241 207b  expression=f"A {
-0000ce70: 6f70 6572 6174 696f 6e5f 6b6c 7d20 4222  operation_kl} B"
-0000ce80: 2c0a 2020 2020 2020 2020 7072 6563 6973  ,.        precis
-0000ce90: 696f 6e3d 7072 6563 6973 696f 6e2c 0a20  ion=precision,. 
-0000cea0: 2020 2020 2020 2074 696c 655f 7369 7a65         tile_size
-0000ceb0: 3d74 696c 655f 7369 7a65 2c0a 2020 2020  =tile_size,.    
-0000cec0: 2020 2020 6d65 7267 655f 6669 7273 743d      merge_first=
-0000ced0: 5472 7565 2c0a 2020 2020 2020 2020 6d65  True,.        me
-0000cee0: 7267 655f 6166 7465 723d 6d65 7267 655f  rge_after=merge_
-0000cef0: 6166 7465 722c 0a20 2020 2020 2020 206f  after,.        o
-0000cf00: 7574 7075 745f 6e61 6d65 3d22 626f 6f6c  utput_name="bool
-0000cf10: 6561 6e22 2c0a 2020 2020 2020 2020 6e75  ean",.        nu
-0000cf20: 6d5f 6370 753d 4e55 4d5f 4350 552c 0a20  m_cpu=NUM_CPU,. 
-0000cf30: 2020 2020 2020 206c 6179 6572 3d6c 6179         layer=lay
-0000cf40: 6572 2c0a 2020 2020 290a 0a20 2020 2072  er,.    )..    r
-0000cf50: 6574 7572 6e20 440a 0a0a 6465 6620 6b6c  eturn D...def kl
-0000cf60: 5f6f 7574 6c69 6e65 280a 2020 2020 656c  _outline(.    el
-0000cf70: 656d 656e 7473 2c0a 2020 2020 6469 7374  ements,.    dist
-0000cf80: 616e 6365 3d30 2e31 2c0a 2020 2020 6f70  ance=0.1,.    op
-0000cf90: 656e 5f70 6f72 7473 3d46 616c 7365 2c0a  en_ports=False,.
-0000cfa0: 2020 2020 7072 6563 6973 696f 6e3d 3165      precision=1e
-0000cfb0: 2d34 2c0a 2020 2020 6d69 7465 725f 6d6f  -4,.    miter_mo
-0000cfc0: 6465 3d32 2c0a 2020 2020 7469 6c65 5f73  de=2,.    tile_s
-0000cfd0: 697a 653d 2831 3030 302c 2031 3030 3029  ize=(1000, 1000)
-0000cfe0: 2c0a 2020 2020 6d65 7267 655f 6166 7465  ,.    merge_afte
-0000cff0: 723d 5472 7565 2c0a 2020 2020 6c61 7965  r=True,.    laye
-0000d000: 723d 302c 0a29 3a0a 2020 2020 2222 2253  r=0,.):.    """S
-0000d010: 6872 696e 6b73 206f 7220 6578 7061 6e64  hrinks or expand
-0000d020: 7320 6120 706f 6c79 676f 6e20 6f72 2073  s a polygon or s
-0000d030: 6574 206f 6620 706f 6c79 676f 6e73 2075  et of polygons u
-0000d040: 7369 6e67 204b 4c61 796f 7574 0a0a 2020  sing KLayout..  
-0000d050: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-0000d060: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-0000d070: 656c 656d 656e 7473 203a 2044 6576 6963  elements : Devic
-0000d080: 6528 2f52 6566 6572 656e 6365 292c 206c  e(/Reference), l
-0000d090: 6973 7420 6f66 2044 6576 6963 6528 2f52  ist of Device(/R
-0000d0a0: 6566 6572 656e 6365 292c 206f 7220 506f  eference), or Po
-0000d0b0: 6c79 676f 6e0a 2020 2020 2020 2020 506f  lygon.        Po
-0000d0c0: 6c79 676f 6e73 2074 6f20 6f66 6673 6574  lygons to offset
-0000d0d0: 206f 7220 4465 7669 6365 2063 6f6e 7461   or Device conta
-0000d0e0: 696e 696e 6720 706f 6c79 676f 6e73 2074  ining polygons t
-0000d0f0: 6f20 6f66 6673 6574 2e0a 2020 2020 6469  o offset..    di
-0000d100: 7374 616e 6365 203a 2069 6e74 206f 7220  stance : int or 
-0000d110: 666c 6f61 740a 2020 2020 2020 2020 4469  float.        Di
-0000d120: 7374 616e 6365 2074 6f20 6f66 6673 6574  stance to offset
-0000d130: 2070 6f6c 7967 6f6e 732e 2050 6f73 6974   polygons. Posit
-0000d140: 6976 6520 7661 6c75 6573 2065 7870 616e  ive values expan
-0000d150: 642c 206e 6567 6174 6976 6520 7368 7269  d, negative shri
-0000d160: 6e6b 2e0a 2020 2020 6f70 656e 5f70 6f72  nk..    open_por
-0000d170: 7473 203a 2062 6f6f 6c20 6f72 2066 6c6f  ts : bool or flo
-0000d180: 6174 0a20 2020 2020 2020 2049 6620 6e6f  at.        If no
-0000d190: 7420 4661 6c73 652c 2068 6f6c 6573 2077  t False, holes w
-0000d1a0: 696c 6c20 6265 2063 7574 2069 6e20 7468  ill be cut in th
-0000d1b0: 6520 6f75 746c 696e 6520 7375 6368 2074  e outline such t
-0000d1c0: 6861 7420 7468 6520 506f 7274 7320 6172  hat the Ports ar
-0000d1d0: 650a 2020 2020 2020 2020 6e6f 7420 636f  e.        not co
-0000d1e0: 7665 7265 642e 2049 6620 5472 7565 2c20  vered. If True, 
-0000d1f0: 7468 6520 686f 6c65 7320 7769 6c6c 2068  the holes will h
-0000d200: 6176 6520 7468 6520 7361 6d65 2077 6964  ave the same wid
-0000d210: 7468 2061 7320 7468 6520 506f 7274 732e  th as the Ports.
-0000d220: 0a20 2020 2020 2020 2049 6620 6120 666c  .        If a fl
-0000d230: 6f61 742c 2074 6865 2068 6f6c 6573 2077  oat, the holes w
-0000d240: 696c 6c20 6265 2062 6520 7769 6465 6e65  ill be be widene
-0000d250: 6420 6279 2074 6861 7420 7661 6c75 6520  d by that value 
-0000d260: 2875 7365 6675 6c20 666f 7220 6675 6c6c  (useful for full
-0000d270: 790a 2020 2020 2020 2020 636c 6561 7269  y.        cleari
-0000d280: 6e67 2074 6865 206f 7574 6c69 6e65 2061  ng the outline a
-0000d290: 726f 756e 6420 7468 6520 506f 7274 7320  round the Ports 
-0000d2a0: 666f 7220 706f 7369 7469 7665 2d74 6f6e  for positive-ton
-0000d2b0: 6520 7072 6f63 6573 7365 730a 2020 2020  e processes.    
-0000d2c0: 7072 6563 6973 696f 6e20 3a20 666c 6f61  precision : floa
-0000d2d0: 740a 2020 2020 2020 2020 4465 7369 7265  t.        Desire
-0000d2e0: 6420 7072 6563 6973 696f 6e20 666f 7220  d precision for 
-0000d2f0: 726f 756e 6469 6e67 2076 6572 7465 7820  rounding vertex 
-0000d300: 636f 6f72 6469 6e61 7465 732e 0a20 2020  coordinates..   
-0000d310: 206d 6974 6572 5f6d 6f64 6520 3a20 696e   miter_mode : in
-0000d320: 740a 2020 2020 2020 2020 5479 7065 206f  t.        Type o
-0000d330: 6620 636f 726e 6572 7320 6765 6e65 7261  f corners genera
-0000d340: 7465 6420 6475 7269 6e67 2074 6865 206f  ted during the o
-0000d350: 6666 7365 7420 6f70 6572 6174 696f 6e2c  ffset operation,
-0000d360: 2073 6565 0a20 2020 2020 2020 2068 7474   see.        htt
-0000d370: 7073 3a2f 2f77 7777 2e6b 6c61 796f 7574  ps://www.klayout
-0000d380: 2e64 652f 646f 632f 636f 6465 2f63 6c61  .de/doc/code/cla
-0000d390: 7373 5f45 6467 6550 726f 6365 7373 6f72  ss_EdgeProcessor
-0000d3a0: 2e68 746d 6c23 6d65 7468 6f64 3535 0a20  .html#method55. 
-0000d3b0: 2020 2074 696c 655f 7369 7a65 203a 2061     tile_size : a
-0000d3c0: 7272 6179 2d6c 696b 655b 325d 0a20 2020  rray-like[2].   
-0000d3d0: 2020 2020 2054 6865 2074 696c 6520 7369       The tile si
-0000d3e0: 7a65 2077 6974 6820 7768 6963 6820 7468  ze with which th
-0000d3f0: 6520 6765 6f6d 6574 7279 2069 7320 6469  e geometry is di
-0000d400: 7669 6465 642e 2054 6869 7320 616c 6c6f  vided. This allo
-0000d410: 7773 2066 6f72 2065 6163 680a 2020 2020  ws for each.    
-0000d420: 2020 2020 7265 6769 6f6e 2074 6f20 6265      region to be
-0000d430: 7072 6f63 6573 7365 6420 7365 7175 656e  processed sequen
-0000d440: 7469 616c 6c79 2c20 7768 6963 6820 6973  tially, which is
-0000d450: 206d 6f72 6520 636f 6d70 7574 6174 696f   more computatio
-0000d460: 6e61 6c6c 790a 2020 2020 2020 2020 6566  nally.        ef
-0000d470: 6669 6369 656e 7420 2861 6e64 2063 616e  ficient (and can
-0000d480: 2062 6520 7275 6e20 696e 2070 6172 616c   be run in paral
-0000d490: 6c65 6c20 6f6e 206d 756c 7469 706c 6520  lel on multiple 
-0000d4a0: 4350 5520 636f 7265 7329 2e0a 2020 2020  CPU cores)..    
-0000d4b0: 6d65 7267 655f 6166 7465 723a 2062 6f6f  merge_after: boo
-0000d4c0: 6c0a 2020 2020 2020 2020 4d65 7267 6520  l.        Merge 
-0000d4d0: 616c 6c20 7468 6520 706f 6c79 676f 6e73  all the polygons
-0000d4e0: 2061 6674 6572 2070 6572 666f 726d 696e   after performin
-0000d4f0: 6720 7468 6520 6f75 746c 696e 6520 6f70  g the outline op
-0000d500: 6572 6174 696f 6e0a 2020 2020 6c61 7965  eration.    laye
-0000d510: 7220 3a20 696e 742c 2061 7272 6179 2d6c  r : int, array-l
-0000d520: 696b 655b 325d 2c20 6f72 2073 6574 0a20  ike[2], or set. 
-0000d530: 2020 2020 2020 2053 7065 6369 6669 6320         Specific 
-0000d540: 6c61 7965 7228 7329 2074 6f20 7075 7420  layer(s) to put 
-0000d550: 706f 6c79 676f 6e20 6765 6f6d 6574 7279  polygon geometry
-0000d560: 206f 6e2e 0a0a 2020 2020 5265 7475 726e   on...    Return
-0000d570: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-0000d580: 2020 4420 3a20 4465 7669 6365 0a20 2020    D : Device.   
-0000d590: 2020 2020 2041 2044 6576 6963 6520 636f       A Device co
-0000d5a0: 6e74 6169 6e69 6e67 2061 2070 6f6c 7967  ntaining a polyg
-0000d5b0: 6f6e 2873 2920 7769 7468 2074 6865 2073  on(s) with the s
-0000d5c0: 7065 6369 6669 6564 206f 6666 7365 7420  pecified offset 
-0000d5d0: 6170 706c 6965 642e 0a20 2020 2022 2222  applied..    """
-0000d5e0: 0a0a 2020 2020 6420 3d20 726f 756e 6428  ..    d = round(
-0000d5f0: 6469 7374 616e 6365 202f 2070 7265 6369  distance / preci
-0000d600: 7369 6f6e 2920 2023 2054 6865 2064 6973  sion)  # The dis
-0000d610: 7461 6e63 6520 696e 2064 6174 6162 6173  tance in databas
-0000d620: 6520 756e 6974 730a 0a20 2020 2023 2047  e units..    # G
-0000d630: 6574 206c 6973 7420 6f66 2070 6f72 7473  et list of ports
-0000d640: 2074 6f20 6265 206f 7065 6e65 640a 2020   to be opened.  
-0000d650: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
-0000d660: 6e63 6528 656c 656d 656e 7473 2c20 6c69  nce(elements, li
-0000d670: 7374 293a 0a20 2020 2020 2020 2065 6c65  st):.        ele
-0000d680: 6d65 6e74 7320 3d20 5b65 6c65 6d65 6e74  ments = [element
-0000d690: 735d 0a20 2020 2070 6f72 745f 6c69 7374  s].    port_list
-0000d6a0: 203d 205b 5d0a 2020 2020 666f 7220 6520   = [].    for e 
-0000d6b0: 696e 2065 6c65 6d65 6e74 733a 0a20 2020  in elements:.   
-0000d6c0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-0000d6d0: 6365 2865 2c20 4465 7669 6365 293a 0a20  ce(e, Device):. 
-0000d6e0: 2020 2020 2020 2020 2020 2070 6f72 745f             port_
-0000d6f0: 6c69 7374 202b 3d20 6c69 7374 2865 2e70  list += list(e.p
-0000d700: 6f72 7473 2e76 616c 7565 7328 2929 0a0a  orts.values())..
-0000d710: 2020 2020 5472 696d 203d 2044 6576 6963      Trim = Devic
-0000d720: 6528 290a 2020 2020 6966 206f 7065 6e5f  e().    if open_
-0000d730: 706f 7274 7320 6973 206e 6f74 2046 616c  ports is not Fal
-0000d740: 7365 3a0a 2020 2020 2020 2020 6966 206f  se:.        if o
-0000d750: 7065 6e5f 706f 7274 7320 6973 2054 7275  pen_ports is Tru
-0000d760: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
-0000d770: 7269 6d5f 7769 6474 6820 3d20 300a 2020  rim_width = 0.  
-0000d780: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000d790: 2020 2020 2020 2020 7472 696d 5f77 6964          trim_wid
-0000d7a0: 7468 203d 206f 7065 6e5f 706f 7274 7320  th = open_ports 
-0000d7b0: 2a20 320a 2020 2020 2020 2020 666f 7220  * 2.        for 
-0000d7c0: 706f 7274 2069 6e20 706f 7274 5f6c 6973  port in port_lis
-0000d7d0: 743a 0a20 2020 2020 2020 2020 2020 2074  t:.            t
-0000d7e0: 7269 6d20 3d20 636f 6d70 6173 7328 7369  rim = compass(si
-0000d7f0: 7a65 3d28 6469 7374 616e 6365 202b 2036  ze=(distance + 6
-0000d800: 202a 2070 7265 6369 7369 6f6e 2c20 706f   * precision, po
-0000d810: 7274 2e77 6964 7468 202b 2074 7269 6d5f  rt.width + trim_
-0000d820: 7769 6474 6829 290a 2020 2020 2020 2020  width)).        
-0000d830: 2020 2020 7472 696d 5f72 6566 203d 2054      trim_ref = T
-0000d840: 7269 6d20 3c3c 2074 7269 6d0a 2020 2020  rim << trim.    
-0000d850: 2020 2020 2020 2020 7472 696d 5f72 6566          trim_ref
-0000d860: 2e63 6f6e 6e65 6374 2822 4522 2c20 706f  .connect("E", po
-0000d870: 7274 2c20 6f76 6572 6c61 703d 3220 2a20  rt, overlap=2 * 
-0000d880: 7072 6563 6973 696f 6e29 0a0a 2020 2020  precision)..    
-0000d890: 4420 3d20 5f6b 6c5f 6578 7072 6573 7369  D = _kl_expressi
-0000d8a0: 6f6e 280a 2020 2020 2020 2020 656c 656d  on(.        elem
-0000d8b0: 656e 745f 6469 6374 3d64 6963 7428 413d  ent_dict=dict(A=
-0000d8c0: 656c 656d 656e 7473 2c20 423d 5472 696d  elements, B=Trim
-0000d8d0: 292c 0a20 2020 2020 2020 2065 7870 7265  ),.        expre
-0000d8e0: 7373 696f 6e3d 6622 412e 7369 7a65 6428  ssion=f"A.sized(
-0000d8f0: 7b64 7d2c 207b 6d69 7465 725f 6d6f 6465  {d}, {miter_mode
-0000d900: 7d29 202d 2028 4120 2b20 4229 222c 0a20  }) - (A + B)",. 
-0000d910: 2020 2020 2020 2070 7265 6369 7369 6f6e         precision
-0000d920: 3d70 7265 6369 7369 6f6e 2c0a 2020 2020  =precision,.    
-0000d930: 2020 2020 7469 6c65 5f73 697a 653d 7469      tile_size=ti
-0000d940: 6c65 5f73 697a 652c 0a20 2020 2020 2020  le_size,.       
-0000d950: 206d 6572 6765 5f66 6972 7374 3d54 7275   merge_first=Tru
-0000d960: 652c 0a20 2020 2020 2020 206d 6572 6765  e,.        merge
-0000d970: 5f61 6674 6572 3d6d 6572 6765 5f61 6674  _after=merge_aft
-0000d980: 6572 2c0a 2020 2020 2020 2020 6f75 7470  er,.        outp
-0000d990: 7574 5f6e 616d 653d 226f 7574 6c69 6e65  ut_name="outline
-0000d9a0: 222c 0a20 2020 2020 2020 206e 756d 5f63  ",.        num_c
-0000d9b0: 7075 3d4e 554d 5f43 5055 2c0a 2020 2020  pu=NUM_CPU,.    
-0000d9c0: 2020 2020 6c61 7965 723d 6c61 7965 722c      layer=layer,
-0000d9d0: 0a20 2020 2029 0a0a 2020 2020 6966 206f  .    )..    if o
-0000d9e0: 7065 6e5f 706f 7274 7320 6973 206e 6f74  pen_ports is not
-0000d9f0: 2046 616c 7365 2061 6e64 206c 656e 2865   False and len(e
-0000da00: 6c65 6d65 6e74 7329 203d 3d20 313a 0a20  lements) == 1:. 
-0000da10: 2020 2020 2020 2066 6f72 2070 6f72 7420         for port 
-0000da20: 696e 2070 6f72 745f 6c69 7374 3a0a 2020  in port_list:.  
-0000da30: 2020 2020 2020 2020 2020 442e 6164 645f            D.add_
-0000da40: 706f 7274 2870 6f72 743d 706f 7274 290a  port(port=port).
-0000da50: 0a20 2020 2072 6574 7572 6e20 440a 0a0a  .    return D...
-0000da60: 6465 6620 6b6c 5f69 6e76 6572 7428 0a20  def kl_invert(. 
-0000da70: 2020 2065 6c65 6d65 6e74 732c 0a20 2020     elements,.   
-0000da80: 2062 6f72 6465 723d 2831 302c 2031 3029   border=(10, 10)
-0000da90: 2c0a 2020 2020 7072 6563 6973 696f 6e3d  ,.    precision=
-0000daa0: 3165 2d34 2c0a 2020 2020 7469 6c65 5f73  1e-4,.    tile_s
-0000dab0: 697a 653d 2831 3030 302c 2031 3030 3029  ize=(1000, 1000)
-0000dac0: 2c0a 2020 2020 6d65 7267 655f 6166 7465  ,.    merge_afte
-0000dad0: 723d 5472 7565 2c0a 2020 2020 6c61 7965  r=True,.    laye
-0000dae0: 723d 302c 0a29 3a0a 2020 2020 2222 2243  r=0,.):.    """C
-0000daf0: 7265 6174 6573 2061 6e20 696e 7665 7274  reates an invert
-0000db00: 6564 2076 6572 7369 6f6e 206f 6620 7468  ed version of th
-0000db10: 6520 696e 7075 7420 7368 6170 6573 2077  e input shapes w
-0000db20: 6974 6820 616e 2061 6464 6974 696f 6e61  ith an additiona
-0000db30: 6c0a 2020 2020 626f 7264 6572 2061 726f  l.    border aro
-0000db40: 756e 6420 7468 6520 6564 6765 732e 0a0a  und the edges...
-0000db50: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-0000db60: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-0000db70: 2020 656c 656d 656e 7473 203a 2044 6576    elements : Dev
-0000db80: 6963 6528 2f52 6566 6572 656e 6365 292c  ice(/Reference),
-0000db90: 206c 6973 7420 6f66 2044 6576 6963 6528   list of Device(
-0000dba0: 2f52 6566 6572 656e 6365 292c 206f 7220  /Reference), or 
-0000dbb0: 506f 6c79 676f 6e0a 2020 2020 2020 2020  Polygon.        
-0000dbc0: 4120 4465 7669 6365 2063 6f6e 7461 696e  A Device contain
-0000dbd0: 696e 6720 7468 6520 706f 6c79 676f 6e73  ing the polygons
-0000dbe0: 2074 6f20 696e 7665 7274 2e0a 2020 2020   to invert..    
-0000dbf0: 626f 7264 6572 203a 2061 7272 6179 2d6c  border : array-l
-0000dc00: 696b 655b 325d 0a20 2020 2020 2020 2028  ike[2].        (
-0000dc10: 6478 2c64 7929 2073 697a 6520 6f66 2074  dx,dy) size of t
-0000dc20: 6865 2062 6f72 6465 7220 6172 6f75 6e64  he border around
-0000dc30: 2074 6865 2069 6e76 6572 7465 6420 7368   the inverted sh
-0000dc40: 6170 6520 2862 6f72 6465 7220 7661 6c75  ape (border valu
-0000dc50: 6520 6973 2074 6865 0a20 2020 2020 2020  e is the.       
-0000dc60: 2064 6973 7461 6e63 6520 6672 6f6d 2074   distance from t
-0000dc70: 6865 2065 6467 6573 206f 6620 7468 6520  he edges of the 
-0000dc80: 626f 756e 6469 6e67 2062 6f78 2064 6566  bounding box def
-0000dc90: 696e 696e 6729 0a20 2020 2070 7265 6369  ining).    preci
-0000dca0: 7369 6f6e 203a 2066 6c6f 6174 0a20 2020  sion : float.   
-0000dcb0: 2020 2020 2044 6573 6972 6564 2070 7265       Desired pre
-0000dcc0: 6369 7369 6f6e 2066 6f72 2072 6f75 6e64  cision for round
-0000dcd0: 696e 6720 7665 7274 6578 2063 6f6f 7264  ing vertex coord
-0000dce0: 696e 6174 6573 2e0a 2020 2020 7469 6c65  inates..    tile
-0000dcf0: 5f73 697a 6520 3a20 6172 7261 792d 6c69  _size : array-li
-0000dd00: 6b65 5b32 5d0a 2020 2020 2020 2020 5468  ke[2].        Th
-0000dd10: 6520 7469 6c65 2073 697a 6520 7769 7468  e tile size with
-0000dd20: 2077 6869 6368 2074 6865 2067 656f 6d65   which the geome
-0000dd30: 7472 7920 6973 2064 6976 6964 6564 2e20  try is divided. 
-0000dd40: 5468 6973 2061 6c6c 6f77 7320 666f 7220  This allows for 
-0000dd50: 6561 6368 0a20 2020 2020 2020 2072 6567  each.        reg
-0000dd60: 696f 6e20 746f 2062 6570 726f 6365 7373  ion to beprocess
-0000dd70: 6564 2073 6571 7565 6e74 6961 6c6c 792c  ed sequentially,
-0000dd80: 2077 6869 6368 2069 7320 6d6f 7265 2063   which is more c
-0000dd90: 6f6d 7075 7461 7469 6f6e 616c 6c79 0a20  omputationally. 
-0000dda0: 2020 2020 2020 2065 6666 6963 6965 6e74         efficient
-0000ddb0: 2028 616e 6420 6361 6e20 6265 2072 756e   (and can be run
-0000ddc0: 2069 6e20 7061 7261 6c6c 656c 206f 6e20   in parallel on 
-0000ddd0: 6d75 6c74 6970 6c65 2043 5055 2063 6f72  multiple CPU cor
-0000dde0: 6573 292e 0a20 2020 206d 6572 6765 5f61  es)..    merge_a
-0000ddf0: 6674 6572 3a20 626f 6f6c 0a20 2020 2020  fter: bool.     
-0000de00: 2020 204d 6572 6765 2061 6c6c 2074 6865     Merge all the
-0000de10: 2070 6f6c 7967 6f6e 7320 6166 7465 7220   polygons after 
-0000de20: 7065 7266 6f72 6d69 6e67 2074 6865 206f  performing the o
-0000de30: 7574 6c69 6e65 206f 7065 7261 7469 6f6e  utline operation
-0000de40: 0a20 2020 206c 6179 6572 203a 2069 6e74  .    layer : int
-0000de50: 2c20 6172 7261 792d 6c69 6b65 5b32 5d2c  , array-like[2],
-0000de60: 206f 7220 7365 740a 2020 2020 2020 2020   or set.        
-0000de70: 5370 6563 6966 6963 206c 6179 6572 2873  Specific layer(s
-0000de80: 2920 746f 2070 7574 2070 6f6c 7967 6f6e  ) to put polygon
-0000de90: 2067 656f 6d65 7472 7920 6f6e 2e0a 0a20   geometry on... 
-0000dea0: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
-0000deb0: 2d2d 2d2d 2d2d 0a20 2020 2044 203a 2044  ------.    D : D
-0000dec0: 6576 6963 650a 2020 2020 2020 2020 4120  evice.        A 
-0000ded0: 4465 7669 6365 2063 6f6e 7461 696e 696e  Device containin
-0000dee0: 6720 7468 6520 696e 7665 7274 6564 2076  g the inverted v
-0000def0: 6572 7369 6f6e 206f 6620 7468 6520 696e  ersion of the in
-0000df00: 7075 7420 7368 6170 6528 7329 2061 6e64  put shape(s) and
-0000df10: 2074 6865 0a20 2020 2020 2020 2063 6f72   the.        cor
-0000df20: 7265 7370 6f6e 6469 6e67 2062 6f72 6465  responding borde
-0000df30: 7228 7329 2e0a 2020 2020 2222 220a 2020  r(s)..    """.  
-0000df40: 2020 6966 206e 702e 7369 7a65 2862 6f72    if np.size(bor
-0000df50: 6465 7229 203d 3d20 313a 0a20 2020 2020  der) == 1:.     
-0000df60: 2020 2064 7820 3d20 6479 203d 2072 6f75     dx = dy = rou
-0000df70: 6e64 2862 6f72 6465 7220 2f20 7072 6563  nd(border / prec
-0000df80: 6973 696f 6e29 0a20 2020 2065 6c69 6620  ision).    elif 
-0000df90: 6e70 2e73 697a 6528 626f 7264 6572 2920  np.size(border) 
-0000dfa0: 3d3d 2032 3a0a 2020 2020 2020 2020 6478  == 2:.        dx
-0000dfb0: 203d 2072 6f75 6e64 2862 6f72 6465 725b   = round(border[
-0000dfc0: 305d 202f 2070 7265 6369 7369 6f6e 290a  0] / precision).
-0000dfd0: 2020 2020 2020 2020 6479 203d 2072 6f75          dy = rou
-0000dfe0: 6e64 2862 6f72 6465 725b 315d 202f 2070  nd(border[1] / p
-0000dff0: 7265 6369 7369 6f6e 290a 0a20 2020 2044  recision)..    D
-0000e000: 203d 205f 6b6c 5f65 7870 7265 7373 696f   = _kl_expressio
-0000e010: 6e28 0a20 2020 2020 2020 2065 6c65 6d65  n(.        eleme
-0000e020: 6e74 5f64 6963 743d 6469 6374 2841 3d65  nt_dict=dict(A=e
-0000e030: 6c65 6d65 6e74 7329 2c0a 2020 2020 2020  lements),.      
-0000e040: 2020 6578 7072 6573 7369 6f6e 3d66 2241    expression=f"A
-0000e050: 2e65 7874 656e 7473 2829 2e73 697a 6564  .extents().sized
-0000e060: 287b 6478 7d2c 7b64 797d 2c32 2920 2d20  ({dx},{dy},2) - 
-0000e070: 4122 2c0a 2020 2020 2020 2020 7072 6563  A",.        prec
-0000e080: 6973 696f 6e3d 7072 6563 6973 696f 6e2c  ision=precision,
-0000e090: 0a20 2020 2020 2020 2074 696c 655f 7369  .        tile_si
-0000e0a0: 7a65 3d74 696c 655f 7369 7a65 2c0a 2020  ze=tile_size,.  
-0000e0b0: 2020 2020 2020 6d65 7267 655f 6669 7273        merge_firs
-0000e0c0: 743d 5472 7565 2c0a 2020 2020 2020 2020  t=True,.        
-0000e0d0: 6d65 7267 655f 6166 7465 723d 6d65 7267  merge_after=merg
-0000e0e0: 655f 6166 7465 722c 0a20 2020 2020 2020  e_after,.       
-0000e0f0: 206f 7574 7075 745f 6e61 6d65 3d22 696e   output_name="in
-0000e100: 7665 7274 222c 0a20 2020 2020 2020 206e  vert",.        n
-0000e110: 756d 5f63 7075 3d4e 554d 5f43 5055 2c0a  um_cpu=NUM_CPU,.
-0000e120: 2020 2020 2020 2020 6c61 7965 723d 6c61          layer=la
-0000e130: 7965 722c 0a20 2020 2029 0a20 2020 2072  yer,.    ).    r
-0000e140: 6574 7572 6e20 440a 0a0a 2320 3d3d 3d3d  eturn D...# ====
-0000e150: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000e160: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000e170: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000e180: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000e190: 3d3d 3d3d 3d3d 3d3d 3d3d 0a23 0a23 204c  ==========.#.# L
-0000e1a0: 6974 686f 6772 6170 6879 2074 6573 7420  ithography test 
-0000e1b0: 7374 7275 6374 7572 6573 0a23 0a23 203d  structures.#.# =
-0000e1c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000e1d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000e1e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000e1f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000e200: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a0a  =============...
-0000e210: 6465 6620 6c69 7468 6f5f 7374 6570 7328  def litho_steps(
-0000e220: 6c69 6e65 5f77 6964 7468 733d 5b31 2c20  line_widths=[1, 
-0000e230: 322c 2034 2c20 382c 2031 365d 2c20 6c69  2, 4, 8, 16], li
-0000e240: 6e65 5f73 7061 6369 6e67 3d31 302c 2068  ne_spacing=10, h
-0000e250: 6569 6768 743d 3130 302c 206c 6179 6572  eight=100, layer
-0000e260: 3d30 293a 0a20 2020 2022 2222 5072 6f64  =0):.    """Prod
-0000e270: 7563 6573 2061 2070 6f73 6974 6976 6520  uces a positive 
-0000e280: 2b20 6e65 6761 7469 7665 2074 6f6e 6520  + negative tone 
-0000e290: 6c69 6e65 7769 6474 6820 7465 7374 2c20  linewidth test, 
-0000e2a0: 7573 6564 2066 6f72 0a20 2020 206c 6974  used for.    lit
-0000e2b0: 686f 6772 6170 6879 2072 6573 6f6c 7574  hography resolut
-0000e2c0: 696f 6e20 7465 7374 2070 6174 7465 726e  ion test pattern
-0000e2d0: 696e 672e 0a0a 2020 2020 5061 7261 6d65  ing...    Parame
-0000e2e0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-0000e2f0: 2d2d 2d0a 2020 2020 6c69 6e65 5f77 6964  ---.    line_wid
-0000e300: 7468 7320 3a20 6172 7261 792d 6c69 6b65  ths : array-like
-0000e310: 5b4e 5d20 6f66 2069 6e74 206f 7220 666c  [N] of int or fl
-0000e320: 6f61 740a 2020 2020 2020 2020 5769 6474  oat.        Widt
-0000e330: 6873 206f 6620 7468 6520 7374 6570 7320  hs of the steps 
-0000e340: 2870 6f73 6974 6976 6520 7369 6465 292e  (positive side).
-0000e350: 0a20 2020 206c 696e 655f 7370 6163 696e  .    line_spacin
-0000e360: 6720 3a20 696e 7420 6f72 2066 6c6f 6174  g : int or float
-0000e370: 0a20 2020 2020 2020 2053 7061 6365 2062  .        Space b
-0000e380: 6574 7765 656e 2065 6163 6820 7374 6570  etween each step
-0000e390: 2028 6e65 6761 7469 7665 2073 6964 6529   (negative side)
-0000e3a0: 2e0a 2020 2020 6865 6967 6874 203a 2069  ..    height : i
-0000e3b0: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
-0000e3c0: 2020 2020 4865 6967 6874 206f 6620 7468      Height of th
-0000e3d0: 6520 7374 6570 732e 0a20 2020 206c 6179  e steps..    lay
-0000e3e0: 6572 203a 2069 6e74 2c20 6172 7261 792d  er : int, array-
-0000e3f0: 6c69 6b65 5b32 5d2c 206f 7220 7365 740a  like[2], or set.
-0000e400: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
-0000e410: 206c 6179 6572 2873 2920 746f 2070 7574   layer(s) to put
-0000e420: 2070 6f6c 7967 6f6e 2067 656f 6d65 7472   polygon geometr
-0000e430: 7920 6f6e 2e0a 0a20 2020 2052 6574 7572  y on...    Retur
-0000e440: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-0000e450: 2020 2044 203a 2044 6576 6963 650a 2020     D : Device.  
-0000e460: 2020 2020 2020 4120 4465 7669 6365 2063        A Device c
-0000e470: 6f6e 7461 696e 696e 6720 7468 6520 6c69  ontaining the li
-0000e480: 7468 6f67 7261 7068 6963 206c 696e 6577  thographic linew
-0000e490: 6964 7468 2072 6573 6f6c 7574 696f 6e20  idth resolution 
-0000e4a0: 7465 7374 0a20 2020 2020 2020 2067 656f  test.        geo
-0000e4b0: 6d65 7472 792e 0a20 2020 2022 2222 0a20  metry..    """. 
-0000e4c0: 2020 2044 203d 2044 6576 6963 6528 226c     D = Device("l
-0000e4d0: 6974 686f 5f73 7465 7073 2229 0a0a 2020  itho_steps")..  
-0000e4e0: 2020 6865 6967 6874 203d 2068 6569 6768    height = heigh
-0000e4f0: 7420 2f20 320a 2020 2020 5431 203d 2074  t / 2.    T1 = t
-0000e500: 6578 7428 0a20 2020 2020 2020 2074 6578  ext(.        tex
-0000e510: 743d 2225 7322 2025 2073 7472 286c 696e  t="%s" % str(lin
-0000e520: 655f 7769 6474 6873 5b2d 315d 292c 2073  e_widths[-1]), s
-0000e530: 697a 653d 6865 6967 6874 2c20 6a75 7374  ize=height, just
-0000e540: 6966 793d 2263 656e 7465 7222 2c20 6c61  ify="center", la
-0000e550: 7965 723d 6c61 7965 720a 2020 2020 290a  yer=layer.    ).
-0000e560: 2020 2020 5f20 3d20 442e 6164 645f 7265      _ = D.add_re
-0000e570: 6628 5431 292e 726f 7461 7465 2839 3029  f(T1).rotate(90)
-0000e580: 2e6d 6f76 6578 282d 6865 6967 6874 202f  .movex(-height /
-0000e590: 2031 3029 0a20 2020 2052 3120 3d20 7265   10).    R1 = re
-0000e5a0: 6374 616e 676c 6528 7369 7a65 3d28 6c69  ctangle(size=(li
-0000e5b0: 6e65 5f73 7061 6369 6e67 2c20 6865 6967  ne_spacing, heig
-0000e5c0: 6874 292c 206c 6179 6572 3d6c 6179 6572  ht), layer=layer
-0000e5d0: 290a 2020 2020 442e 6164 645f 7265 6628  ).    D.add_ref(
-0000e5e0: 5231 292e 6d6f 7665 7928 2d68 6569 6768  R1).movey(-heigh
-0000e5f0: 7429 0a20 2020 2063 6f75 6e74 203d 2030  t).    count = 0
-0000e600: 0a20 2020 2066 6f72 2069 2069 6e20 7265  .    for i in re
-0000e610: 7665 7273 6564 286c 696e 655f 7769 6474  versed(line_widt
-0000e620: 6873 293a 0a20 2020 2020 2020 2063 6f75  hs):.        cou
-0000e630: 6e74 202b 3d20 6c69 6e65 5f73 7061 6369  nt += line_spaci
-0000e640: 6e67 202b 2069 0a20 2020 2020 2020 2052  ng + i.        R
-0000e650: 3220 3d20 7265 6374 616e 676c 6528 7369  2 = rectangle(si
-0000e660: 7a65 3d28 692c 2068 6569 6768 7429 2c20  ze=(i, height), 
-0000e670: 6c61 7965 723d 6c61 7965 7229 0a20 2020  layer=layer).   
-0000e680: 2020 2020 2044 2e61 6464 5f72 6566 2852       D.add_ref(R
-0000e690: 3129 2e6d 6f76 6578 2863 6f75 6e74 292e  1).movex(count).
-0000e6a0: 6d6f 7665 7928 2d68 6569 6768 7429 0a20  movey(-height). 
-0000e6b0: 2020 2020 2020 2044 2e61 6464 5f72 6566         D.add_ref
-0000e6c0: 2852 3229 2e6d 6f76 6578 2863 6f75 6e74  (R2).movex(count
-0000e6d0: 202d 2069 290a 0a20 2020 2072 6574 7572   - i)..    retur
-0000e6e0: 6e20 440a 0a0a 6465 6620 6c69 7468 6f5f  n D...def litho_
-0000e6f0: 7374 6172 286e 756d 5f6c 696e 6573 3d32  star(num_lines=2
-0000e700: 302c 206c 696e 655f 7769 6474 683d 322c  0, line_width=2,
-0000e710: 2064 6961 6d65 7465 723d 3230 302c 206c   diameter=200, l
-0000e720: 6179 6572 3d30 293a 0a20 2020 2022 2222  ayer=0):.    """
-0000e730: 4372 6561 7465 7320 6120 6369 7263 756c  Creates a circul
-0000e740: 6172 2d73 7461 7220 7368 6170 6520 6672  ar-star shape fr
-0000e750: 6f6d 206c 696e 6573 2c20 7573 6564 2061  om lines, used a
-0000e760: 7320 6120 6c69 7468 6f67 7261 7068 6963  s a lithographic
-0000e770: 0a20 2020 2072 6573 6f6c 7574 696f 6e20  .    resolution 
-0000e780: 7465 7374 2070 6174 7465 726e 2e0a 0a20  test pattern... 
-0000e790: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-0000e7a0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-0000e7b0: 206e 756d 5f6c 696e 6573 203a 2069 6e74   num_lines : int
-0000e7c0: 0a20 2020 2020 2020 204e 756d 6265 7220  .        Number 
-0000e7d0: 6f66 206c 696e 6573 2069 6e20 7468 6520  of lines in the 
-0000e7e0: 6369 7263 756c 6172 2d73 7461 7220 7368  circular-star sh
-0000e7f0: 6170 652e 0a20 2020 206c 696e 655f 7769  ape..    line_wi
-0000e800: 6474 6820 3a20 696e 7420 6f72 2066 6c6f  dth : int or flo
-0000e810: 6174 0a20 2020 2020 2020 2054 6869 636b  at.        Thick
-0000e820: 6e65 7373 206f 6620 7374 6172 2073 7069  ness of star spi
-0000e830: 6b65 206c 696e 6573 2e0a 2020 2020 6469  ke lines..    di
-0000e840: 616d 6574 6572 203a 2069 6e74 206f 7220  ameter : int or 
-0000e850: 666c 6f61 740a 2020 2020 2020 2020 4469  float.        Di
-0000e860: 616d 6574 6572 206f 6620 7468 6520 6369  ameter of the ci
-0000e870: 7263 756c 6172 2d73 7461 7220 7368 6170  rcular-star shap
-0000e880: 6520 2874 6f74 616c 206c 656e 6774 6820  e (total length 
-0000e890: 6f66 2065 6163 6820 7374 6172 2073 7069  of each star spi
-0000e8a0: 6b65 292e 0a20 2020 206c 6179 6572 203a  ke)..    layer :
-0000e8b0: 2069 6e74 2c20 6172 7261 792d 6c69 6b65   int, array-like
-0000e8c0: 5b32 5d2c 206f 7220 7365 740a 2020 2020  [2], or set.    
-0000e8d0: 2020 2020 5370 6563 6966 6963 206c 6179      Specific lay
-0000e8e0: 6572 2873 2920 746f 2070 7574 2070 6f6c  er(s) to put pol
-0000e8f0: 7967 6f6e 2067 656f 6d65 7472 7920 6f6e  ygon geometry on
-0000e900: 2e0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
-0000e910: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2044     -------.    D
-0000e920: 203a 2044 6576 6963 650a 2020 2020 2020   : Device.      
-0000e930: 2020 4120 4465 7669 6365 2063 6f6e 7461    A Device conta
-0000e940: 696e 696e 6720 6120 6c69 6e65 2d62 6173  ining a line-bas
-0000e950: 6564 2063 6972 6375 6c61 722d 7374 6172  ed circular-star
-0000e960: 2073 6861 7065 2e0a 2020 2020 2222 220a   shape..    """.
-0000e970: 2020 2020 4420 3d20 4465 7669 6365 2822      D = Device("
-0000e980: 6c69 7468 6f5f 7374 6172 2229 0a0a 2020  litho_star")..  
-0000e990: 2020 6465 6772 6565 203d 2031 3830 202f    degree = 180 /
-0000e9a0: 206e 756d 5f6c 696e 6573 0a20 2020 2052   num_lines.    R
-0000e9b0: 3120 3d20 7265 6374 616e 676c 6528 7369  1 = rectangle(si
-0000e9c0: 7a65 3d28 6c69 6e65 5f77 6964 7468 2c20  ze=(line_width, 
-0000e9d0: 6469 616d 6574 6572 292c 206c 6179 6572  diameter), layer
-0000e9e0: 3d6c 6179 6572 290a 2020 2020 666f 7220  =layer).    for 
-0000e9f0: 6920 696e 2072 616e 6765 286e 756d 5f6c  i in range(num_l
-0000ea00: 696e 6573 293a 0a20 2020 2020 2020 2072  ines):.        r
-0000ea10: 3120 3d20 442e 6164 645f 7265 6628 5231  1 = D.add_ref(R1
-0000ea20: 292e 726f 7461 7465 2864 6567 7265 6520  ).rotate(degree 
-0000ea30: 2a20 6929 0a20 2020 2020 2020 2072 312e  * i).        r1.
-0000ea40: 6365 6e74 6572 203d 2028 302c 2030 290a  center = (0, 0).
-0000ea50: 0a20 2020 2072 6574 7572 6e20 440a 0a0a  .    return D...
-0000ea60: 6465 6620 6c69 7468 6f5f 6361 6c69 7065  def litho_calipe
-0000ea70: 7273 280a 2020 2020 6e6f 7463 685f 7369  rs(.    notch_si
-0000ea80: 7a65 3d5b 322c 2035 5d2c 0a20 2020 206e  ze=[2, 5],.    n
-0000ea90: 6f74 6368 5f73 7061 6369 6e67 3d32 2c0a  otch_spacing=2,.
-0000eaa0: 2020 2020 6e75 6d5f 6e6f 7463 6865 733d      num_notches=
-0000eab0: 3131 2c0a 2020 2020 6f66 6673 6574 5f70  11,.    offset_p
-0000eac0: 6572 5f6e 6f74 6368 3d30 2e31 2c0a 2020  er_notch=0.1,.  
-0000ead0: 2020 726f 775f 7370 6163 696e 673d 302c    row_spacing=0,
-0000eae0: 0a20 2020 206c 6179 6572 313d 312c 0a20  .    layer1=1,. 
-0000eaf0: 2020 206c 6179 6572 323d 322c 0a29 3a0a     layer2=2,.):.
-0000eb00: 2020 2020 2222 2243 7265 6174 6573 2061      """Creates a
-0000eb10: 2076 6572 6e69 6572 2063 616c 6970 6572   vernier caliper
-0000eb20: 2073 7472 7563 7475 7265 2066 6f72 206c   structure for l
-0000eb30: 6974 686f 6772 6170 6879 2061 6c69 676e  ithography align
-0000eb40: 6d65 6e74 0a20 2020 2074 6573 7473 2e20  ment.    tests. 
-0000eb50: 5665 726e 6965 7220 7374 7275 6374 7572  Vernier structur
-0000eb60: 6520 6973 206d 6164 6520 686f 7269 7a6f  e is made horizo
-0000eb70: 6e74 616c 6c79 2e0a 0a20 2020 2050 6172  ntally...    Par
-0000eb80: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-0000eb90: 2d2d 2d2d 2d2d 0a20 2020 206e 6f74 6368  ------.    notch
-0000eba0: 5f73 697a 6520 3a20 6172 7261 792d 6c69  _size : array-li
-0000ebb0: 6b65 5b32 5d20 6f66 2069 6e74 206f 7220  ke[2] of int or 
-0000ebc0: 666c 616f 740a 2020 2020 2020 2020 782c  flaot.        x,
-0000ebd0: 2079 2073 697a 6520 6f66 2074 6865 206e   y size of the n
-0000ebe0: 6f74 6368 6573 2e0a 2020 2020 6e6f 7463  otches..    notc
-0000ebf0: 685f 7370 6163 696e 6720 3a20 696e 7420  h_spacing : int 
-0000ec00: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
-0000ec10: 2053 7061 6369 6e67 2062 6574 7765 656e   Spacing between
-0000ec20: 206e 6f74 6368 6573 206f 6e20 7468 6520   notches on the 
-0000ec30: 636f 6e74 726f 6c20 7374 7275 6374 7572  control structur
-0000ec40: 652e 0a20 2020 206e 756d 5f6e 6f74 6368  e..    num_notch
-0000ec50: 6573 203a 2069 6e74 0a20 2020 2020 2020  es : int.       
-0000ec60: 204e 756d 6265 7220 6f66 206e 6f74 6368   Number of notch
-0000ec70: 6573 206f 6e20 6f6e 6520 7369 6465 206f  es on one side o
-0000ec80: 6620 7468 6520 7374 7275 6374 7572 6520  f the structure 
-0000ec90: 2874 6f74 616c 206e 756d 6265 7220 6f66  (total number of
-0000eca0: 0a20 2020 2020 2020 206e 6f74 6368 6573  .        notches
-0000ecb0: 2069 7320 322a 6e75 6d5f 6e6f 7463 6865   is 2*num_notche
-0000ecc0: 7320 2b20 3129 2e0a 2020 2020 6f66 6673  s + 1)..    offs
-0000ecd0: 6574 5f70 6572 5f6e 6f74 6368 203a 2069  et_per_notch : i
-0000ece0: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
-0000ecf0: 2020 2020 5468 6520 616d 6f75 6e74 206f      The amount o
-0000ed00: 6620 686f 7269 7a6f 6e74 616c 206f 6666  f horizontal off
-0000ed10: 7365 7420 746f 2061 7070 6c79 2074 6f20  set to apply to 
-0000ed20: 7468 6520 6e6f 7463 6820 7370 6163 696e  the notch spacin
-0000ed30: 6720 7065 720a 2020 2020 2020 2020 6e6f  g per.        no
-0000ed40: 7463 6820 6f6e 2074 6865 206e 6f6e 2d63  tch on the non-c
-0000ed50: 6f6e 7472 6f6c 2073 7472 7563 7475 7265  ontrol structure
-0000ed60: 2e0a 2020 2020 726f 775f 7370 6163 696e  ..    row_spacin
-0000ed70: 6720 3a20 696e 7420 6f72 2066 6c6f 6174  g : int or float
-0000ed80: 0a20 2020 2020 2020 2054 6865 2061 6d6f  .        The amo
-0000ed90: 756e 7420 6f66 2076 6572 7469 6361 6c20  unt of vertical 
-0000eda0: 7370 6163 6520 6265 7477 6565 6e20 7468  space between th
-0000edb0: 6520 636f 6e74 726f 6c20 616e 6420 6e6f  e control and no
-0000edc0: 6e2d 636f 6e74 726f 6c0a 2020 2020 2020  n-control.      
-0000edd0: 2020 7374 7275 6374 7572 6573 2e0a 2020    structures..  
-0000ede0: 2020 6c61 7965 7231 203a 2069 6e74 2c20    layer1 : int, 
-0000edf0: 6172 7261 792d 6c69 6b65 5b32 5d2c 206f  array-like[2], o
-0000ee00: 7220 7365 740a 2020 2020 2020 2020 5370  r set.        Sp
-0000ee10: 6563 6966 6963 206c 6179 6572 2873 2920  ecific layer(s) 
-0000ee20: 746f 2070 7574 2074 6865 2063 6f6e 7472  to put the contr
-0000ee30: 6f6c 2067 656f 6d65 7472 7920 6f6e 2e0a  ol geometry on..
-0000ee40: 2020 2020 6c61 7965 7232 203a 2069 6e74      layer2 : int
-0000ee50: 2c20 6172 7261 792d 6c69 6b65 5b32 5d2c  , array-like[2],
-0000ee60: 206f 7220 7365 740a 2020 2020 2020 2020   or set.        
-0000ee70: 5370 6563 6966 6963 206c 6179 6572 2873  Specific layer(s
-0000ee80: 2920 746f 2070 7574 2074 6865 206e 6f6e  ) to put the non
-0000ee90: 2d63 6f6e 7472 6f6c 2067 656f 6d65 7472  -control geometr
-0000eea0: 7920 6f6e 2e0a 0a20 2020 2052 6574 7572  y on...    Retur
-0000eeb0: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-0000eec0: 2020 2044 6576 6963 650a 2020 2020 2020     Device.      
-0000eed0: 2020 4120 4465 7669 6365 2063 6f6e 7461    A Device conta
-0000eee0: 696e 696e 6720 7468 6520 6361 6c69 7065  ining the calipe
-0000eef0: 7220 7374 7275 6374 7572 6573 2e0a 2020  r structures..  
-0000ef00: 2020 2222 220a 2020 2020 4420 3d20 4465    """.    D = De
-0000ef10: 7669 6365 2822 6c69 7468 6f5f 6361 6c69  vice("litho_cali
-0000ef20: 7065 7273 2229 0a20 2020 206e 756d 5f6e  pers").    num_n
-0000ef30: 6f74 6368 6573 5f74 6f74 616c 203d 206e  otches_total = n
-0000ef40: 756d 5f6e 6f74 6368 6573 202a 2032 202b  um_notches * 2 +
-0000ef50: 2031 0a20 2020 2063 656e 7472 655f 6e6f   1.    centre_no
-0000ef60: 7463 6820 3d20 6e75 6d5f 6e6f 7463 6865  tch = num_notche
-0000ef70: 730a 2020 2020 5231 203d 2072 6563 7461  s.    R1 = recta
-0000ef80: 6e67 6c65 2873 697a 653d 286e 6f74 6368  ngle(size=(notch
-0000ef90: 5f73 697a 6529 2c20 6c61 7965 723d 6c61  _size), layer=la
-0000efa0: 7965 7231 290a 2020 2020 5232 203d 2072  yer1).    R2 = r
-0000efb0: 6563 7461 6e67 6c65 2873 697a 653d 286e  ectangle(size=(n
-0000efc0: 6f74 6368 5f73 697a 6529 2c20 6c61 7965  otch_size), laye
-0000efd0: 723d 6c61 7965 7232 290a 2020 2020 666f  r=layer2).    fo
-0000efe0: 7220 6920 696e 2072 616e 6765 286e 756d  r i in range(num
-0000eff0: 5f6e 6f74 6368 6573 5f74 6f74 616c 293a  _notches_total):
-0000f000: 0a20 2020 2020 2020 2069 6620 6920 3d3d  .        if i ==
-0000f010: 2063 656e 7472 655f 6e6f 7463 683a 0a20   centre_notch:. 
-0000f020: 2020 2020 2020 2020 2020 2028 0a20 2020             (.   
-0000f030: 2020 2020 2020 2020 2020 2020 2044 2e61               D.a
-0000f040: 6464 5f72 6566 2852 3129 0a20 2020 2020  dd_ref(R1).     
-0000f050: 2020 2020 2020 2020 2020 202e 6d6f 7665             .move
-0000f060: 7828 6920 2a20 286e 6f74 6368 5f73 697a  x(i * (notch_siz
-0000f070: 655b 305d 202b 206e 6f74 6368 5f73 7061  e[0] + notch_spa
-0000f080: 6369 6e67 2929 0a20 2020 2020 2020 2020  cing)).         
-0000f090: 2020 2020 2020 202e 6d6f 7665 7928 6e6f         .movey(no
-0000f0a0: 7463 685f 7369 7a65 5b31 5d29 0a20 2020  tch_size[1]).   
-0000f0b0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0000f0c0: 2020 2020 2020 2028 0a20 2020 2020 2020         (.       
-0000f0d0: 2020 2020 2020 2020 2044 2e61 6464 5f72           D.add_r
-0000f0e0: 6566 2852 3229 0a20 2020 2020 2020 2020  ef(R2).         
-0000f0f0: 2020 2020 2020 202e 6d6f 7665 7828 0a20         .movex(. 
-0000f100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f110: 2020 2069 202a 2028 6e6f 7463 685f 7369     i * (notch_si
-0000f120: 7a65 5b30 5d20 2b20 6e6f 7463 685f 7370  ze[0] + notch_sp
-0000f130: 6163 696e 6729 0a20 2020 2020 2020 2020  acing).         
-0000f140: 2020 2020 2020 2020 2020 202b 206f 6666             + off
-0000f150: 7365 745f 7065 725f 6e6f 7463 6820 2a20  set_per_notch * 
-0000f160: 2863 656e 7472 655f 6e6f 7463 6820 2d20  (centre_notch - 
-0000f170: 6929 0a20 2020 2020 2020 2020 2020 2020  i).             
-0000f180: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0000f190: 2020 2020 202e 6d6f 7665 7928 2d32 202a       .movey(-2 *
-0000f1a0: 206e 6f74 6368 5f73 697a 655b 315d 202d   notch_size[1] -
-0000f1b0: 2072 6f77 5f73 7061 6369 6e67 290a 2020   row_spacing).  
-0000f1c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000f1d0: 2020 2020 442e 6164 645f 7265 6628 5231      D.add_ref(R1
-0000f1e0: 292e 6d6f 7665 7828 6920 2a20 286e 6f74  ).movex(i * (not
-0000f1f0: 6368 5f73 697a 655b 305d 202b 206e 6f74  ch_size[0] + not
-0000f200: 6368 5f73 7061 6369 6e67 2929 0a20 2020  ch_spacing)).   
-0000f210: 2020 2020 2028 0a20 2020 2020 2020 2020       (.         
-0000f220: 2020 2044 2e61 6464 5f72 6566 2852 3229     D.add_ref(R2)
-0000f230: 0a20 2020 2020 2020 2020 2020 202e 6d6f  .            .mo
-0000f240: 7665 7828 0a20 2020 2020 2020 2020 2020  vex(.           
-0000f250: 2020 2020 2069 202a 2028 6e6f 7463 685f       i * (notch_
-0000f260: 7369 7a65 5b30 5d20 2b20 6e6f 7463 685f  size[0] + notch_
-0000f270: 7370 6163 696e 6729 0a20 2020 2020 2020  spacing).       
-0000f280: 2020 2020 2020 2020 202b 206f 6666 7365           + offse
-0000f290: 745f 7065 725f 6e6f 7463 6820 2a20 2863  t_per_notch * (c
-0000f2a0: 656e 7472 655f 6e6f 7463 6820 2d20 6929  entre_notch - i)
-0000f2b0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0000f2c0: 2020 2020 2020 2020 2020 202e 6d6f 7665             .move
-0000f2d0: 7928 2d6e 6f74 6368 5f73 697a 655b 315d  y(-notch_size[1]
-0000f2e0: 202d 2072 6f77 5f73 7061 6369 6e67 290a   - row_spacing).
-0000f2f0: 2020 2020 2020 2020 290a 0a20 2020 2072          )..    r
-0000f300: 6574 7572 6e20 440a 0a0a 6465 6620 6c69  eturn D...def li
-0000f310: 7468 6f5f 7275 6c65 7228 0a20 2020 2068  tho_ruler(.    h
-0000f320: 6569 6768 743d 322c 0a20 2020 2077 6964  eight=2,.    wid
-0000f330: 7468 3d30 2e35 2c0a 2020 2020 7370 6163  th=0.5,.    spac
-0000f340: 696e 673d 312e 322c 0a20 2020 2073 6361  ing=1.2,.    sca
-0000f350: 6c65 3d5b 332c 2031 2c20 312c 2031 2c20  le=[3, 1, 1, 1, 
-0000f360: 312c 2032 2c20 312c 2031 2c20 312c 2031  1, 2, 1, 1, 1, 1
-0000f370: 5d2c 0a20 2020 206e 756d 5f6d 6172 6b73  ],.    num_marks
-0000f380: 3d32 312c 0a20 2020 206c 6179 6572 3d30  =21,.    layer=0
-0000f390: 2c0a 293a 0a20 2020 2022 2222 4372 6561  ,.):.    """Crea
-0000f3a0: 7465 7320 6120 7275 6c65 7220 7374 7275  tes a ruler stru
-0000f3b0: 6374 7572 6520 666f 7220 6c69 7468 6f67  cture for lithog
-0000f3c0: 7261 7068 6963 206d 6561 7375 7265 6d65  raphic measureme
-0000f3d0: 6e74 2077 6974 6820 6d61 726b 7320 6f66  nt with marks of
-0000f3e0: 0a20 2020 2076 6172 7969 6e67 2073 6361  .    varying sca
-0000f3f0: 6c65 7320 746f 2061 6c6c 6f77 2066 6f72  les to allow for
-0000f400: 2065 6173 7920 7265 6164 696e 6720 6279   easy reading by
-0000f410: 2065 7965 2e0a 0a20 2020 2050 6172 616d   eye...    Param
-0000f420: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
-0000f430: 2d2d 2d2d 0a20 2020 2068 6569 6768 7420  ----.    height 
-0000f440: 3a20 666c 6f61 740a 2020 2020 2020 2020  : float.        
-0000f450: 4865 6967 6874 206f 6620 7468 6520 7275  Height of the ru
-0000f460: 6c69 6e67 206d 6172 6b73 2e0a 2020 2020  ling marks..    
-0000f470: 7769 6474 6820 3a20 666c 6f61 740a 2020  width : float.  
-0000f480: 2020 2020 2020 5769 6474 6820 6f66 2074        Width of t
-0000f490: 6865 2072 756c 696e 6720 6d61 726b 732e  he ruling marks.
-0000f4a0: 0a20 2020 2073 7061 6369 6e67 203a 2066  .    spacing : f
-0000f4b0: 6c6f 6174 0a20 2020 2020 2020 2043 656e  loat.        Cen
-0000f4c0: 7465 722d 746f 2d63 656e 7465 7220 7370  ter-to-center sp
-0000f4d0: 6163 696e 6720 6f66 2074 6865 2072 756c  acing of the rul
-0000f4e0: 696e 6720 6d61 726b 730a 2020 2020 7363  ing marks.    sc
-0000f4f0: 616c 6520 3a20 6172 7261 792d 6c69 6b65  ale : array-like
-0000f500: 0a20 2020 2020 2020 2048 6569 6768 7420  .        Height 
-0000f510: 7363 616c 6520 7061 7474 6572 6e20 6f66  scale pattern of
-0000f520: 206d 6172 6b73 0a20 2020 206e 756d 5f6d   marks.    num_m
-0000f530: 6172 6b73 203a 2069 6e74 0a20 2020 2020  arks : int.     
-0000f540: 2020 2054 6f74 616c 206e 756d 6265 7220     Total number 
-0000f550: 6f66 206d 6172 6b73 2074 6f20 6765 6e65  of marks to gene
-0000f560: 7261 7465 0a20 2020 206e 756d 5f6d 6172  rate.    num_mar
-0000f570: 6b73 203a 2069 6e74 0a20 2020 2020 2020  ks : int.       
-0000f580: 2054 6f74 616c 206e 756d 6265 7220 6f66   Total number of
-0000f590: 206d 6172 6b73 2074 6f20 6765 6e65 7261   marks to genera
-0000f5a0: 7465 0a20 2020 206c 6179 6572 203a 2069  te.    layer : i
-0000f5b0: 6e74 2c20 6172 7261 792d 6c69 6b65 5b32  nt, array-like[2
-0000f5c0: 5d2c 206f 7220 7365 740a 2020 2020 2020  ], or set.      
-0000f5d0: 2020 5370 6563 6966 6963 206c 6179 6572    Specific layer
-0000f5e0: 2873 2920 746f 2070 7574 2074 6865 2072  (s) to put the r
-0000f5f0: 756c 6572 2067 656f 6d65 7472 7920 6f6e  uler geometry on
-0000f600: 2e0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
-0000f610: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2044     -------.    D
-0000f620: 6576 6963 650a 2020 2020 2020 2020 4120  evice.        A 
-0000f630: 4465 7669 6365 2063 6f6e 7461 696e 696e  Device containin
-0000f640: 6720 7468 6520 7275 6c65 7220 7374 7275  g the ruler stru
-0000f650: 6374 7572 650a 2020 2020 2222 220a 0a20  cture.    """.. 
-0000f660: 2020 2044 203d 2044 6576 6963 6528 226c     D = Device("l
-0000f670: 6974 686f 5f72 756c 6572 2229 0a20 2020  itho_ruler").   
-0000f680: 2066 6f72 206e 2069 6e20 7261 6e67 6528   for n in range(
-0000f690: 6e75 6d5f 6d61 726b 7329 3a0a 2020 2020  num_marks):.    
-0000f6a0: 2020 2020 6820 3d20 6865 6967 6874 202a      h = height *
-0000f6b0: 2073 6361 6c65 5b6e 2025 206c 656e 2873   scale[n % len(s
-0000f6c0: 6361 6c65 295d 0a20 2020 2020 2020 2044  cale)].        D
-0000f6d0: 203c 3c20 7265 6374 616e 676c 6528 7369   << rectangle(si
-0000f6e0: 7a65 3d28 7769 6474 682c 2068 292c 206c  ze=(width, h), l
-0000f6f0: 6179 6572 3d6c 6179 6572 290a 0a20 2020  ayer=layer)..   
-0000f700: 2044 2e64 6973 7472 6962 7574 6528 6469   D.distribute(di
-0000f710: 7265 6374 696f 6e3d 2278 222c 2073 7061  rection="x", spa
-0000f720: 6369 6e67 3d73 7061 6369 6e67 2c20 7365  cing=spacing, se
-0000f730: 7061 7261 7469 6f6e 3d46 616c 7365 2c20  paration=False, 
-0000f740: 6564 6765 3d22 7822 290a 2020 2020 442e  edge="x").    D.
-0000f750: 616c 6967 6e28 616c 6967 6e6d 656e 743d  align(alignment=
-0000f760: 2279 6d69 6e22 290a 2020 2020 442e 666c  "ymin").    D.fl
-0000f770: 6174 7465 6e28 290a 2020 2020 7265 7475  atten().    retu
-0000f780: 726e 2044 0a0a 0a23 203d 3d3d 3d3d 3d3d  rn D...# =======
-0000f790: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000f7a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000f7b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000f7c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000f7d0: 3d3d 3d3d 3d3d 3d0a 230a 2320 5574 696c  =======.#.# Util
-0000f7e0: 6974 7920 6675 6e63 7469 6f6e 730a 230a  ity functions.#.
-0000f7f0: 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  # ==============
-0000f800: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000f810: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000f820: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000f830: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000f840: 0a0a 0a64 6566 2065 7874 7261 6374 2844  ...def extract(D
-0000f850: 2c20 6c61 7965 7273 3d5b 302c 2031 5d29  , layers=[0, 1])
-0000f860: 3a0a 2020 2020 2222 2245 7874 7261 6374  :.    """Extract
-0000f870: 7320 706f 6c79 676f 6e73 2066 726f 6d20  s polygons from 
-0000f880: 6120 6769 7665 6e20 4465 7669 6365 2e0a  a given Device..
-0000f890: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
-0000f8a0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-0000f8b0: 2020 2044 203a 2044 6576 6963 650a 2020     D : Device.  
-0000f8c0: 2020 2020 2020 4465 7669 6365 2074 6f20        Device to 
-0000f8d0: 6578 7472 6163 7420 706f 6c79 676f 6e73  extract polygons
-0000f8e0: 2066 726f 6d2e 0a20 2020 206c 6179 6572   from..    layer
-0000f8f0: 7320 3a20 6172 7261 792d 6c69 6b65 5b32  s : array-like[2
-0000f900: 5d20 6f72 2073 6574 0a20 2020 2020 2020  ] or set.       
-0000f910: 2053 7065 6369 6669 6320 6c61 7965 7228   Specific layer(
-0000f920: 7329 2074 6f20 6578 7472 6163 7420 706f  s) to extract po
-0000f930: 6c79 676f 6e20 6765 6f6d 6574 7279 2066  lygon geometry f
-0000f940: 726f 6d2e 0a0a 2020 2020 5265 7475 726e  rom...    Return
-0000f950: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-0000f960: 2020 4465 7669 6365 0a20 2020 2020 2020    Device.       
-0000f970: 2041 2044 6576 6963 6520 636f 6e74 6169   A Device contai
-0000f980: 6e69 6e67 2074 6865 2065 7874 7261 6374  ning the extract
-0000f990: 6564 2070 6f6c 7967 6f6e 732e 0a20 2020  ed polygons..   
-0000f9a0: 2022 2222 0a20 2020 2044 5f65 7874 7261   """.    D_extra
-0000f9b0: 6374 6564 203d 2044 6576 6963 6528 2265  cted = Device("e
-0000f9c0: 7874 7261 6374 2229 0a20 2020 2069 6620  xtract").    if 
-0000f9d0: 6e6f 7420 6973 696e 7374 616e 6365 286c  not isinstance(l
-0000f9e0: 6179 6572 732c 2028 6c69 7374 2c20 7475  ayers, (list, tu
-0000f9f0: 706c 6529 293a 0a20 2020 2020 2020 2072  ple)):.        r
-0000fa00: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0000fa10: 0a20 2020 2020 2020 2020 2020 2022 5b50  .            "[P
-0000fa20: 4849 444c 5d20 7067 2e65 7874 7261 6374  HIDL] pg.extract
-0000fa30: 2829 2041 7267 756d 656e 7420 606c 6179  () Argument `lay
-0000fa40: 6572 7360 206e 6565 6473 2074 6f20 6265  ers` needs to be
-0000fa50: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-0000fa60: 7061 7373 6564 2061 206c 6973 7420 6f72  passed a list or
-0000fa70: 2074 7570 6c65 220a 2020 2020 2020 2020   tuple".        
-0000fa80: 290a 2020 2020 706f 6c79 5f64 6963 7420  ).    poly_dict 
-0000fa90: 3d20 442e 6765 745f 706f 6c79 676f 6e73  = D.get_polygons
-0000faa0: 2862 795f 7370 6563 3d54 7275 6529 0a20  (by_spec=True). 
-0000fab0: 2020 2070 6172 7365 645f 6c61 7965 725f     parsed_layer_
-0000fac0: 6c69 7374 203d 205b 5f70 6172 7365 5f6c  list = [_parse_l
-0000fad0: 6179 6572 286c 6179 6572 2920 666f 7220  ayer(layer) for 
-0000fae0: 6c61 7965 7220 696e 206c 6179 6572 735d  layer in layers]
-0000faf0: 0a20 2020 2066 6f72 206c 6179 6572 2c20  .    for layer, 
-0000fb00: 706f 6c79 7320 696e 2070 6f6c 795f 6469  polys in poly_di
-0000fb10: 6374 2e69 7465 6d73 2829 3a0a 2020 2020  ct.items():.    
-0000fb20: 2020 2020 6966 205f 7061 7273 655f 6c61      if _parse_la
-0000fb30: 7965 7228 6c61 7965 7229 2069 6e20 7061  yer(layer) in pa
-0000fb40: 7273 6564 5f6c 6179 6572 5f6c 6973 743a  rsed_layer_list:
-0000fb50: 0a20 2020 2020 2020 2020 2020 2044 5f65  .            D_e
-0000fb60: 7874 7261 6374 6564 2e61 6464 5f70 6f6c  xtracted.add_pol
-0000fb70: 7967 6f6e 2870 6f6c 7973 2c20 6c61 7965  ygon(polys, laye
-0000fb80: 723d 6c61 7965 7229 0a20 2020 2072 6574  r=layer).    ret
-0000fb90: 7572 6e20 445f 6578 7472 6163 7465 640a  urn D_extracted.
-0000fba0: 0a0a 6465 6620 636f 7079 2844 293a 0a20  ..def copy(D):. 
-0000fbb0: 2020 2022 2222 436f 7069 6573 2061 2044     """Copies a D
-0000fbc0: 6576 6963 652e 0a0a 2020 2020 5061 7261  evice...    Para
-0000fbd0: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-0000fbe0: 2d2d 2d2d 2d0a 2020 2020 4420 3a20 4465  -----.    D : De
-0000fbf0: 7669 6365 0a20 2020 2020 2020 2044 6576  vice.        Dev
-0000fc00: 6963 6520 746f 2062 6520 636f 7069 6564  ice to be copied
-0000fc10: 2e0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
-0000fc20: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2044     -------.    D
-0000fc30: 6576 6963 650a 2020 2020 2020 2020 436f  evice.        Co
-0000fc40: 7069 6564 2044 6576 6963 652e 0a20 2020  pied Device..   
-0000fc50: 2022 2222 0a20 2020 2044 5f63 6f70 7920   """.    D_copy 
-0000fc60: 3d20 4465 7669 6365 286e 616d 653d 442e  = Device(name=D.
-0000fc70: 6e61 6d65 290a 2020 2020 445f 636f 7079  name).    D_copy
-0000fc80: 2e69 6e66 6f20 3d20 7079 7468 6f6e 5f63  .info = python_c
-0000fc90: 6f70 792e 6465 6570 636f 7079 2844 2e69  opy.deepcopy(D.i
-0000fca0: 6e66 6f29 0a20 2020 2066 6f72 2072 6566  nfo).    for ref
-0000fcb0: 2069 6e20 442e 7265 6665 7265 6e63 6573   in D.references
-0000fcc0: 3a0a 2020 2020 2020 2020 6e65 775f 7265  :.        new_re
-0000fcd0: 6620 3d20 4465 7669 6365 5265 6665 7265  f = DeviceRefere
-0000fce0: 6e63 6528 0a20 2020 2020 2020 2020 2020  nce(.           
-0000fcf0: 2064 6576 6963 653d 7265 662e 7061 7265   device=ref.pare
-0000fd00: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-0000fd10: 6f72 6967 696e 3d72 6566 2e6f 7269 6769  origin=ref.origi
-0000fd20: 6e2c 0a20 2020 2020 2020 2020 2020 2072  n,.            r
-0000fd30: 6f74 6174 696f 6e3d 7265 662e 726f 7461  otation=ref.rota
-0000fd40: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
-0000fd50: 2020 6d61 676e 6966 6963 6174 696f 6e3d    magnification=
-0000fd60: 7265 662e 6d61 676e 6966 6963 6174 696f  ref.magnificatio
-0000fd70: 6e2c 0a20 2020 2020 2020 2020 2020 2078  n,.            x
-0000fd80: 5f72 6566 6c65 6374 696f 6e3d 7265 662e  _reflection=ref.
-0000fd90: 785f 7265 666c 6563 7469 6f6e 2c0a 2020  x_reflection,.  
-0000fda0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000fdb0: 6e65 775f 7265 662e 6f77 6e65 7220 3d20  new_ref.owner = 
-0000fdc0: 445f 636f 7079 0a20 2020 2020 2020 2044  D_copy.        D
-0000fdd0: 5f63 6f70 792e 6164 6428 6e65 775f 7265  _copy.add(new_re
-0000fde0: 6629 0a20 2020 2020 2020 2066 6f72 2061  f).        for a
-0000fdf0: 6c69 6173 5f6e 616d 652c 2061 6c69 6173  lias_name, alias
-0000fe00: 5f72 6566 2069 6e20 442e 616c 6961 7365  _ref in D.aliase
-0000fe10: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
-0000fe20: 2020 2020 2020 2069 6620 616c 6961 735f         if alias_
-0000fe30: 7265 6620 3d3d 2072 6566 3a0a 2020 2020  ref == ref:.    
-0000fe40: 2020 2020 2020 2020 2020 2020 445f 636f              D_co
-0000fe50: 7079 2e61 6c69 6173 6573 5b61 6c69 6173  py.aliases[alias
-0000fe60: 5f6e 616d 655d 203d 206e 6577 5f72 6566  _name] = new_ref
-0000fe70: 0a0a 2020 2020 666f 7220 706f 7274 2069  ..    for port i
-0000fe80: 6e20 442e 706f 7274 732e 7661 6c75 6573  n D.ports.values
-0000fe90: 2829 3a0a 2020 2020 2020 2020 445f 636f  ():.        D_co
-0000fea0: 7079 2e61 6464 5f70 6f72 7428 706f 7274  py.add_port(port
-0000feb0: 3d70 6f72 7429 0a20 2020 2066 6f72 2070  =port).    for p
-0000fec0: 6f6c 7920 696e 2044 2e70 6f6c 7967 6f6e  oly in D.polygon
-0000fed0: 733a 0a20 2020 2020 2020 2044 5f63 6f70  s:.        D_cop
-0000fee0: 792e 6164 645f 706f 6c79 676f 6e28 706f  y.add_polygon(po
-0000fef0: 6c79 290a 2020 2020 666f 7220 6c61 6265  ly).    for labe
-0000ff00: 6c20 696e 2044 2e6c 6162 656c 733a 0a20  l in D.labels:. 
-0000ff10: 2020 2020 2020 2044 5f63 6f70 792e 6164         D_copy.ad
-0000ff20: 645f 6c61 6265 6c28 0a20 2020 2020 2020  d_label(.       
-0000ff30: 2020 2020 2074 6578 743d 6c61 6265 6c2e       text=label.
-0000ff40: 7465 7874 2c0a 2020 2020 2020 2020 2020  text,.          
-0000ff50: 2020 706f 7369 7469 6f6e 3d6c 6162 656c    position=label
-0000ff60: 2e70 6f73 6974 696f 6e2c 0a20 2020 2020  .position,.     
-0000ff70: 2020 2020 2020 206c 6179 6572 3d28 6c61         layer=(la
-0000ff80: 6265 6c2e 6c61 7965 722c 206c 6162 656c  bel.layer, label
-0000ff90: 2e74 6578 7474 7970 6529 2c0a 2020 2020  .texttype),.    
-0000ffa0: 2020 2020 290a 2020 2020 7265 7475 726e      ).    return
-0000ffb0: 2044 5f63 6f70 790a 0a0a 6465 6620 6465   D_copy...def de
-0000ffc0: 6570 636f 7079 2844 293a 0a20 2020 2022  epcopy(D):.    "
-0000ffd0: 2222 4465 6570 2063 6f70 6965 7320 6120  ""Deep copies a 
-0000ffe0: 4465 7669 6365 2e0a 0a20 2020 2050 6172  Device...    Par
-0000fff0: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-00010000: 2d2d 2d2d 2d2d 0a20 2020 2044 203a 2044  ------.    D : D
-00010010: 6576 6963 650a 2020 2020 2020 2020 4465  evice.        De
-00010020: 7669 6365 2074 6f20 6265 2064 6565 7020  vice to be deep 
-00010030: 636f 7069 6564 2e0a 0a20 2020 2052 6574  copied...    Ret
-00010040: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
-00010050: 0a20 2020 2044 6576 6963 650a 2020 2020  .    Device.    
-00010060: 2020 2020 4465 6570 2063 6f70 6965 6420      Deep copied 
-00010070: 4465 7669 6365 2e0a 2020 2020 2222 220a  Device..    """.
-00010080: 2020 2020 445f 636f 7079 203d 2070 7974      D_copy = pyt
-00010090: 686f 6e5f 636f 7079 2e64 6565 7063 6f70  hon_copy.deepcop
-000100a0: 7928 4429 0a20 2020 2044 5f63 6f70 792e  y(D).    D_copy.
-000100b0: 7569 6420 3d20 4465 7669 6365 2e5f 6e65  uid = Device._ne
-000100c0: 7874 5f75 6964 0a20 2020 2044 6576 6963  xt_uid.    Devic
-000100d0: 652e 5f6e 6578 745f 7569 6420 2b3d 2031  e._next_uid += 1
-000100e0: 0a20 2020 2044 5f63 6f70 792e 6e61 6d65  .    D_copy.name
-000100f0: 203d 2044 2e6e 616d 650a 2020 2020 2320   = D.name.    # 
-00010100: 4d61 6b65 2073 7572 6520 5f62 625f 7661  Make sure _bb_va
-00010110: 6c69 6420 6973 2073 6574 2074 6f20 6661  lid is set to fa
-00010120: 6c73 6520 666f 7220 7468 6573 6520 6e65  lse for these ne
-00010130: 7720 6f62 6a65 6374 7320 736f 206e 6577  w objects so new
-00010140: 0a20 2020 2023 2062 6f75 6e64 696e 6720  .    # bounding 
-00010150: 626f 7865 7320 6172 6520 6372 6561 7465  boxes are create
-00010160: 6420 696e 2074 6865 2063 6163 6865 0a20  d in the cache. 
-00010170: 2020 2066 6f72 2044 2069 6e20 445f 636f     for D in D_co
-00010180: 7079 2e67 6574 5f64 6570 656e 6465 6e63  py.get_dependenc
-00010190: 6965 7328 5472 7565 293a 0a20 2020 2020  ies(True):.     
-000101a0: 2020 2044 2e5f 6262 5f76 616c 6964 203d     D._bb_valid =
-000101b0: 2046 616c 7365 0a20 2020 2044 5f63 6f70   False.    D_cop
-000101c0: 792e 5f62 625f 7661 6c69 6420 3d20 4661  y._bb_valid = Fa
-000101d0: 6c73 650a 0a20 2020 2072 6574 7572 6e20  lse..    return 
-000101e0: 445f 636f 7079 0a0a 0a64 6566 2063 6f70  D_copy...def cop
-000101f0: 795f 6c61 7965 7228 442c 206c 6179 6572  y_layer(D, layer
-00010200: 3d31 2c20 6e65 775f 6c61 7965 723d 3229  =1, new_layer=2)
-00010210: 3a0a 2020 2020 2222 2243 6f70 6965 7320  :.    """Copies 
-00010220: 6120 6c61 7965 7220 7769 7468 696e 2061  a layer within a
-00010230: 2044 6576 6963 6520 746f 2061 6e6f 7468   Device to anoth
-00010240: 6572 206c 6179 6572 2069 6e20 7468 6520  er layer in the 
-00010250: 7361 6d65 2044 6576 6963 652e 0a0a 2020  same Device...  
-00010260: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-00010270: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-00010280: 4420 3a20 4465 7669 6365 0a20 2020 2020  D : Device.     
-00010290: 2020 2044 6576 6963 6520 636f 6e74 6169     Device contai
-000102a0: 6e69 6e67 206c 6179 6572 2074 6f20 6265  ning layer to be
-000102b0: 2063 6f70 6965 642e 0a20 2020 206c 6179   copied..    lay
-000102c0: 6572 203a 2069 6e74 2c20 6172 7261 792d  er : int, array-
-000102d0: 6c69 6b65 5b32 5d2c 206f 7220 7365 740a  like[2], or set.
-000102e0: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
-000102f0: 206c 6179 6572 2873 2920 746f 2063 6f70   layer(s) to cop
-00010300: 792e 0a20 2020 206e 6577 5f6c 6179 6572  y..    new_layer
-00010310: 203a 2069 6e74 2c20 6172 7261 792d 6c69   : int, array-li
-00010320: 6b65 5b32 5d2c 206f 7220 7365 740a 2020  ke[2], or set.  
-00010330: 2020 2020 2020 5370 6563 6966 6963 206c        Specific l
-00010340: 6179 6572 2873 2920 746f 2070 7574 2063  ayer(s) to put c
-00010350: 6f70 6965 6420 6c61 7965 7220 6f6e 2e0a  opied layer on..
-00010360: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
-00010370: 202d 2d2d 2d2d 2d2d 0a20 2020 2044 6576   -------.    Dev
-00010380: 6963 650a 2020 2020 2020 2020 4120 4465  ice.        A De
-00010390: 7669 6365 2063 6f6e 7461 696e 696e 6720  vice containing 
-000103a0: 7468 6520 6f72 6967 696e 616c 2061 6e64  the original and
-000103b0: 2063 6f70 6965 6420 6c61 7965 7273 2e0a   copied layers..
-000103c0: 2020 2020 2222 220a 2020 2020 445f 636f      """.    D_co
-000103d0: 7069 6564 5f6c 6179 6572 203d 2065 7874  pied_layer = ext
-000103e0: 7261 6374 2844 2c20 6c61 7965 7273 3d5b  ract(D, layers=[
-000103f0: 6c61 7965 725d 290a 2020 2020 445f 636f  layer]).    D_co
-00010400: 7069 6564 5f6c 6179 6572 2e66 6c61 7474  pied_layer.flatt
-00010410: 656e 2873 696e 676c 655f 6c61 7965 723d  en(single_layer=
-00010420: 6e65 775f 6c61 7965 7229 0a20 2020 2072  new_layer).    r
-00010430: 6574 7572 6e20 445f 636f 7069 6564 5f6c  eturn D_copied_l
-00010440: 6179 6572 0a0a 0a64 6566 2069 6d70 6f72  ayer...def impor
-00010450: 745f 6764 7328 6669 6c65 6e61 6d65 2c20  t_gds(filename, 
-00010460: 6365 6c6c 6e61 6d65 3d4e 6f6e 652c 2066  cellname=None, f
-00010470: 6c61 7474 656e 3d46 616c 7365 293a 0a20  latten=False):. 
-00010480: 2020 2022 2222 496d 706f 7274 7320 6120     """Imports a 
-00010490: 4744 5320 6669 6c65 2061 6e64 2072 6574  GDS file and ret
-000104a0: 7572 6e73 2061 2044 6576 6963 6520 7769  urns a Device wi
-000104b0: 7468 2061 6c6c 2074 6865 2063 6f72 7265  th all the corre
-000104c0: 7370 6f6e 6469 6e67 0a20 2020 2067 656f  sponding.    geo
-000104d0: 6d65 7472 790a 0a20 2020 2050 6172 616d  metry..    Param
-000104e0: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
-000104f0: 2d2d 2d2d 0a20 2020 2066 696c 656e 616d  ----.    filenam
-00010500: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
-00010510: 5061 7468 206f 7220 6e61 6d65 206f 6620  Path or name of 
-00010520: 6669 6c65 2074 6f20 6265 2069 6d70 6f72  file to be impor
-00010530: 7465 640a 2020 2020 6365 6c6c 6e61 6d65  ted.    cellname
-00010540: 203a 2073 7472 206f 7220 4e6f 6e65 0a20   : str or None. 
-00010550: 2020 2020 2020 204e 616d 6520 6f66 2074         Name of t
-00010560: 6865 2063 656c 6c20 7468 6174 2077 696c  he cell that wil
-00010570: 6c20 6265 2072 6574 7572 6e65 6420 6173  l be returned as
-00010580: 2061 2044 6576 6963 652e 2020 4966 204e   a Device.  If N
-00010590: 6f6e 652c 0a20 2020 2020 2020 2077 696c  one,.        wil
-000105a0: 6c20 6175 746f 6d61 7469 6361 6c6c 7920  l automatically 
-000105b0: 7365 6c65 6374 2074 6865 2074 6f70 6d6f  select the topmo
-000105c0: 7374 2063 656c 6c0a 2020 2020 666c 6174  st cell.    flat
-000105d0: 7465 6e20 3a20 626f 6f6c 0a20 2020 2020  ten : bool.     
-000105e0: 2020 2057 6865 7468 6572 2074 6f20 666c     Whether to fl
-000105f0: 6174 7465 6e20 7468 6520 696d 706f 7274  atten the import
-00010600: 6564 2067 656f 6d65 7472 792c 2072 656d  ed geometry, rem
-00010610: 6f76 696e 6720 616c 6c20 6365 6c6c 2068  oving all cell h
-00010620: 6569 7261 7263 6879 0a0a 2020 2020 5265  eirarchy..    Re
-00010630: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00010640: 2d0a 2020 2020 4465 7669 6365 0a20 2020  -.    Device.   
-00010650: 2020 2020 2041 2050 4849 444c 2044 6576       A PHIDL Dev
-00010660: 6963 6520 7769 7468 2061 6c6c 2074 6865  ice with all the
-00010670: 2067 656f 6d65 7472 792f 6c61 6265 6c73   geometry/labels
-00010680: 2f65 7463 2069 6d70 6f72 7465 6420 6672  /etc imported fr
-00010690: 6f6d 2074 6865 2047 4453 2066 696c 650a  om the GDS file.
-000106a0: 0a20 2020 2022 2222 0a20 2020 2067 6473  .    """.    gds
-000106b0: 6969 5f6c 6962 203d 2067 6473 7079 2e47  ii_lib = gdspy.G
-000106c0: 6473 4c69 6272 6172 7928 290a 2020 2020  dsLibrary().    
-000106d0: 6764 7369 695f 6c69 622e 7265 6164 5f67  gdsii_lib.read_g
-000106e0: 6473 2866 696c 656e 616d 6529 0a20 2020  ds(filename).   
-000106f0: 2074 6f70 5f6c 6576 656c 5f63 656c 6c73   top_level_cells
-00010700: 203d 2067 6473 6969 5f6c 6962 2e74 6f70   = gdsii_lib.top
-00010710: 5f6c 6576 656c 2829 0a20 2020 2069 6620  _level().    if 
-00010720: 6365 6c6c 6e61 6d65 2069 7320 6e6f 7420  cellname is not 
-00010730: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
-00010740: 2063 656c 6c6e 616d 6520 6e6f 7420 696e   cellname not in
-00010750: 2067 6473 6969 5f6c 6962 2e63 656c 6c73   gdsii_lib.cells
-00010760: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00010770: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
-00010780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010790: 225b 5048 4944 4c5d 2069 6d70 6f72 745f  "[PHIDL] import_
-000107a0: 6764 7328 2920 5468 6520 7265 7175 6573  gds() The reques
-000107b0: 7465 6420 6365 6c6c 2022 0a20 2020 2020  ted cell ".     
-000107c0: 2020 2020 2020 2020 2020 2022 286e 616d             "(nam
-000107d0: 6564 2025 7329 2069 7320 6e6f 7420 7072  ed %s) is not pr
-000107e0: 6573 656e 7420 696e 2066 696c 6520 2573  esent in file %s
-000107f0: 2220 2520 2863 656c 6c6e 616d 652c 2066  " % (cellname, f
-00010800: 696c 656e 616d 6529 0a20 2020 2020 2020  ilename).       
-00010810: 2020 2020 2029 0a20 2020 2020 2020 2074       ).        t
-00010820: 6f70 6365 6c6c 203d 2067 6473 6969 5f6c  opcell = gdsii_l
-00010830: 6962 2e63 656c 6c73 5b63 656c 6c6e 616d  ib.cells[cellnam
-00010840: 655d 0a20 2020 2065 6c69 6620 6365 6c6c  e].    elif cell
-00010850: 6e61 6d65 2069 7320 4e6f 6e65 2061 6e64  name is None and
-00010860: 206c 656e 2874 6f70 5f6c 6576 656c 5f63   len(top_level_c
-00010870: 656c 6c73 2920 3d3d 2031 3a0a 2020 2020  ells) == 1:.    
-00010880: 2020 2020 746f 7063 656c 6c20 3d20 746f      topcell = to
-00010890: 705f 6c65 7665 6c5f 6365 6c6c 735b 305d  p_level_cells[0]
-000108a0: 0a20 2020 2065 6c69 6620 6365 6c6c 6e61  .    elif cellna
-000108b0: 6d65 2069 7320 4e6f 6e65 2061 6e64 206c  me is None and l
-000108c0: 656e 2874 6f70 5f6c 6576 656c 5f63 656c  en(top_level_cel
-000108d0: 6c73 2920 3e20 313a 0a20 2020 2020 2020  ls) > 1:.       
-000108e0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-000108f0: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
-00010900: 5b50 4849 444c 5d20 696d 706f 7274 5f67  [PHIDL] import_g
-00010910: 6473 2829 2054 6865 7265 2061 7265 206d  ds() There are m
-00010920: 756c 7469 706c 6520 746f 702d 6c65 7665  ultiple top-leve
-00010930: 6c20 220a 2020 2020 2020 2020 2020 2020  l ".            
-00010940: 2263 656c 6c73 2c20 796f 7520 6d75 7374  "cells, you must
-00010950: 2073 7065 6369 6679 2060 6365 6c6c 6e61   specify `cellna
-00010960: 6d65 6020 746f 2073 656c 6563 7420 6f66  me` to select of
-00010970: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-00010980: 6f6e 6520 6f66 2074 6865 6d22 0a20 2020  one of them".   
-00010990: 2020 2020 2029 0a0a 2020 2020 6966 206e       )..    if n
-000109a0: 6f74 2066 6c61 7474 656e 3a0a 2020 2020  ot flatten:.    
-000109b0: 2020 2020 445f 6c69 7374 203d 205b 5d0a      D_list = [].
-000109c0: 2020 2020 2020 2020 6332 646d 6170 203d          c2dmap =
-000109d0: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
-000109e0: 6365 6c6c 2069 6e20 6764 7369 695f 6c69  cell in gdsii_li
-000109f0: 622e 6365 6c6c 732e 7661 6c75 6573 2829  b.cells.values()
-00010a00: 3a0a 2020 2020 2020 2020 2020 2020 4420  :.            D 
-00010a10: 3d20 4465 7669 6365 286e 616d 653d 6365  = Device(name=ce
-00010a20: 6c6c 2e6e 616d 6529 0a20 2020 2020 2020  ll.name).       
-00010a30: 2020 2020 2044 2e70 6f6c 7967 6f6e 7320       D.polygons 
-00010a40: 3d20 6365 6c6c 2e70 6f6c 7967 6f6e 730a  = cell.polygons.
-00010a50: 2020 2020 2020 2020 2020 2020 442e 7265              D.re
-00010a60: 6665 7265 6e63 6573 203d 2063 656c 6c2e  ferences = cell.
-00010a70: 7265 6665 7265 6e63 6573 0a20 2020 2020  references.     
-00010a80: 2020 2020 2020 2044 2e6e 616d 6520 3d20         D.name = 
-00010a90: 6365 6c6c 2e6e 616d 650a 2020 2020 2020  cell.name.      
-00010aa0: 2020 2020 2020 442e 7061 7468 7320 3d20        D.paths = 
-00010ab0: 6365 6c6c 2e70 6174 6873 0a20 2020 2020  cell.paths.     
-00010ac0: 2020 2020 2020 2066 6f72 206c 6162 656c         for label
-00010ad0: 2069 6e20 6365 6c6c 2e6c 6162 656c 733a   in cell.labels:
-00010ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010af0: 2072 6f74 6174 696f 6e20 3d20 6c61 6265   rotation = labe
-00010b00: 6c2e 726f 7461 7469 6f6e 0a20 2020 2020  l.rotation.     
-00010b10: 2020 2020 2020 2020 2020 2069 6620 726f             if ro
-00010b20: 7461 7469 6f6e 2069 7320 4e6f 6e65 3a0a  tation is None:.
-00010b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b40: 2020 2020 726f 7461 7469 6f6e 203d 2030      rotation = 0
-00010b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010b60: 206c 203d 2044 2e61 6464 5f6c 6162 656c   l = D.add_label
-00010b70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00010b80: 2020 2020 2020 7465 7874 3d6c 6162 656c        text=label
-00010b90: 2e74 6578 742c 0a20 2020 2020 2020 2020  .text,.         
-00010ba0: 2020 2020 2020 2020 2020 2070 6f73 6974             posit
-00010bb0: 696f 6e3d 6e70 2e61 7366 6172 7261 7928  ion=np.asfarray(
-00010bc0: 6c61 6265 6c2e 706f 7369 7469 6f6e 292c  label.position),
-00010bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010be0: 2020 2020 206d 6167 6e69 6669 6361 7469       magnificati
-00010bf0: 6f6e 3d6c 6162 656c 2e6d 6167 6e69 6669  on=label.magnifi
-00010c00: 6361 7469 6f6e 2c0a 2020 2020 2020 2020  cation,.        
-00010c10: 2020 2020 2020 2020 2020 2020 726f 7461              rota
-00010c20: 7469 6f6e 3d72 6f74 6174 696f 6e20 2a20  tion=rotation * 
-00010c30: 3138 3020 2f20 6e70 2e70 692c 0a20 2020  180 / np.pi,.   
-00010c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c50: 206c 6179 6572 3d28 6c61 6265 6c2e 6c61   layer=(label.la
-00010c60: 7965 722c 206c 6162 656c 2e74 6578 7474  yer, label.textt
-00010c70: 7970 6529 2c0a 2020 2020 2020 2020 2020  ype),.          
-00010c80: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00010c90: 2020 2020 2020 2020 6c2e 616e 6368 6f72          l.anchor
-00010ca0: 203d 206c 6162 656c 2e61 6e63 686f 720a   = label.anchor.
-00010cb0: 2020 2020 2020 2020 2020 2020 6332 646d              c2dm
-00010cc0: 6170 5b63 656c 6c5d 203d 2044 0a20 2020  ap[cell] = D.   
-00010cd0: 2020 2020 2020 2020 2044 5f6c 6973 742e           D_list.
-00010ce0: 6170 7065 6e64 2844 290a 0a20 2020 2020  append(D)..     
-00010cf0: 2020 2066 6f72 2044 2069 6e20 445f 6c69     for D in D_li
-00010d00: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-00010d10: 2320 4669 7273 7420 636f 6e76 6572 7420  # First convert 
-00010d20: 6561 6368 2072 6566 6572 656e 6365 2073  each reference s
-00010d30: 6f20 6974 2070 6f69 6e74 7320 746f 2074  o it points to t
-00010d40: 6865 2072 6967 6874 2044 6576 6963 650a  he right Device.
-00010d50: 2020 2020 2020 2020 2020 2020 636f 6e76              conv
-00010d60: 6572 7465 645f 7265 6665 7265 6e63 6573  erted_references
-00010d70: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-00010d80: 2020 666f 7220 6520 696e 2044 2e72 6566    for e in D.ref
-00010d90: 6572 656e 6365 733a 0a20 2020 2020 2020  erences:.       
-00010da0: 2020 2020 2020 2020 2072 6566 5f64 6576           ref_dev
-00010db0: 6963 6520 3d20 6332 646d 6170 5b65 2e72  ice = c2dmap[e.r
-00010dc0: 6566 5f63 656c 6c5d 0a20 2020 2020 2020  ef_cell].       
-00010dd0: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-00010de0: 7374 616e 6365 2865 2c20 6764 7370 792e  stance(e, gdspy.
-00010df0: 4365 6c6c 5265 6665 7265 6e63 6529 3a0a  CellReference):.
-00010e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e10: 2020 2020 6472 203d 2044 6576 6963 6552      dr = DeviceR
-00010e20: 6566 6572 656e 6365 280a 2020 2020 2020  eference(.      
-00010e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e40: 2020 6465 7669 6365 3d72 6566 5f64 6576    device=ref_dev
-00010e50: 6963 652c 0a20 2020 2020 2020 2020 2020  ice,.           
-00010e60: 2020 2020 2020 2020 2020 2020 206f 7269               ori
-00010e70: 6769 6e3d 652e 6f72 6967 696e 2c0a 2020  gin=e.origin,.  
-00010e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e90: 2020 2020 2020 726f 7461 7469 6f6e 3d65        rotation=e
-00010ea0: 2e72 6f74 6174 696f 6e2c 0a20 2020 2020  .rotation,.     
-00010eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ec0: 2020 206d 6167 6e69 6669 6361 7469 6f6e     magnification
-00010ed0: 3d65 2e6d 6167 6e69 6669 6361 7469 6f6e  =e.magnification
-00010ee0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00010ef0: 2020 2020 2020 2020 2020 785f 7265 666c            x_refl
-00010f00: 6563 7469 6f6e 3d65 2e78 5f72 6566 6c65  ection=e.x_refle
-00010f10: 6374 696f 6e2c 0a20 2020 2020 2020 2020  ction,.         
-00010f20: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00010f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f40: 2064 722e 7072 6f70 6572 7469 6573 203d   dr.properties =
-00010f50: 2065 2e70 726f 7065 7274 6965 730a 2020   e.properties.  
-00010f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f70: 2020 6472 2e6f 776e 6572 203d 2044 0a20    dr.owner = D. 
-00010f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f90: 2020 2063 6f6e 7665 7274 6564 5f72 6566     converted_ref
-00010fa0: 6572 656e 6365 732e 6170 7065 6e64 2864  erences.append(d
-00010fb0: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-00010fc0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-00010fd0: 6365 2865 2c20 6764 7370 792e 4365 6c6c  ce(e, gdspy.Cell
-00010fe0: 4172 7261 7929 3a0a 2020 2020 2020 2020  Array):.        
-00010ff0: 2020 2020 2020 2020 2020 2020 6472 203d              dr =
-00011000: 2043 656c 6c41 7272 6179 280a 2020 2020   CellArray(.    
-00011010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011020: 2020 2020 6465 7669 6365 3d72 6566 5f64      device=ref_d
-00011030: 6576 6963 652c 0a20 2020 2020 2020 2020  evice,.         
-00011040: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00011050: 6f6c 756d 6e73 3d65 2e63 6f6c 756d 6e73  olumns=e.columns
-00011060: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011070: 2020 2020 2020 2020 2020 726f 7773 3d65            rows=e
-00011080: 2e72 6f77 732c 0a20 2020 2020 2020 2020  .rows,.         
-00011090: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000110a0: 7061 6369 6e67 3d65 2e73 7061 6369 6e67  pacing=e.spacing
-000110b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000110c0: 2020 2020 2020 2020 2020 6f72 6967 696e            origin
-000110d0: 3d65 2e6f 7269 6769 6e2c 0a20 2020 2020  =e.origin,.     
-000110e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110f0: 2020 2072 6f74 6174 696f 6e3d 652e 726f     rotation=e.ro
-00011100: 7461 7469 6f6e 2c0a 2020 2020 2020 2020  tation,.        
-00011110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011120: 6d61 676e 6966 6963 6174 696f 6e3d 652e  magnification=e.
-00011130: 6d61 676e 6966 6963 6174 696f 6e2c 0a20  magnification,. 
-00011140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011150: 2020 2020 2020 2078 5f72 6566 6c65 6374         x_reflect
-00011160: 696f 6e3d 652e 785f 7265 666c 6563 7469  ion=e.x_reflecti
-00011170: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-00011180: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00011190: 2020 2020 2020 2020 2020 2020 2020 6472                dr
-000111a0: 2e6f 776e 6572 203d 2044 0a20 2020 2020  .owner = D.     
-000111b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000111c0: 6f6e 7665 7274 6564 5f72 6566 6572 656e  onverted_referen
-000111d0: 6365 732e 6170 7065 6e64 2864 7229 0a20  ces.append(dr). 
-000111e0: 2020 2020 2020 2020 2020 2044 2e72 6566             D.ref
-000111f0: 6572 656e 6365 7320 3d20 636f 6e76 6572  erences = conver
-00011200: 7465 645f 7265 6665 7265 6e63 6573 0a20  ted_references. 
-00011210: 2020 2020 2020 2020 2020 2023 204e 6578             # Nex
-00011220: 7420 636f 6e76 6572 7420 6561 6368 2050  t convert each P
-00011230: 6f6c 7967 6f6e 0a20 2020 2020 2020 2020  olygon.         
-00011240: 2020 2074 656d 705f 706f 6c79 676f 6e73     temp_polygons
-00011250: 203d 206c 6973 7428 442e 706f 6c79 676f   = list(D.polygo
-00011260: 6e73 290a 2020 2020 2020 2020 2020 2020  ns).            
-00011270: 442e 706f 6c79 676f 6e73 203d 205b 5d0a  D.polygons = [].
-00011280: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00011290: 7020 696e 2074 656d 705f 706f 6c79 676f  p in temp_polygo
-000112a0: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-000112b0: 2020 2020 442e 6164 645f 706f 6c79 676f      D.add_polygo
-000112c0: 6e28 7029 0a0a 2020 2020 2020 2020 746f  n(p)..        to
-000112d0: 7064 6576 6963 6520 3d20 6332 646d 6170  pdevice = c2dmap
-000112e0: 5b74 6f70 6365 6c6c 5d0a 2020 2020 2020  [topcell].      
-000112f0: 2020 7265 7475 726e 2074 6f70 6465 7669    return topdevi
-00011300: 6365 0a0a 2020 2020 656c 6966 2066 6c61  ce..    elif fla
-00011310: 7474 656e 3a0a 2020 2020 2020 2020 4420  tten:.        D 
-00011320: 3d20 4465 7669 6365 2822 696d 706f 7274  = Device("import
-00011330: 5f67 6473 2229 0a20 2020 2020 2020 2070  _gds").        p
-00011340: 6f6c 7967 6f6e 7320 3d20 746f 7063 656c  olygons = topcel
-00011350: 6c2e 6765 745f 706f 6c79 676f 6e73 2862  l.get_polygons(b
-00011360: 795f 7370 6563 3d54 7275 6529 0a0a 2020  y_spec=True)..  
-00011370: 2020 2020 2020 666f 7220 6c61 7965 725f        for layer_
-00011380: 696e 5f67 6473 2c20 706f 6c79 7320 696e  in_gds, polys in
-00011390: 2070 6f6c 7967 6f6e 732e 6974 656d 7328   polygons.items(
-000113a0: 293a 0a20 2020 2020 2020 2020 2020 2044  ):.            D
-000113b0: 2e61 6464 5f70 6f6c 7967 6f6e 2870 6f6c  .add_polygon(pol
-000113c0: 7973 2c20 6c61 7965 723d 6c61 7965 725f  ys, layer=layer_
-000113d0: 696e 5f67 6473 290a 2020 2020 2020 2020  in_gds).        
-000113e0: 7265 7475 726e 2044 0a0a 0a64 6566 205f  return D...def _
-000113f0: 7472 616e 736c 6174 655f 6365 6c6c 2863  translate_cell(c
-00011400: 293a 0a20 2020 2044 203d 2044 6576 6963  ):.    D = Devic
-00011410: 6528 6e61 6d65 3d63 2e6e 616d 6529 0a20  e(name=c.name). 
-00011420: 2020 2066 6f72 2065 2069 6e20 632e 656c     for e in c.el
-00011430: 656d 656e 7473 3a0a 2020 2020 2020 2020  ements:.        
-00011440: 6966 2069 7369 6e73 7461 6e63 6528 652c  if isinstance(e,
-00011450: 2067 6473 7079 2e50 6f6c 7967 6f6e 5365   gdspy.PolygonSe
-00011460: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00011470: 666f 7220 6e2c 2070 6f69 6e74 7320 696e  for n, points in
-00011480: 2065 6e75 6d65 7261 7465 2865 2e70 6f6c   enumerate(e.pol
-00011490: 7967 6f6e 7329 3a0a 2020 2020 2020 2020  ygons):.        
-000114a0: 2020 2020 2020 2020 706f 6c79 676f 6e5f          polygon_
-000114b0: 6c61 7965 7220 3d20 5f70 6172 7365 5f6c  layer = _parse_l
-000114c0: 6179 6572 2828 652e 6c61 7965 7273 5b6e  ayer((e.layers[n
-000114d0: 5d2c 2065 2e64 6174 6174 7970 6573 5b6e  ], e.datatypes[n
-000114e0: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
-000114f0: 2020 2020 442e 6164 645f 706f 6c79 676f      D.add_polygo
-00011500: 6e28 706f 696e 7473 3d70 6f69 6e74 732c  n(points=points,
-00011510: 206c 6179 6572 3d70 6f6c 7967 6f6e 5f6c   layer=polygon_l
-00011520: 6179 6572 290a 2020 2020 2020 2020 656c  ayer).        el
-00011530: 6966 2069 7369 6e73 7461 6e63 6528 652c  if isinstance(e,
-00011540: 2067 6473 7079 2e43 656c 6c52 6566 6572   gdspy.CellRefer
-00011550: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
-00011560: 2020 2064 7220 3d20 4465 7669 6365 5265     dr = DeviceRe
-00011570: 6665 7265 6e63 6528 0a20 2020 2020 2020  ference(.       
-00011580: 2020 2020 2020 2020 2064 6576 6963 653d           device=
-00011590: 5f74 7261 6e73 6c61 7465 5f63 656c 6c28  _translate_cell(
-000115a0: 652e 7265 665f 6365 6c6c 292c 0a20 2020  e.ref_cell),.   
-000115b0: 2020 2020 2020 2020 2020 2020 206f 7269               ori
-000115c0: 6769 6e3d 652e 6f72 6967 696e 2c0a 2020  gin=e.origin,.  
-000115d0: 2020 2020 2020 2020 2020 2020 2020 726f                ro
-000115e0: 7461 7469 6f6e 3d65 2e72 6f74 6174 696f  tation=e.rotatio
-000115f0: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
-00011600: 2020 206d 6167 6e69 6669 6361 7469 6f6e     magnification
-00011610: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
-00011620: 2020 2020 2020 2078 5f72 6566 6c65 6374         x_reflect
-00011630: 696f 6e3d 652e 785f 7265 666c 6563 7469  ion=e.x_reflecti
-00011640: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-00011650: 290a 2020 2020 2020 2020 2020 2020 442e  ).            D.
-00011660: 656c 656d 656e 7473 2e61 7070 656e 6428  elements.append(
-00011670: 6472 290a 2020 2020 442e 6c61 6265 6c73  dr).    D.labels
-00011680: 203d 2063 2e6c 6162 656c 730a 2020 2020   = c.labels.    
-00011690: 7265 7475 726e 2044 0a0a 0a64 6566 2070  return D...def p
-000116a0: 7265 7669 6577 5f6c 6179 6572 7365 7428  review_layerset(
-000116b0: 6c73 2c20 7369 7a65 3d31 3030 2c20 7370  ls, size=100, sp
-000116c0: 6163 696e 673d 3130 3029 3a0a 2020 2020  acing=100):.    
-000116d0: 2222 2247 656e 6572 6174 6573 2061 2070  """Generates a p
-000116e0: 7265 7669 6577 2044 6576 6963 6520 7769  review Device wi
-000116f0: 7468 2072 6570 7265 7365 6e74 6174 696f  th representatio
-00011700: 6e73 206f 6620 616c 6c20 7468 6520 6c61  ns of all the la
-00011710: 7965 7273 2c0a 2020 2020 7573 6564 2066  yers,.    used f
-00011720: 6f72 2070 7265 7669 6577 696e 6720 4c61  or previewing La
-00011730: 7965 7253 6574 2063 6f6c 6f72 2073 6368  yerSet color sch
-00011740: 656d 6573 2069 6e20 7175 6963 6b70 6c6f  emes in quickplo
-00011750: 7420 6f72 2073 6176 6564 202e 6764 730a  t or saved .gds.
-00011760: 2020 2020 6669 6c65 732e 0a0a 2020 2020      files...    
-00011770: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-00011780: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6c73  ---------.    ls
-00011790: 203a 204c 6179 6572 5365 740a 2020 2020   : LayerSet.    
-000117a0: 2020 2020 5365 7420 6f66 206c 6179 6572      Set of layer
-000117b0: 7320 746f 2070 7265 7669 6577 2063 6f6c  s to preview col
-000117c0: 6f72 2073 6368 656d 6573 2e0a 2020 2020  or schemes..    
-000117d0: 7369 7a65 203a 2069 6e74 206f 7220 666c  size : int or fl
-000117e0: 6f61 740a 2020 2020 2020 2020 5265 7369  oat.        Resi
-000117f0: 7a69 6e67 2066 6163 746f 7220 666f 7220  zing factor for 
-00011800: 7468 6520 7072 6576 6965 7720 4465 7669  the preview Devi
-00011810: 6365 2e0a 2020 2020 7370 6163 696e 6720  ce..    spacing 
-00011820: 3a20 696e 7420 6f72 2066 6c6f 6174 0a20  : int or float. 
-00011830: 2020 2020 2020 2054 6865 2073 7061 6365         The space
-00011840: 2062 6574 7765 656e 2065 6163 6820 6c61   between each la
-00011850: 7965 7220 7265 7072 6573 656e 7461 7469  yer representati
-00011860: 6f6e 2e0a 0a20 2020 2052 6574 7572 6e73  on...    Returns
-00011870: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-00011880: 2044 203a 2044 6576 6963 650a 2020 2020   D : Device.    
-00011890: 2020 2020 4120 4465 7669 6365 2063 6f6e      A Device con
-000118a0: 7461 696e 696e 6720 6120 7265 7072 6573  taining a repres
-000118b0: 656e 7461 7469 6f6e 206f 6620 616c 6c20  entation of all 
-000118c0: 7468 6520 6c61 7965 7273 2069 6e20 7468  the layers in th
-000118d0: 6520 696e 7075 740a 2020 2020 2020 2020  e input.        
-000118e0: 4c61 7965 7253 6574 2e0a 2020 2020 2222  LayerSet..    ""
-000118f0: 220a 0a20 2020 2044 203d 2044 6576 6963  "..    D = Devic
-00011900: 6528 226c 6179 6572 7365 7422 290a 2020  e("layerset").  
-00011910: 2020 7363 616c 6520 3d20 7369 7a65 202f    scale = size /
-00011920: 2031 3030 0a20 2020 206e 756d 5f6c 6179   100.    num_lay
-00011930: 6572 7320 3d20 6c65 6e28 6c73 2e5f 6c61  ers = len(ls._la
-00011940: 7965 7273 290a 2020 2020 6d61 7472 6978  yers).    matrix
-00011950: 5f73 697a 6520 3d20 696e 7428 6e70 2e63  _size = int(np.c
-00011960: 6569 6c28 6e70 2e73 7172 7428 6e75 6d5f  eil(np.sqrt(num_
-00011970: 6c61 7965 7273 2929 290a 2020 2020 736f  layers))).    so
-00011980: 7274 6564 5f6c 6179 6572 7320 3d20 736f  rted_layers = so
-00011990: 7274 6564 280a 2020 2020 2020 2020 6c73  rted(.        ls
-000119a0: 2e5f 6c61 7965 7273 2e76 616c 7565 7328  ._layers.values(
-000119b0: 292c 206b 6579 3d6c 616d 6264 6120 783a  ), key=lambda x:
-000119c0: 2028 782e 6764 735f 6c61 7965 722c 2078   (x.gds_layer, x
-000119d0: 2e67 6473 5f64 6174 6174 7970 6529 0a20  .gds_datatype). 
-000119e0: 2020 2029 0a20 2020 2066 6f72 206e 2c20     ).    for n, 
-000119f0: 6c61 7965 7220 696e 2065 6e75 6d65 7261  layer in enumera
-00011a00: 7465 2873 6f72 7465 645f 6c61 7965 7273  te(sorted_layers
-00011a10: 293a 0a20 2020 2020 2020 2052 203d 2072  ):.        R = r
-00011a20: 6563 7461 6e67 6c65 2873 697a 653d 2831  ectangle(size=(1
-00011a30: 3030 202a 2073 6361 6c65 2c20 3130 3020  00 * scale, 100 
-00011a40: 2a20 7363 616c 6529 2c20 6c61 7965 723d  * scale), layer=
-00011a50: 6c61 7965 7229 0a20 2020 2020 2020 2054  layer).        T
-00011a60: 203d 2074 6578 7428 0a20 2020 2020 2020   = text(.       
-00011a70: 2020 2020 2074 6578 743d 6622 7b6c 6179       text=f"{lay
-00011a80: 6572 2e6e 616d 657d 5c6e 7b6c 6179 6572  er.name}\n{layer
-00011a90: 2e67 6473 5f6c 6179 6572 7d20 2f20 7b6c  .gds_layer} / {l
-00011aa0: 6179 6572 2e67 6473 5f64 6174 6174 7970  ayer.gds_datatyp
-00011ab0: 657d 222c 0a20 2020 2020 2020 2020 2020  e}",.           
-00011ac0: 2073 697a 653d 3230 202a 2073 6361 6c65   size=20 * scale
-00011ad0: 2c0a 2020 2020 2020 2020 2020 2020 6a75  ,.            ju
-00011ae0: 7374 6966 793d 2263 656e 7465 7222 2c0a  stify="center",.
-00011af0: 2020 2020 2020 2020 2020 2020 6c61 7965              laye
-00011b00: 723d 6c61 7965 722c 0a20 2020 2020 2020  r=layer,.       
-00011b10: 2029 0a0a 2020 2020 2020 2020 542e 6d6f   )..        T.mo
-00011b20: 7665 2828 3530 202a 2073 6361 6c65 2c20  ve((50 * scale, 
-00011b30: 2d32 3020 2a20 7363 616c 6529 290a 2020  -20 * scale)).  
-00011b40: 2020 2020 2020 786c 6f63 203d 206e 2025        xloc = n %
-00011b50: 206d 6174 7269 785f 7369 7a65 0a20 2020   matrix_size.   
-00011b60: 2020 2020 2079 6c6f 6320 3d20 696e 7428       yloc = int(
-00011b70: 6e20 2f2f 206d 6174 7269 785f 7369 7a65  n // matrix_size
-00011b80: 290a 2020 2020 2020 2020 442e 6164 645f  ).        D.add_
-00011b90: 7265 6628 5229 2e6d 6f76 6578 2828 3130  ref(R).movex((10
-00011ba0: 3020 2b20 7370 6163 696e 6729 202a 2078  0 + spacing) * x
-00011bb0: 6c6f 6320 2a20 7363 616c 6529 2e6d 6f76  loc * scale).mov
-00011bc0: 6579 280a 2020 2020 2020 2020 2020 2020  ey(.            
-00011bd0: 2d28 3130 3020 2b20 7370 6163 696e 6729  -(100 + spacing)
-00011be0: 202a 2079 6c6f 6320 2a20 7363 616c 650a   * yloc * scale.
-00011bf0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00011c00: 2020 442e 6164 645f 7265 6628 5429 2e6d    D.add_ref(T).m
-00011c10: 6f76 6578 2828 3130 3020 2b20 7370 6163  ovex((100 + spac
-00011c20: 696e 6729 202a 2078 6c6f 6320 2a20 7363  ing) * xloc * sc
-00011c30: 616c 6529 2e6d 6f76 6579 280a 2020 2020  ale).movey(.    
-00011c40: 2020 2020 2020 2020 2d28 3130 3020 2b20          -(100 + 
-00011c50: 7370 6163 696e 6729 202a 2079 6c6f 6320  spacing) * yloc 
-00011c60: 2a20 7363 616c 650a 2020 2020 2020 2020  * scale.        
-00011c70: 290a 2020 2020 7265 7475 726e 2044 0a0a  ).    return D..
-00011c80: 0a63 6c61 7373 2064 6576 6963 655f 6c72  .class device_lr
-00011c90: 755f 6361 6368 653a 0a20 2020 2022 2222  u_cache:.    """
-00011ca0: 4c65 6173 742d 7265 6365 6e74 6c79 2d75  Least-recently-u
-00011cb0: 7365 6420 284c 5255 2920 6361 6368 6520  sed (LRU) cache 
-00011cc0: 666f 7220 4465 7669 6365 7322 2222 0a0a  for Devices"""..
-00011cd0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-00011ce0: 2873 656c 662c 2066 6e29 3a0a 2020 2020  (self, fn):.    
-00011cf0: 2020 2020 7365 6c66 2e6d 6178 7369 7a65      self.maxsize
-00011d00: 203d 2033 320a 2020 2020 2020 2020 7365   = 32.        se
-00011d10: 6c66 2e66 6e20 3d20 666e 0a20 2020 2020  lf.fn = fn.     
-00011d20: 2020 2073 656c 662e 6d65 6d6f 203d 204f     self.memo = O
-00011d30: 7264 6572 6564 4469 6374 2829 0a20 2020  rderedDict().   
-00011d40: 2020 2020 2075 7064 6174 655f 7772 6170       update_wrap
-00011d50: 7065 7228 7365 6c66 2c20 666e 290a 0a20  per(self, fn).. 
-00011d60: 2020 2064 6566 205f 5f63 616c 6c5f 5f28     def __call__(
-00011d70: 7365 6c66 2c20 2a61 7267 732c 202a 2a6b  self, *args, **k
-00011d80: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-00011d90: 7069 636b 6c65 5f73 7472 203d 2070 6963  pickle_str = pic
-00011da0: 6b6c 652e 6475 6d70 7328 6172 6773 2c20  kle.dumps(args, 
-00011db0: 3129 202b 2070 6963 6b6c 652e 6475 6d70  1) + pickle.dump
-00011dc0: 7328 6b77 6172 6773 2c20 3129 0a20 2020  s(kwargs, 1).   
-00011dd0: 2020 2020 2069 6620 7069 636b 6c65 5f73       if pickle_s
-00011de0: 7472 206e 6f74 2069 6e20 7365 6c66 2e6d  tr not in self.m
-00011df0: 656d 6f2e 6b65 7973 2829 3a0a 2020 2020  emo.keys():.    
-00011e00: 2020 2020 2020 2020 6e65 775f 6361 6368          new_cach
-00011e10: 655f 6974 656d 203d 2073 656c 662e 666e  e_item = self.fn
-00011e20: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
-00011e30: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00011e40: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-00011e50: 6e65 775f 6361 6368 655f 6974 656d 2c20  new_cache_item, 
-00011e60: 4465 7669 6365 293a 0a20 2020 2020 2020  Device):.       
-00011e70: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00011e80: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
-00011e90: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00011ea0: 5b50 4849 444c 5d20 4064 6576 6963 655f  [PHIDL] @device_
-00011eb0: 6c72 755f 6361 6368 6520 6361 6e20 6f6e  lru_cache can on
-00011ec0: 6c79 2062 6520 220a 2020 2020 2020 2020  ly be ".        
-00011ed0: 2020 2020 2020 2020 2020 2020 2275 7365              "use
-00011ee0: 6420 6f6e 2066 756e 6374 696f 6e73 2077  d on functions w
-00011ef0: 6869 6368 2072 6574 7572 6e20 6120 4465  hich return a De
-00011f00: 7669 6365 220a 2020 2020 2020 2020 2020  vice".          
-00011f10: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00011f20: 2020 2020 6966 206c 656e 2873 656c 662e      if len(self.
-00011f30: 6d65 6d6f 2920 3e20 7365 6c66 2e6d 6178  memo) > self.max
-00011f40: 7369 7a65 3a0a 2020 2020 2020 2020 2020  size:.          
-00011f50: 2020 2020 2020 7365 6c66 2e6d 656d 6f2e        self.memo.
-00011f60: 706f 7069 7465 6d28 6c61 7374 3d46 616c  popitem(last=Fal
-00011f70: 7365 2920 2023 2052 656d 6f76 6520 6f6c  se)  # Remove ol
-00011f80: 6465 7374 2069 7465 6d20 6672 6f6d 2063  dest item from c
-00011f90: 6163 6865 0a20 2020 2020 2020 2020 2020  ache.           
-00011fa0: 2023 2041 6464 2061 2064 6565 7063 6f70   # Add a deepcop
-00011fb0: 7920 6f66 206e 6577 2069 7465 6d20 746f  y of new item to
-00011fc0: 2063 6163 6865 2073 6f20 7468 6174 2069   cache so that i
-00011fd0: 6620 7765 2063 6861 6e67 6520 7468 650a  f we change the.
-00011fe0: 2020 2020 2020 2020 2020 2020 2320 7265              # re
-00011ff0: 7475 726e 6564 2064 6576 6963 652c 206f  turned device, o
-00012000: 7572 2073 746f 7265 6420 6361 6368 6520  ur stored cache 
-00012010: 6974 656d 2069 7320 6e6f 7420 6368 616e  item is not chan
-00012020: 6765 640a 2020 2020 2020 2020 2020 2020  ged.            
-00012030: 7365 6c66 2e6d 656d 6f5b 7069 636b 6c65  self.memo[pickle
-00012040: 5f73 7472 5d20 3d20 7079 7468 6f6e 5f63  _str] = python_c
-00012050: 6f70 792e 6465 6570 636f 7079 286e 6577  opy.deepcopy(new
-00012060: 5f63 6163 6865 5f69 7465 6d29 0a20 2020  _cache_item).   
-00012070: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00012080: 6e65 775f 6361 6368 655f 6974 656d 0a20  new_cache_item. 
-00012090: 2020 2020 2020 2065 6c73 653a 2020 2320         else:  # 
-000120a0: 6966 2066 6f75 6e64 2069 6e20 6361 6368  if found in cach
-000120b0: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-000120c0: 506f 7020 6361 6368 6520 6974 656d 206f  Pop cache item o
-000120d0: 7574 2061 6e64 2070 7574 2069 7420 6261  ut and put it ba
-000120e0: 636b 206f 6e20 7468 6520 746f 7020 6f66  ck on the top of
-000120f0: 2074 6865 2063 6163 6865 0a20 2020 2020   the cache.     
-00012100: 2020 2020 2020 2063 6163 6865 645f 6f75         cached_ou
-00012110: 7470 7574 203d 2073 656c 662e 6d65 6d6f  tput = self.memo
-00012120: 2e70 6f70 2870 6963 6b6c 655f 7374 7229  .pop(pickle_str)
-00012130: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00012140: 662e 6d65 6d6f 5b70 6963 6b6c 655f 7374  f.memo[pickle_st
-00012150: 725d 203d 2063 6163 6865 645f 6f75 7470  r] = cached_outp
-00012160: 7574 0a20 2020 2020 2020 2020 2020 2023  ut.            #
-00012170: 2054 6865 6e20 7265 7475 726e 2061 2063   Then return a c
-00012180: 6f70 7920 6f66 2074 6865 2063 6163 6865  opy of the cache
-00012190: 6420 4465 7669 6365 0a20 2020 2020 2020  d Device.       
-000121a0: 2020 2020 2072 6574 7572 6e20 6465 6570       return deep
-000121b0: 636f 7079 2863 6163 6865 645f 6f75 7470  copy(cached_outp
-000121c0: 7574 290a 0a0a 6465 6620 5f63 6f6e 7665  ut)...def _conve
-000121d0: 7274 5f70 6f72 745f 746f 5f67 656f 6d65  rt_port_to_geome
-000121e0: 7472 7928 706f 7274 2c20 6c61 7965 723d  try(port, layer=
-000121f0: 3029 3a0a 2020 2020 2222 2243 6f6e 7665  0):.    """Conve
-00012200: 7274 7320 6120 506f 7274 2074 6f20 6120  rts a Port to a 
-00012210: 6c61 6265 6c20 616e 6420 6120 7472 6961  label and a tria
-00012220: 6e67 6c65 2044 6576 6963 6520 7468 6174  ngle Device that
-00012230: 2061 7265 2074 6865 6e20 6164 6465 640a   are then added.
-00012240: 2020 2020 746f 2074 6865 2070 6172 656e      to the paren
-00012250: 742e 0a0a 2020 2020 5061 7261 6d65 7465  t...    Paramete
-00012260: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-00012270: 2d0a 2020 2020 706f 7274 203a 2050 6f72  -.    port : Por
-00012280: 740a 2020 2020 2020 2020 506f 7274 2074  t.        Port t
-00012290: 6f20 6265 2063 6f6e 7665 7274 6564 2e0a  o be converted..
-000122a0: 2020 2020 6c61 7965 7220 3a20 696e 742c      layer : int,
-000122b0: 2061 7272 6179 2d6c 696b 655b 325d 2c20   array-like[2], 
-000122c0: 6f72 2073 6574 0a20 2020 2020 2020 2053  or set.        S
-000122d0: 7065 6369 6669 6320 6c61 7965 7228 7329  pecific layer(s)
-000122e0: 2074 6f20 7075 7420 6c61 6265 6c20 616e   to put label an
-000122f0: 6420 6765 6f6d 6574 7279 206f 6e2e 0a0a  d geometry on...
-00012300: 2020 2020 4e6f 7465 730a 2020 2020 2d2d      Notes.    --
-00012310: 2d2d 2d0a 2020 2020 5468 6520 506f 7274  ---.    The Port
-00012320: 206d 7573 7420 7374 6172 7420 7769 7468   must start with
-00012330: 2061 2070 6172 656e 742e 0a20 2020 2022   a parent..    "
-00012340: 2222 0a20 2020 2069 6620 706f 7274 2e70  "".    if port.p
-00012350: 6172 656e 7420 6973 204e 6f6e 653a 0a20  arent is None:. 
-00012360: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00012370: 7565 4572 726f 7228 6622 506f 7274 207b  ueError(f"Port {
-00012380: 706f 7274 2e6e 616d 657d 3a20 506f 7274  port.name}: Port
-00012390: 206e 6565 6473 2061 2070 6172 656e 7420   needs a parent 
-000123a0: 696e 2077 6869 6368 2074 6f20 6472 6177  in which to draw
-000123b0: 2229 0a20 2020 2069 6620 6973 696e 7374  ").    if isinst
-000123c0: 616e 6365 2870 6f72 742e 7061 7265 6e74  ance(port.parent
-000123d0: 2c20 4465 7669 6365 5265 6665 7265 6e63  , DeviceReferenc
-000123e0: 6529 3a0a 2020 2020 2020 2020 6465 7669  e):.        devi
-000123f0: 6365 203d 2070 6f72 742e 7061 7265 6e74  ce = port.parent
-00012400: 2e70 6172 656e 740a 2020 2020 656c 7365  .parent.    else
-00012410: 3a0a 2020 2020 2020 2020 6465 7669 6365  :.        device
-00012420: 203d 2070 6f72 742e 7061 7265 6e74 0a0a   = port.parent..
-00012430: 2020 2020 2320 4120 7669 7375 616c 206d      # A visual m
-00012440: 6172 6b65 720a 2020 2020 7472 6961 6e67  arker.    triang
-00012450: 6c65 5f70 6f69 6e74 7320 3d20 5b5b 302c  le_points = [[0,
-00012460: 2030 5d5d 202a 2033 0a20 2020 2074 7269   0]] * 3.    tri
-00012470: 616e 676c 655f 706f 696e 7473 5b30 5d20  angle_points[0] 
-00012480: 3d20 706f 7274 2e65 6e64 706f 696e 7473  = port.endpoints
-00012490: 5b30 5d0a 2020 2020 7472 6961 6e67 6c65  [0].    triangle
-000124a0: 5f70 6f69 6e74 735b 315d 203d 2070 6f72  _points[1] = por
-000124b0: 742e 656e 6470 6f69 6e74 735b 315d 0a20  t.endpoints[1]. 
-000124c0: 2020 2074 7269 616e 676c 655f 706f 696e     triangle_poin
-000124d0: 7473 5b32 5d20 3d20 280a 2020 2020 2020  ts[2] = (.      
-000124e0: 2020 706f 7274 2e6d 6964 706f 696e 7420    port.midpoint 
-000124f0: 2b20 2870 6f72 742e 6e6f 726d 616c 202d  + (port.normal -
-00012500: 2070 6f72 742e 6d69 6470 6f69 6e74 2920   port.midpoint) 
-00012510: 2a20 706f 7274 2e77 6964 7468 202f 2031  * port.width / 1
-00012520: 300a 2020 2020 295b 315d 0a20 2020 2064  0.    )[1].    d
-00012530: 6576 6963 652e 6164 645f 706f 6c79 676f  evice.add_polygo
-00012540: 6e28 7472 6961 6e67 6c65 5f70 6f69 6e74  n(triangle_point
-00012550: 732c 206c 6179 6572 290a 0a20 2020 2023  s, layer)..    #
-00012560: 204c 6162 656c 2063 6172 7279 696e 6720   Label carrying 
-00012570: 6163 7475 616c 2069 6e66 6f72 6d61 7469  actual informati
-00012580: 6f6e 2074 6861 7420 7769 6c6c 2062 6520  on that will be 
-00012590: 7265 636f 7665 7265 640a 2020 2020 6c61  recovered.    la
-000125a0: 6265 6c5f 636f 6e74 656e 7473 203d 2028  bel_contents = (
-000125b0: 0a20 2020 2020 2020 2073 7472 2870 6f72  .        str(por
-000125c0: 742e 6e61 6d65 292c 0a20 2020 2020 2020  t.name),.       
-000125d0: 2023 2070 6f72 742e 6d69 6470 6f69 6e74   # port.midpoint
-000125e0: 2c0a 2020 2020 2020 2020 2320 7261 7468  ,.        # rath
-000125f0: 6572 2074 6861 6e20 7075 7420 7468 6973  er than put this
-00012600: 2069 6e20 7468 6520 7465 7874 2c20 7573   in the text, us
-00012610: 6520 7468 6520 6c61 6265 6c0a 2020 2020  e the label.    
-00012620: 2020 2020 2320 706f 7369 7469 6f6e 0a20      # position. 
-00012630: 2020 2020 2020 2023 2074 6869 7320 6361         # this ca
-00012640: 6e20 6861 7665 2072 6f75 6e64 696e 6720  n have rounding 
-00012650: 6572 726f 7273 2074 6861 7420 6172 6520  errors that are 
-00012660: 6c65 7373 2074 6861 6e20 610a 2020 2020  less than a.    
-00012670: 2020 2020 2320 6e61 6e6f 6d65 7465 720a      # nanometer.
-00012680: 2020 2020 2020 2020 666c 6f61 7428 6e70          float(np
-00012690: 2e72 6f75 6e64 2870 6f72 742e 7769 6474  .round(port.widt
-000126a0: 682c 2064 6563 696d 616c 733d 3329 292c  h, decimals=3)),
-000126b0: 0a20 2020 2020 2020 2066 6c6f 6174 2870  .        float(p
-000126c0: 6f72 742e 6f72 6965 6e74 6174 696f 6e29  ort.orientation)
-000126d0: 2c0a 2020 2020 2020 2020 2320 6465 7669  ,.        # devi
-000126e0: 6365 2c20 2320 7468 6973 2069 7320 6465  ce, # this is de
-000126f0: 6669 6e69 7465 6c79 206e 6f74 2073 6572  finitely not ser
-00012700: 6961 6c69 7a61 626c 650a 2020 2020 2020  ializable.      
-00012710: 2020 2320 706f 7274 2e69 6e66 6f2c 2023    # port.info, #
-00012720: 2077 6f75 6c64 206c 696b 6520 746f 2069   would like to i
-00012730: 6e63 6c75 6465 2c20 6275 7420 6974 206d  nclude, but it m
-00012740: 6967 6874 2067 6f0a 2020 2020 2020 2020  ight go.        
-00012750: 2320 6c6f 6e67 6572 2074 6861 6e20 3130  # longer than 10
-00012760: 3234 2063 6861 7261 6374 6572 730a 2020  24 characters.  
-00012770: 2020 2020 2020 2320 706f 7274 2e75 6964        # port.uid
-00012780: 2c20 2320 6e6f 7420 696e 636c 7564 696e  , # not includin
-00012790: 6720 6265 6361 7573 6520 6974 2069 7320  g because it is 
-000127a0: 7061 7274 206f 6620 7468 650a 2020 2020  part of the.    
-000127b0: 2020 2020 2320 6275 696c 6420 7072 6f63      # build proc
-000127c0: 6573 732c 206e 6f74 2074 6865 2070 6f72  ess, not the por
-000127d0: 7420 7374 6174 650a 2020 2020 290a 2020  t state.    ).  
-000127e0: 2020 6c61 6265 6c5f 7465 7874 203d 206a    label_text = j
-000127f0: 736f 6e2e 6475 6d70 7328 6c61 6265 6c5f  son.dumps(label_
-00012800: 636f 6e74 656e 7473 290a 2020 2020 6465  contents).    de
-00012810: 7669 6365 2e61 6464 5f6c 6162 656c 280a  vice.add_label(.
-00012820: 2020 2020 2020 2020 7465 7874 3d6c 6162          text=lab
-00012830: 656c 5f74 6578 742c 0a20 2020 2020 2020  el_text,.       
-00012840: 2070 6f73 6974 696f 6e3d 706f 7274 2e6d   position=port.m
-00012850: 6964 706f 696e 7420 2b20 5f63 616c 6375  idpoint + _calcu
-00012860: 6c61 7465 5f6c 6162 656c 5f6f 6666 7365  late_label_offse
-00012870: 7428 706f 7274 292c 0a20 2020 2020 2020  t(port),.       
-00012880: 206d 6167 6e69 6669 6361 7469 6f6e 3d30   magnification=0
-00012890: 2e30 3420 2a20 706f 7274 2e77 6964 7468  .04 * port.width
-000128a0: 2c0a 2020 2020 2020 2020 726f 7461 7469  ,.        rotati
-000128b0: 6f6e 3d28 3930 202b 2070 6f72 742e 6f72  on=(90 + port.or
-000128c0: 6965 6e74 6174 696f 6e29 2025 2033 3630  ientation) % 360
-000128d0: 2c0a 2020 2020 2020 2020 6c61 7965 723d  ,.        layer=
-000128e0: 6c61 7965 722c 0a20 2020 2029 0a0a 0a64  layer,.    )...d
-000128f0: 6566 205f 6361 6c63 756c 6174 655f 6c61  ef _calculate_la
-00012900: 6265 6c5f 6f66 6673 6574 2870 6f72 7429  bel_offset(port)
-00012910: 3a0a 2020 2020 2222 2255 7365 6420 746f  :.    """Used to
-00012920: 2070 7574 2074 6865 206c 6162 656c 2069   put the label i
-00012930: 6e20 6120 7072 6574 7479 2070 6f73 6974  n a pretty posit
-00012940: 696f 6e2e 2049 7420 6973 2061 6464 6564  ion. It is added
-00012950: 2077 6865 6e20 6472 6177 696e 670a 2020   when drawing.  
-00012960: 2020 616e 6420 7375 6273 7472 6163 7465    and substracte
-00012970: 6420 7768 656e 2065 7874 7261 6374 696e  d when extractin
-00012980: 672e 0a0a 2020 2020 5061 7261 6d65 7465  g...    Paramete
-00012990: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-000129a0: 2d0a 2020 2020 706f 7274 203a 2050 6f72  -.    port : Por
-000129b0: 740a 2020 2020 2020 2020 506f 7274 2d63  t.        Port-c
-000129c0: 6f6e 7665 7274 6564 206c 6162 656c 2074  onverted label t
-000129d0: 6f20 6d6f 7665 2e0a 0a20 2020 2052 6574  o move...    Ret
-000129e0: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
-000129f0: 0a20 2020 206f 6666 7365 745f 706f 7369  .    offset_posi
-00012a00: 7469 6f6e 203a 2061 7272 6179 2d6c 696b  tion : array-lik
-00012a10: 650a 2020 2020 2020 2020 436f 6f72 6469  e.        Coordi
-00012a20: 6e61 7465 7320 6f66 206e 6577 2070 6f72  nates of new por
-00012a30: 7420 706f 7369 7469 6f6e 2e0a 2020 2020  t position..    
-00012a40: 2222 220a 2020 2020 6f66 6673 6574 5f70  """.    offset_p
-00012a50: 6f73 6974 696f 6e20 3d20 6e70 2e61 7272  osition = np.arr
-00012a60: 6179 280a 2020 2020 2020 2020 282d 636f  ay(.        (-co
-00012a70: 7328 7069 202f 2031 3830 202a 2070 6f72  s(pi / 180 * por
-00012a80: 742e 6f72 6965 6e74 6174 696f 6e29 2c20  t.orientation), 
-00012a90: 2d73 696e 2870 6920 2f20 3138 3020 2a20  -sin(pi / 180 * 
-00012aa0: 706f 7274 2e6f 7269 656e 7461 7469 6f6e  port.orientation
-00012ab0: 2929 0a20 2020 2029 0a20 2020 206f 6666  )).    ).    off
-00012ac0: 7365 745f 706f 7369 7469 6f6e 202a 3d20  set_position *= 
-00012ad0: 706f 7274 2e77 6964 7468 202a 2030 2e30  port.width * 0.0
-00012ae0: 350a 2020 2020 7265 7475 726e 206f 6666  5.    return off
-00012af0: 7365 745f 706f 7369 7469 6f6e 0a0a 0a64  set_position...d
-00012b00: 6566 205f 636f 6e76 6572 745f 6765 6f6d  ef _convert_geom
-00012b10: 6574 7279 5f74 6f5f 706f 7274 286c 6162  etry_to_port(lab
-00012b20: 656c 2c20 6c61 7965 723d 3029 3a0a 2020  el, layer=0):.  
-00012b30: 2020 2222 2243 6f6e 7665 7274 7320 6120    """Converts a 
-00012b40: 6c61 6265 6c20 696e 746f 2061 2050 6f72  label into a Por
-00012b50: 7420 696e 2074 6865 2070 6172 656e 7420  t in the parent 
-00012b60: 4465 7669 6365 2e20 5468 6520 6c61 6265  Device. The labe
-00012b70: 6c20 636f 6e74 6169 6e73 0a20 2020 206e  l contains.    n
-00012b80: 616d 652c 2077 6964 7468 2c20 6f72 6965  ame, width, orie
-00012b90: 6e74 6174 696f 6e2e 2044 6f65 7320 6e6f  ntation. Does no
-00012ba0: 7420 7265 6d6f 7665 2074 6861 7420 6c61  t remove that la
-00012bb0: 6265 6c20 6672 6f6d 2074 6865 2070 6172  bel from the par
-00012bc0: 656e 742e 0a20 2020 2052 6574 7572 6e73  ent..    Returns
-00012bd0: 2074 6865 206e 6577 2070 6f72 742e 0a0a   the new port...
-00012be0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-00012bf0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-00012c00: 2020 6c61 6265 6c20 3a20 4c61 6265 6c0a    label : Label.
-00012c10: 2020 2020 2020 2020 4c61 6265 6c20 746f          Label to
-00012c20: 2062 6520 636f 6e76 6572 7465 6420 696e   be converted in
-00012c30: 746f 2061 2050 6f72 742e 0a20 2020 206c  to a Port..    l
-00012c40: 6179 6572 203a 2069 6e74 2c20 6172 7261  ayer : int, arra
-00012c50: 792d 6c69 6b65 5b32 5d2c 206f 7220 7365  y-like[2], or se
-00012c60: 740a 2020 2020 2020 2020 5370 6563 6966  t.        Specif
-00012c70: 6963 206c 6179 6572 2873 2920 746f 2070  ic layer(s) to p
-00012c80: 7574 2050 6f72 7420 6f6e 2e0a 0a20 2020  ut Port on...   
-00012c90: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
-00012ca0: 2d2d 2d2d 0a20 2020 206e 6577 5f70 6f72  ----.    new_por
-00012cb0: 7420 3a20 506f 7274 0a20 2020 2020 2020  t : Port.       
-00012cc0: 2050 6f72 742d 636f 6e76 6572 7465 6420   Port-converted 
-00012cd0: 6c61 6265 6c2e 0a20 2020 2022 2222 0a20  label..    """. 
-00012ce0: 2020 206e 616d 652c 2077 6964 7468 2c20     name, width, 
-00012cf0: 6f72 6965 6e74 6174 696f 6e20 3d20 6a73  orientation = js
-00012d00: 6f6e 2e6c 6f61 6473 286c 6162 656c 2e74  on.loads(label.t
-00012d10: 6578 7429 0a20 2020 206e 6577 5f70 6f72  ext).    new_por
-00012d20: 7420 3d20 506f 7274 286e 616d 653d 6e61  t = Port(name=na
-00012d30: 6d65 2c20 7769 6474 683d 7769 6474 682c  me, width=width,
-00012d40: 206f 7269 656e 7461 7469 6f6e 3d6f 7269   orientation=ori
-00012d50: 656e 7461 7469 6f6e 290a 2020 2020 6e65  entation).    ne
-00012d60: 775f 706f 7274 2e6d 6964 706f 696e 7420  w_port.midpoint 
-00012d70: 3d20 6c61 6265 6c2e 706f 7369 7469 6f6e  = label.position
-00012d80: 202d 205f 6361 6c63 756c 6174 655f 6c61   - _calculate_la
-00012d90: 6265 6c5f 6f66 6673 6574 286e 6577 5f70  bel_offset(new_p
-00012da0: 6f72 7429 0a20 2020 2072 6574 7572 6e20  ort).    return 
-00012db0: 6e65 775f 706f 7274 0a0a 0a64 6566 2070  new_port...def p
-00012dc0: 6f72 7473 5f74 6f5f 6765 6f6d 6574 7279  orts_to_geometry
-00012dd0: 2864 6576 6963 652c 206c 6179 6572 3d30  (device, layer=0
-00012de0: 293a 0a20 2020 2022 2222 436f 6e76 6572  ):.    """Conver
-00012df0: 7473 2050 6f72 7420 6f62 6a65 6374 7320  ts Port objects 
-00012e00: 6f76 6572 2074 6865 2077 686f 6c65 2044  over the whole D
-00012e10: 6576 6963 6520 6869 6572 6172 6368 7920  evice hierarchy 
-00012e20: 746f 2067 656f 6d65 7472 7920 616e 640a  to geometry and.
-00012e30: 2020 2020 6c61 6265 6c73 2e0a 0a20 2020      labels...   
-00012e40: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-00012e50: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2064  ----------.    d
-00012e60: 6576 6963 6520 3a20 4465 7669 6365 0a20  evice : Device. 
-00012e70: 2020 2020 2020 2044 6576 6963 6520 636f         Device co
-00012e80: 6e74 6169 6e69 6e67 2050 6f72 7420 6f62  ntaining Port ob
-00012e90: 6a65 6374 7320 746f 2063 6f6e 7665 7274  jects to convert
-00012ea0: 2e0a 2020 2020 6c61 7965 7220 3a20 696e  ..    layer : in
-00012eb0: 742c 2061 7272 6179 2d6c 696b 655b 325d  t, array-like[2]
-00012ec0: 2c20 6f72 2073 6574 0a20 2020 2020 2020  , or set.       
-00012ed0: 2053 7065 6369 6669 6320 6c61 7965 7228   Specific layer(
-00012ee0: 7329 2074 6f20 7075 7420 706f 6c79 676f  s) to put polygo
-00012ef0: 6e20 6765 6f6d 6574 7279 206f 6e20 2874  n geometry on (t
-00012f00: 6865 2073 7065 6369 616c 2070 6f72 7420  he special port 
-00012f10: 7265 636f 7264 0a20 2020 2020 2020 206c  record.        l
-00012f20: 6179 6572 292e 0a0a 2020 2020 5265 7475  ayer)...    Retu
-00012f30: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00012f40: 2020 2020 7465 6d70 5f64 6576 6963 6520      temp_device 
-00012f50: 3a20 4465 7669 6365 0a20 2020 2020 2020  : Device.       
-00012f60: 2041 2044 6576 6963 6520 7769 7468 2061   A Device with a
-00012f70: 6c6c 2050 6f72 7473 2063 6f6e 7665 7274  ll Ports convert
-00012f80: 6564 2074 6f20 6765 6f6d 6574 7279 2f6c  ed to geometry/l
-00012f90: 6162 656c 7320 616e 6420 7265 6d6f 7665  abels and remove
-00012fa0: 642e 0a20 2020 2022 2222 0a20 2020 2074  d..    """.    t
-00012fb0: 656d 705f 6465 7669 6365 203d 2064 6565  emp_device = dee
-00012fc0: 7063 6f70 7928 6465 7669 6365 290a 2020  pcopy(device).  
-00012fd0: 2020 616c 6c5f 6365 6c6c 7320 3d20 6c69    all_cells = li
-00012fe0: 7374 2874 656d 705f 6465 7669 6365 2e67  st(temp_device.g
-00012ff0: 6574 5f64 6570 656e 6465 6e63 6965 7328  et_dependencies(
-00013000: 7265 6375 7273 6976 653d 5472 7565 2929  recursive=True))
-00013010: 0a20 2020 2061 6c6c 5f63 656c 6c73 2e61  .    all_cells.a
-00013020: 7070 656e 6428 7465 6d70 5f64 6576 6963  ppend(temp_devic
-00013030: 6529 0a20 2020 2066 6f72 2073 7562 6365  e).    for subce
-00013040: 6c6c 2069 6e20 616c 6c5f 6365 6c6c 733a  ll in all_cells:
-00013050: 0a20 2020 2020 2020 2066 6f72 2070 6f72  .        for por
-00013060: 7420 696e 2073 7562 6365 6c6c 2e70 6f72  t in subcell.por
-00013070: 7473 2e76 616c 7565 7328 293a 0a20 2020  ts.values():.   
-00013080: 2020 2020 2020 2020 205f 636f 6e76 6572           _conver
-00013090: 745f 706f 7274 5f74 6f5f 6765 6f6d 6574  t_port_to_geomet
-000130a0: 7279 2870 6f72 742c 206c 6179 6572 3d6c  ry(port, layer=l
-000130b0: 6179 6572 290a 2020 2020 2020 2020 2020  ayer).          
-000130c0: 2020 7375 6263 656c 6c2e 7265 6d6f 7665    subcell.remove
-000130d0: 2870 6f72 7429 0a20 2020 2072 6574 7572  (port).    retur
-000130e0: 6e20 7465 6d70 5f64 6576 6963 650a 0a0a  n temp_device...
-000130f0: 6465 6620 6765 6f6d 6574 7279 5f74 6f5f  def geometry_to_
-00013100: 706f 7274 7328 6465 7669 6365 2c20 6c61  ports(device, la
-00013110: 7965 723d 3029 3a0a 2020 2020 2222 2243  yer=0):.    """C
-00013120: 6f6e 7665 7274 7320 6765 6f6d 6574 7279  onverts geometry
-00013130: 2072 6570 7265 7365 6e74 696e 6720 706f   representing po
-00013140: 7274 7320 6f76 6572 2074 6865 2077 686f  rts over the who
-00013150: 6c65 2044 6576 6963 6520 6869 6572 6172  le Device hierar
-00013160: 6368 790a 2020 2020 696e 746f 2050 6f72  chy.    into Por
-00013170: 7420 6f62 6a65 6374 732e 0a0a 2020 2020  t objects...    
-00013180: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-00013190: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6465  ---------.    de
-000131a0: 7669 6365 203a 2044 6576 6963 650a 2020  vice : Device.  
-000131b0: 2020 2020 2020 4465 7669 6365 2063 6f6e        Device con
-000131c0: 7461 696e 696e 6720 6765 6f6d 6574 7279  taining geometry
-000131d0: 2072 6570 7265 7365 6e74 696e 6720 706f   representing po
-000131e0: 7274 7320 746f 2063 6f6e 7665 7274 2e0a  rts to convert..
-000131f0: 2020 2020 6c61 7965 7220 3a20 696e 742c      layer : int,
-00013200: 2061 7272 6179 2d6c 696b 655b 325d 2c20   array-like[2], 
-00013210: 6f72 2073 6574 0a20 2020 2020 2020 2053  or set.        S
-00013220: 7065 6369 6669 6320 6c61 7965 7228 7329  pecific layer(s)
-00013230: 2074 6f20 7075 7420 706f 6c79 676f 6e20   to put polygon 
-00013240: 6765 6f6d 6574 7279 206f 6e20 2874 6865  geometry on (the
-00013250: 2073 7065 6369 616c 2070 6f72 7420 7265   special port re
-00013260: 636f 7264 0a20 2020 2020 2020 206c 6179  cord.        lay
-00013270: 6572 290a 0a20 2020 2052 6574 7572 6e73  er)..    Returns
-00013280: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-00013290: 2074 656d 705f 6465 7669 6365 203a 2044   temp_device : D
-000132a0: 6576 6963 650a 2020 2020 2020 2020 4120  evice.        A 
-000132b0: 4465 7669 6365 2077 6974 6820 616c 6c20  Device with all 
-000132c0: 6765 6f6d 6574 7279 2072 6570 7265 7365  geometry represe
-000132d0: 6e74 696e 6720 706f 7274 7320 636f 6e76  nting ports conv
-000132e0: 6572 7465 6420 746f 2050 6f72 7473 2061  erted to Ports a
-000132f0: 6e64 0a20 2020 2020 2020 2072 656d 6f76  nd.        remov
-00013300: 6564 2e0a 0a20 2020 204e 6f74 6573 0a20  ed...    Notes. 
-00013310: 2020 202d 2d2d 2d2d 0a20 2020 2044 6f65     -----.    Doe
-00013320: 7320 6e6f 7420 6d75 7461 7465 2074 6865  s not mutate the
-00013330: 2064 6576 6963 6520 696e 2074 6865 2061   device in the a
-00013340: 7267 756d 656e 742e 2052 6574 7572 6e73  rgument. Returns
-00013350: 2061 206e 6577 206f 6e65 206c 6163 6b69   a new one lacki
-00013360: 6e67 2061 6c6c 0a20 2020 2070 6f72 7420  ng all.    port 
-00013370: 6765 6f6d 6574 7279 2028 696e 636c 2e20  geometry (incl. 
-00013380: 6c61 6265 6c73 290a 2020 2020 2222 220a  labels).    """.
-00013390: 2020 2020 7465 6d70 5f64 6576 6963 6520      temp_device 
-000133a0: 3d20 6465 6570 636f 7079 2864 6576 6963  = deepcopy(devic
-000133b0: 6529 0a20 2020 2061 6c6c 5f63 656c 6c73  e).    all_cells
-000133c0: 203d 206c 6973 7428 7465 6d70 5f64 6576   = list(temp_dev
-000133d0: 6963 652e 6765 745f 6465 7065 6e64 656e  ice.get_dependen
-000133e0: 6369 6573 2872 6563 7572 7369 7665 3d54  cies(recursive=T
-000133f0: 7275 6529 290a 2020 2020 616c 6c5f 6365  rue)).    all_ce
-00013400: 6c6c 732e 6170 7065 6e64 2874 656d 705f  lls.append(temp_
-00013410: 6465 7669 6365 290a 2020 2020 666f 7220  device).    for 
-00013420: 7375 6263 656c 6c20 696e 2061 6c6c 5f63  subcell in all_c
-00013430: 656c 6c73 3a20 2023 2057 616c 6b20 7468  ells:  # Walk th
-00013440: 726f 7567 6820 6365 6c6c 730a 2020 2020  rough cells.    
-00013450: 2020 2020 666f 7220 6c61 6220 696e 2073      for lab in s
-00013460: 7562 6365 6c6c 2e6c 6162 656c 733a 0a20  ubcell.labels:. 
-00013470: 2020 2020 2020 2020 2020 2069 6620 6c61             if la
-00013480: 622e 6c61 7965 7220 3d3d 206c 6179 6572  b.layer == layer
-00013490: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000134a0: 2020 7468 655f 706f 7274 203d 205f 636f    the_port = _co
-000134b0: 6e76 6572 745f 6765 6f6d 6574 7279 5f74  nvert_geometry_t
-000134c0: 6f5f 706f 7274 286c 6162 290a 2020 2020  o_port(lab).    
-000134d0: 2020 2020 2020 2020 2020 2020 7375 6263              subc
-000134e0: 656c 6c2e 6164 645f 706f 7274 286e 616d  ell.add_port(nam
-000134f0: 653d 7468 655f 706f 7274 2e6e 616d 652c  e=the_port.name,
-00013500: 2070 6f72 743d 7468 655f 706f 7274 290a   port=the_port).
-00013510: 2020 2020 7465 6d70 5f64 6576 6963 652e      temp_device.
-00013520: 7265 6d6f 7665 5f6c 6179 6572 7328 6c61  remove_layers(la
-00013530: 7965 7273 3d5b 6c61 7965 725d 2c20 696e  yers=[layer], in
-00013540: 636c 7564 655f 6c61 6265 6c73 3d54 7275  clude_labels=Tru
-00013550: 6529 0a20 2020 2072 6574 7572 6e20 7465  e).    return te
-00013560: 6d70 5f64 6576 6963 650a 0a0a 2320 3d3d  mp_device...# ==
-00013570: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00013580: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00013590: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000135a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000135b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a23 0a23  ============.#.#
-000135c0: 2043 6f6e 6e65 6374 6f72 730a 230a 2320   Connectors.#.# 
-000135d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000135e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000135f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00013600: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00013610: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a  ==============..
-00013620: 0a64 6566 2063 6f6e 6e65 6374 6f72 286d  .def connector(m
-00013630: 6964 706f 696e 743d 2830 2c20 3029 2c20  idpoint=(0, 0), 
-00013640: 7769 6474 683d 312c 206f 7269 656e 7461  width=1, orienta
-00013650: 7469 6f6e 3d30 293a 0a20 2020 2022 2222  tion=0):.    """
-00013660: 4372 6561 7465 7320 6120 4465 7669 6365  Creates a Device
-00013670: 2077 6869 6368 2068 6173 2062 6163 6b2d   which has back-
-00013680: 746f 2d62 6163 6b20 706f 7274 732e 0a0a  to-back ports...
-00013690: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-000136a0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-000136b0: 2020 6d69 6470 6f69 6e74 203a 2061 7272    midpoint : arr
-000136c0: 6179 2d6c 696b 650a 2020 2020 2020 2020  ay-like.        
-000136d0: 436f 6f72 6469 6e61 7465 7320 6f66 2044  Coordinates of D
-000136e0: 6576 6963 6520 6d69 6470 6f69 6e74 2e0a  evice midpoint..
-000136f0: 2020 2020 7769 6474 6820 3a20 696e 7420      width : int 
-00013700: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
-00013710: 2057 6964 7468 206f 6620 636f 6e6e 6563   Width of connec
-00013720: 746f 7220 6f6e 206e 6f6e 2d70 6f72 7420  tor on non-port 
-00013730: 6178 6973 2e0a 2020 2020 6f72 6965 6e74  axis..    orient
-00013740: 6174 696f 6e20 3a20 696e 7420 6f72 2066  ation : int or f
-00013750: 6c6f 6174 0a20 2020 2020 2020 204f 7269  loat.        Ori
-00013760: 656e 7461 7469 6f6e 206f 6620 7468 6520  entation of the 
-00013770: 706f 7274 732e 0a0a 2020 2020 5265 7475  ports...    Retu
-00013780: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00013790: 2020 2020 4420 3a20 4465 7669 6365 0a20      D : Device. 
-000137a0: 2020 2020 2020 2041 2044 6576 6963 6520         A Device 
-000137b0: 636f 6e74 6169 6e69 6e67 2061 2062 6163  containing a bac
-000137c0: 6b2d 746f 2d62 6163 6b20 706f 7274 2067  k-to-back port g
-000137d0: 656f 6d65 7472 792e 0a20 2020 2022 2222  eometry..    """
-000137e0: 0a20 2020 2044 203d 2044 6576 6963 6528  .    D = Device(
-000137f0: 6e61 6d65 3d22 636f 6e6e 6563 746f 7222  name="connector"
-00013800: 290a 2020 2020 442e 6164 645f 706f 7274  ).    D.add_port
-00013810: 280a 2020 2020 2020 2020 6e61 6d65 3d31  (.        name=1
-00013820: 2c0a 2020 2020 2020 2020 6d69 6470 6f69  ,.        midpoi
-00013830: 6e74 3d5b 6d69 6470 6f69 6e74 5b30 5d2c  nt=[midpoint[0],
-00013840: 206d 6964 706f 696e 745b 315d 5d2c 0a20   midpoint[1]],. 
-00013850: 2020 2020 2020 2077 6964 7468 3d77 6964         width=wid
-00013860: 7468 2c0a 2020 2020 2020 2020 6f72 6965  th,.        orie
-00013870: 6e74 6174 696f 6e3d 6f72 6965 6e74 6174  ntation=orientat
-00013880: 696f 6e2c 0a20 2020 2029 0a20 2020 2044  ion,.    ).    D
-00013890: 2e61 6464 5f70 6f72 7428 0a20 2020 2020  .add_port(.     
-000138a0: 2020 206e 616d 653d 322c 0a20 2020 2020     name=2,.     
-000138b0: 2020 206d 6964 706f 696e 743d 5b6d 6964     midpoint=[mid
-000138c0: 706f 696e 745b 305d 2c20 6d69 6470 6f69  point[0], midpoi
-000138d0: 6e74 5b31 5d5d 2c0a 2020 2020 2020 2020  nt[1]],.        
-000138e0: 7769 6474 683d 7769 6474 682c 0a20 2020  width=width,.   
-000138f0: 2020 2020 206f 7269 656e 7461 7469 6f6e       orientation
-00013900: 3d6f 7269 656e 7461 7469 6f6e 202d 2031  =orientation - 1
-00013910: 3830 2c0a 2020 2020 290a 2020 2020 7265  80,.    ).    re
-00013920: 7475 726e 2044 0a0a 0a23 203d 3d3d 3d3d  turn D...# =====
-00013930: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00013940: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00013950: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00013960: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00013970: 3d3d 3d3d 3d3d 3d3d 3d0a 230a 2320 436f  =========.#.# Co
-00013980: 6e74 6163 7420 7061 6473 0a23 0a23 203d  ntact pads.#.# =
-00013990: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000139a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000139b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000139c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000139d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a0a  =============...
-000139e0: 6465 6620 636f 6d70 6173 7328 7369 7a65  def compass(size
-000139f0: 3d28 342c 2032 292c 206c 6179 6572 3d30  =(4, 2), layer=0
-00013a00: 293a 0a20 2020 2022 2222 4372 6561 7465  ):.    """Create
-00013a10: 7320 6120 7265 6374 616e 6775 6c61 7220  s a rectangular 
-00013a20: 636f 6e74 6163 7420 7061 6420 7769 7468  contact pad with
-00013a30: 2063 656e 7465 7265 6420 706f 7274 7320   centered ports 
-00013a40: 6f6e 2065 6467 6573 206f 6620 7468 650a  on edges of the.
-00013a50: 2020 2020 7265 6374 616e 676c 6520 286e      rectangle (n
-00013a60: 6f72 7468 2c20 736f 7574 682c 2065 6173  orth, south, eas
-00013a70: 742c 2061 6e64 2077 6573 7429 2e0a 0a20  t, and west)... 
-00013a80: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-00013a90: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-00013aa0: 2073 697a 6520 3a20 6172 7261 795f 6c69   size : array_li
-00013ab0: 6b65 5b32 5d0a 2020 2020 2020 2020 4469  ke[2].        Di
-00013ac0: 6d65 6e73 696f 6e73 206f 6620 7468 6520  mensions of the 
-00013ad0: 7265 6374 616e 6775 6c61 7220 636f 6e74  rectangular cont
-00013ae0: 6163 7420 7061 642e 0a20 2020 206c 6179  act pad..    lay
-00013af0: 6572 203a 2069 6e74 2c20 6172 7261 792d  er : int, array-
-00013b00: 6c69 6b65 5b32 5d2c 206f 7220 7365 740a  like[2], or set.
-00013b10: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
-00013b20: 206c 6179 6572 2873 2920 746f 2070 7574   layer(s) to put
-00013b30: 2070 6f6c 7967 6f6e 2067 656f 6d65 7472   polygon geometr
-00013b40: 7920 6f6e 2e0a 0a20 2020 2052 6574 7572  y on...    Retur
-00013b50: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-00013b60: 2020 2044 203a 2044 6576 6963 650a 2020     D : Device.  
-00013b70: 2020 2020 2020 4120 4465 7669 6365 2063        A Device c
-00013b80: 6f6e 7461 696e 696e 6720 6120 7265 6374  ontaining a rect
-00013b90: 616e 6775 6c61 7220 636f 6e74 6163 7420  angular contact 
-00013ba0: 7061 6420 7769 7468 2063 656e 7465 7265  pad with centere
-00013bb0: 6420 706f 7274 732e 0a20 2020 2022 2222  d ports..    """
-00013bc0: 0a20 2020 2044 203d 2044 6576 6963 6528  .    D = Device(
-00013bd0: 6e61 6d65 3d22 636f 6d70 6173 7322 290a  name="compass").
-00013be0: 2020 2020 7220 3d20 442e 6164 645f 7265      r = D.add_re
-00013bf0: 6628 7265 6374 616e 676c 6528 7369 7a65  f(rectangle(size
-00013c00: 2c20 6c61 7965 723d 6c61 7965 7229 290a  , layer=layer)).
-00013c10: 2020 2020 722e 6365 6e74 6572 203d 2028      r.center = (
-00013c20: 302c 2030 290a 0a20 2020 2064 7820 3d20  0, 0)..    dx = 
-00013c30: 7369 7a65 5b30 5d0a 2020 2020 6479 203d  size[0].    dy =
-00013c40: 2073 697a 655b 315d 0a20 2020 2044 2e61   size[1].    D.a
-00013c50: 6464 5f70 6f72 7428 6e61 6d65 3d22 4e22  dd_port(name="N"
-00013c60: 2c20 6d69 6470 6f69 6e74 3d5b 302c 2064  , midpoint=[0, d
-00013c70: 7920 2f20 325d 2c20 7769 6474 683d 6478  y / 2], width=dx
-00013c80: 2c20 6f72 6965 6e74 6174 696f 6e3d 3930  , orientation=90
-00013c90: 290a 2020 2020 442e 6164 645f 706f 7274  ).    D.add_port
-00013ca0: 286e 616d 653d 2253 222c 206d 6964 706f  (name="S", midpo
-00013cb0: 696e 743d 5b30 2c20 2d64 7920 2f20 325d  int=[0, -dy / 2]
-00013cc0: 2c20 7769 6474 683d 6478 2c20 6f72 6965  , width=dx, orie
-00013cd0: 6e74 6174 696f 6e3d 2d39 3029 0a20 2020  ntation=-90).   
-00013ce0: 2044 2e61 6464 5f70 6f72 7428 6e61 6d65   D.add_port(name
-00013cf0: 3d22 4522 2c20 6d69 6470 6f69 6e74 3d5b  ="E", midpoint=[
-00013d00: 6478 202f 2032 2c20 305d 2c20 7769 6474  dx / 2, 0], widt
-00013d10: 683d 6479 2c20 6f72 6965 6e74 6174 696f  h=dy, orientatio
-00013d20: 6e3d 3029 0a20 2020 2044 2e61 6464 5f70  n=0).    D.add_p
-00013d30: 6f72 7428 6e61 6d65 3d22 5722 2c20 6d69  ort(name="W", mi
-00013d40: 6470 6f69 6e74 3d5b 2d64 7820 2f20 322c  dpoint=[-dx / 2,
-00013d50: 2030 5d2c 2077 6964 7468 3d64 792c 206f   0], width=dy, o
-00013d60: 7269 656e 7461 7469 6f6e 3d31 3830 290a  rientation=180).
-00013d70: 0a20 2020 2072 6574 7572 6e20 440a 0a0a  .    return D...
-00013d80: 6465 6620 636f 6d70 6173 735f 6d75 6c74  def compass_mult
-00013d90: 6928 7369 7a65 3d28 342c 2032 292c 2070  i(size=(4, 2), p
-00013da0: 6f72 7473 3d7b 224e 223a 2033 2c20 2253  orts={"N": 3, "S
-00013db0: 223a 2034 7d2c 206c 6179 6572 3d30 293a  ": 4}, layer=0):
-00013dc0: 0a20 2020 2022 2222 4372 6561 7465 7320  .    """Creates 
-00013dd0: 6120 7265 6374 616e 6775 6c61 7220 636f  a rectangular co
-00013de0: 6e74 6163 7420 7061 6420 7769 7468 206d  ntact pad with m
-00013df0: 756c 7469 706c 6520 706f 7274 7320 616c  ultiple ports al
-00013e00: 6f6e 6720 7468 6520 6564 6765 730a 2020  ong the edges.  
-00013e10: 2020 7265 6374 616e 676c 6520 286e 6f72    rectangle (nor
-00013e20: 7468 2c20 736f 7574 682c 2065 6173 742c  th, south, east,
-00013e30: 2061 6e64 2077 6573 7429 2e0a 0a20 2020   and west)...   
-00013e40: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-00013e50: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2073  ----------.    s
-00013e60: 697a 6520 3a20 6172 7261 795f 6c69 6b65  ize : array_like
-00013e70: 0a20 2020 2020 2020 2044 696d 656e 7369  .        Dimensi
-00013e80: 6f6e 7320 6f66 2074 6865 2072 6563 7461  ons of the recta
-00013e90: 6e67 756c 6172 2063 6f6e 7461 6374 2070  ngular contact p
-00013ea0: 6164 2e0a 2020 2020 706f 7274 7320 3a20  ad..    ports : 
-00013eb0: 6469 6374 0a20 2020 2020 2020 204e 756d  dict.        Num
-00013ec0: 6265 7220 6f66 2070 6f72 7473 206f 6e20  ber of ports on 
-00013ed0: 6561 6368 2065 6467 6520 6f66 2074 6865  each edge of the
-00013ee0: 2072 6563 7461 6e67 6c65 2e0a 2020 2020   rectangle..    
-00013ef0: 6c61 7965 7220 3a20 696e 742c 2061 7272  layer : int, arr
-00013f00: 6179 2d6c 696b 655b 325d 2c20 6f72 2073  ay-like[2], or s
-00013f10: 6574 0a20 2020 2020 2020 2053 7065 6369  et.        Speci
-00013f20: 6669 6320 6c61 7965 7228 7329 2074 6f20  fic layer(s) to 
-00013f30: 7075 7420 706f 6c79 676f 6e20 6765 6f6d  put polygon geom
-00013f40: 6574 7279 206f 6e2e 0a0a 2020 2020 5265  etry on...    Re
-00013f50: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00013f60: 2d0a 2020 2020 4420 3a20 4465 7669 6365  -.    D : Device
-00013f70: 0a20 2020 2020 2020 2041 2044 6576 6963  .        A Devic
-00013f80: 6520 636f 6e74 6169 6e69 6e67 2061 2072  e containing a r
-00013f90: 6563 7461 6e67 756c 6172 2063 6f6e 7461  ectangular conta
-00013fa0: 6374 2070 6164 2077 6974 6820 6d75 6c74  ct pad with mult
-00013fb0: 6970 6c65 2070 6f72 7473 2e0a 2020 2020  iple ports..    
-00013fc0: 2222 220a 2020 2020 4420 3d20 4465 7669  """.    D = Devi
-00013fd0: 6365 286e 616d 653d 2263 6f6d 7061 7373  ce(name="compass
-00013fe0: 5f6d 756c 7469 2229 0a20 2020 2072 203d  _multi").    r =
-00013ff0: 2044 2e61 6464 5f72 6566 2872 6563 7461   D.add_ref(recta
-00014000: 6e67 6c65 2873 697a 652c 206c 6179 6572  ngle(size, layer
-00014010: 3d6c 6179 6572 2929 0a20 2020 2072 2e63  =layer)).    r.c
-00014020: 656e 7465 7220 3d20 2830 2c20 3029 0a0a  enter = (0, 0)..
-00014030: 2020 2020 6478 203d 2073 697a 655b 305d      dx = size[0]
-00014040: 202f 2032 0a20 2020 2064 7920 3d20 7369   / 2.    dy = si
-00014050: 7a65 5b31 5d20 2f20 320a 0a20 2020 2069  ze[1] / 2..    i
-00014060: 6620 224e 2220 696e 2070 6f72 7473 3a0a  f "N" in ports:.
-00014070: 2020 2020 2020 2020 6e75 6d5f 706f 7274          num_port
-00014080: 7320 3d20 706f 7274 735b 224e 225d 0a20  s = ports["N"]. 
-00014090: 2020 2020 2020 206d 203d 2064 7820 2d20         m = dx - 
-000140a0: 6478 202f 206e 756d 5f70 6f72 7473 0a20  dx / num_ports. 
-000140b0: 2020 2020 2020 2070 5f6c 6973 7420 3d20         p_list = 
-000140c0: 6e70 2e6c 696e 7370 6163 6528 2d6d 2c20  np.linspace(-m, 
-000140d0: 6d2c 206e 756d 5f70 6f72 7473 290a 2020  m, num_ports).  
-000140e0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-000140f0: 2020 2020 442e 6164 645f 706f 7274 280a      D.add_port(.
-00014100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014110: 6e61 6d65 3d28 224e 2573 2220 2520 286e  name=("N%s" % (n
-00014120: 202b 2031 2929 2c0a 2020 2020 2020 2020   + 1)),.        
-00014130: 2020 2020 2020 2020 6d69 6470 6f69 6e74          midpoint
-00014140: 3d5b 702c 2064 795d 2c0a 2020 2020 2020  =[p, dy],.      
-00014150: 2020 2020 2020 2020 2020 7769 6474 683d            width=
-00014160: 6478 202f 206e 756d 5f70 6f72 7473 202a  dx / num_ports *
-00014170: 2032 2c0a 2020 2020 2020 2020 2020 2020   2,.            
-00014180: 2020 2020 6f72 6965 6e74 6174 696f 6e3d      orientation=
-00014190: 3930 2c0a 2020 2020 2020 2020 2020 2020  90,.            
-000141a0: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
-000141b0: 7220 6e2c 2070 2069 6e20 656e 756d 6572  r n, p in enumer
-000141c0: 6174 6528 705f 6c69 7374 290a 2020 2020  ate(p_list).    
-000141d0: 2020 2020 5d0a 2020 2020 6966 2022 5322      ].    if "S"
-000141e0: 2069 6e20 706f 7274 733a 0a20 2020 2020   in ports:.     
-000141f0: 2020 206e 756d 5f70 6f72 7473 203d 2070     num_ports = p
-00014200: 6f72 7473 5b22 5322 5d0a 2020 2020 2020  orts["S"].      
-00014210: 2020 6d20 3d20 6478 202d 2064 7820 2f20    m = dx - dx / 
-00014220: 6e75 6d5f 706f 7274 730a 2020 2020 2020  num_ports.      
-00014230: 2020 705f 6c69 7374 203d 206e 702e 6c69    p_list = np.li
-00014240: 6e73 7061 6365 282d 6d2c 206d 2c20 6e75  nspace(-m, m, nu
-00014250: 6d5f 706f 7274 7329 0a20 2020 2020 2020  m_ports).       
-00014260: 205b 0a20 2020 2020 2020 2020 2020 2044   [.            D
-00014270: 2e61 6464 5f70 6f72 7428 0a20 2020 2020  .add_port(.     
-00014280: 2020 2020 2020 2020 2020 206e 616d 653d             name=
-00014290: 2822 5325 7322 2025 2028 6e20 2b20 3129  ("S%s" % (n + 1)
-000142a0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-000142b0: 2020 206d 6964 706f 696e 743d 5b70 2c20     midpoint=[p, 
-000142c0: 2d64 795d 2c0a 2020 2020 2020 2020 2020  -dy],.          
-000142d0: 2020 2020 2020 7769 6474 683d 6478 202f        width=dx /
-000142e0: 206e 756d 5f70 6f72 7473 202a 2032 2c0a   num_ports * 2,.
-000142f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014300: 6f72 6965 6e74 6174 696f 6e3d 2d39 302c  orientation=-90,
-00014310: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00014320: 2020 2020 2020 2020 2020 2066 6f72 206e             for n
-00014330: 2c20 7020 696e 2065 6e75 6d65 7261 7465  , p in enumerate
-00014340: 2870 5f6c 6973 7429 0a20 2020 2020 2020  (p_list).       
-00014350: 205d 0a20 2020 2069 6620 2245 2220 696e   ].    if "E" in
-00014360: 2070 6f72 7473 3a0a 2020 2020 2020 2020   ports:.        
-00014370: 6e75 6d5f 706f 7274 7320 3d20 706f 7274  num_ports = port
-00014380: 735b 2245 225d 0a20 2020 2020 2020 206d  s["E"].        m
-00014390: 203d 2064 7920 2d20 6479 202f 206e 756d   = dy - dy / num
-000143a0: 5f70 6f72 7473 0a20 2020 2020 2020 2070  _ports.        p
-000143b0: 5f6c 6973 7420 3d20 6e70 2e6c 696e 7370  _list = np.linsp
-000143c0: 6163 6528 2d6d 2c20 6d2c 206e 756d 5f70  ace(-m, m, num_p
-000143d0: 6f72 7473 290a 2020 2020 2020 2020 5b0a  orts).        [.
-000143e0: 2020 2020 2020 2020 2020 2020 442e 6164              D.ad
-000143f0: 645f 706f 7274 280a 2020 2020 2020 2020  d_port(.        
-00014400: 2020 2020 2020 2020 6e61 6d65 3d28 2245          name=("E
-00014410: 2573 2220 2520 286e 202b 2031 2929 2c0a  %s" % (n + 1)),.
-00014420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014430: 6d69 6470 6f69 6e74 3d5b 6478 2c20 705d  midpoint=[dx, p]
-00014440: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014450: 2020 7769 6474 683d 6479 202f 206e 756d    width=dy / num
-00014460: 5f70 6f72 7473 202a 2032 2c0a 2020 2020  _ports * 2,.    
-00014470: 2020 2020 2020 2020 2020 2020 6f72 6965              orie
-00014480: 6e74 6174 696f 6e3d 302c 0a20 2020 2020  ntation=0,.     
-00014490: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000144a0: 2020 2020 2066 6f72 206e 2c20 7020 696e       for n, p in
-000144b0: 2065 6e75 6d65 7261 7465 2870 5f6c 6973   enumerate(p_lis
-000144c0: 7429 0a20 2020 2020 2020 205d 0a20 2020  t).        ].   
-000144d0: 2069 6620 2257 2220 696e 2070 6f72 7473   if "W" in ports
-000144e0: 3a0a 2020 2020 2020 2020 6e75 6d5f 706f  :.        num_po
-000144f0: 7274 7320 3d20 706f 7274 735b 2257 225d  rts = ports["W"]
-00014500: 0a20 2020 2020 2020 206d 203d 2064 7920  .        m = dy 
-00014510: 2d20 6479 202f 206e 756d 5f70 6f72 7473  - dy / num_ports
-00014520: 0a20 2020 2020 2020 2070 5f6c 6973 7420  .        p_list 
-00014530: 3d20 6e70 2e6c 696e 7370 6163 6528 2d6d  = np.linspace(-m
-00014540: 2c20 6d2c 206e 756d 5f70 6f72 7473 290a  , m, num_ports).
-00014550: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00014560: 2020 2020 2020 442e 6164 645f 706f 7274        D.add_port
-00014570: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00014580: 2020 6e61 6d65 3d28 2257 2573 2220 2520    name=("W%s" % 
-00014590: 286e 202b 2031 2929 2c0a 2020 2020 2020  (n + 1)),.      
-000145a0: 2020 2020 2020 2020 2020 6d69 6470 6f69            midpoi
-000145b0: 6e74 3d5b 2d64 782c 2070 5d2c 0a20 2020  nt=[-dx, p],.   
-000145c0: 2020 2020 2020 2020 2020 2020 2077 6964               wid
-000145d0: 7468 3d64 7920 2f20 6e75 6d5f 706f 7274  th=dy / num_port
-000145e0: 7320 2a20 322c 0a20 2020 2020 2020 2020  s * 2,.         
-000145f0: 2020 2020 2020 206f 7269 656e 7461 7469         orientati
-00014600: 6f6e 3d31 3830 2c0a 2020 2020 2020 2020  on=180,.        
-00014610: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00014620: 2020 666f 7220 6e2c 2070 2069 6e20 656e    for n, p in en
-00014630: 756d 6572 6174 6528 705f 6c69 7374 290a  umerate(p_list).
-00014640: 2020 2020 2020 2020 5d0a 0a20 2020 2072          ]..    r
-00014650: 6574 7572 6e20 440a 0a0a 2320 544f 444f  eturn D...# TODO
-00014660: 3a20 4669 7820 7468 6520 6669 6c6c 6574  : Fix the fillet
-00014670: 2068 6572 652c 2072 6967 6874 206e 6f77   here, right now
-00014680: 206f 6e6c 7920 676f 6573 2068 616c 6677   only goes halfw
-00014690: 6179 2064 6f77 6e0a 6465 6620 666c 6167  ay down.def flag
-000146a0: 706f 6c65 2873 697a 653d 2834 2c20 3229  pole(size=(4, 2)
-000146b0: 2c20 7374 7562 5f73 697a 653d 2832 2c20  , stub_size=(2, 
-000146c0: 3129 2c20 7368 6170 653d 2270 222c 2074  1), shape="p", t
-000146d0: 6170 6572 5f74 7970 653d 2273 7472 6169  aper_type="strai
-000146e0: 6768 7422 2c20 6c61 7965 723d 3029 3a0a  ght", layer=0):.
-000146f0: 2020 2020 2222 2243 7265 6174 6573 2061      """Creates a
-00014700: 2066 6c61 6770 6f6c 6520 6765 6f6d 6574   flagpole geomet
-00014710: 7279 206f 6620 6f6e 6520 6f66 2066 6f75  ry of one of fou
-00014720: 7220 636f 6e66 6967 7572 6174 696f 6e73  r configurations
-00014730: 2c20 616c 6c0a 2020 2020 696e 766f 6c76  , all.    involv
-00014740: 696e 6720 6120 7665 7274 6963 616c 2063  ing a vertical c
-00014750: 656e 7472 616c 2063 6f6c 756d 6e20 616e  entral column an
-00014760: 6420 6120 6f75 7477 6172 642d 706f 696e  d a outward-poin
-00014770: 7469 6e67 2066 6c61 672e 0a0a 2020 2020  ting flag...    
-00014780: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-00014790: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7369  ---------.    si
-000147a0: 7a65 203a 2061 7272 6179 2d6c 696b 650a  ze : array-like.
-000147b0: 2020 2020 2020 2020 2877 6964 7468 2c20          (width, 
-000147c0: 6865 6967 6874 2920 6f66 2074 6865 2066  height) of the f
-000147d0: 6c61 672e 0a20 2020 2073 7475 625f 7369  lag..    stub_si
-000147e0: 7a65 203a 2061 7272 6179 2d6c 696b 650a  ze : array-like.
-000147f0: 2020 2020 2020 2020 2877 6964 7468 2c20          (width, 
-00014800: 6865 6967 6874 2920 6f66 2074 6865 2070  height) of the p
-00014810: 6f6c 6520 7374 7562 2e0a 2020 2020 7368  ole stub..    sh
-00014820: 6170 6520 3a20 7b27 7027 2c20 2771 272c  ape : {'p', 'q',
-00014830: 2027 6227 2c20 2764 277d 0a20 2020 2020   'b', 'd'}.     
-00014840: 2020 2043 6f6e 6669 6775 7261 7469 6f6e     Configuration
-00014850: 206f 6620 7468 6520 666c 6167 706f 6c65   of the flagpole
-00014860: 2c20 7768 6572 6520 7468 6520 6375 7276  , where the curv
-00014870: 6564 2070 6f72 7469 6f6e 206f 6620 7468  ed portion of th
-00014880: 650a 2020 2020 2020 2020 6c65 7474 6572  e.        letter
-00014890: 7320 7265 7072 6573 656e 7473 2074 6865  s represents the
-000148a0: 2066 6c61 6720 616e 6420 7468 6520 7374   flag and the st
-000148b0: 7261 6967 6874 2070 6f72 7469 6f6e 2074  raight portion t
-000148c0: 6865 2070 6f6c 652e 0a20 2020 2074 6170  he pole..    tap
-000148d0: 6572 5f74 7970 6520 3a20 7b27 7374 7261  er_type : {'stra
-000148e0: 6967 6874 272c 2027 6669 6c6c 6574 272c  ight', 'fillet',
-000148f0: 204e 6f6e 657d 0a20 2020 2020 2020 2054   None}.        T
-00014900: 7970 6520 6f66 2074 6170 6572 2062 6574  ype of taper bet
-00014910: 7765 656e 2074 6865 2062 6f74 746f 6d20  ween the bottom 
-00014920: 636f 726e 6572 206f 6620 7468 6520 7374  corner of the st
-00014930: 7562 206f 6e20 7468 6520 7369 6465 206f  ub on the side o
-00014940: 660a 2020 2020 2020 2020 7468 6520 666c  f.        the fl
-00014950: 6167 2061 6e64 2074 6865 2063 6f72 6e65  ag and the corne
-00014960: 7220 6f66 2074 6865 2066 6c61 6720 636c  r of the flag cl
-00014970: 6f73 6573 7420 746f 2074 6865 2073 7475  osest to the stu
-00014980: 622e 0a20 2020 206c 6179 6572 203a 2069  b..    layer : i
-00014990: 6e74 2c20 6172 7261 792d 6c69 6b65 5b32  nt, array-like[2
-000149a0: 5d2c 206f 7220 7365 740a 2020 2020 2020  ], or set.      
-000149b0: 2020 5370 6563 6966 6963 206c 6179 6572    Specific layer
-000149c0: 2873 2920 746f 2070 7574 2070 6f6c 7967  (s) to put polyg
-000149d0: 6f6e 2067 656f 6d65 7472 7920 6f6e 2e0a  on geometry on..
-000149e0: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
-000149f0: 202d 2d2d 2d2d 2d2d 0a20 2020 2044 203a   -------.    D :
-00014a00: 2044 6576 6963 650a 2020 2020 2020 2020   Device.        
-00014a10: 4120 4465 7669 6365 2063 6f6e 7461 696e  A Device contain
-00014a20: 696e 6720 6120 666c 6167 706f 6c65 2067  ing a flagpole g
-00014a30: 656f 6d65 7472 792e 0a20 2020 2022 2222  eometry..    """
-00014a40: 0a20 2020 2066 203d 206e 702e 6172 7261  .    f = np.arra
-00014a50: 7928 7369 7a65 290a 2020 2020 7020 3d20  y(size).    p = 
-00014a60: 6e70 2e61 7272 6179 2873 7475 625f 7369  np.array(stub_si
-00014a70: 7a65 290a 2020 2020 7368 6170 6520 3d20  ze).    shape = 
-00014a80: 7368 6170 652e 6c6f 7765 7228 290a 0a20  shape.lower().. 
-00014a90: 2020 2061 7373 6572 7420 7368 6170 6520     assert shape 
-00014aa0: 696e 2022 7071 6264 222c 2022 5b44 4556  in "pqbd", "[DEV
-00014ab0: 4943 455d 2020 666c 6167 706f 6c65 2829  ICE]  flagpole()
-00014ac0: 2073 6861 7065 206d 7573 7420 6265 2070   shape must be p
-00014ad0: 2c20 712c 2062 2c20 6f72 2064 220a 2020  , q, b, or d".  
-00014ae0: 2020 6173 7365 7274 2074 6170 6572 5f74    assert taper_t
-00014af0: 7970 6520 696e 205b 2273 7472 6169 6768  ype in ["straigh
-00014b00: 7422 2c20 2266 696c 6c65 7422 2c20 4e6f  t", "fillet", No
-00014b10: 6e65 5d2c 2028 0a20 2020 2020 2020 2027  ne], (.        '
-00014b20: 5b44 4556 4943 455d 2020 666c 6167 706f  [DEVICE]  flagpo
-00014b30: 6c65 2829 2074 6170 6572 5f74 7970 6520  le() taper_type 
-00014b40: 6d75 7374 2022 7374 7261 6967 6874 2220  must "straight" 
-00014b50: 2720 2720 6f72 2022 6669 6c6c 6574 2220  ' ' or "fillet" 
-00014b60: 6f72 204e 6f6e 6527 0a20 2020 2029 0a0a  or None'.    )..
-00014b70: 2020 2020 6966 2073 6861 7065 203d 3d20      if shape == 
-00014b80: 2270 223a 0a20 2020 2020 2020 206f 7269  "p":.        ori
-00014b90: 656e 7461 7469 6f6e 203d 202d 3930 0a20  entation = -90. 
-00014ba0: 2020 2065 6c69 6620 7368 6170 6520 3d3d     elif shape ==
-00014bb0: 2022 7122 3a0a 2020 2020 2020 2020 665b   "q":.        f[
-00014bc0: 305d 2c20 705b 305d 203d 202d 7369 7a65  0], p[0] = -size
-00014bd0: 5b30 5d2c 202d 7374 7562 5f73 697a 655b  [0], -stub_size[
-00014be0: 305d 0a20 2020 2020 2020 206f 7269 656e  0].        orien
-00014bf0: 7461 7469 6f6e 203d 202d 3930 0a20 2020  tation = -90.   
-00014c00: 2065 6c69 6620 7368 6170 6520 3d3d 2022   elif shape == "
-00014c10: 6222 3a0a 2020 2020 2020 2020 665b 315d  b":.        f[1]
-00014c20: 2c20 705b 315d 203d 202d 7369 7a65 5b31  , p[1] = -size[1
-00014c30: 5d2c 202d 7374 7562 5f73 697a 655b 315d  ], -stub_size[1]
-00014c40: 0a20 2020 2020 2020 206f 7269 656e 7461  .        orienta
-00014c50: 7469 6f6e 203d 2039 300a 2020 2020 656c  tion = 90.    el
-00014c60: 6966 2073 6861 7065 203d 3d20 2264 223a  if shape == "d":
-00014c70: 0a20 2020 2020 2020 2066 5b31 5d2c 2070  .        f[1], p
-00014c80: 5b31 5d20 3d20 2d73 697a 655b 315d 2c20  [1] = -size[1], 
-00014c90: 2d73 7475 625f 7369 7a65 5b31 5d0a 2020  -stub_size[1].  
-00014ca0: 2020 2020 2020 665b 305d 2c20 705b 305d        f[0], p[0]
-00014cb0: 203d 202d 7369 7a65 5b30 5d2c 202d 7374   = -size[0], -st
-00014cc0: 7562 5f73 697a 655b 305d 0a20 2020 2020  ub_size[0].     
-00014cd0: 2020 206f 7269 656e 7461 7469 6f6e 203d     orientation =
-00014ce0: 2039 300a 2020 2020 7870 7473 203d 205b   90.    xpts = [
-00014cf0: 302c 2030 2c20 665b 305d 2c20 665b 305d  0, 0, f[0], f[0]
-00014d00: 2c20 705b 305d 2c20 705b 305d 2c20 305d  , p[0], p[0], 0]
-00014d10: 0a20 2020 2079 7074 7320 3d20 5b30 2c20  .    ypts = [0, 
-00014d20: 665b 315d 2c20 665b 315d 2c20 302c 2030  f[1], f[1], 0, 0
-00014d30: 2c20 2d70 5b31 5d2c 202d 705b 315d 5d0a  , -p[1], -p[1]].
-00014d40: 0a20 2020 2044 203d 2044 6576 6963 6528  .    D = Device(
-00014d50: 6e61 6d65 3d22 666c 6167 706f 6c65 2229  name="flagpole")
-00014d60: 0a20 2020 2070 6164 5f70 6f6c 7920 3d20  .    pad_poly = 
-00014d70: 442e 6164 645f 706f 6c79 676f 6e28 5b78  D.add_polygon([x
-00014d80: 7074 732c 2079 7074 735d 2c20 6c61 7965  pts, ypts], laye
-00014d90: 723d 6c61 7965 7229 0a20 2020 2069 6620  r=layer).    if 
-00014da0: 7461 7065 725f 7479 7065 203d 3d20 2266  taper_type == "f
-00014db0: 696c 6c65 7422 3a0a 2020 2020 2020 2020  illet":.        
-00014dc0: 7461 7065 725f 616d 6f75 6e74 203d 206d  taper_amount = m
-00014dd0: 696e 285b 6162 7328 665b 305d 202d 2070  in([abs(f[0] - p
-00014de0: 5b30 5d29 2c20 6162 7328 705b 315d 295d  [0]), abs(p[1])]
-00014df0: 290a 2020 2020 2020 2020 7061 645f 706f  ).        pad_po
-00014e00: 6c79 2e66 696c 6c65 7428 5b30 2c20 302c  ly.fillet([0, 0,
-00014e10: 2030 2c20 302c 2074 6170 6572 5f61 6d6f   0, 0, taper_amo
-00014e20: 756e 742c 2030 2c20 305d 290a 2020 2020  unt, 0, 0]).    
-00014e30: 656c 6966 2074 6170 6572 5f74 7970 6520  elif taper_type 
-00014e40: 3d3d 2022 7374 7261 6967 6874 223a 0a20  == "straight":. 
-00014e50: 2020 2020 2020 2044 2e61 6464 5f70 6f6c         D.add_pol
-00014e60: 7967 6f6e 285b 7870 7473 5b33 3a36 5d2c  ygon([xpts[3:6],
-00014e70: 2079 7074 735b 333a 365d 5d2c 206c 6179   ypts[3:6]], lay
-00014e80: 6572 3d6c 6179 6572 290a 0a20 2020 2044  er=layer)..    D
-00014e90: 2e61 6464 5f70 6f72 7428 0a20 2020 2020  .add_port(.     
-00014ea0: 2020 206e 616d 653d 312c 206d 6964 706f     name=1, midpo
-00014eb0: 696e 743d 5b70 5b30 5d20 2f20 322c 202d  int=[p[0] / 2, -
-00014ec0: 705b 315d 5d2c 2077 6964 7468 3d61 6273  p[1]], width=abs
-00014ed0: 2870 5b30 5d29 2c20 6f72 6965 6e74 6174  (p[0]), orientat
-00014ee0: 696f 6e3d 6f72 6965 6e74 6174 696f 6e0a  ion=orientation.
-00014ef0: 2020 2020 290a 2020 2020 442e 6164 645f      ).    D.add_
-00014f00: 706f 7274 280a 2020 2020 2020 2020 6e61  port(.        na
-00014f10: 6d65 3d32 2c0a 2020 2020 2020 2020 6d69  me=2,.        mi
-00014f20: 6470 6f69 6e74 3d5b 665b 305d 202f 2032  dpoint=[f[0] / 2
-00014f30: 2c20 665b 315d 5d2c 0a20 2020 2020 2020  , f[1]],.       
-00014f40: 2077 6964 7468 3d61 6273 2866 5b30 5d29   width=abs(f[0])
-00014f50: 2c0a 2020 2020 2020 2020 6f72 6965 6e74  ,.        orient
-00014f60: 6174 696f 6e3d 6f72 6965 6e74 6174 696f  ation=orientatio
-00014f70: 6e20 2d20 3138 302c 0a20 2020 2029 0a20  n - 180,.    ). 
-00014f80: 2020 2072 6574 7572 6e20 440a 0a0a 6465     return D...de
-00014f90: 6620 7465 6528 7369 7a65 3d28 342c 2032  f tee(size=(4, 2
-00014fa0: 292c 2073 7475 625f 7369 7a65 3d28 322c  ), stub_size=(2,
-00014fb0: 2031 292c 2074 6170 6572 5f74 7970 653d   1), taper_type=
-00014fc0: 4e6f 6e65 2c20 6c61 7965 723d 3029 3a0a  None, layer=0):.
-00014fd0: 2020 2020 2222 2243 7265 6174 6573 2061      """Creates a
-00014fe0: 2054 2d73 6861 7065 6420 6765 6f6d 6574   T-shaped geomet
-00014ff0: 7279 2e0a 0a20 2020 2050 6172 616d 6574  ry...    Paramet
-00015000: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-00015010: 2d2d 0a20 2020 2073 697a 6520 3a20 6172  --.    size : ar
-00015020: 7261 792d 6c69 6b65 0a20 2020 2020 2020  ray-like.       
-00015030: 2028 7769 6474 682c 2068 6569 6768 7429   (width, height)
-00015040: 206f 6620 7468 6520 686f 7269 7a6f 6e74   of the horizont
-00015050: 616c 2074 6f70 2070 6172 7420 6f66 2074  al top part of t
-00015060: 6865 2054 2073 6861 7065 2e0a 2020 2020  he T shape..    
-00015070: 7374 7562 5f73 697a 6520 3a20 6172 7261  stub_size : arra
-00015080: 792d 6c69 6b65 0a20 2020 2020 2020 2028  y-like.        (
-00015090: 7769 6474 682c 2068 6569 6768 7429 206f  width, height) o
-000150a0: 6620 7468 6520 7665 7274 6963 616c 2073  f the vertical s
-000150b0: 7475 6220 7061 7274 206f 6620 7468 6520  tub part of the 
-000150c0: 5420 7368 6170 652e 0a20 2020 2074 6170  T shape..    tap
-000150d0: 6572 5f74 7970 6520 3a20 7b27 7374 7261  er_type : {'stra
-000150e0: 6967 6874 272c 2027 6669 6c6c 6574 272c  ight', 'fillet',
-000150f0: 204e 6f6e 657d 0a20 2020 2020 2020 2049   None}.        I
-00015100: 6620 7370 6563 6966 6965 642c 2074 6865  f specified, the
-00015110: 2074 7970 6520 6f66 2074 6170 6572 2062   type of taper b
-00015120: 6574 7765 656e 2074 6865 2062 6f74 746f  etween the botto
-00015130: 6d20 636f 726e 6572 7320 6f66 2074 6865  m corners of the
-00015140: 2073 7475 620a 2020 2020 2020 2020 616e   stub.        an
-00015150: 6420 7468 6520 626f 7474 6f6d 2063 6f72  d the bottom cor
-00015160: 6e65 7273 206f 6620 7468 6520 5420 7368  ners of the T sh
-00015170: 6170 652e 0a20 2020 206c 6179 6572 203a  ape..    layer :
-00015180: 2069 6e74 2c20 6172 7261 792d 6c69 6b65   int, array-like
-00015190: 5b32 5d2c 206f 7220 7365 740a 2020 2020  [2], or set.    
-000151a0: 2020 2020 5370 6563 6966 6963 206c 6179      Specific lay
-000151b0: 6572 2873 2920 746f 2070 7574 2070 6f6c  er(s) to put pol
-000151c0: 7967 6f6e 2067 656f 6d65 7472 7920 6f6e  ygon geometry on
-000151d0: 2e0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
-000151e0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2044     -------.    D
-000151f0: 203a 2044 6576 6963 650a 2020 2020 2020   : Device.      
-00015200: 2020 4120 4465 7669 6365 2063 6f6e 7461    A Device conta
-00015210: 696e 696e 6720 6120 542d 7368 6170 6564  ining a T-shaped
-00015220: 2067 656f 6d65 7472 792e 0a20 2020 2022   geometry..    "
-00015230: 2222 0a20 2020 2066 203d 206e 702e 6172  "".    f = np.ar
-00015240: 7261 7928 7369 7a65 290a 2020 2020 7020  ray(size).    p 
-00015250: 3d20 6e70 2e61 7272 6179 2873 7475 625f  = np.array(stub_
-00015260: 7369 7a65 290a 0a20 2020 2078 7074 7320  size)..    xpts 
-00015270: 3d20 6e70 2e61 7272 6179 285b 665b 305d  = np.array([f[0]
-00015280: 2c20 665b 305d 2c20 705b 305d 2c20 705b  , f[0], p[0], p[
-00015290: 305d 2c20 2d70 5b30 5d2c 202d 705b 305d  0], -p[0], -p[0]
-000152a0: 2c20 2d66 5b30 5d2c 202d 665b 305d 5d29  , -f[0], -f[0]])
-000152b0: 202f 2032 0a20 2020 2079 7074 7320 3d20   / 2.    ypts = 
-000152c0: 5b66 5b31 5d2c 2030 2c20 302c 202d 705b  [f[1], 0, 0, -p[
-000152d0: 315d 2c20 2d70 5b31 5d2c 2030 2c20 302c  1], -p[1], 0, 0,
-000152e0: 2066 5b31 5d5d 0a0a 2020 2020 4420 3d20   f[1]]..    D = 
-000152f0: 4465 7669 6365 286e 616d 653d 2274 6565  Device(name="tee
-00015300: 2229 0a20 2020 2070 6164 5f70 6f6c 7920  ").    pad_poly 
-00015310: 3d20 442e 6164 645f 706f 6c79 676f 6e28  = D.add_polygon(
-00015320: 5b78 7074 732c 2079 7074 735d 2c20 6c61  [xpts, ypts], la
-00015330: 7965 723d 6c61 7965 7229 0a20 2020 2069  yer=layer).    i
-00015340: 6620 7461 7065 725f 7479 7065 203d 3d20  f taper_type == 
-00015350: 2266 696c 6c65 7422 3a0a 2020 2020 2020  "fillet":.      
-00015360: 2020 7461 7065 725f 616d 6f75 6e74 203d    taper_amount =
-00015370: 206d 696e 285b 6162 7328 665b 305d 202d   min([abs(f[0] -
-00015380: 2070 5b30 5d29 2c20 6162 7328 705b 315d   p[0]), abs(p[1]
-00015390: 295d 290a 2020 2020 2020 2020 7061 645f  )]).        pad_
-000153a0: 706f 6c79 2e66 696c 6c65 7428 5b30 2c20  poly.fillet([0, 
-000153b0: 302c 2074 6170 6572 5f61 6d6f 756e 742c  0, taper_amount,
-000153c0: 2030 2c20 302c 2074 6170 6572 5f61 6d6f   0, 0, taper_amo
-000153d0: 756e 742c 2030 2c20 305d 290a 2020 2020  unt, 0, 0]).    
-000153e0: 656c 6966 2074 6170 6572 5f74 7970 6520  elif taper_type 
-000153f0: 3d3d 2022 7374 7261 6967 6874 223a 0a20  == "straight":. 
-00015400: 2020 2020 2020 2044 2e61 6464 5f70 6f6c         D.add_pol
-00015410: 7967 6f6e 285b 7870 7473 5b31 3a34 5d2c  ygon([xpts[1:4],
-00015420: 2079 7074 735b 313a 345d 5d2c 206c 6179   ypts[1:4]], lay
-00015430: 6572 3d6c 6179 6572 2920 2023 2074 6170  er=layer)  # tap
-00015440: 6572 5f70 6f6c 7931 0a20 2020 2020 2020  er_poly1.       
-00015450: 2044 2e61 6464 5f70 6f6c 7967 6f6e 285b   D.add_polygon([
-00015460: 7870 7473 5b34 3a37 5d2c 2079 7074 735b  xpts[4:7], ypts[
-00015470: 343a 375d 5d2c 206c 6179 6572 3d6c 6179  4:7]], layer=lay
-00015480: 6572 2920 2023 2074 6170 6572 5f70 6f6c  er)  # taper_pol
-00015490: 7932 0a0a 2020 2020 442e 6164 645f 706f  y2..    D.add_po
-000154a0: 7274 286e 616d 653d 312c 206d 6964 706f  rt(name=1, midpo
-000154b0: 696e 743d 5b66 5b30 5d20 2f20 322c 2066  int=[f[0] / 2, f
-000154c0: 5b31 5d20 2f20 325d 2c20 7769 6474 683d  [1] / 2], width=
-000154d0: 665b 315d 2c20 6f72 6965 6e74 6174 696f  f[1], orientatio
-000154e0: 6e3d 3029 0a20 2020 2044 2e61 6464 5f70  n=0).    D.add_p
-000154f0: 6f72 7428 6e61 6d65 3d32 2c20 6d69 6470  ort(name=2, midp
-00015500: 6f69 6e74 3d5b 2d66 5b30 5d20 2f20 322c  oint=[-f[0] / 2,
-00015510: 2066 5b31 5d20 2f20 325d 2c20 7769 6474   f[1] / 2], widt
-00015520: 683d 665b 315d 2c20 6f72 6965 6e74 6174  h=f[1], orientat
-00015530: 696f 6e3d 3138 3029 0a20 2020 2044 2e61  ion=180).    D.a
-00015540: 6464 5f70 6f72 7428 6e61 6d65 3d33 2c20  dd_port(name=3, 
-00015550: 6d69 6470 6f69 6e74 3d5b 302c 202d 705b  midpoint=[0, -p[
-00015560: 315d 5d2c 2077 6964 7468 3d70 5b30 5d2c  1]], width=p[0],
-00015570: 206f 7269 656e 7461 7469 6f6e 3d2d 3930   orientation=-90
-00015580: 290a 2020 2020 7265 7475 726e 2044 0a0a  ).    return D..
-00015590: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
-000155a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000155b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000155c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000155d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000155e0: 3d0a 2320 4578 616d 706c 6520 636f 6465  =.# Example code
-000155f0: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
-00015600: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00015610: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00015620: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00015630: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00015640: 3d0a 0a23 2063 7020 3d20 636f 6d70 6173  =..# cp = compas
-00015650: 7328 7369 7a65 203d 205b 342c 325d 290a  s(size = [4,2]).
-00015660: 2320 7175 6963 6b70 6c6f 7428 6370 290a  # quickplot(cp).
-00015670: 0a0a 2320 6370 6d20 3d20 636f 6d70 6173  ..# cpm = compas
-00015680: 735f 6d75 6c74 6928 7369 7a65 203d 205b  s_multi(size = [
-00015690: 3430 2c32 305d 2c20 706f 7274 7320 3d20  40,20], ports = 
-000156a0: 7b27 4e27 3a33 2c27 5327 3a34 2c20 2745  {'N':3,'S':4, 'E
-000156b0: 273a 312c 2027 5727 3a38 7d2c 206c 6179  ':1, 'W':8}, lay
-000156c0: 6572 203d 2030 290a 2320 7175 6963 6b70  er = 0).# quickp
-000156d0: 6c6f 7428 6370 6d29 0a0a 0a23 2063 706d  lot(cpm)...# cpm
-000156e0: 203d 2063 6f6d 7061 7373 5f6d 756c 7469   = compass_multi
-000156f0: 2873 697a 6520 3d20 5b34 302c 3230 5d2c  (size = [40,20],
-00015700: 2070 6f72 7473 203d 207b 274e 273a 332c   ports = {'N':3,
-00015710: 2753 273a 342c 2027 4527 3a31 2c20 2757  'S':4, 'E':1, 'W
-00015720: 273a 387d 2c20 6c61 7965 7220 3d20 3029  ':8}, layer = 0)
-00015730: 0a23 2069 6e73 6574 5f70 6f6c 7967 6f6e  .# inset_polygon
-00015740: 203d 206f 6666 7365 7428 6370 6d2c 2064   = offset(cpm, d
-00015750: 6973 7461 6e63 6520 3d20 2d32 2c20 6c61  istance = -2, la
-00015760: 7965 7220 3d20 3129 0a23 2063 706d 2e61  yer = 1).# cpm.a
-00015770: 6464 5f70 6f6c 7967 6f6e 2869 6e73 6574  dd_polygon(inset
-00015780: 5f70 6f6c 7967 6f6e 290a 2320 7175 6963  _polygon).# quic
-00015790: 6b70 6c6f 7428 6370 6d29 0a0a 2320 6670  kplot(cpm)..# fp
-000157a0: 203d 2066 6c61 6770 6f6c 6528 7369 7a65   = flagpole(size
-000157b0: 203d 205b 342c 325d 2c20 7374 7562 5f73   = [4,2], stub_s
-000157c0: 697a 6520 3d20 5b32 2c31 5d2c 2073 6861  ize = [2,1], sha
-000157d0: 7065 203d 2027 7027 2c20 7461 7065 725f  pe = 'p', taper_
-000157e0: 7479 7065 203d 2027 7374 7261 6967 6874  type = 'straight
-000157f0: 272c 206c 6179 6572 203d 2030 290a 2320  ', layer = 0).# 
-00015800: 7175 6963 6b70 6c6f 7428 6670 290a 0a0a  quickplot(fp)...
-00015810: 2320 7470 203d 2074 6565 2873 697a 6520  # tp = tee(size 
-00015820: 3d20 5b34 2c32 5d2c 2073 7475 625f 7369  = [4,2], stub_si
-00015830: 7a65 203d 205b 322c 315d 2c20 7461 7065  ze = [2,1], tape
-00015840: 725f 7479 7065 203d 2027 6669 6c6c 6574  r_type = 'fillet
-00015850: 272c 206c 6179 6572 203d 2030 290a 2320  ', layer = 0).# 
-00015860: 7175 6963 6b70 6c6f 7428 7470 290a 0a0a  quickplot(tp)...
-00015870: 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  # ==============
-00015880: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00015890: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000158a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000158b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000158c0: 0a23 0a23 2054 6170 6572 730a 230a 2320  .#.# Tapers.#.# 
-000158d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000158e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000158f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00015900: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00015910: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a  ==============..
-00015920: 0a64 6566 2074 6170 6572 286c 656e 6774  .def taper(lengt
-00015930: 683d 3130 2c20 7769 6474 6831 3d35 2c20  h=10, width1=5, 
-00015940: 7769 6474 6832 3d4e 6f6e 652c 2070 6f72  width2=None, por
-00015950: 743d 4e6f 6e65 2c20 6c61 7965 723d 3029  t=None, layer=0)
-00015960: 3a0a 2020 2020 2222 2243 7265 6174 6573  :.    """Creates
-00015970: 2061 2074 6170 6572 6564 2074 7261 7065   a tapered trape
-00015980: 7a6f 6964 2f72 6563 7461 6e67 6c65 2067  zoid/rectangle g
-00015990: 656f 6d65 7472 792e 0a0a 2020 2020 5061  eometry...    Pa
-000159a0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-000159b0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6c65 6e67  -------.    leng
-000159c0: 7468 203a 2069 6e74 206f 7220 666c 6f61  th : int or floa
-000159d0: 740a 2020 2020 2020 2020 4c65 6e67 7468  t.        Length
-000159e0: 206f 6620 7468 6520 7368 6170 652e 0a20   of the shape.. 
-000159f0: 2020 2077 6964 7468 3120 3a20 696e 742c     width1 : int,
-00015a00: 2066 6c6f 6174 2c20 6f72 204e 6f6e 650a   float, or None.
-00015a10: 2020 2020 2020 2020 5769 6474 6820 6f66          Width of
-00015a20: 2065 6e64 2031 206f 6620 7468 6520 7461   end 1 of the ta
-00015a30: 7065 7220 7365 6374 696f 6e20 2877 6964  per section (wid
-00015a40: 7468 2069 7320 6571 7561 6c20 746f 2074  th is equal to t
-00015a50: 6865 2070 6f72 7420 7769 6474 680a 2020  he port width.  
-00015a60: 2020 2020 2020 6966 2050 6f72 7420 6973        if Port is
-00015a70: 206e 6f74 204e 6f6e 6520 616e 6420 7769   not None and wi
-00015a80: 6474 6831 2069 7320 4e6f 6e65 292e 0a20  dth1 is None).. 
-00015a90: 2020 2077 6964 7468 3220 3a20 696e 742c     width2 : int,
-00015aa0: 2066 6c6f 6174 2c20 6f72 204e 6f6e 650a   float, or None.
-00015ab0: 2020 2020 2020 2020 5769 6474 6820 6f66          Width of
-00015ac0: 2065 6e64 2032 206f 6620 7468 6520 7461   end 2 of the ta
-00015ad0: 7065 7220 7365 6374 696f 6e20 2877 6964  per section (wid
-00015ae0: 7468 2069 7320 6571 7561 6c20 746f 2074  th is equal to t
-00015af0: 6865 2070 6f72 7420 7769 6474 680a 2020  he port width.  
-00015b00: 2020 2020 2020 6966 2050 6f72 7420 6973        if Port is
-00015b10: 206e 6f74 204e 6f6e 6520 616e 6420 7769   not None and wi
-00015b20: 6474 6832 2069 7320 4e6f 6e65 292e 0a20  dth2 is None).. 
-00015b30: 2020 2070 6f72 7420 3a20 506f 7274 206f     port : Port o
-00015b40: 7220 4e6f 6e65 0a20 2020 2020 2020 2050  r None.        P
-00015b50: 6f72 7420 7769 7468 2077 6869 6368 2074  ort with which t
-00015b60: 6f20 6d61 7463 6820 7468 6520 7769 6474  o match the widt
-00015b70: 6820 6f66 2074 6865 2074 6170 6572 2065  h of the taper e
-00015b80: 6e64 732e 0a20 2020 206c 6179 6572 203a  nds..    layer :
-00015b90: 2069 6e74 2c20 6172 7261 792d 6c69 6b65   int, array-like
-00015ba0: 5b32 5d2c 206f 7220 7365 740a 2020 2020  [2], or set.    
-00015bb0: 2020 2020 5370 6563 6966 6963 206c 6179      Specific lay
-00015bc0: 6572 2873 2920 746f 2070 7574 2070 6f6c  er(s) to put pol
-00015bd0: 7967 6f6e 2067 656f 6d65 7472 7920 6f6e  ygon geometry on
-00015be0: 2e0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
-00015bf0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2044     -------.    D
-00015c00: 3a20 4465 7669 6365 0a20 2020 2020 2020  : Device.       
-00015c10: 2041 2044 6576 6963 6520 636f 6e74 6169   A Device contai
-00015c20: 6e69 6e67 2061 2074 6170 6572 2067 656f  ning a taper geo
-00015c30: 6d65 7472 792e 0a20 2020 2022 2222 0a20  metry..    """. 
-00015c40: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00015c50: 2870 6f72 742c 2050 6f72 7429 2061 6e64  (port, Port) and
-00015c60: 2077 6964 7468 3120 6973 204e 6f6e 653a   width1 is None:
-00015c70: 0a20 2020 2020 2020 2077 6964 7468 3120  .        width1 
-00015c80: 3d20 706f 7274 2e77 6964 7468 0a20 2020  = port.width.   
-00015c90: 2069 6620 7769 6474 6832 2069 7320 4e6f   if width2 is No
-00015ca0: 6e65 3a0a 2020 2020 2020 2020 7769 6474  ne:.        widt
-00015cb0: 6832 203d 2077 6964 7468 310a 2020 2020  h2 = width1.    
-00015cc0: 7870 7473 203d 205b 302c 206c 656e 6774  xpts = [0, lengt
-00015cd0: 682c 206c 656e 6774 682c 2030 5d0a 2020  h, length, 0].  
-00015ce0: 2020 7970 7473 203d 205b 7769 6474 6831    ypts = [width1
-00015cf0: 202f 2032 2c20 7769 6474 6832 202f 2032   / 2, width2 / 2
-00015d00: 2c20 2d77 6964 7468 3220 2f20 322c 202d  , -width2 / 2, -
-00015d10: 7769 6474 6831 202f 2032 5d0a 0a20 2020  width1 / 2]..   
-00015d20: 2044 203d 2044 6576 6963 6528 2274 6170   D = Device("tap
-00015d30: 6572 2229 0a20 2020 2044 2e61 6464 5f70  er").    D.add_p
-00015d40: 6f6c 7967 6f6e 285b 7870 7473 2c20 7970  olygon([xpts, yp
-00015d50: 7473 5d2c 206c 6179 6572 3d6c 6179 6572  ts], layer=layer
-00015d60: 290a 2020 2020 442e 6164 645f 706f 7274  ).    D.add_port
-00015d70: 286e 616d 653d 312c 206d 6964 706f 696e  (name=1, midpoin
-00015d80: 743d 5b30 2c20 305d 2c20 7769 6474 683d  t=[0, 0], width=
-00015d90: 7769 6474 6831 2c20 6f72 6965 6e74 6174  width1, orientat
-00015da0: 696f 6e3d 3138 3029 0a20 2020 2044 2e61  ion=180).    D.a
-00015db0: 6464 5f70 6f72 7428 6e61 6d65 3d32 2c20  dd_port(name=2, 
-00015dc0: 6d69 6470 6f69 6e74 3d5b 6c65 6e67 7468  midpoint=[length
-00015dd0: 2c20 305d 2c20 7769 6474 683d 7769 6474  , 0], width=widt
-00015de0: 6832 2c20 6f72 6965 6e74 6174 696f 6e3d  h2, orientation=
-00015df0: 3029 0a20 2020 2069 6620 6973 696e 7374  0).    if isinst
-00015e00: 616e 6365 2870 6f72 742c 2050 6f72 7429  ance(port, Port)
-00015e10: 3a0a 2020 2020 2020 2020 442e 726f 7461  :.        D.rota
-00015e20: 7465 2861 6e67 6c65 3d70 6f72 742e 6f72  te(angle=port.or
-00015e30: 6965 6e74 6174 696f 6e2c 2063 656e 7465  ientation, cente
-00015e40: 723d 5b30 2c20 305d 290a 2020 2020 2020  r=[0, 0]).      
-00015e50: 2020 442e 6d6f 7665 286f 7269 6769 6e3d    D.move(origin=
-00015e60: 5b30 2c20 305d 2c20 6465 7374 696e 6174  [0, 0], destinat
-00015e70: 696f 6e3d 706f 7274 2e6d 6964 706f 696e  ion=port.midpoin
-00015e80: 7429 0a20 2020 2072 6574 7572 6e20 440a  t).    return D.
-00015e90: 0a0a 6465 6620 7261 6d70 286c 656e 6774  ..def ramp(lengt
-00015ea0: 683d 3130 2c20 7769 6474 6831 3d35 2c20  h=10, width1=5, 
-00015eb0: 7769 6474 6832 3d38 2c20 6c61 7965 723d  width2=8, layer=
-00015ec0: 3029 3a0a 2020 2020 2222 2243 7265 6174  0):.    """Creat
-00015ed0: 6573 2061 2072 616d 7020 6765 6f6d 6574  es a ramp geomet
-00015ee0: 7279 2e0a 0a20 2020 2050 6172 616d 6574  ry...    Paramet
-00015ef0: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-00015f00: 2d2d 0a20 2020 206c 656e 6774 6820 3a20  --.    length : 
-00015f10: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
-00015f20: 2020 2020 204c 656e 6774 6820 6f66 2074       Length of t
-00015f30: 6865 2072 616d 7020 7365 6374 696f 6e2e  he ramp section.
-00015f40: 0a20 2020 2077 6964 7468 3120 3a20 696e  .    width1 : in
-00015f50: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
-00015f60: 2020 2057 6964 7468 206f 6620 7468 6520     Width of the 
-00015f70: 7374 6172 7420 6f66 2074 6865 2072 616d  start of the ram
-00015f80: 7020 7365 6374 696f 6e2e 0a20 2020 2077  p section..    w
-00015f90: 6964 7468 3220 3a20 696e 742c 2066 6c6f  idth2 : int, flo
-00015fa0: 6174 2c20 6f72 204e 6f6e 650a 2020 2020  at, or None.    
-00015fb0: 2020 2020 5769 6474 6820 6f66 2074 6865      Width of the
-00015fc0: 2065 6e64 206f 6620 7468 6520 7261 6d70   end of the ramp
-00015fd0: 2073 6563 7469 6f6e 2028 6966 2077 6964   section (if wid
-00015fe0: 7468 3220 6973 204e 6f6e 652c 2077 6964  th2 is None, wid
-00015ff0: 7468 320a 2020 2020 2020 2020 6265 636f  th2.        beco
-00016000: 6d65 7320 7468 6520 7361 6d65 2061 7320  mes the same as 
-00016010: 7769 6474 6831 292e 0a20 2020 206c 6179  width1)..    lay
-00016020: 6572 203a 2069 6e74 2c20 6172 7261 792d  er : int, array-
-00016030: 6c69 6b65 5b32 5d2c 206f 7220 7365 740a  like[2], or set.
-00016040: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
-00016050: 206c 6179 6572 2873 2920 746f 2070 7574   layer(s) to put
-00016060: 2070 6f6c 7967 6f6e 2067 656f 6d65 7472   polygon geometr
-00016070: 7920 6f6e 2e0a 0a20 2020 2052 6574 7572  y on...    Retur
-00016080: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-00016090: 2020 2044 203a 2044 6576 6963 650a 2020     D : Device.  
-000160a0: 2020 2020 2020 4120 4465 7669 6365 2063        A Device c
-000160b0: 6f6e 7461 696e 696e 6720 6120 7261 6d70  ontaining a ramp
-000160c0: 2067 656f 6d65 7472 792e 0a20 2020 2022   geometry..    "
-000160d0: 2222 0a20 2020 2069 6620 7769 6474 6832  "".    if width2
-000160e0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-000160f0: 2020 7769 6474 6832 203d 2077 6964 7468    width2 = width
-00016100: 310a 2020 2020 7870 7473 203d 205b 302c  1.    xpts = [0,
-00016110: 206c 656e 6774 682c 206c 656e 6774 682c   length, length,
-00016120: 2030 5d0a 2020 2020 7970 7473 203d 205b   0].    ypts = [
-00016130: 7769 6474 6831 2c20 7769 6474 6832 2c20  width1, width2, 
-00016140: 302c 2030 5d0a 2020 2020 4420 3d20 4465  0, 0].    D = De
-00016150: 7669 6365 2822 7261 6d70 2229 0a20 2020  vice("ramp").   
-00016160: 2044 2e61 6464 5f70 6f6c 7967 6f6e 285b   D.add_polygon([
-00016170: 7870 7473 2c20 7970 7473 5d2c 206c 6179  xpts, ypts], lay
-00016180: 6572 3d6c 6179 6572 290a 2020 2020 442e  er=layer).    D.
-00016190: 6164 645f 706f 7274 286e 616d 653d 312c  add_port(name=1,
-000161a0: 206d 6964 706f 696e 743d 5b30 2c20 7769   midpoint=[0, wi
-000161b0: 6474 6831 202f 2032 5d2c 2077 6964 7468  dth1 / 2], width
-000161c0: 3d77 6964 7468 312c 206f 7269 656e 7461  =width1, orienta
-000161d0: 7469 6f6e 3d31 3830 290a 2020 2020 442e  tion=180).    D.
-000161e0: 6164 645f 706f 7274 286e 616d 653d 322c  add_port(name=2,
-000161f0: 206d 6964 706f 696e 743d 5b6c 656e 6774   midpoint=[lengt
-00016200: 682c 2077 6964 7468 3220 2f20 325d 2c20  h, width2 / 2], 
-00016210: 7769 6474 683d 7769 6474 6832 2c20 6f72  width=width2, or
-00016220: 6965 6e74 6174 696f 6e3d 3029 0a20 2020  ientation=0).   
-00016230: 2072 6574 7572 6e20 440a 0a0a 6465 6620   return D...def 
-00016240: 5f6d 6963 726f 7374 7269 705f 5a28 7769  _microstrip_Z(wi
-00016250: 7265 5f77 6964 7468 2c20 6469 656c 6563  re_width, dielec
-00016260: 7472 6963 5f74 6869 636b 6e65 7373 2c20  tric_thickness, 
-00016270: 6570 735f 7229 3a0a 2020 2020 2222 2243  eps_r):.    """C
-00016280: 616c 6375 6c61 7465 7320 7468 6520 696d  alculates the im
-00016290: 7065 6461 6e63 6520 6f66 2061 206d 6963  pedance of a mic
-000162a0: 726f 7374 7269 7020 6769 7665 6e20 7468  rostrip given th
-000162b0: 6520 7769 7265 2077 6964 7468 2061 6e64  e wire width and
-000162c0: 0a20 2020 2064 6965 6c65 6374 7269 6320  .    dielectric 
-000162d0: 7468 6963 6b6e 6573 7320 616e 6420 636f  thickness and co
-000162e0: 6e73 7461 6e74 2e0a 0a20 2020 2050 6172  nstant...    Par
-000162f0: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-00016300: 2d2d 2d2d 2d2d 0a20 2020 2077 6972 655f  ------.    wire_
-00016310: 7769 6474 6820 3a20 696e 7420 6f72 2066  width : int or f
-00016320: 6c6f 6174 0a20 2020 2020 2020 2057 6964  loat.        Wid
-00016330: 7468 206f 6620 7468 6520 636f 6e64 7563  th of the conduc
-00016340: 7469 6e67 2073 7472 6970 2e0a 2020 2020  ting strip..    
-00016350: 6469 656c 6563 7472 6963 5f74 6869 636b  dielectric_thick
-00016360: 6e65 7373 203a 2069 6e74 206f 7220 666c  ness : int or fl
-00016370: 6f61 740a 2020 2020 2020 2020 5468 6963  oat.        Thic
-00016380: 6b6e 6573 7320 6f66 2074 6865 2073 7562  kness of the sub
-00016390: 7374 7261 7465 2e0a 2020 2020 6570 735f  strate..    eps_
-000163a0: 7220 3a20 696e 7420 6f72 2066 6c6f 6174  r : int or float
-000163b0: 0a20 2020 2020 2020 2044 6965 6c65 6374  .        Dielect
-000163c0: 7269 6320 636f 6e73 7461 6e74 206f 6620  ric constant of 
-000163d0: 7468 6520 7375 6273 7472 6174 652e 0a0a  the substrate...
-000163e0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-000163f0: 2d2d 2d2d 2d2d 2d0a 2020 2020 5a20 3a20  -------.    Z : 
-00016400: 666c 6f61 740a 2020 2020 2020 2020 496d  float.        Im
-00016410: 7065 6461 6e63 6520 6f66 2074 6865 206d  pedance of the m
-00016420: 6963 726f 7374 7269 702e 0a20 2020 2065  icrostrip..    e
-00016430: 7073 5f65 6666 203a 2066 6c6f 6174 0a20  ps_eff : float. 
-00016440: 2020 2020 2020 2045 6666 6563 7469 7665         Effective
-00016450: 2064 6965 6c65 6374 7269 6320 636f 6e73   dielectric cons
-00016460: 7461 6e74 206f 6620 7468 6520 6d69 6372  tant of the micr
-00016470: 6f73 7472 6970 2e0a 0a20 2020 204e 6f74  ostrip...    Not
-00016480: 6573 0a20 2020 202d 2d2d 2d2d 0a20 2020  es.    -----.   
-00016490: 2045 7175 6174 696f 6e73 2074 616b 656e   Equations taken
-000164a0: 2066 726f 6d20 5b31 5d5f 2e0a 0a20 2020   from [1]_...   
-000164b0: 2054 6865 7365 2065 7175 6174 696f 6e73   These equations
-000164c0: 2063 616e 2062 6520 6675 7274 6865 7220   can be further 
-000164d0: 636f 7272 6563 7465 6420 666f 7220 7468  corrected for th
-000164e0: 6963 6b20 6669 6c6d 7320 2848 616d 6d65  ick films (Hamme
-000164f0: 7273 7461 6420 4571 732e 0a20 2020 2036  rstad Eqs..    6
-00016500: 2d39 2920 616e 6420 616c 736f 2066 6f72  -9) and also for
-00016510: 2066 7265 7175 656e 6379 2073 696e 6365   frequency since
-00016520: 206d 6963 726f 7374 7269 7073 2061 7265   microstrips are
-00016530: 2064 6973 7065 7273 6976 6520 2848 616d   dispersive (Ham
-00016540: 6d65 7273 7461 640a 2020 2020 4571 732e  merstad.    Eqs.
-00016550: 2031 302d 3132 290a 0a20 2020 2052 6566   10-12)..    Ref
-00016560: 6572 656e 6365 730a 2020 2020 2d2d 2d2d  erences.    ----
-00016570: 2d2d 2d2d 2d2d 0a20 2020 202e 2e20 5b31  ------.    .. [1
-00016580: 5d20 4861 6d6d 6572 7374 6164 2c20 452e  ] Hammerstad, E.
-00016590: 2c20 2620 4a65 6e73 656e 2c20 4f2e 2028  , & Jensen, O. (
-000165a0: 3139 3830 292e 2041 6363 7572 6174 6520  1980). Accurate 
-000165b0: 4d6f 6465 6c73 2066 6f72 204d 6963 726f  Models for Micro
-000165c0: 7374 7269 700a 2020 2020 2020 2043 6f6d  strip.       Com
-000165d0: 7075 7465 722d 4169 6465 6420 4465 7369  puter-Aided Desi
-000165e0: 676e 2e20 2068 7474 703a 2f2f 646f 692e  gn.  http://doi.
-000165f0: 6f72 672f 3130 2e31 3130 392f 4d57 5359  org/10.1109/MWSY
-00016600: 4d2e 3139 3830 2e31 3132 3433 3033 0a20  M.1980.1124303. 
-00016610: 2020 2022 2222 0a20 2020 2075 203d 2077     """.    u = w
-00016620: 6972 655f 7769 6474 6820 2f20 6469 656c  ire_width / diel
-00016630: 6563 7472 6963 5f74 6869 636b 6e65 7373  ectric_thickness
-00016640: 0a20 2020 2065 7461 203d 2033 3736 2e37  .    eta = 376.7
-00016650: 3320 2023 2056 6163 7575 6d20 696d 7065  3  # Vacuum impe
-00016660: 6461 6e63 650a 0a20 2020 2061 203d 2028  dance..    a = (
-00016670: 0a20 2020 2020 2020 2031 0a20 2020 2020  .        1.     
-00016680: 2020 202b 206c 6f67 2828 752a 2a34 202b     + log((u**4 +
-00016690: 2028 7520 2f20 3532 2920 2a2a 2032 2920   (u / 52) ** 2) 
-000166a0: 2f20 2875 2a2a 3420 2b20 302e 3433 3229  / (u**4 + 0.432)
-000166b0: 2920 2f20 3439 0a20 2020 2020 2020 202b  ) / 49.        +
-000166c0: 206c 6f67 2831 202b 2028 7520 2f20 3138   log(1 + (u / 18
-000166d0: 2e31 2920 2a2a 2033 2920 2f20 3138 2e37  .1) ** 3) / 18.7
-000166e0: 0a20 2020 2029 0a20 2020 2062 203d 2030  .    ).    b = 0
-000166f0: 2e35 3634 202a 2028 2865 7073 5f72 202d  .564 * ((eps_r -
-00016700: 2030 2e39 2920 2f20 2865 7073 5f72 202b   0.9) / (eps_r +
-00016710: 2033 2929 202a 2a20 302e 3035 330a 2020   3)) ** 0.053.  
-00016720: 2020 4620 3d20 3620 2b20 2832 202a 2070    F = 6 + (2 * p
-00016730: 6920 2d20 3629 202a 2065 7870 282d 2828  i - 6) * exp(-((
-00016740: 3330 2e36 3636 202f 2075 2920 2a2a 2030  30.666 / u) ** 0
-00016750: 2e37 3532 3829 290a 2020 2020 6570 735f  .7528)).    eps_
-00016760: 6566 6620 3d20 302e 3520 2a20 2865 7073  eff = 0.5 * (eps
-00016770: 5f72 202b 2031 2920 2b20 302e 3520 2a20  _r + 1) + 0.5 * 
-00016780: 2865 7073 5f72 202d 2031 2920 2a20 2831  (eps_r - 1) * (1
-00016790: 202b 2031 3020 2f20 7529 202a 2a20 282d   + 10 / u) ** (-
-000167a0: 6120 2a20 6229 0a20 2020 205a 203d 2065  a * b).    Z = e
-000167b0: 7461 202f 2028 3220 2a20 7069 2920 2a20  ta / (2 * pi) * 
-000167c0: 6c6f 6728 4620 2f20 7520 2b20 7371 7274  log(F / u + sqrt
-000167d0: 2831 202b 2028 3220 2f20 7529 202a 2a20  (1 + (2 / u) ** 
-000167e0: 3229 2920 2f20 7371 7274 2865 7073 5f65  2)) / sqrt(eps_e
-000167f0: 6666 290a 2020 2020 7265 7475 726e 205a  ff).    return Z
-00016800: 2c20 6570 735f 6566 660a 0a0a 6465 6620  , eps_eff...def 
-00016810: 5f6d 6963 726f 7374 7269 705f 4c43 5f70  _microstrip_LC_p
-00016820: 6572 5f6d 6574 6572 2877 6972 655f 7769  er_meter(wire_wi
-00016830: 6474 682c 2064 6965 6c65 6374 7269 635f  dth, dielectric_
-00016840: 7468 6963 6b6e 6573 732c 2065 7073 5f72  thickness, eps_r
-00016850: 293a 0a20 2020 2022 2222 4361 6c63 756c  ):.    """Calcul
-00016860: 6174 6573 2074 6865 2069 6e64 7563 7461  ates the inducta
-00016870: 6e63 6520 616e 6420 6361 7061 6369 7461  nce and capacita
-00016880: 6e63 6520 7065 7220 6d65 7465 7220 6f66  nce per meter of
-00016890: 2061 206d 6963 726f 7374 7269 700a 2020   a microstrip.  
-000168a0: 2020 6769 7665 6e20 7769 7265 2077 6964    given wire wid
-000168b0: 7468 2061 6e64 2064 6965 6c65 6374 7269  th and dielectri
-000168c0: 6320 7468 6963 6b6e 6573 7320 616e 6420  c thickness and 
-000168d0: 636f 6e73 7461 6e74 2e0a 0a20 2020 2050  constant...    P
-000168e0: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-000168f0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2077 6972  --------.    wir
-00016900: 655f 7769 6474 6820 3a20 696e 7420 6f72  e_width : int or
-00016910: 2066 6c6f 6174 0a20 2020 2020 2020 2057   float.        W
-00016920: 6964 7468 206f 6620 7468 6520 636f 6e64  idth of the cond
-00016930: 7563 7469 6e67 2073 7472 6970 2e0a 2020  ucting strip..  
-00016940: 2020 6469 656c 6563 7472 6963 5f74 6869    dielectric_thi
-00016950: 636b 6e65 7373 203a 2069 6e74 206f 7220  ckness : int or 
-00016960: 666c 6f61 740a 2020 2020 2020 2020 5468  float.        Th
-00016970: 6963 6b6e 6573 7320 6f66 2074 6865 2073  ickness of the s
-00016980: 7562 7374 7261 7465 2e0a 2020 2020 6570  ubstrate..    ep
-00016990: 735f 7220 3a20 696e 7420 6f72 2066 6c6f  s_r : int or flo
-000169a0: 6174 0a20 2020 2020 2020 2044 6965 6c65  at.        Diele
-000169b0: 6374 7269 6320 636f 6e73 7461 6e74 206f  ctric constant o
-000169c0: 6620 7468 6520 7375 6273 7472 6174 652e  f the substrate.
-000169d0: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
-000169e0: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 4c5f    -------.    L_
-000169f0: 6d20 3a20 666c 6f61 740a 2020 2020 2020  m : float.      
-00016a00: 2020 496e 6475 6374 616e 6365 2070 6572    Inductance per
-00016a10: 206d 6574 6572 206f 6620 7468 6520 6d69   meter of the mi
-00016a20: 6372 6f73 7472 6970 2e0a 2020 2020 435f  crostrip..    C_
-00016a30: 6d20 3a20 666c 6f61 740a 2020 2020 2020  m : float.      
-00016a40: 2020 4361 7061 6369 7461 6e63 6520 7065    Capacitance pe
-00016a50: 7220 6d65 7465 7220 6f66 2074 6865 206d  r meter of the m
-00016a60: 6963 726f 7374 7269 702e 0a0a 2020 2020  icrostrip...    
-00016a70: 4e6f 7465 730a 2020 2020 2d2d 2d2d 2d0a  Notes.    -----.
-00016a80: 2020 2020 4571 7561 7469 6f6e 7320 7461      Equations ta
-00016a90: 6b65 6e20 6672 6f6d 3a0a 2020 2020 2020  ken from:.      
-00016aa0: 2020 4861 6d6d 6572 7374 6164 2c20 452e    Hammerstad, E.
-00016ab0: 2c20 2620 4a65 6e73 656e 2c20 4f2e 2028  , & Jensen, O. (
-00016ac0: 3139 3830 292e 2041 6363 7572 6174 6520  1980). Accurate 
-00016ad0: 4d6f 6465 6c73 2066 6f72 204d 6963 726f  Models for Micro
-00016ae0: 7374 7269 700a 2020 2020 2020 2020 436f  strip.        Co
-00016af0: 6d70 7574 6572 2d41 6964 6564 2044 6573  mputer-Aided Des
-00016b00: 6967 6e2e 2020 6874 7470 3a2f 2f64 6f69  ign.  http://doi
-00016b10: 2e6f 7267 2f31 302e 3131 3039 2f4d 5753  .org/10.1109/MWS
-00016b20: 594d 2e31 3938 302e 3131 3234 3330 330a  YM.1980.1124303.
-00016b30: 0a20 2020 2054 6865 7365 2065 7175 6174  .    These equat
-00016b40: 696f 6e73 2063 616e 2062 6520 6675 7274  ions can be furt
-00016b50: 6865 7220 636f 7272 6563 7465 6420 666f  her corrected fo
-00016b60: 7220 7468 6963 6b20 6669 6c6d 7320 2848  r thick films (H
-00016b70: 616d 6d65 7273 7461 6420 4571 730a 2020  ammerstad Eqs.  
-00016b80: 2020 362d 3929 2061 6e64 2061 6c73 6f20    6-9) and also 
-00016b90: 666f 7220 6672 6571 7565 6e63 7920 7369  for frequency si
-00016ba0: 6e63 6520 6d69 6372 6f73 7472 6970 7320  nce microstrips 
-00016bb0: 6172 6520 6469 7370 6572 7369 7665 2028  are dispersive (
-00016bc0: 4861 6d6d 6572 7374 6164 0a20 2020 2045  Hammerstad.    E
-00016bd0: 7173 2031 302d 3132 290a 2020 2020 2222  qs 10-12).    ""
-00016be0: 220a 2020 2020 2320 5573 6520 7468 6520  ".    # Use the 
-00016bf0: 6661 6374 2074 6861 7420 7620 3d20 312f  fact that v = 1/
-00016c00: 7371 7274 284c 5f6d 2a43 5f6d 2920 3d20  sqrt(L_m*C_m) = 
-00016c10: 312f 7371 7274 2865 7073 2a6d 7529 2061  1/sqrt(eps*mu) a
-00016c20: 6e64 0a20 2020 2023 205a 203d 2073 7172  nd.    # Z = sqr
-00016c30: 7428 4c5f 6d2f 435f 6d29 2020 205b 5768  t(L_m/C_m)   [Wh
-00016c40: 6572 6520 4c5f 6d20 6973 2069 6e64 7563  ere L_m is induc
-00016c50: 7461 6e63 6520 7065 7220 6d65 7465 725d  tance per meter]
-00016c60: 0a20 2020 205a 2c20 6570 735f 6566 6620  .    Z, eps_eff 
-00016c70: 3d20 5f6d 6963 726f 7374 7269 705f 5a28  = _microstrip_Z(
-00016c80: 7769 7265 5f77 6964 7468 2c20 6469 656c  wire_width, diel
-00016c90: 6563 7472 6963 5f74 6869 636b 6e65 7373  ectric_thickness
-00016ca0: 2c20 6570 735f 7229 0a20 2020 2065 7073  , eps_r).    eps
-00016cb0: 3020 3d20 382e 3835 3465 2d31 320a 2020  0 = 8.854e-12.  
-00016cc0: 2020 6d75 3020 3d20 3420 2a20 7069 202a    mu0 = 4 * pi *
-00016cd0: 2031 652d 370a 0a20 2020 2065 7073 203d   1e-7..    eps =
-00016ce0: 2065 7073 5f65 6666 202a 2065 7073 300a   eps_eff * eps0.
-00016cf0: 2020 2020 6d75 203d 206d 7530 0a20 2020      mu = mu0.   
-00016d00: 204c 5f6d 203d 2073 7172 7428 6570 7320   L_m = sqrt(eps 
-00016d10: 2a20 6d75 2920 2a20 5a0a 2020 2020 435f  * mu) * Z.    C_
-00016d20: 6d20 3d20 7371 7274 2865 7073 202a 206d  m = sqrt(eps * m
-00016d30: 7529 202f 205a 0a20 2020 2072 6574 7572  u) / Z.    retur
-00016d40: 6e20 4c5f 6d2c 2043 5f6d 0a0a 0a64 6566  n L_m, C_m...def
-00016d50: 205f 6d69 6372 6f73 7472 6970 5f5a 5f77   _microstrip_Z_w
-00016d60: 6974 685f 4c6b 2877 6972 655f 7769 6474  ith_Lk(wire_widt
-00016d70: 682c 2064 6965 6c65 6374 7269 635f 7468  h, dielectric_th
-00016d80: 6963 6b6e 6573 732c 2065 7073 5f72 2c20  ickness, eps_r, 
-00016d90: 4c6b 5f70 6572 5f73 7129 3a0a 2020 2020  Lk_per_sq):.    
-00016da0: 2222 2243 616c 6375 6c61 7465 7320 7468  """Calculates th
-00016db0: 6520 696d 7065 6461 6e63 6520 6f66 2061  e impedance of a
-00016dc0: 206d 6963 726f 7374 7269 7020 6769 7665   microstrip give
-00016dd0: 6e20 7769 7265 2077 6964 7468 2c20 6469  n wire width, di
-00016de0: 656c 6563 7472 6963 0a20 2020 2074 6869  electric.    thi
-00016df0: 636b 6e65 7373 2061 6e64 2063 6f6e 7374  ckness and const
-00016e00: 616e 742c 2061 6e64 206b 696e 6574 6963  ant, and kinetic
-00016e10: 2069 6e64 7563 7461 6e63 6520 7065 7220   inductance per 
-00016e20: 7371 7561 7265 2e0a 0a20 2020 2050 6172  square...    Par
-00016e30: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-00016e40: 2d2d 2d2d 2d2d 0a20 2020 2077 6972 655f  ------.    wire_
-00016e50: 7769 6474 6820 3a20 696e 7420 6f72 2066  width : int or f
-00016e60: 6c6f 6174 0a20 2020 2020 2020 2057 6964  loat.        Wid
-00016e70: 7468 206f 6620 7468 6520 636f 6e64 7563  th of the conduc
-00016e80: 7469 6e67 2073 7472 6970 2e0a 2020 2020  ting strip..    
-00016e90: 6469 656c 6563 7472 6963 5f74 6869 636b  dielectric_thick
-00016ea0: 6e65 7373 203a 2069 6e74 206f 7220 666c  ness : int or fl
-00016eb0: 6f61 740a 2020 2020 2020 2020 5468 6963  oat.        Thic
-00016ec0: 6b6e 6573 7320 6f66 2074 6865 2073 7562  kness of the sub
-00016ed0: 7374 7261 7465 2e0a 2020 2020 6570 735f  strate..    eps_
-00016ee0: 7220 3a20 696e 7420 6f72 2066 6c6f 6174  r : int or float
-00016ef0: 0a20 2020 2020 2020 2044 6965 6c65 6374  .        Dielect
-00016f00: 7269 6320 636f 6e73 7461 6e74 206f 6620  ric constant of 
-00016f10: 7468 6520 7375 6273 7472 6174 652e 0a20  the substrate.. 
-00016f20: 2020 204c 6b5f 7065 725f 7371 203a 2069     Lk_per_sq : i
-00016f30: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
-00016f40: 2020 2020 4b69 6e65 7469 6320 696e 6475      Kinetic indu
-00016f50: 6374 616e 6365 2070 6572 2073 7175 6172  ctance per squar
-00016f60: 6520 6f66 2074 6865 206d 6963 726f 7374  e of the microst
-00016f70: 7269 702e 0a0a 2020 2020 5265 7475 726e  rip...    Return
-00016f80: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-00016f90: 2020 5a20 3a20 666c 6f61 740a 2020 2020    Z : float.    
-00016fa0: 2020 2020 496d 7065 6461 6e63 6520 6f66      Impedance of
-00016fb0: 2074 6865 206d 6963 726f 7374 7269 702e   the microstrip.
-00016fc0: 0a0a 2020 2020 4e6f 7465 730a 2020 2020  ..    Notes.    
-00016fd0: 2d2d 2d2d 2d0a 2020 2020 4571 7561 7469  -----.    Equati
-00016fe0: 6f6e 7320 7461 6b65 6e20 6672 6f6d 3a0a  ons taken from:.
-00016ff0: 2020 2020 2020 2020 4861 6d6d 6572 7374          Hammerst
-00017000: 6164 2c20 452e 2c20 2620 4a65 6e73 656e  ad, E., & Jensen
-00017010: 2c20 4f2e 2028 3139 3830 292e 2041 6363  , O. (1980). Acc
-00017020: 7572 6174 6520 4d6f 6465 6c73 2066 6f72  urate Models for
-00017030: 204d 6963 726f 7374 7269 700a 2020 2020   Microstrip.    
-00017040: 2020 2020 436f 6d70 7574 6572 2d41 6964      Computer-Aid
-00017050: 6564 2044 6573 6967 6e2e 2020 6874 7470  ed Design.  http
-00017060: 3a2f 2f64 6f69 2e6f 7267 2f31 302e 3131  ://doi.org/10.11
-00017070: 3039 2f4d 5753 594d 2e31 3938 302e 3131  09/MWSYM.1980.11
-00017080: 3234 3330 330a 0a20 2020 2054 6865 7365  24303..    These
-00017090: 2065 7175 6174 696f 6e73 2063 616e 2062   equations can b
-000170a0: 6520 6675 7274 6865 7220 636f 7272 6563  e further correc
-000170b0: 7465 6420 666f 7220 7468 6963 6b20 6669  ted for thick fi
-000170c0: 6c6d 7320 2848 616d 6d65 7273 7461 6420  lms (Hammerstad 
-000170d0: 4571 730a 2020 2020 362d 3929 2061 6e64  Eqs.    6-9) and
-000170e0: 2061 6c73 6f20 666f 7220 6672 6571 7565   also for freque
-000170f0: 6e63 7920 7369 6e63 6520 6d69 6372 6f73  ncy since micros
-00017100: 7472 6970 7320 6172 6520 6469 7370 6572  trips are disper
-00017110: 7369 7665 2028 4861 6d6d 6572 7374 6164  sive (Hammerstad
-00017120: 0a20 2020 2045 7173 2031 302d 3132 290a  .    Eqs 10-12).
-00017130: 2020 2020 2222 220a 2020 2020 2320 4164      """.    # Ad
-00017140: 6420 6120 6b69 6e65 7469 6320 696e 6475  d a kinetic indu
-00017150: 6374 616e 6365 2061 6e64 2072 6563 616c  ctance and recal
-00017160: 6375 6c61 7465 2074 6865 2069 6d70 6564  culate the imped
-00017170: 616e 6365 2c20 6265 2063 6172 6566 756c  ance, be careful
-00017180: 0a20 2020 2023 2074 6f20 696e 7075 7420  .    # to input 
-00017190: 4c6b 2061 7320 6120 7065 722d 6d65 7465  Lk as a per-mete
-000171a0: 7220 696e 6475 6374 616e 6365 0a20 2020  r inductance.   
-000171b0: 204c 5f6d 2c20 435f 6d20 3d20 5f6d 6963   L_m, C_m = _mic
-000171c0: 726f 7374 7269 705f 4c43 5f70 6572 5f6d  rostrip_LC_per_m
-000171d0: 6574 6572 2877 6972 655f 7769 6474 682c  eter(wire_width,
-000171e0: 2064 6965 6c65 6374 7269 635f 7468 6963   dielectric_thic
-000171f0: 6b6e 6573 732c 2065 7073 5f72 290a 2020  kness, eps_r).  
-00017200: 2020 4c6b 5f6d 203d 204c 6b5f 7065 725f    Lk_m = Lk_per_
-00017210: 7371 202a 2028 312e 3020 2f20 7769 7265  sq * (1.0 / wire
-00017220: 5f77 6964 7468 290a 2020 2020 5a20 3d20  _width).    Z = 
-00017230: 7371 7274 2828 4c5f 6d20 2b20 4c6b 5f6d  sqrt((L_m + Lk_m
-00017240: 2920 2f20 435f 6d29 0a20 2020 2072 6574  ) / C_m).    ret
-00017250: 7572 6e20 5a0a 0a0a 6465 6620 5f6d 6963  urn Z...def _mic
-00017260: 726f 7374 7269 705f 765f 7769 7468 5f4c  rostrip_v_with_L
-00017270: 6b28 7769 7265 5f77 6964 7468 2c20 6469  k(wire_width, di
-00017280: 656c 6563 7472 6963 5f74 6869 636b 6e65  electric_thickne
-00017290: 7373 2c20 6570 735f 722c 204c 6b5f 7065  ss, eps_r, Lk_pe
-000172a0: 725f 7371 293a 0a20 2020 2022 2222 4361  r_sq):.    """Ca
-000172b0: 6c63 756c 6174 6573 2074 6865 2070 726f  lculates the pro
-000172c0: 7061 6761 7469 6f6e 2076 656c 6f63 6974  pagation velocit
-000172d0: 7920 696e 2061 206d 6963 726f 7374 7269  y in a microstri
-000172e0: 700a 0a20 2020 2050 6172 616d 6574 6572  p..    Parameter
-000172f0: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-00017300: 0a20 2020 2077 6972 655f 7769 6474 6820  .    wire_width 
-00017310: 3a20 696e 7420 6f72 2066 6c6f 6174 0a20  : int or float. 
-00017320: 2020 2020 2020 2057 6964 7468 206f 6620         Width of 
-00017330: 7468 6520 636f 6e64 7563 7469 6e67 2073  the conducting s
-00017340: 7472 6970 2e0a 2020 2020 6469 656c 6563  trip..    dielec
-00017350: 7472 6963 5f74 6869 636b 6e65 7373 203a  tric_thickness :
-00017360: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
-00017370: 2020 2020 2020 5468 6963 6b6e 6573 7320        Thickness 
-00017380: 6f66 2074 6865 2073 7562 7374 7261 7465  of the substrate
-00017390: 2e0a 2020 2020 6570 735f 7220 3a20 696e  ..    eps_r : in
-000173a0: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
-000173b0: 2020 2044 6965 6c65 6374 7269 6320 636f     Dielectric co
-000173c0: 6e73 7461 6e74 206f 6620 7468 6520 7375  nstant of the su
-000173d0: 6273 7472 6174 652e 0a20 2020 204c 6b5f  bstrate..    Lk_
-000173e0: 7065 725f 7371 203a 2069 6e74 206f 7220  per_sq : int or 
-000173f0: 666c 6f61 740a 2020 2020 2020 2020 4b69  float.        Ki
-00017400: 6e65 7469 6320 696e 6475 6374 616e 6365  netic inductance
-00017410: 2070 6572 2073 7175 6172 6520 6f66 2074   per square of t
-00017420: 6865 206d 6963 726f 7374 7269 702e 0a0a  he microstrip...
-00017430: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-00017440: 2d2d 2d2d 2d2d 2d0a 2020 2020 7620 3a20  -------.    v : 
-00017450: 666c 6f61 740a 2020 2020 2020 2020 5072  float.        Pr
-00017460: 6f70 6167 6174 696f 6e20 7665 6c6f 6369  opagation veloci
-00017470: 7479 2069 6e20 7468 6520 6d69 6372 6f73  ty in the micros
-00017480: 7472 6970 0a0a 2020 2020 4e6f 7465 730a  trip..    Notes.
-00017490: 2020 2020 2d2d 2d2d 2d0a 2020 2020 4571      -----.    Eq
-000174a0: 7561 7469 6f6e 7320 7461 6b65 6e20 6672  uations taken fr
-000174b0: 6f6d 3a0a 2020 2020 2020 2020 4861 6d6d  om:.        Hamm
-000174c0: 6572 7374 6164 2c20 452e 2c20 2620 4a65  erstad, E., & Je
-000174d0: 6e73 656e 2c20 4f2e 2028 3139 3830 292e  nsen, O. (1980).
-000174e0: 2041 6363 7572 6174 6520 4d6f 6465 6c73   Accurate Models
-000174f0: 2066 6f72 204d 6963 726f 7374 7269 700a   for Microstrip.
-00017500: 2020 2020 2020 2020 436f 6d70 7574 6572          Computer
-00017510: 2d41 6964 6564 2044 6573 6967 6e2e 2020  -Aided Design.  
-00017520: 6874 7470 3a2f 2f64 6f69 2e6f 7267 2f31  http://doi.org/1
-00017530: 302e 3131 3039 2f4d 5753 594d 2e31 3938  0.1109/MWSYM.198
-00017540: 302e 3131 3234 3330 330a 0a20 2020 2054  0.1124303..    T
-00017550: 6865 7365 2065 7175 6174 696f 6e73 2063  hese equations c
-00017560: 616e 2062 6520 6675 7274 6865 7220 636f  an be further co
-00017570: 7272 6563 7465 6420 666f 7220 7468 6963  rrected for thic
-00017580: 6b20 6669 6c6d 7320 2848 616d 6d65 7273  k films (Hammers
-00017590: 7461 6420 4571 730a 2020 2020 362d 3929  tad Eqs.    6-9)
-000175a0: 2061 6e64 2061 6c73 6f20 666f 7220 6672   and also for fr
-000175b0: 6571 7565 6e63 7920 7369 6e63 6520 6d69  equency since mi
-000175c0: 6372 6f73 7472 6970 7320 6172 6520 6469  crostrips are di
-000175d0: 7370 6572 7369 7665 2028 4861 6d6d 6572  spersive (Hammer
-000175e0: 7374 6164 0a20 2020 2045 7173 2031 302d  stad.    Eqs 10-
-000175f0: 3132 290a 2020 2020 2222 220a 2020 2020  12).    """.    
-00017600: 4c5f 6d2c 2043 5f6d 203d 205f 6d69 6372  L_m, C_m = _micr
-00017610: 6f73 7472 6970 5f4c 435f 7065 725f 6d65  ostrip_LC_per_me
-00017620: 7465 7228 7769 7265 5f77 6964 7468 2c20  ter(wire_width, 
-00017630: 6469 656c 6563 7472 6963 5f74 6869 636b  dielectric_thick
-00017640: 6e65 7373 2c20 6570 735f 7229 0a20 2020  ness, eps_r).   
-00017650: 204c 6b5f 6d20 3d20 4c6b 5f70 6572 5f73   Lk_m = Lk_per_s
-00017660: 7120 2a20 2831 2e30 202f 2077 6972 655f  q * (1.0 / wire_
-00017670: 7769 6474 6829 0a20 2020 2076 203d 2031  width).    v = 1
-00017680: 202f 2073 7172 7428 284c 5f6d 202b 204c   / sqrt((L_m + L
-00017690: 6b5f 6d29 202a 2043 5f6d 290a 2020 2020  k_m) * C_m).    
-000176a0: 7265 7475 726e 2076 0a0a 0a64 6566 205f  return v...def _
-000176b0: 6669 6e64 5f6d 6963 726f 7374 7269 705f  find_microstrip_
-000176c0: 7769 7265 5f77 6964 7468 285a 5f74 6172  wire_width(Z_tar
-000176d0: 6765 742c 2064 6965 6c65 6374 7269 635f  get, dielectric_
-000176e0: 7468 6963 6b6e 6573 732c 2065 7073 5f72  thickness, eps_r
-000176f0: 2c20 4c6b 5f70 6572 5f73 7129 3a0a 2020  , Lk_per_sq):.  
-00017700: 2020 2222 2243 616c 6375 6c61 7465 7320    """Calculates 
-00017710: 7468 6520 7769 7265 2077 6964 7468 206f  the wire width o
-00017720: 6620 6120 6d69 6372 6f73 7472 6970 2067  f a microstrip g
-00017730: 6976 656e 2061 2074 6172 6765 7420 696d  iven a target im
-00017740: 7065 6461 6e63 652c 0a20 2020 2064 6965  pedance,.    die
-00017750: 6c65 6374 7269 6320 7468 6963 6b6e 6573  lectric thicknes
-00017760: 7320 616e 6420 636f 6e73 7461 6e74 2c20  s and constant, 
-00017770: 616e 6420 6b69 6e65 7469 6320 696e 6475  and kinetic indu
-00017780: 6374 616e 6365 2070 6572 2073 7175 6172  ctance per squar
-00017790: 652e 0a0a 2020 2020 5061 7261 6d65 7465  e...    Paramete
-000177a0: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-000177b0: 2d0a 2020 2020 5a5f 7461 7267 6574 203a  -.    Z_target :
-000177c0: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
-000177d0: 2020 2020 2020 5461 7267 6574 2069 6d70        Target imp
-000177e0: 6564 616e 6365 206f 6620 7468 6520 6d69  edance of the mi
-000177f0: 6372 6f73 7472 6970 2e0a 2020 2020 6469  crostrip..    di
-00017800: 656c 6563 7472 6963 5f74 6869 636b 6e65  electric_thickne
-00017810: 7373 203a 2069 6e74 206f 7220 666c 6f61  ss : int or floa
-00017820: 740a 2020 2020 2020 2020 5468 6963 6b6e  t.        Thickn
-00017830: 6573 7320 6f66 2074 6865 2073 7562 7374  ess of the subst
-00017840: 7261 7465 2e0a 2020 2020 6570 735f 7220  rate..    eps_r 
-00017850: 3a20 696e 7420 6f72 2066 6c6f 6174 0a20  : int or float. 
-00017860: 2020 2020 2020 2044 6965 6c65 6374 7269         Dielectri
-00017870: 6320 636f 6e73 7461 6e74 206f 6620 7468  c constant of th
-00017880: 6520 7375 6273 7472 6174 652e 0a20 2020  e substrate..   
-00017890: 204c 6b5f 7065 725f 7371 203a 2069 6e74   Lk_per_sq : int
-000178a0: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
-000178b0: 2020 4b69 6e65 7469 6320 696e 6475 6374    Kinetic induct
-000178c0: 616e 6365 2070 6572 2073 7175 6172 6520  ance per square 
-000178d0: 6f66 2074 6865 206d 6963 726f 7374 7269  of the microstri
-000178e0: 702e 0a0a 2020 2020 5265 7475 726e 730a  p...    Returns.
-000178f0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-00017900: 7720 3a20 666c 6f61 740a 2020 2020 2020  w : float.      
-00017910: 2020 5769 7265 2077 6964 7468 206f 6620    Wire width of 
-00017920: 7468 6520 6d69 6372 6f73 7472 6970 2e0a  the microstrip..
-00017930: 0a20 2020 204e 6f74 6573 0a20 2020 202d  .    Notes.    -
-00017940: 2d2d 2d2d 0a20 2020 2045 7175 6174 696f  ----.    Equatio
-00017950: 6e73 2074 616b 656e 2066 726f 6d3a 0a20  ns taken from:. 
-00017960: 2020 2020 2020 2048 616d 6d65 7273 7461         Hammersta
-00017970: 642c 2045 2e2c 2026 204a 656e 7365 6e2c  d, E., & Jensen,
-00017980: 204f 2e20 2831 3938 3029 2e20 4163 6375   O. (1980). Accu
-00017990: 7261 7465 204d 6f64 656c 7320 666f 7220  rate Models for 
-000179a0: 4d69 6372 6f73 7472 6970 0a20 2020 2020  Microstrip.     
-000179b0: 2020 2043 6f6d 7075 7465 722d 4169 6465     Computer-Aide
-000179c0: 6420 4465 7369 676e 2e20 2068 7474 703a  d Design.  http:
-000179d0: 2f2f 646f 692e 6f72 672f 3130 2e31 3130  //doi.org/10.110
-000179e0: 392f 4d57 5359 4d2e 3139 3830 2e31 3132  9/MWSYM.1980.112
-000179f0: 3433 3033 0a0a 2020 2020 5468 6573 6520  4303..    These 
-00017a00: 6571 7561 7469 6f6e 7320 6361 6e20 6265  equations can be
-00017a10: 2066 7572 7468 6572 2063 6f72 7265 6374   further correct
-00017a20: 6564 2066 6f72 2074 6869 636b 2066 696c  ed for thick fil
-00017a30: 6d73 2028 4861 6d6d 6572 7374 6164 2045  ms (Hammerstad E
-00017a40: 7173 0a20 2020 2036 2d39 2920 616e 6420  qs.    6-9) and 
-00017a50: 616c 736f 2066 6f72 2066 7265 7175 656e  also for frequen
-00017a60: 6379 2073 696e 6365 206d 6963 726f 7374  cy since microst
-00017a70: 7269 7073 2061 7265 2064 6973 7065 7273  rips are dispers
-00017a80: 6976 6520 2848 616d 6d65 7273 7461 640a  ive (Hammerstad.
-00017a90: 2020 2020 4571 7320 3130 2d31 3229 0a20      Eqs 10-12). 
-00017aa0: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
-00017ab0: 6572 726f 725f 6675 6e28 7769 7265 5f77  error_fun(wire_w
-00017ac0: 6964 7468 293a 0a20 2020 2020 2020 205a  idth):.        Z
-00017ad0: 5f67 7565 7373 6564 203d 205f 6d69 6372  _guessed = _micr
-00017ae0: 6f73 7472 6970 5f5a 5f77 6974 685f 4c6b  ostrip_Z_with_Lk
-00017af0: 280a 2020 2020 2020 2020 2020 2020 7769  (.            wi
-00017b00: 7265 5f77 6964 7468 2c20 6469 656c 6563  re_width, dielec
-00017b10: 7472 6963 5f74 6869 636b 6e65 7373 2c20  tric_thickness, 
-00017b20: 6570 735f 722c 204c 6b5f 7065 725f 7371  eps_r, Lk_per_sq
-00017b30: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00017b40: 2020 2072 6574 7572 6e20 285a 5f67 7565     return (Z_gue
-00017b50: 7373 6564 202d 205a 5f74 6172 6765 7429  ssed - Z_target)
-00017b60: 202a 2a20 3220 2023 2054 6865 2065 7272   ** 2  # The err
-00017b70: 6f72 0a0a 2020 2020 7830 203d 2064 6965  or..    x0 = die
-00017b80: 6c65 6374 7269 635f 7468 6963 6b6e 6573  lectric_thicknes
-00017b90: 730a 2020 2020 7472 793a 0a20 2020 2020  s.    try:.     
-00017ba0: 2020 2066 726f 6d20 7363 6970 792e 6f70     from scipy.op
-00017bb0: 7469 6d69 7a65 2069 6d70 6f72 7420 666d  timize import fm
-00017bc0: 696e 0a20 2020 2065 7863 6570 7420 4578  in.    except Ex
-00017bd0: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
-00017be0: 2072 6169 7365 2049 6d70 6f72 7445 7272   raise ImportErr
-00017bf0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00017c00: 2220 5b50 4849 444c 5d20 546f 2072 756e  " [PHIDL] To run
-00017c10: 2074 6865 206d 6963 726f 7374 7269 7020   the microstrip 
-00017c20: 6675 6e63 7469 6f6e 7320 796f 7520 220a  functions you ".
-00017c30: 2020 2020 2020 2020 2020 2020 226e 6565              "nee
-00017c40: 6420 7363 6970 792c 2070 6c65 6173 6520  d scipy, please 
-00017c50: 696e 7374 616c 6c20 6974 2077 6974 6820  install it with 
-00017c60: 220a 2020 2020 2020 2020 2020 2020 2260  ".            "`
-00017c70: 7069 7020 696e 7374 616c 6c20 7363 6970  pip install scip
-00017c80: 7960 220a 2020 2020 2020 2020 290a 2020  y`".        ).  
-00017c90: 2020 7720 3d20 666d 696e 2865 7272 6f72    w = fmin(error
-00017ca0: 5f66 756e 2c20 7830 2c20 6172 6773 3d28  _fun, x0, args=(
-00017cb0: 292c 2064 6973 703d 4661 6c73 6529 0a20  ), disp=False). 
-00017cc0: 2020 2072 6574 7572 6e20 775b 305d 0a0a     return w[0]..
-00017cd0: 0a64 6566 205f 475f 696e 7465 6772 616e  .def _G_integran
-00017ce0: 6428 7869 702c 2042 293a 0a20 2020 2022  d(xip, B):.    "
-00017cf0: 2222 5370 6563 6961 6c20 6675 6e63 7469  ""Special functi
-00017d00: 6f6e 2066 6f72 206d 6963 726f 7374 7269  on for microstri
-00017d10: 7020 6361 6c63 756c 6174 696f 6e73 2222  p calculations""
-00017d20: 220a 2020 2020 7472 793a 0a20 2020 2020  ".    try:.     
-00017d30: 2020 2066 726f 6d20 7363 6970 792e 7370     from scipy.sp
-00017d40: 6563 6961 6c20 696d 706f 7274 2069 7620  ecial import iv 
-00017d50: 6173 2062 6573 7365 6c69 0a20 2020 2065  as besseli.    e
-00017d60: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
-00017d70: 0a20 2020 2020 2020 2022 2222 5b50 4849  .        """[PHI
-00017d80: 444c 5d20 546f 2072 756e 2074 6869 7320  DL] To run this 
-00017d90: 6675 6e63 7469 6f6e 2079 6f75 206e 6565  function you nee
-00017da0: 6420 7363 6970 792c 2070 6c65 6173 6520  d scipy, please 
-00017db0: 696e 7374 616c 6c20 6974 2077 6974 680a  install it with.
-00017dc0: 2020 2020 2020 2020 7069 7020 696e 7374          pip inst
-00017dd0: 616c 6c20 7363 6970 7922 2222 0a20 2020  all scipy""".   
-00017de0: 2072 6574 7572 6e20 6265 7373 656c 6928   return besseli(
-00017df0: 302c 2042 202a 2073 7172 7428 3120 2d20  0, B * sqrt(1 - 
-00017e00: 7869 702a 2a32 2929 0a0a 0a64 6566 205f  xip**2))...def _
-00017e10: 4728 7869 2c20 4229 3a0a 2020 2020 2222  G(xi, B):.    ""
-00017e20: 2253 7065 6369 616c 2066 756e 6374 696f  "Special functio
-00017e30: 6e20 666f 7220 6d69 6372 6f73 7472 6970  n for microstrip
-00017e40: 2063 616c 6375 6c61 7469 6f6e 7322 2222   calculations"""
-00017e50: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
-00017e60: 2020 696d 706f 7274 2073 6369 7079 2e69    import scipy.i
-00017e70: 6e74 6567 7261 7465 0a20 2020 2065 7863  ntegrate.    exc
-00017e80: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
-00017e90: 2020 2020 2020 2072 6169 7365 2049 6d70         raise Imp
-00017ea0: 6f72 7445 7272 6f72 280a 2020 2020 2020  ortError(.      
-00017eb0: 2020 2020 2020 2220 5b50 4849 444c 5d20        " [PHIDL] 
-00017ec0: 546f 2072 756e 2074 6865 206d 6963 726f  To run the micro
-00017ed0: 7374 7269 7020 6675 6e63 7469 6f6e 7320  strip functions 
-00017ee0: 796f 7520 220a 2020 2020 2020 2020 2020  you ".          
-00017ef0: 2020 226e 6565 6420 7363 6970 792c 2070    "need scipy, p
-00017f00: 6c65 6173 6520 696e 7374 616c 6c20 6974  lease install it
-00017f10: 2077 6974 6820 220a 2020 2020 2020 2020   with ".        
-00017f20: 2020 2020 2260 7069 7020 696e 7374 616c      "`pip instal
-00017f30: 6c20 7363 6970 7960 220a 2020 2020 2020  l scipy`".      
-00017f40: 2020 290a 2020 2020 7265 7475 726e 2042    ).    return B
-00017f50: 202f 2073 696e 6828 4229 202a 2073 6369   / sinh(B) * sci
-00017f60: 7079 2e69 6e74 6567 7261 7465 2e71 7561  py.integrate.qua
-00017f70: 6428 5f47 5f69 6e74 6567 7261 6e64 2c20  d(_G_integrand, 
-00017f80: 302c 2078 692c 2061 7267 733d 2842 2929  0, xi, args=(B))
-00017f90: 5b30 5d0a 0a0a 4064 6576 6963 655f 6c72  [0]...@device_lr
-00017fa0: 755f 6361 6368 650a 6465 6620 6865 636b  u_cache.def heck
-00017fb0: 656e 5f74 6170 6572 280a 2020 2020 6c65  en_taper(.    le
-00017fc0: 6e67 7468 3d32 3030 2c0a 2020 2020 423d  ngth=200,.    B=
-00017fd0: 342e 3030 3931 2c0a 2020 2020 6469 656c  4.0091,.    diel
-00017fe0: 6563 7472 6963 5f74 6869 636b 6e65 7373  ectric_thickness
-00017ff0: 3d30 2e32 352c 0a20 2020 2065 7073 5f72  =0.25,.    eps_r
-00018000: 3d32 2c0a 2020 2020 4c6b 5f70 6572 5f73  =2,.    Lk_per_s
-00018010: 713d 3235 3065 2d31 322c 0a20 2020 205a  q=250e-12,.    Z
-00018020: 313d 4e6f 6e65 2c0a 2020 2020 5a32 3d4e  1=None,.    Z2=N
-00018030: 6f6e 652c 0a20 2020 2077 6964 7468 313d  one,.    width1=
-00018040: 4e6f 6e65 2c0a 2020 2020 7769 6474 6832  None,.    width2
-00018050: 3d4e 6f6e 652c 0a20 2020 206e 756d 5f70  =None,.    num_p
-00018060: 7473 3d31 3030 2c0a 2020 2020 6c61 7965  ts=100,.    laye
-00018070: 723d 302c 0a29 3a0a 2020 2020 2222 2243  r=0,.):.    """C
-00018080: 7265 6174 6573 2061 2048 6563 6b65 6e2d  reates a Hecken-
-00018090: 7461 7065 7265 6420 6d69 6372 6f73 7472  tapered microstr
-000180a0: 6970 2e0a 0a20 2020 2050 6172 616d 6574  ip...    Paramet
-000180b0: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-000180c0: 2d2d 0a20 2020 206c 656e 6774 6820 3a20  --.    length : 
-000180d0: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
-000180e0: 2020 2020 204c 656e 6774 6820 6f66 2074       Length of t
-000180f0: 6865 206d 6963 726f 7374 7269 702e 0a20  he microstrip.. 
-00018100: 2020 2042 203a 2069 6e74 206f 7220 666c     B : int or fl
-00018110: 6f61 740a 2020 2020 2020 2020 436f 6e74  oat.        Cont
-00018120: 726f 6c73 2074 6865 2069 6e74 656e 7369  rols the intensi
-00018130: 7479 206f 6620 7468 6520 7461 7065 722e  ty of the taper.
-00018140: 0a20 2020 2064 6965 6c65 6374 7269 635f  .    dielectric_
-00018150: 7468 6963 6b6e 6573 7320 3a20 696e 7420  thickness : int 
-00018160: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
-00018170: 2054 6869 636b 6e65 7373 206f 6620 7468   Thickness of th
-00018180: 6520 7375 6273 7472 6174 652e 0a20 2020  e substrate..   
-00018190: 2065 7073 5f72 203a 2069 6e74 206f 7220   eps_r : int or 
-000181a0: 666c 6f61 740a 2020 2020 2020 2020 4469  float.        Di
-000181b0: 656c 6563 7472 6963 2063 6f6e 7374 616e  electric constan
-000181c0: 7420 6f66 2074 6865 2073 7562 7374 7261  t of the substra
-000181d0: 7465 2e0a 2020 2020 4c6b 5f70 6572 5f73  te..    Lk_per_s
-000181e0: 7120 3a20 666c 6f61 740a 2020 2020 2020  q : float.      
-000181f0: 2020 4b69 6e65 7469 6320 696e 6475 6374    Kinetic induct
-00018200: 616e 6365 2070 6572 2073 7175 6172 6520  ance per square 
-00018210: 6f66 2074 6865 206d 6963 726f 7374 7269  of the microstri
-00018220: 702e 0a20 2020 205a 3120 3a20 696e 742c  p..    Z1 : int,
-00018230: 2066 6c6f 6174 2c20 6f72 204e 6f6e 650a   float, or None.
-00018240: 2020 2020 2020 2020 496d 7065 6461 6e63          Impedanc
-00018250: 6520 6f66 2074 6865 206c 6566 7420 7369  e of the left si
-00018260: 6465 2072 6567 696f 6e20 6f66 2074 6865  de region of the
-00018270: 206d 6963 726f 7374 7269 702e 0a20 2020   microstrip..   
-00018280: 205a 3220 3a20 696e 742c 2066 6c6f 6174   Z2 : int, float
-00018290: 2c20 6f72 204e 6f6e 650a 2020 2020 2020  , or None.      
-000182a0: 2020 496d 7065 6461 6e63 6520 6f66 2074    Impedance of t
-000182b0: 6865 2072 6967 6874 2073 6964 6520 7265  he right side re
-000182c0: 6769 6f6e 206f 6620 7468 6520 6d69 6372  gion of the micr
-000182d0: 6f73 7472 6970 2e0a 2020 2020 7769 6474  ostrip..    widt
-000182e0: 6831 203a 2069 6e74 2c20 666c 6f61 742c  h1 : int, float,
-000182f0: 206f 7220 4e6f 6e65 0a20 2020 2020 2020   or None.       
-00018300: 2057 6964 7468 206f 6620 7468 6520 6c65   Width of the le
-00018310: 6674 2073 6964 6520 6f66 2074 6865 206d  ft side of the m
-00018320: 6963 726f 7374 7269 702e 0a20 2020 2077  icrostrip..    w
-00018330: 6964 7468 3220 3a20 696e 742c 2066 6c6f  idth2 : int, flo
-00018340: 6174 2c20 6f72 204e 6f6e 650a 2020 2020  at, or None.    
-00018350: 2020 2020 5769 6474 6820 6f66 2074 6865      Width of the
-00018360: 2072 6967 6874 2073 6964 6520 6f66 2074   right side of t
-00018370: 6865 206d 6963 726f 7374 7269 702e 0a20  he microstrip.. 
-00018380: 2020 206e 756d 5f70 7473 203a 2069 6e74     num_pts : int
-00018390: 0a20 2020 2020 2020 204e 756d 6265 7220  .        Number 
-000183a0: 6f66 2070 6f69 6e74 7320 636f 6d70 7269  of points compri
-000183b0: 7369 6e67 2074 6865 2063 7572 7665 206f  sing the curve o
-000183c0: 6620 7468 6520 656e 7469 7265 206d 6963  f the entire mic
-000183d0: 726f 7374 7269 702e 0a20 2020 206c 6179  rostrip..    lay
-000183e0: 6572 203a 2069 6e74 2c20 6172 7261 792d  er : int, array-
-000183f0: 6c69 6b65 5b32 5d2c 206f 7220 7365 740a  like[2], or set.
-00018400: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
-00018410: 206c 6179 6572 2873 2920 746f 2070 7574   layer(s) to put
-00018420: 2070 6f6c 7967 6f6e 2067 656f 6d65 7472   polygon geometr
-00018430: 7920 6f6e 2e0a 0a20 2020 2052 6574 7572  y on...    Retur
-00018440: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-00018450: 2020 2044 203a 2044 6576 6963 650a 2020     D : Device.  
-00018460: 2020 2020 2020 4120 4465 7669 6365 2063        A Device c
-00018470: 6f6e 7461 696e 696e 6720 6120 4865 636b  ontaining a Heck
-00018480: 656e 2d74 6170 6572 6564 206d 6963 726f  en-tapered micro
-00018490: 7374 7269 702e 0a20 2020 2022 2222 0a20  strip..    """. 
-000184a0: 2020 2069 6620 7769 6474 6831 2069 7320     if width1 is 
-000184b0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-000184c0: 2020 5a31 203d 205f 6d69 6372 6f73 7472    Z1 = _microstr
-000184d0: 6970 5f5a 5f77 6974 685f 4c6b 280a 2020  ip_Z_with_Lk(.  
-000184e0: 2020 2020 2020 2020 2020 7769 6474 6831            width1
-000184f0: 202a 2031 652d 362c 2064 6965 6c65 6374   * 1e-6, dielect
-00018500: 7269 635f 7468 6963 6b6e 6573 7320 2a20  ric_thickness * 
-00018510: 3165 2d36 2c20 6570 735f 722c 204c 6b5f  1e-6, eps_r, Lk_
-00018520: 7065 725f 7371 0a20 2020 2020 2020 2029  per_sq.        )
-00018530: 0a20 2020 2069 6620 7769 6474 6832 2069  .    if width2 i
-00018540: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00018550: 2020 2020 5a32 203d 205f 6d69 6372 6f73      Z2 = _micros
-00018560: 7472 6970 5f5a 5f77 6974 685f 4c6b 280a  trip_Z_with_Lk(.
-00018570: 2020 2020 2020 2020 2020 2020 7769 6474              widt
-00018580: 6832 202a 2031 652d 362c 2064 6965 6c65  h2 * 1e-6, diele
-00018590: 6374 7269 635f 7468 6963 6b6e 6573 7320  ctric_thickness 
-000185a0: 2a20 3165 2d36 2c20 6570 735f 722c 204c  * 1e-6, eps_r, L
-000185b0: 6b5f 7065 725f 7371 0a20 2020 2020 2020  k_per_sq.       
-000185c0: 2029 0a20 2020 2023 204e 6f72 6d61 6c69   ).    # Normali
-000185d0: 7a65 6420 6c65 6e67 7468 206f 6620 7468  zed length of th
-000185e0: 6520 7769 7265 205b 2d31 2074 6f20 2b31  e wire [-1 to +1
-000185f0: 5d0a 2020 2020 7869 5f6c 6973 7420 3d20  ].    xi_list = 
-00018600: 6e70 2e6c 696e 7370 6163 6528 2d31 2c20  np.linspace(-1, 
-00018610: 312c 206e 756d 5f70 7473 290a 2020 2020  1, num_pts).    
-00018620: 5a20 3d20 5b6e 702e 6578 7028 302e 3520  Z = [np.exp(0.5 
-00018630: 2a20 6c6f 6728 5a31 202a 205a 3229 202b  * log(Z1 * Z2) +
-00018640: 2030 2e35 202a 206c 6f67 285a 3220 2f20   0.5 * log(Z2 / 
-00018650: 5a31 2920 2a20 5f47 2878 692c 2042 2929  Z1) * _G(xi, B))
-00018660: 2066 6f72 2078 6920 696e 2078 695f 6c69   for xi in xi_li
-00018670: 7374 5d0a 2020 2020 7769 6474 6873 203d  st].    widths =
-00018680: 206e 702e 6172 7261 7928 0a20 2020 2020   np.array(.     
-00018690: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-000186a0: 205f 6669 6e64 5f6d 6963 726f 7374 7269   _find_microstri
-000186b0: 705f 7769 7265 5f77 6964 7468 280a 2020  p_wire_width(.  
-000186c0: 2020 2020 2020 2020 2020 2020 2020 7a2c                z,
-000186d0: 2064 6965 6c65 6374 7269 635f 7468 6963   dielectric_thic
-000186e0: 6b6e 6573 7320 2a20 3165 2d36 2c20 6570  kness * 1e-6, ep
-000186f0: 735f 722c 204c 6b5f 7065 725f 7371 0a20  s_r, Lk_per_sq. 
-00018700: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00018710: 2020 2020 2020 2020 202a 2031 6536 0a20           * 1e6. 
-00018720: 2020 2020 2020 2020 2020 2066 6f72 207a             for z
-00018730: 2069 6e20 5a0a 2020 2020 2020 2020 5d0a   in Z.        ].
-00018740: 2020 2020 290a 2020 2020 7820 3d20 2878      ).    x = (x
-00018750: 695f 6c69 7374 202f 2032 2920 2a20 6c65  i_list / 2) * le
-00018760: 6e67 7468 0a0a 2020 2020 2320 436f 6d70  ngth..    # Comp
-00018770: 656e 7361 7465 2066 6f72 2076 6172 7969  ensate for varyi
-00018780: 6e67 2073 7065 6564 206f 6620 6c69 6768  ng speed of ligh
-00018790: 7420 696e 2074 6865 206d 6963 726f 7374  t in the microst
-000187a0: 7269 7020 6279 2073 686f 7274 656e 696e  rip by shortenin
-000187b0: 670a 2020 2020 2320 616e 6420 6c65 6e67  g.    # and leng
-000187c0: 7468 656e 696e 6720 7365 6374 696f 6e73  thening sections
-000187d0: 2061 6363 6f72 6469 6e67 2074 6f20 7468   according to th
-000187e0: 6520 7370 6565 6420 6f66 206c 6967 6874  e speed of light
-000187f0: 2069 6e20 7468 6174 2073 6563 7469 6f6e   in that section
-00018800: 0a20 2020 2076 203d 206e 702e 6172 7261  .    v = np.arra
-00018810: 7928 0a20 2020 2020 2020 205b 0a20 2020  y(.        [.   
-00018820: 2020 2020 2020 2020 205f 6d69 6372 6f73           _micros
-00018830: 7472 6970 5f76 5f77 6974 685f 4c6b 280a  trip_v_with_Lk(.
-00018840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018850: 7720 2a20 3165 2d36 2c20 6469 656c 6563  w * 1e-6, dielec
-00018860: 7472 6963 5f74 6869 636b 6e65 7373 202a  tric_thickness *
-00018870: 2031 652d 362c 2065 7073 5f72 2c20 4c6b   1e-6, eps_r, Lk
-00018880: 5f70 6572 5f73 710a 2020 2020 2020 2020  _per_sq.        
-00018890: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-000188a0: 2020 666f 7220 7720 696e 2077 6964 7468    for w in width
-000188b0: 730a 2020 2020 2020 2020 5d0a 2020 2020  s.        ].    
-000188c0: 290a 2020 2020 6478 203d 206e 702e 6469  ).    dx = np.di
-000188d0: 6666 2878 290a 2020 2020 6478 5f63 6f6d  ff(x).    dx_com
-000188e0: 7065 6e73 6174 6564 203d 2064 7820 2a20  pensated = dx * 
-000188f0: 765b 3a2d 315d 0a20 2020 2078 5f63 6f6d  v[:-1].    x_com
-00018900: 7065 6e73 6174 6564 203d 206e 702e 6375  pensated = np.cu
-00018910: 6d73 756d 2864 785f 636f 6d70 656e 7361  msum(dx_compensa
-00018920: 7465 6429 0a20 2020 2078 203d 206e 702e  ted).    x = np.
-00018930: 6873 7461 636b 285b 302c 2078 5f63 6f6d  hstack([0, x_com
-00018940: 7065 6e73 6174 6564 5d29 202f 206d 6178  pensated]) / max
-00018950: 2878 5f63 6f6d 7065 6e73 6174 6564 2920  (x_compensated) 
-00018960: 2a20 6c65 6e67 7468 0a0a 2020 2020 2320  * length..    # 
-00018970: 4372 6561 7465 2062 6c61 6e6b 2064 6576  Create blank dev
-00018980: 6963 6520 616e 6420 6164 6420 7461 7065  ice and add tape
-00018990: 7220 706f 6c79 676f 6e0a 2020 2020 4420  r polygon.    D 
-000189a0: 3d20 4465 7669 6365 2822 6865 636b 656e  = Device("hecken
-000189b0: 2229 0a20 2020 2078 7074 7320 3d20 6e70  ").    xpts = np
-000189c0: 2e63 6f6e 6361 7465 6e61 7465 285b 782c  .concatenate([x,
-000189d0: 2078 5b3a 3a2d 315d 5d29 0a20 2020 2079   x[::-1]]).    y
-000189e0: 7074 7320 3d20 6e70 2e63 6f6e 6361 7465  pts = np.concate
-000189f0: 6e61 7465 285b 7769 6474 6873 202f 2032  nate([widths / 2
-00018a00: 2c20 2d77 6964 7468 735b 3a3a 2d31 5d20  , -widths[::-1] 
-00018a10: 2f20 325d 290a 2020 2020 442e 6164 645f  / 2]).    D.add_
-00018a20: 706f 6c79 676f 6e28 2878 7074 732c 2079  polygon((xpts, y
-00018a30: 7074 7329 2c20 6c61 7965 723d 6c61 7965  pts), layer=laye
-00018a40: 7229 0a20 2020 2044 2e61 6464 5f70 6f72  r).    D.add_por
-00018a50: 7428 6e61 6d65 3d31 2c20 6d69 6470 6f69  t(name=1, midpoi
-00018a60: 6e74 3d28 302c 2030 292c 2077 6964 7468  nt=(0, 0), width
-00018a70: 3d77 6964 7468 735b 305d 2c20 6f72 6965  =widths[0], orie
-00018a80: 6e74 6174 696f 6e3d 3138 3029 0a20 2020  ntation=180).   
-00018a90: 2044 2e61 6464 5f70 6f72 7428 6e61 6d65   D.add_port(name
-00018aa0: 3d32 2c20 6d69 6470 6f69 6e74 3d28 6c65  =2, midpoint=(le
-00018ab0: 6e67 7468 2c20 3029 2c20 7769 6474 683d  ngth, 0), width=
-00018ac0: 7769 6474 6873 5b2d 315d 2c20 6f72 6965  widths[-1], orie
-00018ad0: 6e74 6174 696f 6e3d 3029 0a0a 2020 2020  ntation=0)..    
-00018ae0: 2320 4164 6420 6d65 7461 2069 6e66 6f72  # Add meta infor
-00018af0: 6d61 7469 6f6e 2061 626f 7574 2074 6865  mation about the
-00018b00: 2074 6170 6572 0a20 2020 2044 2e69 6e66   taper.    D.inf
-00018b10: 6f5b 226e 756d 5f73 7175 6172 6573 225d  o["num_squares"]
-00018b20: 203d 206e 702e 7375 6d28 6e70 2e64 6966   = np.sum(np.dif
-00018b30: 6628 7829 202f 2077 6964 7468 735b 3a2d  f(x) / widths[:-
-00018b40: 315d 290a 2020 2020 442e 696e 666f 5b22  1]).    D.info["
-00018b50: 7769 6474 6831 225d 203d 2077 6964 7468  width1"] = width
-00018b60: 735b 305d 0a20 2020 2044 2e69 6e66 6f5b  s[0].    D.info[
-00018b70: 2277 6964 7468 3222 5d20 3d20 7769 6474  "width2"] = widt
-00018b80: 6873 5b2d 315d 0a20 2020 2044 2e69 6e66  hs[-1].    D.inf
-00018b90: 6f5b 225a 3122 5d20 3d20 5a5b 305d 0a20  o["Z1"] = Z[0]. 
-00018ba0: 2020 2044 2e69 6e66 6f5b 225a 3222 5d20     D.info["Z2"] 
-00018bb0: 3d20 5a5b 2d31 5d0a 2020 2020 2320 4e6f  = Z[-1].    # No
-00018bc0: 7465 2074 6865 7265 2061 7265 2074 776f  te there are two
-00018bd0: 2076 616c 7565 7320 666f 7220 762f 6320   values for v/c 
-00018be0: 2861 6e64 2066 5f63 7574 6f66 6629 2062  (and f_cutoff) b
-00018bf0: 6563 6175 7365 2074 6865 2073 7065 6564  ecause the speed
-00018c00: 206f 660a 2020 2020 2320 6c69 6768 7420   of.    # light 
-00018c10: 6973 2064 6966 6665 7265 6e74 2061 7420  is different at 
-00018c20: 7468 6520 6265 6769 6e6e 696e 6720 616e  the beginning an
-00018c30: 6420 656e 6420 6f66 2074 6865 2074 6170  d end of the tap
-00018c40: 6572 0a20 2020 2044 2e69 6e66 6f5b 2277  er.    D.info["w
-00018c50: 225d 203d 2077 6964 7468 730a 2020 2020  "] = widths.    
-00018c60: 442e 696e 666f 5b22 7822 5d20 3d20 780a  D.info["x"] = x.
-00018c70: 2020 2020 442e 696e 666f 5b22 5a22 5d20      D.info["Z"] 
-00018c80: 3d20 5a0a 2020 2020 442e 696e 666f 5b22  = Z.    D.info["
-00018c90: 762f 6322 5d20 3d20 7620 2f20 3365 380a  v/c"] = v / 3e8.
-00018ca0: 2020 2020 442e 696e 666f 5b22 7469 6d65      D.info["time
-00018cb0: 5f6c 656e 6774 6822 5d20 3d20 6e70 2e73  _length"] = np.s
-00018cc0: 756d 280a 2020 2020 2020 2020 6e70 2e64  um(.        np.d
-00018cd0: 6966 6628 442e 696e 666f 5b22 7822 5d20  iff(D.info["x"] 
-00018ce0: 2a20 3165 2d36 2920 2f20 2844 2e69 6e66  * 1e-6) / (D.inf
-00018cf0: 6f5b 2276 2f63 225d 5b3a 2d31 5d20 2a20  o["v/c"][:-1] * 
-00018d00: 3365 3829 0a20 2020 2029 0a20 2020 2044  3e8).    ).    D
-00018d10: 2e69 6e66 6f5b 2266 5f63 7574 6f66 6622  .info["f_cutoff"
-00018d20: 5d20 3d20 3120 2f20 2832 202a 2044 2e69  ] = 1 / (2 * D.i
-00018d30: 6e66 6f5b 2274 696d 655f 6c65 6e67 7468  nfo["time_length
-00018d40: 225d 290a 2020 2020 442e 696e 666f 5b22  "]).    D.info["
-00018d50: 6c65 6e67 7468 225d 203d 206c 656e 6774  length"] = lengt
-00018d60: 680a 0a20 2020 2072 6574 7572 6e20 440a  h..    return D.
-00018d70: 0a0a 4064 6576 6963 655f 6c72 755f 6361  ..@device_lru_ca
-00018d80: 6368 650a 6465 6620 6d65 616e 6465 725f  che.def meander_
-00018d90: 7461 7065 7228 0a20 2020 2078 5f74 6170  taper(.    x_tap
-00018da0: 6572 2c20 775f 7461 7065 722c 206d 6561  er, w_taper, mea
-00018db0: 6e64 6572 5f6c 656e 6774 683d 3130 3030  nder_length=1000
-00018dc0: 2c20 7370 6163 696e 675f 6661 6374 6f72  , spacing_factor
-00018dd0: 3d33 2c20 6d69 6e5f 7370 6163 696e 673d  =3, min_spacing=
-00018de0: 302e 352c 206c 6179 6572 3d30 0a29 3a0a  0.5, layer=0.):.
-00018df0: 2020 2020 2222 2254 616b 6573 2069 6e20      """Takes in 
-00018e00: 616e 2061 7272 6179 206f 6620 782d 706f  an array of x-po
-00018e10: 7369 7469 6f6e 7320 616e 6420 6120 6172  sitions and a ar
-00018e20: 7261 7920 6f66 2077 6964 7468 7320 2863  ray of widths (c
-00018e30: 6f72 7265 7370 6f6e 6469 6e67 2074 6f0a  orresponding to.
-00018e40: 2020 2020 6561 6368 2078 2d70 6f73 6974      each x-posit
-00018e50: 696f 6e29 2061 6e64 2063 7265 6174 6573  ion) and creates
-00018e60: 2061 206d 6561 6e64 6572 2e20 2054 7970   a meander.  Typ
-00018e70: 6963 616c 6c79 2075 7365 6420 666f 7220  ically used for 
-00018e80: 6372 6561 7469 6e67 0a20 2020 206d 6561  creating.    mea
-00018e90: 6e64 6572 6564 2074 6170 6572 730a 0a20  ndered tapers.. 
-00018ea0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-00018eb0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-00018ec0: 2078 5f74 6170 6572 203a 2061 7272 6179   x_taper : array
-00018ed0: 2d6c 696b 655b 4e5d 0a20 2020 2020 2020  -like[N].       
-00018ee0: 2054 6865 2078 2d63 6f6f 7264 696e 6174   The x-coordinat
-00018ef0: 6573 206f 6620 7468 6520 6461 7461 2070  es of the data p
-00018f00: 6f69 6e74 732c 206d 7573 7420 6265 2069  oints, must be i
-00018f10: 6e63 7265 6173 696e 672e 0a20 2020 2077  ncreasing..    w
-00018f20: 5f74 6170 6572 203a 2061 7272 6179 2d6c  _taper : array-l
-00018f30: 696b 655b 4e5d 0a20 2020 2020 2020 2054  ike[N].        T
-00018f40: 6865 2079 2d63 6f6f 7264 696e 6174 6573  he y-coordinates
-00018f50: 206f 6620 7468 6520 6461 7461 2070 6f69   of the data poi
-00018f60: 6e74 732c 2073 616d 6520 6c65 6e67 7468  nts, same length
-00018f70: 2061 7320 6060 785f 7461 7065 7260 602e   as ``x_taper``.
-00018f80: 0a20 2020 206d 6561 6e64 6572 5f6c 656e  .    meander_len
-00018f90: 6774 6820 3a20 696e 7420 6f72 2066 6c6f  gth : int or flo
-00018fa0: 6174 0a20 2020 2020 2020 204c 656e 6774  at.        Lengt
-00018fb0: 6820 6f66 2065 6163 6820 7365 6374 696f  h of each sectio
-00018fc0: 6e20 6f66 2074 6865 206d 6561 6e64 6572  n of the meander
-00018fd0: 0a20 2020 2073 7061 6369 6e67 5f66 6163  .    spacing_fac
-00018fe0: 746f 7220 3a20 696e 7420 6f72 2066 6c6f  tor : int or flo
-00018ff0: 6174 0a20 2020 2020 2020 204d 756c 7469  at.        Multi
-00019000: 706c 6963 6174 6976 6520 7370 6163 696e  plicative spacin
-00019010: 6720 6661 6374 6f72 2062 6574 7765 656e  g factor between
-00019020: 2061 646a 6163 656e 7420 6d65 616e 6465   adjacent meande
-00019030: 7273 0a20 2020 206d 696e 5f73 7061 6369  rs.    min_spaci
-00019040: 6e67 203a 2069 6e74 206f 7220 666c 6f61  ng : int or floa
-00019050: 740a 2020 2020 2020 2020 4d69 6e69 6d75  t.        Minimu
-00019060: 6d20 7370 6163 696e 6720 6265 7477 6565  m spacing betwee
-00019070: 6e20 6164 6a61 6365 6e74 206d 6561 6e64  n adjacent meand
-00019080: 6572 730a 0a20 2020 206c 6179 6572 203a  ers..    layer :
-00019090: 2069 6e74 2c20 6172 7261 792d 6c69 6b65   int, array-like
-000190a0: 5b32 5d2c 206f 7220 7365 740a 2020 2020  [2], or set.    
-000190b0: 2020 2020 5370 6563 6966 6963 206c 6179      Specific lay
-000190c0: 6572 2873 2920 746f 2070 7574 2070 6f6c  er(s) to put pol
-000190d0: 7967 6f6e 2067 656f 6d65 7472 7920 6f6e  ygon geometry on
-000190e0: 2e0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
-000190f0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2044     -------.    D
-00019100: 203a 2044 6576 6963 650a 0a20 2020 2022   : Device..    "
-00019110: 2222 0a0a 2020 2020 6465 6620 7461 7065  ""..    def tape
-00019120: 725f 7769 6474 6828 7829 3a0a 2020 2020  r_width(x):.    
-00019130: 2020 2020 7265 7475 726e 206e 702e 696e      return np.in
-00019140: 7465 7270 2878 2c20 785f 7461 7065 722c  terp(x, x_taper,
-00019150: 2077 5f74 6170 6572 290a 0a20 2020 2064   w_taper)..    d
-00019160: 6566 2074 6170 6572 5f73 6563 7469 6f6e  ef taper_section
-00019170: 2878 5f73 7461 7274 2c20 785f 656e 642c  (x_start, x_end,
-00019180: 206e 756d 5f70 7473 3d33 302c 206c 6179   num_pts=30, lay
-00019190: 6572 3d30 293a 0a20 2020 2020 2020 2044  er=0):.        D
-000191a0: 203d 2044 6576 6963 6528 2274 6170 6572   = Device("taper
-000191b0: 7365 6322 290a 2020 2020 2020 2020 6c65  sec").        le
-000191c0: 6e67 7468 203d 2078 5f65 6e64 202d 2078  ngth = x_end - x
-000191d0: 5f73 7461 7274 0a20 2020 2020 2020 2078  _start.        x
-000191e0: 203d 206e 702e 6c69 6e73 7061 6365 2830   = np.linspace(0
-000191f0: 2c20 6c65 6e67 7468 2c20 6e75 6d5f 7074  , length, num_pt
-00019200: 7329 0a20 2020 2020 2020 2077 6964 7468  s).        width
-00019210: 7320 3d20 6e70 2e6c 696e 7370 6163 6528  s = np.linspace(
-00019220: 7461 7065 725f 7769 6474 6828 785f 7374  taper_width(x_st
-00019230: 6172 7429 2c20 7461 7065 725f 7769 6474  art), taper_widt
-00019240: 6828 785f 656e 6429 2c20 6e75 6d5f 7074  h(x_end), num_pt
-00019250: 7329 0a20 2020 2020 2020 2078 7074 7320  s).        xpts 
-00019260: 3d20 6e70 2e63 6f6e 6361 7465 6e61 7465  = np.concatenate
-00019270: 285b 782c 2078 5b3a 3a2d 315d 5d29 0a20  ([x, x[::-1]]). 
-00019280: 2020 2020 2020 2079 7074 7320 3d20 6e70         ypts = np
-00019290: 2e63 6f6e 6361 7465 6e61 7465 285b 7769  .concatenate([wi
-000192a0: 6474 6873 202f 2032 2c20 2d77 6964 7468  dths / 2, -width
-000192b0: 735b 3a3a 2d31 5d20 2f20 325d 290a 2020  s[::-1] / 2]).  
-000192c0: 2020 2020 2020 442e 6164 645f 706f 6c79        D.add_poly
-000192d0: 676f 6e28 2878 7074 732c 2079 7074 7329  gon((xpts, ypts)
-000192e0: 2c20 6c61 7965 723d 6c61 7965 7229 0a20  , layer=layer). 
-000192f0: 2020 2020 2020 2044 2e61 6464 5f70 6f72         D.add_por
-00019300: 7428 6e61 6d65 3d31 2c20 6d69 6470 6f69  t(name=1, midpoi
-00019310: 6e74 3d28 302c 2030 292c 2077 6964 7468  nt=(0, 0), width
-00019320: 3d77 6964 7468 735b 305d 2c20 6f72 6965  =widths[0], orie
-00019330: 6e74 6174 696f 6e3d 3138 3029 0a20 2020  ntation=180).   
-00019340: 2020 2020 2044 2e61 6464 5f70 6f72 7428       D.add_port(
-00019350: 6e61 6d65 3d32 2c20 6d69 6470 6f69 6e74  name=2, midpoint
-00019360: 3d28 6c65 6e67 7468 2c20 3029 2c20 7769  =(length, 0), wi
-00019370: 6474 683d 7769 6474 6873 5b2d 315d 2c20  dth=widths[-1], 
-00019380: 6f72 6965 6e74 6174 696f 6e3d 3029 0a20  orientation=0). 
-00019390: 2020 2020 2020 2072 6574 7572 6e20 440a         return D.
-000193a0: 0a20 2020 2064 6566 2061 7263 5f74 6170  .    def arc_tap
-000193b0: 6572 6564 280a 2020 2020 2020 2020 7261  ered(.        ra
-000193c0: 6469 7573 3d31 302c 2077 6964 7468 313d  dius=10, width1=
-000193d0: 312c 2077 6964 7468 323d 322c 2074 6865  1, width2=2, the
-000193e0: 7461 3d34 352c 2061 6e67 6c65 5f72 6573  ta=45, angle_res
-000193f0: 6f6c 7574 696f 6e3d 322e 352c 206c 6179  olution=2.5, lay
-00019400: 6572 3d30 0a20 2020 2029 3a0a 2020 2020  er=0.    ):.    
-00019410: 2020 2020 4420 3d20 4465 7669 6365 2822      D = Device("
-00019420: 6172 6374 6170 6572 2229 0a20 2020 2020  arctaper").     
-00019430: 2020 2070 6174 6831 203d 2067 6473 7079     path1 = gdspy
-00019440: 2e50 6174 6828 7769 6474 683d 7769 6474  .Path(width=widt
-00019450: 6831 2c20 696e 6974 6961 6c5f 706f 696e  h1, initial_poin
-00019460: 743d 2830 2c20 3029 290a 2020 2020 2020  t=(0, 0)).      
-00019470: 2020 7061 7468 312e 7475 726e 280a 2020    path1.turn(.  
-00019480: 2020 2020 2020 2020 2020 7261 6469 7573            radius
-00019490: 3d72 6164 6975 732c 0a20 2020 2020 2020  =radius,.       
-000194a0: 2020 2020 2061 6e67 6c65 3d74 6865 7461       angle=theta
-000194b0: 202a 2070 6920 2f20 3138 302c 0a20 2020   * pi / 180,.   
-000194c0: 2020 2020 2020 2020 206e 756d 6265 725f           number_
-000194d0: 6f66 5f70 6f69 6e74 733d 696e 7428 6162  of_points=int(ab
-000194e0: 7328 3220 2a20 7468 6574 6120 2f20 616e  s(2 * theta / an
-000194f0: 676c 655f 7265 736f 6c75 7469 6f6e 2929  gle_resolution))
-00019500: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
-00019510: 6e61 6c5f 7769 6474 683d 7769 6474 6832  nal_width=width2
-00019520: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00019530: 2020 2020 5b44 2e61 6464 5f70 6f6c 7967      [D.add_polyg
-00019540: 6f6e 2870 2c20 6c61 7965 723d 6c61 7965  on(p, layer=laye
-00019550: 7229 2066 6f72 2070 2069 6e20 7061 7468  r) for p in path
-00019560: 312e 706f 6c79 676f 6e73 5d0a 2020 2020  1.polygons].    
-00019570: 2020 2020 442e 6164 645f 706f 7274 286e      D.add_port(n
-00019580: 616d 653d 312c 206d 6964 706f 696e 743d  ame=1, midpoint=
-00019590: 2830 2c20 3029 2c20 7769 6474 683d 7769  (0, 0), width=wi
-000195a0: 6474 6831 2c20 6f72 6965 6e74 6174 696f  dth1, orientatio
-000195b0: 6e3d 3138 3029 0a20 2020 2020 2020 2044  n=180).        D
-000195c0: 2e61 6464 5f70 6f72 7428 0a20 2020 2020  .add_port(.     
-000195d0: 2020 2020 2020 206e 616d 653d 322c 0a20         name=2,. 
-000195e0: 2020 2020 2020 2020 2020 206d 6964 706f             midpo
-000195f0: 696e 743d 2870 6174 6831 2e78 2c20 7061  int=(path1.x, pa
-00019600: 7468 312e 7929 2c0a 2020 2020 2020 2020  th1.y),.        
-00019610: 2020 2020 7769 6474 683d 7769 6474 6832      width=width2
-00019620: 2c0a 2020 2020 2020 2020 2020 2020 6f72  ,.            or
-00019630: 6965 6e74 6174 696f 6e3d 7061 7468 312e  ientation=path1.
-00019640: 6469 7265 6374 696f 6e20 2a20 3138 3020  direction * 180 
-00019650: 2f20 7069 2c0a 2020 2020 2020 2020 290a  / pi,.        ).
-00019660: 2020 2020 2020 2020 7265 7475 726e 2044          return D
-00019670: 0a0a 2020 2020 4420 3d20 4465 7669 6365  ..    D = Device
-00019680: 2822 6d65 616e 6465 722d 7461 7065 7222  ("meander-taper"
-00019690: 290a 2020 2020 7870 6f73 3120 3d20 6d69  ).    xpos1 = mi
-000196a0: 6e28 785f 7461 7065 7229 0a20 2020 2078  n(x_taper).    x
-000196b0: 706f 7332 203d 206d 696e 2878 5f74 6170  pos2 = min(x_tap
-000196c0: 6572 2920 2b20 6d65 616e 6465 725f 6c65  er) + meander_le
-000196d0: 6e67 7468 0a20 2020 2074 203d 2044 2e61  ngth.    t = D.a
-000196e0: 6464 5f72 6566 2874 6170 6572 5f73 6563  dd_ref(taper_sec
-000196f0: 7469 6f6e 2878 5f73 7461 7274 3d78 706f  tion(x_start=xpo
-00019700: 7331 2c20 785f 656e 643d 7870 6f73 322c  s1, x_end=xpos2,
-00019710: 206e 756d 5f70 7473 3d35 302c 206c 6179   num_pts=50, lay
-00019720: 6572 3d6c 6179 6572 2929 0a20 2020 2044  er=layer)).    D
-00019730: 2e61 6464 5f70 6f72 7428 742e 706f 7274  .add_port(t.port
-00019740: 735b 315d 290a 2020 2020 6469 725f 746f  s[1]).    dir_to
-00019750: 6767 6c65 203d 202d 310a 2020 2020 7768  ggle = -1.    wh
-00019760: 696c 6520 7870 6f73 3220 3c20 6d61 7828  ile xpos2 < max(
-00019770: 785f 7461 7065 7229 3a0a 2020 2020 2020  x_taper):.      
-00019780: 2020 6172 635f 7769 6474 6831 203d 2074    arc_width1 = t
-00019790: 6170 6572 5f77 6964 7468 2878 706f 7332  aper_width(xpos2
-000197a0: 290a 2020 2020 2020 2020 6172 635f 7261  ).        arc_ra
-000197b0: 6469 7573 203d 206d 6178 2873 7061 6369  dius = max(spaci
-000197c0: 6e67 5f66 6163 746f 7220 2a20 6172 635f  ng_factor * arc_
-000197d0: 7769 6474 6831 2c20 6d69 6e5f 7370 6163  width1, min_spac
-000197e0: 696e 6729 0a20 2020 2020 2020 2061 7263  ing).        arc
-000197f0: 5f6c 656e 6774 6820 3d20 7069 202a 2061  _length = pi * a
-00019800: 7263 5f72 6164 6975 730a 2020 2020 2020  rc_radius.      
-00019810: 2020 6172 635f 7769 6474 6832 203d 2074    arc_width2 = t
-00019820: 6170 6572 5f77 6964 7468 2878 706f 7332  aper_width(xpos2
-00019830: 202b 2061 7263 5f6c 656e 6774 6829 0a20   + arc_length). 
-00019840: 2020 2020 2020 2041 203d 2061 7263 5f74         A = arc_t
-00019850: 6170 6572 6564 280a 2020 2020 2020 2020  apered(.        
-00019860: 2020 2020 7261 6469 7573 3d61 7263 5f72      radius=arc_r
-00019870: 6164 6975 732c 0a20 2020 2020 2020 2020  adius,.         
-00019880: 2020 2077 6964 7468 313d 6172 635f 7769     width1=arc_wi
-00019890: 6474 6831 2c0a 2020 2020 2020 2020 2020  dth1,.          
-000198a0: 2020 7769 6474 6832 3d61 7263 5f77 6964    width2=arc_wid
-000198b0: 7468 322c 0a20 2020 2020 2020 2020 2020  th2,.           
-000198c0: 2074 6865 7461 3d31 3830 202a 2064 6972   theta=180 * dir
-000198d0: 5f74 6f67 676c 652c 0a20 2020 2020 2020  _toggle,.       
-000198e0: 2020 2020 206c 6179 6572 3d6c 6179 6572       layer=layer
-000198f0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00019900: 2020 2020 6120 3d20 442e 6164 645f 7265      a = D.add_re
-00019910: 6628 4129 0a20 2020 2020 2020 2061 2e63  f(A).        a.c
-00019920: 6f6e 6e65 6374 2870 6f72 743d 312c 2064  onnect(port=1, d
-00019930: 6573 7469 6e61 7469 6f6e 3d74 2e70 6f72  estination=t.por
-00019940: 7473 5b32 5d29 0a20 2020 2020 2020 2064  ts[2]).        d
-00019950: 6972 5f74 6f67 676c 6520 3d20 2d64 6972  ir_toggle = -dir
-00019960: 5f74 6f67 676c 650a 2020 2020 2020 2020  _toggle.        
-00019970: 7870 6f73 3120 3d20 7870 6f73 3220 2b20  xpos1 = xpos2 + 
-00019980: 6172 635f 6c65 6e67 7468 0a20 2020 2020  arc_length.     
-00019990: 2020 2078 706f 7332 203d 2078 706f 7331     xpos2 = xpos1
-000199a0: 202b 206d 6561 6e64 6572 5f6c 656e 6774   + meander_lengt
-000199b0: 680a 2020 2020 2020 2020 7420 3d20 442e  h.        t = D.
-000199c0: 6164 645f 7265 6628 0a20 2020 2020 2020  add_ref(.       
-000199d0: 2020 2020 2074 6170 6572 5f73 6563 7469       taper_secti
-000199e0: 6f6e 2878 5f73 7461 7274 3d78 706f 7331  on(x_start=xpos1
-000199f0: 2c20 785f 656e 643d 7870 6f73 322c 206e  , x_end=xpos2, n
-00019a00: 756d 5f70 7473 3d33 302c 206c 6179 6572  um_pts=30, layer
-00019a10: 3d6c 6179 6572 290a 2020 2020 2020 2020  =layer).        
-00019a20: 290a 2020 2020 2020 2020 742e 636f 6e6e  ).        t.conn
-00019a30: 6563 7428 706f 7274 3d31 2c20 6465 7374  ect(port=1, dest
-00019a40: 696e 6174 696f 6e3d 612e 706f 7274 735b  ination=a.ports[
-00019a50: 325d 290a 2020 2020 442e 6164 645f 706f  2]).    D.add_po
-00019a60: 7274 2874 2e70 6f72 7473 5b32 5d29 0a0a  rt(t.ports[2])..
-00019a70: 2020 2020 7265 7475 726e 2044 0a0a 0a23      return D...#
-00019a80: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
-00019a90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019aa0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019ab0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019ac0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
-00019ad0: 2320 4578 616d 706c 6520 636f 6465 0a23  # Example code.#
-00019ae0: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
-00019af0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019b00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019b10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019b20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
-00019b30: 0a23 2044 203d 2072 6163 6574 7261 636b  .# D = racetrack
-00019b40: 5f67 7261 6475 616c 2877 6964 7468 2c20  _gradual(width, 
-00019b50: 5220 3d20 352c 204e 3d33 290a 2320 7175  R = 5, N=3).# qu
-00019b60: 6963 6b70 6c6f 7428 4429 0a0a 2320 4420  ickplot(D)..# D 
-00019b70: 3d20 6865 636b 656e 5f74 6170 6572 286c  = hecken_taper(l
-00019b80: 656e 6774 6820 3d20 3230 302c 2042 203d  ength = 200, B =
-00019b90: 2034 2e30 3039 312c 2064 6965 6c65 6374   4.0091, dielect
-00019ba0: 7269 635f 7468 6963 6b6e 6573 7320 3d20  ric_thickness = 
-00019bb0: 302e 3235 2c20 6570 735f 7220 3d20 322c  0.25, eps_r = 2,
-00019bc0: 0a23 2020 2020 2020 2020 2020 2020 2020  .#              
-00019bd0: 2020 2020 4c6b 5f70 6572 5f73 7120 3d20      Lk_per_sq = 
-00019be0: 3235 3065 2d31 322c 205a 3120 3d20 3530  250e-12, Z1 = 50
-00019bf0: 2c20 7769 6474 6832 203d 2030 2e33 2c0a  , width2 = 0.3,.
-00019c00: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-00019c10: 2020 206e 756d 5f70 7473 203d 2031 3030     num_pts = 100
-00019c20: 2c20 6c61 7965 7220 3d20 3029 0a23 2071  , layer = 0).# q
-00019c30: 7569 636b 706c 6f74 2844 290a 0a23 2074  uickplot(D)..# t
-00019c40: 203d 206e 702e 6c69 6e73 7061 6365 2830   = np.linspace(0
-00019c50: 2c31 290a 2320 782c 7920 3d20 5f72 6163  ,1).# x,y = _rac
-00019c60: 6574 7261 636b 5f67 7261 6475 616c 5f70  etrack_gradual_p
-00019c70: 6172 616d 6574 7269 6328 742c 2052 203d  arametric(t, R =
-00019c80: 2035 2c20 4e20 3d20 3329 0a23 2070 6c74   5, N = 3).# plt
-00019c90: 2e70 6c6f 7428 782c 7929 0a23 2070 6c74  .plot(x,y).# plt
-00019ca0: 2e61 7869 7328 2765 7175 616c 2729 0a0a  .axis('equal')..
-00019cb0: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
-00019cc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019cd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019ce0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019cf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019d00: 3d0a 230a 2320 5465 7874 0a23 0a23 203d  =.#.# Text.#.# =
-00019d10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019d20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019d30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019d40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019d50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a0a  =============...
-00019d60: 6465 6620 7465 7874 2874 6578 743d 2261  def text(text="a
-00019d70: 6263 6422 2c20 7369 7a65 3d31 302c 206a  bcd", size=10, j
-00019d80: 7573 7469 6679 3d22 6c65 6674 222c 206c  ustify="left", l
-00019d90: 6179 6572 3d30 2c20 666f 6e74 3d22 4445  ayer=0, font="DE
-00019da0: 504c 4f46 2229 3a0a 2020 2020 2222 2243  PLOF"):.    """C
-00019db0: 7265 6174 6573 2067 656f 6d65 7472 6965  reates geometrie
-00019dc0: 7320 6f66 2074 6578 740a 0a20 2020 2050  s of text..    P
-00019dd0: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-00019de0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2074 6578  --------.    tex
-00019df0: 7420 3a20 7374 720a 2020 2020 2020 2020  t : str.        
-00019e00: 5465 7874 2073 7472 696e 6720 746f 2062  Text string to b
-00019e10: 6520 7772 6974 7465 6e2e 0a20 2020 2073  e written..    s
-00019e20: 697a 6520 3a20 696e 7420 6f72 2066 6c6f  ize : int or flo
-00019e30: 6174 0a20 2020 2020 2020 2053 697a 6520  at.        Size 
-00019e40: 6f66 2074 6865 2074 6578 740a 2020 2020  of the text.    
-00019e50: 6a75 7374 6966 7920 3a20 7b27 6c65 6674  justify : {'left
-00019e60: 272c 2027 7269 6768 7427 2c20 2763 656e  ', 'right', 'cen
-00019e70: 7465 7227 7d0a 2020 2020 2020 2020 4a75  ter'}.        Ju
-00019e80: 7374 6966 6963 6174 696f 6e20 6f66 2074  stification of t
-00019e90: 6865 2074 6578 742e 0a20 2020 206c 6179  he text..    lay
-00019ea0: 6572 203a 2069 6e74 2c20 6172 7261 792d  er : int, array-
-00019eb0: 6c69 6b65 5b32 5d2c 206f 7220 7365 740a  like[2], or set.
-00019ec0: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
-00019ed0: 206c 6179 6572 2873 2920 746f 2070 7574   layer(s) to put
-00019ee0: 2070 6f6c 7967 6f6e 2067 656f 6d65 7472   polygon geometr
-00019ef0: 7920 6f6e 2e0a 2020 2020 666f 6e74 3a20  y on..    font: 
-00019f00: 7374 720a 2020 2020 2020 2020 466f 6e74  str.        Font
-00019f10: 2066 6163 6520 746f 2075 7365 2e20 4465   face to use. De
-00019f20: 6661 756c 7420 4445 504c 4f46 2064 6f65  fault DEPLOF doe
-00019f30: 7320 6e6f 7420 7265 7175 6972 6520 6164  s not require ad
-00019f40: 6469 7469 6f6e 616c 206c 6962 7261 7269  ditional librari
-00019f50: 6573 2c20 6f74 6865 7277 6973 650a 2020  es, otherwise.  
-00019f60: 2020 2020 2020 6672 6565 7479 7065 2077        freetype w
-00019f70: 696c 6c20 6265 2075 7365 6420 746f 206c  ill be used to l
-00019f80: 6f61 6420 666f 6e74 732e 2046 6f6e 7420  oad fonts. Font 
-00019f90: 6361 6e20 6265 2067 6976 656e 2065 6974  can be given eit
-00019fa0: 6865 7220 6279 206e 616d 6520 2865 2e67  her by name (e.g
-00019fb0: 2e20 2254 696d 6573 204e 6577 2052 6f6d  . "Times New Rom
-00019fc0: 616e 2229 2c0a 2020 2020 2020 2020 6f72  an"),.        or
-00019fd0: 2062 7920 6669 6c65 2070 6174 682e 204f   by file path. O
-00019fe0: 5446 206f 7220 5454 4620 666f 6e74 7320  TF or TTF fonts 
-00019ff0: 6172 6520 7375 7070 6f72 7465 642e 0a0a  are supported...
-0001a000: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-0001a010: 2d2d 2d2d 2d2d 2d0a 2020 2020 7420 3a20  -------.    t : 
-0001a020: 4465 7669 6365 0a20 2020 2020 2020 2041  Device.        A
-0001a030: 2044 6576 6963 6520 636f 6e74 6169 6e69   Device containi
-0001a040: 6e67 2074 6865 2074 6578 7420 6765 6f6d  ng the text geom
-0001a050: 6574 7279 2e0a 2020 2020 2222 220a 2020  etry..    """.  
-0001a060: 2020 7420 3d20 4465 7669 6365 2822 7465    t = Device("te
-0001a070: 7874 2229 0a20 2020 2078 6f66 6673 6574  xt").    xoffset
-0001a080: 203d 2030 0a20 2020 2079 6f66 6673 6574   = 0.    yoffset
-0001a090: 203d 2030 0a0a 2020 2020 6661 6365 203d   = 0..    face =
-0001a0a0: 2066 6f6e 740a 2020 2020 6966 2066 6163   font.    if fac
-0001a0b0: 6520 3d3d 2022 4445 504c 4f46 223a 0a20  e == "DEPLOF":. 
-0001a0c0: 2020 2020 2020 2073 6361 6c69 6e67 203d         scaling =
-0001a0d0: 2073 697a 6520 2f20 3130 3030 0a0a 2020   size / 1000..  
-0001a0e0: 2020 2020 2020 666f 7220 6c69 6e65 2069        for line i
-0001a0f0: 6e20 7465 7874 2e73 706c 6974 2822 5c6e  n text.split("\n
-0001a100: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-0001a110: 6c20 3d20 4465 7669 6365 286e 616d 653d  l = Device(name=
-0001a120: 2274 6578 746c 696e 6522 290a 2020 2020  "textline").    
-0001a130: 2020 2020 2020 2020 666f 7220 6320 696e          for c in
-0001a140: 206c 696e 653a 0a20 2020 2020 2020 2020   line:.         
-0001a150: 2020 2020 2020 2061 7363 6969 5f76 616c         ascii_val
-0001a160: 203d 206f 7264 2863 290a 2020 2020 2020   = ord(c).      
-0001a170: 2020 2020 2020 2020 2020 6966 2063 203d            if c =
-0001a180: 3d20 2220 223a 0a20 2020 2020 2020 2020  = " ":.         
-0001a190: 2020 2020 2020 2020 2020 2078 6f66 6673             xoffs
-0001a1a0: 6574 202b 3d20 3530 3020 2a20 7363 616c  et += 500 * scal
-0001a1b0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-0001a1c0: 2020 2020 656c 6966 2028 3333 203c 3d20      elif (33 <= 
-0001a1d0: 6173 6369 695f 7661 6c20 3c3d 2031 3236  ascii_val <= 126
-0001a1e0: 2920 6f72 2028 6173 6369 695f 7661 6c20  ) or (ascii_val 
-0001a1f0: 3d3d 2031 3831 293a 0a20 2020 2020 2020  == 181):.       
-0001a200: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0001a210: 2070 6f6c 7920 696e 205f 676c 7970 685b   poly in _glyph[
-0001a220: 6173 6369 695f 7661 6c5d 3a0a 2020 2020  ascii_val]:.    
-0001a230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a240: 2020 2020 7870 7473 203d 206e 702e 6172      xpts = np.ar
-0001a250: 7261 7928 706f 6c79 295b 3a2c 2030 5d20  ray(poly)[:, 0] 
-0001a260: 2a20 7363 616c 696e 670a 2020 2020 2020  * scaling.      
-0001a270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a280: 2020 7970 7473 203d 206e 702e 6172 7261    ypts = np.arra
-0001a290: 7928 706f 6c79 295b 3a2c 2031 5d20 2a20  y(poly)[:, 1] * 
-0001a2a0: 7363 616c 696e 670a 2020 2020 2020 2020  scaling.        
-0001a2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2c0: 6c2e 6164 645f 706f 6c79 676f 6e28 5b78  l.add_polygon([x
-0001a2d0: 7074 7320 2b20 786f 6666 7365 742c 2079  pts + xoffset, y
-0001a2e0: 7074 7320 2b20 796f 6666 7365 745d 2c20  pts + yoffset], 
-0001a2f0: 6c61 7965 723d 6c61 7965 7229 0a20 2020  layer=layer).   
-0001a300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a310: 2078 6f66 6673 6574 202b 3d20 285f 7769   xoffset += (_wi
-0001a320: 6474 685b 6173 6369 695f 7661 6c5d 202b  dth[ascii_val] +
-0001a330: 205f 696e 6465 6e74 5b61 7363 6969 5f76   _indent[ascii_v
-0001a340: 616c 5d29 202a 2073 6361 6c69 6e67 0a20  al]) * scaling. 
-0001a350: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0001a360: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0001a370: 2020 2020 2020 2020 2076 616c 6964 5f63           valid_c
-0001a380: 6861 7273 203d 2022 215c 2223 2425 2627  hars = "!\"#$%&'
-0001a390: 2829 2a2b 2c2d 2e2f 3031 3233 3435 3637  ()*+,-./01234567
-0001a3a0: 3839 3a3b 3c3d 3e3f 4041 4243 4445 4647  89:;<=>?@ABCDEFG
-0001a3b0: 4849 4a4b 4c4d 4e4f 5051 5253 5455 5657  HIJKLMNOPQRSTUVW
-0001a3c0: 5859 5a5b 5c5c 5d5e 5f60 6162 6364 6566  XYZ[\\]^_`abcdef
-0001a3d0: 6768 696a 6b6c 6d6e 6f70 7172 7374 7576  ghijklmnopqrstuv
-0001a3e0: 7778 797a 7b7c 7d7e c2b5 220a 2020 2020  wxyz{|}~..".    
-0001a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a400: 7761 726e 696e 6773 2e77 6172 6e28 0a20  warnings.warn(. 
-0001a410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a420: 2020 2020 2020 2027 5b50 4849 444c 5d20         '[PHIDL] 
-0001a430: 7465 7874 2829 3a20 5761 726e 696e 672c  text(): Warning,
-0001a440: 2073 6f6d 6520 6368 6172 6163 7465 7273   some characters
-0001a450: 2069 676e 6f72 6564 2c20 6e6f 2067 656f   ignored, no geo
-0001a460: 6d65 7472 7920 666f 7220 6368 6172 6163  metry for charac
-0001a470: 7465 7220 2225 7322 2077 6974 6820 6173  ter "%s" with as
-0001a480: 6369 6920 7661 6c75 6520 2573 2e20 270a  cii value %s. '.
-0001a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a4a0: 2020 2020 2020 2020 2256 616c 6964 2063          "Valid c
-0001a4b0: 6861 7261 6374 6572 733a 2025 7322 0a20  haracters: %s". 
-0001a4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a4d0: 2020 2020 2020 2025 2028 6368 7228 6173         % (chr(as
-0001a4e0: 6369 695f 7661 6c29 2c20 6173 6369 695f  cii_val), ascii_
-0001a4f0: 7661 6c2c 2076 616c 6964 5f63 6861 7273  val, valid_chars
-0001a500: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001a510: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001a520: 2020 2020 742e 6164 645f 7265 6628 6c29      t.add_ref(l)
-0001a530: 0a20 2020 2020 2020 2020 2020 2079 6f66  .            yof
-0001a540: 6673 6574 202d 3d20 3135 3030 202a 2073  fset -= 1500 * s
-0001a550: 6361 6c69 6e67 0a20 2020 2020 2020 2020  caling.         
-0001a560: 2020 2078 6f66 6673 6574 203d 2030 0a20     xoffset = 0. 
-0001a570: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001a580: 2066 726f 6d20 2e66 6f6e 7420 696d 706f   from .font impo
-0001a590: 7274 205f 6765 745f 666f 6e74 5f62 795f  rt _get_font_by_
-0001a5a0: 6669 6c65 2c20 5f67 6574 5f66 6f6e 745f  file, _get_font_
-0001a5b0: 6279 5f6e 616d 652c 205f 6765 745f 676c  by_name, _get_gl
-0001a5c0: 7970 680a 0a20 2020 2020 2020 2023 204c  yph..        # L
-0001a5d0: 6f61 6420 7468 6520 666f 6e74 0a20 2020  oad the font.   
-0001a5e0: 2020 2020 2023 2049 6620 7765 2776 6520       # If we've 
-0001a5f0: 7061 7373 6564 2061 2076 616c 6964 2066  passed a valid f
-0001a600: 696c 652c 2074 7279 2074 6f20 6c6f 6164  ile, try to load
-0001a610: 2074 6861 742c 206f 7468 6572 7769 7365   that, otherwise
-0001a620: 2073 6561 7263 6820 7379 7374 656d 2066   search system f
-0001a630: 6f6e 7473 0a20 2020 2020 2020 2066 6f6e  onts.        fon
-0001a640: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
-0001a650: 2069 6620 2866 6163 652e 656e 6473 7769   if (face.endswi
-0001a660: 7468 2822 2e6f 7466 2229 206f 7220 6661  th(".otf") or fa
-0001a670: 6365 2e65 6e64 7377 6974 6828 222e 7474  ce.endswith(".tt
-0001a680: 6622 2929 2061 6e64 206f 732e 7061 7468  f")) and os.path
-0001a690: 2e65 7869 7374 7328 6661 6365 293a 0a20  .exists(face):. 
-0001a6a0: 2020 2020 2020 2020 2020 2066 6f6e 7420             font 
-0001a6b0: 3d20 5f67 6574 5f66 6f6e 745f 6279 5f66  = _get_font_by_f
-0001a6c0: 696c 6528 6661 6365 290a 2020 2020 2020  ile(face).      
-0001a6d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001a6e0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0001a6f0: 2020 2020 2020 2020 2066 6f6e 7420 3d20           font = 
-0001a700: 5f67 6574 5f66 6f6e 745f 6279 5f6e 616d  _get_font_by_nam
-0001a710: 6528 6661 6365 290a 2020 2020 2020 2020  e(face).        
-0001a720: 2020 2020 6578 6365 7074 2056 616c 7565      except Value
-0001a730: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-0001a740: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-0001a750: 2020 2020 6966 2066 6f6e 7420 6973 204e      if font is N
-0001a760: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001a770: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-0001a780: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-0001a790: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
-0001a7a0: 2020 2020 2020 2020 2027 5b50 4849 444c           '[PHIDL
-0001a7b0: 5d20 4661 696c 6564 2074 6f20 6669 6e64  ] Failed to find
-0001a7c0: 2066 6f6e 743a 2022 2573 222e 2027 0a20   font: "%s". '. 
-0001a7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a7e0: 2020 202b 2022 5472 7920 7370 6563 6966     + "Try specif
-0001a7f0: 7969 6e67 2074 6865 2065 7861 6374 2028  ying the exact (
-0001a800: 6675 6c6c 2920 7061 7468 2074 6f20 7468  full) path to th
-0001a810: 6520 2e74 7466 206f 7220 2e6f 7466 2066  e .ttf or .otf f
-0001a820: 696c 652e 2022 0a20 2020 2020 2020 2020  ile. ".         
-0001a830: 2020 2020 2020 2020 2020 202b 2022 4f74             + "Ot
-0001a840: 6865 7277 6973 652c 2069 7420 6d69 6768  herwise, it migh
-0001a850: 7420 6265 2072 6573 6f6c 7665 6420 6279  t be resolved by
-0001a860: 2072 6562 7569 6c64 696e 6720 7468 6520   rebuilding the 
-0001a870: 6d61 7470 6c6f 746c 6962 2066 6f6e 7420  matplotlib font 
-0001a880: 6361 6368 6522 0a20 2020 2020 2020 2020  cache".         
-0001a890: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001a8a0: 2020 2020 2020 2020 2025 2028 6661 6365           % (face
-0001a8b0: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
-0001a8c0: 0a20 2020 2020 2020 2023 2052 656e 6465  .        # Rende
-0001a8d0: 7220 6561 6368 2063 6861 7261 6374 6572  r each character
-0001a8e0: 0a20 2020 2020 2020 2066 6f72 206c 696e  .        for lin
-0001a8f0: 6520 696e 2074 6578 742e 7370 6c69 7428  e in text.split(
-0001a900: 225c 6e22 293a 0a20 2020 2020 2020 2020  "\n"):.         
-0001a910: 2020 206c 203d 2044 6576 6963 6528 2274     l = Device("t
-0001a920: 6578 746c 696e 6522 290a 2020 2020 2020  extline").      
-0001a930: 2020 2020 2020 786f 6666 7365 7420 3d20        xoffset = 
-0001a940: 300a 2020 2020 2020 2020 2020 2020 666f  0.            fo
-0001a950: 7220 6c65 7474 6572 2069 6e20 6c69 6e65  r letter in line
-0001a960: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001a970: 2020 6c65 7474 6572 5f64 6576 203d 2044    letter_dev = D
-0001a980: 6576 6963 6528 226c 6574 7465 7222 290a  evice("letter").
-0001a990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a9a0: 6c65 7474 6572 5f74 656d 706c 6174 652c  letter_template,
-0001a9b0: 2061 6476 616e 6365 5f78 203d 205f 6765   advance_x = _ge
-0001a9c0: 745f 676c 7970 6828 666f 6e74 2c20 6c65  t_glyph(font, le
-0001a9d0: 7474 6572 290a 2020 2020 2020 2020 2020  tter).          
-0001a9e0: 2020 2020 2020 666f 7220 706f 6c79 2069        for poly i
-0001a9f0: 6e20 6c65 7474 6572 5f74 656d 706c 6174  n letter_templat
-0001aa00: 652e 706f 6c79 676f 6e73 3a0a 2020 2020  e.polygons:.    
-0001aa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa20: 6c65 7474 6572 5f64 6576 2e61 6464 5f70  letter_dev.add_p
-0001aa30: 6f6c 7967 6f6e 2870 6f6c 792e 706f 6c79  olygon(poly.poly
-0001aa40: 676f 6e73 2c20 6c61 7965 723d 6c61 7965  gons, layer=laye
-0001aa50: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-0001aa60: 2020 2072 6566 203d 206c 2e61 6464 5f72     ref = l.add_r
-0001aa70: 6566 286c 6574 7465 725f 6465 7629 0a20  ef(letter_dev). 
-0001aa80: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001aa90: 6566 2e6d 6f76 6528 6465 7374 696e 6174  ef.move(destinat
-0001aaa0: 696f 6e3d 2878 6f66 6673 6574 2c20 3029  ion=(xoffset, 0)
-0001aab0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001aac0: 2020 7265 662e 6d61 676e 6966 6963 6174    ref.magnificat
-0001aad0: 696f 6e20 3d20 7369 7a65 0a20 2020 2020  ion = size.     
-0001aae0: 2020 2020 2020 2020 2020 2078 6f66 6673             xoffs
-0001aaf0: 6574 202b 3d20 7369 7a65 202a 2061 6476  et += size * adv
-0001ab00: 616e 6365 5f78 0a0a 2020 2020 2020 2020  ance_x..        
-0001ab10: 2020 2020 7265 6620 3d20 742e 6164 645f      ref = t.add_
-0001ab20: 7265 6628 6c29 0a20 2020 2020 2020 2020  ref(l).         
-0001ab30: 2020 2072 6566 2e6d 6f76 6528 6465 7374     ref.move(dest
-0001ab40: 696e 6174 696f 6e3d 2830 2c20 796f 6666  ination=(0, yoff
-0001ab50: 7365 7429 290a 2020 2020 2020 2020 2020  set)).          
-0001ab60: 2020 796f 6666 7365 7420 2d3d 2073 697a    yoffset -= siz
-0001ab70: 650a 0a20 2020 206a 7573 7469 6679 203d  e..    justify =
-0001ab80: 206a 7573 7469 6679 2e6c 6f77 6572 2829   justify.lower()
-0001ab90: 0a20 2020 2066 6f72 206c 2069 6e20 742e  .    for l in t.
-0001aba0: 7265 6665 7265 6e63 6573 3a0a 2020 2020  references:.    
-0001abb0: 2020 2020 6966 206a 7573 7469 6679 203d      if justify =
-0001abc0: 3d20 226c 6566 7422 3a0a 2020 2020 2020  = "left":.      
-0001abd0: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
-0001abe0: 2020 2069 6620 6a75 7374 6966 7920 3d3d     if justify ==
-0001abf0: 2022 7269 6768 7422 3a0a 2020 2020 2020   "right":.      
-0001ac00: 2020 2020 2020 6c2e 786d 6178 203d 2030        l.xmax = 0
-0001ac10: 0a20 2020 2020 2020 2069 6620 6a75 7374  .        if just
-0001ac20: 6966 7920 3d3d 2022 6365 6e74 6572 223a  ify == "center":
-0001ac30: 0a20 2020 2020 2020 2020 2020 206c 2e6d  .            l.m
-0001ac40: 6f76 6528 6f72 6967 696e 3d6c 2e63 656e  ove(origin=l.cen
-0001ac50: 7465 722c 2064 6573 7469 6e61 7469 6f6e  ter, destination
-0001ac60: 3d28 302c 2030 292c 2061 7869 733d 2278  =(0, 0), axis="x
-0001ac70: 2229 0a0a 2020 2020 742e 666c 6174 7465  ")..    t.flatte
-0001ac80: 6e28 290a 2020 2020 7265 7475 726e 2074  n().    return t
-0001ac90: 0a0a 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d  ...# ===========
-0001aca0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001acb0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001acc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001acd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001ace0: 3d3d 3d0a 2320 4578 616d 706c 6520 636f  ===.# Example co
-0001acf0: 6465 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d  de.# ===========
-0001ad00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001ad10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001ad20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001ad30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001ad40: 3d3d 3d0a 0a23 2044 203d 2074 6578 7428  ===..# D = text(
-0001ad50: 2774 6865 2071 7569 636b 2062 726f 776e  'the quick brown
-0001ad60: 5c6e 2066 6f78 206a 756d 7065 6420 6f76  \n fox jumped ov
-0001ad70: 6572 5c6e 7468 6520 6c61 7a79 2064 6f67  er\nthe lazy dog
-0001ad80: 272c 206a 7573 7469 6679 203d 2027 6365  ', justify = 'ce
-0001ad90: 6e74 6572 272c 2073 697a 6520 3d20 3830  nter', size = 80
-0001ada0: 3029 0a23 2071 7569 636b 706c 6f74 2844  0).# quickplot(D
-0001adb0: 290a 0a0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d  )...# ==========
-0001adc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001add0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001ade0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001adf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001ae00: 3d3d 3d3d 0a23 0a23 2057 6166 6572 2061  ====.#.# Wafer a
-0001ae10: 6e64 2064 6965 0a23 0a23 203d 3d3d 3d3d  nd die.#.# =====
-0001ae20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001ae30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001ae40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001ae50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001ae60: 3d3d 3d3d 3d3d 3d3d 3d0a 0a0a 6465 6620  =========...def 
-0001ae70: 6261 7369 635f 6469 6528 0a20 2020 2073  basic_die(.    s
-0001ae80: 697a 653d 2831 3030 3030 2c20 3130 3030  ize=(10000, 1000
-0001ae90: 3029 2c0a 2020 2020 7374 7265 6574 5f77  0),.    street_w
-0001aea0: 6964 7468 3d31 3030 2c0a 2020 2020 7374  idth=100,.    st
-0001aeb0: 7265 6574 5f6c 656e 6774 683d 3130 3030  reet_length=1000
-0001aec0: 2c0a 2020 2020 6469 655f 6e61 6d65 3d22  ,.    die_name="
-0001aed0: 6368 6970 3939 222c 0a20 2020 2074 6578  chip99",.    tex
-0001aee0: 745f 7369 7a65 3d31 3030 2c0a 2020 2020  t_size=100,.    
-0001aef0: 7465 7874 5f6c 6f63 6174 696f 6e3d 2253  text_location="S
-0001af00: 5722 2c0a 2020 2020 6c61 7965 723d 302c  W",.    layer=0,
-0001af10: 0a20 2020 2064 7261 775f 6262 6f78 3d54  .    draw_bbox=T
-0001af20: 7275 652c 0a20 2020 2062 626f 785f 6c61  rue,.    bbox_la
-0001af30: 7965 723d 3939 2c0a 293a 0a20 2020 2022  yer=99,.):.    "
-0001af40: 2222 4372 6561 7465 7320 6120 6261 7369  ""Creates a basi
-0001af50: 6320 6368 6970 2f64 6965 2074 656d 706c  c chip/die templ
-0001af60: 6174 652c 2077 6974 6820 3420 7269 6768  ate, with 4 righ
-0001af70: 7420 616e 676c 6520 636f 726e 6572 7320  t angle corners 
-0001af80: 6d61 726b 696e 670a 2020 2020 7468 6520  marking.    the 
-0001af90: 626f 756e 6461 7279 206f 6620 7468 6520  boundary of the 
-0001afa0: 6368 6970 2f64 6965 2061 6e64 2061 206c  chip/die and a l
-0001afb0: 6162 656c 2077 6974 6820 7468 6520 6e61  abel with the na
-0001afc0: 6d65 206f 6620 7468 6520 6469 652e 0a0a  me of the die...
-0001afd0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-0001afe0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-0001aff0: 2020 7369 7a65 203a 2061 7272 6179 5f6c    size : array_l
-0001b000: 696b 655b 325d 206f 6620 696e 7420 6f72  ike[2] of int or
-0001b010: 2066 6c6f 6174 0a20 2020 2020 2020 2078   float.        x
-0001b020: 2c20 7920 6469 6d65 6e73 696f 6e73 206f  , y dimensions o
-0001b030: 6620 7468 6520 6469 652e 0a20 2020 2073  f the die..    s
-0001b040: 7472 6565 745f 7769 6474 6820 3a20 696e  treet_width : in
-0001b050: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
-0001b060: 2020 2057 6964 7468 206f 6620 7468 6520     Width of the 
-0001b070: 636f 726e 6572 206d 6172 6b73 2066 6f72  corner marks for
-0001b080: 2064 6965 2d73 6177 696e 672e 0a20 2020   die-sawing..   
-0001b090: 2073 7472 6565 745f 6c65 6e67 7468 203a   street_length :
-0001b0a0: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
-0001b0b0: 2020 2020 2020 4c65 6e67 7468 206f 6620        Length of 
-0001b0c0: 7468 6520 636f 726e 6572 206d 6172 6b73  the corner marks
-0001b0d0: 2066 6f72 2064 6965 2d73 6177 696e 672e   for die-sawing.
-0001b0e0: 0a20 2020 2064 6965 5f6e 616d 6520 3a20  .    die_name : 
-0001b0f0: 7374 720a 2020 2020 2020 2020 4c61 6265  str.        Labe
-0001b100: 6c20 7465 7874 2e0a 2020 2020 7465 7874  l text..    text
-0001b110: 5f73 697a 6520 3a20 696e 7420 6f72 2066  _size : int or f
-0001b120: 6c6f 6174 0a20 2020 2020 2020 204c 6162  loat.        Lab
-0001b130: 656c 2074 6578 7420 7369 7a65 2e0a 2020  el text size..  
-0001b140: 2020 7465 7874 5f6c 6f63 6174 696f 6e20    text_location 
-0001b150: 3a20 7b27 4e57 272c 2027 4e27 2c20 274e  : {'NW', 'N', 'N
-0001b160: 4527 2c20 2753 5727 2c20 2753 272c 2027  E', 'SW', 'S', '
-0001b170: 5345 277d 0a20 2020 2020 2020 204c 6162  SE'}.        Lab
-0001b180: 656c 2074 6578 7420 636f 6d70 6173 7320  el text compass 
-0001b190: 6c6f 6361 7469 6f6e 2e0a 2020 2020 6c61  location..    la
-0001b1a0: 7965 7220 3a20 696e 740a 2020 2020 2020  yer : int.      
-0001b1b0: 2020 5370 6563 6966 6963 206c 6179 6572    Specific layer
-0001b1c0: 2873 2920 746f 2070 7574 2070 6f6c 7967  (s) to put polyg
-0001b1d0: 6f6e 2067 656f 6d65 7472 7920 6f6e 2e0a  on geometry on..
-0001b1e0: 2020 2020 6472 6177 5f62 626f 7820 3a20      draw_bbox : 
-0001b1f0: 626f 6f6c 0a20 2020 2020 2020 2049 6620  bool.        If 
-0001b200: 7472 7565 2c20 6472 6177 6e73 2061 2062  true, drawns a b
-0001b210: 626f 7820 6172 6f75 6e64 2074 6865 2063  box around the c
-0001b220: 6869 7020 6469 6520 6765 6f6d 6574 7279  hip die geometry
-0001b230: 2e0a 2020 2020 6262 6f78 5f6c 6179 6572  ..    bbox_layer
-0001b240: 203a 2069 6e74 0a20 2020 2020 2020 204c   : int.        L
-0001b250: 6179 6572 206f 6e20 7768 6963 6820 6262  ayer on which bb
-0001b260: 6f78 2069 7320 706c 6163 6564 2069 6620  ox is placed if 
-0001b270: 6060 6472 6177 5f62 626f 7860 6020 6973  ``draw_bbox`` is
-0001b280: 2074 7275 652e 0a0a 2020 2020 5265 7475   true...    Retu
-0001b290: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-0001b2a0: 2020 2020 4420 3a20 4465 7669 6365 0a20      D : Device. 
-0001b2b0: 2020 2020 2020 2041 2044 6576 6963 6520         A Device 
-0001b2c0: 636f 6e74 6169 6e69 6e67 2061 2062 6173  containing a bas
-0001b2d0: 6963 2064 6965 2067 656f 6d65 7472 792e  ic die geometry.
-0001b2e0: 0a20 2020 2022 2222 0a20 2020 2044 203d  .    """.    D =
-0001b2f0: 2044 6576 6963 6528 6e61 6d65 3d22 6469   Device(name="di
-0001b300: 6522 290a 2020 2020 7378 2c20 7379 203d  e").    sx, sy =
-0001b310: 2073 697a 655b 305d 202f 2032 2c20 7369   size[0] / 2, si
-0001b320: 7a65 5b31 5d20 2f20 320a 2020 2020 7870  ze[1] / 2.    xp
-0001b330: 7473 203d 206e 702e 6172 7261 7928 0a20  ts = np.array(. 
-0001b340: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0001b350: 2020 2020 2073 782c 0a20 2020 2020 2020       sx,.       
-0001b360: 2020 2020 2073 782c 0a20 2020 2020 2020       sx,.       
-0001b370: 2020 2020 2073 7820 2d20 7374 7265 6574       sx - street
-0001b380: 5f77 6964 7468 2c0a 2020 2020 2020 2020  _width,.        
-0001b390: 2020 2020 7378 202d 2073 7472 6565 745f      sx - street_
-0001b3a0: 7769 6474 682c 0a20 2020 2020 2020 2020  width,.         
-0001b3b0: 2020 2073 7820 2d20 7374 7265 6574 5f6c     sx - street_l
-0001b3c0: 656e 6774 682c 0a20 2020 2020 2020 2020  ength,.         
-0001b3d0: 2020 2073 7820 2d20 7374 7265 6574 5f6c     sx - street_l
-0001b3e0: 656e 6774 682c 0a20 2020 2020 2020 205d  ength,.        ]
-0001b3f0: 0a20 2020 2029 0a20 2020 2079 7074 7320  .    ).    ypts 
-0001b400: 3d20 6e70 2e61 7272 6179 280a 2020 2020  = np.array(.    
-0001b410: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0001b420: 2020 7379 2c0a 2020 2020 2020 2020 2020    sy,.          
-0001b430: 2020 7379 202d 2073 7472 6565 745f 6c65    sy - street_le
-0001b440: 6e67 7468 2c0a 2020 2020 2020 2020 2020  ngth,.          
-0001b450: 2020 7379 202d 2073 7472 6565 745f 6c65    sy - street_le
-0001b460: 6e67 7468 2c0a 2020 2020 2020 2020 2020  ngth,.          
-0001b470: 2020 7379 202d 2073 7472 6565 745f 7769    sy - street_wi
-0001b480: 6474 682c 0a20 2020 2020 2020 2020 2020  dth,.           
-0001b490: 2073 7920 2d20 7374 7265 6574 5f77 6964   sy - street_wid
-0001b4a0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-0001b4b0: 7379 2c0a 2020 2020 2020 2020 5d0a 2020  sy,.        ].  
-0001b4c0: 2020 290a 2020 2020 442e 6164 645f 706f    ).    D.add_po
-0001b4d0: 6c79 676f 6e28 5b78 7074 732c 2079 7074  lygon([xpts, ypt
-0001b4e0: 735d 2c20 6c61 7965 723d 6c61 7965 7229  s], layer=layer)
-0001b4f0: 0a20 2020 2044 2e61 6464 5f70 6f6c 7967  .    D.add_polyg
-0001b500: 6f6e 285b 2d78 7074 732c 2079 7074 735d  on([-xpts, ypts]
-0001b510: 2c20 6c61 7965 723d 6c61 7965 7229 0a20  , layer=layer). 
-0001b520: 2020 2044 2e61 6464 5f70 6f6c 7967 6f6e     D.add_polygon
-0001b530: 285b 7870 7473 2c20 2d79 7074 735d 2c20  ([xpts, -ypts], 
-0001b540: 6c61 7965 723d 6c61 7965 7229 0a20 2020  layer=layer).   
-0001b550: 2044 2e61 6464 5f70 6f6c 7967 6f6e 285b   D.add_polygon([
-0001b560: 2d78 7074 732c 202d 7970 7473 5d2c 206c  -xpts, -ypts], l
-0001b570: 6179 6572 3d6c 6179 6572 290a 0a20 2020  ayer=layer)..   
-0001b580: 2069 6620 6472 6177 5f62 626f 7820 6973   if draw_bbox is
-0001b590: 2054 7275 653a 0a20 2020 2020 2020 2044   True:.        D
-0001b5a0: 2e61 6464 5f70 6f6c 7967 6f6e 285b 5b73  .add_polygon([[s
-0001b5b0: 782c 2073 795d 2c20 5b73 782c 202d 7379  x, sy], [sx, -sy
-0001b5c0: 5d2c 205b 2d73 782c 202d 7379 5d2c 205b  ], [-sx, -sy], [
-0001b5d0: 2d73 782c 2073 795d 5d2c 206c 6179 6572  -sx, sy]], layer
-0001b5e0: 3d62 626f 785f 6c61 7965 7229 0a20 2020  =bbox_layer).   
-0001b5f0: 2044 2e63 656e 7465 7220 3d20 2830 2c20   D.center = (0, 
-0001b600: 3029 0a20 2020 2074 203d 2044 2e61 6464  0).    t = D.add
-0001b610: 5f72 6566 2874 6578 7428 7465 7874 3d64  _ref(text(text=d
-0001b620: 6965 5f6e 616d 652c 2073 697a 653d 7465  ie_name, size=te
-0001b630: 7874 5f73 697a 652c 206c 6179 6572 3d6c  xt_size, layer=l
-0001b640: 6179 6572 2929 0a0a 2020 2020 6420 3d20  ayer))..    d = 
-0001b650: 7374 7265 6574 5f77 6964 7468 202b 2032  street_width + 2
-0001b660: 300a 2020 2020 6966 2069 7369 6e73 7461  0.    if isinsta
-0001b670: 6e63 6528 7465 7874 5f6c 6f63 6174 696f  nce(text_locatio
-0001b680: 6e2c 2073 7472 293a 0a20 2020 2020 2020  n, str):.       
-0001b690: 2074 6578 745f 6c6f 6361 7469 6f6e 203d   text_location =
-0001b6a0: 2074 6578 745f 6c6f 6361 7469 6f6e 2e75   text_location.u
-0001b6b0: 7070 6572 2829 0a20 2020 2020 2020 2069  pper().        i
-0001b6c0: 6620 7465 7874 5f6c 6f63 6174 696f 6e20  f text_location 
-0001b6d0: 3d3d 2022 4e57 223a 0a20 2020 2020 2020  == "NW":.       
-0001b6e0: 2020 2020 2074 2e78 6d69 6e2c 2074 2e79       t.xmin, t.y
-0001b6f0: 6d61 7820 3d20 5b2d 7378 202b 2064 2c20  max = [-sx + d, 
-0001b700: 7379 202d 2064 5d0a 2020 2020 2020 2020  sy - d].        
-0001b710: 656c 6966 2074 6578 745f 6c6f 6361 7469  elif text_locati
-0001b720: 6f6e 203d 3d20 224e 223a 0a20 2020 2020  on == "N":.     
-0001b730: 2020 2020 2020 2074 2e78 2c20 742e 796d         t.x, t.ym
-0001b740: 6178 203d 205b 302c 2073 7920 2d20 645d  ax = [0, sy - d]
-0001b750: 0a20 2020 2020 2020 2065 6c69 6620 7465  .        elif te
-0001b760: 7874 5f6c 6f63 6174 696f 6e20 3d3d 2022  xt_location == "
-0001b770: 4e45 223a 0a20 2020 2020 2020 2020 2020  NE":.           
-0001b780: 2074 2e78 6d61 782c 2074 2e79 6d61 7820   t.xmax, t.ymax 
-0001b790: 3d20 5b73 7820 2d20 642c 2073 7920 2d20  = [sx - d, sy - 
-0001b7a0: 645d 0a20 2020 2020 2020 2069 6620 7465  d].        if te
-0001b7b0: 7874 5f6c 6f63 6174 696f 6e20 3d3d 2022  xt_location == "
-0001b7c0: 5357 223a 0a20 2020 2020 2020 2020 2020  SW":.           
-0001b7d0: 2074 2e78 6d69 6e2c 2074 2e79 6d69 6e20   t.xmin, t.ymin 
-0001b7e0: 3d20 5b2d 7378 202b 2064 2c20 2d73 7920  = [-sx + d, -sy 
-0001b7f0: 2b20 645d 0a20 2020 2020 2020 2065 6c69  + d].        eli
-0001b800: 6620 7465 7874 5f6c 6f63 6174 696f 6e20  f text_location 
-0001b810: 3d3d 2022 5322 3a0a 2020 2020 2020 2020  == "S":.        
-0001b820: 2020 2020 742e 782c 2074 2e79 6d69 6e20      t.x, t.ymin 
-0001b830: 3d20 5b30 2c20 2d73 7920 2b20 645d 0a20  = [0, -sy + d]. 
-0001b840: 2020 2020 2020 2065 6c69 6620 7465 7874         elif text
-0001b850: 5f6c 6f63 6174 696f 6e20 3d3d 2022 5345  _location == "SE
-0001b860: 223a 0a20 2020 2020 2020 2020 2020 2074  ":.            t
-0001b870: 2e78 6d61 782c 2074 2e79 6d69 6e20 3d20  .xmax, t.ymin = 
-0001b880: 5b73 7820 2d20 642c 202d 7379 202b 2064  [sx - d, -sy + d
-0001b890: 5d0a 2020 2020 656c 7365 3a0a 2020 2020  ].    else:.    
-0001b8a0: 2020 2020 742e 782c 2074 2e79 203d 2074      t.x, t.y = t
-0001b8b0: 6578 745f 6c6f 6361 7469 6f6e 0a0a 2020  ext_location..  
-0001b8c0: 2020 7265 7475 726e 2044 0a0a 0a23 203d    return D...# =
+0000ba00: 3d0a 230a 2320 4b4c 6179 6f75 7420 626f  =.#.# KLayout bo
+0000ba10: 6f6c 6561 6e20 6675 6e63 7469 6f6e 730a  olean functions.
+0000ba20: 230a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  #.# ============
+0000ba30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000ba40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000ba50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000ba60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000ba70: 3d3d 0a0a 0a64 6566 205f 6b6c 5f65 7870  ==...def _kl_exp
+0000ba80: 7265 7373 696f 6e28 0a20 2020 2065 6c65  ression(.    ele
+0000ba90: 6d65 6e74 5f64 6963 742c 2020 2320 652e  ment_dict,  # e.
+0000baa0: 672e 2064 6963 7428 4120 3d20 736e 7370  g. dict(A = snsp
+0000bab0: 6428 292c 2042 203d 2070 672e 656c 6c69  d(), B = pg.elli
+0000bac0: 7073 6528 2929 0a20 2020 2065 7870 7265  pse()).    expre
+0000bad0: 7373 696f 6e2c 2020 2320 652e 672e 2027  ssion,  # e.g. '
+0000bae0: 412e 7369 7a65 6428 2d35 3030 2c20 3229  A.sized(-500, 2)
+0000baf0: 202d 2042 272c 0a20 2020 2070 7265 6369   - B',.    preci
+0000bb00: 7369 6f6e 3d31 652d 342c 0a20 2020 2074  sion=1e-4,.    t
+0000bb10: 696c 655f 7369 7a65 3d28 3130 3030 2c20  ile_size=(1000, 
+0000bb20: 3130 3030 292c 0a20 2020 206d 6572 6765  1000),.    merge
+0000bb30: 5f66 6972 7374 3d54 7275 652c 0a20 2020  _first=True,.   
+0000bb40: 206d 6572 6765 5f61 6674 6572 3d54 7275   merge_after=Tru
+0000bb50: 652c 0a20 2020 206f 7574 7075 745f 6e61  e,.    output_na
+0000bb60: 6d65 3d22 756e 6e61 6d65 6422 2c0a 2020  me="unnamed",.  
+0000bb70: 2020 6e75 6d5f 6370 753d 2261 6c6c 222c    num_cpu="all",
+0000bb80: 0a20 2020 206c 6179 6572 3d30 2c0a 293a  .    layer=0,.):
+0000bb90: 0a20 2020 206c 6179 6572 203d 205f 7061  .    layer = _pa
+0000bba0: 7273 655f 6c61 7965 7228 6c61 7965 7229  rse_layer(layer)
+0000bbb0: 0a20 2020 206b 6c5f 7265 6769 6f6e 5f64  .    kl_region_d
+0000bbc0: 6963 7420 3d20 7b0a 2020 2020 2020 2020  ict = {.        
+0000bbd0: 6b3a 205f 6f62 6a65 6374 735f 746f 5f6b  k: _objects_to_k
+0000bbe0: 6c5f 7265 6769 6f6e 2876 2c20 7072 6563  l_region(v, prec
+0000bbf0: 6973 696f 6e3d 7072 6563 6973 696f 6e29  ision=precision)
+0000bc00: 0a20 2020 2020 2020 2066 6f72 206b 2c20  .        for k, 
+0000bc10: 7620 696e 2065 6c65 6d65 6e74 5f64 6963  v in element_dic
+0000bc20: 742e 6974 656d 7328 290a 2020 2020 7d0a  t.items().    }.
+0000bc30: 2020 2020 666f 7220 6b6c 5f72 6567 696f      for kl_regio
+0000bc40: 6e20 696e 206b 6c5f 7265 6769 6f6e 5f64  n in kl_region_d
+0000bc50: 6963 742e 7661 6c75 6573 2829 3a0a 2020  ict.values():.  
+0000bc60: 2020 2020 2020 6b6c 5f72 6567 696f 6e2e        kl_region.
+0000bc70: 6d65 7267 6564 5f73 656d 616e 7469 6373  merged_semantics
+0000bc80: 203d 206d 6572 6765 5f66 6972 7374 0a0a   = merge_first..
+0000bc90: 2020 2020 696d 706f 7274 206b 6c61 796f      import klayo
+0000bca0: 7574 2e64 6220 6173 206b 6462 0a0a 2020  ut.db as kdb..  
+0000bcb0: 2020 7072 696e 7428 7068 6964 6c5f 636f    print(phidl_co
+0000bcc0: 6e66 6967 5b22 4e55 4d5f 4350 5522 5d20  nfig["NUM_CPU"] 
+0000bcd0: 6966 206e 756d 5f63 7075 203d 3d20 2261  if num_cpu == "a
+0000bce0: 6c6c 2220 656c 7365 206e 756d 5f63 7075  ll" else num_cpu
+0000bcf0: 290a 2020 2020 7470 203d 206b 6462 2e54  ).    tp = kdb.T
+0000bd00: 696c 696e 6750 726f 6365 7373 6f72 2829  ilingProcessor()
+0000bd10: 0a20 2020 2074 702e 7468 7265 6164 7320  .    tp.threads 
+0000bd20: 3d20 7068 6964 6c5f 636f 6e66 6967 5b22  = phidl_config["
+0000bd30: 4e55 4d5f 4350 5522 5d20 6966 206e 756d  NUM_CPU"] if num
+0000bd40: 5f63 7075 203d 3d20 2261 6c6c 2220 656c  _cpu == "all" el
+0000bd50: 7365 206e 756d 5f63 7075 0a20 2020 2069  se num_cpu.    i
+0000bd60: 6620 7469 6c65 5f73 697a 6520 6973 206e  f tile_size is n
+0000bd70: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0000bd80: 2074 702e 7469 6c65 5f73 697a 6528 0a20   tp.tile_size(. 
+0000bd90: 2020 2020 2020 2020 2020 2074 696c 655f             tile_
+0000bda0: 7369 7a65 5b30 5d20 2a20 7470 2e64 6275  size[0] * tp.dbu
+0000bdb0: 202f 2070 7265 6369 7369 6f6e 2c20 7469   / precision, ti
+0000bdc0: 6c65 5f73 697a 655b 305d 202a 2074 702e  le_size[0] * tp.
+0000bdd0: 6462 7520 2f20 7072 6563 6973 696f 6e0a  dbu / precision.
+0000bde0: 2020 2020 2020 2020 290a 2020 2020 666f          ).    fo
+0000bdf0: 7220 6e61 6d65 2c20 6b6c 5f72 6567 696f  r name, kl_regio
+0000be00: 6e20 696e 206b 6c5f 7265 6769 6f6e 5f64  n in kl_region_d
+0000be10: 6963 742e 6974 656d 7328 293a 0a20 2020  ict.items():.   
+0000be20: 2020 2020 2074 702e 696e 7075 7428 6e61       tp.input(na
+0000be30: 6d65 2c20 6b6c 5f72 6567 696f 6e29 0a20  me, kl_region). 
+0000be40: 2020 206f 7574 7075 745f 7265 6769 6f6e     output_region
+0000be50: 203d 206b 6462 2e52 6567 696f 6e28 290a   = kdb.Region().
+0000be60: 2020 2020 7470 2e6f 7574 7075 7428 226f      tp.output("o
+0000be70: 7574 222c 206f 7574 7075 745f 7265 6769  ut", output_regi
+0000be80: 6f6e 290a 2020 2020 7470 2e71 7565 7565  on).    tp.queue
+0000be90: 2866 225f 6f75 7470 7574 286f 7574 2c20  (f"_output(out, 
+0000bea0: 7b65 7870 7265 7373 696f 6e7d 2922 290a  {expression})").
+0000beb0: 2020 2020 7470 2e65 7865 6375 7465 2822      tp.execute("
+0000bec0: 7469 6c65 6420 6f70 6572 6174 696f 6e22  tiled operation"
+0000bed0: 290a 0a20 2020 2069 6620 6d65 7267 655f  )..    if merge_
+0000bee0: 6166 7465 7220 6973 2054 7275 653a 0a20  after is True:. 
+0000bef0: 2020 2020 2020 206f 7574 7075 745f 7265         output_re
+0000bf00: 6769 6f6e 2e6d 6572 6765 2829 0a0a 2020  gion.merge()..  
+0000bf10: 2020 2320 4372 6561 7465 2074 6865 2044    # Create the D
+0000bf20: 6576 6963 6520 616e 6420 6164 6420 7468  evice and add th
+0000bf30: 6520 7265 7375 6c74 696e 6720 6f66 6673  e resulting offs
+0000bf40: 6574 2072 6567 696f 6e20 746f 2069 740a  et region to it.
+0000bf50: 2020 2020 4420 3d20 5f6b 6c5f 7265 6769      D = _kl_regi
+0000bf60: 6f6e 5f74 6f5f 6465 7669 6365 280a 2020  on_to_device(.  
+0000bf70: 2020 2020 2020 6f75 7470 7574 5f72 6567        output_reg
+0000bf80: 696f 6e2c 206c 6179 6572 3d6c 6179 6572  ion, layer=layer
+0000bf90: 2c20 6e61 6d65 3d6f 7574 7075 745f 6e61  , name=output_na
+0000bfa0: 6d65 2c20 7072 6563 6973 696f 6e3d 7072  me, precision=pr
+0000bfb0: 6563 6973 696f 6e0a 2020 2020 290a 0a20  ecision.    ).. 
+0000bfc0: 2020 2023 2044 656c 6574 6520 7468 6520     # Delete the 
+0000bfd0: 7265 6769 6f6e 7320 736f 2074 6865 7920  regions so they 
+0000bfe0: 646f 6e27 7420 6861 6e67 2061 726f 756e  don't hang aroun
+0000bff0: 6420 696e 206d 656d 6f72 790a 2020 2020  d in memory.    
+0000c000: 666f 7220 6b6c 5f72 6567 696f 6e20 696e  for kl_region in
+0000c010: 206b 6c5f 7265 6769 6f6e 5f64 6963 742e   kl_region_dict.
+0000c020: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
+0000c030: 2020 6b6c 5f72 6567 696f 6e2e 636c 6561    kl_region.clea
+0000c040: 7228 290a 2020 2020 2020 2020 6b6c 5f72  r().        kl_r
+0000c050: 6567 696f 6e2e 5f64 6573 7472 6f79 2829  egion._destroy()
+0000c060: 0a0a 2020 2020 7265 7475 726e 2044 0a0a  ..    return D..
+0000c070: 0a64 6566 206b 6c5f 6f66 6673 6574 280a  .def kl_offset(.
+0000c080: 2020 2020 656c 656d 656e 7473 2c0a 2020      elements,.  
+0000c090: 2020 6469 7374 616e 6365 3d30 2e31 2c0a    distance=0.1,.
+0000c0a0: 2020 2020 7072 6563 6973 696f 6e3d 3165      precision=1e
+0000c0b0: 2d34 2c0a 2020 2020 6d69 7465 725f 6d6f  -4,.    miter_mo
+0000c0c0: 6465 3d32 2c0a 2020 2020 7469 6c65 5f73  de=2,.    tile_s
+0000c0d0: 697a 653d 2831 3030 302c 2031 3030 3029  ize=(1000, 1000)
+0000c0e0: 2c0a 2020 2020 6d65 7267 655f 6166 7465  ,.    merge_afte
+0000c0f0: 723d 5472 7565 2c0a 2020 2020 6e75 6d5f  r=True,.    num_
+0000c100: 6370 753d 2261 6c6c 222c 0a20 2020 206c  cpu="all",.    l
+0000c110: 6179 6572 3d30 2c0a 293a 0a20 2020 2022  ayer=0,.):.    "
+0000c120: 2222 5368 7269 6e6b 7320 6f72 2065 7870  ""Shrinks or exp
+0000c130: 616e 6473 2061 2070 6f6c 7967 6f6e 206f  ands a polygon o
+0000c140: 7220 7365 7420 6f66 2070 6f6c 7967 6f6e  r set of polygon
+0000c150: 7320 7573 696e 6720 4b4c 6179 6f75 740a  s using KLayout.
+0000c160: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+0000c170: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+0000c180: 2020 2065 6c65 6d65 6e74 7320 3a20 4465     elements : De
+0000c190: 7669 6365 282f 5265 6665 7265 6e63 6529  vice(/Reference)
+0000c1a0: 2c20 6c69 7374 206f 6620 4465 7669 6365  , list of Device
+0000c1b0: 282f 5265 6665 7265 6e63 6529 2c20 6f72  (/Reference), or
+0000c1c0: 2050 6f6c 7967 6f6e 0a20 2020 2020 2020   Polygon.       
+0000c1d0: 2050 6f6c 7967 6f6e 7320 746f 206f 6666   Polygons to off
+0000c1e0: 7365 7420 6f72 2044 6576 6963 6520 636f  set or Device co
+0000c1f0: 6e74 6169 6e69 6e67 2070 6f6c 7967 6f6e  ntaining polygon
+0000c200: 7320 746f 206f 6666 7365 742e 0a20 2020  s to offset..   
+0000c210: 2064 6973 7461 6e63 6520 3a20 696e 7420   distance : int 
+0000c220: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
+0000c230: 2044 6973 7461 6e63 6520 746f 206f 6666   Distance to off
+0000c240: 7365 7420 706f 6c79 676f 6e73 2e20 506f  set polygons. Po
+0000c250: 7369 7469 7665 2076 616c 7565 7320 6578  sitive values ex
+0000c260: 7061 6e64 2c20 6e65 6761 7469 7665 2073  pand, negative s
+0000c270: 6872 696e 6b2e 0a20 2020 2070 7265 6369  hrink..    preci
+0000c280: 7369 6f6e 203a 2066 6c6f 6174 0a20 2020  sion : float.   
+0000c290: 2020 2020 2044 6573 6972 6564 2070 7265       Desired pre
+0000c2a0: 6369 7369 6f6e 2066 6f72 2072 6f75 6e64  cision for round
+0000c2b0: 696e 6720 7665 7274 6578 2063 6f6f 7264  ing vertex coord
+0000c2c0: 696e 6174 6573 2e0a 2020 2020 6d69 7465  inates..    mite
+0000c2d0: 725f 6d6f 6465 203a 2069 6e74 0a20 2020  r_mode : int.   
+0000c2e0: 2020 2020 2054 7970 6520 6f66 2063 6f72       Type of cor
+0000c2f0: 6e65 7273 2067 656e 6572 6174 6564 2064  ners generated d
+0000c300: 7572 696e 6720 7468 6520 6f66 6673 6574  uring the offset
+0000c310: 206f 7065 7261 7469 6f6e 2c20 7365 650a   operation, see.
+0000c320: 2020 2020 2020 2020 6874 7470 733a 2f2f          https://
+0000c330: 7777 772e 6b6c 6179 6f75 742e 6465 2f64  www.klayout.de/d
+0000c340: 6f63 2f63 6f64 652f 636c 6173 735f 4564  oc/code/class_Ed
+0000c350: 6765 5072 6f63 6573 736f 722e 6874 6d6c  geProcessor.html
+0000c360: 236d 6574 686f 6435 350a 2020 2020 7469  #method55.    ti
+0000c370: 6c65 5f73 697a 6520 3a20 6172 7261 792d  le_size : array-
+0000c380: 6c69 6b65 5b32 5d0a 2020 2020 2020 2020  like[2].        
+0000c390: 5468 6520 7469 6c65 2073 697a 6520 7769  The tile size wi
+0000c3a0: 7468 2077 6869 6368 2074 6865 2067 656f  th which the geo
+0000c3b0: 6d65 7472 7920 6973 2064 6976 6964 6564  metry is divided
+0000c3c0: 2e20 5468 6973 2061 6c6c 6f77 7320 666f  . This allows fo
+0000c3d0: 7220 6561 6368 0a20 2020 2020 2020 2072  r each.        r
+0000c3e0: 6567 696f 6e20 746f 2062 6570 726f 6365  egion to beproce
+0000c3f0: 7373 6564 2073 6571 7565 6e74 6961 6c6c  ssed sequentiall
+0000c400: 792c 2077 6869 6368 2069 7320 6d6f 7265  y, which is more
+0000c410: 2063 6f6d 7075 7461 7469 6f6e 616c 6c79   computationally
+0000c420: 0a20 2020 2020 2020 2065 6666 6963 6965  .        efficie
+0000c430: 6e74 2028 616e 6420 6361 6e20 6265 2072  nt (and can be r
+0000c440: 756e 2069 6e20 7061 7261 6c6c 656c 206f  un in parallel o
+0000c450: 6e20 6d75 6c74 6970 6c65 2043 5055 2063  n multiple CPU c
+0000c460: 6f72 6573 292e 0a20 2020 206d 6572 6765  ores)..    merge
+0000c470: 5f61 6674 6572 3a20 626f 6f6c 0a20 2020  _after: bool.   
+0000c480: 2020 2020 204d 6572 6765 2061 6c6c 2074       Merge all t
+0000c490: 6865 2070 6f6c 7967 6f6e 7320 6166 7465  he polygons afte
+0000c4a0: 7220 7065 7266 6f72 6d69 6e67 2074 6865  r performing the
+0000c4b0: 206f 6666 7365 7420 6f70 6572 6174 696f   offset operatio
+0000c4c0: 6e0a 2020 2020 6e75 6d5f 6370 7520 3a20  n.    num_cpu : 
+0000c4d0: 696e 7420 6f72 2022 616c 6c22 0a20 2020  int or "all".   
+0000c4e0: 2020 2020 204e 756d 6265 7220 6f66 2043       Number of C
+0000c4f0: 5055 2063 6f72 6573 2074 6f20 7573 652e  PU cores to use.
+0000c500: 2042 7920 6465 6661 756c 742c 2069 7420   By default, it 
+0000c510: 7573 6573 2061 6c6c 2061 7661 696c 6162  uses all availab
+0000c520: 6c65 2043 5055 2063 6f72 6573 2c0a 2020  le CPU cores,.  
+0000c530: 2020 2020 2020 6275 7420 7468 6973 2064        but this d
+0000c540: 6566 6175 6c74 2063 616e 2062 6520 7365  efault can be se
+0000c550: 7420 6279 2060 7068 6964 6c2e 636f 6e66  t by `phidl.conf
+0000c560: 6967 5b27 4e55 4d5f 4350 5527 5d20 3d20  ig['NUM_CPU'] = 
+0000c570: 3260 0a20 2020 206c 6179 6572 203a 2069  2`.    layer : i
+0000c580: 6e74 2c20 6172 7261 792d 6c69 6b65 5b32  nt, array-like[2
+0000c590: 5d2c 206f 7220 7365 740a 2020 2020 2020  ], or set.      
+0000c5a0: 2020 5370 6563 6966 6963 206c 6179 6572    Specific layer
+0000c5b0: 2873 2920 746f 2070 7574 2070 6f6c 7967  (s) to put polyg
+0000c5c0: 6f6e 2067 656f 6d65 7472 7920 6f6e 2e0a  on geometry on..
+0000c5d0: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
+0000c5e0: 202d 2d2d 2d2d 2d2d 0a20 2020 2044 203a   -------.    D :
+0000c5f0: 2044 6576 6963 650a 2020 2020 2020 2020   Device.        
+0000c600: 4120 4465 7669 6365 2063 6f6e 7461 696e  A Device contain
+0000c610: 696e 6720 6120 706f 6c79 676f 6e28 7329  ing a polygon(s)
+0000c620: 2077 6974 6820 7468 6520 7370 6563 6966   with the specif
+0000c630: 6965 6420 6f66 6673 6574 2061 7070 6c69  ied offset appli
+0000c640: 6564 2e0a 2020 2020 2222 220a 0a20 2020  ed..    """..   
+0000c650: 2064 203d 2072 6f75 6e64 2864 6973 7461   d = round(dista
+0000c660: 6e63 6520 2f20 7072 6563 6973 696f 6e29  nce / precision)
+0000c670: 2020 2320 5468 6520 6469 7374 616e 6365    # The distance
+0000c680: 2069 6e20 6461 7461 6261 7365 2075 6e69   in database uni
+0000c690: 7473 0a20 2020 2044 203d 205f 6b6c 5f65  ts.    D = _kl_e
+0000c6a0: 7870 7265 7373 696f 6e28 0a20 2020 2020  xpression(.     
+0000c6b0: 2020 2065 6c65 6d65 6e74 5f64 6963 743d     element_dict=
+0000c6c0: 6469 6374 2841 3d65 6c65 6d65 6e74 7329  dict(A=elements)
+0000c6d0: 2c0a 2020 2020 2020 2020 6578 7072 6573  ,.        expres
+0000c6e0: 7369 6f6e 3d66 2241 2e73 697a 6564 287b  sion=f"A.sized({
+0000c6f0: 647d 2c20 7b6d 6974 6572 5f6d 6f64 657d  d}, {miter_mode}
+0000c700: 2922 2c0a 2020 2020 2020 2020 7072 6563  )",.        prec
+0000c710: 6973 696f 6e3d 7072 6563 6973 696f 6e2c  ision=precision,
+0000c720: 0a20 2020 2020 2020 2074 696c 655f 7369  .        tile_si
+0000c730: 7a65 3d74 696c 655f 7369 7a65 2c0a 2020  ze=tile_size,.  
+0000c740: 2020 2020 2020 6d65 7267 655f 6669 7273        merge_firs
+0000c750: 743d 5472 7565 2c0a 2020 2020 2020 2020  t=True,.        
+0000c760: 6d65 7267 655f 6166 7465 723d 6d65 7267  merge_after=merg
+0000c770: 655f 6166 7465 722c 0a20 2020 2020 2020  e_after,.       
+0000c780: 206f 7574 7075 745f 6e61 6d65 3d22 6f66   output_name="of
+0000c790: 6673 6574 222c 0a20 2020 2020 2020 206e  fset",.        n
+0000c7a0: 756d 5f63 7075 3d6e 756d 5f63 7075 2c0a  um_cpu=num_cpu,.
+0000c7b0: 2020 2020 2020 2020 6c61 7965 723d 6c61          layer=la
+0000c7c0: 7965 722c 0a20 2020 2029 0a0a 2020 2020  yer,.    )..    
+0000c7d0: 7265 7475 726e 2044 0a0a 0a64 6566 206b  return D...def k
+0000c7e0: 6c5f 626f 6f6c 6561 6e28 0a20 2020 2041  l_boolean(.    A
+0000c7f0: 2c0a 2020 2020 422c 0a20 2020 206f 7065  ,.    B,.    ope
+0000c800: 7261 7469 6f6e 2c0a 2020 2020 7072 6563  ration,.    prec
+0000c810: 6973 696f 6e3d 3165 2d34 2c0a 2020 2020  ision=1e-4,.    
+0000c820: 7469 6c65 5f73 697a 653d 2831 3030 302c  tile_size=(1000,
+0000c830: 2031 3030 3029 2c0a 2020 2020 6d65 7267   1000),.    merg
+0000c840: 655f 6166 7465 723d 5472 7565 2c0a 2020  e_after=True,.  
+0000c850: 2020 6e75 6d5f 6370 753d 2261 6c6c 222c    num_cpu="all",
+0000c860: 0a20 2020 206c 6179 6572 3d30 2c0a 293a  .    layer=0,.):
+0000c870: 0a20 2020 2022 2222 0a20 2020 2050 6572  .    """.    Per
+0000c880: 666f 726d 7320 626f 6f6c 6561 6e20 6f70  forms boolean op
+0000c890: 6572 6174 696f 6e73 2062 6574 7765 656e  erations between
+0000c8a0: 2032 2044 6576 6963 652f 4465 7669 6365   2 Device/Device
+0000c8b0: 5265 6665 7265 6e63 6520 6f62 6a65 6374  Reference object
+0000c8c0: 732c 0a20 2020 206f 7220 6c69 7374 7320  s,.    or lists 
+0000c8d0: 6f66 2044 6576 6963 6573 2f44 6576 6963  of Devices/Devic
+0000c8e0: 6552 6566 6572 656e 6365 732e 0a0a 2020  eReferences...  
+0000c8f0: 2020 6060 6f70 6572 6174 696f 6e60 6020    ``operation`` 
+0000c900: 7368 6f75 6c64 2062 6520 6f6e 6520 6f66  should be one of
+0000c910: 207b 276e 6f74 272c 2027 616e 6427 2c20   {'not', 'and', 
+0000c920: 276f 7227 2c20 2778 6f72 272c 2027 412d  'or', 'xor', 'A-
+0000c930: 4227 2c20 2742 2d41 272c 2027 412b 4227  B', 'B-A', 'A+B'
+0000c940: 7d2e 0a20 2020 204e 6f74 6520 7468 6174  }..    Note that
+0000c950: 2027 412b 4227 2069 7320 6571 7569 7661   'A+B' is equiva
+0000c960: 6c65 6e74 2074 6f20 276f 7227 2c20 2741  lent to 'or', 'A
+0000c970: 2d42 2720 6973 2065 7175 6976 616c 656e  -B' is equivalen
+0000c980: 7420 746f 2027 6e6f 7427 2c20 616e 640a  t to 'not', and.
+0000c990: 2020 2020 2742 2d41 2720 6973 2065 7175      'B-A' is equ
+0000c9a0: 6976 616c 656e 7420 746f 2027 6e6f 7427  ivalent to 'not'
+0000c9b0: 2077 6974 6820 7468 6520 6f70 6572 616e   with the operan
+0000c9c0: 6473 2073 7769 7463 6865 640a 0a20 2020  ds switched..   
+0000c9d0: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+0000c9e0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2041  ----------.    A
+0000c9f0: 203a 2044 6576 6963 6528 2f52 6566 6572   : Device(/Refer
+0000ca00: 656e 6365 2920 6f72 206c 6973 7420 6f66  ence) or list of
+0000ca10: 2044 6576 6963 6528 2f52 6566 6572 656e   Device(/Referen
+0000ca20: 6365 2920 6f72 2050 6f6c 7967 6f6e 0a20  ce) or Polygon. 
+0000ca30: 2020 2020 2020 2049 6e70 7574 2044 6576         Input Dev
+0000ca40: 6963 6573 2e0a 2020 2020 4220 3a20 4465  ices..    B : De
+0000ca50: 7669 6365 282f 5265 6665 7265 6e63 6529  vice(/Reference)
+0000ca60: 206f 7220 6c69 7374 206f 6620 4465 7669   or list of Devi
+0000ca70: 6365 282f 5265 6665 7265 6e63 6529 206f  ce(/Reference) o
+0000ca80: 7220 506f 6c79 676f 6e0a 2020 2020 2020  r Polygon.      
+0000ca90: 2020 496e 7075 7420 4465 7669 6365 732e    Input Devices.
+0000caa0: 0a20 2020 206f 7065 7261 7469 6f6e 203a  .    operation :
+0000cab0: 207b 276e 6f74 272c 2027 616e 6427 2c20   {'not', 'and', 
+0000cac0: 276f 7227 2c20 2778 6f72 272c 2027 412d  'or', 'xor', 'A-
+0000cad0: 4227 2c20 2742 2d41 272c 2027 412b 4227  B', 'B-A', 'A+B'
+0000cae0: 7d0a 2020 2020 2020 2020 426f 6f6c 6561  }.        Boolea
+0000caf0: 6e20 6f70 6572 6174 696f 6e20 746f 2070  n operation to p
+0000cb00: 6572 666f 726d 2e0a 2020 2020 7072 6563  erform..    prec
+0000cb10: 6973 696f 6e20 3a20 666c 6f61 740a 2020  ision : float.  
+0000cb20: 2020 2020 2020 4465 7369 7265 6420 7072        Desired pr
+0000cb30: 6563 6973 696f 6e20 666f 7220 726f 756e  ecision for roun
+0000cb40: 6469 6e67 2076 6572 7465 7820 636f 6f72  ding vertex coor
+0000cb50: 6469 6e61 7465 732e 0a20 2020 2074 696c  dinates..    til
+0000cb60: 655f 7369 7a65 203a 2061 7272 6179 2d6c  e_size : array-l
+0000cb70: 696b 655b 325d 0a20 2020 2020 2020 2054  ike[2].        T
+0000cb80: 6865 2074 696c 6520 7369 7a65 2077 6974  he tile size wit
+0000cb90: 6820 7768 6963 6820 7468 6520 6765 6f6d  h which the geom
+0000cba0: 6574 7279 2069 7320 6469 7669 6465 642e  etry is divided.
+0000cbb0: 2054 6869 7320 616c 6c6f 7773 2066 6f72   This allows for
+0000cbc0: 2065 6163 680a 2020 2020 2020 2020 7265   each.        re
+0000cbd0: 6769 6f6e 2074 6f20 6265 7072 6f63 6573  gion to beproces
+0000cbe0: 7365 6420 7365 7175 656e 7469 616c 6c79  sed sequentially
+0000cbf0: 2c20 7768 6963 6820 6973 206d 6f72 6520  , which is more 
+0000cc00: 636f 6d70 7574 6174 696f 6e61 6c6c 790a  computationally.
+0000cc10: 2020 2020 2020 2020 6566 6669 6369 656e          efficien
+0000cc20: 7420 2861 6e64 2063 616e 2062 6520 7275  t (and can be ru
+0000cc30: 6e20 696e 2070 6172 616c 6c65 6c20 6f6e  n in parallel on
+0000cc40: 206d 756c 7469 706c 6520 4350 5520 636f   multiple CPU co
+0000cc50: 7265 7329 2e0a 2020 2020 6d65 7267 655f  res)..    merge_
+0000cc60: 6166 7465 723a 2062 6f6f 6c0a 2020 2020  after: bool.    
+0000cc70: 2020 2020 4d65 7267 6520 616c 6c20 7468      Merge all th
+0000cc80: 6520 706f 6c79 676f 6e73 2061 6674 6572  e polygons after
+0000cc90: 2070 6572 666f 726d 696e 6720 7468 6520   performing the 
+0000cca0: 7469 6c65 6420 626f 6f6c 6561 6e20 6f70  tiled boolean op
+0000ccb0: 6572 6174 696f 6e0a 2020 2020 6e75 6d5f  eration.    num_
+0000ccc0: 6370 7520 3a20 696e 7420 6f72 2022 616c  cpu : int or "al
+0000ccd0: 6c22 0a20 2020 2020 2020 204e 756d 6265  l".        Numbe
+0000cce0: 7220 6f66 2043 5055 2063 6f72 6573 2074  r of CPU cores t
+0000ccf0: 6f20 7573 652e 2042 7920 6465 6661 756c  o use. By defaul
+0000cd00: 742c 2069 7420 7573 6573 2061 6c6c 2061  t, it uses all a
+0000cd10: 7661 696c 6162 6c65 2043 5055 2063 6f72  vailable CPU cor
+0000cd20: 6573 2c0a 2020 2020 2020 2020 6275 7420  es,.        but 
+0000cd30: 7468 6973 2064 6566 6175 6c74 2063 616e  this default can
+0000cd40: 2062 6520 7365 7420 6279 2060 7068 6964   be set by `phid
+0000cd50: 6c2e 636f 6e66 6967 5b27 4e55 4d5f 4350  l.config['NUM_CP
+0000cd60: 5527 5d20 3d20 3260 0a20 2020 206c 6179  U'] = 2`.    lay
+0000cd70: 6572 203a 2069 6e74 2c20 6172 7261 792d  er : int, array-
+0000cd80: 6c69 6b65 5b32 5d2c 206f 7220 7365 740a  like[2], or set.
+0000cd90: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
+0000cda0: 206c 6179 6572 2873 2920 746f 2070 7574   layer(s) to put
+0000cdb0: 2070 6f6c 7967 6f6e 2067 656f 6d65 7472   polygon geometr
+0000cdc0: 7920 6f6e 2e0a 0a20 2020 2052 6574 7572  y on...    Retur
+0000cdd0: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+0000cde0: 2020 2044 203a 2044 6576 6963 650a 2020     D : Device.  
+0000cdf0: 2020 2020 2020 4120 4465 7669 6365 2063        A Device c
+0000ce00: 6f6e 7461 696e 696e 6720 6120 706f 6c79  ontaining a poly
+0000ce10: 676f 6e28 7329 2077 6974 6820 7468 6520  gon(s) with the 
+0000ce20: 626f 6f6c 6561 6e20 6f70 6572 6174 696f  boolean operatio
+0000ce30: 6e20 6170 706c 6965 642e 0a20 2020 2022  n applied..    "
+0000ce40: 2222 0a0a 2020 2020 6f70 6572 6174 696f  ""..    operatio
+0000ce50: 6e20 3d20 6f70 6572 6174 696f 6e2e 6c6f  n = operation.lo
+0000ce60: 7765 7228 292e 7265 706c 6163 6528 2220  wer().replace(" 
+0000ce70: 222c 2022 2229 0a20 2020 2069 6620 6f70  ", "").    if op
+0000ce80: 6572 6174 696f 6e20 696e 207b 2261 2d62  eration in {"a-b
+0000ce90: 222c 2022 6e6f 7422 7d3a 0a20 2020 2020  ", "not"}:.     
+0000cea0: 2020 206f 7065 7261 7469 6f6e 5f6b 6c20     operation_kl 
+0000ceb0: 3d20 222d 220a 2020 2020 656c 6966 206f  = "-".    elif o
+0000cec0: 7065 7261 7469 6f6e 2069 6e20 7b22 622d  peration in {"b-
+0000ced0: 6122 7d3a 0a20 2020 2020 2020 206f 7065  a"}:.        ope
+0000cee0: 7261 7469 6f6e 5f6b 6c20 3d20 222d 220a  ration_kl = "-".
+0000cef0: 2020 2020 656c 6966 206f 7065 7261 7469      elif operati
+0000cf00: 6f6e 2069 6e20 7b22 612b 6222 2c20 226f  on in {"a+b", "o
+0000cf10: 7222 7d3a 0a20 2020 2020 2020 206f 7065  r"}:.        ope
+0000cf20: 7261 7469 6f6e 5f6b 6c20 3d20 222b 220a  ration_kl = "+".
+0000cf30: 2020 2020 656c 6966 206f 7065 7261 7469      elif operati
+0000cf40: 6f6e 2069 6e20 7b22 615e 6222 2c20 2278  on in {"a^b", "x
+0000cf50: 6f72 227d 3a0a 2020 2020 2020 2020 6f70  or"}:.        op
+0000cf60: 6572 6174 696f 6e5f 6b6c 203d 2022 5e22  eration_kl = "^"
+0000cf70: 0a20 2020 2065 6c69 6620 6f70 6572 6174  .    elif operat
+0000cf80: 696f 6e20 696e 207b 2261 2662 222c 2022  ion in {"a&b", "
+0000cf90: 616e 6422 7d3a 0a20 2020 2020 2020 206f  and"}:.        o
+0000cfa0: 7065 7261 7469 6f6e 5f6b 6c20 3d20 2226  peration_kl = "&
+0000cfb0: 220a 2020 2020 656c 7365 3a0a 2020 2020  ".    else:.    
+0000cfc0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+0000cfd0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0000cfe0: 2020 225b 5048 4944 4c5d 2070 6869 646c    "[PHIDL] phidl
+0000cff0: 2e67 656f 6d65 7472 792e 626f 6f6c 6561  .geometry.boolea
+0000d000: 6e28 2920 606f 7065 7261 7469 6f6e 6020  n() `operation` 
+0000d010: 7061 7261 6d65 7465 7222 0a20 2020 2020  parameter".     
+0000d020: 2020 2020 2020 202b 2022 206e 6f74 2072         + " not r
+0000d030: 6563 6f67 6e69 7a65 642c 206d 7573 7420  ecognized, must 
+0000d040: 6265 206f 6e65 206f 6620 7468 6520 666f  be one of the fo
+0000d050: 6c6c 6f77 696e 673a 2020 276e 6f74 272c  llowing:  'not',
+0000d060: 220a 2020 2020 2020 2020 2020 2020 2b20  ".            + 
+0000d070: 2220 2761 6e64 272c 2027 6f72 272c 2027  " 'and', 'or', '
+0000d080: 786f 7227 2c20 2741 2d42 272c 2027 422d  xor', 'A-B', 'B-
+0000d090: 4127 2c20 2741 2b42 272c 2020 2741 2642  A', 'A+B',  'A&B
+0000d0a0: 272c 2027 415e 4227 220a 2020 2020 2020  ', 'A^B'".      
+0000d0b0: 2020 290a 0a20 2020 2044 203d 205f 6b6c    )..    D = _kl
+0000d0c0: 5f65 7870 7265 7373 696f 6e28 0a20 2020  _expression(.   
+0000d0d0: 2020 2020 2065 6c65 6d65 6e74 5f64 6963       element_dic
+0000d0e0: 743d 6469 6374 2841 3d41 2c20 423d 4229  t=dict(A=A, B=B)
+0000d0f0: 2c0a 2020 2020 2020 2020 6578 7072 6573  ,.        expres
+0000d100: 7369 6f6e 3d66 2241 207b 6f70 6572 6174  sion=f"A {operat
+0000d110: 696f 6e5f 6b6c 7d20 4222 2c0a 2020 2020  ion_kl} B",.    
+0000d120: 2020 2020 7072 6563 6973 696f 6e3d 7072      precision=pr
+0000d130: 6563 6973 696f 6e2c 0a20 2020 2020 2020  ecision,.       
+0000d140: 2074 696c 655f 7369 7a65 3d74 696c 655f   tile_size=tile_
+0000d150: 7369 7a65 2c0a 2020 2020 2020 2020 6d65  size,.        me
+0000d160: 7267 655f 6669 7273 743d 5472 7565 2c0a  rge_first=True,.
+0000d170: 2020 2020 2020 2020 6d65 7267 655f 6166          merge_af
+0000d180: 7465 723d 6d65 7267 655f 6166 7465 722c  ter=merge_after,
+0000d190: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
+0000d1a0: 6e61 6d65 3d22 626f 6f6c 6561 6e22 2c0a  name="boolean",.
+0000d1b0: 2020 2020 2020 2020 6e75 6d5f 6370 753d          num_cpu=
+0000d1c0: 6e75 6d5f 6370 752c 0a20 2020 2020 2020  num_cpu,.       
+0000d1d0: 206c 6179 6572 3d6c 6179 6572 2c0a 2020   layer=layer,.  
+0000d1e0: 2020 290a 0a20 2020 2072 6574 7572 6e20    )..    return 
+0000d1f0: 440a 0a0a 6465 6620 6b6c 5f6f 7574 6c69  D...def kl_outli
+0000d200: 6e65 280a 2020 2020 656c 656d 656e 7473  ne(.    elements
+0000d210: 2c0a 2020 2020 6469 7374 616e 6365 3d30  ,.    distance=0
+0000d220: 2e31 2c0a 2020 2020 6f70 656e 5f70 6f72  .1,.    open_por
+0000d230: 7473 3d46 616c 7365 2c0a 2020 2020 7072  ts=False,.    pr
+0000d240: 6563 6973 696f 6e3d 3165 2d34 2c0a 2020  ecision=1e-4,.  
+0000d250: 2020 6d69 7465 725f 6d6f 6465 3d32 2c0a    miter_mode=2,.
+0000d260: 2020 2020 7469 6c65 5f73 697a 653d 2831      tile_size=(1
+0000d270: 3030 302c 2031 3030 3029 2c0a 2020 2020  000, 1000),.    
+0000d280: 6d65 7267 655f 6166 7465 723d 5472 7565  merge_after=True
+0000d290: 2c0a 2020 2020 6e75 6d5f 6370 753d 2261  ,.    num_cpu="a
+0000d2a0: 6c6c 222c 0a20 2020 206c 6179 6572 3d30  ll",.    layer=0
+0000d2b0: 2c0a 293a 0a20 2020 2022 2222 5368 7269  ,.):.    """Shri
+0000d2c0: 6e6b 7320 6f72 2065 7870 616e 6473 2061  nks or expands a
+0000d2d0: 2070 6f6c 7967 6f6e 206f 7220 7365 7420   polygon or set 
+0000d2e0: 6f66 2070 6f6c 7967 6f6e 7320 7573 696e  of polygons usin
+0000d2f0: 6720 4b4c 6179 6f75 740a 0a20 2020 2050  g KLayout..    P
+0000d300: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+0000d310: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2065 6c65  --------.    ele
+0000d320: 6d65 6e74 7320 3a20 4465 7669 6365 282f  ments : Device(/
+0000d330: 5265 6665 7265 6e63 6529 2c20 6c69 7374  Reference), list
+0000d340: 206f 6620 4465 7669 6365 282f 5265 6665   of Device(/Refe
+0000d350: 7265 6e63 6529 2c20 6f72 2050 6f6c 7967  rence), or Polyg
+0000d360: 6f6e 0a20 2020 2020 2020 2050 6f6c 7967  on.        Polyg
+0000d370: 6f6e 7320 746f 206f 6666 7365 7420 6f72  ons to offset or
+0000d380: 2044 6576 6963 6520 636f 6e74 6169 6e69   Device containi
+0000d390: 6e67 2070 6f6c 7967 6f6e 7320 746f 206f  ng polygons to o
+0000d3a0: 6666 7365 742e 0a20 2020 2064 6973 7461  ffset..    dista
+0000d3b0: 6e63 6520 3a20 696e 7420 6f72 2066 6c6f  nce : int or flo
+0000d3c0: 6174 0a20 2020 2020 2020 2044 6973 7461  at.        Dista
+0000d3d0: 6e63 6520 746f 206f 6666 7365 7420 706f  nce to offset po
+0000d3e0: 6c79 676f 6e73 2e20 506f 7369 7469 7665  lygons. Positive
+0000d3f0: 2076 616c 7565 7320 6578 7061 6e64 2c20   values expand, 
+0000d400: 6e65 6761 7469 7665 2073 6872 696e 6b2e  negative shrink.
+0000d410: 0a20 2020 206f 7065 6e5f 706f 7274 7320  .    open_ports 
+0000d420: 3a20 626f 6f6c 206f 7220 666c 6f61 740a  : bool or float.
+0000d430: 2020 2020 2020 2020 4966 206e 6f74 2046          If not F
+0000d440: 616c 7365 2c20 686f 6c65 7320 7769 6c6c  alse, holes will
+0000d450: 2062 6520 6375 7420 696e 2074 6865 206f   be cut in the o
+0000d460: 7574 6c69 6e65 2073 7563 6820 7468 6174  utline such that
+0000d470: 2074 6865 2050 6f72 7473 2061 7265 0a20   the Ports are. 
+0000d480: 2020 2020 2020 206e 6f74 2063 6f76 6572         not cover
+0000d490: 6564 2e20 4966 2054 7275 652c 2074 6865  ed. If True, the
+0000d4a0: 2068 6f6c 6573 2077 696c 6c20 6861 7665   holes will have
+0000d4b0: 2074 6865 2073 616d 6520 7769 6474 6820   the same width 
+0000d4c0: 6173 2074 6865 2050 6f72 7473 2e0a 2020  as the Ports..  
+0000d4d0: 2020 2020 2020 4966 2061 2066 6c6f 6174        If a float
+0000d4e0: 2c20 7468 6520 686f 6c65 7320 7769 6c6c  , the holes will
+0000d4f0: 2062 6520 6265 2077 6964 656e 6564 2062   be be widened b
+0000d500: 7920 7468 6174 2076 616c 7565 2028 7573  y that value (us
+0000d510: 6566 756c 2066 6f72 2066 756c 6c79 0a20  eful for fully. 
+0000d520: 2020 2020 2020 2063 6c65 6172 696e 6720         clearing 
+0000d530: 7468 6520 6f75 746c 696e 6520 6172 6f75  the outline arou
+0000d540: 6e64 2074 6865 2050 6f72 7473 2066 6f72  nd the Ports for
+0000d550: 2070 6f73 6974 6976 652d 746f 6e65 2070   positive-tone p
+0000d560: 726f 6365 7373 6573 0a20 2020 2070 7265  rocesses.    pre
+0000d570: 6369 7369 6f6e 203a 2066 6c6f 6174 0a20  cision : float. 
+0000d580: 2020 2020 2020 2044 6573 6972 6564 2070         Desired p
+0000d590: 7265 6369 7369 6f6e 2066 6f72 2072 6f75  recision for rou
+0000d5a0: 6e64 696e 6720 7665 7274 6578 2063 6f6f  nding vertex coo
+0000d5b0: 7264 696e 6174 6573 2e0a 2020 2020 6d69  rdinates..    mi
+0000d5c0: 7465 725f 6d6f 6465 203a 2069 6e74 0a20  ter_mode : int. 
+0000d5d0: 2020 2020 2020 2054 7970 6520 6f66 2063         Type of c
+0000d5e0: 6f72 6e65 7273 2067 656e 6572 6174 6564  orners generated
+0000d5f0: 2064 7572 696e 6720 7468 6520 6f66 6673   during the offs
+0000d600: 6574 206f 7065 7261 7469 6f6e 2c20 7365  et operation, se
+0000d610: 650a 2020 2020 2020 2020 6874 7470 733a  e.        https:
+0000d620: 2f2f 7777 772e 6b6c 6179 6f75 742e 6465  //www.klayout.de
+0000d630: 2f64 6f63 2f63 6f64 652f 636c 6173 735f  /doc/code/class_
+0000d640: 4564 6765 5072 6f63 6573 736f 722e 6874  EdgeProcessor.ht
+0000d650: 6d6c 236d 6574 686f 6435 350a 2020 2020  ml#method55.    
+0000d660: 7469 6c65 5f73 697a 6520 3a20 6172 7261  tile_size : arra
+0000d670: 792d 6c69 6b65 5b32 5d0a 2020 2020 2020  y-like[2].      
+0000d680: 2020 5468 6520 7469 6c65 2073 697a 6520    The tile size 
+0000d690: 7769 7468 2077 6869 6368 2074 6865 2067  with which the g
+0000d6a0: 656f 6d65 7472 7920 6973 2064 6976 6964  eometry is divid
+0000d6b0: 6564 2e20 5468 6973 2061 6c6c 6f77 7320  ed. This allows 
+0000d6c0: 666f 7220 6561 6368 0a20 2020 2020 2020  for each.       
+0000d6d0: 2072 6567 696f 6e20 746f 2062 6570 726f   region to bepro
+0000d6e0: 6365 7373 6564 2073 6571 7565 6e74 6961  cessed sequentia
+0000d6f0: 6c6c 792c 2077 6869 6368 2069 7320 6d6f  lly, which is mo
+0000d700: 7265 2063 6f6d 7075 7461 7469 6f6e 616c  re computational
+0000d710: 6c79 0a20 2020 2020 2020 2065 6666 6963  ly.        effic
+0000d720: 6965 6e74 2028 616e 6420 6361 6e20 6265  ient (and can be
+0000d730: 2072 756e 2069 6e20 7061 7261 6c6c 656c   run in parallel
+0000d740: 206f 6e20 6d75 6c74 6970 6c65 2043 5055   on multiple CPU
+0000d750: 2063 6f72 6573 292e 0a20 2020 206d 6572   cores)..    mer
+0000d760: 6765 5f61 6674 6572 3a20 626f 6f6c 0a20  ge_after: bool. 
+0000d770: 2020 2020 2020 204d 6572 6765 2061 6c6c         Merge all
+0000d780: 2074 6865 2070 6f6c 7967 6f6e 7320 6166   the polygons af
+0000d790: 7465 7220 7065 7266 6f72 6d69 6e67 2074  ter performing t
+0000d7a0: 6865 206f 7574 6c69 6e65 206f 7065 7261  he outline opera
+0000d7b0: 7469 6f6e 0a20 2020 206e 756d 5f63 7075  tion.    num_cpu
+0000d7c0: 203a 2069 6e74 206f 7220 2261 6c6c 220a   : int or "all".
+0000d7d0: 2020 2020 2020 2020 4e75 6d62 6572 206f          Number o
+0000d7e0: 6620 4350 5520 636f 7265 7320 746f 2075  f CPU cores to u
+0000d7f0: 7365 2e20 4279 2064 6566 6175 6c74 2c20  se. By default, 
+0000d800: 6974 2075 7365 7320 616c 6c20 6176 6169  it uses all avai
+0000d810: 6c61 626c 6520 4350 5520 636f 7265 732c  lable CPU cores,
+0000d820: 0a20 2020 2020 2020 2062 7574 2074 6869  .        but thi
+0000d830: 7320 6465 6661 756c 7420 6361 6e20 6265  s default can be
+0000d840: 2073 6574 2062 7920 6070 6869 646c 2e63   set by `phidl.c
+0000d850: 6f6e 6669 675b 274e 554d 5f43 5055 275d  onfig['NUM_CPU']
+0000d860: 203d 2032 600a 2020 2020 6c61 7965 7220   = 2`.    layer 
+0000d870: 3a20 696e 742c 2061 7272 6179 2d6c 696b  : int, array-lik
+0000d880: 655b 325d 2c20 6f72 2073 6574 0a20 2020  e[2], or set.   
+0000d890: 2020 2020 2053 7065 6369 6669 6320 6c61       Specific la
+0000d8a0: 7965 7228 7329 2074 6f20 7075 7420 706f  yer(s) to put po
+0000d8b0: 6c79 676f 6e20 6765 6f6d 6574 7279 206f  lygon geometry o
+0000d8c0: 6e2e 0a0a 2020 2020 5265 7475 726e 730a  n...    Returns.
+0000d8d0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+0000d8e0: 4420 3a20 4465 7669 6365 0a20 2020 2020  D : Device.     
+0000d8f0: 2020 2041 2044 6576 6963 6520 636f 6e74     A Device cont
+0000d900: 6169 6e69 6e67 2061 2070 6f6c 7967 6f6e  aining a polygon
+0000d910: 2873 2920 7769 7468 2074 6865 2073 7065  (s) with the spe
+0000d920: 6369 6669 6564 206f 6666 7365 7420 6170  cified offset ap
+0000d930: 706c 6965 642e 0a20 2020 2022 2222 0a0a  plied..    """..
+0000d940: 2020 2020 6420 3d20 726f 756e 6428 6469      d = round(di
+0000d950: 7374 616e 6365 202f 2070 7265 6369 7369  stance / precisi
+0000d960: 6f6e 2920 2023 2054 6865 2064 6973 7461  on)  # The dista
+0000d970: 6e63 6520 696e 2064 6174 6162 6173 6520  nce in database 
+0000d980: 756e 6974 730a 0a20 2020 2023 2047 6574  units..    # Get
+0000d990: 206c 6973 7420 6f66 2070 6f72 7473 2074   list of ports t
+0000d9a0: 6f20 6265 206f 7065 6e65 640a 2020 2020  o be opened.    
+0000d9b0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
+0000d9c0: 6528 656c 656d 656e 7473 2c20 6c69 7374  e(elements, list
+0000d9d0: 293a 0a20 2020 2020 2020 2065 6c65 6d65  ):.        eleme
+0000d9e0: 6e74 7320 3d20 5b65 6c65 6d65 6e74 735d  nts = [elements]
+0000d9f0: 0a20 2020 2070 6f72 745f 6c69 7374 203d  .    port_list =
+0000da00: 205b 5d0a 2020 2020 666f 7220 6520 696e   [].    for e in
+0000da10: 2065 6c65 6d65 6e74 733a 0a20 2020 2020   elements:.     
+0000da20: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0000da30: 2865 2c20 4465 7669 6365 293a 0a20 2020  (e, Device):.   
+0000da40: 2020 2020 2020 2020 2070 6f72 745f 6c69           port_li
+0000da50: 7374 202b 3d20 6c69 7374 2865 2e70 6f72  st += list(e.por
+0000da60: 7473 2e76 616c 7565 7328 2929 0a0a 2020  ts.values())..  
+0000da70: 2020 5472 696d 203d 2044 6576 6963 6528    Trim = Device(
+0000da80: 290a 2020 2020 6966 206f 7065 6e5f 706f  ).    if open_po
+0000da90: 7274 7320 6973 206e 6f74 2046 616c 7365  rts is not False
+0000daa0: 3a0a 2020 2020 2020 2020 6966 206f 7065  :.        if ope
+0000dab0: 6e5f 706f 7274 7320 6973 2054 7275 653a  n_ports is True:
+0000dac0: 0a20 2020 2020 2020 2020 2020 2074 7269  .            tri
+0000dad0: 6d5f 7769 6474 6820 3d20 300a 2020 2020  m_width = 0.    
+0000dae0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000daf0: 2020 2020 2020 7472 696d 5f77 6964 7468        trim_width
+0000db00: 203d 206f 7065 6e5f 706f 7274 7320 2a20   = open_ports * 
+0000db10: 320a 2020 2020 2020 2020 666f 7220 706f  2.        for po
+0000db20: 7274 2069 6e20 706f 7274 5f6c 6973 743a  rt in port_list:
+0000db30: 0a20 2020 2020 2020 2020 2020 2074 7269  .            tri
+0000db40: 6d20 3d20 636f 6d70 6173 7328 7369 7a65  m = compass(size
+0000db50: 3d28 6469 7374 616e 6365 202b 2036 202a  =(distance + 6 *
+0000db60: 2070 7265 6369 7369 6f6e 2c20 706f 7274   precision, port
+0000db70: 2e77 6964 7468 202b 2074 7269 6d5f 7769  .width + trim_wi
+0000db80: 6474 6829 290a 2020 2020 2020 2020 2020  dth)).          
+0000db90: 2020 7472 696d 5f72 6566 203d 2054 7269    trim_ref = Tri
+0000dba0: 6d20 3c3c 2074 7269 6d0a 2020 2020 2020  m << trim.      
+0000dbb0: 2020 2020 2020 7472 696d 5f72 6566 2e63        trim_ref.c
+0000dbc0: 6f6e 6e65 6374 2822 4522 2c20 706f 7274  onnect("E", port
+0000dbd0: 2c20 6f76 6572 6c61 703d 3220 2a20 7072  , overlap=2 * pr
+0000dbe0: 6563 6973 696f 6e29 0a0a 2020 2020 4420  ecision)..    D 
+0000dbf0: 3d20 5f6b 6c5f 6578 7072 6573 7369 6f6e  = _kl_expression
+0000dc00: 280a 2020 2020 2020 2020 656c 656d 656e  (.        elemen
+0000dc10: 745f 6469 6374 3d64 6963 7428 413d 656c  t_dict=dict(A=el
+0000dc20: 656d 656e 7473 2c20 423d 5472 696d 292c  ements, B=Trim),
+0000dc30: 0a20 2020 2020 2020 2065 7870 7265 7373  .        express
+0000dc40: 696f 6e3d 6622 412e 7369 7a65 6428 7b64  ion=f"A.sized({d
+0000dc50: 7d2c 207b 6d69 7465 725f 6d6f 6465 7d29  }, {miter_mode})
+0000dc60: 202d 2028 4120 2b20 4229 222c 0a20 2020   - (A + B)",.   
+0000dc70: 2020 2020 2070 7265 6369 7369 6f6e 3d70       precision=p
+0000dc80: 7265 6369 7369 6f6e 2c0a 2020 2020 2020  recision,.      
+0000dc90: 2020 7469 6c65 5f73 697a 653d 7469 6c65    tile_size=tile
+0000dca0: 5f73 697a 652c 0a20 2020 2020 2020 206d  _size,.        m
+0000dcb0: 6572 6765 5f66 6972 7374 3d54 7275 652c  erge_first=True,
+0000dcc0: 0a20 2020 2020 2020 206d 6572 6765 5f61  .        merge_a
+0000dcd0: 6674 6572 3d6d 6572 6765 5f61 6674 6572  fter=merge_after
+0000dce0: 2c0a 2020 2020 2020 2020 6f75 7470 7574  ,.        output
+0000dcf0: 5f6e 616d 653d 226f 7574 6c69 6e65 222c  _name="outline",
+0000dd00: 0a20 2020 2020 2020 206e 756d 5f63 7075  .        num_cpu
+0000dd10: 3d6e 756d 5f63 7075 2c0a 2020 2020 2020  =num_cpu,.      
+0000dd20: 2020 6c61 7965 723d 6c61 7965 722c 0a20    layer=layer,. 
+0000dd30: 2020 2029 0a0a 2020 2020 6966 206f 7065     )..    if ope
+0000dd40: 6e5f 706f 7274 7320 6973 206e 6f74 2046  n_ports is not F
+0000dd50: 616c 7365 2061 6e64 206c 656e 2865 6c65  alse and len(ele
+0000dd60: 6d65 6e74 7329 203d 3d20 313a 0a20 2020  ments) == 1:.   
+0000dd70: 2020 2020 2066 6f72 2070 6f72 7420 696e       for port in
+0000dd80: 2070 6f72 745f 6c69 7374 3a0a 2020 2020   port_list:.    
+0000dd90: 2020 2020 2020 2020 442e 6164 645f 706f          D.add_po
+0000dda0: 7274 2870 6f72 743d 706f 7274 290a 0a20  rt(port=port).. 
+0000ddb0: 2020 2072 6574 7572 6e20 440a 0a0a 6465     return D...de
+0000ddc0: 6620 6b6c 5f69 6e76 6572 7428 0a20 2020  f kl_invert(.   
+0000ddd0: 2065 6c65 6d65 6e74 732c 0a20 2020 2062   elements,.    b
+0000dde0: 6f72 6465 723d 2831 302c 2031 3029 2c0a  order=(10, 10),.
+0000ddf0: 2020 2020 7072 6563 6973 696f 6e3d 3165      precision=1e
+0000de00: 2d34 2c0a 2020 2020 7469 6c65 5f73 697a  -4,.    tile_siz
+0000de10: 653d 2831 3030 302c 2031 3030 3029 2c0a  e=(1000, 1000),.
+0000de20: 2020 2020 6d65 7267 655f 6166 7465 723d      merge_after=
+0000de30: 5472 7565 2c0a 2020 2020 6e75 6d5f 6370  True,.    num_cp
+0000de40: 753d 2261 6c6c 222c 0a20 2020 206c 6179  u="all",.    lay
+0000de50: 6572 3d30 2c0a 293a 0a20 2020 2022 2222  er=0,.):.    """
+0000de60: 4372 6561 7465 7320 616e 2069 6e76 6572  Creates an inver
+0000de70: 7465 6420 7665 7273 696f 6e20 6f66 2074  ted version of t
+0000de80: 6865 2069 6e70 7574 2073 6861 7065 7320  he input shapes 
+0000de90: 7769 7468 2061 6e20 6164 6469 7469 6f6e  with an addition
+0000dea0: 616c 0a20 2020 2062 6f72 6465 7220 6172  al.    border ar
+0000deb0: 6f75 6e64 2074 6865 2065 6467 6573 2e0a  ound the edges..
+0000dec0: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+0000ded0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+0000dee0: 2020 2065 6c65 6d65 6e74 7320 3a20 4465     elements : De
+0000def0: 7669 6365 282f 5265 6665 7265 6e63 6529  vice(/Reference)
+0000df00: 2c20 6c69 7374 206f 6620 4465 7669 6365  , list of Device
+0000df10: 282f 5265 6665 7265 6e63 6529 2c20 6f72  (/Reference), or
+0000df20: 2050 6f6c 7967 6f6e 0a20 2020 2020 2020   Polygon.       
+0000df30: 2041 2044 6576 6963 6520 636f 6e74 6169   A Device contai
+0000df40: 6e69 6e67 2074 6865 2070 6f6c 7967 6f6e  ning the polygon
+0000df50: 7320 746f 2069 6e76 6572 742e 0a20 2020  s to invert..   
+0000df60: 2062 6f72 6465 7220 3a20 6172 7261 792d   border : array-
+0000df70: 6c69 6b65 5b32 5d0a 2020 2020 2020 2020  like[2].        
+0000df80: 2864 782c 6479 2920 7369 7a65 206f 6620  (dx,dy) size of 
+0000df90: 7468 6520 626f 7264 6572 2061 726f 756e  the border aroun
+0000dfa0: 6420 7468 6520 696e 7665 7274 6564 2073  d the inverted s
+0000dfb0: 6861 7065 2028 626f 7264 6572 2076 616c  hape (border val
+0000dfc0: 7565 2069 7320 7468 650a 2020 2020 2020  ue is the.      
+0000dfd0: 2020 6469 7374 616e 6365 2066 726f 6d20    distance from 
+0000dfe0: 7468 6520 6564 6765 7320 6f66 2074 6865  the edges of the
+0000dff0: 2062 6f75 6e64 696e 6720 626f 7820 6465   bounding box de
+0000e000: 6669 6e69 6e67 290a 2020 2020 7072 6563  fining).    prec
+0000e010: 6973 696f 6e20 3a20 666c 6f61 740a 2020  ision : float.  
+0000e020: 2020 2020 2020 4465 7369 7265 6420 7072        Desired pr
+0000e030: 6563 6973 696f 6e20 666f 7220 726f 756e  ecision for roun
+0000e040: 6469 6e67 2076 6572 7465 7820 636f 6f72  ding vertex coor
+0000e050: 6469 6e61 7465 732e 0a20 2020 2074 696c  dinates..    til
+0000e060: 655f 7369 7a65 203a 2061 7272 6179 2d6c  e_size : array-l
+0000e070: 696b 655b 325d 0a20 2020 2020 2020 2054  ike[2].        T
+0000e080: 6865 2074 696c 6520 7369 7a65 2077 6974  he tile size wit
+0000e090: 6820 7768 6963 6820 7468 6520 6765 6f6d  h which the geom
+0000e0a0: 6574 7279 2069 7320 6469 7669 6465 642e  etry is divided.
+0000e0b0: 2054 6869 7320 616c 6c6f 7773 2066 6f72   This allows for
+0000e0c0: 2065 6163 680a 2020 2020 2020 2020 7265   each.        re
+0000e0d0: 6769 6f6e 2074 6f20 6265 7072 6f63 6573  gion to beproces
+0000e0e0: 7365 6420 7365 7175 656e 7469 616c 6c79  sed sequentially
+0000e0f0: 2c20 7768 6963 6820 6973 206d 6f72 6520  , which is more 
+0000e100: 636f 6d70 7574 6174 696f 6e61 6c6c 790a  computationally.
+0000e110: 2020 2020 2020 2020 6566 6669 6369 656e          efficien
+0000e120: 7420 2861 6e64 2063 616e 2062 6520 7275  t (and can be ru
+0000e130: 6e20 696e 2070 6172 616c 6c65 6c20 6f6e  n in parallel on
+0000e140: 206d 756c 7469 706c 6520 4350 5520 636f   multiple CPU co
+0000e150: 7265 7329 2e0a 2020 2020 6d65 7267 655f  res)..    merge_
+0000e160: 6166 7465 723a 2062 6f6f 6c0a 2020 2020  after: bool.    
+0000e170: 2020 2020 4d65 7267 6520 616c 6c20 7468      Merge all th
+0000e180: 6520 706f 6c79 676f 6e73 2061 6674 6572  e polygons after
+0000e190: 2070 6572 666f 726d 696e 6720 7468 6520   performing the 
+0000e1a0: 6f75 746c 696e 6520 6f70 6572 6174 696f  outline operatio
+0000e1b0: 6e0a 2020 2020 6e75 6d5f 6370 7520 3a20  n.    num_cpu : 
+0000e1c0: 696e 7420 6f72 2022 616c 6c22 0a20 2020  int or "all".   
+0000e1d0: 2020 2020 204e 756d 6265 7220 6f66 2043       Number of C
+0000e1e0: 5055 2063 6f72 6573 2074 6f20 7573 652e  PU cores to use.
+0000e1f0: 2042 7920 6465 6661 756c 742c 2069 7420   By default, it 
+0000e200: 7573 6573 2061 6c6c 2061 7661 696c 6162  uses all availab
+0000e210: 6c65 2043 5055 2063 6f72 6573 2c0a 2020  le CPU cores,.  
+0000e220: 2020 2020 2020 6275 7420 7468 6973 2064        but this d
+0000e230: 6566 6175 6c74 2063 616e 2062 6520 7365  efault can be se
+0000e240: 7420 6279 2060 7068 6964 6c2e 636f 6e66  t by `phidl.conf
+0000e250: 6967 5b27 4e55 4d5f 4350 5527 5d20 3d20  ig['NUM_CPU'] = 
+0000e260: 3260 0a20 2020 206c 6179 6572 203a 2069  2`.    layer : i
+0000e270: 6e74 2c20 6172 7261 792d 6c69 6b65 5b32  nt, array-like[2
+0000e280: 5d2c 206f 7220 7365 740a 2020 2020 2020  ], or set.      
+0000e290: 2020 5370 6563 6966 6963 206c 6179 6572    Specific layer
+0000e2a0: 2873 2920 746f 2070 7574 2070 6f6c 7967  (s) to put polyg
+0000e2b0: 6f6e 2067 656f 6d65 7472 7920 6f6e 2e0a  on geometry on..
+0000e2c0: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
+0000e2d0: 202d 2d2d 2d2d 2d2d 0a20 2020 2044 203a   -------.    D :
+0000e2e0: 2044 6576 6963 650a 2020 2020 2020 2020   Device.        
+0000e2f0: 4120 4465 7669 6365 2063 6f6e 7461 696e  A Device contain
+0000e300: 696e 6720 7468 6520 696e 7665 7274 6564  ing the inverted
+0000e310: 2076 6572 7369 6f6e 206f 6620 7468 6520   version of the 
+0000e320: 696e 7075 7420 7368 6170 6528 7329 2061  input shape(s) a
+0000e330: 6e64 2074 6865 0a20 2020 2020 2020 2063  nd the.        c
+0000e340: 6f72 7265 7370 6f6e 6469 6e67 2062 6f72  orresponding bor
+0000e350: 6465 7228 7329 2e0a 2020 2020 2222 220a  der(s)..    """.
+0000e360: 2020 2020 6966 206e 702e 7369 7a65 2862      if np.size(b
+0000e370: 6f72 6465 7229 203d 3d20 313a 0a20 2020  order) == 1:.   
+0000e380: 2020 2020 2064 7820 3d20 6479 203d 2072       dx = dy = r
+0000e390: 6f75 6e64 2862 6f72 6465 7220 2f20 7072  ound(border / pr
+0000e3a0: 6563 6973 696f 6e29 0a20 2020 2065 6c69  ecision).    eli
+0000e3b0: 6620 6e70 2e73 697a 6528 626f 7264 6572  f np.size(border
+0000e3c0: 2920 3d3d 2032 3a0a 2020 2020 2020 2020  ) == 2:.        
+0000e3d0: 6478 203d 2072 6f75 6e64 2862 6f72 6465  dx = round(borde
+0000e3e0: 725b 305d 202f 2070 7265 6369 7369 6f6e  r[0] / precision
+0000e3f0: 290a 2020 2020 2020 2020 6479 203d 2072  ).        dy = r
+0000e400: 6f75 6e64 2862 6f72 6465 725b 315d 202f  ound(border[1] /
+0000e410: 2070 7265 6369 7369 6f6e 290a 0a20 2020   precision)..   
+0000e420: 2041 203d 205f 6f62 6a65 6374 735f 746f   A = _objects_to
+0000e430: 5f6b 6c5f 7265 6769 6f6e 2865 6c65 6d65  _kl_region(eleme
+0000e440: 6e74 732c 2070 7265 6369 7369 6f6e 290a  nts, precision).
+0000e450: 2020 2020 4220 3d20 412e 6578 7465 6e74      B = A.extent
+0000e460: 7328 292e 7369 7a65 6428 6478 2c20 6479  s().sized(dx, dy
+0000e470: 2c20 3229 0a0a 2020 2020 4420 3d20 5f6b  , 2)..    D = _k
+0000e480: 6c5f 6578 7072 6573 7369 6f6e 280a 2020  l_expression(.  
+0000e490: 2020 2020 2020 656c 656d 656e 745f 6469        element_di
+0000e4a0: 6374 3d64 6963 7428 413d 412c 2042 3d42  ct=dict(A=A, B=B
+0000e4b0: 292c 0a20 2020 2020 2020 2065 7870 7265  ),.        expre
+0000e4c0: 7373 696f 6e3d 2242 202d 2041 222c 0a20  ssion="B - A",. 
+0000e4d0: 2020 2020 2020 2070 7265 6369 7369 6f6e         precision
+0000e4e0: 3d70 7265 6369 7369 6f6e 2c0a 2020 2020  =precision,.    
+0000e4f0: 2020 2020 7469 6c65 5f73 697a 653d 7469      tile_size=ti
+0000e500: 6c65 5f73 697a 652c 0a20 2020 2020 2020  le_size,.       
+0000e510: 206d 6572 6765 5f66 6972 7374 3d54 7275   merge_first=Tru
+0000e520: 652c 0a20 2020 2020 2020 206d 6572 6765  e,.        merge
+0000e530: 5f61 6674 6572 3d6d 6572 6765 5f61 6674  _after=merge_aft
+0000e540: 6572 2c0a 2020 2020 2020 2020 6f75 7470  er,.        outp
+0000e550: 7574 5f6e 616d 653d 2269 6e76 6572 7422  ut_name="invert"
+0000e560: 2c0a 2020 2020 2020 2020 6e75 6d5f 6370  ,.        num_cp
+0000e570: 753d 6e75 6d5f 6370 752c 0a20 2020 2020  u=num_cpu,.     
+0000e580: 2020 206c 6179 6572 3d6c 6179 6572 2c0a     layer=layer,.
+0000e590: 2020 2020 290a 2020 2020 7265 7475 726e      ).    return
+0000e5a0: 2044 0a0a 0a23 203d 3d3d 3d3d 3d3d 3d3d   D...# =========
+0000e5b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000e5c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000e5d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000e5e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000e5f0: 3d3d 3d3d 3d0a 230a 2320 4c69 7468 6f67  =====.#.# Lithog
+0000e600: 7261 7068 7920 7465 7374 2073 7472 7563  raphy test struc
+0000e610: 7475 7265 730a 230a 2320 3d3d 3d3d 3d3d  tures.#.# ======
+0000e620: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000e630: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000e640: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000e650: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000e660: 3d3d 3d3d 3d3d 3d3d 0a0a 0a64 6566 206c  ========...def l
+0000e670: 6974 686f 5f73 7465 7073 286c 696e 655f  itho_steps(line_
+0000e680: 7769 6474 6873 3d5b 312c 2032 2c20 342c  widths=[1, 2, 4,
+0000e690: 2038 2c20 3136 5d2c 206c 696e 655f 7370   8, 16], line_sp
+0000e6a0: 6163 696e 673d 3130 2c20 6865 6967 6874  acing=10, height
+0000e6b0: 3d31 3030 2c20 6c61 7965 723d 3029 3a0a  =100, layer=0):.
+0000e6c0: 2020 2020 2222 2250 726f 6475 6365 7320      """Produces 
+0000e6d0: 6120 706f 7369 7469 7665 202b 206e 6567  a positive + neg
+0000e6e0: 6174 6976 6520 746f 6e65 206c 696e 6577  ative tone linew
+0000e6f0: 6964 7468 2074 6573 742c 2075 7365 6420  idth test, used 
+0000e700: 666f 720a 2020 2020 6c69 7468 6f67 7261  for.    lithogra
+0000e710: 7068 7920 7265 736f 6c75 7469 6f6e 2074  phy resolution t
+0000e720: 6573 7420 7061 7474 6572 6e69 6e67 2e0a  est patterning..
+0000e730: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+0000e740: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+0000e750: 2020 206c 696e 655f 7769 6474 6873 203a     line_widths :
+0000e760: 2061 7272 6179 2d6c 696b 655b 4e5d 206f   array-like[N] o
+0000e770: 6620 696e 7420 6f72 2066 6c6f 6174 0a20  f int or float. 
+0000e780: 2020 2020 2020 2057 6964 7468 7320 6f66         Widths of
+0000e790: 2074 6865 2073 7465 7073 2028 706f 7369   the steps (posi
+0000e7a0: 7469 7665 2073 6964 6529 2e0a 2020 2020  tive side)..    
+0000e7b0: 6c69 6e65 5f73 7061 6369 6e67 203a 2069  line_spacing : i
+0000e7c0: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
+0000e7d0: 2020 2020 5370 6163 6520 6265 7477 6565      Space betwee
+0000e7e0: 6e20 6561 6368 2073 7465 7020 286e 6567  n each step (neg
+0000e7f0: 6174 6976 6520 7369 6465 292e 0a20 2020  ative side)..   
+0000e800: 2068 6569 6768 7420 3a20 696e 7420 6f72   height : int or
+0000e810: 2066 6c6f 6174 0a20 2020 2020 2020 2048   float.        H
+0000e820: 6569 6768 7420 6f66 2074 6865 2073 7465  eight of the ste
+0000e830: 7073 2e0a 2020 2020 6c61 7965 7220 3a20  ps..    layer : 
+0000e840: 696e 742c 2061 7272 6179 2d6c 696b 655b  int, array-like[
+0000e850: 325d 2c20 6f72 2073 6574 0a20 2020 2020  2], or set.     
+0000e860: 2020 2053 7065 6369 6669 6320 6c61 7965     Specific laye
+0000e870: 7228 7329 2074 6f20 7075 7420 706f 6c79  r(s) to put poly
+0000e880: 676f 6e20 6765 6f6d 6574 7279 206f 6e2e  gon geometry on.
+0000e890: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+0000e8a0: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 4420    -------.    D 
+0000e8b0: 3a20 4465 7669 6365 0a20 2020 2020 2020  : Device.       
+0000e8c0: 2041 2044 6576 6963 6520 636f 6e74 6169   A Device contai
+0000e8d0: 6e69 6e67 2074 6865 206c 6974 686f 6772  ning the lithogr
+0000e8e0: 6170 6869 6320 6c69 6e65 7769 6474 6820  aphic linewidth 
+0000e8f0: 7265 736f 6c75 7469 6f6e 2074 6573 740a  resolution test.
+0000e900: 2020 2020 2020 2020 6765 6f6d 6574 7279          geometry
+0000e910: 2e0a 2020 2020 2222 220a 2020 2020 4420  ..    """.    D 
+0000e920: 3d20 4465 7669 6365 2822 6c69 7468 6f5f  = Device("litho_
+0000e930: 7374 6570 7322 290a 0a20 2020 2068 6569  steps")..    hei
+0000e940: 6768 7420 3d20 6865 6967 6874 202f 2032  ght = height / 2
+0000e950: 0a20 2020 2054 3120 3d20 7465 7874 280a  .    T1 = text(.
+0000e960: 2020 2020 2020 2020 7465 7874 3d22 2573          text="%s
+0000e970: 2220 2520 7374 7228 6c69 6e65 5f77 6964  " % str(line_wid
+0000e980: 7468 735b 2d31 5d29 2c20 7369 7a65 3d68  ths[-1]), size=h
+0000e990: 6569 6768 742c 206a 7573 7469 6679 3d22  eight, justify="
+0000e9a0: 6365 6e74 6572 222c 206c 6179 6572 3d6c  center", layer=l
+0000e9b0: 6179 6572 0a20 2020 2029 0a20 2020 205f  ayer.    ).    _
+0000e9c0: 203d 2044 2e61 6464 5f72 6566 2854 3129   = D.add_ref(T1)
+0000e9d0: 2e72 6f74 6174 6528 3930 292e 6d6f 7665  .rotate(90).move
+0000e9e0: 7828 2d68 6569 6768 7420 2f20 3130 290a  x(-height / 10).
+0000e9f0: 2020 2020 5231 203d 2072 6563 7461 6e67      R1 = rectang
+0000ea00: 6c65 2873 697a 653d 286c 696e 655f 7370  le(size=(line_sp
+0000ea10: 6163 696e 672c 2068 6569 6768 7429 2c20  acing, height), 
+0000ea20: 6c61 7965 723d 6c61 7965 7229 0a20 2020  layer=layer).   
+0000ea30: 2044 2e61 6464 5f72 6566 2852 3129 2e6d   D.add_ref(R1).m
+0000ea40: 6f76 6579 282d 6865 6967 6874 290a 2020  ovey(-height).  
+0000ea50: 2020 636f 756e 7420 3d20 300a 2020 2020    count = 0.    
+0000ea60: 666f 7220 6920 696e 2072 6576 6572 7365  for i in reverse
+0000ea70: 6428 6c69 6e65 5f77 6964 7468 7329 3a0a  d(line_widths):.
+0000ea80: 2020 2020 2020 2020 636f 756e 7420 2b3d          count +=
+0000ea90: 206c 696e 655f 7370 6163 696e 6720 2b20   line_spacing + 
+0000eaa0: 690a 2020 2020 2020 2020 5232 203d 2072  i.        R2 = r
+0000eab0: 6563 7461 6e67 6c65 2873 697a 653d 2869  ectangle(size=(i
+0000eac0: 2c20 6865 6967 6874 292c 206c 6179 6572  , height), layer
+0000ead0: 3d6c 6179 6572 290a 2020 2020 2020 2020  =layer).        
+0000eae0: 442e 6164 645f 7265 6628 5231 292e 6d6f  D.add_ref(R1).mo
+0000eaf0: 7665 7828 636f 756e 7429 2e6d 6f76 6579  vex(count).movey
+0000eb00: 282d 6865 6967 6874 290a 2020 2020 2020  (-height).      
+0000eb10: 2020 442e 6164 645f 7265 6628 5232 292e    D.add_ref(R2).
+0000eb20: 6d6f 7665 7828 636f 756e 7420 2d20 6929  movex(count - i)
+0000eb30: 0a0a 2020 2020 7265 7475 726e 2044 0a0a  ..    return D..
+0000eb40: 0a64 6566 206c 6974 686f 5f73 7461 7228  .def litho_star(
+0000eb50: 6e75 6d5f 6c69 6e65 733d 3230 2c20 6c69  num_lines=20, li
+0000eb60: 6e65 5f77 6964 7468 3d32 2c20 6469 616d  ne_width=2, diam
+0000eb70: 6574 6572 3d32 3030 2c20 6c61 7965 723d  eter=200, layer=
+0000eb80: 3029 3a0a 2020 2020 2222 2243 7265 6174  0):.    """Creat
+0000eb90: 6573 2061 2063 6972 6375 6c61 722d 7374  es a circular-st
+0000eba0: 6172 2073 6861 7065 2066 726f 6d20 6c69  ar shape from li
+0000ebb0: 6e65 732c 2075 7365 6420 6173 2061 206c  nes, used as a l
+0000ebc0: 6974 686f 6772 6170 6869 630a 2020 2020  ithographic.    
+0000ebd0: 7265 736f 6c75 7469 6f6e 2074 6573 7420  resolution test 
+0000ebe0: 7061 7474 6572 6e2e 0a0a 2020 2020 5061  pattern...    Pa
+0000ebf0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+0000ec00: 2d2d 2d2d 2d2d 2d0a 2020 2020 6e75 6d5f  -------.    num_
+0000ec10: 6c69 6e65 7320 3a20 696e 740a 2020 2020  lines : int.    
+0000ec20: 2020 2020 4e75 6d62 6572 206f 6620 6c69      Number of li
+0000ec30: 6e65 7320 696e 2074 6865 2063 6972 6375  nes in the circu
+0000ec40: 6c61 722d 7374 6172 2073 6861 7065 2e0a  lar-star shape..
+0000ec50: 2020 2020 6c69 6e65 5f77 6964 7468 203a      line_width :
+0000ec60: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
+0000ec70: 2020 2020 2020 5468 6963 6b6e 6573 7320        Thickness 
+0000ec80: 6f66 2073 7461 7220 7370 696b 6520 6c69  of star spike li
+0000ec90: 6e65 732e 0a20 2020 2064 6961 6d65 7465  nes..    diamete
+0000eca0: 7220 3a20 696e 7420 6f72 2066 6c6f 6174  r : int or float
+0000ecb0: 0a20 2020 2020 2020 2044 6961 6d65 7465  .        Diamete
+0000ecc0: 7220 6f66 2074 6865 2063 6972 6375 6c61  r of the circula
+0000ecd0: 722d 7374 6172 2073 6861 7065 2028 746f  r-star shape (to
+0000ece0: 7461 6c20 6c65 6e67 7468 206f 6620 6561  tal length of ea
+0000ecf0: 6368 2073 7461 7220 7370 696b 6529 2e0a  ch star spike)..
+0000ed00: 2020 2020 6c61 7965 7220 3a20 696e 742c      layer : int,
+0000ed10: 2061 7272 6179 2d6c 696b 655b 325d 2c20   array-like[2], 
+0000ed20: 6f72 2073 6574 0a20 2020 2020 2020 2053  or set.        S
+0000ed30: 7065 6369 6669 6320 6c61 7965 7228 7329  pecific layer(s)
+0000ed40: 2074 6f20 7075 7420 706f 6c79 676f 6e20   to put polygon 
+0000ed50: 6765 6f6d 6574 7279 206f 6e2e 0a0a 2020  geometry on...  
+0000ed60: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+0000ed70: 2d2d 2d2d 2d0a 2020 2020 4420 3a20 4465  -----.    D : De
+0000ed80: 7669 6365 0a20 2020 2020 2020 2041 2044  vice.        A D
+0000ed90: 6576 6963 6520 636f 6e74 6169 6e69 6e67  evice containing
+0000eda0: 2061 206c 696e 652d 6261 7365 6420 6369   a line-based ci
+0000edb0: 7263 756c 6172 2d73 7461 7220 7368 6170  rcular-star shap
+0000edc0: 652e 0a20 2020 2022 2222 0a20 2020 2044  e..    """.    D
+0000edd0: 203d 2044 6576 6963 6528 226c 6974 686f   = Device("litho
+0000ede0: 5f73 7461 7222 290a 0a20 2020 2064 6567  _star")..    deg
+0000edf0: 7265 6520 3d20 3138 3020 2f20 6e75 6d5f  ree = 180 / num_
+0000ee00: 6c69 6e65 730a 2020 2020 5231 203d 2072  lines.    R1 = r
+0000ee10: 6563 7461 6e67 6c65 2873 697a 653d 286c  ectangle(size=(l
+0000ee20: 696e 655f 7769 6474 682c 2064 6961 6d65  ine_width, diame
+0000ee30: 7465 7229 2c20 6c61 7965 723d 6c61 7965  ter), layer=laye
+0000ee40: 7229 0a20 2020 2066 6f72 2069 2069 6e20  r).    for i in 
+0000ee50: 7261 6e67 6528 6e75 6d5f 6c69 6e65 7329  range(num_lines)
+0000ee60: 3a0a 2020 2020 2020 2020 7231 203d 2044  :.        r1 = D
+0000ee70: 2e61 6464 5f72 6566 2852 3129 2e72 6f74  .add_ref(R1).rot
+0000ee80: 6174 6528 6465 6772 6565 202a 2069 290a  ate(degree * i).
+0000ee90: 2020 2020 2020 2020 7231 2e63 656e 7465          r1.cente
+0000eea0: 7220 3d20 2830 2c20 3029 0a0a 2020 2020  r = (0, 0)..    
+0000eeb0: 7265 7475 726e 2044 0a0a 0a64 6566 206c  return D...def l
+0000eec0: 6974 686f 5f63 616c 6970 6572 7328 0a20  itho_calipers(. 
+0000eed0: 2020 206e 6f74 6368 5f73 697a 653d 5b32     notch_size=[2
+0000eee0: 2c20 355d 2c0a 2020 2020 6e6f 7463 685f  , 5],.    notch_
+0000eef0: 7370 6163 696e 673d 322c 0a20 2020 206e  spacing=2,.    n
+0000ef00: 756d 5f6e 6f74 6368 6573 3d31 312c 0a20  um_notches=11,. 
+0000ef10: 2020 206f 6666 7365 745f 7065 725f 6e6f     offset_per_no
+0000ef20: 7463 683d 302e 312c 0a20 2020 2072 6f77  tch=0.1,.    row
+0000ef30: 5f73 7061 6369 6e67 3d30 2c0a 2020 2020  _spacing=0,.    
+0000ef40: 6c61 7965 7231 3d31 2c0a 2020 2020 6c61  layer1=1,.    la
+0000ef50: 7965 7232 3d32 2c0a 293a 0a20 2020 2022  yer2=2,.):.    "
+0000ef60: 2222 4372 6561 7465 7320 6120 7665 726e  ""Creates a vern
+0000ef70: 6965 7220 6361 6c69 7065 7220 7374 7275  ier caliper stru
+0000ef80: 6374 7572 6520 666f 7220 6c69 7468 6f67  cture for lithog
+0000ef90: 7261 7068 7920 616c 6967 6e6d 656e 740a  raphy alignment.
+0000efa0: 2020 2020 7465 7374 732e 2056 6572 6e69      tests. Verni
+0000efb0: 6572 2073 7472 7563 7475 7265 2069 7320  er structure is 
+0000efc0: 6d61 6465 2068 6f72 697a 6f6e 7461 6c6c  made horizontall
+0000efd0: 792e 0a0a 2020 2020 5061 7261 6d65 7465  y...    Paramete
+0000efe0: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+0000eff0: 2d0a 2020 2020 6e6f 7463 685f 7369 7a65  -.    notch_size
+0000f000: 203a 2061 7272 6179 2d6c 696b 655b 325d   : array-like[2]
+0000f010: 206f 6620 696e 7420 6f72 2066 6c61 6f74   of int or flaot
+0000f020: 0a20 2020 2020 2020 2078 2c20 7920 7369  .        x, y si
+0000f030: 7a65 206f 6620 7468 6520 6e6f 7463 6865  ze of the notche
+0000f040: 732e 0a20 2020 206e 6f74 6368 5f73 7061  s..    notch_spa
+0000f050: 6369 6e67 203a 2069 6e74 206f 7220 666c  cing : int or fl
+0000f060: 6f61 740a 2020 2020 2020 2020 5370 6163  oat.        Spac
+0000f070: 696e 6720 6265 7477 6565 6e20 6e6f 7463  ing between notc
+0000f080: 6865 7320 6f6e 2074 6865 2063 6f6e 7472  hes on the contr
+0000f090: 6f6c 2073 7472 7563 7475 7265 2e0a 2020  ol structure..  
+0000f0a0: 2020 6e75 6d5f 6e6f 7463 6865 7320 3a20    num_notches : 
+0000f0b0: 696e 740a 2020 2020 2020 2020 4e75 6d62  int.        Numb
+0000f0c0: 6572 206f 6620 6e6f 7463 6865 7320 6f6e  er of notches on
+0000f0d0: 206f 6e65 2073 6964 6520 6f66 2074 6865   one side of the
+0000f0e0: 2073 7472 7563 7475 7265 2028 746f 7461   structure (tota
+0000f0f0: 6c20 6e75 6d62 6572 206f 660a 2020 2020  l number of.    
+0000f100: 2020 2020 6e6f 7463 6865 7320 6973 2032      notches is 2
+0000f110: 2a6e 756d 5f6e 6f74 6368 6573 202b 2031  *num_notches + 1
+0000f120: 292e 0a20 2020 206f 6666 7365 745f 7065  )..    offset_pe
+0000f130: 725f 6e6f 7463 6820 3a20 696e 7420 6f72  r_notch : int or
+0000f140: 2066 6c6f 6174 0a20 2020 2020 2020 2054   float.        T
+0000f150: 6865 2061 6d6f 756e 7420 6f66 2068 6f72  he amount of hor
+0000f160: 697a 6f6e 7461 6c20 6f66 6673 6574 2074  izontal offset t
+0000f170: 6f20 6170 706c 7920 746f 2074 6865 206e  o apply to the n
+0000f180: 6f74 6368 2073 7061 6369 6e67 2070 6572  otch spacing per
+0000f190: 0a20 2020 2020 2020 206e 6f74 6368 206f  .        notch o
+0000f1a0: 6e20 7468 6520 6e6f 6e2d 636f 6e74 726f  n the non-contro
+0000f1b0: 6c20 7374 7275 6374 7572 652e 0a20 2020  l structure..   
+0000f1c0: 2072 6f77 5f73 7061 6369 6e67 203a 2069   row_spacing : i
+0000f1d0: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
+0000f1e0: 2020 2020 5468 6520 616d 6f75 6e74 206f      The amount o
+0000f1f0: 6620 7665 7274 6963 616c 2073 7061 6365  f vertical space
+0000f200: 2062 6574 7765 656e 2074 6865 2063 6f6e   between the con
+0000f210: 7472 6f6c 2061 6e64 206e 6f6e 2d63 6f6e  trol and non-con
+0000f220: 7472 6f6c 0a20 2020 2020 2020 2073 7472  trol.        str
+0000f230: 7563 7475 7265 732e 0a20 2020 206c 6179  uctures..    lay
+0000f240: 6572 3120 3a20 696e 742c 2061 7272 6179  er1 : int, array
+0000f250: 2d6c 696b 655b 325d 2c20 6f72 2073 6574  -like[2], or set
+0000f260: 0a20 2020 2020 2020 2053 7065 6369 6669  .        Specifi
+0000f270: 6320 6c61 7965 7228 7329 2074 6f20 7075  c layer(s) to pu
+0000f280: 7420 7468 6520 636f 6e74 726f 6c20 6765  t the control ge
+0000f290: 6f6d 6574 7279 206f 6e2e 0a20 2020 206c  ometry on..    l
+0000f2a0: 6179 6572 3220 3a20 696e 742c 2061 7272  ayer2 : int, arr
+0000f2b0: 6179 2d6c 696b 655b 325d 2c20 6f72 2073  ay-like[2], or s
+0000f2c0: 6574 0a20 2020 2020 2020 2053 7065 6369  et.        Speci
+0000f2d0: 6669 6320 6c61 7965 7228 7329 2074 6f20  fic layer(s) to 
+0000f2e0: 7075 7420 7468 6520 6e6f 6e2d 636f 6e74  put the non-cont
+0000f2f0: 726f 6c20 6765 6f6d 6574 7279 206f 6e2e  rol geometry on.
+0000f300: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+0000f310: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 4465    -------.    De
+0000f320: 7669 6365 0a20 2020 2020 2020 2041 2044  vice.        A D
+0000f330: 6576 6963 6520 636f 6e74 6169 6e69 6e67  evice containing
+0000f340: 2074 6865 2063 616c 6970 6572 2073 7472   the caliper str
+0000f350: 7563 7475 7265 732e 0a20 2020 2022 2222  uctures..    """
+0000f360: 0a20 2020 2044 203d 2044 6576 6963 6528  .    D = Device(
+0000f370: 226c 6974 686f 5f63 616c 6970 6572 7322  "litho_calipers"
+0000f380: 290a 2020 2020 6e75 6d5f 6e6f 7463 6865  ).    num_notche
+0000f390: 735f 746f 7461 6c20 3d20 6e75 6d5f 6e6f  s_total = num_no
+0000f3a0: 7463 6865 7320 2a20 3220 2b20 310a 2020  tches * 2 + 1.  
+0000f3b0: 2020 6365 6e74 7265 5f6e 6f74 6368 203d    centre_notch =
+0000f3c0: 206e 756d 5f6e 6f74 6368 6573 0a20 2020   num_notches.   
+0000f3d0: 2052 3120 3d20 7265 6374 616e 676c 6528   R1 = rectangle(
+0000f3e0: 7369 7a65 3d28 6e6f 7463 685f 7369 7a65  size=(notch_size
+0000f3f0: 292c 206c 6179 6572 3d6c 6179 6572 3129  ), layer=layer1)
+0000f400: 0a20 2020 2052 3220 3d20 7265 6374 616e  .    R2 = rectan
+0000f410: 676c 6528 7369 7a65 3d28 6e6f 7463 685f  gle(size=(notch_
+0000f420: 7369 7a65 292c 206c 6179 6572 3d6c 6179  size), layer=lay
+0000f430: 6572 3229 0a20 2020 2066 6f72 2069 2069  er2).    for i i
+0000f440: 6e20 7261 6e67 6528 6e75 6d5f 6e6f 7463  n range(num_notc
+0000f450: 6865 735f 746f 7461 6c29 3a0a 2020 2020  hes_total):.    
+0000f460: 2020 2020 6966 2069 203d 3d20 6365 6e74      if i == cent
+0000f470: 7265 5f6e 6f74 6368 3a0a 2020 2020 2020  re_notch:.      
+0000f480: 2020 2020 2020 280a 2020 2020 2020 2020        (.        
+0000f490: 2020 2020 2020 2020 442e 6164 645f 7265          D.add_re
+0000f4a0: 6628 5231 290a 2020 2020 2020 2020 2020  f(R1).          
+0000f4b0: 2020 2020 2020 2e6d 6f76 6578 2869 202a        .movex(i *
+0000f4c0: 2028 6e6f 7463 685f 7369 7a65 5b30 5d20   (notch_size[0] 
+0000f4d0: 2b20 6e6f 7463 685f 7370 6163 696e 6729  + notch_spacing)
+0000f4e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000f4f0: 2020 2e6d 6f76 6579 286e 6f74 6368 5f73    .movey(notch_s
+0000f500: 697a 655b 315d 290a 2020 2020 2020 2020  ize[1]).        
+0000f510: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0000f520: 2020 280a 2020 2020 2020 2020 2020 2020    (.            
+0000f530: 2020 2020 442e 6164 645f 7265 6628 5232      D.add_ref(R2
+0000f540: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000f550: 2020 2e6d 6f76 6578 280a 2020 2020 2020    .movex(.      
+0000f560: 2020 2020 2020 2020 2020 2020 2020 6920                i 
+0000f570: 2a20 286e 6f74 6368 5f73 697a 655b 305d  * (notch_size[0]
+0000f580: 202b 206e 6f74 6368 5f73 7061 6369 6e67   + notch_spacing
+0000f590: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000f5a0: 2020 2020 2020 2b20 6f66 6673 6574 5f70        + offset_p
+0000f5b0: 6572 5f6e 6f74 6368 202a 2028 6365 6e74  er_notch * (cent
+0000f5c0: 7265 5f6e 6f74 6368 202d 2069 290a 2020  re_notch - i).  
+0000f5d0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0000f5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f5f0: 2e6d 6f76 6579 282d 3220 2a20 6e6f 7463  .movey(-2 * notc
+0000f600: 685f 7369 7a65 5b31 5d20 2d20 726f 775f  h_size[1] - row_
+0000f610: 7370 6163 696e 6729 0a20 2020 2020 2020  spacing).       
+0000f620: 2020 2020 2029 0a20 2020 2020 2020 2044       ).        D
+0000f630: 2e61 6464 5f72 6566 2852 3129 2e6d 6f76  .add_ref(R1).mov
+0000f640: 6578 2869 202a 2028 6e6f 7463 685f 7369  ex(i * (notch_si
+0000f650: 7a65 5b30 5d20 2b20 6e6f 7463 685f 7370  ze[0] + notch_sp
+0000f660: 6163 696e 6729 290a 2020 2020 2020 2020  acing)).        
+0000f670: 280a 2020 2020 2020 2020 2020 2020 442e  (.            D.
+0000f680: 6164 645f 7265 6628 5232 290a 2020 2020  add_ref(R2).    
+0000f690: 2020 2020 2020 2020 2e6d 6f76 6578 280a          .movex(.
+0000f6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f6b0: 6920 2a20 286e 6f74 6368 5f73 697a 655b  i * (notch_size[
+0000f6c0: 305d 202b 206e 6f74 6368 5f73 7061 6369  0] + notch_spaci
+0000f6d0: 6e67 290a 2020 2020 2020 2020 2020 2020  ng).            
+0000f6e0: 2020 2020 2b20 6f66 6673 6574 5f70 6572      + offset_per
+0000f6f0: 5f6e 6f74 6368 202a 2028 6365 6e74 7265  _notch * (centre
+0000f700: 5f6e 6f74 6368 202d 2069 290a 2020 2020  _notch - i).    
+0000f710: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000f720: 2020 2020 2020 2e6d 6f76 6579 282d 6e6f        .movey(-no
+0000f730: 7463 685f 7369 7a65 5b31 5d20 2d20 726f  tch_size[1] - ro
+0000f740: 775f 7370 6163 696e 6729 0a20 2020 2020  w_spacing).     
+0000f750: 2020 2029 0a0a 2020 2020 7265 7475 726e     )..    return
+0000f760: 2044 0a0a 0a64 6566 206c 6974 686f 5f72   D...def litho_r
+0000f770: 756c 6572 280a 2020 2020 6865 6967 6874  uler(.    height
+0000f780: 3d32 2c0a 2020 2020 7769 6474 683d 302e  =2,.    width=0.
+0000f790: 352c 0a20 2020 2073 7061 6369 6e67 3d31  5,.    spacing=1
+0000f7a0: 2e32 2c0a 2020 2020 7363 616c 653d 5b33  .2,.    scale=[3
+0000f7b0: 2c20 312c 2031 2c20 312c 2031 2c20 322c  , 1, 1, 1, 1, 2,
+0000f7c0: 2031 2c20 312c 2031 2c20 315d 2c0a 2020   1, 1, 1, 1],.  
+0000f7d0: 2020 6e75 6d5f 6d61 726b 733d 3231 2c0a    num_marks=21,.
+0000f7e0: 2020 2020 6c61 7965 723d 302c 0a29 3a0a      layer=0,.):.
+0000f7f0: 2020 2020 2222 2243 7265 6174 6573 2061      """Creates a
+0000f800: 2072 756c 6572 2073 7472 7563 7475 7265   ruler structure
+0000f810: 2066 6f72 206c 6974 686f 6772 6170 6869   for lithographi
+0000f820: 6320 6d65 6173 7572 656d 656e 7420 7769  c measurement wi
+0000f830: 7468 206d 6172 6b73 206f 660a 2020 2020  th marks of.    
+0000f840: 7661 7279 696e 6720 7363 616c 6573 2074  varying scales t
+0000f850: 6f20 616c 6c6f 7720 666f 7220 6561 7379  o allow for easy
+0000f860: 2072 6561 6469 6e67 2062 7920 6579 652e   reading by eye.
+0000f870: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+0000f880: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+0000f890: 2020 2020 6865 6967 6874 203a 2066 6c6f      height : flo
+0000f8a0: 6174 0a20 2020 2020 2020 2048 6569 6768  at.        Heigh
+0000f8b0: 7420 6f66 2074 6865 2072 756c 696e 6720  t of the ruling 
+0000f8c0: 6d61 726b 732e 0a20 2020 2077 6964 7468  marks..    width
+0000f8d0: 203a 2066 6c6f 6174 0a20 2020 2020 2020   : float.       
+0000f8e0: 2057 6964 7468 206f 6620 7468 6520 7275   Width of the ru
+0000f8f0: 6c69 6e67 206d 6172 6b73 2e0a 2020 2020  ling marks..    
+0000f900: 7370 6163 696e 6720 3a20 666c 6f61 740a  spacing : float.
+0000f910: 2020 2020 2020 2020 4365 6e74 6572 2d74          Center-t
+0000f920: 6f2d 6365 6e74 6572 2073 7061 6369 6e67  o-center spacing
+0000f930: 206f 6620 7468 6520 7275 6c69 6e67 206d   of the ruling m
+0000f940: 6172 6b73 0a20 2020 2073 6361 6c65 203a  arks.    scale :
+0000f950: 2061 7272 6179 2d6c 696b 650a 2020 2020   array-like.    
+0000f960: 2020 2020 4865 6967 6874 2073 6361 6c65      Height scale
+0000f970: 2070 6174 7465 726e 206f 6620 6d61 726b   pattern of mark
+0000f980: 730a 2020 2020 6e75 6d5f 6d61 726b 7320  s.    num_marks 
+0000f990: 3a20 696e 740a 2020 2020 2020 2020 546f  : int.        To
+0000f9a0: 7461 6c20 6e75 6d62 6572 206f 6620 6d61  tal number of ma
+0000f9b0: 726b 7320 746f 2067 656e 6572 6174 650a  rks to generate.
+0000f9c0: 2020 2020 6e75 6d5f 6d61 726b 7320 3a20      num_marks : 
+0000f9d0: 696e 740a 2020 2020 2020 2020 546f 7461  int.        Tota
+0000f9e0: 6c20 6e75 6d62 6572 206f 6620 6d61 726b  l number of mark
+0000f9f0: 7320 746f 2067 656e 6572 6174 650a 2020  s to generate.  
+0000fa00: 2020 6c61 7965 7220 3a20 696e 742c 2061    layer : int, a
+0000fa10: 7272 6179 2d6c 696b 655b 325d 2c20 6f72  rray-like[2], or
+0000fa20: 2073 6574 0a20 2020 2020 2020 2053 7065   set.        Spe
+0000fa30: 6369 6669 6320 6c61 7965 7228 7329 2074  cific layer(s) t
+0000fa40: 6f20 7075 7420 7468 6520 7275 6c65 7220  o put the ruler 
+0000fa50: 6765 6f6d 6574 7279 206f 6e2e 0a0a 2020  geometry on...  
+0000fa60: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+0000fa70: 2d2d 2d2d 2d0a 2020 2020 4465 7669 6365  -----.    Device
+0000fa80: 0a20 2020 2020 2020 2041 2044 6576 6963  .        A Devic
+0000fa90: 6520 636f 6e74 6169 6e69 6e67 2074 6865  e containing the
+0000faa0: 2072 756c 6572 2073 7472 7563 7475 7265   ruler structure
+0000fab0: 0a20 2020 2022 2222 0a0a 2020 2020 4420  .    """..    D 
+0000fac0: 3d20 4465 7669 6365 2822 6c69 7468 6f5f  = Device("litho_
+0000fad0: 7275 6c65 7222 290a 2020 2020 666f 7220  ruler").    for 
+0000fae0: 6e20 696e 2072 616e 6765 286e 756d 5f6d  n in range(num_m
+0000faf0: 6172 6b73 293a 0a20 2020 2020 2020 2068  arks):.        h
+0000fb00: 203d 2068 6569 6768 7420 2a20 7363 616c   = height * scal
+0000fb10: 655b 6e20 2520 6c65 6e28 7363 616c 6529  e[n % len(scale)
+0000fb20: 5d0a 2020 2020 2020 2020 4420 3c3c 2072  ].        D << r
+0000fb30: 6563 7461 6e67 6c65 2873 697a 653d 2877  ectangle(size=(w
+0000fb40: 6964 7468 2c20 6829 2c20 6c61 7965 723d  idth, h), layer=
+0000fb50: 6c61 7965 7229 0a0a 2020 2020 442e 6469  layer)..    D.di
+0000fb60: 7374 7269 6275 7465 2864 6972 6563 7469  stribute(directi
+0000fb70: 6f6e 3d22 7822 2c20 7370 6163 696e 673d  on="x", spacing=
+0000fb80: 7370 6163 696e 672c 2073 6570 6172 6174  spacing, separat
+0000fb90: 696f 6e3d 4661 6c73 652c 2065 6467 653d  ion=False, edge=
+0000fba0: 2278 2229 0a20 2020 2044 2e61 6c69 676e  "x").    D.align
+0000fbb0: 2861 6c69 676e 6d65 6e74 3d22 796d 696e  (alignment="ymin
+0000fbc0: 2229 0a20 2020 2044 2e66 6c61 7474 656e  ").    D.flatten
+0000fbd0: 2829 0a20 2020 2072 6574 7572 6e20 440a  ().    return D.
+0000fbe0: 0a0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ..# ============
+0000fbf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000fc00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000fc10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000fc20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000fc30: 3d3d 0a23 0a23 2055 7469 6c69 7479 2066  ==.#.# Utility f
+0000fc40: 756e 6374 696f 6e73 0a23 0a23 203d 3d3d  unctions.#.# ===
+0000fc50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000fc60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000fc70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000fc80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000fc90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a0a 6465  ===========...de
+0000fca0: 6620 6578 7472 6163 7428 442c 206c 6179  f extract(D, lay
+0000fcb0: 6572 733d 5b30 2c20 315d 293a 0a20 2020  ers=[0, 1]):.   
+0000fcc0: 2022 2222 4578 7472 6163 7473 2070 6f6c   """Extracts pol
+0000fcd0: 7967 6f6e 7320 6672 6f6d 2061 2067 6976  ygons from a giv
+0000fce0: 656e 2044 6576 6963 652e 0a0a 2020 2020  en Device...    
+0000fcf0: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+0000fd00: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 4420  ---------.    D 
+0000fd10: 3a20 4465 7669 6365 0a20 2020 2020 2020  : Device.       
+0000fd20: 2044 6576 6963 6520 746f 2065 7874 7261   Device to extra
+0000fd30: 6374 2070 6f6c 7967 6f6e 7320 6672 6f6d  ct polygons from
+0000fd40: 2e0a 2020 2020 6c61 7965 7273 203a 2061  ..    layers : a
+0000fd50: 7272 6179 2d6c 696b 655b 325d 206f 7220  rray-like[2] or 
+0000fd60: 7365 740a 2020 2020 2020 2020 5370 6563  set.        Spec
+0000fd70: 6966 6963 206c 6179 6572 2873 2920 746f  ific layer(s) to
+0000fd80: 2065 7874 7261 6374 2070 6f6c 7967 6f6e   extract polygon
+0000fd90: 2067 656f 6d65 7472 7920 6672 6f6d 2e0a   geometry from..
+0000fda0: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
+0000fdb0: 202d 2d2d 2d2d 2d2d 0a20 2020 2044 6576   -------.    Dev
+0000fdc0: 6963 650a 2020 2020 2020 2020 4120 4465  ice.        A De
+0000fdd0: 7669 6365 2063 6f6e 7461 696e 696e 6720  vice containing 
+0000fde0: 7468 6520 6578 7472 6163 7465 6420 706f  the extracted po
+0000fdf0: 6c79 676f 6e73 2e0a 2020 2020 2222 220a  lygons..    """.
+0000fe00: 2020 2020 445f 6578 7472 6163 7465 6420      D_extracted 
+0000fe10: 3d20 4465 7669 6365 2822 6578 7472 6163  = Device("extrac
+0000fe20: 7422 290a 2020 2020 6966 206e 6f74 2069  t").    if not i
+0000fe30: 7369 6e73 7461 6e63 6528 6c61 7965 7273  sinstance(layers
+0000fe40: 2c20 286c 6973 742c 2074 7570 6c65 2929  , (list, tuple))
+0000fe50: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+0000fe60: 5661 6c75 6545 7272 6f72 280a 2020 2020  ValueError(.    
+0000fe70: 2020 2020 2020 2020 225b 5048 4944 4c5d          "[PHIDL]
+0000fe80: 2070 672e 6578 7472 6163 7428 2920 4172   pg.extract() Ar
+0000fe90: 6775 6d65 6e74 2060 6c61 7965 7273 6020  gument `layers` 
+0000fea0: 6e65 6564 7320 746f 2062 6520 220a 2020  needs to be ".  
+0000feb0: 2020 2020 2020 2020 2020 2270 6173 7365            "passe
+0000fec0: 6420 6120 6c69 7374 206f 7220 7475 706c  d a list or tupl
+0000fed0: 6522 0a20 2020 2020 2020 2029 0a20 2020  e".        ).   
+0000fee0: 2070 6f6c 795f 6469 6374 203d 2044 2e67   poly_dict = D.g
+0000fef0: 6574 5f70 6f6c 7967 6f6e 7328 6279 5f73  et_polygons(by_s
+0000ff00: 7065 633d 5472 7565 290a 2020 2020 7061  pec=True).    pa
+0000ff10: 7273 6564 5f6c 6179 6572 5f6c 6973 7420  rsed_layer_list 
+0000ff20: 3d20 5b5f 7061 7273 655f 6c61 7965 7228  = [_parse_layer(
+0000ff30: 6c61 7965 7229 2066 6f72 206c 6179 6572  layer) for layer
+0000ff40: 2069 6e20 6c61 7965 7273 5d0a 2020 2020   in layers].    
+0000ff50: 666f 7220 6c61 7965 722c 2070 6f6c 7973  for layer, polys
+0000ff60: 2069 6e20 706f 6c79 5f64 6963 742e 6974   in poly_dict.it
+0000ff70: 656d 7328 293a 0a20 2020 2020 2020 2069  ems():.        i
+0000ff80: 6620 5f70 6172 7365 5f6c 6179 6572 286c  f _parse_layer(l
+0000ff90: 6179 6572 2920 696e 2070 6172 7365 645f  ayer) in parsed_
+0000ffa0: 6c61 7965 725f 6c69 7374 3a0a 2020 2020  layer_list:.    
+0000ffb0: 2020 2020 2020 2020 445f 6578 7472 6163          D_extrac
+0000ffc0: 7465 642e 6164 645f 706f 6c79 676f 6e28  ted.add_polygon(
+0000ffd0: 706f 6c79 732c 206c 6179 6572 3d6c 6179  polys, layer=lay
+0000ffe0: 6572 290a 2020 2020 7265 7475 726e 2044  er).    return D
+0000fff0: 5f65 7874 7261 6374 6564 0a0a 0a64 6566  _extracted...def
+00010000: 2063 6f70 7928 4429 3a0a 2020 2020 2222   copy(D):.    ""
+00010010: 2243 6f70 6965 7320 6120 4465 7669 6365  "Copies a Device
+00010020: 2e0a 0a20 2020 2050 6172 616d 6574 6572  ...    Parameter
+00010030: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+00010040: 0a20 2020 2044 203a 2044 6576 6963 650a  .    D : Device.
+00010050: 2020 2020 2020 2020 4465 7669 6365 2074          Device t
+00010060: 6f20 6265 2063 6f70 6965 642e 0a0a 2020  o be copied...  
+00010070: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+00010080: 2d2d 2d2d 2d0a 2020 2020 4465 7669 6365  -----.    Device
+00010090: 0a20 2020 2020 2020 2043 6f70 6965 6420  .        Copied 
+000100a0: 4465 7669 6365 2e0a 2020 2020 2222 220a  Device..    """.
+000100b0: 2020 2020 445f 636f 7079 203d 2044 6576      D_copy = Dev
+000100c0: 6963 6528 6e61 6d65 3d44 2e6e 616d 6529  ice(name=D.name)
+000100d0: 0a20 2020 2044 5f63 6f70 792e 696e 666f  .    D_copy.info
+000100e0: 203d 2070 7974 686f 6e5f 636f 7079 2e64   = python_copy.d
+000100f0: 6565 7063 6f70 7928 442e 696e 666f 290a  eepcopy(D.info).
+00010100: 2020 2020 666f 7220 7265 6620 696e 2044      for ref in D
+00010110: 2e72 6566 6572 656e 6365 733a 0a20 2020  .references:.   
+00010120: 2020 2020 206e 6577 5f72 6566 203d 2044       new_ref = D
+00010130: 6576 6963 6552 6566 6572 656e 6365 280a  eviceReference(.
+00010140: 2020 2020 2020 2020 2020 2020 6465 7669              devi
+00010150: 6365 3d72 6566 2e70 6172 656e 742c 0a20  ce=ref.parent,. 
+00010160: 2020 2020 2020 2020 2020 206f 7269 6769             origi
+00010170: 6e3d 7265 662e 6f72 6967 696e 2c0a 2020  n=ref.origin,.  
+00010180: 2020 2020 2020 2020 2020 726f 7461 7469            rotati
+00010190: 6f6e 3d72 6566 2e72 6f74 6174 696f 6e2c  on=ref.rotation,
+000101a0: 0a20 2020 2020 2020 2020 2020 206d 6167  .            mag
+000101b0: 6e69 6669 6361 7469 6f6e 3d72 6566 2e6d  nification=ref.m
+000101c0: 6167 6e69 6669 6361 7469 6f6e 2c0a 2020  agnification,.  
+000101d0: 2020 2020 2020 2020 2020 785f 7265 666c            x_refl
+000101e0: 6563 7469 6f6e 3d72 6566 2e78 5f72 6566  ection=ref.x_ref
+000101f0: 6c65 6374 696f 6e2c 0a20 2020 2020 2020  lection,.       
+00010200: 2029 0a20 2020 2020 2020 206e 6577 5f72   ).        new_r
+00010210: 6566 2e6f 776e 6572 203d 2044 5f63 6f70  ef.owner = D_cop
+00010220: 790a 2020 2020 2020 2020 445f 636f 7079  y.        D_copy
+00010230: 2e61 6464 286e 6577 5f72 6566 290a 2020  .add(new_ref).  
+00010240: 2020 2020 2020 666f 7220 616c 6961 735f        for alias_
+00010250: 6e61 6d65 2c20 616c 6961 735f 7265 6620  name, alias_ref 
+00010260: 696e 2044 2e61 6c69 6173 6573 2e69 7465  in D.aliases.ite
+00010270: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+00010280: 2020 6966 2061 6c69 6173 5f72 6566 203d    if alias_ref =
+00010290: 3d20 7265 663a 0a20 2020 2020 2020 2020  = ref:.         
+000102a0: 2020 2020 2020 2044 5f63 6f70 792e 616c         D_copy.al
+000102b0: 6961 7365 735b 616c 6961 735f 6e61 6d65  iases[alias_name
+000102c0: 5d20 3d20 6e65 775f 7265 660a 0a20 2020  ] = new_ref..   
+000102d0: 2066 6f72 2070 6f72 7420 696e 2044 2e70   for port in D.p
+000102e0: 6f72 7473 2e76 616c 7565 7328 293a 0a20  orts.values():. 
+000102f0: 2020 2020 2020 2044 5f63 6f70 792e 6164         D_copy.ad
+00010300: 645f 706f 7274 2870 6f72 743d 706f 7274  d_port(port=port
+00010310: 290a 2020 2020 666f 7220 706f 6c79 2069  ).    for poly i
+00010320: 6e20 442e 706f 6c79 676f 6e73 3a0a 2020  n D.polygons:.  
+00010330: 2020 2020 2020 445f 636f 7079 2e61 6464        D_copy.add
+00010340: 5f70 6f6c 7967 6f6e 2870 6f6c 7929 0a20  _polygon(poly). 
+00010350: 2020 2066 6f72 206c 6162 656c 2069 6e20     for label in 
+00010360: 442e 6c61 6265 6c73 3a0a 2020 2020 2020  D.labels:.      
+00010370: 2020 445f 636f 7079 2e61 6464 5f6c 6162    D_copy.add_lab
+00010380: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
+00010390: 7465 7874 3d6c 6162 656c 2e74 6578 742c  text=label.text,
+000103a0: 0a20 2020 2020 2020 2020 2020 2070 6f73  .            pos
+000103b0: 6974 696f 6e3d 6c61 6265 6c2e 706f 7369  ition=label.posi
+000103c0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+000103d0: 2020 6c61 7965 723d 286c 6162 656c 2e6c    layer=(label.l
+000103e0: 6179 6572 2c20 6c61 6265 6c2e 7465 7874  ayer, label.text
+000103f0: 7479 7065 292c 0a20 2020 2020 2020 2029  type),.        )
+00010400: 0a20 2020 2072 6574 7572 6e20 445f 636f  .    return D_co
+00010410: 7079 0a0a 0a64 6566 2064 6565 7063 6f70  py...def deepcop
+00010420: 7928 4429 3a0a 2020 2020 2222 2244 6565  y(D):.    """Dee
+00010430: 7020 636f 7069 6573 2061 2044 6576 6963  p copies a Devic
+00010440: 652e 0a0a 2020 2020 5061 7261 6d65 7465  e...    Paramete
+00010450: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+00010460: 2d0a 2020 2020 4420 3a20 4465 7669 6365  -.    D : Device
+00010470: 0a20 2020 2020 2020 2044 6576 6963 6520  .        Device 
+00010480: 746f 2062 6520 6465 6570 2063 6f70 6965  to be deep copie
+00010490: 642e 0a0a 2020 2020 5265 7475 726e 730a  d...    Returns.
+000104a0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+000104b0: 4465 7669 6365 0a20 2020 2020 2020 2044  Device.        D
+000104c0: 6565 7020 636f 7069 6564 2044 6576 6963  eep copied Devic
+000104d0: 652e 0a20 2020 2022 2222 0a20 2020 2044  e..    """.    D
+000104e0: 5f63 6f70 7920 3d20 7079 7468 6f6e 5f63  _copy = python_c
+000104f0: 6f70 792e 6465 6570 636f 7079 2844 290a  opy.deepcopy(D).
+00010500: 2020 2020 445f 636f 7079 2e75 6964 203d      D_copy.uid =
+00010510: 2044 6576 6963 652e 5f6e 6578 745f 7569   Device._next_ui
+00010520: 640a 2020 2020 4465 7669 6365 2e5f 6e65  d.    Device._ne
+00010530: 7874 5f75 6964 202b 3d20 310a 2020 2020  xt_uid += 1.    
+00010540: 445f 636f 7079 2e6e 616d 6520 3d20 442e  D_copy.name = D.
+00010550: 6e61 6d65 0a20 2020 2023 204d 616b 6520  name.    # Make 
+00010560: 7375 7265 205f 6262 5f76 616c 6964 2069  sure _bb_valid i
+00010570: 7320 7365 7420 746f 2066 616c 7365 2066  s set to false f
+00010580: 6f72 2074 6865 7365 206e 6577 206f 626a  or these new obj
+00010590: 6563 7473 2073 6f20 6e65 770a 2020 2020  ects so new.    
+000105a0: 2320 626f 756e 6469 6e67 2062 6f78 6573  # bounding boxes
+000105b0: 2061 7265 2063 7265 6174 6564 2069 6e20   are created in 
+000105c0: 7468 6520 6361 6368 650a 2020 2020 666f  the cache.    fo
+000105d0: 7220 4420 696e 2044 5f63 6f70 792e 6765  r D in D_copy.ge
+000105e0: 745f 6465 7065 6e64 656e 6369 6573 2854  t_dependencies(T
+000105f0: 7275 6529 3a0a 2020 2020 2020 2020 442e  rue):.        D.
+00010600: 5f62 625f 7661 6c69 6420 3d20 4661 6c73  _bb_valid = Fals
+00010610: 650a 2020 2020 445f 636f 7079 2e5f 6262  e.    D_copy._bb
+00010620: 5f76 616c 6964 203d 2046 616c 7365 0a0a  _valid = False..
+00010630: 2020 2020 7265 7475 726e 2044 5f63 6f70      return D_cop
+00010640: 790a 0a0a 6465 6620 636f 7079 5f6c 6179  y...def copy_lay
+00010650: 6572 2844 2c20 6c61 7965 723d 312c 206e  er(D, layer=1, n
+00010660: 6577 5f6c 6179 6572 3d32 293a 0a20 2020  ew_layer=2):.   
+00010670: 2022 2222 436f 7069 6573 2061 206c 6179   """Copies a lay
+00010680: 6572 2077 6974 6869 6e20 6120 4465 7669  er within a Devi
+00010690: 6365 2074 6f20 616e 6f74 6865 7220 6c61  ce to another la
+000106a0: 7965 7220 696e 2074 6865 2073 616d 6520  yer in the same 
+000106b0: 4465 7669 6365 2e0a 0a20 2020 2050 6172  Device...    Par
+000106c0: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+000106d0: 2d2d 2d2d 2d2d 0a20 2020 2044 203a 2044  ------.    D : D
+000106e0: 6576 6963 650a 2020 2020 2020 2020 4465  evice.        De
+000106f0: 7669 6365 2063 6f6e 7461 696e 696e 6720  vice containing 
+00010700: 6c61 7965 7220 746f 2062 6520 636f 7069  layer to be copi
+00010710: 6564 2e0a 2020 2020 6c61 7965 7220 3a20  ed..    layer : 
+00010720: 696e 742c 2061 7272 6179 2d6c 696b 655b  int, array-like[
+00010730: 325d 2c20 6f72 2073 6574 0a20 2020 2020  2], or set.     
+00010740: 2020 2053 7065 6369 6669 6320 6c61 7965     Specific laye
+00010750: 7228 7329 2074 6f20 636f 7079 2e0a 2020  r(s) to copy..  
+00010760: 2020 6e65 775f 6c61 7965 7220 3a20 696e    new_layer : in
+00010770: 742c 2061 7272 6179 2d6c 696b 655b 325d  t, array-like[2]
+00010780: 2c20 6f72 2073 6574 0a20 2020 2020 2020  , or set.       
+00010790: 2053 7065 6369 6669 6320 6c61 7965 7228   Specific layer(
+000107a0: 7329 2074 6f20 7075 7420 636f 7069 6564  s) to put copied
+000107b0: 206c 6179 6572 206f 6e2e 0a0a 2020 2020   layer on...    
+000107c0: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+000107d0: 2d2d 2d0a 2020 2020 4465 7669 6365 0a20  ---.    Device. 
+000107e0: 2020 2020 2020 2041 2044 6576 6963 6520         A Device 
+000107f0: 636f 6e74 6169 6e69 6e67 2074 6865 206f  containing the o
+00010800: 7269 6769 6e61 6c20 616e 6420 636f 7069  riginal and copi
+00010810: 6564 206c 6179 6572 732e 0a20 2020 2022  ed layers..    "
+00010820: 2222 0a20 2020 2044 5f63 6f70 6965 645f  "".    D_copied_
+00010830: 6c61 7965 7220 3d20 6578 7472 6163 7428  layer = extract(
+00010840: 442c 206c 6179 6572 733d 5b6c 6179 6572  D, layers=[layer
+00010850: 5d29 0a20 2020 2044 5f63 6f70 6965 645f  ]).    D_copied_
+00010860: 6c61 7965 722e 666c 6174 7465 6e28 7369  layer.flatten(si
+00010870: 6e67 6c65 5f6c 6179 6572 3d6e 6577 5f6c  ngle_layer=new_l
+00010880: 6179 6572 290a 2020 2020 7265 7475 726e  ayer).    return
+00010890: 2044 5f63 6f70 6965 645f 6c61 7965 720a   D_copied_layer.
+000108a0: 0a0a 6465 6620 666c 6174 7465 6e28 442c  ..def flatten(D,
+000108b0: 2073 696e 676c 655f 6c61 7965 723d 4e6f   single_layer=No
+000108c0: 6e65 293a 0a20 2020 2022 2222 466c 6174  ne):.    """Flat
+000108d0: 7465 6e73 2074 6865 2068 6569 7261 7263  tens the heirarc
+000108e0: 6879 206f 6620 7468 6520 4465 7669 6365  hy of the Device
+000108f0: 2073 7563 6820 7468 6174 2074 6865 7265   such that there
+00010900: 2061 7265 206e 6f20 6c6f 6e67 6572 0a20   are no longer. 
+00010910: 2020 2061 6e79 2072 6566 6572 656e 6365     any reference
+00010920: 7320 746f 206f 7468 6572 2044 6576 6963  s to other Devic
+00010930: 6573 2e20 2041 6c6c 2070 6f6c 7967 6f6e  es.  All polygon
+00010940: 7320 616e 6420 6c61 6265 6c73 2066 726f  s and labels fro
+00010950: 6d0a 2020 2020 756e 6465 726c 7969 6e67  m.    underlying
+00010960: 2072 6566 6572 656e 6365 7320 6172 6520   references are 
+00010970: 636f 7069 6564 2061 6e64 2070 6c61 6365  copied and place
+00010980: 6420 696e 2074 6865 2074 6f70 2d6c 6576  d in the top-lev
+00010990: 656c 2044 6576 6963 652e 0a20 2020 2049  el Device..    I
+000109a0: 6620 7369 6e67 6c65 5f6c 6179 6572 2069  f single_layer i
+000109b0: 7320 7370 6563 6966 6965 642c 2061 6c6c  s specified, all
+000109c0: 2070 6f6c 7967 6f6e 7320 6172 6520 6d6f   polygons are mo
+000109d0: 7665 6420 746f 2074 6861 7420 6c61 7965  ved to that laye
+000109e0: 722e 0a20 2020 2049 6465 6e74 6963 616c  r..    Identical
+000109f0: 2074 6f20 4465 7669 6365 2e66 6c61 7474   to Device.flatt
+00010a00: 656e 2829 2062 7574 2063 7265 6174 6573  en() but creates
+00010a10: 206e 6577 2067 656f 6d65 7472 7920 696e   new geometry in
+00010a20: 7374 6561 6420 6f66 0a20 2020 206d 6f64  stead of.    mod
+00010a30: 6966 7969 6e67 2069 6e2d 706c 6163 652e  ifying in-place.
+00010a40: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00010a50: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+00010a60: 2020 2020 7369 6e67 6c65 5f6c 6179 6572      single_layer
+00010a70: 203a 204e 6f6e 652c 2069 6e74 2c20 7475   : None, int, tu
+00010a80: 706c 6520 6f66 2069 6e74 2c20 6f72 2073  ple of int, or s
+00010a90: 6574 206f 6620 696e 740a 2020 2020 2020  et of int.      
+00010aa0: 2020 4966 206e 6f74 204e 6f6e 652c 2061    If not None, a
+00010ab0: 6c6c 2070 6f6c 7967 6f6e 7320 6172 6520  ll polygons are 
+00010ac0: 6d6f 7665 6420 746f 2074 6865 2073 7065  moved to the spe
+00010ad0: 6369 6669 6564 0a20 2020 2022 2222 0a20  cified.    """. 
+00010ae0: 2020 2072 6574 7572 6e20 636f 7079 2844     return copy(D
+00010af0: 292e 666c 6174 7465 6e28 290a 0a0a 6465  ).flatten()...de
+00010b00: 6620 696d 706f 7274 5f67 6473 2866 696c  f import_gds(fil
+00010b10: 656e 616d 652c 2063 656c 6c6e 616d 653d  ename, cellname=
+00010b20: 4e6f 6e65 2c20 666c 6174 7465 6e3d 4661  None, flatten=Fa
+00010b30: 6c73 6529 3a0a 2020 2020 2222 2249 6d70  lse):.    """Imp
+00010b40: 6f72 7473 2061 2047 4453 2066 696c 6520  orts a GDS file 
+00010b50: 616e 6420 7265 7475 726e 7320 6120 4465  and returns a De
+00010b60: 7669 6365 2077 6974 6820 616c 6c20 7468  vice with all th
+00010b70: 6520 636f 7272 6573 706f 6e64 696e 670a  e corresponding.
+00010b80: 2020 2020 6765 6f6d 6574 7279 0a0a 2020      geometry..  
+00010b90: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00010ba0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00010bb0: 6669 6c65 6e61 6d65 203a 2073 7472 0a20  filename : str. 
+00010bc0: 2020 2020 2020 2050 6174 6820 6f72 206e         Path or n
+00010bd0: 616d 6520 6f66 2066 696c 6520 746f 2062  ame of file to b
+00010be0: 6520 696d 706f 7274 6564 0a20 2020 2063  e imported.    c
+00010bf0: 656c 6c6e 616d 6520 3a20 7374 7220 6f72  ellname : str or
+00010c00: 204e 6f6e 650a 2020 2020 2020 2020 4e61   None.        Na
+00010c10: 6d65 206f 6620 7468 6520 6365 6c6c 2074  me of the cell t
+00010c20: 6861 7420 7769 6c6c 2062 6520 7265 7475  hat will be retu
+00010c30: 726e 6564 2061 7320 6120 4465 7669 6365  rned as a Device
+00010c40: 2e20 2049 6620 4e6f 6e65 2c0a 2020 2020  .  If None,.    
+00010c50: 2020 2020 7769 6c6c 2061 7574 6f6d 6174      will automat
+00010c60: 6963 616c 6c79 2073 656c 6563 7420 7468  ically select th
+00010c70: 6520 746f 706d 6f73 7420 6365 6c6c 0a20  e topmost cell. 
+00010c80: 2020 2066 6c61 7474 656e 203a 2062 6f6f     flatten : boo
+00010c90: 6c0a 2020 2020 2020 2020 5768 6574 6865  l.        Whethe
+00010ca0: 7220 746f 2066 6c61 7474 656e 2074 6865  r to flatten the
+00010cb0: 2069 6d70 6f72 7465 6420 6765 6f6d 6574   imported geomet
+00010cc0: 7279 2c20 7265 6d6f 7669 6e67 2061 6c6c  ry, removing all
+00010cd0: 2063 656c 6c20 6865 6972 6172 6368 790a   cell heirarchy.
+00010ce0: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
+00010cf0: 202d 2d2d 2d2d 2d2d 0a20 2020 2044 6576   -------.    Dev
+00010d00: 6963 650a 2020 2020 2020 2020 4120 5048  ice.        A PH
+00010d10: 4944 4c20 4465 7669 6365 2077 6974 6820  IDL Device with 
+00010d20: 616c 6c20 7468 6520 6765 6f6d 6574 7279  all the geometry
+00010d30: 2f6c 6162 656c 732f 6574 6320 696d 706f  /labels/etc impo
+00010d40: 7274 6564 2066 726f 6d20 7468 6520 4744  rted from the GD
+00010d50: 5320 6669 6c65 0a0a 2020 2020 2222 220a  S file..    """.
+00010d60: 2020 2020 6764 7369 695f 6c69 6220 3d20      gdsii_lib = 
+00010d70: 6764 7370 792e 4764 734c 6962 7261 7279  gdspy.GdsLibrary
+00010d80: 2829 0a20 2020 2067 6473 6969 5f6c 6962  ().    gdsii_lib
+00010d90: 2e72 6561 645f 6764 7328 6669 6c65 6e61  .read_gds(filena
+00010da0: 6d65 290a 2020 2020 746f 705f 6c65 7665  me).    top_leve
+00010db0: 6c5f 6365 6c6c 7320 3d20 6764 7369 695f  l_cells = gdsii_
+00010dc0: 6c69 622e 746f 705f 6c65 7665 6c28 290a  lib.top_level().
+00010dd0: 2020 2020 6966 2063 656c 6c6e 616d 6520      if cellname 
+00010de0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00010df0: 2020 2020 2069 6620 6365 6c6c 6e61 6d65       if cellname
+00010e00: 206e 6f74 2069 6e20 6764 7369 695f 6c69   not in gdsii_li
+00010e10: 622e 6365 6c6c 733a 0a20 2020 2020 2020  b.cells:.       
+00010e20: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00010e30: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00010e40: 2020 2020 2020 2022 5b50 4849 444c 5d20         "[PHIDL] 
+00010e50: 696d 706f 7274 5f67 6473 2829 2054 6865  import_gds() The
+00010e60: 2072 6571 7565 7374 6564 2063 656c 6c20   requested cell 
+00010e70: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00010e80: 2020 2228 6e61 6d65 6420 2573 2920 6973    "(named %s) is
+00010e90: 206e 6f74 2070 7265 7365 6e74 2069 6e20   not present in 
+00010ea0: 6669 6c65 2025 7322 2025 2028 6365 6c6c  file %s" % (cell
+00010eb0: 6e61 6d65 2c20 6669 6c65 6e61 6d65 290a  name, filename).
+00010ec0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00010ed0: 2020 2020 2020 746f 7063 656c 6c20 3d20        topcell = 
+00010ee0: 6764 7369 695f 6c69 622e 6365 6c6c 735b  gdsii_lib.cells[
+00010ef0: 6365 6c6c 6e61 6d65 5d0a 2020 2020 656c  cellname].    el
+00010f00: 6966 2063 656c 6c6e 616d 6520 6973 204e  if cellname is N
+00010f10: 6f6e 6520 616e 6420 6c65 6e28 746f 705f  one and len(top_
+00010f20: 6c65 7665 6c5f 6365 6c6c 7329 203d 3d20  level_cells) == 
+00010f30: 313a 0a20 2020 2020 2020 2074 6f70 6365  1:.        topce
+00010f40: 6c6c 203d 2074 6f70 5f6c 6576 656c 5f63  ll = top_level_c
+00010f50: 656c 6c73 5b30 5d0a 2020 2020 656c 6966  ells[0].    elif
+00010f60: 2063 656c 6c6e 616d 6520 6973 204e 6f6e   cellname is Non
+00010f70: 6520 616e 6420 6c65 6e28 746f 705f 6c65  e and len(top_le
+00010f80: 7665 6c5f 6365 6c6c 7329 203e 2031 3a0a  vel_cells) > 1:.
+00010f90: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00010fa0: 6c75 6545 7272 6f72 280a 2020 2020 2020  lueError(.      
+00010fb0: 2020 2020 2020 225b 5048 4944 4c5d 2069        "[PHIDL] i
+00010fc0: 6d70 6f72 745f 6764 7328 2920 5468 6572  mport_gds() Ther
+00010fd0: 6520 6172 6520 6d75 6c74 6970 6c65 2074  e are multiple t
+00010fe0: 6f70 2d6c 6576 656c 2022 0a20 2020 2020  op-level ".     
+00010ff0: 2020 2020 2020 2022 6365 6c6c 732c 2079         "cells, y
+00011000: 6f75 206d 7573 7420 7370 6563 6966 7920  ou must specify 
+00011010: 6063 656c 6c6e 616d 6560 2074 6f20 7365  `cellname` to se
+00011020: 6c65 6374 206f 6620 220a 2020 2020 2020  lect of ".      
+00011030: 2020 2020 2020 226f 6e65 206f 6620 7468        "one of th
+00011040: 656d 220a 2020 2020 2020 2020 290a 0a20  em".        ).. 
+00011050: 2020 2069 6620 6e6f 7420 666c 6174 7465     if not flatte
+00011060: 6e3a 0a20 2020 2020 2020 2044 5f6c 6973  n:.        D_lis
+00011070: 7420 3d20 5b5d 0a20 2020 2020 2020 2063  t = [].        c
+00011080: 3264 6d61 7020 3d20 7b7d 0a20 2020 2020  2dmap = {}.     
+00011090: 2020 2066 6f72 2063 656c 6c20 696e 2067     for cell in g
+000110a0: 6473 6969 5f6c 6962 2e63 656c 6c73 2e76  dsii_lib.cells.v
+000110b0: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
+000110c0: 2020 2020 2044 203d 2044 6576 6963 6528       D = Device(
+000110d0: 6e61 6d65 3d63 656c 6c2e 6e61 6d65 290a  name=cell.name).
+000110e0: 2020 2020 2020 2020 2020 2020 442e 706f              D.po
+000110f0: 6c79 676f 6e73 203d 2063 656c 6c2e 706f  lygons = cell.po
+00011100: 6c79 676f 6e73 0a20 2020 2020 2020 2020  lygons.         
+00011110: 2020 2044 2e72 6566 6572 656e 6365 7320     D.references 
+00011120: 3d20 6365 6c6c 2e72 6566 6572 656e 6365  = cell.reference
+00011130: 730a 2020 2020 2020 2020 2020 2020 442e  s.            D.
+00011140: 6e61 6d65 203d 2063 656c 6c2e 6e61 6d65  name = cell.name
+00011150: 0a20 2020 2020 2020 2020 2020 2044 2e70  .            D.p
+00011160: 6174 6873 203d 2063 656c 6c2e 7061 7468  aths = cell.path
+00011170: 730a 2020 2020 2020 2020 2020 2020 666f  s.            fo
+00011180: 7220 6c61 6265 6c20 696e 2063 656c 6c2e  r label in cell.
+00011190: 6c61 6265 6c73 3a0a 2020 2020 2020 2020  labels:.        
+000111a0: 2020 2020 2020 2020 726f 7461 7469 6f6e          rotation
+000111b0: 203d 206c 6162 656c 2e72 6f74 6174 696f   = label.rotatio
+000111c0: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+000111d0: 2020 6966 2072 6f74 6174 696f 6e20 6973    if rotation is
+000111e0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000111f0: 2020 2020 2020 2020 2020 2072 6f74 6174             rotat
+00011200: 696f 6e20 3d20 300a 2020 2020 2020 2020  ion = 0.        
+00011210: 2020 2020 2020 2020 6c20 3d20 442e 6164          l = D.ad
+00011220: 645f 6c61 6265 6c28 0a20 2020 2020 2020  d_label(.       
+00011230: 2020 2020 2020 2020 2020 2020 2074 6578               tex
+00011240: 743d 6c61 6265 6c2e 7465 7874 2c0a 2020  t=label.text,.  
+00011250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011260: 2020 706f 7369 7469 6f6e 3d6e 702e 6173    position=np.as
+00011270: 6661 7272 6179 286c 6162 656c 2e70 6f73  farray(label.pos
+00011280: 6974 696f 6e29 2c0a 2020 2020 2020 2020  ition),.        
+00011290: 2020 2020 2020 2020 2020 2020 6d61 676e              magn
+000112a0: 6966 6963 6174 696f 6e3d 6c61 6265 6c2e  ification=label.
+000112b0: 6d61 676e 6966 6963 6174 696f 6e2c 0a20  magnification,. 
+000112c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000112d0: 2020 2072 6f74 6174 696f 6e3d 726f 7461     rotation=rota
+000112e0: 7469 6f6e 202a 2031 3830 202f 206e 702e  tion * 180 / np.
+000112f0: 7069 2c0a 2020 2020 2020 2020 2020 2020  pi,.            
+00011300: 2020 2020 2020 2020 6c61 7965 723d 286c          layer=(l
+00011310: 6162 656c 2e6c 6179 6572 2c20 6c61 6265  abel.layer, labe
+00011320: 6c2e 7465 7874 7479 7065 292c 0a20 2020  l.texttype),.   
+00011330: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00011340: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00011350: 2e61 6e63 686f 7220 3d20 6c61 6265 6c2e  .anchor = label.
+00011360: 616e 6368 6f72 0a20 2020 2020 2020 2020  anchor.         
+00011370: 2020 2063 3264 6d61 705b 6365 6c6c 5d20     c2dmap[cell] 
+00011380: 3d20 440a 2020 2020 2020 2020 2020 2020  = D.            
+00011390: 445f 6c69 7374 2e61 7070 656e 6428 4429  D_list.append(D)
+000113a0: 0a0a 2020 2020 2020 2020 666f 7220 4420  ..        for D 
+000113b0: 696e 2044 5f6c 6973 743a 0a20 2020 2020  in D_list:.     
+000113c0: 2020 2020 2020 2023 2046 6972 7374 2063         # First c
+000113d0: 6f6e 7665 7274 2065 6163 6820 7265 6665  onvert each refe
+000113e0: 7265 6e63 6520 736f 2069 7420 706f 696e  rence so it poin
+000113f0: 7473 2074 6f20 7468 6520 7269 6768 7420  ts to the right 
+00011400: 4465 7669 6365 0a20 2020 2020 2020 2020  Device.         
+00011410: 2020 2063 6f6e 7665 7274 6564 5f72 6566     converted_ref
+00011420: 6572 656e 6365 7320 3d20 5b5d 0a20 2020  erences = [].   
+00011430: 2020 2020 2020 2020 2066 6f72 2065 2069           for e i
+00011440: 6e20 442e 7265 6665 7265 6e63 6573 3a0a  n D.references:.
+00011450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011460: 7265 665f 6465 7669 6365 203d 2063 3264  ref_device = c2d
+00011470: 6d61 705b 652e 7265 665f 6365 6c6c 5d0a  map[e.ref_cell].
+00011480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011490: 6966 2069 7369 6e73 7461 6e63 6528 652c  if isinstance(e,
+000114a0: 2067 6473 7079 2e43 656c 6c52 6566 6572   gdspy.CellRefer
+000114b0: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
+000114c0: 2020 2020 2020 2020 2020 2064 7220 3d20             dr = 
+000114d0: 4465 7669 6365 5265 6665 7265 6e63 6528  DeviceReference(
+000114e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000114f0: 2020 2020 2020 2020 2064 6576 6963 653d           device=
+00011500: 7265 665f 6465 7669 6365 2c0a 2020 2020  ref_device,.    
+00011510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011520: 2020 2020 6f72 6967 696e 3d65 2e6f 7269      origin=e.ori
+00011530: 6769 6e2c 0a20 2020 2020 2020 2020 2020  gin,.           
+00011540: 2020 2020 2020 2020 2020 2020 2072 6f74               rot
+00011550: 6174 696f 6e3d 652e 726f 7461 7469 6f6e  ation=e.rotation
+00011560: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00011570: 2020 2020 2020 2020 2020 6d61 676e 6966            magnif
+00011580: 6963 6174 696f 6e3d 652e 6d61 676e 6966  ication=e.magnif
+00011590: 6963 6174 696f 6e2c 0a20 2020 2020 2020  ication,.       
+000115a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000115b0: 2078 5f72 6566 6c65 6374 696f 6e3d 652e   x_reflection=e.
+000115c0: 785f 7265 666c 6563 7469 6f6e 2c0a 2020  x_reflection,.  
+000115d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000115e0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000115f0: 2020 2020 2020 2020 6472 2e70 726f 7065          dr.prope
+00011600: 7274 6965 7320 3d20 5f63 6f72 7265 6374  rties = _correct
+00011610: 5f70 726f 7065 7274 6965 7328 652e 7072  _properties(e.pr
+00011620: 6f70 6572 7469 6573 290a 2020 2020 2020  operties).      
+00011630: 2020 2020 2020 2020 2020 2020 2020 6472                dr
+00011640: 2e6f 776e 6572 203d 2044 0a20 2020 2020  .owner = D.     
+00011650: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00011660: 6f6e 7665 7274 6564 5f72 6566 6572 656e  onverted_referen
+00011670: 6365 732e 6170 7065 6e64 2864 7229 0a20  ces.append(dr). 
+00011680: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00011690: 6c69 6620 6973 696e 7374 616e 6365 2865  lif isinstance(e
+000116a0: 2c20 6764 7370 792e 4365 6c6c 4172 7261  , gdspy.CellArra
+000116b0: 7929 3a0a 2020 2020 2020 2020 2020 2020  y):.            
+000116c0: 2020 2020 2020 2020 6472 203d 2043 656c          dr = Cel
+000116d0: 6c41 7272 6179 280a 2020 2020 2020 2020  lArray(.        
+000116e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000116f0: 6465 7669 6365 3d72 6566 5f64 6576 6963  device=ref_devic
+00011700: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00011710: 2020 2020 2020 2020 2020 2063 6f6c 756d             colum
+00011720: 6e73 3d65 2e63 6f6c 756d 6e73 2c0a 2020  ns=e.columns,.  
+00011730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011740: 2020 2020 2020 726f 7773 3d65 2e72 6f77        rows=e.row
+00011750: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00011760: 2020 2020 2020 2020 2020 2073 7061 6369             spaci
+00011770: 6e67 3d65 2e73 7061 6369 6e67 2c0a 2020  ng=e.spacing,.  
+00011780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011790: 2020 2020 2020 6f72 6967 696e 3d65 2e6f        origin=e.o
+000117a0: 7269 6769 6e2c 0a20 2020 2020 2020 2020  rigin,.         
+000117b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000117c0: 6f74 6174 696f 6e3d 652e 726f 7461 7469  otation=e.rotati
+000117d0: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
+000117e0: 2020 2020 2020 2020 2020 2020 6d61 676e              magn
+000117f0: 6966 6963 6174 696f 6e3d 652e 6d61 676e  ification=e.magn
+00011800: 6966 6963 6174 696f 6e2c 0a20 2020 2020  ification,.     
+00011810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011820: 2020 2078 5f72 6566 6c65 6374 696f 6e3d     x_reflection=
+00011830: 652e 785f 7265 666c 6563 7469 6f6e 2c0a  e.x_reflection,.
+00011840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011850: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00011860: 2020 2020 2020 2020 2020 6472 2e6f 776e            dr.own
+00011870: 6572 203d 2044 0a20 2020 2020 2020 2020  er = D.         
+00011880: 2020 2020 2020 2020 2020 2063 6f6e 7665             conve
+00011890: 7274 6564 5f72 6566 6572 656e 6365 732e  rted_references.
+000118a0: 6170 7065 6e64 2864 7229 0a20 2020 2020  append(dr).     
+000118b0: 2020 2020 2020 2044 2e72 6566 6572 656e         D.referen
+000118c0: 6365 7320 3d20 636f 6e76 6572 7465 645f  ces = converted_
+000118d0: 7265 6665 7265 6e63 6573 0a20 2020 2020  references.     
+000118e0: 2020 2020 2020 2023 204e 6578 7420 636f         # Next co
+000118f0: 6e76 6572 7420 6561 6368 2050 6f6c 7967  nvert each Polyg
+00011900: 6f6e 0a20 2020 2020 2020 2020 2020 2074  on.            t
+00011910: 656d 705f 706f 6c79 676f 6e73 203d 206c  emp_polygons = l
+00011920: 6973 7428 442e 706f 6c79 676f 6e73 290a  ist(D.polygons).
+00011930: 2020 2020 2020 2020 2020 2020 442e 706f              D.po
+00011940: 6c79 676f 6e73 203d 205b 5d0a 2020 2020  lygons = [].    
+00011950: 2020 2020 2020 2020 666f 7220 7020 696e          for p in
+00011960: 2074 656d 705f 706f 6c79 676f 6e73 3a0a   temp_polygons:.
+00011970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011980: 5f63 6f72 7265 6374 5f70 726f 7065 7274  _correct_propert
+00011990: 6965 7328 702e 7072 6f70 6572 7469 6573  ies(p.properties
+000119a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000119b0: 2020 442e 6164 645f 706f 6c79 676f 6e28    D.add_polygon(
+000119c0: 7029 0a0a 2020 2020 2020 2020 746f 7064  p)..        topd
+000119d0: 6576 6963 6520 3d20 6332 646d 6170 5b74  evice = c2dmap[t
+000119e0: 6f70 6365 6c6c 5d0a 2020 2020 2020 2020  opcell].        
+000119f0: 7265 7475 726e 2074 6f70 6465 7669 6365  return topdevice
+00011a00: 0a0a 2020 2020 656c 6966 2066 6c61 7474  ..    elif flatt
+00011a10: 656e 3a0a 2020 2020 2020 2020 4420 3d20  en:.        D = 
+00011a20: 4465 7669 6365 2822 696d 706f 7274 5f67  Device("import_g
+00011a30: 6473 2229 0a20 2020 2020 2020 2070 6f6c  ds").        pol
+00011a40: 7967 6f6e 7320 3d20 746f 7063 656c 6c2e  ygons = topcell.
+00011a50: 6765 745f 706f 6c79 676f 6e73 2862 795f  get_polygons(by_
+00011a60: 7370 6563 3d54 7275 6529 0a0a 2020 2020  spec=True)..    
+00011a70: 2020 2020 666f 7220 6c61 7965 725f 696e      for layer_in
+00011a80: 5f67 6473 2c20 706f 6c79 7320 696e 2070  _gds, polys in p
+00011a90: 6f6c 7967 6f6e 732e 6974 656d 7328 293a  olygons.items():
+00011aa0: 0a20 2020 2020 2020 2020 2020 2044 2e61  .            D.a
+00011ab0: 6464 5f70 6f6c 7967 6f6e 2870 6f6c 7973  dd_polygon(polys
+00011ac0: 2c20 6c61 7965 723d 6c61 7965 725f 696e  , layer=layer_in
+00011ad0: 5f67 6473 290a 2020 2020 2020 2020 7265  _gds).        re
+00011ae0: 7475 726e 2044 0a0a 0a64 6566 205f 636f  turn D...def _co
+00011af0: 7272 6563 745f 7072 6f70 6572 7469 6573  rrect_properties
+00011b00: 2870 726f 7065 7274 6965 733a 2064 6963  (properties: dic
+00011b10: 745b 696e 742c 2073 7472 5d29 202d 3e20  t[int, str]) -> 
+00011b20: 6469 6374 5b69 6e74 2c20 7374 725d 3a0a  dict[int, str]:.
+00011b30: 2020 2020 2222 220a 2020 2020 436f 7272      """.    Corr
+00011b40: 6563 7473 2074 6865 2070 726f 7065 7274  ects the propert
+00011b50: 6965 7320 6469 6374 696f 6e61 7279 206f  ies dictionary o
+00011b60: 6620 6120 6c6f 6164 6564 2047 4453 2065  f a loaded GDS e
+00011b70: 6c65 6d65 6e74 2074 6f20 6861 6e64 6c65  lement to handle
+00011b80: 2074 6865 0a20 2020 2063 6f6e 7665 7273   the.    convers
+00011b90: 696f 6e20 6f66 206b 6579 7320 6672 6f6d  ion of keys from
+00011ba0: 2073 6967 6e65 6420 746f 2075 6e73 6967   signed to unsig
+00011bb0: 6e65 6420 696e 7465 6765 7273 2e0a 0a20  ned integers... 
+00011bc0: 2020 2054 6869 7320 6973 2061 2077 6f72     This is a wor
+00011bd0: 6b61 726f 756e 6420 666f 7220 6120 6275  karound for a bu
+00011be0: 6720 696e 2067 6473 7079 2028 6874 7470  g in gdspy (http
+00011bf0: 733a 2f2f 6769 7468 7562 2e63 6f6d 2f68  s://github.com/h
+00011c00: 6569 747a 6d61 6e6e 2f67 6473 7079 2f70  eitzmann/gdspy/p
+00011c10: 756c 6c2f 3234 3029 0a20 2020 2077 6865  ull/240).    whe
+00011c20: 7265 2070 726f 7065 7274 7920 6b65 7973  re property keys
+00011c30: 2061 7265 2069 6e63 6f72 7265 6374 6c79   are incorrectly
+00011c40: 2069 6e74 6572 7072 6574 6564 2061 7320   interpreted as 
+00011c50: 7369 676e 6564 2069 6e74 6567 6572 7320  signed integers 
+00011c60: 7768 656e 206c 6f61 6469 6e67 0a20 2020  when loading.   
+00011c70: 2047 4453 2066 696c 6573 2e0a 0a20 2020   GDS files...   
+00011c80: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+00011c90: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2070  ----------.    p
+00011ca0: 726f 7065 7274 6965 7320 3a20 6469 6374  roperties : dict
+00011cb0: 5b69 6e74 2c20 7374 725d 0a20 2020 2020  [int, str].     
+00011cc0: 2020 2054 6865 2070 726f 7065 7274 6965     The propertie
+00011cd0: 7320 6469 6374 696f 6e61 7279 206f 6620  s dictionary of 
+00011ce0: 6120 6c6f 6164 6564 2047 4453 2065 6c65  a loaded GDS ele
+00011cf0: 6d65 6e74 2e0a 0a20 2020 2052 6574 7572  ment...    Retur
+00011d00: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+00011d10: 2020 2064 6963 745b 696e 742c 2073 7472     dict[int, str
+00011d20: 5d0a 2020 2020 2020 2020 5468 6520 696e  ].        The in
+00011d30: 7075 7420 6469 6374 696f 6e61 7279 2069  put dictionary i
+00011d40: 7320 6d6f 6469 6669 6564 2069 6e20 706c  s modified in pl
+00011d50: 6163 6520 6275 7420 616c 736f 2072 6574  ace but also ret
+00011d60: 7572 6e65 6420 666f 7220 636f 6e76 656e  urned for conven
+00011d70: 6965 6e63 652e 0a20 2020 2022 2222 0a20  ience..    """. 
+00011d80: 2020 2074 6f5f 6465 6c20 3d20 5b5d 0a20     to_del = []. 
+00011d90: 2020 2074 6f5f 6164 6420 3d20 7b7d 0a20     to_add = {}. 
+00011da0: 2020 2066 6f72 206b 6579 2c20 7661 6c75     for key, valu
+00011db0: 6520 696e 2070 726f 7065 7274 6965 732e  e in properties.
+00011dc0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00011dd0: 2069 6620 6b65 7920 3c20 303a 0a20 2020   if key < 0:.   
+00011de0: 2020 2020 2020 2020 2074 6f5f 6164 645b           to_add[
+00011df0: 6b65 7920 2b20 322a 2a31 365d 203d 2076  key + 2**16] = v
+00011e00: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
+00011e10: 2074 6f5f 6465 6c2e 6170 7065 6e64 286b   to_del.append(k
+00011e20: 6579 290a 2020 2020 666f 7220 6b65 7920  ey).    for key 
+00011e30: 696e 2074 6f5f 6465 6c3a 0a20 2020 2020  in to_del:.     
+00011e40: 2020 2064 656c 2070 726f 7065 7274 6965     del propertie
+00011e50: 735b 6b65 795d 0a20 2020 2070 726f 7065  s[key].    prope
+00011e60: 7274 6965 732e 7570 6461 7465 2874 6f5f  rties.update(to_
+00011e70: 6164 6429 0a20 2020 2072 6574 7572 6e20  add).    return 
+00011e80: 7072 6f70 6572 7469 6573 0a0a 0a64 6566  properties...def
+00011e90: 205f 7472 616e 736c 6174 655f 6365 6c6c   _translate_cell
+00011ea0: 2863 293a 0a20 2020 2044 203d 2044 6576  (c):.    D = Dev
+00011eb0: 6963 6528 6e61 6d65 3d63 2e6e 616d 6529  ice(name=c.name)
+00011ec0: 0a20 2020 2066 6f72 2065 2069 6e20 632e  .    for e in c.
+00011ed0: 656c 656d 656e 7473 3a0a 2020 2020 2020  elements:.      
+00011ee0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00011ef0: 652c 2067 6473 7079 2e50 6f6c 7967 6f6e  e, gdspy.Polygon
+00011f00: 5365 7429 3a0a 2020 2020 2020 2020 2020  Set):.          
+00011f10: 2020 666f 7220 6e2c 2070 6f69 6e74 7320    for n, points 
+00011f20: 696e 2065 6e75 6d65 7261 7465 2865 2e70  in enumerate(e.p
+00011f30: 6f6c 7967 6f6e 7329 3a0a 2020 2020 2020  olygons):.      
+00011f40: 2020 2020 2020 2020 2020 706f 6c79 676f            polygo
+00011f50: 6e5f 6c61 7965 7220 3d20 5f70 6172 7365  n_layer = _parse
+00011f60: 5f6c 6179 6572 2828 652e 6c61 7965 7273  _layer((e.layers
+00011f70: 5b6e 5d2c 2065 2e64 6174 6174 7970 6573  [n], e.datatypes
+00011f80: 5b6e 5d29 290a 2020 2020 2020 2020 2020  [n])).          
+00011f90: 2020 2020 2020 442e 6164 645f 706f 6c79        D.add_poly
+00011fa0: 676f 6e28 706f 696e 7473 3d70 6f69 6e74  gon(points=point
+00011fb0: 732c 206c 6179 6572 3d70 6f6c 7967 6f6e  s, layer=polygon
+00011fc0: 5f6c 6179 6572 290a 2020 2020 2020 2020  _layer).        
+00011fd0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+00011fe0: 652c 2067 6473 7079 2e43 656c 6c52 6566  e, gdspy.CellRef
+00011ff0: 6572 656e 6365 293a 0a20 2020 2020 2020  erence):.       
+00012000: 2020 2020 2064 7220 3d20 4465 7669 6365       dr = Device
+00012010: 5265 6665 7265 6e63 6528 0a20 2020 2020  Reference(.     
+00012020: 2020 2020 2020 2020 2020 2064 6576 6963             devic
+00012030: 653d 5f74 7261 6e73 6c61 7465 5f63 656c  e=_translate_cel
+00012040: 6c28 652e 7265 665f 6365 6c6c 292c 0a20  l(e.ref_cell),. 
+00012050: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00012060: 7269 6769 6e3d 652e 6f72 6967 696e 2c0a  rigin=e.origin,.
+00012070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012080: 726f 7461 7469 6f6e 3d65 2e72 6f74 6174  rotation=e.rotat
+00012090: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
+000120a0: 2020 2020 206d 6167 6e69 6669 6361 7469       magnificati
+000120b0: 6f6e 3d4e 6f6e 652c 0a20 2020 2020 2020  on=None,.       
+000120c0: 2020 2020 2020 2020 2078 5f72 6566 6c65           x_refle
+000120d0: 6374 696f 6e3d 652e 785f 7265 666c 6563  ction=e.x_reflec
+000120e0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+000120f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00012100: 442e 656c 656d 656e 7473 2e61 7070 656e  D.elements.appen
+00012110: 6428 6472 290a 2020 2020 442e 6c61 6265  d(dr).    D.labe
+00012120: 6c73 203d 2063 2e6c 6162 656c 730a 2020  ls = c.labels.  
+00012130: 2020 7265 7475 726e 2044 0a0a 0a64 6566    return D...def
+00012140: 2070 7265 7669 6577 5f6c 6179 6572 7365   preview_layerse
+00012150: 7428 6c73 2c20 7369 7a65 3d31 3030 2c20  t(ls, size=100, 
+00012160: 7370 6163 696e 673d 3130 3029 3a0a 2020  spacing=100):.  
+00012170: 2020 2222 2247 656e 6572 6174 6573 2061    """Generates a
+00012180: 2070 7265 7669 6577 2044 6576 6963 6520   preview Device 
+00012190: 7769 7468 2072 6570 7265 7365 6e74 6174  with representat
+000121a0: 696f 6e73 206f 6620 616c 6c20 7468 6520  ions of all the 
+000121b0: 6c61 7965 7273 2c0a 2020 2020 7573 6564  layers,.    used
+000121c0: 2066 6f72 2070 7265 7669 6577 696e 6720   for previewing 
+000121d0: 4c61 7965 7253 6574 2063 6f6c 6f72 2073  LayerSet color s
+000121e0: 6368 656d 6573 2069 6e20 7175 6963 6b70  chemes in quickp
+000121f0: 6c6f 7420 6f72 2073 6176 6564 202e 6764  lot or saved .gd
+00012200: 730a 2020 2020 6669 6c65 732e 0a0a 2020  s.    files...  
+00012210: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00012220: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00012230: 6c73 203a 204c 6179 6572 5365 740a 2020  ls : LayerSet.  
+00012240: 2020 2020 2020 5365 7420 6f66 206c 6179        Set of lay
+00012250: 6572 7320 746f 2070 7265 7669 6577 2063  ers to preview c
+00012260: 6f6c 6f72 2073 6368 656d 6573 2e0a 2020  olor schemes..  
+00012270: 2020 7369 7a65 203a 2069 6e74 206f 7220    size : int or 
+00012280: 666c 6f61 740a 2020 2020 2020 2020 5265  float.        Re
+00012290: 7369 7a69 6e67 2066 6163 746f 7220 666f  sizing factor fo
+000122a0: 7220 7468 6520 7072 6576 6965 7720 4465  r the preview De
+000122b0: 7669 6365 2e0a 2020 2020 7370 6163 696e  vice..    spacin
+000122c0: 6720 3a20 696e 7420 6f72 2066 6c6f 6174  g : int or float
+000122d0: 0a20 2020 2020 2020 2054 6865 2073 7061  .        The spa
+000122e0: 6365 2062 6574 7765 656e 2065 6163 6820  ce between each 
+000122f0: 6c61 7965 7220 7265 7072 6573 656e 7461  layer representa
+00012300: 7469 6f6e 2e0a 0a20 2020 2052 6574 7572  tion...    Retur
+00012310: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+00012320: 2020 2044 203a 2044 6576 6963 650a 2020     D : Device.  
+00012330: 2020 2020 2020 4120 4465 7669 6365 2063        A Device c
+00012340: 6f6e 7461 696e 696e 6720 6120 7265 7072  ontaining a repr
+00012350: 6573 656e 7461 7469 6f6e 206f 6620 616c  esentation of al
+00012360: 6c20 7468 6520 6c61 7965 7273 2069 6e20  l the layers in 
+00012370: 7468 6520 696e 7075 740a 2020 2020 2020  the input.      
+00012380: 2020 4c61 7965 7253 6574 2e0a 2020 2020    LayerSet..    
+00012390: 2222 220a 0a20 2020 2044 203d 2044 6576  """..    D = Dev
+000123a0: 6963 6528 226c 6179 6572 7365 7422 290a  ice("layerset").
+000123b0: 2020 2020 7363 616c 6520 3d20 7369 7a65      scale = size
+000123c0: 202f 2031 3030 0a20 2020 206e 756d 5f6c   / 100.    num_l
+000123d0: 6179 6572 7320 3d20 6c65 6e28 6c73 2e5f  ayers = len(ls._
+000123e0: 6c61 7965 7273 290a 2020 2020 6d61 7472  layers).    matr
+000123f0: 6978 5f73 697a 6520 3d20 696e 7428 6e70  ix_size = int(np
+00012400: 2e63 6569 6c28 6e70 2e73 7172 7428 6e75  .ceil(np.sqrt(nu
+00012410: 6d5f 6c61 7965 7273 2929 290a 2020 2020  m_layers))).    
+00012420: 736f 7274 6564 5f6c 6179 6572 7320 3d20  sorted_layers = 
+00012430: 736f 7274 6564 280a 2020 2020 2020 2020  sorted(.        
+00012440: 6c73 2e5f 6c61 7965 7273 2e76 616c 7565  ls._layers.value
+00012450: 7328 292c 206b 6579 3d6c 616d 6264 6120  s(), key=lambda 
+00012460: 783a 2028 782e 6764 735f 6c61 7965 722c  x: (x.gds_layer,
+00012470: 2078 2e67 6473 5f64 6174 6174 7970 6529   x.gds_datatype)
+00012480: 0a20 2020 2029 0a20 2020 2066 6f72 206e  .    ).    for n
+00012490: 2c20 6c61 7965 7220 696e 2065 6e75 6d65  , layer in enume
+000124a0: 7261 7465 2873 6f72 7465 645f 6c61 7965  rate(sorted_laye
+000124b0: 7273 293a 0a20 2020 2020 2020 2052 203d  rs):.        R =
+000124c0: 2072 6563 7461 6e67 6c65 2873 697a 653d   rectangle(size=
+000124d0: 2831 3030 202a 2073 6361 6c65 2c20 3130  (100 * scale, 10
+000124e0: 3020 2a20 7363 616c 6529 2c20 6c61 7965  0 * scale), laye
+000124f0: 723d 6c61 7965 7229 0a20 2020 2020 2020  r=layer).       
+00012500: 2054 203d 2074 6578 7428 0a20 2020 2020   T = text(.     
+00012510: 2020 2020 2020 2074 6578 743d 6622 7b6c         text=f"{l
+00012520: 6179 6572 2e6e 616d 657d 5c6e 7b6c 6179  ayer.name}\n{lay
+00012530: 6572 2e67 6473 5f6c 6179 6572 7d20 2f20  er.gds_layer} / 
+00012540: 7b6c 6179 6572 2e67 6473 5f64 6174 6174  {layer.gds_datat
+00012550: 7970 657d 222c 0a20 2020 2020 2020 2020  ype}",.         
+00012560: 2020 2073 697a 653d 3230 202a 2073 6361     size=20 * sca
+00012570: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
+00012580: 6a75 7374 6966 793d 2263 656e 7465 7222  justify="center"
+00012590: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
+000125a0: 7965 723d 6c61 7965 722c 0a20 2020 2020  yer=layer,.     
+000125b0: 2020 2029 0a0a 2020 2020 2020 2020 542e     )..        T.
+000125c0: 6d6f 7665 2828 3530 202a 2073 6361 6c65  move((50 * scale
+000125d0: 2c20 2d32 3020 2a20 7363 616c 6529 290a  , -20 * scale)).
+000125e0: 2020 2020 2020 2020 786c 6f63 203d 206e          xloc = n
+000125f0: 2025 206d 6174 7269 785f 7369 7a65 0a20   % matrix_size. 
+00012600: 2020 2020 2020 2079 6c6f 6320 3d20 696e         yloc = in
+00012610: 7428 6e20 2f2f 206d 6174 7269 785f 7369  t(n // matrix_si
+00012620: 7a65 290a 2020 2020 2020 2020 442e 6164  ze).        D.ad
+00012630: 645f 7265 6628 5229 2e6d 6f76 6578 2828  d_ref(R).movex((
+00012640: 3130 3020 2b20 7370 6163 696e 6729 202a  100 + spacing) *
+00012650: 2078 6c6f 6320 2a20 7363 616c 6529 2e6d   xloc * scale).m
+00012660: 6f76 6579 280a 2020 2020 2020 2020 2020  ovey(.          
+00012670: 2020 2d28 3130 3020 2b20 7370 6163 696e    -(100 + spacin
+00012680: 6729 202a 2079 6c6f 6320 2a20 7363 616c  g) * yloc * scal
+00012690: 650a 2020 2020 2020 2020 290a 2020 2020  e.        ).    
+000126a0: 2020 2020 442e 6164 645f 7265 6628 5429      D.add_ref(T)
+000126b0: 2e6d 6f76 6578 2828 3130 3020 2b20 7370  .movex((100 + sp
+000126c0: 6163 696e 6729 202a 2078 6c6f 6320 2a20  acing) * xloc * 
+000126d0: 7363 616c 6529 2e6d 6f76 6579 280a 2020  scale).movey(.  
+000126e0: 2020 2020 2020 2020 2020 2d28 3130 3020            -(100 
+000126f0: 2b20 7370 6163 696e 6729 202a 2079 6c6f  + spacing) * ylo
+00012700: 6320 2a20 7363 616c 650a 2020 2020 2020  c * scale.      
+00012710: 2020 290a 2020 2020 7265 7475 726e 2044    ).    return D
+00012720: 0a0a 0a63 6c61 7373 2064 6576 6963 655f  ...class device_
+00012730: 6c72 755f 6361 6368 653a 0a20 2020 2022  lru_cache:.    "
+00012740: 2222 4c65 6173 742d 7265 6365 6e74 6c79  ""Least-recently
+00012750: 2d75 7365 6420 284c 5255 2920 6361 6368  -used (LRU) cach
+00012760: 6520 666f 7220 4465 7669 6365 7322 2222  e for Devices"""
+00012770: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+00012780: 5f5f 2873 656c 662c 2066 6e29 3a0a 2020  __(self, fn):.  
+00012790: 2020 2020 2020 7365 6c66 2e6d 6178 7369        self.maxsi
+000127a0: 7a65 203d 2033 320a 2020 2020 2020 2020  ze = 32.        
+000127b0: 7365 6c66 2e66 6e20 3d20 666e 0a20 2020  self.fn = fn.   
+000127c0: 2020 2020 2073 656c 662e 6d65 6d6f 203d       self.memo =
+000127d0: 204f 7264 6572 6564 4469 6374 2829 0a20   OrderedDict(). 
+000127e0: 2020 2020 2020 2075 7064 6174 655f 7772         update_wr
+000127f0: 6170 7065 7228 7365 6c66 2c20 666e 290a  apper(self, fn).
+00012800: 0a20 2020 2064 6566 205f 5f63 616c 6c5f  .    def __call_
+00012810: 5f28 7365 6c66 2c20 2a61 7267 732c 202a  _(self, *args, *
+00012820: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+00012830: 2020 7069 636b 6c65 5f73 7472 203d 2070    pickle_str = p
+00012840: 6963 6b6c 652e 6475 6d70 7328 6172 6773  ickle.dumps(args
+00012850: 2c20 3129 202b 2070 6963 6b6c 652e 6475  , 1) + pickle.du
+00012860: 6d70 7328 6b77 6172 6773 2c20 3129 0a20  mps(kwargs, 1). 
+00012870: 2020 2020 2020 2069 6620 7069 636b 6c65         if pickle
+00012880: 5f73 7472 206e 6f74 2069 6e20 7365 6c66  _str not in self
+00012890: 2e6d 656d 6f2e 6b65 7973 2829 3a0a 2020  .memo.keys():.  
+000128a0: 2020 2020 2020 2020 2020 6e65 775f 6361            new_ca
+000128b0: 6368 655f 6974 656d 203d 2073 656c 662e  che_item = self.
+000128c0: 666e 282a 6172 6773 2c20 2a2a 6b77 6172  fn(*args, **kwar
+000128d0: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+000128e0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
+000128f0: 6528 6e65 775f 6361 6368 655f 6974 656d  e(new_cache_item
+00012900: 2c20 4465 7669 6365 293a 0a20 2020 2020  , Device):.     
+00012910: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00012920: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
+00012930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012940: 2022 5b50 4849 444c 5d20 4064 6576 6963   "[PHIDL] @devic
+00012950: 655f 6c72 755f 6361 6368 6520 6361 6e20  e_lru_cache can 
+00012960: 6f6e 6c79 2062 6520 220a 2020 2020 2020  only be ".      
+00012970: 2020 2020 2020 2020 2020 2020 2020 2275                "u
+00012980: 7365 6420 6f6e 2066 756e 6374 696f 6e73  sed on functions
+00012990: 2077 6869 6368 2072 6574 7572 6e20 6120   which return a 
+000129a0: 4465 7669 6365 220a 2020 2020 2020 2020  Device".        
+000129b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000129c0: 2020 2020 2020 6966 206c 656e 2873 656c        if len(sel
+000129d0: 662e 6d65 6d6f 2920 3e20 7365 6c66 2e6d  f.memo) > self.m
+000129e0: 6178 7369 7a65 3a0a 2020 2020 2020 2020  axsize:.        
+000129f0: 2020 2020 2020 2020 7365 6c66 2e6d 656d          self.mem
+00012a00: 6f2e 706f 7069 7465 6d28 6c61 7374 3d46  o.popitem(last=F
+00012a10: 616c 7365 2920 2023 2052 656d 6f76 6520  alse)  # Remove 
+00012a20: 6f6c 6465 7374 2069 7465 6d20 6672 6f6d  oldest item from
+00012a30: 2063 6163 6865 0a20 2020 2020 2020 2020   cache.         
+00012a40: 2020 2023 2041 6464 2061 2064 6565 7063     # Add a deepc
+00012a50: 6f70 7920 6f66 206e 6577 2069 7465 6d20  opy of new item 
+00012a60: 746f 2063 6163 6865 2073 6f20 7468 6174  to cache so that
+00012a70: 2069 6620 7765 2063 6861 6e67 6520 7468   if we change th
+00012a80: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
+00012a90: 7265 7475 726e 6564 2064 6576 6963 652c  returned device,
+00012aa0: 206f 7572 2073 746f 7265 6420 6361 6368   our stored cach
+00012ab0: 6520 6974 656d 2069 7320 6e6f 7420 6368  e item is not ch
+00012ac0: 616e 6765 640a 2020 2020 2020 2020 2020  anged.          
+00012ad0: 2020 7365 6c66 2e6d 656d 6f5b 7069 636b    self.memo[pick
+00012ae0: 6c65 5f73 7472 5d20 3d20 7079 7468 6f6e  le_str] = python
+00012af0: 5f63 6f70 792e 6465 6570 636f 7079 286e  _copy.deepcopy(n
+00012b00: 6577 5f63 6163 6865 5f69 7465 6d29 0a20  ew_cache_item). 
+00012b10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00012b20: 6e20 6e65 775f 6361 6368 655f 6974 656d  n new_cache_item
+00012b30: 0a20 2020 2020 2020 2065 6c73 653a 2020  .        else:  
+00012b40: 2320 6966 2066 6f75 6e64 2069 6e20 6361  # if found in ca
+00012b50: 6368 650a 2020 2020 2020 2020 2020 2020  che.            
+00012b60: 2320 506f 7020 6361 6368 6520 6974 656d  # Pop cache item
+00012b70: 206f 7574 2061 6e64 2070 7574 2069 7420   out and put it 
+00012b80: 6261 636b 206f 6e20 7468 6520 746f 7020  back on the top 
+00012b90: 6f66 2074 6865 2063 6163 6865 0a20 2020  of the cache.   
+00012ba0: 2020 2020 2020 2020 2063 6163 6865 645f           cached_
+00012bb0: 6f75 7470 7574 203d 2073 656c 662e 6d65  output = self.me
+00012bc0: 6d6f 2e70 6f70 2870 6963 6b6c 655f 7374  mo.pop(pickle_st
+00012bd0: 7229 0a20 2020 2020 2020 2020 2020 2073  r).            s
+00012be0: 656c 662e 6d65 6d6f 5b70 6963 6b6c 655f  elf.memo[pickle_
+00012bf0: 7374 725d 203d 2063 6163 6865 645f 6f75  str] = cached_ou
+00012c00: 7470 7574 0a20 2020 2020 2020 2020 2020  tput.           
+00012c10: 2023 2054 6865 6e20 7265 7475 726e 2061   # Then return a
+00012c20: 2063 6f70 7920 6f66 2074 6865 2063 6163   copy of the cac
+00012c30: 6865 6420 4465 7669 6365 0a20 2020 2020  hed Device.     
+00012c40: 2020 2020 2020 2072 6574 7572 6e20 6465         return de
+00012c50: 6570 636f 7079 2863 6163 6865 645f 6f75  epcopy(cached_ou
+00012c60: 7470 7574 290a 0a0a 6465 6620 5f63 6f6e  tput)...def _con
+00012c70: 7665 7274 5f70 6f72 745f 746f 5f67 656f  vert_port_to_geo
+00012c80: 6d65 7472 7928 706f 7274 2c20 6c61 7965  metry(port, laye
+00012c90: 723d 3029 3a0a 2020 2020 2222 2243 6f6e  r=0):.    """Con
+00012ca0: 7665 7274 7320 6120 506f 7274 2074 6f20  verts a Port to 
+00012cb0: 6120 6c61 6265 6c20 616e 6420 6120 7472  a label and a tr
+00012cc0: 6961 6e67 6c65 2044 6576 6963 6520 7468  iangle Device th
+00012cd0: 6174 2061 7265 2074 6865 6e20 6164 6465  at are then adde
+00012ce0: 640a 2020 2020 746f 2074 6865 2070 6172  d.    to the par
+00012cf0: 656e 742e 0a0a 2020 2020 5061 7261 6d65  ent...    Parame
+00012d00: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+00012d10: 2d2d 2d0a 2020 2020 706f 7274 203a 2050  ---.    port : P
+00012d20: 6f72 740a 2020 2020 2020 2020 506f 7274  ort.        Port
+00012d30: 2074 6f20 6265 2063 6f6e 7665 7274 6564   to be converted
+00012d40: 2e0a 2020 2020 6c61 7965 7220 3a20 696e  ..    layer : in
+00012d50: 742c 2061 7272 6179 2d6c 696b 655b 325d  t, array-like[2]
+00012d60: 2c20 6f72 2073 6574 0a20 2020 2020 2020  , or set.       
+00012d70: 2053 7065 6369 6669 6320 6c61 7965 7228   Specific layer(
+00012d80: 7329 2074 6f20 7075 7420 6c61 6265 6c20  s) to put label 
+00012d90: 616e 6420 6765 6f6d 6574 7279 206f 6e2e  and geometry on.
+00012da0: 0a0a 2020 2020 4e6f 7465 730a 2020 2020  ..    Notes.    
+00012db0: 2d2d 2d2d 2d0a 2020 2020 5468 6520 506f  -----.    The Po
+00012dc0: 7274 206d 7573 7420 7374 6172 7420 7769  rt must start wi
+00012dd0: 7468 2061 2070 6172 656e 742e 0a20 2020  th a parent..   
+00012de0: 2022 2222 0a20 2020 2069 6620 706f 7274   """.    if port
+00012df0: 2e70 6172 656e 7420 6973 204e 6f6e 653a  .parent is None:
+00012e00: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
+00012e10: 616c 7565 4572 726f 7228 6622 506f 7274  alueError(f"Port
+00012e20: 207b 706f 7274 2e6e 616d 657d 3a20 506f   {port.name}: Po
+00012e30: 7274 206e 6565 6473 2061 2070 6172 656e  rt needs a paren
+00012e40: 7420 696e 2077 6869 6368 2074 6f20 6472  t in which to dr
+00012e50: 6177 2229 0a20 2020 2069 6620 6973 696e  aw").    if isin
+00012e60: 7374 616e 6365 2870 6f72 742e 7061 7265  stance(port.pare
+00012e70: 6e74 2c20 4465 7669 6365 5265 6665 7265  nt, DeviceRefere
+00012e80: 6e63 6529 3a0a 2020 2020 2020 2020 6465  nce):.        de
+00012e90: 7669 6365 203d 2070 6f72 742e 7061 7265  vice = port.pare
+00012ea0: 6e74 2e70 6172 656e 740a 2020 2020 656c  nt.parent.    el
+00012eb0: 7365 3a0a 2020 2020 2020 2020 6465 7669  se:.        devi
+00012ec0: 6365 203d 2070 6f72 742e 7061 7265 6e74  ce = port.parent
+00012ed0: 0a0a 2020 2020 2320 4120 7669 7375 616c  ..    # A visual
+00012ee0: 206d 6172 6b65 720a 2020 2020 7472 6961   marker.    tria
+00012ef0: 6e67 6c65 5f70 6f69 6e74 7320 3d20 5b5b  ngle_points = [[
+00012f00: 302c 2030 5d5d 202a 2033 0a20 2020 2074  0, 0]] * 3.    t
+00012f10: 7269 616e 676c 655f 706f 696e 7473 5b30  riangle_points[0
+00012f20: 5d20 3d20 706f 7274 2e65 6e64 706f 696e  ] = port.endpoin
+00012f30: 7473 5b30 5d0a 2020 2020 7472 6961 6e67  ts[0].    triang
+00012f40: 6c65 5f70 6f69 6e74 735b 315d 203d 2070  le_points[1] = p
+00012f50: 6f72 742e 656e 6470 6f69 6e74 735b 315d  ort.endpoints[1]
+00012f60: 0a20 2020 2074 7269 616e 676c 655f 706f  .    triangle_po
+00012f70: 696e 7473 5b32 5d20 3d20 280a 2020 2020  ints[2] = (.    
+00012f80: 2020 2020 706f 7274 2e6d 6964 706f 696e      port.midpoin
+00012f90: 7420 2b20 2870 6f72 742e 6e6f 726d 616c  t + (port.normal
+00012fa0: 202d 2070 6f72 742e 6d69 6470 6f69 6e74   - port.midpoint
+00012fb0: 2920 2a20 706f 7274 2e77 6964 7468 202f  ) * port.width /
+00012fc0: 2031 300a 2020 2020 295b 315d 0a20 2020   10.    )[1].   
+00012fd0: 2064 6576 6963 652e 6164 645f 706f 6c79   device.add_poly
+00012fe0: 676f 6e28 7472 6961 6e67 6c65 5f70 6f69  gon(triangle_poi
+00012ff0: 6e74 732c 206c 6179 6572 290a 0a20 2020  nts, layer)..   
+00013000: 2023 204c 6162 656c 2063 6172 7279 696e   # Label carryin
+00013010: 6720 6163 7475 616c 2069 6e66 6f72 6d61  g actual informa
+00013020: 7469 6f6e 2074 6861 7420 7769 6c6c 2062  tion that will b
+00013030: 6520 7265 636f 7665 7265 640a 2020 2020  e recovered.    
+00013040: 6c61 6265 6c5f 636f 6e74 656e 7473 203d  label_contents =
+00013050: 2028 0a20 2020 2020 2020 2073 7472 2870   (.        str(p
+00013060: 6f72 742e 6e61 6d65 292c 0a20 2020 2020  ort.name),.     
+00013070: 2020 2023 2070 6f72 742e 6d69 6470 6f69     # port.midpoi
+00013080: 6e74 2c0a 2020 2020 2020 2020 2320 7261  nt,.        # ra
+00013090: 7468 6572 2074 6861 6e20 7075 7420 7468  ther than put th
+000130a0: 6973 2069 6e20 7468 6520 7465 7874 2c20  is in the text, 
+000130b0: 7573 6520 7468 6520 6c61 6265 6c0a 2020  use the label.  
+000130c0: 2020 2020 2020 2320 706f 7369 7469 6f6e        # position
+000130d0: 0a20 2020 2020 2020 2023 2074 6869 7320  .        # this 
+000130e0: 6361 6e20 6861 7665 2072 6f75 6e64 696e  can have roundin
+000130f0: 6720 6572 726f 7273 2074 6861 7420 6172  g errors that ar
+00013100: 6520 6c65 7373 2074 6861 6e20 610a 2020  e less than a.  
+00013110: 2020 2020 2020 2320 6e61 6e6f 6d65 7465        # nanomete
+00013120: 720a 2020 2020 2020 2020 666c 6f61 7428  r.        float(
+00013130: 6e70 2e72 6f75 6e64 2870 6f72 742e 7769  np.round(port.wi
+00013140: 6474 682c 2064 6563 696d 616c 733d 3329  dth, decimals=3)
+00013150: 292c 0a20 2020 2020 2020 2066 6c6f 6174  ),.        float
+00013160: 2870 6f72 742e 6f72 6965 6e74 6174 696f  (port.orientatio
+00013170: 6e29 2c0a 2020 2020 2020 2020 2320 6465  n),.        # de
+00013180: 7669 6365 2c20 2320 7468 6973 2069 7320  vice, # this is 
+00013190: 6465 6669 6e69 7465 6c79 206e 6f74 2073  definitely not s
+000131a0: 6572 6961 6c69 7a61 626c 650a 2020 2020  erializable.    
+000131b0: 2020 2020 2320 706f 7274 2e69 6e66 6f2c      # port.info,
+000131c0: 2023 2077 6f75 6c64 206c 696b 6520 746f   # would like to
+000131d0: 2069 6e63 6c75 6465 2c20 6275 7420 6974   include, but it
+000131e0: 206d 6967 6874 2067 6f0a 2020 2020 2020   might go.      
+000131f0: 2020 2320 6c6f 6e67 6572 2074 6861 6e20    # longer than 
+00013200: 3130 3234 2063 6861 7261 6374 6572 730a  1024 characters.
+00013210: 2020 2020 2020 2020 2320 706f 7274 2e75          # port.u
+00013220: 6964 2c20 2320 6e6f 7420 696e 636c 7564  id, # not includ
+00013230: 696e 6720 6265 6361 7573 6520 6974 2069  ing because it i
+00013240: 7320 7061 7274 206f 6620 7468 650a 2020  s part of the.  
+00013250: 2020 2020 2020 2320 6275 696c 6420 7072        # build pr
+00013260: 6f63 6573 732c 206e 6f74 2074 6865 2070  ocess, not the p
+00013270: 6f72 7420 7374 6174 650a 2020 2020 290a  ort state.    ).
+00013280: 2020 2020 6c61 6265 6c5f 7465 7874 203d      label_text =
+00013290: 206a 736f 6e2e 6475 6d70 7328 6c61 6265   json.dumps(labe
+000132a0: 6c5f 636f 6e74 656e 7473 290a 2020 2020  l_contents).    
+000132b0: 6465 7669 6365 2e61 6464 5f6c 6162 656c  device.add_label
+000132c0: 280a 2020 2020 2020 2020 7465 7874 3d6c  (.        text=l
+000132d0: 6162 656c 5f74 6578 742c 0a20 2020 2020  abel_text,.     
+000132e0: 2020 2070 6f73 6974 696f 6e3d 706f 7274     position=port
+000132f0: 2e6d 6964 706f 696e 7420 2b20 5f63 616c  .midpoint + _cal
+00013300: 6375 6c61 7465 5f6c 6162 656c 5f6f 6666  culate_label_off
+00013310: 7365 7428 706f 7274 292c 0a20 2020 2020  set(port),.     
+00013320: 2020 206d 6167 6e69 6669 6361 7469 6f6e     magnification
+00013330: 3d30 2e30 3420 2a20 706f 7274 2e77 6964  =0.04 * port.wid
+00013340: 7468 2c0a 2020 2020 2020 2020 726f 7461  th,.        rota
+00013350: 7469 6f6e 3d28 3930 202b 2070 6f72 742e  tion=(90 + port.
+00013360: 6f72 6965 6e74 6174 696f 6e29 2025 2033  orientation) % 3
+00013370: 3630 2c0a 2020 2020 2020 2020 6c61 7965  60,.        laye
+00013380: 723d 6c61 7965 722c 0a20 2020 2029 0a0a  r=layer,.    )..
+00013390: 0a64 6566 205f 6361 6c63 756c 6174 655f  .def _calculate_
+000133a0: 6c61 6265 6c5f 6f66 6673 6574 2870 6f72  label_offset(por
+000133b0: 7429 3a0a 2020 2020 2222 2255 7365 6420  t):.    """Used 
+000133c0: 746f 2070 7574 2074 6865 206c 6162 656c  to put the label
+000133d0: 2069 6e20 6120 7072 6574 7479 2070 6f73   in a pretty pos
+000133e0: 6974 696f 6e2e 2049 7420 6973 2061 6464  ition. It is add
+000133f0: 6564 2077 6865 6e20 6472 6177 696e 670a  ed when drawing.
+00013400: 2020 2020 616e 6420 7375 6273 7472 6163      and substrac
+00013410: 7465 6420 7768 656e 2065 7874 7261 6374  ted when extract
+00013420: 696e 672e 0a0a 2020 2020 5061 7261 6d65  ing...    Parame
+00013430: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+00013440: 2d2d 2d0a 2020 2020 706f 7274 203a 2050  ---.    port : P
+00013450: 6f72 740a 2020 2020 2020 2020 506f 7274  ort.        Port
+00013460: 2d63 6f6e 7665 7274 6564 206c 6162 656c  -converted label
+00013470: 2074 6f20 6d6f 7665 2e0a 0a20 2020 2052   to move...    R
+00013480: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
+00013490: 2d2d 0a20 2020 206f 6666 7365 745f 706f  --.    offset_po
+000134a0: 7369 7469 6f6e 203a 2061 7272 6179 2d6c  sition : array-l
+000134b0: 696b 650a 2020 2020 2020 2020 436f 6f72  ike.        Coor
+000134c0: 6469 6e61 7465 7320 6f66 206e 6577 2070  dinates of new p
+000134d0: 6f72 7420 706f 7369 7469 6f6e 2e0a 2020  ort position..  
+000134e0: 2020 2222 220a 2020 2020 6f66 6673 6574    """.    offset
+000134f0: 5f70 6f73 6974 696f 6e20 3d20 6e70 2e61  _position = np.a
+00013500: 7272 6179 280a 2020 2020 2020 2020 282d  rray(.        (-
+00013510: 636f 7328 7069 202f 2031 3830 202a 2070  cos(pi / 180 * p
+00013520: 6f72 742e 6f72 6965 6e74 6174 696f 6e29  ort.orientation)
+00013530: 2c20 2d73 696e 2870 6920 2f20 3138 3020  , -sin(pi / 180 
+00013540: 2a20 706f 7274 2e6f 7269 656e 7461 7469  * port.orientati
+00013550: 6f6e 2929 0a20 2020 2029 0a20 2020 206f  on)).    ).    o
+00013560: 6666 7365 745f 706f 7369 7469 6f6e 202a  ffset_position *
+00013570: 3d20 706f 7274 2e77 6964 7468 202a 2030  = port.width * 0
+00013580: 2e30 350a 2020 2020 7265 7475 726e 206f  .05.    return o
+00013590: 6666 7365 745f 706f 7369 7469 6f6e 0a0a  ffset_position..
+000135a0: 0a64 6566 205f 636f 6e76 6572 745f 6765  .def _convert_ge
+000135b0: 6f6d 6574 7279 5f74 6f5f 706f 7274 286c  ometry_to_port(l
+000135c0: 6162 656c 2c20 6c61 7965 723d 3029 3a0a  abel, layer=0):.
+000135d0: 2020 2020 2222 2243 6f6e 7665 7274 7320      """Converts 
+000135e0: 6120 6c61 6265 6c20 696e 746f 2061 2050  a label into a P
+000135f0: 6f72 7420 696e 2074 6865 2070 6172 656e  ort in the paren
+00013600: 7420 4465 7669 6365 2e20 5468 6520 6c61  t Device. The la
+00013610: 6265 6c20 636f 6e74 6169 6e73 0a20 2020  bel contains.   
+00013620: 206e 616d 652c 2077 6964 7468 2c20 6f72   name, width, or
+00013630: 6965 6e74 6174 696f 6e2e 2044 6f65 7320  ientation. Does 
+00013640: 6e6f 7420 7265 6d6f 7665 2074 6861 7420  not remove that 
+00013650: 6c61 6265 6c20 6672 6f6d 2074 6865 2070  label from the p
+00013660: 6172 656e 742e 0a20 2020 2052 6574 7572  arent..    Retur
+00013670: 6e73 2074 6865 206e 6577 2070 6f72 742e  ns the new port.
+00013680: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00013690: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+000136a0: 2020 2020 6c61 6265 6c20 3a20 4c61 6265      label : Labe
+000136b0: 6c0a 2020 2020 2020 2020 4c61 6265 6c20  l.        Label 
+000136c0: 746f 2062 6520 636f 6e76 6572 7465 6420  to be converted 
+000136d0: 696e 746f 2061 2050 6f72 742e 0a20 2020  into a Port..   
+000136e0: 206c 6179 6572 203a 2069 6e74 2c20 6172   layer : int, ar
+000136f0: 7261 792d 6c69 6b65 5b32 5d2c 206f 7220  ray-like[2], or 
+00013700: 7365 740a 2020 2020 2020 2020 5370 6563  set.        Spec
+00013710: 6966 6963 206c 6179 6572 2873 2920 746f  ific layer(s) to
+00013720: 2070 7574 2050 6f72 7420 6f6e 2e0a 0a20   put Port on... 
+00013730: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
+00013740: 2d2d 2d2d 2d2d 0a20 2020 206e 6577 5f70  ------.    new_p
+00013750: 6f72 7420 3a20 506f 7274 0a20 2020 2020  ort : Port.     
+00013760: 2020 2050 6f72 742d 636f 6e76 6572 7465     Port-converte
+00013770: 6420 6c61 6265 6c2e 0a20 2020 2022 2222  d label..    """
+00013780: 0a20 2020 206e 616d 652c 2077 6964 7468  .    name, width
+00013790: 2c20 6f72 6965 6e74 6174 696f 6e20 3d20  , orientation = 
+000137a0: 6a73 6f6e 2e6c 6f61 6473 286c 6162 656c  json.loads(label
+000137b0: 2e74 6578 7429 0a20 2020 206e 6577 5f70  .text).    new_p
+000137c0: 6f72 7420 3d20 506f 7274 286e 616d 653d  ort = Port(name=
+000137d0: 6e61 6d65 2c20 7769 6474 683d 7769 6474  name, width=widt
+000137e0: 682c 206f 7269 656e 7461 7469 6f6e 3d6f  h, orientation=o
+000137f0: 7269 656e 7461 7469 6f6e 290a 2020 2020  rientation).    
+00013800: 6e65 775f 706f 7274 2e6d 6964 706f 696e  new_port.midpoin
+00013810: 7420 3d20 6c61 6265 6c2e 706f 7369 7469  t = label.positi
+00013820: 6f6e 202d 205f 6361 6c63 756c 6174 655f  on - _calculate_
+00013830: 6c61 6265 6c5f 6f66 6673 6574 286e 6577  label_offset(new
+00013840: 5f70 6f72 7429 0a20 2020 2072 6574 7572  _port).    retur
+00013850: 6e20 6e65 775f 706f 7274 0a0a 0a64 6566  n new_port...def
+00013860: 2070 6f72 7473 5f74 6f5f 6765 6f6d 6574   ports_to_geomet
+00013870: 7279 2864 6576 6963 652c 206c 6179 6572  ry(device, layer
+00013880: 3d30 293a 0a20 2020 2022 2222 436f 6e76  =0):.    """Conv
+00013890: 6572 7473 2050 6f72 7420 6f62 6a65 6374  erts Port object
+000138a0: 7320 6f76 6572 2074 6865 2077 686f 6c65  s over the whole
+000138b0: 2044 6576 6963 6520 6869 6572 6172 6368   Device hierarch
+000138c0: 7920 746f 2067 656f 6d65 7472 7920 616e  y to geometry an
+000138d0: 640a 2020 2020 6c61 6265 6c73 2e0a 0a20  d.    labels... 
+000138e0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+000138f0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+00013900: 2064 6576 6963 6520 3a20 4465 7669 6365   device : Device
+00013910: 0a20 2020 2020 2020 2044 6576 6963 6520  .        Device 
+00013920: 636f 6e74 6169 6e69 6e67 2050 6f72 7420  containing Port 
+00013930: 6f62 6a65 6374 7320 746f 2063 6f6e 7665  objects to conve
+00013940: 7274 2e0a 2020 2020 6c61 7965 7220 3a20  rt..    layer : 
+00013950: 696e 742c 2061 7272 6179 2d6c 696b 655b  int, array-like[
+00013960: 325d 2c20 6f72 2073 6574 0a20 2020 2020  2], or set.     
+00013970: 2020 2053 7065 6369 6669 6320 6c61 7965     Specific laye
+00013980: 7228 7329 2074 6f20 7075 7420 706f 6c79  r(s) to put poly
+00013990: 676f 6e20 6765 6f6d 6574 7279 206f 6e20  gon geometry on 
+000139a0: 2874 6865 2073 7065 6369 616c 2070 6f72  (the special por
+000139b0: 7420 7265 636f 7264 0a20 2020 2020 2020  t record.       
+000139c0: 206c 6179 6572 292e 0a0a 2020 2020 5265   layer)...    Re
+000139d0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+000139e0: 2d0a 2020 2020 7465 6d70 5f64 6576 6963  -.    temp_devic
+000139f0: 6520 3a20 4465 7669 6365 0a20 2020 2020  e : Device.     
+00013a00: 2020 2041 2044 6576 6963 6520 7769 7468     A Device with
+00013a10: 2061 6c6c 2050 6f72 7473 2063 6f6e 7665   all Ports conve
+00013a20: 7274 6564 2074 6f20 6765 6f6d 6574 7279  rted to geometry
+00013a30: 2f6c 6162 656c 7320 616e 6420 7265 6d6f  /labels and remo
+00013a40: 7665 642e 0a20 2020 2022 2222 0a20 2020  ved..    """.   
+00013a50: 2074 656d 705f 6465 7669 6365 203d 2064   temp_device = d
+00013a60: 6565 7063 6f70 7928 6465 7669 6365 290a  eepcopy(device).
+00013a70: 2020 2020 616c 6c5f 6365 6c6c 7320 3d20      all_cells = 
+00013a80: 6c69 7374 2874 656d 705f 6465 7669 6365  list(temp_device
+00013a90: 2e67 6574 5f64 6570 656e 6465 6e63 6965  .get_dependencie
+00013aa0: 7328 7265 6375 7273 6976 653d 5472 7565  s(recursive=True
+00013ab0: 2929 0a20 2020 2061 6c6c 5f63 656c 6c73  )).    all_cells
+00013ac0: 2e61 7070 656e 6428 7465 6d70 5f64 6576  .append(temp_dev
+00013ad0: 6963 6529 0a20 2020 2066 6f72 2073 7562  ice).    for sub
+00013ae0: 6365 6c6c 2069 6e20 616c 6c5f 6365 6c6c  cell in all_cell
+00013af0: 733a 0a20 2020 2020 2020 2066 6f72 2070  s:.        for p
+00013b00: 6f72 7420 696e 2073 7562 6365 6c6c 2e70  ort in subcell.p
+00013b10: 6f72 7473 2e76 616c 7565 7328 293a 0a20  orts.values():. 
+00013b20: 2020 2020 2020 2020 2020 205f 636f 6e76             _conv
+00013b30: 6572 745f 706f 7274 5f74 6f5f 6765 6f6d  ert_port_to_geom
+00013b40: 6574 7279 2870 6f72 742c 206c 6179 6572  etry(port, layer
+00013b50: 3d6c 6179 6572 290a 2020 2020 2020 2020  =layer).        
+00013b60: 2020 2020 7375 6263 656c 6c2e 7265 6d6f      subcell.remo
+00013b70: 7665 2870 6f72 7429 0a20 2020 2072 6574  ve(port).    ret
+00013b80: 7572 6e20 7465 6d70 5f64 6576 6963 650a  urn temp_device.
+00013b90: 0a0a 6465 6620 6765 6f6d 6574 7279 5f74  ..def geometry_t
+00013ba0: 6f5f 706f 7274 7328 6465 7669 6365 2c20  o_ports(device, 
+00013bb0: 6c61 7965 723d 3029 3a0a 2020 2020 2222  layer=0):.    ""
+00013bc0: 2243 6f6e 7665 7274 7320 6765 6f6d 6574  "Converts geomet
+00013bd0: 7279 2072 6570 7265 7365 6e74 696e 6720  ry representing 
+00013be0: 706f 7274 7320 6f76 6572 2074 6865 2077  ports over the w
+00013bf0: 686f 6c65 2044 6576 6963 6520 6869 6572  hole Device hier
+00013c00: 6172 6368 790a 2020 2020 696e 746f 2050  archy.    into P
+00013c10: 6f72 7420 6f62 6a65 6374 732e 0a0a 2020  ort objects...  
+00013c20: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00013c30: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00013c40: 6465 7669 6365 203a 2044 6576 6963 650a  device : Device.
+00013c50: 2020 2020 2020 2020 4465 7669 6365 2063          Device c
+00013c60: 6f6e 7461 696e 696e 6720 6765 6f6d 6574  ontaining geomet
+00013c70: 7279 2072 6570 7265 7365 6e74 696e 6720  ry representing 
+00013c80: 706f 7274 7320 746f 2063 6f6e 7665 7274  ports to convert
+00013c90: 2e0a 2020 2020 6c61 7965 7220 3a20 696e  ..    layer : in
+00013ca0: 742c 2061 7272 6179 2d6c 696b 655b 325d  t, array-like[2]
+00013cb0: 2c20 6f72 2073 6574 0a20 2020 2020 2020  , or set.       
+00013cc0: 2053 7065 6369 6669 6320 6c61 7965 7228   Specific layer(
+00013cd0: 7329 2074 6f20 7075 7420 706f 6c79 676f  s) to put polygo
+00013ce0: 6e20 6765 6f6d 6574 7279 206f 6e20 2874  n geometry on (t
+00013cf0: 6865 2073 7065 6369 616c 2070 6f72 7420  he special port 
+00013d00: 7265 636f 7264 0a20 2020 2020 2020 206c  record.        l
+00013d10: 6179 6572 290a 0a20 2020 2052 6574 7572  ayer)..    Retur
+00013d20: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+00013d30: 2020 2074 656d 705f 6465 7669 6365 203a     temp_device :
+00013d40: 2044 6576 6963 650a 2020 2020 2020 2020   Device.        
+00013d50: 4120 4465 7669 6365 2077 6974 6820 616c  A Device with al
+00013d60: 6c20 6765 6f6d 6574 7279 2072 6570 7265  l geometry repre
+00013d70: 7365 6e74 696e 6720 706f 7274 7320 636f  senting ports co
+00013d80: 6e76 6572 7465 6420 746f 2050 6f72 7473  nverted to Ports
+00013d90: 2061 6e64 0a20 2020 2020 2020 2072 656d   and.        rem
+00013da0: 6f76 6564 2e0a 0a20 2020 204e 6f74 6573  oved...    Notes
+00013db0: 0a20 2020 202d 2d2d 2d2d 0a20 2020 2044  .    -----.    D
+00013dc0: 6f65 7320 6e6f 7420 6d75 7461 7465 2074  oes not mutate t
+00013dd0: 6865 2064 6576 6963 6520 696e 2074 6865  he device in the
+00013de0: 2061 7267 756d 656e 742e 2052 6574 7572   argument. Retur
+00013df0: 6e73 2061 206e 6577 206f 6e65 206c 6163  ns a new one lac
+00013e00: 6b69 6e67 2061 6c6c 0a20 2020 2070 6f72  king all.    por
+00013e10: 7420 6765 6f6d 6574 7279 2028 696e 636c  t geometry (incl
+00013e20: 2e20 6c61 6265 6c73 290a 2020 2020 2222  . labels).    ""
+00013e30: 220a 2020 2020 7465 6d70 5f64 6576 6963  ".    temp_devic
+00013e40: 6520 3d20 6465 6570 636f 7079 2864 6576  e = deepcopy(dev
+00013e50: 6963 6529 0a20 2020 2061 6c6c 5f63 656c  ice).    all_cel
+00013e60: 6c73 203d 206c 6973 7428 7465 6d70 5f64  ls = list(temp_d
+00013e70: 6576 6963 652e 6765 745f 6465 7065 6e64  evice.get_depend
+00013e80: 656e 6369 6573 2872 6563 7572 7369 7665  encies(recursive
+00013e90: 3d54 7275 6529 290a 2020 2020 616c 6c5f  =True)).    all_
+00013ea0: 6365 6c6c 732e 6170 7065 6e64 2874 656d  cells.append(tem
+00013eb0: 705f 6465 7669 6365 290a 2020 2020 666f  p_device).    fo
+00013ec0: 7220 7375 6263 656c 6c20 696e 2061 6c6c  r subcell in all
+00013ed0: 5f63 656c 6c73 3a20 2023 2057 616c 6b20  _cells:  # Walk 
+00013ee0: 7468 726f 7567 6820 6365 6c6c 730a 2020  through cells.  
+00013ef0: 2020 2020 2020 666f 7220 6c61 6220 696e        for lab in
+00013f00: 2073 7562 6365 6c6c 2e6c 6162 656c 733a   subcell.labels:
+00013f10: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00013f20: 6c61 622e 6c61 7965 7220 3d3d 206c 6179  lab.layer == lay
+00013f30: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+00013f40: 2020 2020 7468 655f 706f 7274 203d 205f      the_port = _
+00013f50: 636f 6e76 6572 745f 6765 6f6d 6574 7279  convert_geometry
+00013f60: 5f74 6f5f 706f 7274 286c 6162 290a 2020  _to_port(lab).  
+00013f70: 2020 2020 2020 2020 2020 2020 2020 7375                su
+00013f80: 6263 656c 6c2e 6164 645f 706f 7274 286e  bcell.add_port(n
+00013f90: 616d 653d 7468 655f 706f 7274 2e6e 616d  ame=the_port.nam
+00013fa0: 652c 2070 6f72 743d 7468 655f 706f 7274  e, port=the_port
+00013fb0: 290a 2020 2020 7465 6d70 5f64 6576 6963  ).    temp_devic
+00013fc0: 652e 7265 6d6f 7665 5f6c 6179 6572 7328  e.remove_layers(
+00013fd0: 6c61 7965 7273 3d5b 6c61 7965 725d 2c20  layers=[layer], 
+00013fe0: 696e 636c 7564 655f 6c61 6265 6c73 3d54  include_labels=T
+00013ff0: 7275 6529 0a20 2020 2072 6574 7572 6e20  rue).    return 
+00014000: 7465 6d70 5f64 6576 6963 650a 0a0a 2320  temp_device...# 
+00014010: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00014020: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00014030: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00014040: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00014050: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a23  ==============.#
+00014060: 0a23 2043 6f6e 6e65 6374 6f72 730a 230a  .# Connectors.#.
+00014070: 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  # ==============
+00014080: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00014090: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000140a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000140b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000140c0: 0a0a 0a64 6566 2063 6f6e 6e65 6374 6f72  ...def connector
+000140d0: 286d 6964 706f 696e 743d 2830 2c20 3029  (midpoint=(0, 0)
+000140e0: 2c20 7769 6474 683d 312c 206f 7269 656e  , width=1, orien
+000140f0: 7461 7469 6f6e 3d30 293a 0a20 2020 2022  tation=0):.    "
+00014100: 2222 4372 6561 7465 7320 6120 4465 7669  ""Creates a Devi
+00014110: 6365 2077 6869 6368 2068 6173 2062 6163  ce which has bac
+00014120: 6b2d 746f 2d62 6163 6b20 706f 7274 732e  k-to-back ports.
+00014130: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00014140: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+00014150: 2020 2020 6d69 6470 6f69 6e74 203a 2061      midpoint : a
+00014160: 7272 6179 2d6c 696b 650a 2020 2020 2020  rray-like.      
+00014170: 2020 436f 6f72 6469 6e61 7465 7320 6f66    Coordinates of
+00014180: 2044 6576 6963 6520 6d69 6470 6f69 6e74   Device midpoint
+00014190: 2e0a 2020 2020 7769 6474 6820 3a20 696e  ..    width : in
+000141a0: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
+000141b0: 2020 2057 6964 7468 206f 6620 636f 6e6e     Width of conn
+000141c0: 6563 746f 7220 6f6e 206e 6f6e 2d70 6f72  ector on non-por
+000141d0: 7420 6178 6973 2e0a 2020 2020 6f72 6965  t axis..    orie
+000141e0: 6e74 6174 696f 6e20 3a20 696e 7420 6f72  ntation : int or
+000141f0: 2066 6c6f 6174 0a20 2020 2020 2020 204f   float.        O
+00014200: 7269 656e 7461 7469 6f6e 206f 6620 7468  rientation of th
+00014210: 6520 706f 7274 732e 0a0a 2020 2020 5265  e ports...    Re
+00014220: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+00014230: 2d0a 2020 2020 4420 3a20 4465 7669 6365  -.    D : Device
+00014240: 0a20 2020 2020 2020 2041 2044 6576 6963  .        A Devic
+00014250: 6520 636f 6e74 6169 6e69 6e67 2061 2062  e containing a b
+00014260: 6163 6b2d 746f 2d62 6163 6b20 706f 7274  ack-to-back port
+00014270: 2067 656f 6d65 7472 792e 0a20 2020 2022   geometry..    "
+00014280: 2222 0a20 2020 2044 203d 2044 6576 6963  "".    D = Devic
+00014290: 6528 6e61 6d65 3d22 636f 6e6e 6563 746f  e(name="connecto
+000142a0: 7222 290a 2020 2020 442e 6164 645f 706f  r").    D.add_po
+000142b0: 7274 280a 2020 2020 2020 2020 6e61 6d65  rt(.        name
+000142c0: 3d31 2c0a 2020 2020 2020 2020 6d69 6470  =1,.        midp
+000142d0: 6f69 6e74 3d5b 6d69 6470 6f69 6e74 5b30  oint=[midpoint[0
+000142e0: 5d2c 206d 6964 706f 696e 745b 315d 5d2c  ], midpoint[1]],
+000142f0: 0a20 2020 2020 2020 2077 6964 7468 3d77  .        width=w
+00014300: 6964 7468 2c0a 2020 2020 2020 2020 6f72  idth,.        or
+00014310: 6965 6e74 6174 696f 6e3d 6f72 6965 6e74  ientation=orient
+00014320: 6174 696f 6e2c 0a20 2020 2029 0a20 2020  ation,.    ).   
+00014330: 2044 2e61 6464 5f70 6f72 7428 0a20 2020   D.add_port(.   
+00014340: 2020 2020 206e 616d 653d 322c 0a20 2020       name=2,.   
+00014350: 2020 2020 206d 6964 706f 696e 743d 5b6d       midpoint=[m
+00014360: 6964 706f 696e 745b 305d 2c20 6d69 6470  idpoint[0], midp
+00014370: 6f69 6e74 5b31 5d5d 2c0a 2020 2020 2020  oint[1]],.      
+00014380: 2020 7769 6474 683d 7769 6474 682c 0a20    width=width,. 
+00014390: 2020 2020 2020 206f 7269 656e 7461 7469         orientati
+000143a0: 6f6e 3d6f 7269 656e 7461 7469 6f6e 202d  on=orientation -
+000143b0: 2031 3830 2c0a 2020 2020 290a 2020 2020   180,.    ).    
+000143c0: 7265 7475 726e 2044 0a0a 0a23 203d 3d3d  return D...# ===
+000143d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000143e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000143f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00014400: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00014410: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 230a 2320  ===========.#.# 
+00014420: 436f 6e74 6163 7420 7061 6473 0a23 0a23  Contact pads.#.#
+00014430: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
+00014440: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00014450: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00014460: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00014470: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
+00014480: 0a0a 6465 6620 636f 6d70 6173 7328 7369  ..def compass(si
+00014490: 7a65 3d28 342c 2032 292c 206c 6179 6572  ze=(4, 2), layer
+000144a0: 3d30 293a 0a20 2020 2022 2222 4372 6561  =0):.    """Crea
+000144b0: 7465 7320 6120 7265 6374 616e 6775 6c61  tes a rectangula
+000144c0: 7220 636f 6e74 6163 7420 7061 6420 7769  r contact pad wi
+000144d0: 7468 2063 656e 7465 7265 6420 706f 7274  th centered port
+000144e0: 7320 6f6e 2065 6467 6573 206f 6620 7468  s on edges of th
+000144f0: 650a 2020 2020 7265 6374 616e 676c 6520  e.    rectangle 
+00014500: 286e 6f72 7468 2c20 736f 7574 682c 2065  (north, south, e
+00014510: 6173 742c 2061 6e64 2077 6573 7429 2e0a  ast, and west)..
+00014520: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00014530: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00014540: 2020 2073 697a 6520 3a20 6172 7261 795f     size : array_
+00014550: 6c69 6b65 5b32 5d0a 2020 2020 2020 2020  like[2].        
+00014560: 4469 6d65 6e73 696f 6e73 206f 6620 7468  Dimensions of th
+00014570: 6520 7265 6374 616e 6775 6c61 7220 636f  e rectangular co
+00014580: 6e74 6163 7420 7061 642e 0a20 2020 206c  ntact pad..    l
+00014590: 6179 6572 203a 2069 6e74 2c20 6172 7261  ayer : int, arra
+000145a0: 792d 6c69 6b65 5b32 5d2c 206f 7220 7365  y-like[2], or se
+000145b0: 740a 2020 2020 2020 2020 5370 6563 6966  t.        Specif
+000145c0: 6963 206c 6179 6572 2873 2920 746f 2070  ic layer(s) to p
+000145d0: 7574 2070 6f6c 7967 6f6e 2067 656f 6d65  ut polygon geome
+000145e0: 7472 7920 6f6e 2e0a 0a20 2020 2052 6574  try on...    Ret
+000145f0: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+00014600: 0a20 2020 2044 203a 2044 6576 6963 650a  .    D : Device.
+00014610: 2020 2020 2020 2020 4120 4465 7669 6365          A Device
+00014620: 2063 6f6e 7461 696e 696e 6720 6120 7265   containing a re
+00014630: 6374 616e 6775 6c61 7220 636f 6e74 6163  ctangular contac
+00014640: 7420 7061 6420 7769 7468 2063 656e 7465  t pad with cente
+00014650: 7265 6420 706f 7274 732e 0a20 2020 2022  red ports..    "
+00014660: 2222 0a20 2020 2044 203d 2044 6576 6963  "".    D = Devic
+00014670: 6528 6e61 6d65 3d22 636f 6d70 6173 7322  e(name="compass"
+00014680: 290a 2020 2020 7220 3d20 442e 6164 645f  ).    r = D.add_
+00014690: 7265 6628 7265 6374 616e 676c 6528 7369  ref(rectangle(si
+000146a0: 7a65 2c20 6c61 7965 723d 6c61 7965 7229  ze, layer=layer)
+000146b0: 290a 2020 2020 722e 6365 6e74 6572 203d  ).    r.center =
+000146c0: 2028 302c 2030 290a 0a20 2020 2064 7820   (0, 0)..    dx 
+000146d0: 3d20 7369 7a65 5b30 5d0a 2020 2020 6479  = size[0].    dy
+000146e0: 203d 2073 697a 655b 315d 0a20 2020 2044   = size[1].    D
+000146f0: 2e61 6464 5f70 6f72 7428 6e61 6d65 3d22  .add_port(name="
+00014700: 4e22 2c20 6d69 6470 6f69 6e74 3d5b 302c  N", midpoint=[0,
+00014710: 2064 7920 2f20 325d 2c20 7769 6474 683d   dy / 2], width=
+00014720: 6478 2c20 6f72 6965 6e74 6174 696f 6e3d  dx, orientation=
+00014730: 3930 290a 2020 2020 442e 6164 645f 706f  90).    D.add_po
+00014740: 7274 286e 616d 653d 2253 222c 206d 6964  rt(name="S", mid
+00014750: 706f 696e 743d 5b30 2c20 2d64 7920 2f20  point=[0, -dy / 
+00014760: 325d 2c20 7769 6474 683d 6478 2c20 6f72  2], width=dx, or
+00014770: 6965 6e74 6174 696f 6e3d 2d39 3029 0a20  ientation=-90). 
+00014780: 2020 2044 2e61 6464 5f70 6f72 7428 6e61     D.add_port(na
+00014790: 6d65 3d22 4522 2c20 6d69 6470 6f69 6e74  me="E", midpoint
+000147a0: 3d5b 6478 202f 2032 2c20 305d 2c20 7769  =[dx / 2, 0], wi
+000147b0: 6474 683d 6479 2c20 6f72 6965 6e74 6174  dth=dy, orientat
+000147c0: 696f 6e3d 3029 0a20 2020 2044 2e61 6464  ion=0).    D.add
+000147d0: 5f70 6f72 7428 6e61 6d65 3d22 5722 2c20  _port(name="W", 
+000147e0: 6d69 6470 6f69 6e74 3d5b 2d64 7820 2f20  midpoint=[-dx / 
+000147f0: 322c 2030 5d2c 2077 6964 7468 3d64 792c  2, 0], width=dy,
+00014800: 206f 7269 656e 7461 7469 6f6e 3d31 3830   orientation=180
+00014810: 290a 0a20 2020 2072 6574 7572 6e20 440a  )..    return D.
+00014820: 0a0a 6465 6620 636f 6d70 6173 735f 6d75  ..def compass_mu
+00014830: 6c74 6928 7369 7a65 3d28 342c 2032 292c  lti(size=(4, 2),
+00014840: 2070 6f72 7473 3d7b 224e 223a 2033 2c20   ports={"N": 3, 
+00014850: 2253 223a 2034 7d2c 206c 6179 6572 3d30  "S": 4}, layer=0
+00014860: 293a 0a20 2020 2022 2222 4372 6561 7465  ):.    """Create
+00014870: 7320 6120 7265 6374 616e 6775 6c61 7220  s a rectangular 
+00014880: 636f 6e74 6163 7420 7061 6420 7769 7468  contact pad with
+00014890: 206d 756c 7469 706c 6520 706f 7274 7320   multiple ports 
+000148a0: 616c 6f6e 6720 7468 6520 6564 6765 730a  along the edges.
+000148b0: 2020 2020 7265 6374 616e 676c 6520 286e      rectangle (n
+000148c0: 6f72 7468 2c20 736f 7574 682c 2065 6173  orth, south, eas
+000148d0: 742c 2061 6e64 2077 6573 7429 2e0a 0a20  t, and west)... 
+000148e0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+000148f0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+00014900: 2073 697a 6520 3a20 6172 7261 795f 6c69   size : array_li
+00014910: 6b65 0a20 2020 2020 2020 2044 696d 656e  ke.        Dimen
+00014920: 7369 6f6e 7320 6f66 2074 6865 2072 6563  sions of the rec
+00014930: 7461 6e67 756c 6172 2063 6f6e 7461 6374  tangular contact
+00014940: 2070 6164 2e0a 2020 2020 706f 7274 7320   pad..    ports 
+00014950: 3a20 6469 6374 0a20 2020 2020 2020 204e  : dict.        N
+00014960: 756d 6265 7220 6f66 2070 6f72 7473 206f  umber of ports o
+00014970: 6e20 6561 6368 2065 6467 6520 6f66 2074  n each edge of t
+00014980: 6865 2072 6563 7461 6e67 6c65 2e0a 2020  he rectangle..  
+00014990: 2020 6c61 7965 7220 3a20 696e 742c 2061    layer : int, a
+000149a0: 7272 6179 2d6c 696b 655b 325d 2c20 6f72  rray-like[2], or
+000149b0: 2073 6574 0a20 2020 2020 2020 2053 7065   set.        Spe
+000149c0: 6369 6669 6320 6c61 7965 7228 7329 2074  cific layer(s) t
+000149d0: 6f20 7075 7420 706f 6c79 676f 6e20 6765  o put polygon ge
+000149e0: 6f6d 6574 7279 206f 6e2e 0a0a 2020 2020  ometry on...    
+000149f0: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+00014a00: 2d2d 2d0a 2020 2020 4420 3a20 4465 7669  ---.    D : Devi
+00014a10: 6365 0a20 2020 2020 2020 2041 2044 6576  ce.        A Dev
+00014a20: 6963 6520 636f 6e74 6169 6e69 6e67 2061  ice containing a
+00014a30: 2072 6563 7461 6e67 756c 6172 2063 6f6e   rectangular con
+00014a40: 7461 6374 2070 6164 2077 6974 6820 6d75  tact pad with mu
+00014a50: 6c74 6970 6c65 2070 6f72 7473 2e0a 2020  ltiple ports..  
+00014a60: 2020 2222 220a 2020 2020 4420 3d20 4465    """.    D = De
+00014a70: 7669 6365 286e 616d 653d 2263 6f6d 7061  vice(name="compa
+00014a80: 7373 5f6d 756c 7469 2229 0a20 2020 2072  ss_multi").    r
+00014a90: 203d 2044 2e61 6464 5f72 6566 2872 6563   = D.add_ref(rec
+00014aa0: 7461 6e67 6c65 2873 697a 652c 206c 6179  tangle(size, lay
+00014ab0: 6572 3d6c 6179 6572 2929 0a20 2020 2072  er=layer)).    r
+00014ac0: 2e63 656e 7465 7220 3d20 2830 2c20 3029  .center = (0, 0)
+00014ad0: 0a0a 2020 2020 6478 203d 2073 697a 655b  ..    dx = size[
+00014ae0: 305d 202f 2032 0a20 2020 2064 7920 3d20  0] / 2.    dy = 
+00014af0: 7369 7a65 5b31 5d20 2f20 320a 0a20 2020  size[1] / 2..   
+00014b00: 2069 6620 224e 2220 696e 2070 6f72 7473   if "N" in ports
+00014b10: 3a0a 2020 2020 2020 2020 6e75 6d5f 706f  :.        num_po
+00014b20: 7274 7320 3d20 706f 7274 735b 224e 225d  rts = ports["N"]
+00014b30: 0a20 2020 2020 2020 206d 203d 2064 7820  .        m = dx 
+00014b40: 2d20 6478 202f 206e 756d 5f70 6f72 7473  - dx / num_ports
+00014b50: 0a20 2020 2020 2020 2070 5f6c 6973 7420  .        p_list 
+00014b60: 3d20 6e70 2e6c 696e 7370 6163 6528 2d6d  = np.linspace(-m
+00014b70: 2c20 6d2c 206e 756d 5f70 6f72 7473 290a  , m, num_ports).
+00014b80: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00014b90: 2020 2020 2020 442e 6164 645f 706f 7274        D.add_port
+00014ba0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00014bb0: 2020 6e61 6d65 3d28 224e 2573 2220 2520    name=("N%s" % 
+00014bc0: 286e 202b 2031 2929 2c0a 2020 2020 2020  (n + 1)),.      
+00014bd0: 2020 2020 2020 2020 2020 6d69 6470 6f69            midpoi
+00014be0: 6e74 3d5b 702c 2064 795d 2c0a 2020 2020  nt=[p, dy],.    
+00014bf0: 2020 2020 2020 2020 2020 2020 7769 6474              widt
+00014c00: 683d 6478 202f 206e 756d 5f70 6f72 7473  h=dx / num_ports
+00014c10: 202a 2032 2c0a 2020 2020 2020 2020 2020   * 2,.          
+00014c20: 2020 2020 2020 6f72 6965 6e74 6174 696f        orientatio
+00014c30: 6e3d 3930 2c0a 2020 2020 2020 2020 2020  n=90,.          
+00014c40: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00014c50: 666f 7220 6e2c 2070 2069 6e20 656e 756d  for n, p in enum
+00014c60: 6572 6174 6528 705f 6c69 7374 290a 2020  erate(p_list).  
+00014c70: 2020 2020 2020 5d0a 2020 2020 6966 2022        ].    if "
+00014c80: 5322 2069 6e20 706f 7274 733a 0a20 2020  S" in ports:.   
+00014c90: 2020 2020 206e 756d 5f70 6f72 7473 203d       num_ports =
+00014ca0: 2070 6f72 7473 5b22 5322 5d0a 2020 2020   ports["S"].    
+00014cb0: 2020 2020 6d20 3d20 6478 202d 2064 7820      m = dx - dx 
+00014cc0: 2f20 6e75 6d5f 706f 7274 730a 2020 2020  / num_ports.    
+00014cd0: 2020 2020 705f 6c69 7374 203d 206e 702e      p_list = np.
+00014ce0: 6c69 6e73 7061 6365 282d 6d2c 206d 2c20  linspace(-m, m, 
+00014cf0: 6e75 6d5f 706f 7274 7329 0a20 2020 2020  num_ports).     
+00014d00: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00014d10: 2044 2e61 6464 5f70 6f72 7428 0a20 2020   D.add_port(.   
+00014d20: 2020 2020 2020 2020 2020 2020 206e 616d               nam
+00014d30: 653d 2822 5325 7322 2025 2028 6e20 2b20  e=("S%s" % (n + 
+00014d40: 3129 292c 0a20 2020 2020 2020 2020 2020  1)),.           
+00014d50: 2020 2020 206d 6964 706f 696e 743d 5b70       midpoint=[p
+00014d60: 2c20 2d64 795d 2c0a 2020 2020 2020 2020  , -dy],.        
+00014d70: 2020 2020 2020 2020 7769 6474 683d 6478          width=dx
+00014d80: 202f 206e 756d 5f70 6f72 7473 202a 2032   / num_ports * 2
+00014d90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014da0: 2020 6f72 6965 6e74 6174 696f 6e3d 2d39    orientation=-9
+00014db0: 302c 0a20 2020 2020 2020 2020 2020 2029  0,.            )
+00014dc0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00014dd0: 206e 2c20 7020 696e 2065 6e75 6d65 7261   n, p in enumera
+00014de0: 7465 2870 5f6c 6973 7429 0a20 2020 2020  te(p_list).     
+00014df0: 2020 205d 0a20 2020 2069 6620 2245 2220     ].    if "E" 
+00014e00: 696e 2070 6f72 7473 3a0a 2020 2020 2020  in ports:.      
+00014e10: 2020 6e75 6d5f 706f 7274 7320 3d20 706f    num_ports = po
+00014e20: 7274 735b 2245 225d 0a20 2020 2020 2020  rts["E"].       
+00014e30: 206d 203d 2064 7920 2d20 6479 202f 206e   m = dy - dy / n
+00014e40: 756d 5f70 6f72 7473 0a20 2020 2020 2020  um_ports.       
+00014e50: 2070 5f6c 6973 7420 3d20 6e70 2e6c 696e   p_list = np.lin
+00014e60: 7370 6163 6528 2d6d 2c20 6d2c 206e 756d  space(-m, m, num
+00014e70: 5f70 6f72 7473 290a 2020 2020 2020 2020  _ports).        
+00014e80: 5b0a 2020 2020 2020 2020 2020 2020 442e  [.            D.
+00014e90: 6164 645f 706f 7274 280a 2020 2020 2020  add_port(.      
+00014ea0: 2020 2020 2020 2020 2020 6e61 6d65 3d28            name=(
+00014eb0: 2245 2573 2220 2520 286e 202b 2031 2929  "E%s" % (n + 1))
+00014ec0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014ed0: 2020 6d69 6470 6f69 6e74 3d5b 6478 2c20    midpoint=[dx, 
+00014ee0: 705d 2c0a 2020 2020 2020 2020 2020 2020  p],.            
+00014ef0: 2020 2020 7769 6474 683d 6479 202f 206e      width=dy / n
+00014f00: 756d 5f70 6f72 7473 202a 2032 2c0a 2020  um_ports * 2,.  
+00014f10: 2020 2020 2020 2020 2020 2020 2020 6f72                or
+00014f20: 6965 6e74 6174 696f 6e3d 302c 0a20 2020  ientation=0,.   
+00014f30: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00014f40: 2020 2020 2020 2066 6f72 206e 2c20 7020         for n, p 
+00014f50: 696e 2065 6e75 6d65 7261 7465 2870 5f6c  in enumerate(p_l
+00014f60: 6973 7429 0a20 2020 2020 2020 205d 0a20  ist).        ]. 
+00014f70: 2020 2069 6620 2257 2220 696e 2070 6f72     if "W" in por
+00014f80: 7473 3a0a 2020 2020 2020 2020 6e75 6d5f  ts:.        num_
+00014f90: 706f 7274 7320 3d20 706f 7274 735b 2257  ports = ports["W
+00014fa0: 225d 0a20 2020 2020 2020 206d 203d 2064  "].        m = d
+00014fb0: 7920 2d20 6479 202f 206e 756d 5f70 6f72  y - dy / num_por
+00014fc0: 7473 0a20 2020 2020 2020 2070 5f6c 6973  ts.        p_lis
+00014fd0: 7420 3d20 6e70 2e6c 696e 7370 6163 6528  t = np.linspace(
+00014fe0: 2d6d 2c20 6d2c 206e 756d 5f70 6f72 7473  -m, m, num_ports
+00014ff0: 290a 2020 2020 2020 2020 5b0a 2020 2020  ).        [.    
+00015000: 2020 2020 2020 2020 442e 6164 645f 706f          D.add_po
+00015010: 7274 280a 2020 2020 2020 2020 2020 2020  rt(.            
+00015020: 2020 2020 6e61 6d65 3d28 2257 2573 2220      name=("W%s" 
+00015030: 2520 286e 202b 2031 2929 2c0a 2020 2020  % (n + 1)),.    
+00015040: 2020 2020 2020 2020 2020 2020 6d69 6470              midp
+00015050: 6f69 6e74 3d5b 2d64 782c 2070 5d2c 0a20  oint=[-dx, p],. 
+00015060: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00015070: 6964 7468 3d64 7920 2f20 6e75 6d5f 706f  idth=dy / num_po
+00015080: 7274 7320 2a20 322c 0a20 2020 2020 2020  rts * 2,.       
+00015090: 2020 2020 2020 2020 206f 7269 656e 7461           orienta
+000150a0: 7469 6f6e 3d31 3830 2c0a 2020 2020 2020  tion=180,.      
+000150b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000150c0: 2020 2020 666f 7220 6e2c 2070 2069 6e20      for n, p in 
+000150d0: 656e 756d 6572 6174 6528 705f 6c69 7374  enumerate(p_list
+000150e0: 290a 2020 2020 2020 2020 5d0a 0a20 2020  ).        ]..   
+000150f0: 2072 6574 7572 6e20 440a 0a0a 2320 544f   return D...# TO
+00015100: 444f 3a20 4669 7820 7468 6520 6669 6c6c  DO: Fix the fill
+00015110: 6574 2068 6572 652c 2072 6967 6874 206e  et here, right n
+00015120: 6f77 206f 6e6c 7920 676f 6573 2068 616c  ow only goes hal
+00015130: 6677 6179 2064 6f77 6e0a 6465 6620 666c  fway down.def fl
+00015140: 6167 706f 6c65 2873 697a 653d 2834 2c20  agpole(size=(4, 
+00015150: 3229 2c20 7374 7562 5f73 697a 653d 2832  2), stub_size=(2
+00015160: 2c20 3129 2c20 7368 6170 653d 2270 222c  , 1), shape="p",
+00015170: 2074 6170 6572 5f74 7970 653d 2273 7472   taper_type="str
+00015180: 6169 6768 7422 2c20 6c61 7965 723d 3029  aight", layer=0)
+00015190: 3a0a 2020 2020 2222 2243 7265 6174 6573  :.    """Creates
+000151a0: 2061 2066 6c61 6770 6f6c 6520 6765 6f6d   a flagpole geom
+000151b0: 6574 7279 206f 6620 6f6e 6520 6f66 2066  etry of one of f
+000151c0: 6f75 7220 636f 6e66 6967 7572 6174 696f  our configuratio
+000151d0: 6e73 2c20 616c 6c0a 2020 2020 696e 766f  ns, all.    invo
+000151e0: 6c76 696e 6720 6120 7665 7274 6963 616c  lving a vertical
+000151f0: 2063 656e 7472 616c 2063 6f6c 756d 6e20   central column 
+00015200: 616e 6420 6120 6f75 7477 6172 642d 706f  and a outward-po
+00015210: 696e 7469 6e67 2066 6c61 672e 0a0a 2020  inting flag...  
+00015220: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00015230: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00015240: 7369 7a65 203a 2061 7272 6179 2d6c 696b  size : array-lik
+00015250: 650a 2020 2020 2020 2020 2877 6964 7468  e.        (width
+00015260: 2c20 6865 6967 6874 2920 6f66 2074 6865  , height) of the
+00015270: 2066 6c61 672e 0a20 2020 2073 7475 625f   flag..    stub_
+00015280: 7369 7a65 203a 2061 7272 6179 2d6c 696b  size : array-lik
+00015290: 650a 2020 2020 2020 2020 2877 6964 7468  e.        (width
+000152a0: 2c20 6865 6967 6874 2920 6f66 2074 6865  , height) of the
+000152b0: 2070 6f6c 6520 7374 7562 2e0a 2020 2020   pole stub..    
+000152c0: 7368 6170 6520 3a20 7b27 7027 2c20 2771  shape : {'p', 'q
+000152d0: 272c 2027 6227 2c20 2764 277d 0a20 2020  ', 'b', 'd'}.   
+000152e0: 2020 2020 2043 6f6e 6669 6775 7261 7469       Configurati
+000152f0: 6f6e 206f 6620 7468 6520 666c 6167 706f  on of the flagpo
+00015300: 6c65 2c20 7768 6572 6520 7468 6520 6375  le, where the cu
+00015310: 7276 6564 2070 6f72 7469 6f6e 206f 6620  rved portion of 
+00015320: 7468 650a 2020 2020 2020 2020 6c65 7474  the.        lett
+00015330: 6572 7320 7265 7072 6573 656e 7473 2074  ers represents t
+00015340: 6865 2066 6c61 6720 616e 6420 7468 6520  he flag and the 
+00015350: 7374 7261 6967 6874 2070 6f72 7469 6f6e  straight portion
+00015360: 2074 6865 2070 6f6c 652e 0a20 2020 2074   the pole..    t
+00015370: 6170 6572 5f74 7970 6520 3a20 7b27 7374  aper_type : {'st
+00015380: 7261 6967 6874 272c 2027 6669 6c6c 6574  raight', 'fillet
+00015390: 272c 204e 6f6e 657d 0a20 2020 2020 2020  ', None}.       
+000153a0: 2054 7970 6520 6f66 2074 6170 6572 2062   Type of taper b
+000153b0: 6574 7765 656e 2074 6865 2062 6f74 746f  etween the botto
+000153c0: 6d20 636f 726e 6572 206f 6620 7468 6520  m corner of the 
+000153d0: 7374 7562 206f 6e20 7468 6520 7369 6465  stub on the side
+000153e0: 206f 660a 2020 2020 2020 2020 7468 6520   of.        the 
+000153f0: 666c 6167 2061 6e64 2074 6865 2063 6f72  flag and the cor
+00015400: 6e65 7220 6f66 2074 6865 2066 6c61 6720  ner of the flag 
+00015410: 636c 6f73 6573 7420 746f 2074 6865 2073  closest to the s
+00015420: 7475 622e 0a20 2020 206c 6179 6572 203a  tub..    layer :
+00015430: 2069 6e74 2c20 6172 7261 792d 6c69 6b65   int, array-like
+00015440: 5b32 5d2c 206f 7220 7365 740a 2020 2020  [2], or set.    
+00015450: 2020 2020 5370 6563 6966 6963 206c 6179      Specific lay
+00015460: 6572 2873 2920 746f 2070 7574 2070 6f6c  er(s) to put pol
+00015470: 7967 6f6e 2067 656f 6d65 7472 7920 6f6e  ygon geometry on
+00015480: 2e0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
+00015490: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2044     -------.    D
+000154a0: 203a 2044 6576 6963 650a 2020 2020 2020   : Device.      
+000154b0: 2020 4120 4465 7669 6365 2063 6f6e 7461    A Device conta
+000154c0: 696e 696e 6720 6120 666c 6167 706f 6c65  ining a flagpole
+000154d0: 2067 656f 6d65 7472 792e 0a20 2020 2022   geometry..    "
+000154e0: 2222 0a20 2020 2066 203d 206e 702e 6172  "".    f = np.ar
+000154f0: 7261 7928 7369 7a65 290a 2020 2020 7020  ray(size).    p 
+00015500: 3d20 6e70 2e61 7272 6179 2873 7475 625f  = np.array(stub_
+00015510: 7369 7a65 290a 2020 2020 7368 6170 6520  size).    shape 
+00015520: 3d20 7368 6170 652e 6c6f 7765 7228 290a  = shape.lower().
+00015530: 0a20 2020 2061 7373 6572 7420 7368 6170  .    assert shap
+00015540: 6520 696e 2022 7071 6264 222c 2022 5b44  e in "pqbd", "[D
+00015550: 4556 4943 455d 2020 666c 6167 706f 6c65  EVICE]  flagpole
+00015560: 2829 2073 6861 7065 206d 7573 7420 6265  () shape must be
+00015570: 2070 2c20 712c 2062 2c20 6f72 2064 220a   p, q, b, or d".
+00015580: 2020 2020 6173 7365 7274 2074 6170 6572      assert taper
+00015590: 5f74 7970 6520 696e 205b 2273 7472 6169  _type in ["strai
+000155a0: 6768 7422 2c20 2266 696c 6c65 7422 2c20  ght", "fillet", 
+000155b0: 4e6f 6e65 5d2c 2028 0a20 2020 2020 2020  None], (.       
+000155c0: 2027 5b44 4556 4943 455d 2020 666c 6167   '[DEVICE]  flag
+000155d0: 706f 6c65 2829 2074 6170 6572 5f74 7970  pole() taper_typ
+000155e0: 6520 6d75 7374 2022 7374 7261 6967 6874  e must "straight
+000155f0: 2220 2720 2720 6f72 2022 6669 6c6c 6574  " ' ' or "fillet
+00015600: 2220 6f72 204e 6f6e 6527 0a20 2020 2029  " or None'.    )
+00015610: 0a0a 2020 2020 6966 2073 6861 7065 203d  ..    if shape =
+00015620: 3d20 2270 223a 0a20 2020 2020 2020 206f  = "p":.        o
+00015630: 7269 656e 7461 7469 6f6e 203d 202d 3930  rientation = -90
+00015640: 0a20 2020 2065 6c69 6620 7368 6170 6520  .    elif shape 
+00015650: 3d3d 2022 7122 3a0a 2020 2020 2020 2020  == "q":.        
+00015660: 665b 305d 2c20 705b 305d 203d 202d 7369  f[0], p[0] = -si
+00015670: 7a65 5b30 5d2c 202d 7374 7562 5f73 697a  ze[0], -stub_siz
+00015680: 655b 305d 0a20 2020 2020 2020 206f 7269  e[0].        ori
+00015690: 656e 7461 7469 6f6e 203d 202d 3930 0a20  entation = -90. 
+000156a0: 2020 2065 6c69 6620 7368 6170 6520 3d3d     elif shape ==
+000156b0: 2022 6222 3a0a 2020 2020 2020 2020 665b   "b":.        f[
+000156c0: 315d 2c20 705b 315d 203d 202d 7369 7a65  1], p[1] = -size
+000156d0: 5b31 5d2c 202d 7374 7562 5f73 697a 655b  [1], -stub_size[
+000156e0: 315d 0a20 2020 2020 2020 206f 7269 656e  1].        orien
+000156f0: 7461 7469 6f6e 203d 2039 300a 2020 2020  tation = 90.    
+00015700: 656c 6966 2073 6861 7065 203d 3d20 2264  elif shape == "d
+00015710: 223a 0a20 2020 2020 2020 2066 5b31 5d2c  ":.        f[1],
+00015720: 2070 5b31 5d20 3d20 2d73 697a 655b 315d   p[1] = -size[1]
+00015730: 2c20 2d73 7475 625f 7369 7a65 5b31 5d0a  , -stub_size[1].
+00015740: 2020 2020 2020 2020 665b 305d 2c20 705b          f[0], p[
+00015750: 305d 203d 202d 7369 7a65 5b30 5d2c 202d  0] = -size[0], -
+00015760: 7374 7562 5f73 697a 655b 305d 0a20 2020  stub_size[0].   
+00015770: 2020 2020 206f 7269 656e 7461 7469 6f6e       orientation
+00015780: 203d 2039 300a 2020 2020 7870 7473 203d   = 90.    xpts =
+00015790: 205b 302c 2030 2c20 665b 305d 2c20 665b   [0, 0, f[0], f[
+000157a0: 305d 2c20 705b 305d 2c20 705b 305d 2c20  0], p[0], p[0], 
+000157b0: 305d 0a20 2020 2079 7074 7320 3d20 5b30  0].    ypts = [0
+000157c0: 2c20 665b 315d 2c20 665b 315d 2c20 302c  , f[1], f[1], 0,
+000157d0: 2030 2c20 2d70 5b31 5d2c 202d 705b 315d   0, -p[1], -p[1]
+000157e0: 5d0a 0a20 2020 2044 203d 2044 6576 6963  ]..    D = Devic
+000157f0: 6528 6e61 6d65 3d22 666c 6167 706f 6c65  e(name="flagpole
+00015800: 2229 0a20 2020 2070 6164 5f70 6f6c 7920  ").    pad_poly 
+00015810: 3d20 442e 6164 645f 706f 6c79 676f 6e28  = D.add_polygon(
+00015820: 5b78 7074 732c 2079 7074 735d 2c20 6c61  [xpts, ypts], la
+00015830: 7965 723d 6c61 7965 7229 0a20 2020 2069  yer=layer).    i
+00015840: 6620 7461 7065 725f 7479 7065 203d 3d20  f taper_type == 
+00015850: 2266 696c 6c65 7422 3a0a 2020 2020 2020  "fillet":.      
+00015860: 2020 7461 7065 725f 616d 6f75 6e74 203d    taper_amount =
+00015870: 206d 696e 285b 6162 7328 665b 305d 202d   min([abs(f[0] -
+00015880: 2070 5b30 5d29 2c20 6162 7328 705b 315d   p[0]), abs(p[1]
+00015890: 295d 290a 2020 2020 2020 2020 7061 645f  )]).        pad_
+000158a0: 706f 6c79 2e66 696c 6c65 7428 5b30 2c20  poly.fillet([0, 
+000158b0: 302c 2030 2c20 302c 2074 6170 6572 5f61  0, 0, 0, taper_a
+000158c0: 6d6f 756e 742c 2030 2c20 305d 290a 2020  mount, 0, 0]).  
+000158d0: 2020 656c 6966 2074 6170 6572 5f74 7970    elif taper_typ
+000158e0: 6520 3d3d 2022 7374 7261 6967 6874 223a  e == "straight":
+000158f0: 0a20 2020 2020 2020 2044 2e61 6464 5f70  .        D.add_p
+00015900: 6f6c 7967 6f6e 285b 7870 7473 5b33 3a36  olygon([xpts[3:6
+00015910: 5d2c 2079 7074 735b 333a 365d 5d2c 206c  ], ypts[3:6]], l
+00015920: 6179 6572 3d6c 6179 6572 290a 0a20 2020  ayer=layer)..   
+00015930: 2044 2e61 6464 5f70 6f72 7428 0a20 2020   D.add_port(.   
+00015940: 2020 2020 206e 616d 653d 312c 206d 6964       name=1, mid
+00015950: 706f 696e 743d 5b70 5b30 5d20 2f20 322c  point=[p[0] / 2,
+00015960: 202d 705b 315d 5d2c 2077 6964 7468 3d61   -p[1]], width=a
+00015970: 6273 2870 5b30 5d29 2c20 6f72 6965 6e74  bs(p[0]), orient
+00015980: 6174 696f 6e3d 6f72 6965 6e74 6174 696f  ation=orientatio
+00015990: 6e0a 2020 2020 290a 2020 2020 442e 6164  n.    ).    D.ad
+000159a0: 645f 706f 7274 280a 2020 2020 2020 2020  d_port(.        
+000159b0: 6e61 6d65 3d32 2c0a 2020 2020 2020 2020  name=2,.        
+000159c0: 6d69 6470 6f69 6e74 3d5b 665b 305d 202f  midpoint=[f[0] /
+000159d0: 2032 2c20 665b 315d 5d2c 0a20 2020 2020   2, f[1]],.     
+000159e0: 2020 2077 6964 7468 3d61 6273 2866 5b30     width=abs(f[0
+000159f0: 5d29 2c0a 2020 2020 2020 2020 6f72 6965  ]),.        orie
+00015a00: 6e74 6174 696f 6e3d 6f72 6965 6e74 6174  ntation=orientat
+00015a10: 696f 6e20 2d20 3138 302c 0a20 2020 2029  ion - 180,.    )
+00015a20: 0a20 2020 2072 6574 7572 6e20 440a 0a0a  .    return D...
+00015a30: 6465 6620 7465 6528 7369 7a65 3d28 342c  def tee(size=(4,
+00015a40: 2032 292c 2073 7475 625f 7369 7a65 3d28   2), stub_size=(
+00015a50: 322c 2031 292c 2074 6170 6572 5f74 7970  2, 1), taper_typ
+00015a60: 653d 4e6f 6e65 2c20 6c61 7965 723d 3029  e=None, layer=0)
+00015a70: 3a0a 2020 2020 2222 2243 7265 6174 6573  :.    """Creates
+00015a80: 2061 2054 2d73 6861 7065 6420 6765 6f6d   a T-shaped geom
+00015a90: 6574 7279 2e0a 0a20 2020 2050 6172 616d  etry...    Param
+00015aa0: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
+00015ab0: 2d2d 2d2d 0a20 2020 2073 697a 6520 3a20  ----.    size : 
+00015ac0: 6172 7261 792d 6c69 6b65 0a20 2020 2020  array-like.     
+00015ad0: 2020 2028 7769 6474 682c 2068 6569 6768     (width, heigh
+00015ae0: 7429 206f 6620 7468 6520 686f 7269 7a6f  t) of the horizo
+00015af0: 6e74 616c 2074 6f70 2070 6172 7420 6f66  ntal top part of
+00015b00: 2074 6865 2054 2073 6861 7065 2e0a 2020   the T shape..  
+00015b10: 2020 7374 7562 5f73 697a 6520 3a20 6172    stub_size : ar
+00015b20: 7261 792d 6c69 6b65 0a20 2020 2020 2020  ray-like.       
+00015b30: 2028 7769 6474 682c 2068 6569 6768 7429   (width, height)
+00015b40: 206f 6620 7468 6520 7665 7274 6963 616c   of the vertical
+00015b50: 2073 7475 6220 7061 7274 206f 6620 7468   stub part of th
+00015b60: 6520 5420 7368 6170 652e 0a20 2020 2074  e T shape..    t
+00015b70: 6170 6572 5f74 7970 6520 3a20 7b27 7374  aper_type : {'st
+00015b80: 7261 6967 6874 272c 2027 6669 6c6c 6574  raight', 'fillet
+00015b90: 272c 204e 6f6e 657d 0a20 2020 2020 2020  ', None}.       
+00015ba0: 2049 6620 7370 6563 6966 6965 642c 2074   If specified, t
+00015bb0: 6865 2074 7970 6520 6f66 2074 6170 6572  he type of taper
+00015bc0: 2062 6574 7765 656e 2074 6865 2062 6f74   between the bot
+00015bd0: 746f 6d20 636f 726e 6572 7320 6f66 2074  tom corners of t
+00015be0: 6865 2073 7475 620a 2020 2020 2020 2020  he stub.        
+00015bf0: 616e 6420 7468 6520 626f 7474 6f6d 2063  and the bottom c
+00015c00: 6f72 6e65 7273 206f 6620 7468 6520 5420  orners of the T 
+00015c10: 7368 6170 652e 0a20 2020 206c 6179 6572  shape..    layer
+00015c20: 203a 2069 6e74 2c20 6172 7261 792d 6c69   : int, array-li
+00015c30: 6b65 5b32 5d2c 206f 7220 7365 740a 2020  ke[2], or set.  
+00015c40: 2020 2020 2020 5370 6563 6966 6963 206c        Specific l
+00015c50: 6179 6572 2873 2920 746f 2070 7574 2070  ayer(s) to put p
+00015c60: 6f6c 7967 6f6e 2067 656f 6d65 7472 7920  olygon geometry 
+00015c70: 6f6e 2e0a 0a20 2020 2052 6574 7572 6e73  on...    Returns
+00015c80: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+00015c90: 2044 203a 2044 6576 6963 650a 2020 2020   D : Device.    
+00015ca0: 2020 2020 4120 4465 7669 6365 2063 6f6e      A Device con
+00015cb0: 7461 696e 696e 6720 6120 542d 7368 6170  taining a T-shap
+00015cc0: 6564 2067 656f 6d65 7472 792e 0a20 2020  ed geometry..   
+00015cd0: 2022 2222 0a20 2020 2066 203d 206e 702e   """.    f = np.
+00015ce0: 6172 7261 7928 7369 7a65 290a 2020 2020  array(size).    
+00015cf0: 7020 3d20 6e70 2e61 7272 6179 2873 7475  p = np.array(stu
+00015d00: 625f 7369 7a65 290a 0a20 2020 2078 7074  b_size)..    xpt
+00015d10: 7320 3d20 6e70 2e61 7272 6179 285b 665b  s = np.array([f[
+00015d20: 305d 2c20 665b 305d 2c20 705b 305d 2c20  0], f[0], p[0], 
+00015d30: 705b 305d 2c20 2d70 5b30 5d2c 202d 705b  p[0], -p[0], -p[
+00015d40: 305d 2c20 2d66 5b30 5d2c 202d 665b 305d  0], -f[0], -f[0]
+00015d50: 5d29 202f 2032 0a20 2020 2079 7074 7320  ]) / 2.    ypts 
+00015d60: 3d20 5b66 5b31 5d2c 2030 2c20 302c 202d  = [f[1], 0, 0, -
+00015d70: 705b 315d 2c20 2d70 5b31 5d2c 2030 2c20  p[1], -p[1], 0, 
+00015d80: 302c 2066 5b31 5d5d 0a0a 2020 2020 4420  0, f[1]]..    D 
+00015d90: 3d20 4465 7669 6365 286e 616d 653d 2274  = Device(name="t
+00015da0: 6565 2229 0a20 2020 2070 6164 5f70 6f6c  ee").    pad_pol
+00015db0: 7920 3d20 442e 6164 645f 706f 6c79 676f  y = D.add_polygo
+00015dc0: 6e28 5b78 7074 732c 2079 7074 735d 2c20  n([xpts, ypts], 
+00015dd0: 6c61 7965 723d 6c61 7965 7229 0a20 2020  layer=layer).   
+00015de0: 2069 6620 7461 7065 725f 7479 7065 203d   if taper_type =
+00015df0: 3d20 2266 696c 6c65 7422 3a0a 2020 2020  = "fillet":.    
+00015e00: 2020 2020 7461 7065 725f 616d 6f75 6e74      taper_amount
+00015e10: 203d 206d 696e 285b 6162 7328 665b 305d   = min([abs(f[0]
+00015e20: 202d 2070 5b30 5d29 2c20 6162 7328 705b   - p[0]), abs(p[
+00015e30: 315d 295d 290a 2020 2020 2020 2020 7061  1])]).        pa
+00015e40: 645f 706f 6c79 2e66 696c 6c65 7428 5b30  d_poly.fillet([0
+00015e50: 2c20 302c 2074 6170 6572 5f61 6d6f 756e  , 0, taper_amoun
+00015e60: 742c 2030 2c20 302c 2074 6170 6572 5f61  t, 0, 0, taper_a
+00015e70: 6d6f 756e 742c 2030 2c20 305d 290a 2020  mount, 0, 0]).  
+00015e80: 2020 656c 6966 2074 6170 6572 5f74 7970    elif taper_typ
+00015e90: 6520 3d3d 2022 7374 7261 6967 6874 223a  e == "straight":
+00015ea0: 0a20 2020 2020 2020 2044 2e61 6464 5f70  .        D.add_p
+00015eb0: 6f6c 7967 6f6e 285b 7870 7473 5b31 3a34  olygon([xpts[1:4
+00015ec0: 5d2c 2079 7074 735b 313a 345d 5d2c 206c  ], ypts[1:4]], l
+00015ed0: 6179 6572 3d6c 6179 6572 2920 2023 2074  ayer=layer)  # t
+00015ee0: 6170 6572 5f70 6f6c 7931 0a20 2020 2020  aper_poly1.     
+00015ef0: 2020 2044 2e61 6464 5f70 6f6c 7967 6f6e     D.add_polygon
+00015f00: 285b 7870 7473 5b34 3a37 5d2c 2079 7074  ([xpts[4:7], ypt
+00015f10: 735b 343a 375d 5d2c 206c 6179 6572 3d6c  s[4:7]], layer=l
+00015f20: 6179 6572 2920 2023 2074 6170 6572 5f70  ayer)  # taper_p
+00015f30: 6f6c 7932 0a0a 2020 2020 442e 6164 645f  oly2..    D.add_
+00015f40: 706f 7274 286e 616d 653d 312c 206d 6964  port(name=1, mid
+00015f50: 706f 696e 743d 5b66 5b30 5d20 2f20 322c  point=[f[0] / 2,
+00015f60: 2066 5b31 5d20 2f20 325d 2c20 7769 6474   f[1] / 2], widt
+00015f70: 683d 665b 315d 2c20 6f72 6965 6e74 6174  h=f[1], orientat
+00015f80: 696f 6e3d 3029 0a20 2020 2044 2e61 6464  ion=0).    D.add
+00015f90: 5f70 6f72 7428 6e61 6d65 3d32 2c20 6d69  _port(name=2, mi
+00015fa0: 6470 6f69 6e74 3d5b 2d66 5b30 5d20 2f20  dpoint=[-f[0] / 
+00015fb0: 322c 2066 5b31 5d20 2f20 325d 2c20 7769  2, f[1] / 2], wi
+00015fc0: 6474 683d 665b 315d 2c20 6f72 6965 6e74  dth=f[1], orient
+00015fd0: 6174 696f 6e3d 3138 3029 0a20 2020 2044  ation=180).    D
+00015fe0: 2e61 6464 5f70 6f72 7428 6e61 6d65 3d33  .add_port(name=3
+00015ff0: 2c20 6d69 6470 6f69 6e74 3d5b 302c 202d  , midpoint=[0, -
+00016000: 705b 315d 5d2c 2077 6964 7468 3d70 5b30  p[1]], width=p[0
+00016010: 5d2c 206f 7269 656e 7461 7469 6f6e 3d2d  ], orientation=-
+00016020: 3930 290a 2020 2020 7265 7475 726e 2044  90).    return D
+00016030: 0a0a 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d  ...# ===========
+00016040: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00016050: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00016060: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00016070: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00016080: 3d3d 3d0a 2320 4578 616d 706c 6520 636f  ===.# Example co
+00016090: 6465 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d  de.# ===========
+000160a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000160b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000160c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000160d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000160e0: 3d3d 3d0a 0a23 2063 7020 3d20 636f 6d70  ===..# cp = comp
+000160f0: 6173 7328 7369 7a65 203d 205b 342c 325d  ass(size = [4,2]
+00016100: 290a 2320 7175 6963 6b70 6c6f 7428 6370  ).# quickplot(cp
+00016110: 290a 0a0a 2320 6370 6d20 3d20 636f 6d70  )...# cpm = comp
+00016120: 6173 735f 6d75 6c74 6928 7369 7a65 203d  ass_multi(size =
+00016130: 205b 3430 2c32 305d 2c20 706f 7274 7320   [40,20], ports 
+00016140: 3d20 7b27 4e27 3a33 2c27 5327 3a34 2c20  = {'N':3,'S':4, 
+00016150: 2745 273a 312c 2027 5727 3a38 7d2c 206c  'E':1, 'W':8}, l
+00016160: 6179 6572 203d 2030 290a 2320 7175 6963  ayer = 0).# quic
+00016170: 6b70 6c6f 7428 6370 6d29 0a0a 0a23 2063  kplot(cpm)...# c
+00016180: 706d 203d 2063 6f6d 7061 7373 5f6d 756c  pm = compass_mul
+00016190: 7469 2873 697a 6520 3d20 5b34 302c 3230  ti(size = [40,20
+000161a0: 5d2c 2070 6f72 7473 203d 207b 274e 273a  ], ports = {'N':
+000161b0: 332c 2753 273a 342c 2027 4527 3a31 2c20  3,'S':4, 'E':1, 
+000161c0: 2757 273a 387d 2c20 6c61 7965 7220 3d20  'W':8}, layer = 
+000161d0: 3029 0a23 2069 6e73 6574 5f70 6f6c 7967  0).# inset_polyg
+000161e0: 6f6e 203d 206f 6666 7365 7428 6370 6d2c  on = offset(cpm,
+000161f0: 2064 6973 7461 6e63 6520 3d20 2d32 2c20   distance = -2, 
+00016200: 6c61 7965 7220 3d20 3129 0a23 2063 706d  layer = 1).# cpm
+00016210: 2e61 6464 5f70 6f6c 7967 6f6e 2869 6e73  .add_polygon(ins
+00016220: 6574 5f70 6f6c 7967 6f6e 290a 2320 7175  et_polygon).# qu
+00016230: 6963 6b70 6c6f 7428 6370 6d29 0a0a 2320  ickplot(cpm)..# 
+00016240: 6670 203d 2066 6c61 6770 6f6c 6528 7369  fp = flagpole(si
+00016250: 7a65 203d 205b 342c 325d 2c20 7374 7562  ze = [4,2], stub
+00016260: 5f73 697a 6520 3d20 5b32 2c31 5d2c 2073  _size = [2,1], s
+00016270: 6861 7065 203d 2027 7027 2c20 7461 7065  hape = 'p', tape
+00016280: 725f 7479 7065 203d 2027 7374 7261 6967  r_type = 'straig
+00016290: 6874 272c 206c 6179 6572 203d 2030 290a  ht', layer = 0).
+000162a0: 2320 7175 6963 6b70 6c6f 7428 6670 290a  # quickplot(fp).
+000162b0: 0a0a 2320 7470 203d 2074 6565 2873 697a  ..# tp = tee(siz
+000162c0: 6520 3d20 5b34 2c32 5d2c 2073 7475 625f  e = [4,2], stub_
+000162d0: 7369 7a65 203d 205b 322c 315d 2c20 7461  size = [2,1], ta
+000162e0: 7065 725f 7479 7065 203d 2027 6669 6c6c  per_type = 'fill
+000162f0: 6574 272c 206c 6179 6572 203d 2030 290a  et', layer = 0).
+00016300: 2320 7175 6963 6b70 6c6f 7428 7470 290a  # quickplot(tp).
+00016310: 0a0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ..# ============
+00016320: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00016330: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00016340: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00016350: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00016360: 3d3d 0a23 0a23 2054 6170 6572 730a 230a  ==.#.# Tapers.#.
+00016370: 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  # ==============
+00016380: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00016390: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000163a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000163b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000163c0: 0a0a 0a64 6566 2074 6170 6572 286c 656e  ...def taper(len
+000163d0: 6774 683d 3130 2c20 7769 6474 6831 3d35  gth=10, width1=5
+000163e0: 2c20 7769 6474 6832 3d4e 6f6e 652c 2070  , width2=None, p
+000163f0: 6f72 743d 4e6f 6e65 2c20 6c61 7965 723d  ort=None, layer=
+00016400: 3029 3a0a 2020 2020 2222 2243 7265 6174  0):.    """Creat
+00016410: 6573 2061 2074 6170 6572 6564 2074 7261  es a tapered tra
+00016420: 7065 7a6f 6964 2f72 6563 7461 6e67 6c65  pezoid/rectangle
+00016430: 2067 656f 6d65 7472 792e 0a0a 2020 2020   geometry...    
+00016440: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+00016450: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6c65  ---------.    le
+00016460: 6e67 7468 203a 2069 6e74 206f 7220 666c  ngth : int or fl
+00016470: 6f61 740a 2020 2020 2020 2020 4c65 6e67  oat.        Leng
+00016480: 7468 206f 6620 7468 6520 7368 6170 652e  th of the shape.
+00016490: 0a20 2020 2077 6964 7468 3120 3a20 696e  .    width1 : in
+000164a0: 742c 2066 6c6f 6174 2c20 6f72 204e 6f6e  t, float, or Non
+000164b0: 650a 2020 2020 2020 2020 5769 6474 6820  e.        Width 
+000164c0: 6f66 2065 6e64 2031 206f 6620 7468 6520  of end 1 of the 
+000164d0: 7461 7065 7220 7365 6374 696f 6e20 2877  taper section (w
+000164e0: 6964 7468 2069 7320 6571 7561 6c20 746f  idth is equal to
+000164f0: 2074 6865 2070 6f72 7420 7769 6474 680a   the port width.
+00016500: 2020 2020 2020 2020 6966 2050 6f72 7420          if Port 
+00016510: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+00016520: 7769 6474 6831 2069 7320 4e6f 6e65 292e  width1 is None).
+00016530: 0a20 2020 2077 6964 7468 3220 3a20 696e  .    width2 : in
+00016540: 742c 2066 6c6f 6174 2c20 6f72 204e 6f6e  t, float, or Non
+00016550: 650a 2020 2020 2020 2020 5769 6474 6820  e.        Width 
+00016560: 6f66 2065 6e64 2032 206f 6620 7468 6520  of end 2 of the 
+00016570: 7461 7065 7220 7365 6374 696f 6e20 2877  taper section (w
+00016580: 6964 7468 2069 7320 6571 7561 6c20 746f  idth is equal to
+00016590: 2074 6865 2070 6f72 7420 7769 6474 680a   the port width.
+000165a0: 2020 2020 2020 2020 6966 2050 6f72 7420          if Port 
+000165b0: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+000165c0: 7769 6474 6832 2069 7320 4e6f 6e65 292e  width2 is None).
+000165d0: 0a20 2020 2070 6f72 7420 3a20 506f 7274  .    port : Port
+000165e0: 206f 7220 4e6f 6e65 0a20 2020 2020 2020   or None.       
+000165f0: 2050 6f72 7420 7769 7468 2077 6869 6368   Port with which
+00016600: 2074 6f20 6d61 7463 6820 7468 6520 7769   to match the wi
+00016610: 6474 6820 6f66 2074 6865 2074 6170 6572  dth of the taper
+00016620: 2065 6e64 732e 0a20 2020 206c 6179 6572   ends..    layer
+00016630: 203a 2069 6e74 2c20 6172 7261 792d 6c69   : int, array-li
+00016640: 6b65 5b32 5d2c 206f 7220 7365 740a 2020  ke[2], or set.  
+00016650: 2020 2020 2020 5370 6563 6966 6963 206c        Specific l
+00016660: 6179 6572 2873 2920 746f 2070 7574 2070  ayer(s) to put p
+00016670: 6f6c 7967 6f6e 2067 656f 6d65 7472 7920  olygon geometry 
+00016680: 6f6e 2e0a 0a20 2020 2052 6574 7572 6e73  on...    Returns
+00016690: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+000166a0: 2044 3a20 4465 7669 6365 0a20 2020 2020   D: Device.     
+000166b0: 2020 2041 2044 6576 6963 6520 636f 6e74     A Device cont
+000166c0: 6169 6e69 6e67 2061 2074 6170 6572 2067  aining a taper g
+000166d0: 656f 6d65 7472 792e 0a20 2020 2022 2222  eometry..    """
+000166e0: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
+000166f0: 6365 2870 6f72 742c 2050 6f72 7429 2061  ce(port, Port) a
+00016700: 6e64 2077 6964 7468 3120 6973 204e 6f6e  nd width1 is Non
+00016710: 653a 0a20 2020 2020 2020 2077 6964 7468  e:.        width
+00016720: 3120 3d20 706f 7274 2e77 6964 7468 0a20  1 = port.width. 
+00016730: 2020 2069 6620 7769 6474 6832 2069 7320     if width2 is 
+00016740: 4e6f 6e65 3a0a 2020 2020 2020 2020 7769  None:.        wi
+00016750: 6474 6832 203d 2077 6964 7468 310a 2020  dth2 = width1.  
+00016760: 2020 7870 7473 203d 205b 302c 206c 656e    xpts = [0, len
+00016770: 6774 682c 206c 656e 6774 682c 2030 5d0a  gth, length, 0].
+00016780: 2020 2020 7970 7473 203d 205b 7769 6474      ypts = [widt
+00016790: 6831 202f 2032 2c20 7769 6474 6832 202f  h1 / 2, width2 /
+000167a0: 2032 2c20 2d77 6964 7468 3220 2f20 322c   2, -width2 / 2,
+000167b0: 202d 7769 6474 6831 202f 2032 5d0a 0a20   -width1 / 2].. 
+000167c0: 2020 2044 203d 2044 6576 6963 6528 2274     D = Device("t
+000167d0: 6170 6572 2229 0a20 2020 2044 2e61 6464  aper").    D.add
+000167e0: 5f70 6f6c 7967 6f6e 285b 7870 7473 2c20  _polygon([xpts, 
+000167f0: 7970 7473 5d2c 206c 6179 6572 3d6c 6179  ypts], layer=lay
+00016800: 6572 290a 2020 2020 442e 6164 645f 706f  er).    D.add_po
+00016810: 7274 286e 616d 653d 312c 206d 6964 706f  rt(name=1, midpo
+00016820: 696e 743d 5b30 2c20 305d 2c20 7769 6474  int=[0, 0], widt
+00016830: 683d 7769 6474 6831 2c20 6f72 6965 6e74  h=width1, orient
+00016840: 6174 696f 6e3d 3138 3029 0a20 2020 2044  ation=180).    D
+00016850: 2e61 6464 5f70 6f72 7428 6e61 6d65 3d32  .add_port(name=2
+00016860: 2c20 6d69 6470 6f69 6e74 3d5b 6c65 6e67  , midpoint=[leng
+00016870: 7468 2c20 305d 2c20 7769 6474 683d 7769  th, 0], width=wi
+00016880: 6474 6832 2c20 6f72 6965 6e74 6174 696f  dth2, orientatio
+00016890: 6e3d 3029 0a20 2020 2069 6620 6973 696e  n=0).    if isin
+000168a0: 7374 616e 6365 2870 6f72 742c 2050 6f72  stance(port, Por
+000168b0: 7429 3a0a 2020 2020 2020 2020 442e 726f  t):.        D.ro
+000168c0: 7461 7465 2861 6e67 6c65 3d70 6f72 742e  tate(angle=port.
+000168d0: 6f72 6965 6e74 6174 696f 6e2c 2063 656e  orientation, cen
+000168e0: 7465 723d 5b30 2c20 305d 290a 2020 2020  ter=[0, 0]).    
+000168f0: 2020 2020 442e 6d6f 7665 286f 7269 6769      D.move(origi
+00016900: 6e3d 5b30 2c20 305d 2c20 6465 7374 696e  n=[0, 0], destin
+00016910: 6174 696f 6e3d 706f 7274 2e6d 6964 706f  ation=port.midpo
+00016920: 696e 7429 0a20 2020 2072 6574 7572 6e20  int).    return 
+00016930: 440a 0a0a 6465 6620 7261 6d70 286c 656e  D...def ramp(len
+00016940: 6774 683d 3130 2c20 7769 6474 6831 3d35  gth=10, width1=5
+00016950: 2c20 7769 6474 6832 3d38 2c20 6c61 7965  , width2=8, laye
+00016960: 723d 3029 3a0a 2020 2020 2222 2243 7265  r=0):.    """Cre
+00016970: 6174 6573 2061 2072 616d 7020 6765 6f6d  ates a ramp geom
+00016980: 6574 7279 2e0a 0a20 2020 2050 6172 616d  etry...    Param
+00016990: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
+000169a0: 2d2d 2d2d 0a20 2020 206c 656e 6774 6820  ----.    length 
+000169b0: 3a20 696e 7420 6f72 2066 6c6f 6174 0a20  : int or float. 
+000169c0: 2020 2020 2020 204c 656e 6774 6820 6f66         Length of
+000169d0: 2074 6865 2072 616d 7020 7365 6374 696f   the ramp sectio
+000169e0: 6e2e 0a20 2020 2077 6964 7468 3120 3a20  n..    width1 : 
+000169f0: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
+00016a00: 2020 2020 2057 6964 7468 206f 6620 7468       Width of th
+00016a10: 6520 7374 6172 7420 6f66 2074 6865 2072  e start of the r
+00016a20: 616d 7020 7365 6374 696f 6e2e 0a20 2020  amp section..   
+00016a30: 2077 6964 7468 3220 3a20 696e 742c 2066   width2 : int, f
+00016a40: 6c6f 6174 2c20 6f72 204e 6f6e 650a 2020  loat, or None.  
+00016a50: 2020 2020 2020 5769 6474 6820 6f66 2074        Width of t
+00016a60: 6865 2065 6e64 206f 6620 7468 6520 7261  he end of the ra
+00016a70: 6d70 2073 6563 7469 6f6e 2028 6966 2077  mp section (if w
+00016a80: 6964 7468 3220 6973 204e 6f6e 652c 2077  idth2 is None, w
+00016a90: 6964 7468 320a 2020 2020 2020 2020 6265  idth2.        be
+00016aa0: 636f 6d65 7320 7468 6520 7361 6d65 2061  comes the same a
+00016ab0: 7320 7769 6474 6831 292e 0a20 2020 206c  s width1)..    l
+00016ac0: 6179 6572 203a 2069 6e74 2c20 6172 7261  ayer : int, arra
+00016ad0: 792d 6c69 6b65 5b32 5d2c 206f 7220 7365  y-like[2], or se
+00016ae0: 740a 2020 2020 2020 2020 5370 6563 6966  t.        Specif
+00016af0: 6963 206c 6179 6572 2873 2920 746f 2070  ic layer(s) to p
+00016b00: 7574 2070 6f6c 7967 6f6e 2067 656f 6d65  ut polygon geome
+00016b10: 7472 7920 6f6e 2e0a 0a20 2020 2052 6574  try on...    Ret
+00016b20: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+00016b30: 0a20 2020 2044 203a 2044 6576 6963 650a  .    D : Device.
+00016b40: 2020 2020 2020 2020 4120 4465 7669 6365          A Device
+00016b50: 2063 6f6e 7461 696e 696e 6720 6120 7261   containing a ra
+00016b60: 6d70 2067 656f 6d65 7472 792e 0a20 2020  mp geometry..   
+00016b70: 2022 2222 0a20 2020 2069 6620 7769 6474   """.    if widt
+00016b80: 6832 2069 7320 4e6f 6e65 3a0a 2020 2020  h2 is None:.    
+00016b90: 2020 2020 7769 6474 6832 203d 2077 6964      width2 = wid
+00016ba0: 7468 310a 2020 2020 7870 7473 203d 205b  th1.    xpts = [
+00016bb0: 302c 206c 656e 6774 682c 206c 656e 6774  0, length, lengt
+00016bc0: 682c 2030 5d0a 2020 2020 7970 7473 203d  h, 0].    ypts =
+00016bd0: 205b 7769 6474 6831 2c20 7769 6474 6832   [width1, width2
+00016be0: 2c20 302c 2030 5d0a 2020 2020 4420 3d20  , 0, 0].    D = 
+00016bf0: 4465 7669 6365 2822 7261 6d70 2229 0a20  Device("ramp"). 
+00016c00: 2020 2044 2e61 6464 5f70 6f6c 7967 6f6e     D.add_polygon
+00016c10: 285b 7870 7473 2c20 7970 7473 5d2c 206c  ([xpts, ypts], l
+00016c20: 6179 6572 3d6c 6179 6572 290a 2020 2020  ayer=layer).    
+00016c30: 442e 6164 645f 706f 7274 286e 616d 653d  D.add_port(name=
+00016c40: 312c 206d 6964 706f 696e 743d 5b30 2c20  1, midpoint=[0, 
+00016c50: 7769 6474 6831 202f 2032 5d2c 2077 6964  width1 / 2], wid
+00016c60: 7468 3d77 6964 7468 312c 206f 7269 656e  th=width1, orien
+00016c70: 7461 7469 6f6e 3d31 3830 290a 2020 2020  tation=180).    
+00016c80: 442e 6164 645f 706f 7274 286e 616d 653d  D.add_port(name=
+00016c90: 322c 206d 6964 706f 696e 743d 5b6c 656e  2, midpoint=[len
+00016ca0: 6774 682c 2077 6964 7468 3220 2f20 325d  gth, width2 / 2]
+00016cb0: 2c20 7769 6474 683d 7769 6474 6832 2c20  , width=width2, 
+00016cc0: 6f72 6965 6e74 6174 696f 6e3d 3029 0a20  orientation=0). 
+00016cd0: 2020 2072 6574 7572 6e20 440a 0a0a 6465     return D...de
+00016ce0: 6620 5f6d 6963 726f 7374 7269 705f 5a28  f _microstrip_Z(
+00016cf0: 7769 7265 5f77 6964 7468 2c20 6469 656c  wire_width, diel
+00016d00: 6563 7472 6963 5f74 6869 636b 6e65 7373  ectric_thickness
+00016d10: 2c20 6570 735f 7229 3a0a 2020 2020 2222  , eps_r):.    ""
+00016d20: 2243 616c 6375 6c61 7465 7320 7468 6520  "Calculates the 
+00016d30: 696d 7065 6461 6e63 6520 6f66 2061 206d  impedance of a m
+00016d40: 6963 726f 7374 7269 7020 6769 7665 6e20  icrostrip given 
+00016d50: 7468 6520 7769 7265 2077 6964 7468 2061  the wire width a
+00016d60: 6e64 0a20 2020 2064 6965 6c65 6374 7269  nd.    dielectri
+00016d70: 6320 7468 6963 6b6e 6573 7320 616e 6420  c thickness and 
+00016d80: 636f 6e73 7461 6e74 2e0a 0a20 2020 2050  constant...    P
+00016d90: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+00016da0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2077 6972  --------.    wir
+00016db0: 655f 7769 6474 6820 3a20 696e 7420 6f72  e_width : int or
+00016dc0: 2066 6c6f 6174 0a20 2020 2020 2020 2057   float.        W
+00016dd0: 6964 7468 206f 6620 7468 6520 636f 6e64  idth of the cond
+00016de0: 7563 7469 6e67 2073 7472 6970 2e0a 2020  ucting strip..  
+00016df0: 2020 6469 656c 6563 7472 6963 5f74 6869    dielectric_thi
+00016e00: 636b 6e65 7373 203a 2069 6e74 206f 7220  ckness : int or 
+00016e10: 666c 6f61 740a 2020 2020 2020 2020 5468  float.        Th
+00016e20: 6963 6b6e 6573 7320 6f66 2074 6865 2073  ickness of the s
+00016e30: 7562 7374 7261 7465 2e0a 2020 2020 6570  ubstrate..    ep
+00016e40: 735f 7220 3a20 696e 7420 6f72 2066 6c6f  s_r : int or flo
+00016e50: 6174 0a20 2020 2020 2020 2044 6965 6c65  at.        Diele
+00016e60: 6374 7269 6320 636f 6e73 7461 6e74 206f  ctric constant o
+00016e70: 6620 7468 6520 7375 6273 7472 6174 652e  f the substrate.
+00016e80: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+00016e90: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 5a20    -------.    Z 
+00016ea0: 3a20 666c 6f61 740a 2020 2020 2020 2020  : float.        
+00016eb0: 496d 7065 6461 6e63 6520 6f66 2074 6865  Impedance of the
+00016ec0: 206d 6963 726f 7374 7269 702e 0a20 2020   microstrip..   
+00016ed0: 2065 7073 5f65 6666 203a 2066 6c6f 6174   eps_eff : float
+00016ee0: 0a20 2020 2020 2020 2045 6666 6563 7469  .        Effecti
+00016ef0: 7665 2064 6965 6c65 6374 7269 6320 636f  ve dielectric co
+00016f00: 6e73 7461 6e74 206f 6620 7468 6520 6d69  nstant of the mi
+00016f10: 6372 6f73 7472 6970 2e0a 0a20 2020 204e  crostrip...    N
+00016f20: 6f74 6573 0a20 2020 202d 2d2d 2d2d 0a20  otes.    -----. 
+00016f30: 2020 2045 7175 6174 696f 6e73 2074 616b     Equations tak
+00016f40: 656e 2066 726f 6d20 5b31 5d5f 2e0a 0a20  en from [1]_... 
+00016f50: 2020 2054 6865 7365 2065 7175 6174 696f     These equatio
+00016f60: 6e73 2063 616e 2062 6520 6675 7274 6865  ns can be furthe
+00016f70: 7220 636f 7272 6563 7465 6420 666f 7220  r corrected for 
+00016f80: 7468 6963 6b20 6669 6c6d 7320 2848 616d  thick films (Ham
+00016f90: 6d65 7273 7461 6420 4571 732e 0a20 2020  merstad Eqs..   
+00016fa0: 2036 2d39 2920 616e 6420 616c 736f 2066   6-9) and also f
+00016fb0: 6f72 2066 7265 7175 656e 6379 2073 696e  or frequency sin
+00016fc0: 6365 206d 6963 726f 7374 7269 7073 2061  ce microstrips a
+00016fd0: 7265 2064 6973 7065 7273 6976 6520 2848  re dispersive (H
+00016fe0: 616d 6d65 7273 7461 640a 2020 2020 4571  ammerstad.    Eq
+00016ff0: 732e 2031 302d 3132 290a 0a20 2020 2052  s. 10-12)..    R
+00017000: 6566 6572 656e 6365 730a 2020 2020 2d2d  eferences.    --
+00017010: 2d2d 2d2d 2d2d 2d2d 0a20 2020 202e 2e20  --------.    .. 
+00017020: 5b31 5d20 4861 6d6d 6572 7374 6164 2c20  [1] Hammerstad, 
+00017030: 452e 2c20 2620 4a65 6e73 656e 2c20 4f2e  E., & Jensen, O.
+00017040: 2028 3139 3830 292e 2041 6363 7572 6174   (1980). Accurat
+00017050: 6520 4d6f 6465 6c73 2066 6f72 204d 6963  e Models for Mic
+00017060: 726f 7374 7269 700a 2020 2020 2020 2043  rostrip.       C
+00017070: 6f6d 7075 7465 722d 4169 6465 6420 4465  omputer-Aided De
+00017080: 7369 676e 2e20 2068 7474 703a 2f2f 646f  sign.  http://do
+00017090: 692e 6f72 672f 3130 2e31 3130 392f 4d57  i.org/10.1109/MW
+000170a0: 5359 4d2e 3139 3830 2e31 3132 3433 3033  SYM.1980.1124303
+000170b0: 0a20 2020 2022 2222 0a20 2020 2075 203d  .    """.    u =
+000170c0: 2077 6972 655f 7769 6474 6820 2f20 6469   wire_width / di
+000170d0: 656c 6563 7472 6963 5f74 6869 636b 6e65  electric_thickne
+000170e0: 7373 0a20 2020 2065 7461 203d 2033 3736  ss.    eta = 376
+000170f0: 2e37 3320 2023 2056 6163 7575 6d20 696d  .73  # Vacuum im
+00017100: 7065 6461 6e63 650a 0a20 2020 2061 203d  pedance..    a =
+00017110: 2028 0a20 2020 2020 2020 2031 0a20 2020   (.        1.   
+00017120: 2020 2020 202b 206c 6f67 2828 752a 2a34       + log((u**4
+00017130: 202b 2028 7520 2f20 3532 2920 2a2a 2032   + (u / 52) ** 2
+00017140: 2920 2f20 2875 2a2a 3420 2b20 302e 3433  ) / (u**4 + 0.43
+00017150: 3229 2920 2f20 3439 0a20 2020 2020 2020  2)) / 49.       
+00017160: 202b 206c 6f67 2831 202b 2028 7520 2f20   + log(1 + (u / 
+00017170: 3138 2e31 2920 2a2a 2033 2920 2f20 3138  18.1) ** 3) / 18
+00017180: 2e37 0a20 2020 2029 0a20 2020 2062 203d  .7.    ).    b =
+00017190: 2030 2e35 3634 202a 2028 2865 7073 5f72   0.564 * ((eps_r
+000171a0: 202d 2030 2e39 2920 2f20 2865 7073 5f72   - 0.9) / (eps_r
+000171b0: 202b 2033 2929 202a 2a20 302e 3035 330a   + 3)) ** 0.053.
+000171c0: 2020 2020 4620 3d20 3620 2b20 2832 202a      F = 6 + (2 *
+000171d0: 2070 6920 2d20 3629 202a 2065 7870 282d   pi - 6) * exp(-
+000171e0: 2828 3330 2e36 3636 202f 2075 2920 2a2a  ((30.666 / u) **
+000171f0: 2030 2e37 3532 3829 290a 2020 2020 6570   0.7528)).    ep
+00017200: 735f 6566 6620 3d20 302e 3520 2a20 2865  s_eff = 0.5 * (e
+00017210: 7073 5f72 202b 2031 2920 2b20 302e 3520  ps_r + 1) + 0.5 
+00017220: 2a20 2865 7073 5f72 202d 2031 2920 2a20  * (eps_r - 1) * 
+00017230: 2831 202b 2031 3020 2f20 7529 202a 2a20  (1 + 10 / u) ** 
+00017240: 282d 6120 2a20 6229 0a20 2020 205a 203d  (-a * b).    Z =
+00017250: 2065 7461 202f 2028 3220 2a20 7069 2920   eta / (2 * pi) 
+00017260: 2a20 6c6f 6728 4620 2f20 7520 2b20 7371  * log(F / u + sq
+00017270: 7274 2831 202b 2028 3220 2f20 7529 202a  rt(1 + (2 / u) *
+00017280: 2a20 3229 2920 2f20 7371 7274 2865 7073  * 2)) / sqrt(eps
+00017290: 5f65 6666 290a 2020 2020 7265 7475 726e  _eff).    return
+000172a0: 205a 2c20 6570 735f 6566 660a 0a0a 6465   Z, eps_eff...de
+000172b0: 6620 5f6d 6963 726f 7374 7269 705f 4c43  f _microstrip_LC
+000172c0: 5f70 6572 5f6d 6574 6572 2877 6972 655f  _per_meter(wire_
+000172d0: 7769 6474 682c 2064 6965 6c65 6374 7269  width, dielectri
+000172e0: 635f 7468 6963 6b6e 6573 732c 2065 7073  c_thickness, eps
+000172f0: 5f72 293a 0a20 2020 2022 2222 4361 6c63  _r):.    """Calc
+00017300: 756c 6174 6573 2074 6865 2069 6e64 7563  ulates the induc
+00017310: 7461 6e63 6520 616e 6420 6361 7061 6369  tance and capaci
+00017320: 7461 6e63 6520 7065 7220 6d65 7465 7220  tance per meter 
+00017330: 6f66 2061 206d 6963 726f 7374 7269 700a  of a microstrip.
+00017340: 2020 2020 6769 7665 6e20 7769 7265 2077      given wire w
+00017350: 6964 7468 2061 6e64 2064 6965 6c65 6374  idth and dielect
+00017360: 7269 6320 7468 6963 6b6e 6573 7320 616e  ric thickness an
+00017370: 6420 636f 6e73 7461 6e74 2e0a 0a20 2020  d constant...   
+00017380: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+00017390: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2077  ----------.    w
+000173a0: 6972 655f 7769 6474 6820 3a20 696e 7420  ire_width : int 
+000173b0: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
+000173c0: 2057 6964 7468 206f 6620 7468 6520 636f   Width of the co
+000173d0: 6e64 7563 7469 6e67 2073 7472 6970 2e0a  nducting strip..
+000173e0: 2020 2020 6469 656c 6563 7472 6963 5f74      dielectric_t
+000173f0: 6869 636b 6e65 7373 203a 2069 6e74 206f  hickness : int o
+00017400: 7220 666c 6f61 740a 2020 2020 2020 2020  r float.        
+00017410: 5468 6963 6b6e 6573 7320 6f66 2074 6865  Thickness of the
+00017420: 2073 7562 7374 7261 7465 2e0a 2020 2020   substrate..    
+00017430: 6570 735f 7220 3a20 696e 7420 6f72 2066  eps_r : int or f
+00017440: 6c6f 6174 0a20 2020 2020 2020 2044 6965  loat.        Die
+00017450: 6c65 6374 7269 6320 636f 6e73 7461 6e74  lectric constant
+00017460: 206f 6620 7468 6520 7375 6273 7472 6174   of the substrat
+00017470: 652e 0a0a 2020 2020 5265 7475 726e 730a  e...    Returns.
+00017480: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+00017490: 4c5f 6d20 3a20 666c 6f61 740a 2020 2020  L_m : float.    
+000174a0: 2020 2020 496e 6475 6374 616e 6365 2070      Inductance p
+000174b0: 6572 206d 6574 6572 206f 6620 7468 6520  er meter of the 
+000174c0: 6d69 6372 6f73 7472 6970 2e0a 2020 2020  microstrip..    
+000174d0: 435f 6d20 3a20 666c 6f61 740a 2020 2020  C_m : float.    
+000174e0: 2020 2020 4361 7061 6369 7461 6e63 6520      Capacitance 
+000174f0: 7065 7220 6d65 7465 7220 6f66 2074 6865  per meter of the
+00017500: 206d 6963 726f 7374 7269 702e 0a0a 2020   microstrip...  
+00017510: 2020 4e6f 7465 730a 2020 2020 2d2d 2d2d    Notes.    ----
+00017520: 2d0a 2020 2020 4571 7561 7469 6f6e 7320  -.    Equations 
+00017530: 7461 6b65 6e20 6672 6f6d 3a0a 2020 2020  taken from:.    
+00017540: 2020 2020 4861 6d6d 6572 7374 6164 2c20      Hammerstad, 
+00017550: 452e 2c20 2620 4a65 6e73 656e 2c20 4f2e  E., & Jensen, O.
+00017560: 2028 3139 3830 292e 2041 6363 7572 6174   (1980). Accurat
+00017570: 6520 4d6f 6465 6c73 2066 6f72 204d 6963  e Models for Mic
+00017580: 726f 7374 7269 700a 2020 2020 2020 2020  rostrip.        
+00017590: 436f 6d70 7574 6572 2d41 6964 6564 2044  Computer-Aided D
+000175a0: 6573 6967 6e2e 2020 6874 7470 3a2f 2f64  esign.  http://d
+000175b0: 6f69 2e6f 7267 2f31 302e 3131 3039 2f4d  oi.org/10.1109/M
+000175c0: 5753 594d 2e31 3938 302e 3131 3234 3330  WSYM.1980.112430
+000175d0: 330a 0a20 2020 2054 6865 7365 2065 7175  3..    These equ
+000175e0: 6174 696f 6e73 2063 616e 2062 6520 6675  ations can be fu
+000175f0: 7274 6865 7220 636f 7272 6563 7465 6420  rther corrected 
+00017600: 666f 7220 7468 6963 6b20 6669 6c6d 7320  for thick films 
+00017610: 2848 616d 6d65 7273 7461 6420 4571 730a  (Hammerstad Eqs.
+00017620: 2020 2020 362d 3929 2061 6e64 2061 6c73      6-9) and als
+00017630: 6f20 666f 7220 6672 6571 7565 6e63 7920  o for frequency 
+00017640: 7369 6e63 6520 6d69 6372 6f73 7472 6970  since microstrip
+00017650: 7320 6172 6520 6469 7370 6572 7369 7665  s are dispersive
+00017660: 2028 4861 6d6d 6572 7374 6164 0a20 2020   (Hammerstad.   
+00017670: 2045 7173 2031 302d 3132 290a 2020 2020   Eqs 10-12).    
+00017680: 2222 220a 2020 2020 2320 5573 6520 7468  """.    # Use th
+00017690: 6520 6661 6374 2074 6861 7420 7620 3d20  e fact that v = 
+000176a0: 312f 7371 7274 284c 5f6d 2a43 5f6d 2920  1/sqrt(L_m*C_m) 
+000176b0: 3d20 312f 7371 7274 2865 7073 2a6d 7529  = 1/sqrt(eps*mu)
+000176c0: 2061 6e64 0a20 2020 2023 205a 203d 2073   and.    # Z = s
+000176d0: 7172 7428 4c5f 6d2f 435f 6d29 2020 205b  qrt(L_m/C_m)   [
+000176e0: 5768 6572 6520 4c5f 6d20 6973 2069 6e64  Where L_m is ind
+000176f0: 7563 7461 6e63 6520 7065 7220 6d65 7465  uctance per mete
+00017700: 725d 0a20 2020 205a 2c20 6570 735f 6566  r].    Z, eps_ef
+00017710: 6620 3d20 5f6d 6963 726f 7374 7269 705f  f = _microstrip_
+00017720: 5a28 7769 7265 5f77 6964 7468 2c20 6469  Z(wire_width, di
+00017730: 656c 6563 7472 6963 5f74 6869 636b 6e65  electric_thickne
+00017740: 7373 2c20 6570 735f 7229 0a20 2020 2065  ss, eps_r).    e
+00017750: 7073 3020 3d20 382e 3835 3465 2d31 320a  ps0 = 8.854e-12.
+00017760: 2020 2020 6d75 3020 3d20 3420 2a20 7069      mu0 = 4 * pi
+00017770: 202a 2031 652d 370a 0a20 2020 2065 7073   * 1e-7..    eps
+00017780: 203d 2065 7073 5f65 6666 202a 2065 7073   = eps_eff * eps
+00017790: 300a 2020 2020 6d75 203d 206d 7530 0a20  0.    mu = mu0. 
+000177a0: 2020 204c 5f6d 203d 2073 7172 7428 6570     L_m = sqrt(ep
+000177b0: 7320 2a20 6d75 2920 2a20 5a0a 2020 2020  s * mu) * Z.    
+000177c0: 435f 6d20 3d20 7371 7274 2865 7073 202a  C_m = sqrt(eps *
+000177d0: 206d 7529 202f 205a 0a20 2020 2072 6574   mu) / Z.    ret
+000177e0: 7572 6e20 4c5f 6d2c 2043 5f6d 0a0a 0a64  urn L_m, C_m...d
+000177f0: 6566 205f 6d69 6372 6f73 7472 6970 5f5a  ef _microstrip_Z
+00017800: 5f77 6974 685f 4c6b 2877 6972 655f 7769  _with_Lk(wire_wi
+00017810: 6474 682c 2064 6965 6c65 6374 7269 635f  dth, dielectric_
+00017820: 7468 6963 6b6e 6573 732c 2065 7073 5f72  thickness, eps_r
+00017830: 2c20 4c6b 5f70 6572 5f73 7129 3a0a 2020  , Lk_per_sq):.  
+00017840: 2020 2222 2243 616c 6375 6c61 7465 7320    """Calculates 
+00017850: 7468 6520 696d 7065 6461 6e63 6520 6f66  the impedance of
+00017860: 2061 206d 6963 726f 7374 7269 7020 6769   a microstrip gi
+00017870: 7665 6e20 7769 7265 2077 6964 7468 2c20  ven wire width, 
+00017880: 6469 656c 6563 7472 6963 0a20 2020 2074  dielectric.    t
+00017890: 6869 636b 6e65 7373 2061 6e64 2063 6f6e  hickness and con
+000178a0: 7374 616e 742c 2061 6e64 206b 696e 6574  stant, and kinet
+000178b0: 6963 2069 6e64 7563 7461 6e63 6520 7065  ic inductance pe
+000178c0: 7220 7371 7561 7265 2e0a 0a20 2020 2050  r square...    P
+000178d0: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+000178e0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2077 6972  --------.    wir
+000178f0: 655f 7769 6474 6820 3a20 696e 7420 6f72  e_width : int or
+00017900: 2066 6c6f 6174 0a20 2020 2020 2020 2057   float.        W
+00017910: 6964 7468 206f 6620 7468 6520 636f 6e64  idth of the cond
+00017920: 7563 7469 6e67 2073 7472 6970 2e0a 2020  ucting strip..  
+00017930: 2020 6469 656c 6563 7472 6963 5f74 6869    dielectric_thi
+00017940: 636b 6e65 7373 203a 2069 6e74 206f 7220  ckness : int or 
+00017950: 666c 6f61 740a 2020 2020 2020 2020 5468  float.        Th
+00017960: 6963 6b6e 6573 7320 6f66 2074 6865 2073  ickness of the s
+00017970: 7562 7374 7261 7465 2e0a 2020 2020 6570  ubstrate..    ep
+00017980: 735f 7220 3a20 696e 7420 6f72 2066 6c6f  s_r : int or flo
+00017990: 6174 0a20 2020 2020 2020 2044 6965 6c65  at.        Diele
+000179a0: 6374 7269 6320 636f 6e73 7461 6e74 206f  ctric constant o
+000179b0: 6620 7468 6520 7375 6273 7472 6174 652e  f the substrate.
+000179c0: 0a20 2020 204c 6b5f 7065 725f 7371 203a  .    Lk_per_sq :
+000179d0: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
+000179e0: 2020 2020 2020 4b69 6e65 7469 6320 696e        Kinetic in
+000179f0: 6475 6374 616e 6365 2070 6572 2073 7175  ductance per squ
+00017a00: 6172 6520 6f66 2074 6865 206d 6963 726f  are of the micro
+00017a10: 7374 7269 702e 0a0a 2020 2020 5265 7475  strip...    Retu
+00017a20: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+00017a30: 2020 2020 5a20 3a20 666c 6f61 740a 2020      Z : float.  
+00017a40: 2020 2020 2020 496d 7065 6461 6e63 6520        Impedance 
+00017a50: 6f66 2074 6865 206d 6963 726f 7374 7269  of the microstri
+00017a60: 702e 0a0a 2020 2020 4e6f 7465 730a 2020  p...    Notes.  
+00017a70: 2020 2d2d 2d2d 2d0a 2020 2020 4571 7561    -----.    Equa
+00017a80: 7469 6f6e 7320 7461 6b65 6e20 6672 6f6d  tions taken from
+00017a90: 3a0a 2020 2020 2020 2020 4861 6d6d 6572  :.        Hammer
+00017aa0: 7374 6164 2c20 452e 2c20 2620 4a65 6e73  stad, E., & Jens
+00017ab0: 656e 2c20 4f2e 2028 3139 3830 292e 2041  en, O. (1980). A
+00017ac0: 6363 7572 6174 6520 4d6f 6465 6c73 2066  ccurate Models f
+00017ad0: 6f72 204d 6963 726f 7374 7269 700a 2020  or Microstrip.  
+00017ae0: 2020 2020 2020 436f 6d70 7574 6572 2d41        Computer-A
+00017af0: 6964 6564 2044 6573 6967 6e2e 2020 6874  ided Design.  ht
+00017b00: 7470 3a2f 2f64 6f69 2e6f 7267 2f31 302e  tp://doi.org/10.
+00017b10: 3131 3039 2f4d 5753 594d 2e31 3938 302e  1109/MWSYM.1980.
+00017b20: 3131 3234 3330 330a 0a20 2020 2054 6865  1124303..    The
+00017b30: 7365 2065 7175 6174 696f 6e73 2063 616e  se equations can
+00017b40: 2062 6520 6675 7274 6865 7220 636f 7272   be further corr
+00017b50: 6563 7465 6420 666f 7220 7468 6963 6b20  ected for thick 
+00017b60: 6669 6c6d 7320 2848 616d 6d65 7273 7461  films (Hammersta
+00017b70: 6420 4571 730a 2020 2020 362d 3929 2061  d Eqs.    6-9) a
+00017b80: 6e64 2061 6c73 6f20 666f 7220 6672 6571  nd also for freq
+00017b90: 7565 6e63 7920 7369 6e63 6520 6d69 6372  uency since micr
+00017ba0: 6f73 7472 6970 7320 6172 6520 6469 7370  ostrips are disp
+00017bb0: 6572 7369 7665 2028 4861 6d6d 6572 7374  ersive (Hammerst
+00017bc0: 6164 0a20 2020 2045 7173 2031 302d 3132  ad.    Eqs 10-12
+00017bd0: 290a 2020 2020 2222 220a 2020 2020 2320  ).    """.    # 
+00017be0: 4164 6420 6120 6b69 6e65 7469 6320 696e  Add a kinetic in
+00017bf0: 6475 6374 616e 6365 2061 6e64 2072 6563  ductance and rec
+00017c00: 616c 6375 6c61 7465 2074 6865 2069 6d70  alculate the imp
+00017c10: 6564 616e 6365 2c20 6265 2063 6172 6566  edance, be caref
+00017c20: 756c 0a20 2020 2023 2074 6f20 696e 7075  ul.    # to inpu
+00017c30: 7420 4c6b 2061 7320 6120 7065 722d 6d65  t Lk as a per-me
+00017c40: 7465 7220 696e 6475 6374 616e 6365 0a20  ter inductance. 
+00017c50: 2020 204c 5f6d 2c20 435f 6d20 3d20 5f6d     L_m, C_m = _m
+00017c60: 6963 726f 7374 7269 705f 4c43 5f70 6572  icrostrip_LC_per
+00017c70: 5f6d 6574 6572 2877 6972 655f 7769 6474  _meter(wire_widt
+00017c80: 682c 2064 6965 6c65 6374 7269 635f 7468  h, dielectric_th
+00017c90: 6963 6b6e 6573 732c 2065 7073 5f72 290a  ickness, eps_r).
+00017ca0: 2020 2020 4c6b 5f6d 203d 204c 6b5f 7065      Lk_m = Lk_pe
+00017cb0: 725f 7371 202a 2028 312e 3020 2f20 7769  r_sq * (1.0 / wi
+00017cc0: 7265 5f77 6964 7468 290a 2020 2020 5a20  re_width).    Z 
+00017cd0: 3d20 7371 7274 2828 4c5f 6d20 2b20 4c6b  = sqrt((L_m + Lk
+00017ce0: 5f6d 2920 2f20 435f 6d29 0a20 2020 2072  _m) / C_m).    r
+00017cf0: 6574 7572 6e20 5a0a 0a0a 6465 6620 5f6d  eturn Z...def _m
+00017d00: 6963 726f 7374 7269 705f 765f 7769 7468  icrostrip_v_with
+00017d10: 5f4c 6b28 7769 7265 5f77 6964 7468 2c20  _Lk(wire_width, 
+00017d20: 6469 656c 6563 7472 6963 5f74 6869 636b  dielectric_thick
+00017d30: 6e65 7373 2c20 6570 735f 722c 204c 6b5f  ness, eps_r, Lk_
+00017d40: 7065 725f 7371 293a 0a20 2020 2022 2222  per_sq):.    """
+00017d50: 4361 6c63 756c 6174 6573 2074 6865 2070  Calculates the p
+00017d60: 726f 7061 6761 7469 6f6e 2076 656c 6f63  ropagation veloc
+00017d70: 6974 7920 696e 2061 206d 6963 726f 7374  ity in a microst
+00017d80: 7269 700a 0a20 2020 2050 6172 616d 6574  rip..    Paramet
+00017d90: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
+00017da0: 2d2d 0a20 2020 2077 6972 655f 7769 6474  --.    wire_widt
+00017db0: 6820 3a20 696e 7420 6f72 2066 6c6f 6174  h : int or float
+00017dc0: 0a20 2020 2020 2020 2057 6964 7468 206f  .        Width o
+00017dd0: 6620 7468 6520 636f 6e64 7563 7469 6e67  f the conducting
+00017de0: 2073 7472 6970 2e0a 2020 2020 6469 656c   strip..    diel
+00017df0: 6563 7472 6963 5f74 6869 636b 6e65 7373  ectric_thickness
+00017e00: 203a 2069 6e74 206f 7220 666c 6f61 740a   : int or float.
+00017e10: 2020 2020 2020 2020 5468 6963 6b6e 6573          Thicknes
+00017e20: 7320 6f66 2074 6865 2073 7562 7374 7261  s of the substra
+00017e30: 7465 2e0a 2020 2020 6570 735f 7220 3a20  te..    eps_r : 
+00017e40: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
+00017e50: 2020 2020 2044 6965 6c65 6374 7269 6320       Dielectric 
+00017e60: 636f 6e73 7461 6e74 206f 6620 7468 6520  constant of the 
+00017e70: 7375 6273 7472 6174 652e 0a20 2020 204c  substrate..    L
+00017e80: 6b5f 7065 725f 7371 203a 2069 6e74 206f  k_per_sq : int o
+00017e90: 7220 666c 6f61 740a 2020 2020 2020 2020  r float.        
+00017ea0: 4b69 6e65 7469 6320 696e 6475 6374 616e  Kinetic inductan
+00017eb0: 6365 2070 6572 2073 7175 6172 6520 6f66  ce per square of
+00017ec0: 2074 6865 206d 6963 726f 7374 7269 702e   the microstrip.
+00017ed0: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+00017ee0: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 7620    -------.    v 
+00017ef0: 3a20 666c 6f61 740a 2020 2020 2020 2020  : float.        
+00017f00: 5072 6f70 6167 6174 696f 6e20 7665 6c6f  Propagation velo
+00017f10: 6369 7479 2069 6e20 7468 6520 6d69 6372  city in the micr
+00017f20: 6f73 7472 6970 0a0a 2020 2020 4e6f 7465  ostrip..    Note
+00017f30: 730a 2020 2020 2d2d 2d2d 2d0a 2020 2020  s.    -----.    
+00017f40: 4571 7561 7469 6f6e 7320 7461 6b65 6e20  Equations taken 
+00017f50: 6672 6f6d 3a0a 2020 2020 2020 2020 4861  from:.        Ha
+00017f60: 6d6d 6572 7374 6164 2c20 452e 2c20 2620  mmerstad, E., & 
+00017f70: 4a65 6e73 656e 2c20 4f2e 2028 3139 3830  Jensen, O. (1980
+00017f80: 292e 2041 6363 7572 6174 6520 4d6f 6465  ). Accurate Mode
+00017f90: 6c73 2066 6f72 204d 6963 726f 7374 7269  ls for Microstri
+00017fa0: 700a 2020 2020 2020 2020 436f 6d70 7574  p.        Comput
+00017fb0: 6572 2d41 6964 6564 2044 6573 6967 6e2e  er-Aided Design.
+00017fc0: 2020 6874 7470 3a2f 2f64 6f69 2e6f 7267    http://doi.org
+00017fd0: 2f31 302e 3131 3039 2f4d 5753 594d 2e31  /10.1109/MWSYM.1
+00017fe0: 3938 302e 3131 3234 3330 330a 0a20 2020  980.1124303..   
+00017ff0: 2054 6865 7365 2065 7175 6174 696f 6e73   These equations
+00018000: 2063 616e 2062 6520 6675 7274 6865 7220   can be further 
+00018010: 636f 7272 6563 7465 6420 666f 7220 7468  corrected for th
+00018020: 6963 6b20 6669 6c6d 7320 2848 616d 6d65  ick films (Hamme
+00018030: 7273 7461 6420 4571 730a 2020 2020 362d  rstad Eqs.    6-
+00018040: 3929 2061 6e64 2061 6c73 6f20 666f 7220  9) and also for 
+00018050: 6672 6571 7565 6e63 7920 7369 6e63 6520  frequency since 
+00018060: 6d69 6372 6f73 7472 6970 7320 6172 6520  microstrips are 
+00018070: 6469 7370 6572 7369 7665 2028 4861 6d6d  dispersive (Hamm
+00018080: 6572 7374 6164 0a20 2020 2045 7173 2031  erstad.    Eqs 1
+00018090: 302d 3132 290a 2020 2020 2222 220a 2020  0-12).    """.  
+000180a0: 2020 4c5f 6d2c 2043 5f6d 203d 205f 6d69    L_m, C_m = _mi
+000180b0: 6372 6f73 7472 6970 5f4c 435f 7065 725f  crostrip_LC_per_
+000180c0: 6d65 7465 7228 7769 7265 5f77 6964 7468  meter(wire_width
+000180d0: 2c20 6469 656c 6563 7472 6963 5f74 6869  , dielectric_thi
+000180e0: 636b 6e65 7373 2c20 6570 735f 7229 0a20  ckness, eps_r). 
+000180f0: 2020 204c 6b5f 6d20 3d20 4c6b 5f70 6572     Lk_m = Lk_per
+00018100: 5f73 7120 2a20 2831 2e30 202f 2077 6972  _sq * (1.0 / wir
+00018110: 655f 7769 6474 6829 0a20 2020 2076 203d  e_width).    v =
+00018120: 2031 202f 2073 7172 7428 284c 5f6d 202b   1 / sqrt((L_m +
+00018130: 204c 6b5f 6d29 202a 2043 5f6d 290a 2020   Lk_m) * C_m).  
+00018140: 2020 7265 7475 726e 2076 0a0a 0a64 6566    return v...def
+00018150: 205f 6669 6e64 5f6d 6963 726f 7374 7269   _find_microstri
+00018160: 705f 7769 7265 5f77 6964 7468 285a 5f74  p_wire_width(Z_t
+00018170: 6172 6765 742c 2064 6965 6c65 6374 7269  arget, dielectri
+00018180: 635f 7468 6963 6b6e 6573 732c 2065 7073  c_thickness, eps
+00018190: 5f72 2c20 4c6b 5f70 6572 5f73 7129 3a0a  _r, Lk_per_sq):.
+000181a0: 2020 2020 2222 2243 616c 6375 6c61 7465      """Calculate
+000181b0: 7320 7468 6520 7769 7265 2077 6964 7468  s the wire width
+000181c0: 206f 6620 6120 6d69 6372 6f73 7472 6970   of a microstrip
+000181d0: 2067 6976 656e 2061 2074 6172 6765 7420   given a target 
+000181e0: 696d 7065 6461 6e63 652c 0a20 2020 2064  impedance,.    d
+000181f0: 6965 6c65 6374 7269 6320 7468 6963 6b6e  ielectric thickn
+00018200: 6573 7320 616e 6420 636f 6e73 7461 6e74  ess and constant
+00018210: 2c20 616e 6420 6b69 6e65 7469 6320 696e  , and kinetic in
+00018220: 6475 6374 616e 6365 2070 6572 2073 7175  ductance per squ
+00018230: 6172 652e 0a0a 2020 2020 5061 7261 6d65  are...    Parame
+00018240: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+00018250: 2d2d 2d0a 2020 2020 5a5f 7461 7267 6574  ---.    Z_target
+00018260: 203a 2069 6e74 206f 7220 666c 6f61 740a   : int or float.
+00018270: 2020 2020 2020 2020 5461 7267 6574 2069          Target i
+00018280: 6d70 6564 616e 6365 206f 6620 7468 6520  mpedance of the 
+00018290: 6d69 6372 6f73 7472 6970 2e0a 2020 2020  microstrip..    
+000182a0: 6469 656c 6563 7472 6963 5f74 6869 636b  dielectric_thick
+000182b0: 6e65 7373 203a 2069 6e74 206f 7220 666c  ness : int or fl
+000182c0: 6f61 740a 2020 2020 2020 2020 5468 6963  oat.        Thic
+000182d0: 6b6e 6573 7320 6f66 2074 6865 2073 7562  kness of the sub
+000182e0: 7374 7261 7465 2e0a 2020 2020 6570 735f  strate..    eps_
+000182f0: 7220 3a20 696e 7420 6f72 2066 6c6f 6174  r : int or float
+00018300: 0a20 2020 2020 2020 2044 6965 6c65 6374  .        Dielect
+00018310: 7269 6320 636f 6e73 7461 6e74 206f 6620  ric constant of 
+00018320: 7468 6520 7375 6273 7472 6174 652e 0a20  the substrate.. 
+00018330: 2020 204c 6b5f 7065 725f 7371 203a 2069     Lk_per_sq : i
+00018340: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
+00018350: 2020 2020 4b69 6e65 7469 6320 696e 6475      Kinetic indu
+00018360: 6374 616e 6365 2070 6572 2073 7175 6172  ctance per squar
+00018370: 6520 6f66 2074 6865 206d 6963 726f 7374  e of the microst
+00018380: 7269 702e 0a0a 2020 2020 5265 7475 726e  rip...    Return
+00018390: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
+000183a0: 2020 7720 3a20 666c 6f61 740a 2020 2020    w : float.    
+000183b0: 2020 2020 5769 7265 2077 6964 7468 206f      Wire width o
+000183c0: 6620 7468 6520 6d69 6372 6f73 7472 6970  f the microstrip
+000183d0: 2e0a 0a20 2020 204e 6f74 6573 0a20 2020  ...    Notes.   
+000183e0: 202d 2d2d 2d2d 0a20 2020 2045 7175 6174   -----.    Equat
+000183f0: 696f 6e73 2074 616b 656e 2066 726f 6d3a  ions taken from:
+00018400: 0a20 2020 2020 2020 2048 616d 6d65 7273  .        Hammers
+00018410: 7461 642c 2045 2e2c 2026 204a 656e 7365  tad, E., & Jense
+00018420: 6e2c 204f 2e20 2831 3938 3029 2e20 4163  n, O. (1980). Ac
+00018430: 6375 7261 7465 204d 6f64 656c 7320 666f  curate Models fo
+00018440: 7220 4d69 6372 6f73 7472 6970 0a20 2020  r Microstrip.   
+00018450: 2020 2020 2043 6f6d 7075 7465 722d 4169       Computer-Ai
+00018460: 6465 6420 4465 7369 676e 2e20 2068 7474  ded Design.  htt
+00018470: 703a 2f2f 646f 692e 6f72 672f 3130 2e31  p://doi.org/10.1
+00018480: 3130 392f 4d57 5359 4d2e 3139 3830 2e31  109/MWSYM.1980.1
+00018490: 3132 3433 3033 0a0a 2020 2020 5468 6573  124303..    Thes
+000184a0: 6520 6571 7561 7469 6f6e 7320 6361 6e20  e equations can 
+000184b0: 6265 2066 7572 7468 6572 2063 6f72 7265  be further corre
+000184c0: 6374 6564 2066 6f72 2074 6869 636b 2066  cted for thick f
+000184d0: 696c 6d73 2028 4861 6d6d 6572 7374 6164  ilms (Hammerstad
+000184e0: 2045 7173 0a20 2020 2036 2d39 2920 616e   Eqs.    6-9) an
+000184f0: 6420 616c 736f 2066 6f72 2066 7265 7175  d also for frequ
+00018500: 656e 6379 2073 696e 6365 206d 6963 726f  ency since micro
+00018510: 7374 7269 7073 2061 7265 2064 6973 7065  strips are dispe
+00018520: 7273 6976 6520 2848 616d 6d65 7273 7461  rsive (Hammersta
+00018530: 640a 2020 2020 4571 7320 3130 2d31 3229  d.    Eqs 10-12)
+00018540: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
+00018550: 6620 6572 726f 725f 6675 6e28 7769 7265  f error_fun(wire
+00018560: 5f77 6964 7468 293a 0a20 2020 2020 2020  _width):.       
+00018570: 205a 5f67 7565 7373 6564 203d 205f 6d69   Z_guessed = _mi
+00018580: 6372 6f73 7472 6970 5f5a 5f77 6974 685f  crostrip_Z_with_
+00018590: 4c6b 280a 2020 2020 2020 2020 2020 2020  Lk(.            
+000185a0: 7769 7265 5f77 6964 7468 2c20 6469 656c  wire_width, diel
+000185b0: 6563 7472 6963 5f74 6869 636b 6e65 7373  ectric_thickness
+000185c0: 2c20 6570 735f 722c 204c 6b5f 7065 725f  , eps_r, Lk_per_
+000185d0: 7371 0a20 2020 2020 2020 2029 0a20 2020  sq.        ).   
+000185e0: 2020 2020 2072 6574 7572 6e20 285a 5f67       return (Z_g
+000185f0: 7565 7373 6564 202d 205a 5f74 6172 6765  uessed - Z_targe
+00018600: 7429 202a 2a20 3220 2023 2054 6865 2065  t) ** 2  # The e
+00018610: 7272 6f72 0a0a 2020 2020 7830 203d 2064  rror..    x0 = d
+00018620: 6965 6c65 6374 7269 635f 7468 6963 6b6e  ielectric_thickn
+00018630: 6573 730a 2020 2020 7472 793a 0a20 2020  ess.    try:.   
+00018640: 2020 2020 2066 726f 6d20 7363 6970 792e       from scipy.
+00018650: 6f70 7469 6d69 7a65 2069 6d70 6f72 7420  optimize import 
+00018660: 666d 696e 0a20 2020 2065 7863 6570 7420  fmin.    except 
+00018670: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
+00018680: 2020 2072 6169 7365 2049 6d70 6f72 7445     raise ImportE
+00018690: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+000186a0: 2020 2220 5b50 4849 444c 5d20 546f 2072    " [PHIDL] To r
+000186b0: 756e 2074 6865 206d 6963 726f 7374 7269  un the microstri
+000186c0: 7020 6675 6e63 7469 6f6e 7320 796f 7520  p functions you 
+000186d0: 220a 2020 2020 2020 2020 2020 2020 226e  ".            "n
+000186e0: 6565 6420 7363 6970 792c 2070 6c65 6173  eed scipy, pleas
+000186f0: 6520 696e 7374 616c 6c20 6974 2077 6974  e install it wit
+00018700: 6820 220a 2020 2020 2020 2020 2020 2020  h ".            
+00018710: 2260 7069 7020 696e 7374 616c 6c20 7363  "`pip install sc
+00018720: 6970 7960 220a 2020 2020 2020 2020 290a  ipy`".        ).
+00018730: 2020 2020 7720 3d20 666d 696e 2865 7272      w = fmin(err
+00018740: 6f72 5f66 756e 2c20 7830 2c20 6172 6773  or_fun, x0, args
+00018750: 3d28 292c 2064 6973 703d 4661 6c73 6529  =(), disp=False)
+00018760: 0a20 2020 2072 6574 7572 6e20 775b 305d  .    return w[0]
+00018770: 0a0a 0a64 6566 205f 475f 696e 7465 6772  ...def _G_integr
+00018780: 616e 6428 7869 702c 2042 293a 0a20 2020  and(xip, B):.   
+00018790: 2022 2222 5370 6563 6961 6c20 6675 6e63   """Special func
+000187a0: 7469 6f6e 2066 6f72 206d 6963 726f 7374  tion for microst
+000187b0: 7269 7020 6361 6c63 756c 6174 696f 6e73  rip calculations
+000187c0: 2222 220a 2020 2020 7472 793a 0a20 2020  """.    try:.   
+000187d0: 2020 2020 2066 726f 6d20 7363 6970 792e       from scipy.
+000187e0: 7370 6563 6961 6c20 696d 706f 7274 2069  special import i
+000187f0: 7620 6173 2062 6573 7365 6c69 0a20 2020  v as besseli.   
+00018800: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+00018810: 6e3a 0a20 2020 2020 2020 2022 2222 5b50  n:.        """[P
+00018820: 4849 444c 5d20 546f 2072 756e 2074 6869  HIDL] To run thi
+00018830: 7320 6675 6e63 7469 6f6e 2079 6f75 206e  s function you n
+00018840: 6565 6420 7363 6970 792c 2070 6c65 6173  eed scipy, pleas
+00018850: 6520 696e 7374 616c 6c20 6974 2077 6974  e install it wit
+00018860: 680a 2020 2020 2020 2020 7069 7020 696e  h.        pip in
+00018870: 7374 616c 6c20 7363 6970 7922 2222 0a20  stall scipy""". 
+00018880: 2020 2072 6574 7572 6e20 6265 7373 656c     return bessel
+00018890: 6928 302c 2042 202a 2073 7172 7428 3120  i(0, B * sqrt(1 
+000188a0: 2d20 7869 702a 2a32 2929 0a0a 0a64 6566  - xip**2))...def
+000188b0: 205f 4728 7869 2c20 4229 3a0a 2020 2020   _G(xi, B):.    
+000188c0: 2222 2253 7065 6369 616c 2066 756e 6374  """Special funct
+000188d0: 696f 6e20 666f 7220 6d69 6372 6f73 7472  ion for microstr
+000188e0: 6970 2063 616c 6375 6c61 7469 6f6e 7322  ip calculations"
+000188f0: 2222 0a20 2020 2074 7279 3a0a 2020 2020  "".    try:.    
+00018900: 2020 2020 696d 706f 7274 2073 6369 7079      import scipy
+00018910: 2e69 6e74 6567 7261 7465 0a20 2020 2065  .integrate.    e
+00018920: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
+00018930: 0a20 2020 2020 2020 2072 6169 7365 2049  .        raise I
+00018940: 6d70 6f72 7445 7272 6f72 280a 2020 2020  mportError(.    
+00018950: 2020 2020 2020 2020 2220 5b50 4849 444c          " [PHIDL
+00018960: 5d20 546f 2072 756e 2074 6865 206d 6963  ] To run the mic
+00018970: 726f 7374 7269 7020 6675 6e63 7469 6f6e  rostrip function
+00018980: 7320 796f 7520 220a 2020 2020 2020 2020  s you ".        
+00018990: 2020 2020 226e 6565 6420 7363 6970 792c      "need scipy,
+000189a0: 2070 6c65 6173 6520 696e 7374 616c 6c20   please install 
+000189b0: 6974 2077 6974 6820 220a 2020 2020 2020  it with ".      
+000189c0: 2020 2020 2020 2260 7069 7020 696e 7374        "`pip inst
+000189d0: 616c 6c20 7363 6970 7960 220a 2020 2020  all scipy`".    
+000189e0: 2020 2020 290a 2020 2020 7265 7475 726e      ).    return
+000189f0: 2042 202f 2073 696e 6828 4229 202a 2073   B / sinh(B) * s
+00018a00: 6369 7079 2e69 6e74 6567 7261 7465 2e71  cipy.integrate.q
+00018a10: 7561 6428 5f47 5f69 6e74 6567 7261 6e64  uad(_G_integrand
+00018a20: 2c20 302c 2078 692c 2061 7267 733d 2842  , 0, xi, args=(B
+00018a30: 2929 5b30 5d0a 0a0a 4064 6576 6963 655f  ))[0]...@device_
+00018a40: 6c72 755f 6361 6368 650a 6465 6620 6865  lru_cache.def he
+00018a50: 636b 656e 5f74 6170 6572 280a 2020 2020  cken_taper(.    
+00018a60: 6c65 6e67 7468 3d32 3030 2c0a 2020 2020  length=200,.    
+00018a70: 423d 342e 3030 3931 2c0a 2020 2020 6469  B=4.0091,.    di
+00018a80: 656c 6563 7472 6963 5f74 6869 636b 6e65  electric_thickne
+00018a90: 7373 3d30 2e32 352c 0a20 2020 2065 7073  ss=0.25,.    eps
+00018aa0: 5f72 3d32 2c0a 2020 2020 4c6b 5f70 6572  _r=2,.    Lk_per
+00018ab0: 5f73 713d 3235 3065 2d31 322c 0a20 2020  _sq=250e-12,.   
+00018ac0: 205a 313d 4e6f 6e65 2c0a 2020 2020 5a32   Z1=None,.    Z2
+00018ad0: 3d4e 6f6e 652c 0a20 2020 2077 6964 7468  =None,.    width
+00018ae0: 313d 4e6f 6e65 2c0a 2020 2020 7769 6474  1=None,.    widt
+00018af0: 6832 3d4e 6f6e 652c 0a20 2020 206e 756d  h2=None,.    num
+00018b00: 5f70 7473 3d31 3030 2c0a 2020 2020 6c61  _pts=100,.    la
+00018b10: 7965 723d 302c 0a29 3a0a 2020 2020 2222  yer=0,.):.    ""
+00018b20: 2243 7265 6174 6573 2061 2048 6563 6b65  "Creates a Hecke
+00018b30: 6e2d 7461 7065 7265 6420 6d69 6372 6f73  n-tapered micros
+00018b40: 7472 6970 2e0a 0a20 2020 2050 6172 616d  trip...    Param
+00018b50: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
+00018b60: 2d2d 2d2d 0a20 2020 206c 656e 6774 6820  ----.    length 
+00018b70: 3a20 696e 7420 6f72 2066 6c6f 6174 0a20  : int or float. 
+00018b80: 2020 2020 2020 204c 656e 6774 6820 6f66         Length of
+00018b90: 2074 6865 206d 6963 726f 7374 7269 702e   the microstrip.
+00018ba0: 0a20 2020 2042 203a 2069 6e74 206f 7220  .    B : int or 
+00018bb0: 666c 6f61 740a 2020 2020 2020 2020 436f  float.        Co
+00018bc0: 6e74 726f 6c73 2074 6865 2069 6e74 656e  ntrols the inten
+00018bd0: 7369 7479 206f 6620 7468 6520 7461 7065  sity of the tape
+00018be0: 722e 0a20 2020 2064 6965 6c65 6374 7269  r..    dielectri
+00018bf0: 635f 7468 6963 6b6e 6573 7320 3a20 696e  c_thickness : in
+00018c00: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
+00018c10: 2020 2054 6869 636b 6e65 7373 206f 6620     Thickness of 
+00018c20: 7468 6520 7375 6273 7472 6174 652e 0a20  the substrate.. 
+00018c30: 2020 2065 7073 5f72 203a 2069 6e74 206f     eps_r : int o
+00018c40: 7220 666c 6f61 740a 2020 2020 2020 2020  r float.        
+00018c50: 4469 656c 6563 7472 6963 2063 6f6e 7374  Dielectric const
+00018c60: 616e 7420 6f66 2074 6865 2073 7562 7374  ant of the subst
+00018c70: 7261 7465 2e0a 2020 2020 4c6b 5f70 6572  rate..    Lk_per
+00018c80: 5f73 7120 3a20 666c 6f61 740a 2020 2020  _sq : float.    
+00018c90: 2020 2020 4b69 6e65 7469 6320 696e 6475      Kinetic indu
+00018ca0: 6374 616e 6365 2070 6572 2073 7175 6172  ctance per squar
+00018cb0: 6520 6f66 2074 6865 206d 6963 726f 7374  e of the microst
+00018cc0: 7269 702e 0a20 2020 205a 3120 3a20 696e  rip..    Z1 : in
+00018cd0: 742c 2066 6c6f 6174 2c20 6f72 204e 6f6e  t, float, or Non
+00018ce0: 650a 2020 2020 2020 2020 496d 7065 6461  e.        Impeda
+00018cf0: 6e63 6520 6f66 2074 6865 206c 6566 7420  nce of the left 
+00018d00: 7369 6465 2072 6567 696f 6e20 6f66 2074  side region of t
+00018d10: 6865 206d 6963 726f 7374 7269 702e 0a20  he microstrip.. 
+00018d20: 2020 205a 3220 3a20 696e 742c 2066 6c6f     Z2 : int, flo
+00018d30: 6174 2c20 6f72 204e 6f6e 650a 2020 2020  at, or None.    
+00018d40: 2020 2020 496d 7065 6461 6e63 6520 6f66      Impedance of
+00018d50: 2074 6865 2072 6967 6874 2073 6964 6520   the right side 
+00018d60: 7265 6769 6f6e 206f 6620 7468 6520 6d69  region of the mi
+00018d70: 6372 6f73 7472 6970 2e0a 2020 2020 7769  crostrip..    wi
+00018d80: 6474 6831 203a 2069 6e74 2c20 666c 6f61  dth1 : int, floa
+00018d90: 742c 206f 7220 4e6f 6e65 0a20 2020 2020  t, or None.     
+00018da0: 2020 2057 6964 7468 206f 6620 7468 6520     Width of the 
+00018db0: 6c65 6674 2073 6964 6520 6f66 2074 6865  left side of the
+00018dc0: 206d 6963 726f 7374 7269 702e 0a20 2020   microstrip..   
+00018dd0: 2077 6964 7468 3220 3a20 696e 742c 2066   width2 : int, f
+00018de0: 6c6f 6174 2c20 6f72 204e 6f6e 650a 2020  loat, or None.  
+00018df0: 2020 2020 2020 5769 6474 6820 6f66 2074        Width of t
+00018e00: 6865 2072 6967 6874 2073 6964 6520 6f66  he right side of
+00018e10: 2074 6865 206d 6963 726f 7374 7269 702e   the microstrip.
+00018e20: 0a20 2020 206e 756d 5f70 7473 203a 2069  .    num_pts : i
+00018e30: 6e74 0a20 2020 2020 2020 204e 756d 6265  nt.        Numbe
+00018e40: 7220 6f66 2070 6f69 6e74 7320 636f 6d70  r of points comp
+00018e50: 7269 7369 6e67 2074 6865 2063 7572 7665  rising the curve
+00018e60: 206f 6620 7468 6520 656e 7469 7265 206d   of the entire m
+00018e70: 6963 726f 7374 7269 702e 0a20 2020 206c  icrostrip..    l
+00018e80: 6179 6572 203a 2069 6e74 2c20 6172 7261  ayer : int, arra
+00018e90: 792d 6c69 6b65 5b32 5d2c 206f 7220 7365  y-like[2], or se
+00018ea0: 740a 2020 2020 2020 2020 5370 6563 6966  t.        Specif
+00018eb0: 6963 206c 6179 6572 2873 2920 746f 2070  ic layer(s) to p
+00018ec0: 7574 2070 6f6c 7967 6f6e 2067 656f 6d65  ut polygon geome
+00018ed0: 7472 7920 6f6e 2e0a 0a20 2020 2052 6574  try on...    Ret
+00018ee0: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+00018ef0: 0a20 2020 2044 203a 2044 6576 6963 650a  .    D : Device.
+00018f00: 2020 2020 2020 2020 4120 4465 7669 6365          A Device
+00018f10: 2063 6f6e 7461 696e 696e 6720 6120 4865   containing a He
+00018f20: 636b 656e 2d74 6170 6572 6564 206d 6963  cken-tapered mic
+00018f30: 726f 7374 7269 702e 0a20 2020 2022 2222  rostrip..    """
+00018f40: 0a20 2020 2069 6620 7769 6474 6831 2069  .    if width1 i
+00018f50: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00018f60: 2020 2020 5a31 203d 205f 6d69 6372 6f73      Z1 = _micros
+00018f70: 7472 6970 5f5a 5f77 6974 685f 4c6b 280a  trip_Z_with_Lk(.
+00018f80: 2020 2020 2020 2020 2020 2020 7769 6474              widt
+00018f90: 6831 202a 2031 652d 362c 2064 6965 6c65  h1 * 1e-6, diele
+00018fa0: 6374 7269 635f 7468 6963 6b6e 6573 7320  ctric_thickness 
+00018fb0: 2a20 3165 2d36 2c20 6570 735f 722c 204c  * 1e-6, eps_r, L
+00018fc0: 6b5f 7065 725f 7371 0a20 2020 2020 2020  k_per_sq.       
+00018fd0: 2029 0a20 2020 2069 6620 7769 6474 6832   ).    if width2
+00018fe0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00018ff0: 2020 2020 2020 5a32 203d 205f 6d69 6372        Z2 = _micr
+00019000: 6f73 7472 6970 5f5a 5f77 6974 685f 4c6b  ostrip_Z_with_Lk
+00019010: 280a 2020 2020 2020 2020 2020 2020 7769  (.            wi
+00019020: 6474 6832 202a 2031 652d 362c 2064 6965  dth2 * 1e-6, die
+00019030: 6c65 6374 7269 635f 7468 6963 6b6e 6573  lectric_thicknes
+00019040: 7320 2a20 3165 2d36 2c20 6570 735f 722c  s * 1e-6, eps_r,
+00019050: 204c 6b5f 7065 725f 7371 0a20 2020 2020   Lk_per_sq.     
+00019060: 2020 2029 0a20 2020 2023 204e 6f72 6d61     ).    # Norma
+00019070: 6c69 7a65 6420 6c65 6e67 7468 206f 6620  lized length of 
+00019080: 7468 6520 7769 7265 205b 2d31 2074 6f20  the wire [-1 to 
+00019090: 2b31 5d0a 2020 2020 7869 5f6c 6973 7420  +1].    xi_list 
+000190a0: 3d20 6e70 2e6c 696e 7370 6163 6528 2d31  = np.linspace(-1
+000190b0: 2c20 312c 206e 756d 5f70 7473 290a 2020  , 1, num_pts).  
+000190c0: 2020 5a20 3d20 5b6e 702e 6578 7028 302e    Z = [np.exp(0.
+000190d0: 3520 2a20 6c6f 6728 5a31 202a 205a 3229  5 * log(Z1 * Z2)
+000190e0: 202b 2030 2e35 202a 206c 6f67 285a 3220   + 0.5 * log(Z2 
+000190f0: 2f20 5a31 2920 2a20 5f47 2878 692c 2042  / Z1) * _G(xi, B
+00019100: 2929 2066 6f72 2078 6920 696e 2078 695f  )) for xi in xi_
+00019110: 6c69 7374 5d0a 2020 2020 7769 6474 6873  list].    widths
+00019120: 203d 206e 702e 6172 7261 7928 0a20 2020   = np.array(.   
+00019130: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00019140: 2020 205f 6669 6e64 5f6d 6963 726f 7374     _find_microst
+00019150: 7269 705f 7769 7265 5f77 6964 7468 280a  rip_wire_width(.
+00019160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019170: 7a2c 2064 6965 6c65 6374 7269 635f 7468  z, dielectric_th
+00019180: 6963 6b6e 6573 7320 2a20 3165 2d36 2c20  ickness * 1e-6, 
+00019190: 6570 735f 722c 204c 6b5f 7065 725f 7371  eps_r, Lk_per_sq
+000191a0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+000191b0: 2020 2020 2020 2020 2020 202a 2031 6536             * 1e6
+000191c0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000191d0: 207a 2069 6e20 5a0a 2020 2020 2020 2020   z in Z.        
+000191e0: 5d0a 2020 2020 290a 2020 2020 7820 3d20  ].    ).    x = 
+000191f0: 2878 695f 6c69 7374 202f 2032 2920 2a20  (xi_list / 2) * 
+00019200: 6c65 6e67 7468 0a0a 2020 2020 2320 436f  length..    # Co
+00019210: 6d70 656e 7361 7465 2066 6f72 2076 6172  mpensate for var
+00019220: 7969 6e67 2073 7065 6564 206f 6620 6c69  ying speed of li
+00019230: 6768 7420 696e 2074 6865 206d 6963 726f  ght in the micro
+00019240: 7374 7269 7020 6279 2073 686f 7274 656e  strip by shorten
+00019250: 696e 670a 2020 2020 2320 616e 6420 6c65  ing.    # and le
+00019260: 6e67 7468 656e 696e 6720 7365 6374 696f  ngthening sectio
+00019270: 6e73 2061 6363 6f72 6469 6e67 2074 6f20  ns according to 
+00019280: 7468 6520 7370 6565 6420 6f66 206c 6967  the speed of lig
+00019290: 6874 2069 6e20 7468 6174 2073 6563 7469  ht in that secti
+000192a0: 6f6e 0a20 2020 2076 203d 206e 702e 6172  on.    v = np.ar
+000192b0: 7261 7928 0a20 2020 2020 2020 205b 0a20  ray(.        [. 
+000192c0: 2020 2020 2020 2020 2020 205f 6d69 6372             _micr
+000192d0: 6f73 7472 6970 5f76 5f77 6974 685f 4c6b  ostrip_v_with_Lk
+000192e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000192f0: 2020 7720 2a20 3165 2d36 2c20 6469 656c    w * 1e-6, diel
+00019300: 6563 7472 6963 5f74 6869 636b 6e65 7373  ectric_thickness
+00019310: 202a 2031 652d 362c 2065 7073 5f72 2c20   * 1e-6, eps_r, 
+00019320: 4c6b 5f70 6572 5f73 710a 2020 2020 2020  Lk_per_sq.      
+00019330: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00019340: 2020 2020 666f 7220 7720 696e 2077 6964      for w in wid
+00019350: 7468 730a 2020 2020 2020 2020 5d0a 2020  ths.        ].  
+00019360: 2020 290a 2020 2020 6478 203d 206e 702e    ).    dx = np.
+00019370: 6469 6666 2878 290a 2020 2020 6478 5f63  diff(x).    dx_c
+00019380: 6f6d 7065 6e73 6174 6564 203d 2064 7820  ompensated = dx 
+00019390: 2a20 765b 3a2d 315d 0a20 2020 2078 5f63  * v[:-1].    x_c
+000193a0: 6f6d 7065 6e73 6174 6564 203d 206e 702e  ompensated = np.
+000193b0: 6375 6d73 756d 2864 785f 636f 6d70 656e  cumsum(dx_compen
+000193c0: 7361 7465 6429 0a20 2020 2078 203d 206e  sated).    x = n
+000193d0: 702e 6873 7461 636b 285b 302c 2078 5f63  p.hstack([0, x_c
+000193e0: 6f6d 7065 6e73 6174 6564 5d29 202f 206d  ompensated]) / m
+000193f0: 6178 2878 5f63 6f6d 7065 6e73 6174 6564  ax(x_compensated
+00019400: 2920 2a20 6c65 6e67 7468 0a0a 2020 2020  ) * length..    
+00019410: 2320 4372 6561 7465 2062 6c61 6e6b 2064  # Create blank d
+00019420: 6576 6963 6520 616e 6420 6164 6420 7461  evice and add ta
+00019430: 7065 7220 706f 6c79 676f 6e0a 2020 2020  per polygon.    
+00019440: 4420 3d20 4465 7669 6365 2822 6865 636b  D = Device("heck
+00019450: 656e 2229 0a20 2020 2078 7074 7320 3d20  en").    xpts = 
+00019460: 6e70 2e63 6f6e 6361 7465 6e61 7465 285b  np.concatenate([
+00019470: 782c 2078 5b3a 3a2d 315d 5d29 0a20 2020  x, x[::-1]]).   
+00019480: 2079 7074 7320 3d20 6e70 2e63 6f6e 6361   ypts = np.conca
+00019490: 7465 6e61 7465 285b 7769 6474 6873 202f  tenate([widths /
+000194a0: 2032 2c20 2d77 6964 7468 735b 3a3a 2d31   2, -widths[::-1
+000194b0: 5d20 2f20 325d 290a 2020 2020 442e 6164  ] / 2]).    D.ad
+000194c0: 645f 706f 6c79 676f 6e28 2878 7074 732c  d_polygon((xpts,
+000194d0: 2079 7074 7329 2c20 6c61 7965 723d 6c61   ypts), layer=la
+000194e0: 7965 7229 0a20 2020 2044 2e61 6464 5f70  yer).    D.add_p
+000194f0: 6f72 7428 6e61 6d65 3d31 2c20 6d69 6470  ort(name=1, midp
+00019500: 6f69 6e74 3d28 302c 2030 292c 2077 6964  oint=(0, 0), wid
+00019510: 7468 3d77 6964 7468 735b 305d 2c20 6f72  th=widths[0], or
+00019520: 6965 6e74 6174 696f 6e3d 3138 3029 0a20  ientation=180). 
+00019530: 2020 2044 2e61 6464 5f70 6f72 7428 6e61     D.add_port(na
+00019540: 6d65 3d32 2c20 6d69 6470 6f69 6e74 3d28  me=2, midpoint=(
+00019550: 6c65 6e67 7468 2c20 3029 2c20 7769 6474  length, 0), widt
+00019560: 683d 7769 6474 6873 5b2d 315d 2c20 6f72  h=widths[-1], or
+00019570: 6965 6e74 6174 696f 6e3d 3029 0a0a 2020  ientation=0)..  
+00019580: 2020 2320 4164 6420 6d65 7461 2069 6e66    # Add meta inf
+00019590: 6f72 6d61 7469 6f6e 2061 626f 7574 2074  ormation about t
+000195a0: 6865 2074 6170 6572 0a20 2020 2044 2e69  he taper.    D.i
+000195b0: 6e66 6f5b 226e 756d 5f73 7175 6172 6573  nfo["num_squares
+000195c0: 225d 203d 206e 702e 7375 6d28 6e70 2e64  "] = np.sum(np.d
+000195d0: 6966 6628 7829 202f 2077 6964 7468 735b  iff(x) / widths[
+000195e0: 3a2d 315d 290a 2020 2020 442e 696e 666f  :-1]).    D.info
+000195f0: 5b22 7769 6474 6831 225d 203d 2077 6964  ["width1"] = wid
+00019600: 7468 735b 305d 0a20 2020 2044 2e69 6e66  ths[0].    D.inf
+00019610: 6f5b 2277 6964 7468 3222 5d20 3d20 7769  o["width2"] = wi
+00019620: 6474 6873 5b2d 315d 0a20 2020 2044 2e69  dths[-1].    D.i
+00019630: 6e66 6f5b 225a 3122 5d20 3d20 5a5b 305d  nfo["Z1"] = Z[0]
+00019640: 0a20 2020 2044 2e69 6e66 6f5b 225a 3222  .    D.info["Z2"
+00019650: 5d20 3d20 5a5b 2d31 5d0a 2020 2020 2320  ] = Z[-1].    # 
+00019660: 4e6f 7465 2074 6865 7265 2061 7265 2074  Note there are t
+00019670: 776f 2076 616c 7565 7320 666f 7220 762f  wo values for v/
+00019680: 6320 2861 6e64 2066 5f63 7574 6f66 6629  c (and f_cutoff)
+00019690: 2062 6563 6175 7365 2074 6865 2073 7065   because the spe
+000196a0: 6564 206f 660a 2020 2020 2320 6c69 6768  ed of.    # ligh
+000196b0: 7420 6973 2064 6966 6665 7265 6e74 2061  t is different a
+000196c0: 7420 7468 6520 6265 6769 6e6e 696e 6720  t the beginning 
+000196d0: 616e 6420 656e 6420 6f66 2074 6865 2074  and end of the t
+000196e0: 6170 6572 0a20 2020 2044 2e69 6e66 6f5b  aper.    D.info[
+000196f0: 2277 225d 203d 2077 6964 7468 730a 2020  "w"] = widths.  
+00019700: 2020 442e 696e 666f 5b22 7822 5d20 3d20    D.info["x"] = 
+00019710: 780a 2020 2020 442e 696e 666f 5b22 5a22  x.    D.info["Z"
+00019720: 5d20 3d20 5a0a 2020 2020 442e 696e 666f  ] = Z.    D.info
+00019730: 5b22 762f 6322 5d20 3d20 7620 2f20 3365  ["v/c"] = v / 3e
+00019740: 380a 2020 2020 442e 696e 666f 5b22 7469  8.    D.info["ti
+00019750: 6d65 5f6c 656e 6774 6822 5d20 3d20 6e70  me_length"] = np
+00019760: 2e73 756d 280a 2020 2020 2020 2020 6e70  .sum(.        np
+00019770: 2e64 6966 6628 442e 696e 666f 5b22 7822  .diff(D.info["x"
+00019780: 5d20 2a20 3165 2d36 2920 2f20 2844 2e69  ] * 1e-6) / (D.i
+00019790: 6e66 6f5b 2276 2f63 225d 5b3a 2d31 5d20  nfo["v/c"][:-1] 
+000197a0: 2a20 3365 3829 0a20 2020 2029 0a20 2020  * 3e8).    ).   
+000197b0: 2044 2e69 6e66 6f5b 2266 5f63 7574 6f66   D.info["f_cutof
+000197c0: 6622 5d20 3d20 3120 2f20 2832 202a 2044  f"] = 1 / (2 * D
+000197d0: 2e69 6e66 6f5b 2274 696d 655f 6c65 6e67  .info["time_leng
+000197e0: 7468 225d 290a 2020 2020 442e 696e 666f  th"]).    D.info
+000197f0: 5b22 6c65 6e67 7468 225d 203d 206c 656e  ["length"] = len
+00019800: 6774 680a 0a20 2020 2072 6574 7572 6e20  gth..    return 
+00019810: 440a 0a0a 4064 6576 6963 655f 6c72 755f  D...@device_lru_
+00019820: 6361 6368 650a 6465 6620 6d65 616e 6465  cache.def meande
+00019830: 725f 7461 7065 7228 0a20 2020 2078 5f74  r_taper(.    x_t
+00019840: 6170 6572 2c20 775f 7461 7065 722c 206d  aper, w_taper, m
+00019850: 6561 6e64 6572 5f6c 656e 6774 683d 3130  eander_length=10
+00019860: 3030 2c20 7370 6163 696e 675f 6661 6374  00, spacing_fact
+00019870: 6f72 3d33 2c20 6d69 6e5f 7370 6163 696e  or=3, min_spacin
+00019880: 673d 302e 352c 206c 6179 6572 3d30 0a29  g=0.5, layer=0.)
+00019890: 3a0a 2020 2020 2222 2254 616b 6573 2069  :.    """Takes i
+000198a0: 6e20 616e 2061 7272 6179 206f 6620 782d  n an array of x-
+000198b0: 706f 7369 7469 6f6e 7320 616e 6420 6120  positions and a 
+000198c0: 6172 7261 7920 6f66 2077 6964 7468 7320  array of widths 
+000198d0: 2863 6f72 7265 7370 6f6e 6469 6e67 2074  (corresponding t
+000198e0: 6f0a 2020 2020 6561 6368 2078 2d70 6f73  o.    each x-pos
+000198f0: 6974 696f 6e29 2061 6e64 2063 7265 6174  ition) and creat
+00019900: 6573 2061 206d 6561 6e64 6572 2e20 2054  es a meander.  T
+00019910: 7970 6963 616c 6c79 2075 7365 6420 666f  ypically used fo
+00019920: 7220 6372 6561 7469 6e67 0a20 2020 206d  r creating.    m
+00019930: 6561 6e64 6572 6564 2074 6170 6572 730a  eandered tapers.
+00019940: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00019950: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00019960: 2020 2078 5f74 6170 6572 203a 2061 7272     x_taper : arr
+00019970: 6179 2d6c 696b 655b 4e5d 0a20 2020 2020  ay-like[N].     
+00019980: 2020 2054 6865 2078 2d63 6f6f 7264 696e     The x-coordin
+00019990: 6174 6573 206f 6620 7468 6520 6461 7461  ates of the data
+000199a0: 2070 6f69 6e74 732c 206d 7573 7420 6265   points, must be
+000199b0: 2069 6e63 7265 6173 696e 672e 0a20 2020   increasing..   
+000199c0: 2077 5f74 6170 6572 203a 2061 7272 6179   w_taper : array
+000199d0: 2d6c 696b 655b 4e5d 0a20 2020 2020 2020  -like[N].       
+000199e0: 2054 6865 2079 2d63 6f6f 7264 696e 6174   The y-coordinat
+000199f0: 6573 206f 6620 7468 6520 6461 7461 2070  es of the data p
+00019a00: 6f69 6e74 732c 2073 616d 6520 6c65 6e67  oints, same leng
+00019a10: 7468 2061 7320 6060 785f 7461 7065 7260  th as ``x_taper`
+00019a20: 602e 0a20 2020 206d 6561 6e64 6572 5f6c  `..    meander_l
+00019a30: 656e 6774 6820 3a20 696e 7420 6f72 2066  ength : int or f
+00019a40: 6c6f 6174 0a20 2020 2020 2020 204c 656e  loat.        Len
+00019a50: 6774 6820 6f66 2065 6163 6820 7365 6374  gth of each sect
+00019a60: 696f 6e20 6f66 2074 6865 206d 6561 6e64  ion of the meand
+00019a70: 6572 0a20 2020 2073 7061 6369 6e67 5f66  er.    spacing_f
+00019a80: 6163 746f 7220 3a20 696e 7420 6f72 2066  actor : int or f
+00019a90: 6c6f 6174 0a20 2020 2020 2020 204d 756c  loat.        Mul
+00019aa0: 7469 706c 6963 6174 6976 6520 7370 6163  tiplicative spac
+00019ab0: 696e 6720 6661 6374 6f72 2062 6574 7765  ing factor betwe
+00019ac0: 656e 2061 646a 6163 656e 7420 6d65 616e  en adjacent mean
+00019ad0: 6465 7273 0a20 2020 206d 696e 5f73 7061  ders.    min_spa
+00019ae0: 6369 6e67 203a 2069 6e74 206f 7220 666c  cing : int or fl
+00019af0: 6f61 740a 2020 2020 2020 2020 4d69 6e69  oat.        Mini
+00019b00: 6d75 6d20 7370 6163 696e 6720 6265 7477  mum spacing betw
+00019b10: 6565 6e20 6164 6a61 6365 6e74 206d 6561  een adjacent mea
+00019b20: 6e64 6572 730a 0a20 2020 206c 6179 6572  nders..    layer
+00019b30: 203a 2069 6e74 2c20 6172 7261 792d 6c69   : int, array-li
+00019b40: 6b65 5b32 5d2c 206f 7220 7365 740a 2020  ke[2], or set.  
+00019b50: 2020 2020 2020 5370 6563 6966 6963 206c        Specific l
+00019b60: 6179 6572 2873 2920 746f 2070 7574 2070  ayer(s) to put p
+00019b70: 6f6c 7967 6f6e 2067 656f 6d65 7472 7920  olygon geometry 
+00019b80: 6f6e 2e0a 0a20 2020 2052 6574 7572 6e73  on...    Returns
+00019b90: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+00019ba0: 2044 203a 2044 6576 6963 650a 0a20 2020   D : Device..   
+00019bb0: 2022 2222 0a0a 2020 2020 6465 6620 7461   """..    def ta
+00019bc0: 7065 725f 7769 6474 6828 7829 3a0a 2020  per_width(x):.  
+00019bd0: 2020 2020 2020 7265 7475 726e 206e 702e        return np.
+00019be0: 696e 7465 7270 2878 2c20 785f 7461 7065  interp(x, x_tape
+00019bf0: 722c 2077 5f74 6170 6572 290a 0a20 2020  r, w_taper)..   
+00019c00: 2064 6566 2074 6170 6572 5f73 6563 7469   def taper_secti
+00019c10: 6f6e 2878 5f73 7461 7274 2c20 785f 656e  on(x_start, x_en
+00019c20: 642c 206e 756d 5f70 7473 3d33 302c 206c  d, num_pts=30, l
+00019c30: 6179 6572 3d30 293a 0a20 2020 2020 2020  ayer=0):.       
+00019c40: 2044 203d 2044 6576 6963 6528 2274 6170   D = Device("tap
+00019c50: 6572 7365 6322 290a 2020 2020 2020 2020  ersec").        
+00019c60: 6c65 6e67 7468 203d 2078 5f65 6e64 202d  length = x_end -
+00019c70: 2078 5f73 7461 7274 0a20 2020 2020 2020   x_start.       
+00019c80: 2078 203d 206e 702e 6c69 6e73 7061 6365   x = np.linspace
+00019c90: 2830 2c20 6c65 6e67 7468 2c20 6e75 6d5f  (0, length, num_
+00019ca0: 7074 7329 0a20 2020 2020 2020 2077 6964  pts).        wid
+00019cb0: 7468 7320 3d20 6e70 2e6c 696e 7370 6163  ths = np.linspac
+00019cc0: 6528 7461 7065 725f 7769 6474 6828 785f  e(taper_width(x_
+00019cd0: 7374 6172 7429 2c20 7461 7065 725f 7769  start), taper_wi
+00019ce0: 6474 6828 785f 656e 6429 2c20 6e75 6d5f  dth(x_end), num_
+00019cf0: 7074 7329 0a20 2020 2020 2020 2078 7074  pts).        xpt
+00019d00: 7320 3d20 6e70 2e63 6f6e 6361 7465 6e61  s = np.concatena
+00019d10: 7465 285b 782c 2078 5b3a 3a2d 315d 5d29  te([x, x[::-1]])
+00019d20: 0a20 2020 2020 2020 2079 7074 7320 3d20  .        ypts = 
+00019d30: 6e70 2e63 6f6e 6361 7465 6e61 7465 285b  np.concatenate([
+00019d40: 7769 6474 6873 202f 2032 2c20 2d77 6964  widths / 2, -wid
+00019d50: 7468 735b 3a3a 2d31 5d20 2f20 325d 290a  ths[::-1] / 2]).
+00019d60: 2020 2020 2020 2020 442e 6164 645f 706f          D.add_po
+00019d70: 6c79 676f 6e28 2878 7074 732c 2079 7074  lygon((xpts, ypt
+00019d80: 7329 2c20 6c61 7965 723d 6c61 7965 7229  s), layer=layer)
+00019d90: 0a20 2020 2020 2020 2044 2e61 6464 5f70  .        D.add_p
+00019da0: 6f72 7428 6e61 6d65 3d31 2c20 6d69 6470  ort(name=1, midp
+00019db0: 6f69 6e74 3d28 302c 2030 292c 2077 6964  oint=(0, 0), wid
+00019dc0: 7468 3d77 6964 7468 735b 305d 2c20 6f72  th=widths[0], or
+00019dd0: 6965 6e74 6174 696f 6e3d 3138 3029 0a20  ientation=180). 
+00019de0: 2020 2020 2020 2044 2e61 6464 5f70 6f72         D.add_por
+00019df0: 7428 6e61 6d65 3d32 2c20 6d69 6470 6f69  t(name=2, midpoi
+00019e00: 6e74 3d28 6c65 6e67 7468 2c20 3029 2c20  nt=(length, 0), 
+00019e10: 7769 6474 683d 7769 6474 6873 5b2d 315d  width=widths[-1]
+00019e20: 2c20 6f72 6965 6e74 6174 696f 6e3d 3029  , orientation=0)
+00019e30: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00019e40: 440a 0a20 2020 2064 6566 2061 7263 5f74  D..    def arc_t
+00019e50: 6170 6572 6564 280a 2020 2020 2020 2020  apered(.        
+00019e60: 7261 6469 7573 3d31 302c 2077 6964 7468  radius=10, width
+00019e70: 313d 312c 2077 6964 7468 323d 322c 2074  1=1, width2=2, t
+00019e80: 6865 7461 3d34 352c 2061 6e67 6c65 5f72  heta=45, angle_r
+00019e90: 6573 6f6c 7574 696f 6e3d 322e 352c 206c  esolution=2.5, l
+00019ea0: 6179 6572 3d30 0a20 2020 2029 3a0a 2020  ayer=0.    ):.  
+00019eb0: 2020 2020 2020 4420 3d20 4465 7669 6365        D = Device
+00019ec0: 2822 6172 6374 6170 6572 2229 0a20 2020  ("arctaper").   
+00019ed0: 2020 2020 2070 6174 6831 203d 2067 6473       path1 = gds
+00019ee0: 7079 2e50 6174 6828 7769 6474 683d 7769  py.Path(width=wi
+00019ef0: 6474 6831 2c20 696e 6974 6961 6c5f 706f  dth1, initial_po
+00019f00: 696e 743d 2830 2c20 3029 290a 2020 2020  int=(0, 0)).    
+00019f10: 2020 2020 7061 7468 312e 7475 726e 280a      path1.turn(.
+00019f20: 2020 2020 2020 2020 2020 2020 7261 6469              radi
+00019f30: 7573 3d72 6164 6975 732c 0a20 2020 2020  us=radius,.     
+00019f40: 2020 2020 2020 2061 6e67 6c65 3d74 6865         angle=the
+00019f50: 7461 202a 2070 6920 2f20 3138 302c 0a20  ta * pi / 180,. 
+00019f60: 2020 2020 2020 2020 2020 206e 756d 6265             numbe
+00019f70: 725f 6f66 5f70 6f69 6e74 733d 696e 7428  r_of_points=int(
+00019f80: 6162 7328 3220 2a20 7468 6574 6120 2f20  abs(2 * theta / 
+00019f90: 616e 676c 655f 7265 736f 6c75 7469 6f6e  angle_resolution
+00019fa0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+00019fb0: 6669 6e61 6c5f 7769 6474 683d 7769 6474  final_width=widt
+00019fc0: 6832 2c0a 2020 2020 2020 2020 290a 2020  h2,.        ).  
+00019fd0: 2020 2020 2020 5b44 2e61 6464 5f70 6f6c        [D.add_pol
+00019fe0: 7967 6f6e 2870 2c20 6c61 7965 723d 6c61  ygon(p, layer=la
+00019ff0: 7965 7229 2066 6f72 2070 2069 6e20 7061  yer) for p in pa
+0001a000: 7468 312e 706f 6c79 676f 6e73 5d0a 2020  th1.polygons].  
+0001a010: 2020 2020 2020 442e 6164 645f 706f 7274        D.add_port
+0001a020: 286e 616d 653d 312c 206d 6964 706f 696e  (name=1, midpoin
+0001a030: 743d 2830 2c20 3029 2c20 7769 6474 683d  t=(0, 0), width=
+0001a040: 7769 6474 6831 2c20 6f72 6965 6e74 6174  width1, orientat
+0001a050: 696f 6e3d 3138 3029 0a20 2020 2020 2020  ion=180).       
+0001a060: 2044 2e61 6464 5f70 6f72 7428 0a20 2020   D.add_port(.   
+0001a070: 2020 2020 2020 2020 206e 616d 653d 322c           name=2,
+0001a080: 0a20 2020 2020 2020 2020 2020 206d 6964  .            mid
+0001a090: 706f 696e 743d 2870 6174 6831 2e78 2c20  point=(path1.x, 
+0001a0a0: 7061 7468 312e 7929 2c0a 2020 2020 2020  path1.y),.      
+0001a0b0: 2020 2020 2020 7769 6474 683d 7769 6474        width=widt
+0001a0c0: 6832 2c0a 2020 2020 2020 2020 2020 2020  h2,.            
+0001a0d0: 6f72 6965 6e74 6174 696f 6e3d 7061 7468  orientation=path
+0001a0e0: 312e 6469 7265 6374 696f 6e20 2a20 3138  1.direction * 18
+0001a0f0: 3020 2f20 7069 2c0a 2020 2020 2020 2020  0 / pi,.        
+0001a100: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0001a110: 2044 0a0a 2020 2020 4420 3d20 4465 7669   D..    D = Devi
+0001a120: 6365 2822 6d65 616e 6465 722d 7461 7065  ce("meander-tape
+0001a130: 7222 290a 2020 2020 7870 6f73 3120 3d20  r").    xpos1 = 
+0001a140: 6d69 6e28 785f 7461 7065 7229 0a20 2020  min(x_taper).   
+0001a150: 2078 706f 7332 203d 206d 696e 2878 5f74   xpos2 = min(x_t
+0001a160: 6170 6572 2920 2b20 6d65 616e 6465 725f  aper) + meander_
+0001a170: 6c65 6e67 7468 0a20 2020 2074 203d 2044  length.    t = D
+0001a180: 2e61 6464 5f72 6566 2874 6170 6572 5f73  .add_ref(taper_s
+0001a190: 6563 7469 6f6e 2878 5f73 7461 7274 3d78  ection(x_start=x
+0001a1a0: 706f 7331 2c20 785f 656e 643d 7870 6f73  pos1, x_end=xpos
+0001a1b0: 322c 206e 756d 5f70 7473 3d35 302c 206c  2, num_pts=50, l
+0001a1c0: 6179 6572 3d6c 6179 6572 2929 0a20 2020  ayer=layer)).   
+0001a1d0: 2044 2e61 6464 5f70 6f72 7428 742e 706f   D.add_port(t.po
+0001a1e0: 7274 735b 315d 290a 2020 2020 6469 725f  rts[1]).    dir_
+0001a1f0: 746f 6767 6c65 203d 202d 310a 2020 2020  toggle = -1.    
+0001a200: 7768 696c 6520 7870 6f73 3220 3c20 6d61  while xpos2 < ma
+0001a210: 7828 785f 7461 7065 7229 3a0a 2020 2020  x(x_taper):.    
+0001a220: 2020 2020 6172 635f 7769 6474 6831 203d      arc_width1 =
+0001a230: 2074 6170 6572 5f77 6964 7468 2878 706f   taper_width(xpo
+0001a240: 7332 290a 2020 2020 2020 2020 6172 635f  s2).        arc_
+0001a250: 7261 6469 7573 203d 206d 6178 2873 7061  radius = max(spa
+0001a260: 6369 6e67 5f66 6163 746f 7220 2a20 6172  cing_factor * ar
+0001a270: 635f 7769 6474 6831 2c20 6d69 6e5f 7370  c_width1, min_sp
+0001a280: 6163 696e 6729 0a20 2020 2020 2020 2061  acing).        a
+0001a290: 7263 5f6c 656e 6774 6820 3d20 7069 202a  rc_length = pi *
+0001a2a0: 2061 7263 5f72 6164 6975 730a 2020 2020   arc_radius.    
+0001a2b0: 2020 2020 6172 635f 7769 6474 6832 203d      arc_width2 =
+0001a2c0: 2074 6170 6572 5f77 6964 7468 2878 706f   taper_width(xpo
+0001a2d0: 7332 202b 2061 7263 5f6c 656e 6774 6829  s2 + arc_length)
+0001a2e0: 0a20 2020 2020 2020 2041 203d 2061 7263  .        A = arc
+0001a2f0: 5f74 6170 6572 6564 280a 2020 2020 2020  _tapered(.      
+0001a300: 2020 2020 2020 7261 6469 7573 3d61 7263        radius=arc
+0001a310: 5f72 6164 6975 732c 0a20 2020 2020 2020  _radius,.       
+0001a320: 2020 2020 2077 6964 7468 313d 6172 635f       width1=arc_
+0001a330: 7769 6474 6831 2c0a 2020 2020 2020 2020  width1,.        
+0001a340: 2020 2020 7769 6474 6832 3d61 7263 5f77      width2=arc_w
+0001a350: 6964 7468 322c 0a20 2020 2020 2020 2020  idth2,.         
+0001a360: 2020 2074 6865 7461 3d31 3830 202a 2064     theta=180 * d
+0001a370: 6972 5f74 6f67 676c 652c 0a20 2020 2020  ir_toggle,.     
+0001a380: 2020 2020 2020 206c 6179 6572 3d6c 6179         layer=lay
+0001a390: 6572 2c0a 2020 2020 2020 2020 290a 2020  er,.        ).  
+0001a3a0: 2020 2020 2020 6120 3d20 442e 6164 645f        a = D.add_
+0001a3b0: 7265 6628 4129 0a20 2020 2020 2020 2061  ref(A).        a
+0001a3c0: 2e63 6f6e 6e65 6374 2870 6f72 743d 312c  .connect(port=1,
+0001a3d0: 2064 6573 7469 6e61 7469 6f6e 3d74 2e70   destination=t.p
+0001a3e0: 6f72 7473 5b32 5d29 0a20 2020 2020 2020  orts[2]).       
+0001a3f0: 2064 6972 5f74 6f67 676c 6520 3d20 2d64   dir_toggle = -d
+0001a400: 6972 5f74 6f67 676c 650a 2020 2020 2020  ir_toggle.      
+0001a410: 2020 7870 6f73 3120 3d20 7870 6f73 3220    xpos1 = xpos2 
+0001a420: 2b20 6172 635f 6c65 6e67 7468 0a20 2020  + arc_length.   
+0001a430: 2020 2020 2078 706f 7332 203d 2078 706f       xpos2 = xpo
+0001a440: 7331 202b 206d 6561 6e64 6572 5f6c 656e  s1 + meander_len
+0001a450: 6774 680a 2020 2020 2020 2020 7420 3d20  gth.        t = 
+0001a460: 442e 6164 645f 7265 6628 0a20 2020 2020  D.add_ref(.     
+0001a470: 2020 2020 2020 2074 6170 6572 5f73 6563         taper_sec
+0001a480: 7469 6f6e 2878 5f73 7461 7274 3d78 706f  tion(x_start=xpo
+0001a490: 7331 2c20 785f 656e 643d 7870 6f73 322c  s1, x_end=xpos2,
+0001a4a0: 206e 756d 5f70 7473 3d33 302c 206c 6179   num_pts=30, lay
+0001a4b0: 6572 3d6c 6179 6572 290a 2020 2020 2020  er=layer).      
+0001a4c0: 2020 290a 2020 2020 2020 2020 742e 636f    ).        t.co
+0001a4d0: 6e6e 6563 7428 706f 7274 3d31 2c20 6465  nnect(port=1, de
+0001a4e0: 7374 696e 6174 696f 6e3d 612e 706f 7274  stination=a.port
+0001a4f0: 735b 325d 290a 2020 2020 442e 6164 645f  s[2]).    D.add_
+0001a500: 706f 7274 2874 2e70 6f72 7473 5b32 5d29  port(t.ports[2])
+0001a510: 0a0a 2020 2020 7265 7475 726e 2044 0a0a  ..    return D..
+0001a520: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
+0001a530: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001a540: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001a550: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001a560: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001a570: 3d0a 2320 4578 616d 706c 6520 636f 6465  =.# Example code
+0001a580: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
+0001a590: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001a5a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001a5b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001a5c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001a5d0: 3d0a 0a23 2044 203d 2072 6163 6574 7261  =..# D = racetra
+0001a5e0: 636b 5f67 7261 6475 616c 2877 6964 7468  ck_gradual(width
+0001a5f0: 2c20 5220 3d20 352c 204e 3d33 290a 2320  , R = 5, N=3).# 
+0001a600: 7175 6963 6b70 6c6f 7428 4429 0a0a 2320  quickplot(D)..# 
+0001a610: 4420 3d20 6865 636b 656e 5f74 6170 6572  D = hecken_taper
+0001a620: 286c 656e 6774 6820 3d20 3230 302c 2042  (length = 200, B
+0001a630: 203d 2034 2e30 3039 312c 2064 6965 6c65   = 4.0091, diele
+0001a640: 6374 7269 635f 7468 6963 6b6e 6573 7320  ctric_thickness 
+0001a650: 3d20 302e 3235 2c20 6570 735f 7220 3d20  = 0.25, eps_r = 
+0001a660: 322c 0a23 2020 2020 2020 2020 2020 2020  2,.#            
+0001a670: 2020 2020 2020 4c6b 5f70 6572 5f73 7120        Lk_per_sq 
+0001a680: 3d20 3235 3065 2d31 322c 205a 3120 3d20  = 250e-12, Z1 = 
+0001a690: 3530 2c20 7769 6474 6832 203d 2030 2e33  50, width2 = 0.3
+0001a6a0: 2c0a 2320 2020 2020 2020 2020 2020 2020  ,.#             
+0001a6b0: 2020 2020 206e 756d 5f70 7473 203d 2031       num_pts = 1
+0001a6c0: 3030 2c20 6c61 7965 7220 3d20 3029 0a23  00, layer = 0).#
+0001a6d0: 2071 7569 636b 706c 6f74 2844 290a 0a23   quickplot(D)..#
+0001a6e0: 2074 203d 206e 702e 6c69 6e73 7061 6365   t = np.linspace
+0001a6f0: 2830 2c31 290a 2320 782c 7920 3d20 5f72  (0,1).# x,y = _r
+0001a700: 6163 6574 7261 636b 5f67 7261 6475 616c  acetrack_gradual
+0001a710: 5f70 6172 616d 6574 7269 6328 742c 2052  _parametric(t, R
+0001a720: 203d 2035 2c20 4e20 3d20 3329 0a23 2070   = 5, N = 3).# p
+0001a730: 6c74 2e70 6c6f 7428 782c 7929 0a23 2070  lt.plot(x,y).# p
+0001a740: 6c74 2e61 7869 7328 2765 7175 616c 2729  lt.axis('equal')
+0001a750: 0a0a 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d  ...# ===========
+0001a760: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001a770: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001a780: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001a790: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001a7a0: 3d3d 3d0a 230a 2320 5465 7874 0a23 0a23  ===.#.# Text.#.#
+0001a7b0: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
+0001a7c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001a7d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001a7e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001a7f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
+0001a800: 0a0a 6465 6620 7465 7874 2874 6578 743d  ..def text(text=
+0001a810: 2261 6263 6422 2c20 7369 7a65 3d31 302c  "abcd", size=10,
+0001a820: 206a 7573 7469 6679 3d22 6c65 6674 222c   justify="left",
+0001a830: 206c 6179 6572 3d30 2c20 666f 6e74 3d22   layer=0, font="
+0001a840: 4445 504c 4f46 2229 3a0a 2020 2020 2222  DEPLOF"):.    ""
+0001a850: 2243 7265 6174 6573 2067 656f 6d65 7472  "Creates geometr
+0001a860: 6965 7320 6f66 2074 6578 740a 0a20 2020  ies of text..   
+0001a870: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+0001a880: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2074  ----------.    t
+0001a890: 6578 7420 3a20 7374 720a 2020 2020 2020  ext : str.      
+0001a8a0: 2020 5465 7874 2073 7472 696e 6720 746f    Text string to
+0001a8b0: 2062 6520 7772 6974 7465 6e2e 0a20 2020   be written..   
+0001a8c0: 2073 697a 6520 3a20 696e 7420 6f72 2066   size : int or f
+0001a8d0: 6c6f 6174 0a20 2020 2020 2020 2053 697a  loat.        Siz
+0001a8e0: 6520 6f66 2074 6865 2074 6578 740a 2020  e of the text.  
+0001a8f0: 2020 6a75 7374 6966 7920 3a20 7b27 6c65    justify : {'le
+0001a900: 6674 272c 2027 7269 6768 7427 2c20 2763  ft', 'right', 'c
+0001a910: 656e 7465 7227 7d0a 2020 2020 2020 2020  enter'}.        
+0001a920: 4a75 7374 6966 6963 6174 696f 6e20 6f66  Justification of
+0001a930: 2074 6865 2074 6578 742e 0a20 2020 206c   the text..    l
+0001a940: 6179 6572 203a 2069 6e74 2c20 6172 7261  ayer : int, arra
+0001a950: 792d 6c69 6b65 5b32 5d2c 206f 7220 7365  y-like[2], or se
+0001a960: 740a 2020 2020 2020 2020 5370 6563 6966  t.        Specif
+0001a970: 6963 206c 6179 6572 2873 2920 746f 2070  ic layer(s) to p
+0001a980: 7574 2070 6f6c 7967 6f6e 2067 656f 6d65  ut polygon geome
+0001a990: 7472 7920 6f6e 2e0a 2020 2020 666f 6e74  try on..    font
+0001a9a0: 3a20 7374 720a 2020 2020 2020 2020 466f  : str.        Fo
+0001a9b0: 6e74 2066 6163 6520 746f 2075 7365 2e20  nt face to use. 
+0001a9c0: 4465 6661 756c 7420 4445 504c 4f46 2064  Default DEPLOF d
+0001a9d0: 6f65 7320 6e6f 7420 7265 7175 6972 6520  oes not require 
+0001a9e0: 6164 6469 7469 6f6e 616c 206c 6962 7261  additional libra
+0001a9f0: 7269 6573 2c20 6f74 6865 7277 6973 650a  ries, otherwise.
+0001aa00: 2020 2020 2020 2020 6672 6565 7479 7065          freetype
+0001aa10: 2077 696c 6c20 6265 2075 7365 6420 746f   will be used to
+0001aa20: 206c 6f61 6420 666f 6e74 732e 2046 6f6e   load fonts. Fon
+0001aa30: 7420 6361 6e20 6265 2067 6976 656e 2065  t can be given e
+0001aa40: 6974 6865 7220 6279 206e 616d 6520 2865  ither by name (e
+0001aa50: 2e67 2e20 2254 696d 6573 204e 6577 2052  .g. "Times New R
+0001aa60: 6f6d 616e 2229 2c0a 2020 2020 2020 2020  oman"),.        
+0001aa70: 6f72 2062 7920 6669 6c65 2070 6174 682e  or by file path.
+0001aa80: 204f 5446 206f 7220 5454 4620 666f 6e74   OTF or TTF font
+0001aa90: 7320 6172 6520 7375 7070 6f72 7465 642e  s are supported.
+0001aaa0: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+0001aab0: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 7420    -------.    t 
+0001aac0: 3a20 4465 7669 6365 0a20 2020 2020 2020  : Device.       
+0001aad0: 2041 2044 6576 6963 6520 636f 6e74 6169   A Device contai
+0001aae0: 6e69 6e67 2074 6865 2074 6578 7420 6765  ning the text ge
+0001aaf0: 6f6d 6574 7279 2e0a 2020 2020 2222 220a  ometry..    """.
+0001ab00: 2020 2020 7420 3d20 4465 7669 6365 2822      t = Device("
+0001ab10: 7465 7874 2229 0a20 2020 2078 6f66 6673  text").    xoffs
+0001ab20: 6574 203d 2030 0a20 2020 2079 6f66 6673  et = 0.    yoffs
+0001ab30: 6574 203d 2030 0a0a 2020 2020 6661 6365  et = 0..    face
+0001ab40: 203d 2066 6f6e 740a 2020 2020 6966 2066   = font.    if f
+0001ab50: 6163 6520 3d3d 2022 4445 504c 4f46 223a  ace == "DEPLOF":
+0001ab60: 0a20 2020 2020 2020 2073 6361 6c69 6e67  .        scaling
+0001ab70: 203d 2073 697a 6520 2f20 3130 3030 0a0a   = size / 1000..
+0001ab80: 2020 2020 2020 2020 666f 7220 6c69 6e65          for line
+0001ab90: 2069 6e20 7465 7874 2e73 706c 6974 2822   in text.split("
+0001aba0: 5c6e 2229 3a0a 2020 2020 2020 2020 2020  \n"):.          
+0001abb0: 2020 6c20 3d20 4465 7669 6365 286e 616d    l = Device(nam
+0001abc0: 653d 2274 6578 746c 696e 6522 290a 2020  e="textline").  
+0001abd0: 2020 2020 2020 2020 2020 666f 7220 6320            for c 
+0001abe0: 696e 206c 696e 653a 0a20 2020 2020 2020  in line:.       
+0001abf0: 2020 2020 2020 2020 2061 7363 6969 5f76           ascii_v
+0001ac00: 616c 203d 206f 7264 2863 290a 2020 2020  al = ord(c).    
+0001ac10: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+0001ac20: 203d 3d20 2220 223a 0a20 2020 2020 2020   == " ":.       
+0001ac30: 2020 2020 2020 2020 2020 2020 2078 6f66               xof
+0001ac40: 6673 6574 202b 3d20 3530 3020 2a20 7363  fset += 500 * sc
+0001ac50: 616c 696e 670a 2020 2020 2020 2020 2020  aling.          
+0001ac60: 2020 2020 2020 656c 6966 2028 3333 203c        elif (33 <
+0001ac70: 3d20 6173 6369 695f 7661 6c20 3c3d 2031  = ascii_val <= 1
+0001ac80: 3236 2920 6f72 2028 6173 6369 695f 7661  26) or (ascii_va
+0001ac90: 6c20 3d3d 2031 3831 293a 0a20 2020 2020  l == 181):.     
+0001aca0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001acb0: 6f72 2070 6f6c 7920 696e 205f 676c 7970  or poly in _glyp
+0001acc0: 685b 6173 6369 695f 7661 6c5d 3a0a 2020  h[ascii_val]:.  
+0001acd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ace0: 2020 2020 2020 7870 7473 203d 206e 702e        xpts = np.
+0001acf0: 6172 7261 7928 706f 6c79 295b 3a2c 2030  array(poly)[:, 0
+0001ad00: 5d20 2a20 7363 616c 696e 670a 2020 2020  ] * scaling.    
+0001ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad20: 2020 2020 7970 7473 203d 206e 702e 6172      ypts = np.ar
+0001ad30: 7261 7928 706f 6c79 295b 3a2c 2031 5d20  ray(poly)[:, 1] 
+0001ad40: 2a20 7363 616c 696e 670a 2020 2020 2020  * scaling.      
+0001ad50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad60: 2020 6c2e 6164 645f 706f 6c79 676f 6e28    l.add_polygon(
+0001ad70: 5b78 7074 7320 2b20 786f 6666 7365 742c  [xpts + xoffset,
+0001ad80: 2079 7074 7320 2b20 796f 6666 7365 745d   ypts + yoffset]
+0001ad90: 2c20 6c61 7965 723d 6c61 7965 7229 0a20  , layer=layer). 
+0001ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001adb0: 2020 2078 6f66 6673 6574 202b 3d20 285f     xoffset += (_
+0001adc0: 7769 6474 685b 6173 6369 695f 7661 6c5d  width[ascii_val]
+0001add0: 202b 205f 696e 6465 6e74 5b61 7363 6969   + _indent[ascii
+0001ade0: 5f76 616c 5d29 202a 2073 6361 6c69 6e67  _val]) * scaling
+0001adf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ae00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001ae10: 2020 2020 2020 2020 2020 2076 616c 6964             valid
+0001ae20: 5f63 6861 7273 203d 2022 215c 2223 2425  _chars = "!\"#$%
+0001ae30: 2627 2829 2a2b 2c2d 2e2f 3031 3233 3435  &'()*+,-./012345
+0001ae40: 3637 3839 3a3b 3c3d 3e3f 4041 4243 4445  6789:;<=>?@ABCDE
+0001ae50: 4647 4849 4a4b 4c4d 4e4f 5051 5253 5455  FGHIJKLMNOPQRSTU
+0001ae60: 5657 5859 5a5b 5c5c 5d5e 5f60 6162 6364  VWXYZ[\\]^_`abcd
+0001ae70: 6566 6768 696a 6b6c 6d6e 6f70 7172 7374  efghijklmnopqrst
+0001ae80: 7576 7778 797a 7b7c 7d7e c2b5 220a 2020  uvwxyz{|}~..".  
+0001ae90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aea0: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
+0001aeb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001aec0: 2020 2020 2020 2020 2027 5b50 4849 444c           '[PHIDL
+0001aed0: 5d20 7465 7874 2829 3a20 5761 726e 696e  ] text(): Warnin
+0001aee0: 672c 2073 6f6d 6520 6368 6172 6163 7465  g, some characte
+0001aef0: 7273 2069 676e 6f72 6564 2c20 6e6f 2067  rs ignored, no g
+0001af00: 656f 6d65 7472 7920 666f 7220 6368 6172  eometry for char
+0001af10: 6163 7465 7220 2225 7322 2077 6974 6820  acter "%s" with 
+0001af20: 6173 6369 6920 7661 6c75 6520 2573 2e20  ascii value %s. 
+0001af30: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001af40: 2020 2020 2020 2020 2020 2256 616c 6964            "Valid
+0001af50: 2063 6861 7261 6374 6572 733a 2025 7322   characters: %s"
+0001af60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001af70: 2020 2020 2020 2020 2025 2028 6368 7228           % (chr(
+0001af80: 6173 6369 695f 7661 6c29 2c20 6173 6369  ascii_val), asci
+0001af90: 695f 7661 6c2c 2076 616c 6964 5f63 6861  i_val, valid_cha
+0001afa0: 7273 290a 2020 2020 2020 2020 2020 2020  rs).            
+0001afb0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001afc0: 2020 2020 2020 742e 6164 645f 7265 6628        t.add_ref(
+0001afd0: 6c29 0a20 2020 2020 2020 2020 2020 2079  l).            y
+0001afe0: 6f66 6673 6574 202d 3d20 3135 3030 202a  offset -= 1500 *
+0001aff0: 2073 6361 6c69 6e67 0a20 2020 2020 2020   scaling.       
+0001b000: 2020 2020 2078 6f66 6673 6574 203d 2030       xoffset = 0
+0001b010: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0001b020: 2020 2066 726f 6d20 2e66 6f6e 7420 696d     from .font im
+0001b030: 706f 7274 205f 6765 745f 666f 6e74 5f62  port _get_font_b
+0001b040: 795f 6669 6c65 2c20 5f67 6574 5f66 6f6e  y_file, _get_fon
+0001b050: 745f 6279 5f6e 616d 652c 205f 6765 745f  t_by_name, _get_
+0001b060: 676c 7970 680a 0a20 2020 2020 2020 2023  glyph..        #
+0001b070: 204c 6f61 6420 7468 6520 666f 6e74 0a20   Load the font. 
+0001b080: 2020 2020 2020 2023 2049 6620 7765 2776         # If we'v
+0001b090: 6520 7061 7373 6564 2061 2076 616c 6964  e passed a valid
+0001b0a0: 2066 696c 652c 2074 7279 2074 6f20 6c6f   file, try to lo
+0001b0b0: 6164 2074 6861 742c 206f 7468 6572 7769  ad that, otherwi
+0001b0c0: 7365 2073 6561 7263 6820 7379 7374 656d  se search system
+0001b0d0: 2066 6f6e 7473 0a20 2020 2020 2020 2066   fonts.        f
+0001b0e0: 6f6e 7420 3d20 4e6f 6e65 0a20 2020 2020  ont = None.     
+0001b0f0: 2020 2069 6620 2866 6163 652e 656e 6473     if (face.ends
+0001b100: 7769 7468 2822 2e6f 7466 2229 206f 7220  with(".otf") or 
+0001b110: 6661 6365 2e65 6e64 7377 6974 6828 222e  face.endswith(".
+0001b120: 7474 6622 2929 2061 6e64 206f 732e 7061  ttf")) and os.pa
+0001b130: 7468 2e65 7869 7374 7328 6661 6365 293a  th.exists(face):
+0001b140: 0a20 2020 2020 2020 2020 2020 2066 6f6e  .            fon
+0001b150: 7420 3d20 5f67 6574 5f66 6f6e 745f 6279  t = _get_font_by
+0001b160: 5f66 696c 6528 6661 6365 290a 2020 2020  _file(face).    
+0001b170: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001b180: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0001b190: 2020 2020 2020 2020 2020 2066 6f6e 7420             font 
+0001b1a0: 3d20 5f67 6574 5f66 6f6e 745f 6279 5f6e  = _get_font_by_n
+0001b1b0: 616d 6528 6661 6365 290a 2020 2020 2020  ame(face).      
+0001b1c0: 2020 2020 2020 6578 6365 7074 2056 616c        except Val
+0001b1d0: 7565 4572 726f 723a 0a20 2020 2020 2020  ueError:.       
+0001b1e0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+0001b1f0: 2020 2020 2020 6966 2066 6f6e 7420 6973        if font is
+0001b200: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0001b210: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+0001b220: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+0001b230: 2020 2020 2028 0a20 2020 2020 2020 2020       (.         
+0001b240: 2020 2020 2020 2020 2020 2027 5b50 4849             '[PHI
+0001b250: 444c 5d20 4661 696c 6564 2074 6f20 6669  DL] Failed to fi
+0001b260: 6e64 2066 6f6e 743a 2022 2573 222e 2027  nd font: "%s". '
+0001b270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b280: 2020 2020 202b 2022 5472 7920 7370 6563       + "Try spec
+0001b290: 6966 7969 6e67 2074 6865 2065 7861 6374  ifying the exact
+0001b2a0: 2028 6675 6c6c 2920 7061 7468 2074 6f20   (full) path to 
+0001b2b0: 7468 6520 2e74 7466 206f 7220 2e6f 7466  the .ttf or .otf
+0001b2c0: 2066 696c 652e 2022 0a20 2020 2020 2020   file. ".       
+0001b2d0: 2020 2020 2020 2020 2020 2020 202b 2022               + "
+0001b2e0: 4f74 6865 7277 6973 652c 2069 7420 6d69  Otherwise, it mi
+0001b2f0: 6768 7420 6265 2072 6573 6f6c 7665 6420  ght be resolved 
+0001b300: 6279 2072 6562 7569 6c64 696e 6720 7468  by rebuilding th
+0001b310: 6520 6d61 7470 6c6f 746c 6962 2066 6f6e  e matplotlib fon
+0001b320: 7420 6361 6368 6522 0a20 2020 2020 2020  t cache".       
+0001b330: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001b340: 2020 2020 2020 2020 2020 2025 2028 6661             % (fa
+0001b350: 6365 290a 2020 2020 2020 2020 2020 2020  ce).            
+0001b360: 290a 0a20 2020 2020 2020 2023 2052 656e  )..        # Ren
+0001b370: 6465 7220 6561 6368 2063 6861 7261 6374  der each charact
+0001b380: 6572 0a20 2020 2020 2020 2066 6f72 206c  er.        for l
+0001b390: 696e 6520 696e 2074 6578 742e 7370 6c69  ine in text.spli
+0001b3a0: 7428 225c 6e22 293a 0a20 2020 2020 2020  t("\n"):.       
+0001b3b0: 2020 2020 206c 203d 2044 6576 6963 6528       l = Device(
+0001b3c0: 2274 6578 746c 696e 6522 290a 2020 2020  "textline").    
+0001b3d0: 2020 2020 2020 2020 786f 6666 7365 7420          xoffset 
+0001b3e0: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
+0001b3f0: 666f 7220 6c65 7474 6572 2069 6e20 6c69  for letter in li
+0001b400: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0001b410: 2020 2020 6c65 7474 6572 5f64 6576 203d      letter_dev =
+0001b420: 2044 6576 6963 6528 226c 6574 7465 7222   Device("letter"
+0001b430: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001b440: 2020 6c65 7474 6572 5f74 656d 706c 6174    letter_templat
+0001b450: 652c 2061 6476 616e 6365 5f78 203d 205f  e, advance_x = _
+0001b460: 6765 745f 676c 7970 6828 666f 6e74 2c20  get_glyph(font, 
+0001b470: 6c65 7474 6572 290a 2020 2020 2020 2020  letter).        
+0001b480: 2020 2020 2020 2020 666f 7220 706f 6c79          for poly
+0001b490: 2069 6e20 6c65 7474 6572 5f74 656d 706c   in letter_templ
+0001b4a0: 6174 652e 706f 6c79 676f 6e73 3a0a 2020  ate.polygons:.  
+0001b4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b4c0: 2020 6c65 7474 6572 5f64 6576 2e61 6464    letter_dev.add
+0001b4d0: 5f70 6f6c 7967 6f6e 2870 6f6c 792e 706f  _polygon(poly.po
+0001b4e0: 6c79 676f 6e73 2c20 6c61 7965 723d 6c61  lygons, layer=la
+0001b4f0: 7965 7229 0a20 2020 2020 2020 2020 2020  yer).           
+0001b500: 2020 2020 2072 6566 203d 206c 2e61 6464       ref = l.add
+0001b510: 5f72 6566 286c 6574 7465 725f 6465 7629  _ref(letter_dev)
+0001b520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b530: 2072 6566 2e6d 6f76 6528 6465 7374 696e   ref.move(destin
+0001b540: 6174 696f 6e3d 2878 6f66 6673 6574 2c20  ation=(xoffset, 
+0001b550: 3029 290a 2020 2020 2020 2020 2020 2020  0)).            
+0001b560: 2020 2020 7265 662e 6d61 676e 6966 6963      ref.magnific
+0001b570: 6174 696f 6e20 3d20 7369 7a65 0a20 2020  ation = size.   
+0001b580: 2020 2020 2020 2020 2020 2020 2078 6f66               xof
+0001b590: 6673 6574 202b 3d20 7369 7a65 202a 2061  fset += size * a
+0001b5a0: 6476 616e 6365 5f78 0a0a 2020 2020 2020  dvance_x..      
+0001b5b0: 2020 2020 2020 7265 6620 3d20 742e 6164        ref = t.ad
+0001b5c0: 645f 7265 6628 6c29 0a20 2020 2020 2020  d_ref(l).       
+0001b5d0: 2020 2020 2072 6566 2e6d 6f76 6528 6465       ref.move(de
+0001b5e0: 7374 696e 6174 696f 6e3d 2830 2c20 796f  stination=(0, yo
+0001b5f0: 6666 7365 7429 290a 2020 2020 2020 2020  ffset)).        
+0001b600: 2020 2020 796f 6666 7365 7420 2d3d 2073      yoffset -= s
+0001b610: 697a 650a 0a20 2020 206a 7573 7469 6679  ize..    justify
+0001b620: 203d 206a 7573 7469 6679 2e6c 6f77 6572   = justify.lower
+0001b630: 2829 0a20 2020 2066 6f72 206c 2069 6e20  ().    for l in 
+0001b640: 742e 7265 6665 7265 6e63 6573 3a0a 2020  t.references:.  
+0001b650: 2020 2020 2020 6966 206a 7573 7469 6679        if justify
+0001b660: 203d 3d20 226c 6566 7422 3a0a 2020 2020   == "left":.    
+0001b670: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
+0001b680: 2020 2020 2069 6620 6a75 7374 6966 7920       if justify 
+0001b690: 3d3d 2022 7269 6768 7422 3a0a 2020 2020  == "right":.    
+0001b6a0: 2020 2020 2020 2020 6c2e 786d 6178 203d          l.xmax =
+0001b6b0: 2030 0a20 2020 2020 2020 2069 6620 6a75   0.        if ju
+0001b6c0: 7374 6966 7920 3d3d 2022 6365 6e74 6572  stify == "center
+0001b6d0: 223a 0a20 2020 2020 2020 2020 2020 206c  ":.            l
+0001b6e0: 2e6d 6f76 6528 6f72 6967 696e 3d6c 2e63  .move(origin=l.c
+0001b6f0: 656e 7465 722c 2064 6573 7469 6e61 7469  enter, destinati
+0001b700: 6f6e 3d28 302c 2030 292c 2061 7869 733d  on=(0, 0), axis=
+0001b710: 2278 2229 0a0a 2020 2020 742e 666c 6174  "x")..    t.flat
+0001b720: 7465 6e28 290a 2020 2020 7265 7475 726e  ten().    return
+0001b730: 2074 0a0a 0a23 203d 3d3d 3d3d 3d3d 3d3d   t...# =========
+0001b740: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b750: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b760: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b770: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b780: 3d3d 3d3d 3d0a 2320 4578 616d 706c 6520  =====.# Example 
+0001b790: 636f 6465 0a23 203d 3d3d 3d3d 3d3d 3d3d  code.# =========
+0001b7a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b7b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b7c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b7d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b7e0: 3d3d 3d3d 3d0a 0a23 2044 203d 2074 6578  =====..# D = tex
+0001b7f0: 7428 2774 6865 2071 7569 636b 2062 726f  t('the quick bro
+0001b800: 776e 5c6e 2066 6f78 206a 756d 7065 6420  wn\n fox jumped 
+0001b810: 6f76 6572 5c6e 7468 6520 6c61 7a79 2064  over\nthe lazy d
+0001b820: 6f67 272c 206a 7573 7469 6679 203d 2027  og', justify = '
+0001b830: 6365 6e74 6572 272c 2073 697a 6520 3d20  center', size = 
+0001b840: 3830 3029 0a23 2071 7569 636b 706c 6f74  800).# quickplot
+0001b850: 2844 290a 0a0a 2320 3d3d 3d3d 3d3d 3d3d  (D)...# ========
+0001b860: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b870: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b880: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b890: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b8a0: 3d3d 3d3d 3d3d 0a23 0a23 2057 6166 6572  ======.#.# Wafer
+0001b8b0: 2061 6e64 2064 6965 0a23 0a23 203d 3d3d   and die.#.# ===
+0001b8c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 0001b8d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 0001b8e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 0001b8f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001b900: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001b910: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2320  =============.# 
-0001b920: 4578 616d 706c 6520 636f 6465 0a23 203d  Example code.# =
-0001b930: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001b940: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001b950: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001b960: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001b970: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a23  =============..#
-0001b980: 2044 203d 2062 6173 6963 5f64 6965 2873   D = basic_die(s
-0001b990: 697a 6520 3d20 2831 3030 3030 2c20 3130  ize = (10000, 10
-0001b9a0: 3030 3029 2c20 7374 7265 6574 5f77 6964  000), street_wid
-0001b9b0: 7468 203d 2031 3030 2c20 7374 7265 6574  th = 100, street
-0001b9c0: 5f6c 656e 6774 6820 3d20 3130 3030 2c0a  _length = 1000,.
-0001b9d0: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-0001b9e0: 6469 655f 6e61 6d65 203d 2027 6368 6970  die_name = 'chip
-0001b9f0: 3939 272c 2074 6578 745f 7369 7a65 203d  99', text_size =
-0001ba00: 2033 3030 2c20 7465 7874 5f6c 6f63 6174   300, text_locat
-0001ba10: 696f 6e20 3d20 2753 5727 2c20 206c 6179  ion = 'SW',  lay
-0001ba20: 6572 203d 2030 2c0a 2320 2020 2020 2020  er = 0,.#       
-0001ba30: 2020 2020 2020 2020 6472 6177 5f62 626f          draw_bbo
-0001ba40: 7820 3d20 5472 7565 2c20 2062 626f 785f  x = True,  bbox_
-0001ba50: 6c61 7965 7220 3d20 3939 290a 2320 7175  layer = 99).# qu
-0001ba60: 6963 6b70 6c6f 7428 4429 0a0a 0a23 203d  ickplot(D)...# =
-0001ba70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001ba80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001ba90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001baa0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001bab0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 230a  =============.#.
-0001bac0: 2320 5761 7665 6775 6964 6520 6375 7276  # Waveguide curv
-0001bad0: 6573 0a23 0a23 203d 3d3d 3d3d 3d3d 3d3d  es.#.# =========
-0001bae0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001baf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001bb00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001bb10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001bb20: 3d3d 3d3d 3d0a 0a0a 6465 6620 7261 6365  =====...def race
-0001bb30: 7472 6163 6b5f 6772 6164 7561 6c28 7769  track_gradual(wi
-0001bb40: 6474 683d 302e 332c 2052 3d35 2c20 4e3d  dth=0.3, R=5, N=
-0001bb50: 332c 206c 6179 6572 3d30 293a 0a20 2020  3, layer=0):.   
-0001bb60: 2022 2222 4372 6561 7465 7320 6120 6772   """Creates a gr
-0001bb70: 6164 7561 6c20 7261 6365 7472 6163 6b20  adual racetrack 
-0001bb80: 6265 6e74 2067 656f 6d65 7472 792e 0a0a  bent geometry...
-0001bb90: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-0001bba0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-0001bbb0: 2020 7769 6474 6820 3a20 696e 7420 6f72    width : int or
-0001bbc0: 2066 6c6f 6174 0a20 2020 2020 2020 2057   float.        W
-0001bbd0: 6964 7468 206f 6620 7468 6520 7472 6163  idth of the trac
-0001bbe0: 6b2e 0a20 2020 2052 203a 2069 6e74 206f  k..    R : int o
-0001bbf0: 7220 666c 6f61 740a 2020 2020 2020 2020  r float.        
-0001bc00: 5261 6469 7573 206f 6620 7468 6520 7472  Radius of the tr
-0001bc10: 6163 6b20 6174 2069 7473 206d 6f73 7420  ack at its most 
-0001bc20: 6375 7276 6564 2070 6f69 6e74 2e0a 2020  curved point..  
-0001bc30: 2020 4e20 3a20 696e 7420 6f72 2066 6c6f    N : int or flo
-0001bc40: 6174 0a20 2020 2020 2020 2052 6164 6975  at.        Radiu
-0001bc50: 7320 6f66 2074 6865 2074 7261 636b 2061  s of the track a
-0001bc60: 7420 6974 7320 6c65 6173 7420 6375 7276  t its least curv
-0001bc70: 6564 2070 6f69 6e74 2e0a 2020 2020 6c61  ed point..    la
-0001bc80: 7965 7220 3a20 696e 742c 2061 7272 6179  yer : int, array
-0001bc90: 2d6c 696b 655b 325d 2c20 6f72 2073 6574  -like[2], or set
-0001bca0: 0a20 2020 2020 2020 2053 7065 6369 6669  .        Specifi
-0001bcb0: 6320 6c61 7965 7228 7329 2074 6f20 7075  c layer(s) to pu
-0001bcc0: 7420 706f 6c79 676f 6e20 6765 6f6d 6574  t polygon geomet
-0001bcd0: 7279 206f 6e2e 0a0a 2020 2020 5265 7475  ry on...    Retu
-0001bce0: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-0001bcf0: 2020 2020 4420 3a20 4465 7669 6365 0a20      D : Device. 
-0001bd00: 2020 2020 2020 2041 2044 6576 6963 6520         A Device 
-0001bd10: 636f 6e74 6169 6e69 6e67 2061 2067 7261  containing a gra
-0001bd20: 6475 616c 2072 6163 6574 7261 636b 2062  dual racetrack b
-0001bd30: 656e 7420 6765 6f6d 6574 7279 2e0a 2020  ent geometry..  
-0001bd40: 2020 2222 220a 2020 2020 6375 7276 655f    """.    curve_
-0001bd50: 6675 6e20 3d20 6c61 6d62 6461 2074 3a20  fun = lambda t: 
-0001bd60: 5f72 6163 6574 7261 636b 5f67 7261 6475  _racetrack_gradu
-0001bd70: 616c 5f70 6172 616d 6574 7269 6328 742c  al_parametric(t,
-0001bd80: 2052 3d35 2c20 4e3d 3329 0a20 2020 2072   R=5, N=3).    r
-0001bd90: 6f75 7465 5f70 6174 6820 3d20 6764 7370  oute_path = gdsp
-0001bda0: 792e 5061 7468 2877 6964 7468 3d77 6964  y.Path(width=wid
-0001bdb0: 7468 2c20 696e 6974 6961 6c5f 706f 696e  th, initial_poin
-0001bdc0: 743d 5b30 2c20 305d 290a 2020 2020 726f  t=[0, 0]).    ro
-0001bdd0: 7574 655f 7061 7468 2e70 6172 616d 6574  ute_path.paramet
-0001bde0: 7269 6328 0a20 2020 2020 2020 2063 7572  ric(.        cur
-0001bdf0: 7665 5f66 756e 2c0a 2020 2020 2020 2020  ve_fun,.        
-0001be00: 6e75 6d62 6572 5f6f 665f 6576 616c 7561  number_of_evalua
-0001be10: 7469 6f6e 733d 3939 2c0a 2020 2020 2020  tions=99,.      
-0001be20: 2020 6d61 785f 706f 696e 7473 3d34 3030    max_points=400
-0001be30: 302c 0a20 2020 2020 2020 2066 696e 616c  0,.        final
-0001be40: 5f64 6973 7461 6e63 653d 4e6f 6e65 2c0a  _distance=None,.
-0001be50: 2020 2020 2020 2020 6c61 7965 723d 6c61          layer=la
-0001be60: 7965 722c 0a20 2020 2029 0a20 2020 2044  yer,.    ).    D
-0001be70: 203d 2044 6576 6963 6528 2272 6163 6574   = Device("racet
-0001be80: 7261 636b 2229 0a20 2020 2044 2e61 6464  rack").    D.add
-0001be90: 2872 6f75 7465 5f70 6174 6829 0a20 2020  (route_path).   
-0001bea0: 2072 6574 7572 6e20 440a 0a0a 6465 6620   return D...def 
-0001beb0: 5f72 6163 6574 7261 636b 5f67 7261 6475  _racetrack_gradu
-0001bec0: 616c 5f70 6172 616d 6574 7269 6328 742c  al_parametric(t,
-0001bed0: 2052 2c20 4e29 3a0a 2020 2020 2222 2254   R, N):.    """T
-0001bee0: 616b 6573 2069 6e20 6120 7061 7261 6d65  akes in a parame
-0001bef0: 7472 6963 2076 616c 7565 2060 6074 6060  tric value ``t``
-0001bf00: 206f 6e20 2830 2c31 292c 2072 6574 7572   on (0,1), retur
-0001bf10: 6e73 2074 6865 2078 2c79 2063 6f6f 7264  ns the x,y coord
-0001bf20: 696e 6174 6573 0a20 2020 206f 6620 6120  inates.    of a 
-0001bf30: 7261 6365 7472 6163 6b20 6265 6e74 2061  racetrack bent a
-0001bf40: 6363 6f72 6469 6e67 2074 6f0a 2020 2020  ccording to.    
-0001bf50: 3230 3039 3038 3130 5f45 4f53 345f 6d6f  20090810_EOS4_mo
-0001bf60: 6475 6c61 746f 725f 6465 7369 676e 735f  dulator_designs_
-0001bf70: 6578 6365 7270 7446 6f72 4a61 736f 6e47  excerptForJasonG
-0001bf80: 7261 6475 616c 4265 6e64 732e 7070 740a  radualBends.ppt.
-0001bf90: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
-0001bfa0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-0001bfb0: 2020 2074 203a 2061 7272 6179 2d6c 696b     t : array-lik
-0001bfc0: 655b 4e5d 0a20 2020 2020 2020 2050 6172  e[N].        Par
-0001bfd0: 616d 6574 7269 6320 7661 6c75 6573 2066  ametric values f
-0001bfe0: 6f72 2074 6865 2072 6163 6574 7261 636b  or the racetrack
-0001bff0: 2e0a 2020 2020 5220 3a20 696e 7420 6f72  ..    R : int or
-0001c000: 2066 6c6f 6174 0a20 2020 2020 2020 2052   float.        R
-0001c010: 6164 6975 7320 6f66 2074 6865 2074 7261  adius of the tra
-0001c020: 636b 2061 7420 6974 7320 6d6f 7374 2063  ck at its most c
-0001c030: 7572 7665 6420 706f 696e 742e 0a20 2020  urved point..   
-0001c040: 204e 203a 2069 6e74 206f 7220 666c 6f61   N : int or floa
-0001c050: 740a 2020 2020 2020 2020 5261 6469 7573  t.        Radius
-0001c060: 206f 6620 7468 6520 7472 6163 6b20 6174   of the track at
-0001c070: 2069 7473 206c 6561 7374 2063 7572 7665   its least curve
-0001c080: 6420 706f 696e 742e 0a0a 2020 2020 5265  d point...    Re
-0001c090: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-0001c0a0: 2d0a 2020 2020 7820 3a20 6172 7261 792d  -.    x : array-
-0001c0b0: 6c69 6b65 5b4e 5d0a 2020 2020 2020 2020  like[N].        
-0001c0c0: 782d 636f 6f72 6469 6e61 7465 7320 6f66  x-coordinates of
-0001c0d0: 2074 6865 2072 6163 6574 7261 636b 2063   the racetrack c
-0001c0e0: 7572 7665 2e0a 2020 2020 7920 3a20 6172  urve..    y : ar
-0001c0f0: 7261 792d 6c69 6b65 5b4e 5d0a 2020 2020  ray-like[N].    
-0001c100: 2020 2020 792d 636f 6f72 6469 6e61 7465      y-coordinate
-0001c110: 7320 6f66 2074 6865 2072 6163 6574 7261  s of the racetra
-0001c120: 636b 2063 7572 7665 2e0a 2020 2020 2222  ck curve..    ""
-0001c130: 220a 2020 2020 7830 203d 2052 202f 2032  ".    x0 = R / 2
-0001c140: 202a 2a20 2831 202f 204e 290a 2020 2020   ** (1 / N).    
-0001c150: 526d 696e 203d 2032 202a 2a20 2830 2e35  Rmin = 2 ** (0.5
-0001c160: 202d 2031 202f 204e 2920 2f20 284e 202d   - 1 / N) / (N -
-0001c170: 2031 2920 2a20 520a 2020 2020 5230 203d   1) * R.    R0 =
-0001c180: 2052 202d 2028 7830 202d 2052 6d69 6e20   R - (x0 - Rmin 
-0001c190: 2f20 7371 7274 2832 2929 0a20 2020 2074  / sqrt(2)).    t
-0001c1a0: 203d 206e 702e 6172 7261 7928 7429 0a20   = np.array(t). 
-0001c1b0: 2020 2078 2c20 7920 3d20 6e70 2e7a 6572     x, y = np.zer
-0001c1c0: 6f73 2874 2e73 6861 7065 292c 206e 702e  os(t.shape), np.
-0001c1d0: 7a65 726f 7328 742e 7368 6170 6529 0a0a  zeros(t.shape)..
-0001c1e0: 2020 2020 2320 446f 696e 6720 7468 6520      # Doing the 
-0001c1f0: 6d61 7468 0a20 2020 2078 203d 2063 6f73  math.    x = cos
-0001c200: 2874 202a 2070 6920 2f20 3229 202a 2052  (t * pi / 2) * R
-0001c210: 3020 2023 2074 2028 302d 3129 2077 6869  0  # t (0-1) whi
-0001c220: 6c65 2078 2028 3020 746f 2052 3029 0a20  le x (0 to R0). 
-0001c230: 2020 2069 6920 3d20 2852 6d69 6e20 2f20     ii = (Rmin / 
-0001c240: 7371 7274 2832 2920 3c20 7829 2026 2028  sqrt(2) < x) & (
-0001c250: 7820 3c3d 2052 3029 0a20 2020 206a 6a20  x <= R0).    jj 
-0001c260: 3d20 2830 203c 2078 2920 2620 2878 203c  = (0 < x) & (x <
-0001c270: 3d20 526d 696e 202f 2073 7172 7428 3229  = Rmin / sqrt(2)
-0001c280: 290a 2020 2020 795b 6969 5d20 3d20 2852  ).    y[ii] = (R
-0001c290: 2a2a 4e20 2d20 2878 5b69 695d 202b 2028  **N - (x[ii] + (
-0001c2a0: 7830 202d 2052 6d69 6e20 2f20 7371 7274  x0 - Rmin / sqrt
-0001c2b0: 2832 2929 2920 2a2a 204e 2920 2a2a 2028  (2))) ** N) ** (
-0001c2c0: 3120 2f20 4e29 0a20 2020 2079 5b6a 6a5d  1 / N).    y[jj]
-0001c2d0: 203d 2028 7830 202d 2052 6d69 6e20 2f20   = (x0 - Rmin / 
-0001c2e0: 7371 7274 2832 2929 202b 2073 7172 7428  sqrt(2)) + sqrt(
-0001c2f0: 526d 696e 2a2a 3220 2d20 785b 6a6a 5d20  Rmin**2 - x[jj] 
-0001c300: 2a2a 2032 290a 2020 2020 7265 7475 726e  ** 2).    return
-0001c310: 2078 2c20 790a 0a0a 2320 3d3d 3d3d 3d3d   x, y...# ======
-0001c320: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001c330: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001c340: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001c350: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001c360: 3d3d 3d3d 3d3d 3d3d 0a23 2045 7861 6d70  ========.# Examp
-0001c370: 6c65 2063 6f64 650a 2320 3d3d 3d3d 3d3d  le code.# ======
+0001b900: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a0a 6465  ===========...de
+0001b910: 6620 6261 7369 635f 6469 6528 0a20 2020  f basic_die(.   
+0001b920: 2073 697a 653d 2831 3030 3030 2c20 3130   size=(10000, 10
+0001b930: 3030 3029 2c0a 2020 2020 7374 7265 6574  000),.    street
+0001b940: 5f77 6964 7468 3d31 3030 2c0a 2020 2020  _width=100,.    
+0001b950: 7374 7265 6574 5f6c 656e 6774 683d 3130  street_length=10
+0001b960: 3030 2c0a 2020 2020 6469 655f 6e61 6d65  00,.    die_name
+0001b970: 3d22 6368 6970 3939 222c 0a20 2020 2074  ="chip99",.    t
+0001b980: 6578 745f 7369 7a65 3d31 3030 2c0a 2020  ext_size=100,.  
+0001b990: 2020 7465 7874 5f6c 6f63 6174 696f 6e3d    text_location=
+0001b9a0: 2253 5722 2c0a 2020 2020 6c61 7965 723d  "SW",.    layer=
+0001b9b0: 302c 0a20 2020 2064 7261 775f 6262 6f78  0,.    draw_bbox
+0001b9c0: 3d54 7275 652c 0a20 2020 2062 626f 785f  =True,.    bbox_
+0001b9d0: 6c61 7965 723d 3939 2c0a 293a 0a20 2020  layer=99,.):.   
+0001b9e0: 2022 2222 4372 6561 7465 7320 6120 6261   """Creates a ba
+0001b9f0: 7369 6320 6368 6970 2f64 6965 2074 656d  sic chip/die tem
+0001ba00: 706c 6174 652c 2077 6974 6820 3420 7269  plate, with 4 ri
+0001ba10: 6768 7420 616e 676c 6520 636f 726e 6572  ght angle corner
+0001ba20: 7320 6d61 726b 696e 670a 2020 2020 7468  s marking.    th
+0001ba30: 6520 626f 756e 6461 7279 206f 6620 7468  e boundary of th
+0001ba40: 6520 6368 6970 2f64 6965 2061 6e64 2061  e chip/die and a
+0001ba50: 206c 6162 656c 2077 6974 6820 7468 6520   label with the 
+0001ba60: 6e61 6d65 206f 6620 7468 6520 6469 652e  name of the die.
+0001ba70: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+0001ba80: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+0001ba90: 2020 2020 7369 7a65 203a 2061 7272 6179      size : array
+0001baa0: 5f6c 696b 655b 325d 206f 6620 696e 7420  _like[2] of int 
+0001bab0: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
+0001bac0: 2078 2c20 7920 6469 6d65 6e73 696f 6e73   x, y dimensions
+0001bad0: 206f 6620 7468 6520 6469 652e 0a20 2020   of the die..   
+0001bae0: 2073 7472 6565 745f 7769 6474 6820 3a20   street_width : 
+0001baf0: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
+0001bb00: 2020 2020 2057 6964 7468 206f 6620 7468       Width of th
+0001bb10: 6520 636f 726e 6572 206d 6172 6b73 2066  e corner marks f
+0001bb20: 6f72 2064 6965 2d73 6177 696e 672e 0a20  or die-sawing.. 
+0001bb30: 2020 2073 7472 6565 745f 6c65 6e67 7468     street_length
+0001bb40: 203a 2069 6e74 206f 7220 666c 6f61 740a   : int or float.
+0001bb50: 2020 2020 2020 2020 4c65 6e67 7468 206f          Length o
+0001bb60: 6620 7468 6520 636f 726e 6572 206d 6172  f the corner mar
+0001bb70: 6b73 2066 6f72 2064 6965 2d73 6177 696e  ks for die-sawin
+0001bb80: 672e 0a20 2020 2064 6965 5f6e 616d 6520  g..    die_name 
+0001bb90: 3a20 7374 720a 2020 2020 2020 2020 4c61  : str.        La
+0001bba0: 6265 6c20 7465 7874 2e0a 2020 2020 7465  bel text..    te
+0001bbb0: 7874 5f73 697a 6520 3a20 696e 7420 6f72  xt_size : int or
+0001bbc0: 2066 6c6f 6174 0a20 2020 2020 2020 204c   float.        L
+0001bbd0: 6162 656c 2074 6578 7420 7369 7a65 2e0a  abel text size..
+0001bbe0: 2020 2020 7465 7874 5f6c 6f63 6174 696f      text_locatio
+0001bbf0: 6e20 3a20 7b27 4e57 272c 2027 4e27 2c20  n : {'NW', 'N', 
+0001bc00: 274e 4527 2c20 2753 5727 2c20 2753 272c  'NE', 'SW', 'S',
+0001bc10: 2027 5345 277d 0a20 2020 2020 2020 204c   'SE'}.        L
+0001bc20: 6162 656c 2074 6578 7420 636f 6d70 6173  abel text compas
+0001bc30: 7320 6c6f 6361 7469 6f6e 2e0a 2020 2020  s location..    
+0001bc40: 6c61 7965 7220 3a20 696e 740a 2020 2020  layer : int.    
+0001bc50: 2020 2020 5370 6563 6966 6963 206c 6179      Specific lay
+0001bc60: 6572 2873 2920 746f 2070 7574 2070 6f6c  er(s) to put pol
+0001bc70: 7967 6f6e 2067 656f 6d65 7472 7920 6f6e  ygon geometry on
+0001bc80: 2e0a 2020 2020 6472 6177 5f62 626f 7820  ..    draw_bbox 
+0001bc90: 3a20 626f 6f6c 0a20 2020 2020 2020 2049  : bool.        I
+0001bca0: 6620 7472 7565 2c20 6472 6177 6e73 2061  f true, drawns a
+0001bcb0: 2062 626f 7820 6172 6f75 6e64 2074 6865   bbox around the
+0001bcc0: 2063 6869 7020 6469 6520 6765 6f6d 6574   chip die geomet
+0001bcd0: 7279 2e0a 2020 2020 6262 6f78 5f6c 6179  ry..    bbox_lay
+0001bce0: 6572 203a 2069 6e74 0a20 2020 2020 2020  er : int.       
+0001bcf0: 204c 6179 6572 206f 6e20 7768 6963 6820   Layer on which 
+0001bd00: 6262 6f78 2069 7320 706c 6163 6564 2069  bbox is placed i
+0001bd10: 6620 6060 6472 6177 5f62 626f 7860 6020  f ``draw_bbox`` 
+0001bd20: 6973 2074 7275 652e 0a0a 2020 2020 5265  is true...    Re
+0001bd30: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+0001bd40: 2d0a 2020 2020 4420 3a20 4465 7669 6365  -.    D : Device
+0001bd50: 0a20 2020 2020 2020 2041 2044 6576 6963  .        A Devic
+0001bd60: 6520 636f 6e74 6169 6e69 6e67 2061 2062  e containing a b
+0001bd70: 6173 6963 2064 6965 2067 656f 6d65 7472  asic die geometr
+0001bd80: 792e 0a20 2020 2022 2222 0a20 2020 2044  y..    """.    D
+0001bd90: 203d 2044 6576 6963 6528 6e61 6d65 3d22   = Device(name="
+0001bda0: 6469 6522 290a 2020 2020 7378 2c20 7379  die").    sx, sy
+0001bdb0: 203d 2073 697a 655b 305d 202f 2032 2c20   = size[0] / 2, 
+0001bdc0: 7369 7a65 5b31 5d20 2f20 320a 2020 2020  size[1] / 2.    
+0001bdd0: 7870 7473 203d 206e 702e 6172 7261 7928  xpts = np.array(
+0001bde0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0001bdf0: 2020 2020 2020 2073 782c 0a20 2020 2020         sx,.     
+0001be00: 2020 2020 2020 2073 782c 0a20 2020 2020         sx,.     
+0001be10: 2020 2020 2020 2073 7820 2d20 7374 7265         sx - stre
+0001be20: 6574 5f77 6964 7468 2c0a 2020 2020 2020  et_width,.      
+0001be30: 2020 2020 2020 7378 202d 2073 7472 6565        sx - stree
+0001be40: 745f 7769 6474 682c 0a20 2020 2020 2020  t_width,.       
+0001be50: 2020 2020 2073 7820 2d20 7374 7265 6574       sx - street
+0001be60: 5f6c 656e 6774 682c 0a20 2020 2020 2020  _length,.       
+0001be70: 2020 2020 2073 7820 2d20 7374 7265 6574       sx - street
+0001be80: 5f6c 656e 6774 682c 0a20 2020 2020 2020  _length,.       
+0001be90: 205d 0a20 2020 2029 0a20 2020 2079 7074   ].    ).    ypt
+0001bea0: 7320 3d20 6e70 2e61 7272 6179 280a 2020  s = np.array(.  
+0001beb0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0001bec0: 2020 2020 7379 2c0a 2020 2020 2020 2020      sy,.        
+0001bed0: 2020 2020 7379 202d 2073 7472 6565 745f      sy - street_
+0001bee0: 6c65 6e67 7468 2c0a 2020 2020 2020 2020  length,.        
+0001bef0: 2020 2020 7379 202d 2073 7472 6565 745f      sy - street_
+0001bf00: 6c65 6e67 7468 2c0a 2020 2020 2020 2020  length,.        
+0001bf10: 2020 2020 7379 202d 2073 7472 6565 745f      sy - street_
+0001bf20: 7769 6474 682c 0a20 2020 2020 2020 2020  width,.         
+0001bf30: 2020 2073 7920 2d20 7374 7265 6574 5f77     sy - street_w
+0001bf40: 6964 7468 2c0a 2020 2020 2020 2020 2020  idth,.          
+0001bf50: 2020 7379 2c0a 2020 2020 2020 2020 5d0a    sy,.        ].
+0001bf60: 2020 2020 290a 2020 2020 442e 6164 645f      ).    D.add_
+0001bf70: 706f 6c79 676f 6e28 5b78 7074 732c 2079  polygon([xpts, y
+0001bf80: 7074 735d 2c20 6c61 7965 723d 6c61 7965  pts], layer=laye
+0001bf90: 7229 0a20 2020 2044 2e61 6464 5f70 6f6c  r).    D.add_pol
+0001bfa0: 7967 6f6e 285b 2d78 7074 732c 2079 7074  ygon([-xpts, ypt
+0001bfb0: 735d 2c20 6c61 7965 723d 6c61 7965 7229  s], layer=layer)
+0001bfc0: 0a20 2020 2044 2e61 6464 5f70 6f6c 7967  .    D.add_polyg
+0001bfd0: 6f6e 285b 7870 7473 2c20 2d79 7074 735d  on([xpts, -ypts]
+0001bfe0: 2c20 6c61 7965 723d 6c61 7965 7229 0a20  , layer=layer). 
+0001bff0: 2020 2044 2e61 6464 5f70 6f6c 7967 6f6e     D.add_polygon
+0001c000: 285b 2d78 7074 732c 202d 7970 7473 5d2c  ([-xpts, -ypts],
+0001c010: 206c 6179 6572 3d6c 6179 6572 290a 0a20   layer=layer).. 
+0001c020: 2020 2069 6620 6472 6177 5f62 626f 7820     if draw_bbox 
+0001c030: 6973 2054 7275 653a 0a20 2020 2020 2020  is True:.       
+0001c040: 2044 2e61 6464 5f70 6f6c 7967 6f6e 285b   D.add_polygon([
+0001c050: 5b73 782c 2073 795d 2c20 5b73 782c 202d  [sx, sy], [sx, -
+0001c060: 7379 5d2c 205b 2d73 782c 202d 7379 5d2c  sy], [-sx, -sy],
+0001c070: 205b 2d73 782c 2073 795d 5d2c 206c 6179   [-sx, sy]], lay
+0001c080: 6572 3d62 626f 785f 6c61 7965 7229 0a20  er=bbox_layer). 
+0001c090: 2020 2044 2e63 656e 7465 7220 3d20 2830     D.center = (0
+0001c0a0: 2c20 3029 0a20 2020 2074 203d 2044 2e61  , 0).    t = D.a
+0001c0b0: 6464 5f72 6566 2874 6578 7428 7465 7874  dd_ref(text(text
+0001c0c0: 3d64 6965 5f6e 616d 652c 2073 697a 653d  =die_name, size=
+0001c0d0: 7465 7874 5f73 697a 652c 206c 6179 6572  text_size, layer
+0001c0e0: 3d6c 6179 6572 2929 0a0a 2020 2020 6420  =layer))..    d 
+0001c0f0: 3d20 7374 7265 6574 5f77 6964 7468 202b  = street_width +
+0001c100: 2032 300a 2020 2020 6966 2069 7369 6e73   20.    if isins
+0001c110: 7461 6e63 6528 7465 7874 5f6c 6f63 6174  tance(text_locat
+0001c120: 696f 6e2c 2073 7472 293a 0a20 2020 2020  ion, str):.     
+0001c130: 2020 2074 6578 745f 6c6f 6361 7469 6f6e     text_location
+0001c140: 203d 2074 6578 745f 6c6f 6361 7469 6f6e   = text_location
+0001c150: 2e75 7070 6572 2829 0a20 2020 2020 2020  .upper().       
+0001c160: 2069 6620 7465 7874 5f6c 6f63 6174 696f   if text_locatio
+0001c170: 6e20 3d3d 2022 4e57 223a 0a20 2020 2020  n == "NW":.     
+0001c180: 2020 2020 2020 2074 2e78 6d69 6e2c 2074         t.xmin, t
+0001c190: 2e79 6d61 7820 3d20 5b2d 7378 202b 2064  .ymax = [-sx + d
+0001c1a0: 2c20 7379 202d 2064 5d0a 2020 2020 2020  , sy - d].      
+0001c1b0: 2020 656c 6966 2074 6578 745f 6c6f 6361    elif text_loca
+0001c1c0: 7469 6f6e 203d 3d20 224e 223a 0a20 2020  tion == "N":.   
+0001c1d0: 2020 2020 2020 2020 2074 2e78 2c20 742e           t.x, t.
+0001c1e0: 796d 6178 203d 205b 302c 2073 7920 2d20  ymax = [0, sy - 
+0001c1f0: 645d 0a20 2020 2020 2020 2065 6c69 6620  d].        elif 
+0001c200: 7465 7874 5f6c 6f63 6174 696f 6e20 3d3d  text_location ==
+0001c210: 2022 4e45 223a 0a20 2020 2020 2020 2020   "NE":.         
+0001c220: 2020 2074 2e78 6d61 782c 2074 2e79 6d61     t.xmax, t.yma
+0001c230: 7820 3d20 5b73 7820 2d20 642c 2073 7920  x = [sx - d, sy 
+0001c240: 2d20 645d 0a20 2020 2020 2020 2069 6620  - d].        if 
+0001c250: 7465 7874 5f6c 6f63 6174 696f 6e20 3d3d  text_location ==
+0001c260: 2022 5357 223a 0a20 2020 2020 2020 2020   "SW":.         
+0001c270: 2020 2074 2e78 6d69 6e2c 2074 2e79 6d69     t.xmin, t.ymi
+0001c280: 6e20 3d20 5b2d 7378 202b 2064 2c20 2d73  n = [-sx + d, -s
+0001c290: 7920 2b20 645d 0a20 2020 2020 2020 2065  y + d].        e
+0001c2a0: 6c69 6620 7465 7874 5f6c 6f63 6174 696f  lif text_locatio
+0001c2b0: 6e20 3d3d 2022 5322 3a0a 2020 2020 2020  n == "S":.      
+0001c2c0: 2020 2020 2020 742e 782c 2074 2e79 6d69        t.x, t.ymi
+0001c2d0: 6e20 3d20 5b30 2c20 2d73 7920 2b20 645d  n = [0, -sy + d]
+0001c2e0: 0a20 2020 2020 2020 2065 6c69 6620 7465  .        elif te
+0001c2f0: 7874 5f6c 6f63 6174 696f 6e20 3d3d 2022  xt_location == "
+0001c300: 5345 223a 0a20 2020 2020 2020 2020 2020  SE":.           
+0001c310: 2074 2e78 6d61 782c 2074 2e79 6d69 6e20   t.xmax, t.ymin 
+0001c320: 3d20 5b73 7820 2d20 642c 202d 7379 202b  = [sx - d, -sy +
+0001c330: 2064 5d0a 2020 2020 656c 7365 3a0a 2020   d].    else:.  
+0001c340: 2020 2020 2020 742e 782c 2074 2e79 203d        t.x, t.y =
+0001c350: 2074 6578 745f 6c6f 6361 7469 6f6e 0a0a   text_location..
+0001c360: 2020 2020 7265 7475 726e 2044 0a0a 0a23      return D...#
+0001c370: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
 0001c380: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 0001c390: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 0001c3a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001c3b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001c3c0: 3d3d 3d3d 3d3d 3d3d 0a0a 2320 4420 3d20  ========..# D = 
-0001c3d0: 7261 6365 7472 6163 6b5f 6772 6164 7561  racetrack_gradua
-0001c3e0: 6c28 7769 6474 6820 3d20 302e 332c 2052  l(width = 0.3, R
-0001c3f0: 203d 2035 2c20 4e20 3d20 3329 0a23 2071   = 5, N = 3).# q
-0001c400: 7569 636b 706c 6f74 2844 290a 0a0a 2320  uickplot(D)...# 
-0001c410: 7420 3d20 6e70 2e6c 696e 7370 6163 6528  t = np.linspace(
-0001c420: 302c 3129 0a23 2078 2c79 203d 205f 7261  0,1).# x,y = _ra
-0001c430: 6365 7472 6163 6b5f 6772 6164 7561 6c5f  cetrack_gradual_
-0001c440: 7061 7261 6d65 7472 6963 2874 2c20 5220  parametric(t, R 
-0001c450: 3d20 352c 204e 203d 2033 290a 2320 706c  = 5, N = 3).# pl
-0001c460: 742e 706c 6f74 2878 2c79 290a 2320 706c  t.plot(x,y).# pl
-0001c470: 742e 6178 6973 2827 6571 7561 6c27 290a  t.axis('equal').
-0001c480: 0a0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ..# ============
-0001c490: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001c4a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001c4b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001c4c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001c4d0: 3d3d 0a23 0a23 2041 7261 6e67 652c 2070  ==.#.# Arange, p
-0001c4e0: 6163 6b69 6e67 2061 6e64 2066 696c 6c0a  acking and fill.
-0001c4f0: 230a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  #.# ============
-0001c500: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001c510: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001c3b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
+0001c3c0: 2320 4578 616d 706c 6520 636f 6465 0a23  # Example code.#
+0001c3d0: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
+0001c3e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001c3f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001c400: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001c410: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
+0001c420: 0a23 2044 203d 2062 6173 6963 5f64 6965  .# D = basic_die
+0001c430: 2873 697a 6520 3d20 2831 3030 3030 2c20  (size = (10000, 
+0001c440: 3130 3030 3029 2c20 7374 7265 6574 5f77  10000), street_w
+0001c450: 6964 7468 203d 2031 3030 2c20 7374 7265  idth = 100, stre
+0001c460: 6574 5f6c 656e 6774 6820 3d20 3130 3030  et_length = 1000
+0001c470: 2c0a 2320 2020 2020 2020 2020 2020 2020  ,.#             
+0001c480: 2020 6469 655f 6e61 6d65 203d 2027 6368    die_name = 'ch
+0001c490: 6970 3939 272c 2074 6578 745f 7369 7a65  ip99', text_size
+0001c4a0: 203d 2033 3030 2c20 7465 7874 5f6c 6f63   = 300, text_loc
+0001c4b0: 6174 696f 6e20 3d20 2753 5727 2c20 206c  ation = 'SW',  l
+0001c4c0: 6179 6572 203d 2030 2c0a 2320 2020 2020  ayer = 0,.#     
+0001c4d0: 2020 2020 2020 2020 2020 6472 6177 5f62            draw_b
+0001c4e0: 626f 7820 3d20 5472 7565 2c20 2062 626f  box = True,  bbo
+0001c4f0: 785f 6c61 7965 7220 3d20 3939 290a 2320  x_layer = 99).# 
+0001c500: 7175 6963 6b70 6c6f 7428 4429 0a0a 0a23  quickplot(D)...#
+0001c510: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
 0001c520: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 0001c530: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001c540: 3d3d 0a0a 0a64 6566 2067 7269 6428 0a20  ==...def grid(. 
-0001c550: 2020 2064 6576 6963 655f 6c69 7374 2c0a     device_list,.
-0001c560: 2020 2020 7370 6163 696e 673d 2835 2c20      spacing=(5, 
-0001c570: 3130 292c 0a20 2020 2073 6570 6172 6174  10),.    separat
-0001c580: 696f 6e3d 5472 7565 2c0a 2020 2020 7368  ion=True,.    sh
-0001c590: 6170 653d 4e6f 6e65 2c0a 2020 2020 616c  ape=None,.    al
-0001c5a0: 6967 6e5f 783d 2278 222c 0a20 2020 2061  ign_x="x",.    a
-0001c5b0: 6c69 676e 5f79 3d22 7922 2c0a 2020 2020  lign_y="y",.    
-0001c5c0: 6564 6765 5f78 3d22 7822 2c0a 2020 2020  edge_x="x",.    
-0001c5d0: 6564 6765 5f79 3d22 796d 6178 222c 0a29  edge_y="ymax",.)
-0001c5e0: 3a0a 2020 2020 2222 2250 6c61 6365 7320  :.    """Places 
-0001c5f0: 7468 6520 6465 7669 6365 7320 696e 2074  the devices in t
-0001c600: 6865 2060 6465 7669 6365 5f6c 6973 7460  he `device_list`
-0001c610: 2028 3144 206f 7220 3244 2920 6f6e 2061   (1D or 2D) on a
-0001c620: 2067 7269 642e 0a0a 2020 2020 5061 7261   grid...    Para
-0001c630: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-0001c640: 2d2d 2d2d 2d0a 2020 2020 6465 7669 6365  -----.    device
-0001c650: 5f6c 6973 7420 3a20 6172 7261 792d 6c69  _list : array-li
-0001c660: 6b65 5b4e 5d20 6f66 2044 6576 6963 650a  ke[N] of Device.
-0001c670: 2020 2020 2020 2020 4465 7669 6365 7320          Devices 
-0001c680: 746f 2062 6520 706c 6163 6564 206f 6e74  to be placed ont
-0001c690: 6f20 6120 6772 6964 2e0a 2020 2020 7370  o a grid..    sp
-0001c6a0: 6163 696e 6720 3a20 696e 742c 2066 6c6f  acing : int, flo
-0001c6b0: 6174 2c20 6f72 2061 7272 6179 2d6c 696b  at, or array-lik
-0001c6c0: 655b 325d 206f 6620 696e 7420 6f72 2066  e[2] of int or f
-0001c6d0: 6c6f 6174 0a20 2020 2020 2020 2053 7061  loat.        Spa
-0001c6e0: 6369 6e67 2062 6574 7765 656e 2061 646a  cing between adj
-0001c6f0: 6163 656e 7420 656c 656d 656e 7473 206f  acent elements o
-0001c700: 6e20 7468 6520 6772 6964 2c20 6361 6e20  n the grid, can 
-0001c710: 6265 2061 2074 7570 6c65 2066 6f72 0a20  be a tuple for. 
-0001c720: 2020 2020 2020 2064 6966 6665 7265 6e74         different
-0001c730: 2064 6973 7461 6e63 6573 2069 6e20 7769   distances in wi
-0001c740: 6474 6820 616e 6420 6865 6967 6874 2028  dth and height (
-0001c750: 782c 7929 2e0a 2020 2020 7365 7061 7261  x,y)..    separa
-0001c760: 7469 6f6e 203a 2062 6f6f 6c0a 2020 2020  tion : bool.    
-0001c770: 2020 2020 4966 2054 7275 652c 2067 7561      If True, gua
-0001c780: 7261 6e74 6565 7320 656c 656d 656e 7473  rantees elements
-0001c790: 2061 7265 2073 7065 7061 7261 7465 6420   are speparated 
-0001c7a0: 7769 7468 2061 2066 6978 6564 2073 7061  with a fixed spa
-0001c7b0: 6369 6e67 0a20 2020 2020 2020 2062 6574  cing.        bet
-0001c7c0: 7765 656e 3b20 6966 2020 4661 6c73 652c  ween; if  False,
-0001c7d0: 2065 6c65 6d65 6e74 7320 6172 6520 7370   elements are sp
-0001c7e0: 6163 6564 2065 7665 6e6c 7920 616c 6f6e  aced evenly alon
-0001c7f0: 6720 6120 6772 6964 2e0a 2020 2020 7368  g a grid..    sh
-0001c800: 6170 6520 3a20 6172 7261 792d 6c69 6b65  ape : array-like
-0001c810: 5b32 5d0a 2020 2020 2020 2020 782c 2079  [2].        x, y
-0001c820: 2073 6861 7065 206f 6620 7468 6520 6772   shape of the gr
-0001c830: 6964 2028 6173 2069 6620 6e70 2e72 6573  id (as if np.res
-0001c840: 6861 7065 2829 2077 6572 6520 7275 6e20  hape() were run 
-0001c850: 7769 7468 2073 6861 7065 5b3a 3a2d 315d  with shape[::-1]
-0001c860: 292e 2049 6620 6e6f 2073 6861 7065 2069  ). If no shape i
-0001c870: 7320 6769 7665 6e20 616e 6420 7468 650a  s given and the.
-0001c880: 2020 2020 2020 2020 6c69 7374 2069 7320          list is 
-0001c890: 3144 2c20 7468 6520 6f75 7470 7574 2069  1D, the output i
-0001c8a0: 7320 6173 2069 6620 6e70 2e72 6573 6861  s as if np.resha
-0001c8b0: 7065 2077 6572 6520 7275 6e20 7769 7468  pe were run with
-0001c8c0: 2028 2d31 2c20 7369 7a65 206f 6620 6c69   (-1, size of li
-0001c8d0: 7374 292e 0a20 2020 2061 6c69 676e 5f78  st)..    align_x
-0001c8e0: 203a 207b 2778 272c 2027 786d 696e 272c   : {'x', 'xmin',
-0001c8f0: 2027 786d 6178 277d 0a20 2020 2020 2020   'xmax'}.       
-0001c900: 2057 6869 6368 2065 6467 6520 746f 2070   Which edge to p
-0001c910: 6572 666f 726d 2074 6865 2078 2028 636f  erform the x (co
-0001c920: 6c75 6d6e 2920 616c 6967 6e6d 656e 7420  lumn) alignment 
-0001c930: 616c 6f6e 670a 2020 2020 616c 6967 6e5f  along.    align_
-0001c940: 7920 3a20 7b27 7927 2c20 2779 6d69 6e27  y : {'y', 'ymin'
-0001c950: 2c20 2779 6d61 7827 7d0a 2020 2020 2020  , 'ymax'}.      
-0001c960: 2020 5768 6963 6820 6564 6765 2074 6f20    Which edge to 
-0001c970: 7065 7266 6f72 6d20 7468 6520 7920 2872  perform the y (r
-0001c980: 6f77 2920 616c 6967 6e6d 656e 7420 616c  ow) alignment al
-0001c990: 6f6e 670a 2020 2020 6564 6765 5f78 203a  ong.    edge_x :
-0001c9a0: 207b 2778 272c 2027 786d 696e 272c 2027   {'x', 'xmin', '
-0001c9b0: 786d 6178 277d 0a20 2020 2020 2020 2057  xmax'}.        W
-0001c9c0: 6869 6368 2065 6467 6520 746f 2070 6572  hich edge to per
-0001c9d0: 666f 726d 2074 6865 2078 2028 636f 6c75  form the x (colu
-0001c9e0: 6d6e 2920 6469 7374 7269 6275 7469 6f6e  mn) distribution
-0001c9f0: 2061 6c6f 6e67 2028 756e 7573 6564 2069   along (unused i
-0001ca00: 660a 2020 2020 2020 2020 7365 7061 7261  f.        separa
-0001ca10: 7469 6f6e 203d 3d20 5472 7565 290a 2020  tion == True).  
-0001ca20: 2020 6564 6765 5f79 203a 207b 2779 272c    edge_y : {'y',
-0001ca30: 2027 796d 696e 272c 2027 796d 6178 277d   'ymin', 'ymax'}
-0001ca40: 0a20 2020 2020 2020 2057 6869 6368 2065  .        Which e
-0001ca50: 6467 6520 746f 2070 6572 666f 726d 2074  dge to perform t
-0001ca60: 6865 2079 2028 726f 7729 2064 6973 7472  he y (row) distr
-0001ca70: 6962 7574 696f 6e20 616c 6f6e 6720 2875  ibution along (u
-0001ca80: 6e75 7365 6420 6966 0a20 2020 2020 2020  nused if.       
-0001ca90: 2073 6570 6172 6174 696f 6e20 3d3d 2054   separation == T
-0001caa0: 7275 6529 0a0a 2020 2020 5265 7475 726e  rue)..    Return
-0001cab0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-0001cac0: 2020 6465 7669 6365 5f6d 6174 7269 7820    device_matrix 
-0001cad0: 3a20 4465 7669 6365 0a20 2020 2020 2020  : Device.       
-0001cae0: 2041 2044 6576 6963 6520 636f 6e74 6169   A Device contai
-0001caf0: 6e69 6e67 2061 6c6c 2074 6865 2044 6576  ning all the Dev
-0001cb00: 6963 6573 2069 6e20 6064 6576 6963 655f  ices in `device_
-0001cb10: 6c69 7374 6020 696e 2061 2067 7269 642e  list` in a grid.
-0001cb20: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
-0001cb30: 7669 6365 5f61 7272 6179 203d 206e 702e  vice_array = np.
-0001cb40: 6173 6172 7261 7928 6465 7669 6365 5f6c  asarray(device_l
-0001cb50: 6973 7429 0a20 2020 2073 7061 6369 6e67  ist).    spacing
-0001cb60: 203d 206e 702e 6272 6f61 6463 6173 745f   = np.broadcast_
-0001cb70: 746f 2873 7061 6369 6e67 2c20 3229 0a20  to(spacing, 2). 
-0001cb80: 2020 2023 2043 6865 636b 2061 7267 756d     # Check argum
-0001cb90: 656e 7473 0a20 2020 2069 6620 6465 7669  ents.    if devi
-0001cba0: 6365 5f61 7272 6179 2e6e 6469 6d20 6e6f  ce_array.ndim no
-0001cbb0: 7420 696e 2028 312c 2032 293a 0a20 2020  t in (1, 2):.   
-0001cbc0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-0001cbd0: 4572 726f 7228 225b 5048 4944 4c5d 2067  Error("[PHIDL] g
-0001cbe0: 7269 6428 2920 5468 6520 6465 7669 6365  rid() The device
-0001cbf0: 5f6c 6973 7420 6e65 6564 7320 746f 2062  _list needs to b
-0001cc00: 6520 3144 206f 7220 3244 2e22 290a 2020  e 1D or 2D.").  
-0001cc10: 2020 6966 2073 6861 7065 2069 7320 6e6f    if shape is no
-0001cc20: 7420 4e6f 6e65 2061 6e64 206c 656e 2873  t None and len(s
-0001cc30: 6861 7065 2920 213d 2032 3a0a 2020 2020  hape) != 2:.    
-0001cc40: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-0001cc50: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0001cc60: 2020 225b 5048 4944 4c5d 2067 7269 6428    "[PHIDL] grid(
-0001cc70: 2920 7368 6170 6520 6172 6775 6d65 6e74  ) shape argument
-0001cc80: 206d 7573 7420 6265 204e 6f6e 6520 6f72   must be None or
-0001cc90: 220a 2020 2020 2020 2020 2020 2020 2b20  ".            + 
-0001cca0: 2220 6861 7665 2061 206c 656e 6774 6820  " have a length 
-0001ccb0: 6f66 2032 2c20 666f 7220 6578 616d 706c  of 2, for exampl
-0001ccc0: 6520 7368 6170 653d 2834 2c36 2922 0a20  e shape=(4,6)". 
-0001ccd0: 2020 2020 2020 2029 0a0a 2020 2020 2320         )..    # 
-0001cce0: 4368 6563 6b20 7468 6174 2073 6861 7065  Check that shape
-0001ccf0: 2069 7320 7661 6c69 6420 616e 6420 7265   is valid and re
-0001cd00: 7368 6170 6520 6172 7261 7920 6966 206e  shape array if n
-0001cd10: 6565 6465 640a 2020 2020 6966 2028 7368  eeded.    if (sh
-0001cd20: 6170 6520 6973 204e 6f6e 6529 2061 6e64  ape is None) and
-0001cd30: 2028 6465 7669 6365 5f61 7272 6179 2e6e   (device_array.n
-0001cd40: 6469 6d20 3d3d 2032 293a 2020 2320 416c  dim == 2):  # Al
-0001cd50: 7265 6164 7920 696e 2064 6573 6972 6564  ready in desired
-0001cd60: 2073 6861 7065 0a20 2020 2020 2020 2073   shape.        s
-0001cd70: 6861 7065 203d 2064 6576 6963 655f 6172  hape = device_ar
-0001cd80: 7261 792e 7368 6170 650a 2020 2020 656c  ray.shape.    el
-0001cd90: 6966 2028 7368 6170 6520 6973 204e 6f6e  if (shape is Non
-0001cda0: 6529 2061 6e64 2028 6465 7669 6365 5f61  e) and (device_a
-0001cdb0: 7272 6179 2e6e 6469 6d20 3d3d 2031 293a  rray.ndim == 1):
-0001cdc0: 0a20 2020 2020 2020 2073 6861 7065 203d  .        shape =
-0001cdd0: 2028 2d31 2c20 6465 7669 6365 5f61 7272   (-1, device_arr
-0001cde0: 6179 2e73 697a 6529 0a20 2020 2065 6c69  ay.size).    eli
-0001cdf0: 6620 3020 3c20 7368 6170 655b 305d 202a  f 0 < shape[0] *
-0001ce00: 2073 6861 7065 5b31 5d20 3c20 6465 7669   shape[1] < devi
-0001ce10: 6365 5f61 7272 6179 2e73 697a 653a 0a20  ce_array.size:. 
-0001ce20: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-0001ce30: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
-0001ce40: 2020 2020 2022 5b50 4849 444c 5d20 6772       "[PHIDL] gr
-0001ce50: 6964 2829 2054 6865 2073 6861 7065 2069  id() The shape i
-0001ce60: 7320 746f 6f20 736d 616c 6c20 666f 7220  s too small for 
-0001ce70: 616c 6c20 7468 6520 6974 656d 7320 696e  all the items in
-0001ce80: 2064 6576 6963 655f 6c69 7374 220a 2020   device_list".  
-0001ce90: 2020 2020 2020 290a 2020 2020 656c 7365        ).    else
-0001cea0: 3a0a 2020 2020 2020 2020 2320 4368 616e  :.        # Chan
-0001ceb0: 6765 2028 782c 7929 2073 6861 7065 2074  ge (x,y) shape t
-0001cec0: 6f20 2879 2c78 2920 7368 6170 6520 746f  o (y,x) shape to
-0001ced0: 2066 6f6c 6c6f 7720 6465 6661 756c 7420   follow default 
-0001cee0: 726f 772c 2063 6f6c 756d 6e20 666f 726d  row, column form
-0001cef0: 6174 2069 6e20 6e70 2e72 6573 6861 7065  at in np.reshape
-0001cf00: 0a20 2020 2020 2020 2073 6861 7065 203d  .        shape =
-0001cf10: 2073 6861 7065 5b3a 3a2d 315d 0a0a 2020   shape[::-1]..  
-0001cf20: 2020 2020 2020 6966 206e 702e 6d69 6e28        if np.min(
-0001cf30: 7368 6170 6529 203d 3d20 2d31 3a0a 2020  shape) == -1:.  
-0001cf40: 2020 2020 2020 2020 2020 6d61 785f 7368            max_sh
-0001cf50: 6170 6520 3d20 6e70 2e6d 6178 2873 6861  ape = np.max(sha
-0001cf60: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
-0001cf70: 6d69 6e5f 6465 7669 6365 7320 3d20 696e  min_devices = in
-0001cf80: 7428 6e70 2e63 6569 6c28 6465 7669 6365  t(np.ceil(device
-0001cf90: 5f61 7272 6179 2e73 697a 6520 2f20 6d61  _array.size / ma
-0001cfa0: 785f 7368 6170 6529 202a 206d 6178 5f73  x_shape) * max_s
-0001cfb0: 6861 7065 290a 2020 2020 2020 2020 2020  hape).          
-0001cfc0: 2020 6578 7472 615f 6465 7669 6365 7320    extra_devices 
-0001cfd0: 3d20 6d69 6e5f 6465 7669 6365 7320 2d20  = min_devices - 
-0001cfe0: 6465 7669 6365 5f61 7272 6179 2e73 697a  device_array.siz
-0001cff0: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-0001d000: 2020 2020 2020 2020 2020 2020 6578 7472              extr
-0001d010: 615f 6465 7669 6365 7320 3d20 7368 6170  a_devices = shap
-0001d020: 655b 305d 202a 2073 6861 7065 5b31 5d20  e[0] * shape[1] 
-0001d030: 2d20 6465 7669 6365 5f61 7272 6179 2e73  - device_array.s
-0001d040: 697a 650a 2020 2020 2020 2020 6966 2065  ize.        if e
-0001d050: 7874 7261 5f64 6576 6963 6573 2021 3d20  xtra_devices != 
-0001d060: 303a 0a20 2020 2020 2020 2020 2020 2064  0:.            d
-0001d070: 6576 6963 655f 6172 7261 7920 3d20 6e70  evice_array = np
-0001d080: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
-0001d090: 2020 2020 2020 2020 2064 6576 6963 655f           device_
-0001d0a0: 6172 7261 792c 0a20 2020 2020 2020 2020  array,.         
-0001d0b0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0001d0c0: 2020 2020 2020 2020 2020 2020 204e 6f6e               Non
-0001d0d0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001d0e0: 2020 205d 0a20 2020 2020 2020 2020 2020     ].           
-0001d0f0: 2020 2020 202a 2065 7874 7261 5f64 6576       * extra_dev
-0001d100: 6963 6573 2c0a 2020 2020 2020 2020 2020  ices,.          
-0001d110: 2020 290a 2020 2020 6465 7669 6365 5f61    ).    device_a
-0001d120: 7272 6179 203d 206e 702e 7265 7368 6170  rray = np.reshap
-0001d130: 6528 6465 7669 6365 5f61 7272 6179 2c20  e(device_array, 
-0001d140: 7368 6170 6529 0a0a 2020 2020 2320 4372  shape)..    # Cr
-0001d150: 6561 7465 2061 2062 6c61 6e6b 2044 6576  eate a blank Dev
-0001d160: 6963 6520 616e 6420 7265 6665 7265 6e63  ice and referenc
-0001d170: 6520 616c 6c20 7468 6520 4465 7669 6365  e all the Device
-0001d180: 7320 696e 2069 740a 2020 2020 4420 3d20  s in it.    D = 
-0001d190: 4465 7669 6365 2822 6772 6964 2229 0a20  Device("grid"). 
-0001d1a0: 2020 2072 6566 5f61 7272 6179 203d 206e     ref_array = n
-0001d1b0: 702e 656d 7074 7928 6465 7669 6365 5f61  p.empty(device_a
-0001d1c0: 7272 6179 2e73 6861 7065 2c20 6474 7970  rray.shape, dtyp
-0001d1d0: 653d 6f62 6a65 6374 290a 2020 2020 6475  e=object).    du
-0001d1e0: 6d6d 7920 3d20 4465 7669 6365 2829 0a20  mmy = Device(). 
-0001d1f0: 2020 2066 6f72 2069 6478 2c20 6420 696e     for idx, d in
-0001d200: 206e 702e 6e64 656e 756d 6572 6174 6528   np.ndenumerate(
-0001d210: 6465 7669 6365 5f61 7272 6179 293a 0a20  device_array):. 
-0001d220: 2020 2020 2020 2069 6620 6420 6973 206e         if d is n
-0001d230: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0001d240: 2020 2020 2072 6566 5f61 7272 6179 5b69       ref_array[i
-0001d250: 6478 5d20 3d20 4420 3c3c 2064 0a20 2020  dx] = D << d.   
-0001d260: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001d270: 2020 2020 2020 2072 6566 5f61 7272 6179         ref_array
-0001d280: 5b69 6478 5d20 3d20 4420 3c3c 2064 756d  [idx] = D << dum
-0001d290: 6d79 2020 2320 4372 6561 7465 2064 756d  my  # Create dum
-0001d2a0: 6d79 2064 6576 6963 6573 0a0a 2020 2020  my devices..    
-0001d2b0: 726f 7773 203d 205b 4772 6f75 7028 7265  rows = [Group(re
-0001d2c0: 665f 6172 7261 795b 6e2c 203a 5d29 2066  f_array[n, :]) f
-0001d2d0: 6f72 206e 2069 6e20 7261 6e67 6528 7265  or n in range(re
-0001d2e0: 665f 6172 7261 792e 7368 6170 655b 305d  f_array.shape[0]
-0001d2f0: 295d 0a20 2020 2063 6f6c 7320 3d20 5b47  )].    cols = [G
-0001d300: 726f 7570 2872 6566 5f61 7272 6179 5b3a  roup(ref_array[:
-0001d310: 2c20 6e5d 2920 666f 7220 6e20 696e 2072  , n]) for n in r
-0001d320: 616e 6765 2872 6566 5f61 7272 6179 2e73  ange(ref_array.s
-0001d330: 6861 7065 5b31 5d29 5d0a 0a20 2020 2023  hape[1])]..    #
-0001d340: 2041 6c69 676e 2072 6f77 7320 616e 6420   Align rows and 
-0001d350: 636f 6c75 6d6e 7320 696e 6465 7065 6e64  columns independ
-0001d360: 656e 746c 790a 2020 2020 666f 7220 6e2c  ently.    for n,
-0001d370: 2072 2069 6e20 656e 756d 6572 6174 6528   r in enumerate(
-0001d380: 726f 7773 293a 0a20 2020 2020 2020 2072  rows):.        r
-0001d390: 2e61 6c69 676e 2861 6c69 676e 6d65 6e74  .align(alignment
-0001d3a0: 3d61 6c69 676e 5f79 290a 2020 2020 666f  =align_y).    fo
-0001d3b0: 7220 6e2c 2063 2069 6e20 656e 756d 6572  r n, c in enumer
-0001d3c0: 6174 6528 636f 6c73 293a 0a20 2020 2020  ate(cols):.     
-0001d3d0: 2020 2063 2e61 6c69 676e 2861 6c69 676e     c.align(align
-0001d3e0: 6d65 6e74 3d61 6c69 676e 5f78 290a 0a20  ment=align_x).. 
-0001d3f0: 2020 2023 2044 6973 7472 6962 7574 6520     # Distribute 
-0001d400: 726f 7773 2061 6e64 2063 6f6c 756d 6e73  rows and columns
-0001d410: 0a20 2020 2047 726f 7570 2863 6f6c 7329  .    Group(cols)
-0001d420: 2e64 6973 7472 6962 7574 6528 0a20 2020  .distribute(.   
-0001d430: 2020 2020 2064 6972 6563 7469 6f6e 3d22       direction="
-0001d440: 7822 2c20 7370 6163 696e 673d 7370 6163  x", spacing=spac
-0001d450: 696e 675b 305d 2c20 7365 7061 7261 7469  ing[0], separati
-0001d460: 6f6e 3d73 6570 6172 6174 696f 6e2c 2065  on=separation, e
-0001d470: 6467 653d 6564 6765 5f78 0a20 2020 2029  dge=edge_x.    )
-0001d480: 0a20 2020 2047 726f 7570 2872 6f77 735b  .    Group(rows[
-0001d490: 3a3a 2d31 5d29 2e64 6973 7472 6962 7574  ::-1]).distribut
-0001d4a0: 6528 0a20 2020 2020 2020 2064 6972 6563  e(.        direc
-0001d4b0: 7469 6f6e 3d22 7922 2c20 7370 6163 696e  tion="y", spacin
-0001d4c0: 673d 7370 6163 696e 675b 315d 2c20 7365  g=spacing[1], se
-0001d4d0: 7061 7261 7469 6f6e 3d73 6570 6172 6174  paration=separat
-0001d4e0: 696f 6e2c 2065 6467 653d 6564 6765 5f79  ion, edge=edge_y
-0001d4f0: 0a20 2020 2029 0a0a 2020 2020 2320 7265  .    )..    # re
-0001d500: 7475 726e 2064 6576 6963 655f 6d61 7472  turn device_matr
-0001d510: 6978 0a20 2020 2072 6574 7572 6e20 440a  ix.    return D.
-0001d520: 0a0a 6465 6620 5f70 6172 616d 6574 6572  ..def _parameter
-0001d530: 5f63 6f6d 6269 6e61 7469 6f6e 7328 7061  _combinations(pa
-0001d540: 7261 6d65 7465 7273 5f64 6963 7429 3a0a  rameters_dict):.
-0001d550: 2020 2020 2222 2243 7265 6174 6573 2070      """Creates p
-0001d560: 6172 616d 6574 6572 2063 6f6d 6269 6e61  arameter combina
-0001d570: 7469 6f6e 7320 6672 6f6d 2061 2064 6963  tions from a dic
-0001d580: 7420 6669 6c6c 6564 2077 6974 6820 6c69  t filled with li
-0001d590: 7374 2076 616c 7565 732c 2065 2e67 2e0a  st values, e.g..
-0001d5a0: 2020 2020 7061 7261 6d65 7465 7273 5f64      parameters_d
-0001d5b0: 6963 7420 3d20 7b0a 2020 2020 2020 2020  ict = {.        
-0001d5c0: 2777 6964 7468 2720 3a20 5b30 2e31 2c30  'width' : [0.1,0
-0001d5d0: 2e32 5d2c 0a20 2020 2020 2020 2027 6c65  .2],.        'le
-0001d5e0: 6e67 7468 2720 3a20 5b34 2c35 2c36 5d2c  ngth' : [4,5,6],
-0001d5f0: 0a20 2020 2020 2020 2027 6865 6967 6874  .        'height
-0001d600: 2720 3a20 5b32 325d 0a20 2020 2020 2020  ' : [22].       
-0001d610: 207d 0a20 2020 2057 696c 6c20 7072 6f64   }.    Will prod
-0001d620: 7563 6520 6120 6c69 7374 206f 6620 6469  uce a list of di
-0001d630: 6374 696f 6e61 7269 6573 2c20 6561 6368  ctionaries, each
-0001d640: 206f 6620 7768 6963 6820 6361 6e20 6265   of which can be
-0001d650: 2075 7365 6420 6173 206b 7761 7267 7320   used as kwargs 
-0001d660: 696e 7075 743a 0a20 2020 2020 2020 205b  input:.        [
-0001d670: 7b27 6865 6967 6874 273a 2032 322c 2027  {'height': 22, '
-0001d680: 6c65 6e67 7468 273a 2034 2c20 2777 6964  length': 4, 'wid
-0001d690: 7468 273a 2030 2e31 7d2c 0a20 2020 2020  th': 0.1},.     
-0001d6a0: 2020 2020 7b27 6865 6967 6874 273a 2032      {'height': 2
-0001d6b0: 322c 2027 6c65 6e67 7468 273a 2035 2c20  2, 'length': 5, 
-0001d6c0: 2777 6964 7468 273a 2030 2e31 7d2c 0a20  'width': 0.1},. 
-0001d6d0: 2020 2020 2020 2020 7b27 6865 6967 6874          {'height
-0001d6e0: 273a 2032 322c 2027 6c65 6e67 7468 273a  ': 22, 'length':
-0001d6f0: 2036 2c20 2777 6964 7468 273a 2030 2e31   6, 'width': 0.1
-0001d700: 7d2c 0a20 2020 2020 2020 2020 7b27 6865  },.         {'he
-0001d710: 6967 6874 273a 2032 322c 2027 6c65 6e67  ight': 22, 'leng
-0001d720: 7468 273a 2034 2c20 2777 6964 7468 273a  th': 4, 'width':
-0001d730: 2030 2e32 7d2c 0a20 2020 2020 2020 2020   0.2},.         
-0001d740: 7b27 6865 6967 6874 273a 2032 322c 2027  {'height': 22, '
-0001d750: 6c65 6e67 7468 273a 2035 2c20 2777 6964  length': 5, 'wid
-0001d760: 7468 273a 2030 2e32 7d2c 0a20 2020 2020  th': 0.2},.     
-0001d770: 2020 2020 7b27 6865 6967 6874 273a 2032      {'height': 2
-0001d780: 322c 2027 6c65 6e67 7468 273a 2036 2c20  2, 'length': 6, 
-0001d790: 2777 6964 7468 273a 2030 2e32 7d5d 2222  'width': 0.2}]""
-0001d7a0: 220a 2020 2020 7661 6c75 655f 636f 6d62  ".    value_comb
-0001d7b0: 696e 6174 696f 6e73 203d 206c 6973 7428  inations = list(
-0001d7c0: 6974 6572 746f 6f6c 732e 7072 6f64 7563  itertools.produc
-0001d7d0: 7428 2a70 6172 616d 6574 6572 735f 6469  t(*parameters_di
-0001d7e0: 6374 2e76 616c 7565 7328 2929 290a 2020  ct.values())).  
-0001d7f0: 2020 6b65 7973 203d 206c 6973 7428 7061    keys = list(pa
-0001d800: 7261 6d65 7465 7273 5f64 6963 742e 6b65  rameters_dict.ke
-0001d810: 7973 2829 290a 2020 2020 7265 7475 726e  ys()).    return
-0001d820: 205b 0a20 2020 2020 2020 207b 6b65 7973   [.        {keys
-0001d830: 5b6e 5d3a 2076 616c 7565 735b 6e5d 2066  [n]: values[n] f
-0001d840: 6f72 206e 2069 6e20 7261 6e67 6528 6c65  or n in range(le
-0001d850: 6e28 6b65 7973 2929 7d20 666f 7220 7661  n(keys))} for va
-0001d860: 6c75 6573 2069 6e20 7661 6c75 655f 636f  lues in value_co
-0001d870: 6d62 696e 6174 696f 6e73 0a20 2020 205d  mbinations.    ]
-0001d880: 0a0a 0a64 6566 205f 6765 6e5f 7061 7261  ...def _gen_para
-0001d890: 6d5f 7661 7269 6174 696f 6e73 280a 2020  m_variations(.  
-0001d8a0: 2020 6675 6e63 7469 6f6e 2c20 7061 7261    function, para
-0001d8b0: 6d5f 7661 7269 6174 696f 6e73 2c20 7061  m_variations, pa
-0001d8c0: 7261 6d5f 6465 6661 756c 7473 3d7b 7d2c  ram_defaults={},
-0001d8d0: 2070 6172 616d 5f6f 7665 7272 6964 653d   param_override=
-0001d8e0: 7b7d 2c20 6c61 6265 6c5f 6c61 7965 723d  {}, label_layer=
-0001d8f0: 3235 350a 293a 0a20 2020 2022 2222 5461  255.):.    """Ta
-0001d900: 6b65 7320 652e 672e 0a0a 2020 2020 7061  kes e.g...    pa
-0001d910: 7261 6d5f 7661 7269 6174 696f 6e73 203d  ram_variations =
-0001d920: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
-0001d930: 6368 616e 6e65 6c5f 7769 6474 6827 203a  channel_width' :
-0001d940: 205b 312c 322c 335d 0a20 2020 2020 2020   [1,2,3].       
-0001d950: 2020 2020 2027 6761 7465 5f77 6964 7468       'gate_width
-0001d960: 2720 3a20 5b30 2e31 2c30 2e32 2c30 2e34  ' : [0.1,0.2,0.4
-0001d970: 5d2c 0a20 2020 2020 2020 2020 2020 207d  ],.            }
-0001d980: 0a20 2020 2020 2020 6f72 2065 7175 6976  .       or equiv
-0001d990: 616c 656e 746c 790a 2020 2020 7061 7261  alently.    para
-0001d9a0: 6d5f 7661 7269 6174 696f 6e73 203d 2064  m_variations = d
-0001d9b0: 6963 7428 0a20 2020 2020 2020 2020 2020  ict(.           
-0001d9c0: 2063 6861 6e6e 656c 5f77 6964 7468 203d   channel_width =
-0001d9d0: 205b 312c 322c 335d 2c0a 2020 2020 2020   [1,2,3],.      
-0001d9e0: 2020 2020 2020 6761 7465 5f77 6964 7468        gate_width
-0001d9f0: 203d 205b 302e 312c 302e 322c 302e 345d   = [0.1,0.2,0.4]
-0001da00: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-0001da10: 2020 2020 2222 220a 2020 2020 7061 7261      """.    para
-0001da20: 6d65 7465 725f 6c69 7374 203d 205f 7061  meter_list = _pa
-0001da30: 7261 6d65 7465 725f 636f 6d62 696e 6174  rameter_combinat
-0001da40: 696f 6e73 2870 6172 616d 5f76 6172 6961  ions(param_varia
-0001da50: 7469 6f6e 7329 0a0a 2020 2020 2320 506f  tions)..    # Po
-0001da60: 7020 6f75 7420 616e 7920 4e6f 6e65 2076  p out any None v
-0001da70: 616c 7565 730a 2020 2020 5b70 6172 616d  alues.    [param
-0001da80: 732e 706f 7028 284e 6f6e 652c 2022 7822  s.pop((None, "x"
-0001da90: 292c 204e 6f6e 6529 2066 6f72 2070 6172  ), None) for par
-0001daa0: 616d 7320 696e 2070 6172 616d 6574 6572  ams in parameter
-0001dab0: 5f6c 6973 745d 0a20 2020 205b 7061 7261  _list].    [para
-0001dac0: 6d73 2e70 6f70 2828 4e6f 6e65 2c20 2279  ms.pop((None, "y
-0001dad0: 2229 2c20 4e6f 6e65 2920 666f 7220 7061  "), None) for pa
-0001dae0: 7261 6d73 2069 6e20 7061 7261 6d65 7465  rams in paramete
-0001daf0: 725f 6c69 7374 5d0a 0a20 2020 2044 5f6c  r_list]..    D_l
-0001db00: 6973 7420 3d20 5b5d 0a20 2020 2066 6f72  ist = [].    for
-0001db10: 2070 6172 616d 7320 696e 2070 6172 616d   params in param
-0001db20: 6574 6572 5f6c 6973 743a 0a20 2020 2020  eter_list:.     
-0001db30: 2020 206e 6577 5f70 6172 616d 7320 3d20     new_params = 
-0001db40: 6469 6374 2829 0a20 2020 2020 2020 206e  dict().        n
-0001db50: 6577 5f70 6172 616d 732e 7570 6461 7465  ew_params.update
-0001db60: 2870 6172 616d 7329 0a20 2020 2020 2020  (params).       
-0001db70: 206e 6577 5f70 6172 616d 732e 7570 6461   new_params.upda
-0001db80: 7465 2870 6172 616d 5f6f 7665 7272 6964  te(param_overrid
-0001db90: 6529 0a20 2020 2020 2020 2044 5f6e 6577  e).        D_new
-0001dba0: 203d 206d 616b 655f 6465 7669 6365 2866   = make_device(f
-0001dbb0: 756e 6374 696f 6e2c 2063 6f6e 6669 673d  unction, config=
-0001dbc0: 7061 7261 6d5f 6465 6661 756c 7473 2c20  param_defaults, 
-0001dbd0: 2a2a 6e65 775f 7061 7261 6d73 290a 2020  **new_params).  
-0001dbe0: 2020 2020 2020 6c61 6265 6c5f 7465 7874        label_text
-0001dbf0: 203d 2022 220a 2020 2020 2020 2020 666f   = "".        fo
-0001dc00: 7220 6e61 6d65 2c20 7661 6c75 6520 696e  r name, value in
-0001dc10: 2070 6172 616d 732e 6974 656d 7328 293a   params.items():
-0001dc20: 0a20 2020 2020 2020 2020 2020 206c 6162  .            lab
-0001dc30: 656c 5f74 6578 7420 2b3d 2028 6622 7b6e  el_text += (f"{n
-0001dc40: 616d 657d 3d7b 7661 6c75 657d 2229 202b  ame}={value}") +
-0001dc50: 2022 5c6e 220a 2020 2020 2020 2020 6966   "\n".        if
-0001dc60: 206c 6162 656c 5f6c 6179 6572 2069 7320   label_layer is 
-0001dc70: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0001dc80: 2020 2020 2020 445f 6e65 772e 6164 645f        D_new.add_
-0001dc90: 6c61 6265 6c28 7465 7874 3d6c 6162 656c  label(text=label
-0001dca0: 5f74 6578 742c 2070 6f73 6974 696f 6e3d  _text, position=
-0001dcb0: 445f 6e65 772e 6365 6e74 6572 2c20 6c61  D_new.center, la
-0001dcc0: 7965 723d 6c61 6265 6c5f 6c61 7965 7229  yer=label_layer)
-0001dcd0: 0a0a 2020 2020 2020 2020 445f 6c69 7374  ..        D_list
-0001dce0: 2e61 7070 656e 6428 445f 6e65 7729 0a20  .append(D_new). 
-0001dcf0: 2020 2072 6574 7572 6e20 445f 6c69 7374     return D_list
-0001dd00: 0a0a 0a64 6566 2067 7269 6473 7765 6570  ...def gridsweep
-0001dd10: 280a 2020 2020 6675 6e63 7469 6f6e 2c0a  (.    function,.
-0001dd20: 2020 2020 7061 7261 6d5f 783d 7b22 7769      param_x={"wi
-0001dd30: 6474 6822 3a20 5b31 2c20 352c 2036 2c20  dth": [1, 5, 6, 
-0001dd40: 375d 7d2c 0a20 2020 2070 6172 616d 5f79  7]},.    param_y
-0001dd50: 3d7b 226c 656e 6774 6822 3a20 5b31 2e31  ={"length": [1.1
-0001dd60: 2c20 322c 2037 305d 7d2c 0a20 2020 2070  , 2, 70]},.    p
-0001dd70: 6172 616d 5f64 6566 6175 6c74 733d 7b7d  aram_defaults={}
-0001dd80: 2c0a 2020 2020 7061 7261 6d5f 6f76 6572  ,.    param_over
-0001dd90: 7269 6465 3d7b 7d2c 0a20 2020 2073 7061  ride={},.    spa
-0001dda0: 6369 6e67 3d28 3530 2c20 3130 3029 2c0a  cing=(50, 100),.
-0001ddb0: 2020 2020 7365 7061 7261 7469 6f6e 3d54      separation=T
-0001ddc0: 7275 652c 0a20 2020 2061 6c69 676e 5f78  rue,.    align_x
-0001ddd0: 3d22 7822 2c0a 2020 2020 616c 6967 6e5f  ="x",.    align_
-0001dde0: 793d 2279 222c 0a20 2020 2065 6467 655f  y="y",.    edge_
-0001ddf0: 783d 2278 222c 0a20 2020 2065 6467 655f  x="x",.    edge_
-0001de00: 793d 2279 6d69 6e22 2c0a 2020 2020 6c61  y="ymin",.    la
-0001de10: 6265 6c5f 6c61 7965 723d 3235 352c 0a29  bel_layer=255,.)
-0001de20: 3a0a 2020 2020 2222 2243 7265 6174 6573  :.    """Creates
-0001de30: 2061 2070 6172 616d 6574 6572 2073 7765   a parameter swe
-0001de40: 6570 206f 6620 6465 7669 6365 7320 616e  ep of devices an
-0001de50: 6420 706c 6163 6573 2074 6865 6d20 6f6e  d places them on
-0001de60: 2061 2067 7269 6420 7769 7468 0a20 2020   a grid with.   
-0001de70: 206c 6162 656c 7320 666f 7220 6561 6368   labels for each
-0001de80: 2064 6576 6963 652e 2046 6f72 2069 6e73   device. For ins
-0001de90: 7461 6e63 652c 2067 6976 656e 2061 2066  tance, given a f
-0001dea0: 756e 6374 696f 6e20 6465 6669 6e65 6420  unction defined 
-0001deb0: 6c69 6b65 0a20 2020 2060 6d79 7368 6170  like.    `myshap
-0001dec0: 6528 7769 6474 682c 2068 6569 6768 742c  e(width, height,
-0001ded0: 206f 6666 7365 742c 206c 6179 6572 2960   offset, layer)`
-0001dee0: 2061 6e64 2074 6865 2066 6f6c 6c6f 7769   and the followi
-0001def0: 6e67 2070 6172 616d 6574 6572 733a 0a20  ng parameters:. 
-0001df00: 2020 2020 2020 2070 6172 616d 5f78 203d         param_x =
-0001df10: 207b 2777 6964 7468 2720 3a20 205b 342c   {'width' :  [4,
-0001df20: 2035 2c20 365d 2020 7d2c 0a20 2020 2020   5, 6]  },.     
-0001df30: 2020 2070 6172 616d 5f79 203d 207b 2768     param_y = {'h
-0001df40: 6569 6768 7427 203a 205b 372c 2039 5d2c  eight' : [7, 9],
-0001df50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001df60: 2020 2020 276c 6179 6572 2720 3a20 205b      'layer' :  [
-0001df70: 312c 2032 2c20 335d 2020 7d2c 0a20 2020  1, 2, 3]  },.   
-0001df80: 2020 2020 2070 6172 616d 5f64 6566 6175       param_defau
-0001df90: 6c74 7320 3d20 7b27 7363 616c 6527 203a  lts = {'scale' :
-0001dfa0: 2031 7d0a 0a20 2020 2067 7269 6473 7765   1}..    gridswe
-0001dfb0: 6570 2829 2070 726f 6475 6365 2061 2067  ep() produce a g
-0001dfc0: 7269 6420 6f66 2064 6576 6963 6573 2077  rid of devices w
-0001dfd0: 6974 6820 7468 6520 666f 6c6c 6f77 696e  ith the followin
-0001dfe0: 6720 6c61 796f 7574 2f70 6172 616d 6574  g layout/paramet
-0001dff0: 6572 733a 0a20 2020 2020 2020 2028 773d  ers:.        (w=
-0001e000: 342c 2068 3d37 2c20 733d 312c 206c 3d31  4, h=7, s=1, l=1
-0001e010: 2920 2020 2028 773d 352c 2068 3d37 2c20  )    (w=5, h=7, 
-0001e020: 733d 312c 206c 3d31 2920 2020 2028 773d  s=1, l=1)    (w=
-0001e030: 362c 2068 3d37 2c20 733d 312c 206c 3d31  6, h=7, s=1, l=1
-0001e040: 290a 2020 2020 2020 2020 2877 3d34 2c20  ).        (w=4, 
-0001e050: 683d 372c 2073 3d31 2c20 6c3d 3229 2020  h=7, s=1, l=2)  
-0001e060: 2020 2877 3d35 2c20 683d 372c 2073 3d31    (w=5, h=7, s=1
-0001e070: 2c20 6c3d 3229 2020 2020 2877 3d36 2c20  , l=2)    (w=6, 
-0001e080: 683d 372c 2073 3d31 2c20 6c3d 3229 0a20  h=7, s=1, l=2). 
-0001e090: 2020 2020 2020 2028 773d 342c 2068 3d37         (w=4, h=7
-0001e0a0: 2c20 733d 312c 206c 3d33 2920 2020 2028  , s=1, l=3)    (
-0001e0b0: 773d 352c 2068 3d37 2c20 733d 312c 206c  w=5, h=7, s=1, l
-0001e0c0: 3d33 2920 2020 2028 773d 362c 2068 3d37  =3)    (w=6, h=7
-0001e0d0: 2c20 733d 312c 206c 3d33 290a 2020 2020  , s=1, l=3).    
-0001e0e0: 2020 2020 2877 3d34 2c20 683d 392c 2073      (w=4, h=9, s
-0001e0f0: 3d31 2c20 6c3d 3129 2020 2020 2877 3d35  =1, l=1)    (w=5
-0001e100: 2c20 683d 392c 2073 3d31 2c20 6c3d 3129  , h=9, s=1, l=1)
-0001e110: 2020 2020 2877 3d36 2c20 683d 392c 2073      (w=6, h=9, s
-0001e120: 3d31 2c20 6c3d 3129 0a20 2020 2020 2020  =1, l=1).       
-0001e130: 2028 773d 342c 2068 3d39 2c20 733d 312c   (w=4, h=9, s=1,
-0001e140: 206c 3d32 2920 2020 2028 773d 352c 2068   l=2)    (w=5, h
-0001e150: 3d39 2c20 733d 312c 206c 3d32 2920 2020  =9, s=1, l=2)   
-0001e160: 2028 773d 362c 2068 3d39 2c20 733d 312c   (w=6, h=9, s=1,
-0001e170: 206c 3d32 290a 2020 2020 2020 2020 2877   l=2).        (w
-0001e180: 3d34 2c20 683d 392c 2073 3d31 2c20 6c3d  =4, h=9, s=1, l=
-0001e190: 3329 2020 2020 2877 3d35 2c20 683d 392c  3)    (w=5, h=9,
-0001e1a0: 2073 3d31 2c20 6c3d 3329 2020 2020 2877   s=1, l=3)    (w
-0001e1b0: 3d36 2c20 683d 392c 2073 3d31 2c20 6c3d  =6, h=9, s=1, l=
-0001e1c0: 3329 0a0a 0a20 2020 2050 6172 616d 6574  3)...    Paramet
-0001e1d0: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-0001e1e0: 2d2d 0a20 2020 2066 756e 6374 696f 6e20  --.    function 
-0001e1f0: 3a20 6675 6e63 7469 6f6e 2074 6861 7420  : function that 
-0001e200: 7072 6f64 7563 6573 2061 2044 6576 6963  produces a Devic
-0001e210: 650a 2020 2020 2020 2020 5468 6520 6675  e.        The fu
-0001e220: 6e63 7469 6f6e 2077 6869 6368 2077 696c  nction which wil
-0001e230: 6c20 6265 2075 7365 6420 746f 2063 7265  l be used to cre
-0001e240: 6174 6520 7468 6520 696e 6469 7669 6475  ate the individu
-0001e250: 616c 2064 6576 6963 6573 2069 6e20 7468  al devices in th
-0001e260: 650a 2020 2020 2020 2020 6772 6964 2e20  e.        grid. 
-0001e270: 204d 7573 7420 6f6e 6c79 2072 6574 7572   Must only retur
-0001e280: 6e20 6120 7369 6e67 6c65 2044 6576 6963  n a single Devic
-0001e290: 6520 2865 2e67 2e20 616e 7920 6f66 2074  e (e.g. any of t
-0001e2a0: 6865 2066 756e 6374 696f 6e73 2069 6e0a  he functions in.
-0001e2b0: 2020 2020 2020 2020 7067 2e67 656f 6d65          pg.geome
-0001e2c0: 7472 7929 0a20 2020 2070 6172 616d 5f78  try).    param_x
-0001e2d0: 203a 2064 6963 742c 2069 6e74 2c20 4e6f   : dict, int, No
-0001e2e0: 6e65 0a20 2020 2020 2020 2041 2064 6963  ne.        A dic
-0001e2f0: 7469 6f6e 6172 7920 6f66 206f 6e65 206f  tionary of one o
-0001e300: 7220 6d6f 7265 2070 6172 616d 6574 6572  r more parameter
-0001e310: 7320 746f 2073 7765 6570 2069 6e20 7468  s to sweep in th
-0001e320: 6520 782d 6469 7265 6374 696f 6e2e 0a20  e x-direction.. 
-0001e330: 2020 2020 2020 2049 6620 4e6f 6e65 2c20         If None, 
-0001e340: 646f 206e 6f74 2073 7765 6570 2e20 4966  do not sweep. If
-0001e350: 2069 6e74 2c20 7265 7065 6174 204e 2074   int, repeat N t
-0001e360: 696d 6573 2069 6e20 782d 6469 7265 6374  imes in x-direct
-0001e370: 696f 6e0a 2020 2020 7061 7261 6d5f 7920  ion.    param_y 
-0001e380: 3a20 6469 6374 2c20 696e 742c 204e 6f6e  : dict, int, Non
-0001e390: 650a 2020 2020 2020 2020 4120 6469 6374  e.        A dict
-0001e3a0: 696f 6e61 7279 206f 6620 6f6e 6520 6f72  ionary of one or
-0001e3b0: 206d 6f72 6520 7061 7261 6d65 7465 7273   more parameters
-0001e3c0: 2074 6f20 7377 6565 7020 696e 2074 6865   to sweep in the
-0001e3d0: 2079 2d64 6972 6563 7469 6f6e 2e0a 2020   y-direction..  
-0001e3e0: 2020 2020 2020 4966 204e 6f6e 652c 2064        If None, d
-0001e3f0: 6f20 6e6f 7420 7377 6565 702e 2049 6620  o not sweep. If 
-0001e400: 696e 742c 2072 6570 6561 7420 4e20 7469  int, repeat N ti
-0001e410: 6d65 7320 696e 2079 2d64 6972 6563 7469  mes in y-directi
-0001e420: 6f6e 0a20 2020 2070 6172 616d 5f64 6566  on.    param_def
-0001e430: 6175 6c74 7320 3a20 6469 6374 0a20 2020  aults : dict.   
-0001e440: 2020 2020 2044 6566 6175 6c74 2070 6172       Default par
-0001e450: 616d 6574 6572 7320 746f 2070 6173 7320  ameters to pass 
-0001e460: 746f 2065 7665 7279 2064 6576 6963 6520  to every device 
-0001e470: 696e 2074 6865 2067 7269 640a 2020 2020  in the grid.    
-0001e480: 7061 7261 6d5f 6f76 6572 7269 6465 203a  param_override :
-0001e490: 2064 6963 740a 2020 2020 2020 2020 5061   dict.        Pa
-0001e4a0: 7261 6d65 7465 7273 2074 6861 7420 7769  rameters that wi
-0001e4b0: 6c6c 206f 7665 7272 6964 6520 6070 6172  ll override `par
-0001e4c0: 616d 5f64 6566 6175 6c74 7360 2c20 6571  am_defaults`, eq
-0001e4d0: 7569 7661 6c65 6e74 2074 6f20 6368 616e  uivalent to chan
-0001e4e0: 6769 6e67 0a20 2020 2020 2020 2070 6172  ging.        par
-0001e4f0: 616d 5f64 6566 6175 6c74 7320 2875 7365  am_defaults (use
-0001e500: 6675 6c20 290a 2020 2020 7370 6163 696e  ful ).    spacin
-0001e510: 6720 3a20 696e 742c 2066 6c6f 6174 2c20  g : int, float, 
-0001e520: 6f72 2061 7272 6179 2d6c 696b 655b 325d  or array-like[2]
-0001e530: 206f 6620 696e 7420 6f72 2066 6c6f 6174   of int or float
-0001e540: 0a20 2020 2020 2020 2053 7061 6369 6e67  .        Spacing
-0001e550: 2062 6574 7765 656e 2061 646a 6163 656e   between adjacen
-0001e560: 7420 656c 656d 656e 7473 206f 6e20 7468  t elements on th
-0001e570: 6520 6772 6964 2c20 6361 6e20 6265 2061  e grid, can be a
-0001e580: 2074 7570 6c65 2066 6f72 0a20 2020 2020   tuple for.     
-0001e590: 2020 2064 6966 6665 7265 6e74 2064 6973     different dis
-0001e5a0: 7461 6e63 6573 2069 6e20 7769 6474 6820  tances in width 
-0001e5b0: 616e 6420 6865 6967 6874 2028 782c 7929  and height (x,y)
-0001e5c0: 2e0a 2020 2020 7365 7061 7261 7469 6f6e  ..    separation
-0001e5d0: 203a 2062 6f6f 6c0a 2020 2020 2020 2020   : bool.        
-0001e5e0: 4966 2054 7275 652c 2067 7561 7261 6e74  If True, guarant
-0001e5f0: 6565 7320 656c 656d 656e 7473 2061 7265  ees elements are
-0001e600: 2073 6570 6172 6174 6564 2077 6974 6820   separated with 
-0001e610: 6120 6669 7865 6420 7370 6163 696e 670a  a fixed spacing.
-0001e620: 2020 2020 2020 2020 6265 7477 6565 6e3b          between;
-0001e630: 2069 6620 4661 6c73 652c 2065 6c65 6d65   if False, eleme
-0001e640: 6e74 7320 6172 6520 7370 6163 6564 2065  nts are spaced e
-0001e650: 7665 6e6c 7920 616c 6f6e 6720 6120 6772  venly along a gr
-0001e660: 6964 2e0a 2020 2020 7368 6170 6520 3a20  id..    shape : 
-0001e670: 6172 7261 792d 6c69 6b65 5b32 5d0a 2020  array-like[2].  
-0001e680: 2020 2020 2020 782c 2079 2073 6861 7065        x, y shape
-0001e690: 206f 6620 7468 6520 6772 6964 2028 7365   of the grid (se
-0001e6a0: 6520 6e70 2e72 6573 6861 7065 292e 2049  e np.reshape). I
-0001e6b0: 6620 6e6f 2073 6861 7065 2069 7320 6769  f no shape is gi
-0001e6c0: 7665 6e20 616e 6420 7468 650a 2020 2020  ven and the.    
-0001e6d0: 2020 2020 6c69 7374 2069 7320 3144 2c20      list is 1D, 
-0001e6e0: 7468 6520 6f75 7470 7574 2069 7320 6173  the output is as
-0001e6f0: 2069 6620 6e70 2e72 6573 6861 7065 2077   if np.reshape w
-0001e700: 6572 6520 7275 6e20 7769 7468 2028 312c  ere run with (1,
-0001e710: 202d 3129 2e0a 2020 2020 616c 6967 6e5f   -1)..    align_
-0001e720: 7820 3a20 7b27 7827 2c20 2778 6d69 6e27  x : {'x', 'xmin'
-0001e730: 2c20 2778 6d61 7827 7d0a 2020 2020 2020  , 'xmax'}.      
-0001e740: 2020 5768 6963 6820 6564 6765 2074 6f20    Which edge to 
-0001e750: 7065 7266 6f72 6d20 7468 6520 7820 2863  perform the x (c
-0001e760: 6f6c 756d 6e29 2061 6c69 676e 6d65 6e74  olumn) alignment
-0001e770: 2061 6c6f 6e67 0a20 2020 2061 6c69 676e   along.    align
-0001e780: 5f79 203a 207b 2779 272c 2027 796d 696e  _y : {'y', 'ymin
-0001e790: 272c 2027 796d 6178 277d 0a20 2020 2020  ', 'ymax'}.     
-0001e7a0: 2020 2057 6869 6368 2065 6467 6520 746f     Which edge to
-0001e7b0: 2070 6572 666f 726d 2074 6865 2079 2028   perform the y (
-0001e7c0: 726f 7729 2061 6c69 676e 6d65 6e74 2061  row) alignment a
-0001e7d0: 6c6f 6e67 0a20 2020 2065 6467 655f 7820  long.    edge_x 
-0001e7e0: 3a20 7b27 7827 2c20 2778 6d69 6e27 2c20  : {'x', 'xmin', 
-0001e7f0: 2778 6d61 7827 7d0a 2020 2020 2020 2020  'xmax'}.        
-0001e800: 5768 6963 6820 6564 6765 2074 6f20 7065  Which edge to pe
-0001e810: 7266 6f72 6d20 7468 6520 7820 2863 6f6c  rform the x (col
-0001e820: 756d 6e29 2064 6973 7472 6962 7574 696f  umn) distributio
-0001e830: 6e20 616c 6f6e 6720 2875 6e75 7365 6420  n along (unused 
-0001e840: 6966 0a20 2020 2020 2020 2073 6570 6172  if.        separ
-0001e850: 6174 696f 6e20 3d3d 2054 7275 6529 0a20  ation == True). 
-0001e860: 2020 2065 6467 655f 7920 3a20 7b27 7927     edge_y : {'y'
-0001e870: 2c20 2779 6d69 6e27 2c20 2779 6d61 7827  , 'ymin', 'ymax'
-0001e880: 7d0a 2020 2020 2020 2020 5768 6963 6820  }.        Which 
-0001e890: 6564 6765 2074 6f20 7065 7266 6f72 6d20  edge to perform 
-0001e8a0: 7468 6520 7920 2872 6f77 2920 6469 7374  the y (row) dist
-0001e8b0: 7269 6275 7469 6f6e 2061 6c6f 6e67 2028  ribution along (
-0001e8c0: 756e 7573 6564 2069 660a 2020 2020 2020  unused if.      
-0001e8d0: 2020 7365 7061 7261 7469 6f6e 203d 3d20    separation == 
-0001e8e0: 5472 7565 290a 2020 2020 6c61 6265 6c5f  True).    label_
-0001e8f0: 6c61 7965 7220 3a20 4e6f 6e65 206f 7220  layer : None or 
-0001e900: 6c61 7965 720a 2020 2020 2020 2020 4966  layer.        If
-0001e910: 206e 6f74 204e 6f6e 652c 2077 696c 6c20   not None, will 
-0001e920: 706c 6163 6520 6120 6c61 6265 6c20 7468  place a label th
-0001e930: 6174 2064 6573 6372 6962 6573 2074 6865  at describes the
-0001e940: 2070 6172 616d 6574 6572 7320 6f6e 2074   parameters on t
-0001e950: 6865 2064 6576 6963 650a 0a20 2020 2052  he device..    R
-0001e960: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-0001e970: 2d2d 0a20 2020 2064 6576 6963 655f 6d61  --.    device_ma
-0001e980: 7472 6978 203a 2044 6576 6963 650a 2020  trix : Device.  
-0001e990: 2020 2020 2020 4120 4465 7669 6365 2063        A Device c
-0001e9a0: 6f6e 7461 696e 696e 6720 616c 6c20 7468  ontaining all th
-0001e9b0: 6520 4465 7669 6365 7320 696e 2060 6465  e Devices in `de
-0001e9c0: 7669 6365 5f6c 6973 7460 2069 6e20 6120  vice_list` in a 
-0001e9d0: 6772 6964 2e0a 2020 2020 2222 220a 2020  grid..    """.  
-0001e9e0: 2020 6966 2070 6172 616d 5f78 2069 7320    if param_x is 
-0001e9f0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7061  None:.        pa
-0001ea00: 7261 6d5f 7820 3d20 7b28 4e6f 6e65 2c20  ram_x = {(None, 
-0001ea10: 2278 2229 3a20 5b4e 6f6e 655d 7d0a 2020  "x"): [None]}.  
-0001ea20: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-0001ea30: 6528 7061 7261 6d5f 782c 2069 6e74 293a  e(param_x, int):
-0001ea40: 0a20 2020 2020 2020 2070 6172 616d 5f78  .        param_x
-0001ea50: 203d 207b 284e 6f6e 652c 2022 7822 293a   = {(None, "x"):
-0001ea60: 205b 4e6f 6e65 5d20 2a20 7061 7261 6d5f   [None] * param_
-0001ea70: 787d 0a20 2020 2069 6620 7061 7261 6d5f  x}.    if param_
-0001ea80: 7920 6973 204e 6f6e 653a 0a20 2020 2020  y is None:.     
-0001ea90: 2020 2070 6172 616d 5f79 203d 207b 284e     param_y = {(N
-0001eaa0: 6f6e 652c 2022 7922 293a 205b 4e6f 6e65  one, "y"): [None
-0001eab0: 5d7d 0a20 2020 2065 6c69 6620 6973 696e  ]}.    elif isin
-0001eac0: 7374 616e 6365 2870 6172 616d 5f79 2c20  stance(param_y, 
-0001ead0: 696e 7429 3a0a 2020 2020 2020 2020 7061  int):.        pa
-0001eae0: 7261 6d5f 7920 3d20 7b28 4e6f 6e65 2c20  ram_y = {(None, 
-0001eaf0: 2279 2229 3a20 5b4e 6f6e 655d 202a 2070  "y"): [None] * p
-0001eb00: 6172 616d 5f79 7d0a 0a20 2020 2070 6172  aram_y}..    par
-0001eb10: 616d 5f76 6172 6961 7469 6f6e 7320 3d20  am_variations = 
-0001eb20: 4f72 6465 7265 6444 6963 7428 290a 2020  OrderedDict().  
-0001eb30: 2020 7061 7261 6d5f 7661 7269 6174 696f    param_variatio
-0001eb40: 6e73 2e75 7064 6174 6528 7061 7261 6d5f  ns.update(param_
-0001eb50: 7929 0a20 2020 2070 6172 616d 5f76 6172  y).    param_var
-0001eb60: 6961 7469 6f6e 732e 7570 6461 7465 2870  iations.update(p
-0001eb70: 6172 616d 5f78 290a 0a20 2020 2044 5f6c  aram_x)..    D_l
-0001eb80: 6973 7420 3d20 5f67 656e 5f70 6172 616d  ist = _gen_param
-0001eb90: 5f76 6172 6961 7469 6f6e 7328 0a20 2020  _variations(.   
-0001eba0: 2020 2020 2066 756e 6374 696f 6e3d 6675       function=fu
-0001ebb0: 6e63 7469 6f6e 2c0a 2020 2020 2020 2020  nction,.        
-0001ebc0: 7061 7261 6d5f 7661 7269 6174 696f 6e73  param_variations
-0001ebd0: 3d70 6172 616d 5f76 6172 6961 7469 6f6e  =param_variation
-0001ebe0: 732c 0a20 2020 2020 2020 2070 6172 616d  s,.        param
-0001ebf0: 5f64 6566 6175 6c74 733d 7061 7261 6d5f  _defaults=param_
-0001ec00: 6465 6661 756c 7473 2c0a 2020 2020 2020  defaults,.      
-0001ec10: 2020 7061 7261 6d5f 6f76 6572 7269 6465    param_override
-0001ec20: 3d70 6172 616d 5f6f 7665 7272 6964 652c  =param_override,
-0001ec30: 0a20 2020 2020 2020 206c 6162 656c 5f6c  .        label_l
-0001ec40: 6179 6572 3d6c 6162 656c 5f6c 6179 6572  ayer=label_layer
-0001ec50: 2c0a 2020 2020 290a 0a20 2020 206e 756d  ,.    )..    num
-0001ec60: 5f78 5f70 6172 616d 6574 6572 7320 3d20  _x_parameters = 
-0001ec70: 6c65 6e28 5f70 6172 616d 6574 6572 5f63  len(_parameter_c
-0001ec80: 6f6d 6269 6e61 7469 6f6e 7328 7061 7261  ombinations(para
-0001ec90: 6d5f 7829 290a 2020 2020 6e75 6d5f 795f  m_x)).    num_y_
-0001eca0: 7061 7261 6d65 7465 7273 203d 206c 656e  parameters = len
-0001ecb0: 285f 7061 7261 6d65 7465 725f 636f 6d62  (_parameter_comb
-0001ecc0: 696e 6174 696f 6e73 2870 6172 616d 5f79  inations(param_y
-0001ecd0: 2929 0a20 2020 2044 203d 2067 7269 6428  )).    D = grid(
-0001ece0: 0a20 2020 2020 2020 2044 5f6c 6973 742c  .        D_list,
-0001ecf0: 0a20 2020 2020 2020 2073 7061 6369 6e67  .        spacing
-0001ed00: 3d73 7061 6369 6e67 2c0a 2020 2020 2020  =spacing,.      
-0001ed10: 2020 7365 7061 7261 7469 6f6e 3d73 6570    separation=sep
-0001ed20: 6172 6174 696f 6e2c 0a20 2020 2020 2020  aration,.       
-0001ed30: 2073 6861 7065 3d28 6e75 6d5f 785f 7061   shape=(num_x_pa
-0001ed40: 7261 6d65 7465 7273 2c20 6e75 6d5f 795f  rameters, num_y_
-0001ed50: 7061 7261 6d65 7465 7273 292c 0a20 2020  parameters),.   
-0001ed60: 2020 2020 2061 6c69 676e 5f78 3d61 6c69       align_x=ali
-0001ed70: 676e 5f78 2c0a 2020 2020 2020 2020 616c  gn_x,.        al
-0001ed80: 6967 6e5f 793d 616c 6967 6e5f 792c 0a20  ign_y=align_y,. 
-0001ed90: 2020 2020 2020 2065 6467 655f 783d 6564         edge_x=ed
-0001eda0: 6765 5f78 2c0a 2020 2020 2020 2020 6564  ge_x,.        ed
-0001edb0: 6765 5f79 3d65 6467 655f 792c 0a20 2020  ge_y=edge_y,.   
-0001edc0: 2029 0a0a 2020 2020 6c61 6265 6c5f 7465   )..    label_te
-0001edd0: 7874 203d 207b 7d0a 2020 2020 6c61 6265  xt = {}.    labe
-0001ede0: 6c5f 7465 7874 2e75 7064 6174 6528 7061  l_text.update(pa
-0001edf0: 7261 6d5f 6465 6661 756c 7473 290a 2020  ram_defaults).  
-0001ee00: 2020 6c61 6265 6c5f 7465 7874 2e75 7064    label_text.upd
-0001ee10: 6174 6528 7061 7261 6d5f 6f76 6572 7269  ate(param_overri
-0001ee20: 6465 290a 2020 2020 6966 206c 6162 656c  de).    if label
-0001ee30: 5f6c 6179 6572 2069 7320 6e6f 7420 4e6f  _layer is not No
-0001ee40: 6e65 3a0a 2020 2020 2020 2020 442e 6164  ne:.        D.ad
-0001ee50: 645f 6c61 6265 6c28 7465 7874 3d73 7472  d_label(text=str
-0001ee60: 286c 6162 656c 5f74 6578 7429 2c20 706f  (label_text), po
-0001ee70: 7369 7469 6f6e 3d28 442e 786d 696e 2c20  sition=(D.xmin, 
-0001ee80: 442e 796d 696e 292c 206c 6179 6572 3d6c  D.ymin), layer=l
-0001ee90: 6162 656c 5f6c 6179 6572 290a 0a20 2020  abel_layer)..   
-0001eea0: 2072 6574 7572 6e20 440a 0a0a 6465 6620   return D...def 
-0001eeb0: 5f70 6163 6b5f 7369 6e67 6c65 5f62 696e  _pack_single_bin
-0001eec0: 280a 2020 2020 7265 6374 5f64 6963 742c  (.    rect_dict,
-0001eed0: 2061 7370 6563 745f 7261 7469 6f2c 206d   aspect_ratio, m
-0001eee0: 6178 5f73 697a 652c 2073 6f72 745f 6279  ax_size, sort_by
-0001eef0: 5f61 7265 612c 2064 656e 7369 7479 2c20  _area, density, 
-0001ef00: 7072 6563 6973 696f 6e2c 2076 6572 626f  precision, verbo
-0001ef10: 7365 0a29 3a0a 2020 2020 2222 2254 616b  se.):.    """Tak
-0001ef20: 6573 2061 2060 7265 6374 5f64 6963 7460  es a `rect_dict`
-0001ef30: 2061 7267 756d 656e 7420 6f66 2074 6865   argument of the
-0001ef40: 2066 6f72 6d20 7b69 643a 2877 2c20 6829   form {id:(w, h)
-0001ef50: 7d20 616e 6420 7472 6965 7320 746f 0a20  } and tries to. 
-0001ef60: 2020 2070 6163 6b20 6974 2069 6e74 6f20     pack it into 
-0001ef70: 6120 6269 6e20 6173 2073 6d61 6c6c 2061  a bin as small a
-0001ef80: 7320 706f 7373 6962 6c65 2077 6974 6820  s possible with 
-0001ef90: 6173 7065 6374 2072 6174 696f 2060 6173  aspect ratio `as
-0001efa0: 7065 6374 5f72 6174 696f 602e 0a20 2020  pect_ratio`..   
-0001efb0: 2057 696c 6c20 6974 6572 6174 6976 656c   Will iterativel
-0001efc0: 7920 6772 6f77 2074 6865 2062 696e 2073  y grow the bin s
-0001efd0: 697a 6520 756e 7469 6c20 6576 6572 7974  ize until everyt
-0001efe0: 6869 6e67 2066 6974 7320 6f72 2074 6865  hing fits or the
-0001eff0: 2062 696e 2073 697a 650a 2020 2020 7265   bin size.    re
-0001f000: 6163 6865 7320 606d 6178 5f73 697a 6560  aches `max_size`
-0001f010: 2e20 5265 7475 726e 7320 6120 6469 6374  . Returns a dict
-0001f020: 696f 6e61 7279 206f 6620 7468 6520 7061  ionary of the pa
-0001f030: 636b 6564 2072 6563 7461 6e67 6c65 736e  cked rectanglesn
-0001f040: 2069 6e20 7468 650a 2020 2020 666f 726d   in the.    form
-0001f050: 207b 6964 3a28 782c 2079 2c20 772c 2068   {id:(x, y, w, h
-0001f060: 297d 2c20 616e 6420 6120 6469 6374 696f  )}, and a dictio
-0001f070: 6e61 7279 206f 6620 7265 6d61 696e 696e  nary of remainin
-0001f080: 6720 756e 7061 636b 6564 2072 6563 7473  g unpacked rects
-0001f090: 2e0a 2020 2020 2222 220a 2020 2020 7472  ..    """.    tr
-0001f0a0: 793a 0a20 2020 2020 2020 2069 6d70 6f72  y:.        impor
-0001f0b0: 7420 7265 6374 7061 636b 0a20 2020 2065  t rectpack.    e
-0001f0c0: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
-0001f0d0: 0a20 2020 2020 2020 2072 6169 7365 2049  .        raise I
-0001f0e0: 6d70 6f72 7445 7272 6f72 280a 2020 2020  mportError(.    
-0001f0f0: 2020 2020 2020 2020 225b 5048 4944 4c5d          "[PHIDL]
-0001f100: 2054 6865 2070 6163 6b65 7228 2920 6675   The packer() fu
-0001f110: 6e63 7469 6f6e 2072 6571 7569 7265 7320  nction requires 
-0001f120: 7468 6520 220a 2020 2020 2020 2020 2020  the ".          
-0001f130: 2020 276d 6f64 756c 6520 2272 6563 7470    'module "rectp
-0001f140: 6163 6b22 2074 6f20 6f70 6572 6174 652e  ack" to operate.
-0001f150: 2020 506c 6561 7365 2072 6574 7279 2027    Please retry '
-0001f160: 0a20 2020 2020 2020 2020 2020 2022 6166  .            "af
-0001f170: 7465 7220 696e 7374 616c 6c69 6e67 2072  ter installing r
-0001f180: 6563 7470 6163 6b3a 5c6e 5c6e 220a 2020  ectpack:\n\n".  
-0001f190: 2020 2020 2020 2020 2020 2224 2070 6970            "$ pip
-0001f1a0: 2069 6e73 7461 6c6c 2072 6563 7470 6163   install rectpac
-0001f1b0: 6b22 0a20 2020 2020 2020 2029 0a0a 2020  k".        )..  
-0001f1c0: 2020 2320 436f 6d70 7574 6520 746f 7461    # Compute tota
-0001f1d0: 6c20 6172 6561 2061 6e64 2075 7365 2069  l area and use i
-0001f1e0: 7420 666f 7220 616e 2069 6e69 7469 616c  t for an initial
-0001f1f0: 2065 7374 696d 6174 6520 6f66 2074 6865   estimate of the
-0001f200: 2062 696e 2073 697a 650a 2020 2020 746f   bin size.    to
-0001f210: 7461 6c5f 6172 6561 203d 2030 0a20 2020  tal_area = 0.   
-0001f220: 2066 6f72 2072 2069 6e20 7265 6374 5f64   for r in rect_d
-0001f230: 6963 742e 7661 6c75 6573 2829 3a0a 2020  ict.values():.  
-0001f240: 2020 2020 2020 746f 7461 6c5f 6172 6561        total_area
-0001f250: 202b 3d20 725b 305d 202a 2072 5b31 5d0a   += r[0] * r[1].
-0001f260: 2020 2020 2320 4e6f 726d 616c 697a 650a      # Normalize.
-0001f270: 2020 2020 6173 7065 6374 5f72 6174 696f      aspect_ratio
-0001f280: 203d 206e 702e 6173 6172 7261 7928 6173   = np.asarray(as
-0001f290: 7065 6374 5f72 6174 696f 2920 2f20 6e70  pect_ratio) / np
-0001f2a0: 2e6c 696e 616c 672e 6e6f 726d 2861 7370  .linalg.norm(asp
-0001f2b0: 6563 745f 7261 7469 6f29 0a0a 2020 2020  ect_ratio)..    
-0001f2c0: 2320 5365 7475 7020 7661 7269 6162 6c65  # Setup variable
-0001f2d0: 730a 2020 2020 626f 785f 7369 7a65 203d  s.    box_size =
-0001f2e0: 206e 702e 6173 6172 7261 7928 6173 7065   np.asarray(aspe
-0001f2f0: 6374 5f72 6174 696f 202a 206e 702e 7371  ct_ratio * np.sq
-0001f300: 7274 2874 6f74 616c 5f61 7265 6129 2c20  rt(total_area), 
-0001f310: 6474 7970 653d 6e70 2e66 6c6f 6174 3634  dtype=np.float64
-0001f320: 290a 2020 2020 626f 785f 7369 7a65 203d  ).    box_size =
-0001f330: 206e 702e 636c 6970 2862 6f78 5f73 697a   np.clip(box_siz
-0001f340: 652c 204e 6f6e 652c 206d 6178 5f73 697a  e, None, max_siz
-0001f350: 6529 0a20 2020 2069 6620 736f 7274 5f62  e).    if sort_b
-0001f360: 795f 6172 6561 3a0a 2020 2020 2020 2020  y_area:.        
-0001f370: 7270 5f73 6f72 7420 3d20 7265 6374 7061  rp_sort = rectpa
-0001f380: 636b 2e53 4f52 545f 4152 4541 0a20 2020  ck.SORT_AREA.   
-0001f390: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
-0001f3a0: 705f 736f 7274 203d 2072 6563 7470 6163  p_sort = rectpac
-0001f3b0: 6b2e 534f 5254 5f4e 4f4e 450a 0a20 2020  k.SORT_NONE..   
-0001f3c0: 2023 2052 6570 6561 7465 646c 7920 7275   # Repeatedly ru
-0001f3d0: 6e20 7468 6520 7265 6374 616e 676c 652d  n the rectangle-
-0001f3e0: 7061 636b 696e 6720 616c 676f 7269 7468  packing algorith
-0001f3f0: 6d20 7769 7468 2069 6e63 7265 6173 696e  m with increasin
-0001f400: 676c 7920 6c61 7267 6572 0a20 2020 2023  gly larger.    #
-0001f410: 2061 7265 6173 2075 6e74 696c 2065 7665   areas until eve
-0001f420: 7279 7468 696e 6720 6669 7473 206f 7220  rything fits or 
-0001f430: 7765 2776 6520 7265 6163 6865 6420 7468  we've reached th
-0001f440: 6520 6d61 7869 6d75 6d20 7369 7a65 0a20  e maximum size. 
-0001f450: 2020 2077 6869 6c65 2054 7275 653a 0a20     while True:. 
-0001f460: 2020 2020 2020 2023 2043 7265 6174 6520         # Create 
-0001f470: 7468 6520 7061 636b 6572 206f 626a 6563  the packer objec
-0001f480: 740a 2020 2020 2020 2020 7265 6374 5f70  t.        rect_p
-0001f490: 6163 6b65 7220 3d20 7265 6374 7061 636b  acker = rectpack
-0001f4a0: 2e6e 6577 5061 636b 6572 280a 2020 2020  .newPacker(.    
-0001f4b0: 2020 2020 2020 2020 6d6f 6465 3d72 6563          mode=rec
-0001f4c0: 7470 6163 6b2e 5061 636b 696e 674d 6f64  tpack.PackingMod
-0001f4d0: 652e 4f66 666c 696e 652c 0a20 2020 2020  e.Offline,.     
-0001f4e0: 2020 2020 2020 2070 6163 6b5f 616c 676f         pack_algo
-0001f4f0: 3d72 6563 7470 6163 6b2e 4d61 7852 6563  =rectpack.MaxRec
-0001f500: 7473 426c 7366 2c0a 2020 2020 2020 2020  tsBlsf,.        
-0001f510: 2020 2020 736f 7274 5f61 6c67 6f3d 7270      sort_algo=rp
-0001f520: 5f73 6f72 742c 0a20 2020 2020 2020 2020  _sort,.         
-0001f530: 2020 2062 696e 5f61 6c67 6f3d 7265 6374     bin_algo=rect
-0001f540: 7061 636b 2e50 6163 6b69 6e67 4269 6e2e  pack.PackingBin.
-0001f550: 4242 462c 0a20 2020 2020 2020 2020 2020  BBF,.           
-0001f560: 2072 6f74 6174 696f 6e3d 4661 6c73 652c   rotation=False,
-0001f570: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0001f580: 2020 2020 2320 4164 6420 6561 6368 2072      # Add each r
-0001f590: 6563 7461 6e67 6c65 2074 6f20 7468 6520  ectangle to the 
-0001f5a0: 7061 636b 6572 2c20 6372 6561 7465 2061  packer, create a
-0001f5b0: 2073 696e 676c 6520 6269 6e2c 2061 6e64   single bin, and
-0001f5c0: 2070 6163 6b0a 2020 2020 2020 2020 666f   pack.        fo
-0001f5d0: 7220 7269 642c 2072 2069 6e20 7265 6374  r rid, r in rect
-0001f5e0: 5f64 6963 742e 6974 656d 7328 293a 0a20  _dict.items():. 
-0001f5f0: 2020 2020 2020 2020 2020 2072 6563 745f             rect_
-0001f600: 7061 636b 6572 2e61 6464 5f72 6563 7428  packer.add_rect(
-0001f610: 7769 6474 683d 725b 305d 2c20 6865 6967  width=r[0], heig
-0001f620: 6874 3d72 5b31 5d2c 2072 6964 3d72 6964  ht=r[1], rid=rid
-0001f630: 290a 2020 2020 2020 2020 7265 6374 5f70  ).        rect_p
-0001f640: 6163 6b65 722e 6164 645f 6269 6e28 7769  acker.add_bin(wi
-0001f650: 6474 683d 626f 785f 7369 7a65 5b30 5d2c  dth=box_size[0],
-0001f660: 2068 6569 6768 743d 626f 785f 7369 7a65   height=box_size
-0001f670: 5b31 5d29 0a20 2020 2020 2020 2072 6563  [1]).        rec
-0001f680: 745f 7061 636b 6572 2e70 6163 6b28 290a  t_packer.pack().
-0001f690: 0a20 2020 2020 2020 2023 2041 646a 7573  .        # Adjus
-0001f6a0: 7420 7468 6520 626f 7820 7369 7a65 2066  t the box size f
-0001f6b0: 6f72 206e 6578 7420 7469 6d65 0a20 2020  or next time.   
-0001f6c0: 2020 2020 2062 6f78 5f73 697a 6520 2a3d       box_size *=
-0001f6d0: 2064 656e 7369 7479 2020 2320 496e 6372   density  # Incr
-0001f6e0: 6561 7365 2061 7265 6120 746f 2074 7279  ease area to try
-0001f6f0: 2074 6f20 6669 740a 2020 2020 2020 2020   to fit.        
-0001f700: 626f 785f 7369 7a65 203d 206e 702e 636c  box_size = np.cl
-0001f710: 6970 2862 6f78 5f73 697a 652c 204e 6f6e  ip(box_size, Non
-0001f720: 652c 206d 6178 5f73 697a 6529 0a20 2020  e, max_size).   
-0001f730: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-0001f740: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-0001f750: 6e74 280a 2020 2020 2020 2020 2020 2020  nt(.            
-0001f760: 2020 2020 2254 7279 696e 6720 746f 2070      "Trying to p
-0001f770: 6163 6b20 696e 2062 696e 2073 697a 6520  ack in bin size 
-0001f780: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0001f790: 2020 2228 2530 2e32 662c 2025 302e 3266    "(%0.2f, %0.2f
-0001f7a0: 2922 2025 2074 7570 6c65 2862 6f78 5f73  )" % tuple(box_s
-0001f7b0: 697a 6520 2a20 7072 6563 6973 696f 6e29  ize * precision)
-0001f7c0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-0001f7d0: 2020 2020 2020 2020 2320 5175 6974 2074          # Quit t
-0001f7e0: 6865 206c 6f6f 7020 6966 2077 6527 7665  he loop if we've
-0001f7f0: 2070 6163 6b65 6420 616c 6c20 7468 6520   packed all the 
-0001f800: 7265 6374 616e 676c 6573 0a20 2020 2020  rectangles.     
-0001f810: 2020 2023 206f 7220 7265 6163 6865 6420     # or reached 
-0001f820: 7468 6520 6d61 7820 7369 7a65 0a20 2020  the max size.   
-0001f830: 2020 2020 2069 6620 6c65 6e28 7265 6374       if len(rect
-0001f840: 5f70 6163 6b65 722e 7265 6374 5f6c 6973  _packer.rect_lis
-0001f850: 7428 2929 203d 3d20 6c65 6e28 7265 6374  t()) == len(rect
-0001f860: 5f64 6963 7429 3a0a 2020 2020 2020 2020  _dict):.        
-0001f870: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
-0001f880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f890: 7072 696e 7428 2253 7563 6365 7373 2122  print("Success!"
-0001f8a0: 290a 2020 2020 2020 2020 2020 2020 6272  ).            br
-0001f8b0: 6561 6b0a 2020 2020 2020 2020 656c 6966  eak.        elif
-0001f8c0: 2061 6c6c 2862 6f78 5f73 697a 6520 3e3d   all(box_size >=
-0001f8d0: 206d 6178 5f73 697a 6529 3a0a 2020 2020   max_size):.    
-0001f8e0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-0001f8f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001f900: 2020 2020 7072 696e 7428 2252 6561 6368      print("Reach
-0001f910: 6564 206d 6178 5f73 697a 652c 2063 7265  ed max_size, cre
-0001f920: 6174 696e 6720 2220 2261 6e20 6164 6469  ating " "an addi
-0001f930: 7469 6f6e 616c 2062 696e 2229 0a20 2020  tional bin").   
-0001f940: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
-0001f950: 2020 2020 2320 5365 7061 7261 7465 2070      # Separate p
-0001f960: 6163 6b65 6420 6672 6f6d 2075 6e70 6163  acked from unpac
-0001f970: 6b65 6420 7265 6374 616e 676c 6573 2c20  ked rectangles, 
-0001f980: 6d61 6b65 2064 6963 7473 206f 6620 666f  make dicts of fo
-0001f990: 726d 0a20 2020 2023 207b 6964 3a28 782c  rm.    # {id:(x,
-0001f9a0: 792c 772c 6829 7d0a 2020 2020 7061 636b  y,w,h)}.    pack
-0001f9b0: 6564 5f72 6563 745f 6469 6374 203d 207b  ed_rect_dict = {
-0001f9c0: 725b 2d31 5d3a 2072 5b3a 2d31 5d20 666f  r[-1]: r[:-1] fo
-0001f9d0: 7220 7220 696e 2072 6563 745f 7061 636b  r r in rect_pack
-0001f9e0: 6572 5b30 5d2e 7265 6374 5f6c 6973 7428  er[0].rect_list(
-0001f9f0: 297d 0a20 2020 2075 6e70 6163 6b65 645f  )}.    unpacked_
-0001fa00: 7265 6374 5f64 6963 7420 3d20 7b7d 0a20  rect_dict = {}. 
-0001fa10: 2020 2066 6f72 206b 2c20 7620 696e 2072     for k, v in r
-0001fa20: 6563 745f 6469 6374 2e69 7465 6d73 2829  ect_dict.items()
-0001fa30: 3a0a 2020 2020 2020 2020 6966 206b 206e  :.        if k n
-0001fa40: 6f74 2069 6e20 7061 636b 6564 5f72 6563  ot in packed_rec
-0001fa50: 745f 6469 6374 3a0a 2020 2020 2020 2020  t_dict:.        
-0001fa60: 2020 2020 756e 7061 636b 6564 5f72 6563      unpacked_rec
-0001fa70: 745f 6469 6374 5b6b 5d20 3d20 760a 0a20  t_dict[k] = v.. 
-0001fa80: 2020 2072 6574 7572 6e20 2870 6163 6b65     return (packe
-0001fa90: 645f 7265 6374 5f64 6963 742c 2075 6e70  d_rect_dict, unp
-0001faa0: 6163 6b65 645f 7265 6374 5f64 6963 7429  acked_rect_dict)
-0001fab0: 0a0a 0a64 6566 2070 6163 6b65 7228 0a20  ...def packer(. 
-0001fac0: 2020 2044 5f6c 6973 742c 0a20 2020 2073     D_list,.    s
-0001fad0: 7061 6369 6e67 3d31 302c 0a20 2020 2061  pacing=10,.    a
-0001fae0: 7370 6563 745f 7261 7469 6f3d 2831 2c20  spect_ratio=(1, 
-0001faf0: 3129 2c0a 2020 2020 6d61 785f 7369 7a65  1),.    max_size
-0001fb00: 3d28 4e6f 6e65 2c20 4e6f 6e65 292c 0a20  =(None, None),. 
-0001fb10: 2020 2073 6f72 745f 6279 5f61 7265 613d     sort_by_area=
-0001fb20: 5472 7565 2c0a 2020 2020 6465 6e73 6974  True,.    densit
-0001fb30: 793d 312e 312c 0a20 2020 2070 7265 6369  y=1.1,.    preci
-0001fb40: 7369 6f6e 3d31 652d 322c 0a20 2020 2076  sion=1e-2,.    v
-0001fb50: 6572 626f 7365 3d46 616c 7365 2c0a 293a  erbose=False,.):
-0001fb60: 0a20 2020 2022 2222 5061 636b 7320 6765  .    """Packs ge
-0001fb70: 6f6d 6574 7269 6573 2074 6f67 6574 6865  ometries togethe
-0001fb80: 7220 696e 746f 2072 6563 7461 6e67 756c  r into rectangul
-0001fb90: 6172 2062 696e 732e 0a0a 2020 2020 5061  ar bins...    Pa
-0001fba0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-0001fbb0: 2d2d 2d2d 2d2d 2d0a 2020 2020 445f 6c69  -------.    D_li
-0001fbc0: 7374 203a 2061 7272 6179 2d6c 696b 6520  st : array-like 
-0001fbd0: 6f66 2044 6576 6963 6573 0a20 2020 2020  of Devices.     
-0001fbe0: 2020 2049 6e70 7574 2044 6576 6963 6573     Input Devices
-0001fbf0: 2074 6f20 6265 2070 6163 6b65 642e 0a20   to be packed.. 
-0001fc00: 2020 2073 7061 6369 6e67 203a 2069 6e74     spacing : int
-0001fc10: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
-0001fc20: 2020 5468 6520 6d69 6e69 6d75 6d20 6469    The minimum di
-0001fc30: 7374 616e 6365 2062 6574 7765 656e 2061  stance between a
-0001fc40: 646a 6163 656e 7420 7368 6170 6573 2e0a  djacent shapes..
-0001fc50: 2020 2020 6173 7065 6374 5f72 6174 696f      aspect_ratio
-0001fc60: 203a 2061 7272 6179 2d6c 696b 650a 2020   : array-like.  
-0001fc70: 2020 2020 2020 5468 6520 2877 6964 7468        The (width
-0001fc80: 2c20 6865 6967 6874 2920 7261 7469 6f20  , height) ratio 
-0001fc90: 6f66 2074 6865 2072 6563 7461 6e67 756c  of the rectangul
-0001fca0: 6172 2062 696e 2e0a 2020 2020 6d61 785f  ar bin..    max_
-0001fcb0: 7369 7a65 203a 2061 7272 6179 2d6c 696b  size : array-lik
-0001fcc0: 650a 2020 2020 2020 2020 4c69 6d69 7473  e.        Limits
-0001fcd0: 2074 6865 2073 697a 6520 696e 746f 2077   the size into w
-0001fce0: 6869 6368 2074 6865 2073 6861 7065 7320  hich the shapes 
-0001fcf0: 7769 6c6c 2062 6520 7061 636b 6564 2e0a  will be packed..
-0001fd00: 2020 2020 736f 7274 5f62 795f 6172 6561      sort_by_area
-0001fd10: 203a 2062 6f6f 6c0a 2020 2020 2020 2020   : bool.        
-0001fd20: 4966 2074 7275 652c 2070 7265 2d73 6f72  If true, pre-sor
-0001fd30: 7473 2074 6865 2073 6861 7065 7320 6279  ts the shapes by
-0001fd40: 2061 7265 612e 0a20 2020 2064 656e 7369   area..    densi
-0001fd50: 7479 203a 2069 6e74 206f 7220 666c 6f61  ty : int or floa
-0001fd60: 740a 2020 2020 2020 2020 4465 6e73 6974  t.        Densit
-0001fd70: 7920 6f66 2070 6163 6b69 6e67 2e20 5661  y of packing. Va
-0001fd80: 6c75 6573 2063 6c6f 7365 7220 746f 2031  lues closer to 1
-0001fd90: 2070 6163 6b20 7469 6768 7465 7220 6275   pack tighter bu
-0001fda0: 7420 7265 7175 6972 6520 6d6f 7265 0a20  t require more. 
-0001fdb0: 2020 2020 2020 2063 6f6d 7075 7461 7469         computati
-0001fdc0: 6f6e 2e0a 2020 2020 7072 6563 6973 696f  on..    precisio
-0001fdd0: 6e20 3a20 666c 6f61 740a 2020 2020 2020  n : float.      
-0001fde0: 2020 4465 7369 7265 6420 7072 6563 6973    Desired precis
-0001fdf0: 696f 6e20 666f 7220 726f 756e 6469 6e67  ion for rounding
-0001fe00: 2076 6572 7465 7820 636f 6f72 6469 6e61   vertex coordina
-0001fe10: 7465 732e 0a20 2020 2076 6572 626f 7365  tes..    verbose
-0001fe20: 203a 2062 6f6f 6c0a 2020 2020 2020 2020   : bool.        
-0001fe30: 5768 6574 6865 7220 746f 2064 6973 706c  Whether to displ
-0001fe40: 6179 2072 6573 756c 7473 206f 6620 7061  ay results of pa
-0001fe50: 636b 696e 6720 6174 7465 6d70 7473 0a0a  cking attempts..
-0001fe60: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
-0001fe70: 202d 2d2d 2d2d 2d2d 0a20 2020 2044 5f70   -------.    D_p
-0001fe80: 6163 6b65 645f 6c69 7374 203a 2044 6576  acked_list : Dev
-0001fe90: 6963 6520 6f72 206c 6973 7420 6f66 2044  ice or list of D
-0001fea0: 6576 6963 6573 0a20 2020 2020 2020 2041  evices.        A
-0001feb0: 2044 6576 6963 6520 6f72 206c 6973 7420   Device or list 
-0001fec0: 6f66 2044 6576 6963 6573 2063 6f6e 7461  of Devices conta
-0001fed0: 696e 696e 6720 616c 6c20 7468 6520 7061  ining all the pa
-0001fee0: 636b 6564 2072 6563 7461 6e67 756c 6172  cked rectangular
-0001fef0: 0a20 2020 2020 2020 2062 696e 7320 6765  .        bins ge
-0001ff00: 6e65 7261 7465 642e 0a0a 2020 2020 4e6f  nerated...    No
-0001ff10: 7465 730a 2020 2020 2d2d 2d2d 2d0a 2020  tes.    -----.  
-0001ff20: 2020 4966 2061 206d 6178 2d73 697a 6520    If a max-size 
-0001ff30: 6973 2073 7065 6369 6669 6564 2c20 7468  is specified, th
-0001ff40: 6520 6675 6e63 7469 6f6e 2077 696c 6c20  e function will 
-0001ff50: 6372 6561 7465 2061 7320 6d61 6e79 2062  create as many b
-0001ff60: 696e 7320 6173 0a20 2020 206e 6563 6573  ins as.    neces
-0001ff70: 7361 7279 2074 6f20 7061 636b 2061 6c6c  sary to pack all
-0001ff80: 2074 6865 2067 656f 6d65 7472 6965 7320   the geometries 
-0001ff90: 616e 6420 7468 656e 2072 6574 7572 6e20  and then return 
-0001ffa0: 6120 6c69 7374 206f 6620 7468 650a 2020  a list of the.  
-0001ffb0: 2020 6669 6c6c 6564 2d62 696e 2044 6576    filled-bin Dev
-0001ffc0: 6963 6573 2e0a 2020 2020 2222 220a 2020  ices..    """.  
-0001ffd0: 2020 6966 2064 656e 7369 7479 203c 2031    if density < 1
-0001ffe0: 2e30 313a 0a20 2020 2020 2020 2072 6169  .01:.        rai
-0001fff0: 7365 2056 616c 7565 4572 726f 7228 0a20  se ValueError(. 
-00020000: 2020 2020 2020 2020 2020 2022 5b50 4849             "[PHI
-00020010: 444c 5d20 7061 636b 6572 2829 2077 6173  DL] packer() was
-00020020: 2067 6976 656e 2061 2060 6465 6e73 6974   given a `densit
-00020030: 7960 2061 7267 756d 656e 7420 220a 2020  y` argument ".  
-00020040: 2020 2020 2020 2020 2020 2274 6861 7420            "that 
-00020050: 6973 2074 6f6f 2073 6d61 6c6c 2e20 2054  is too small.  T
-00020060: 6865 2064 656e 7369 7479 2061 7267 756d  he density argum
-00020070: 656e 7420 6d75 7374 2062 6520 220a 2020  ent must be ".  
-00020080: 2020 2020 2020 2020 2020 223e 3d20 312e            ">= 1.
-00020090: 3031 220a 2020 2020 2020 2020 290a 0a20  01".        ).. 
-000200a0: 2020 2023 2053 616e 7469 7a65 206d 6178     # Santize max
-000200b0: 5f73 697a 6520 7661 7269 6162 6c65 0a20  _size variable. 
-000200c0: 2020 206d 6178 5f73 697a 6520 3d20 5b6e     max_size = [n
-000200d0: 702e 696e 6620 6966 2076 2069 7320 4e6f  p.inf if v is No
-000200e0: 6e65 2065 6c73 6520 7620 666f 7220 7620  ne else v for v 
-000200f0: 696e 206d 6178 5f73 697a 655d 0a20 2020  in max_size].   
-00020100: 206d 6178 5f73 697a 6520 3d20 6e70 2e61   max_size = np.a
-00020110: 7361 7272 6179 286d 6178 5f73 697a 652c  sarray(max_size,
-00020120: 2064 7479 7065 3d6e 702e 666c 6f61 7436   dtype=np.float6
-00020130: 3429 2020 2320 496e 2063 6173 6520 6974  4)  # In case it
-00020140: 2773 2069 6e74 6567 6572 730a 2020 2020  's integers.    
-00020150: 6d61 785f 7369 7a65 203d 206d 6178 5f73  max_size = max_s
-00020160: 697a 6520 2f20 7072 6563 6973 696f 6e0a  ize / precision.
-00020170: 0a20 2020 2023 2043 6f6e 7665 7274 2044  .    # Convert D
-00020180: 6576 6963 6573 2074 6f20 7265 6374 616e  evices to rectan
-00020190: 676c 6573 0a20 2020 2072 6563 745f 6469  gles.    rect_di
-000201a0: 6374 203d 207b 7d0a 2020 2020 666f 7220  ct = {}.    for 
-000201b0: 6e2c 2044 2069 6e20 656e 756d 6572 6174  n, D in enumerat
-000201c0: 6528 445f 6c69 7374 293a 0a20 2020 2020  e(D_list):.     
-000201d0: 2020 2077 2c20 6820 3d20 2844 2e73 697a     w, h = (D.siz
-000201e0: 6520 2b20 7370 6163 696e 6729 202f 2070  e + spacing) / p
-000201f0: 7265 6369 7369 6f6e 0a20 2020 2020 2020  recision.       
-00020200: 2077 2c20 6820 3d20 696e 7428 7729 2c20   w, h = int(w), 
-00020210: 696e 7428 6829 0a20 2020 2020 2020 2069  int(h).        i
-00020220: 6620 2877 203e 206d 6178 5f73 697a 655b  f (w > max_size[
-00020230: 305d 2920 6f72 2028 6820 3e20 6d61 785f  0]) or (h > max_
-00020240: 7369 7a65 5b31 5d29 3a0a 2020 2020 2020  size[1]):.      
-00020250: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00020260: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
-00020270: 2020 2020 2020 2020 225b 5048 4944 4c5d          "[PHIDL]
-00020280: 2070 6163 6b65 7228 2920 6661 696c 6564   packer() failed
-00020290: 2062 6563 6175 7365 206f 6e65 206f 6620   because one of 
-000202a0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000202b0: 2020 2274 6865 206f 626a 6563 7473 2069    "the objects i
-000202c0: 6e20 6044 5f6c 6973 7460 2069 7320 6861  n `D_list` is ha
-000202d0: 7320 616e 2078 206f 7220 220a 2020 2020  s an x or ".    
-000202e0: 2020 2020 2020 2020 2020 2020 2279 2064              "y d
-000202f0: 696d 656e 7369 6f6e 206c 6172 6765 7220  imension larger 
-00020300: 7468 616e 2060 6d61 785f 7369 7a65 6020  than `max_size` 
-00020310: 616e 6420 220a 2020 2020 2020 2020 2020  and ".          
-00020320: 2020 2020 2020 2273 6f20 6361 6e6e 6f74        "so cannot
-00020330: 2062 6520 7061 636b 6564 220a 2020 2020   be packed".    
-00020340: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00020350: 2020 7265 6374 5f64 6963 745b 6e5d 203d    rect_dict[n] =
-00020360: 2028 772c 2068 290a 0a20 2020 2070 6163   (w, h)..    pac
-00020370: 6b65 645f 6c69 7374 203d 205b 5d0a 2020  ked_list = [].  
-00020380: 2020 7768 696c 6520 6c65 6e28 7265 6374    while len(rect
-00020390: 5f64 6963 7429 203e 2030 3a0a 2020 2020  _dict) > 0:.    
-000203a0: 2020 2020 2870 6163 6b65 645f 7265 6374      (packed_rect
-000203b0: 5f64 6963 742c 2072 6563 745f 6469 6374  _dict, rect_dict
-000203c0: 2920 3d20 5f70 6163 6b5f 7369 6e67 6c65  ) = _pack_single
-000203d0: 5f62 696e 280a 2020 2020 2020 2020 2020  _bin(.          
-000203e0: 2020 7265 6374 5f64 6963 742c 0a20 2020    rect_dict,.   
-000203f0: 2020 2020 2020 2020 2061 7370 6563 745f           aspect_
-00020400: 7261 7469 6f3d 6173 7065 6374 5f72 6174  ratio=aspect_rat
-00020410: 696f 2c0a 2020 2020 2020 2020 2020 2020  io,.            
-00020420: 6d61 785f 7369 7a65 3d6d 6178 5f73 697a  max_size=max_siz
-00020430: 652c 0a20 2020 2020 2020 2020 2020 2073  e,.            s
-00020440: 6f72 745f 6279 5f61 7265 613d 736f 7274  ort_by_area=sort
-00020450: 5f62 795f 6172 6561 2c0a 2020 2020 2020  _by_area,.      
-00020460: 2020 2020 2020 6465 6e73 6974 793d 6465        density=de
-00020470: 6e73 6974 792c 0a20 2020 2020 2020 2020  nsity,.         
-00020480: 2020 2070 7265 6369 7369 6f6e 3d70 7265     precision=pre
-00020490: 6369 7369 6f6e 2c0a 2020 2020 2020 2020  cision,.        
-000204a0: 2020 2020 7665 7262 6f73 653d 7665 7262      verbose=verb
-000204b0: 6f73 652c 0a20 2020 2020 2020 2029 0a20  ose,.        ). 
-000204c0: 2020 2020 2020 2070 6163 6b65 645f 6c69         packed_li
-000204d0: 7374 2e61 7070 656e 6428 7061 636b 6564  st.append(packed
-000204e0: 5f72 6563 745f 6469 6374 290a 0a20 2020  _rect_dict)..   
-000204f0: 2044 5f70 6163 6b65 645f 6c69 7374 203d   D_packed_list =
-00020500: 205b 5d0a 2020 2020 666f 7220 7265 6374   [].    for rect
-00020510: 5f64 6963 7420 696e 2070 6163 6b65 645f  _dict in packed_
-00020520: 6c69 7374 3a0a 2020 2020 2020 2020 445f  list:.        D_
-00020530: 7061 636b 6564 203d 2044 6576 6963 6528  packed = Device(
-00020540: 290a 2020 2020 2020 2020 666f 7220 6e2c  ).        for n,
-00020550: 2072 6563 7420 696e 2072 6563 745f 6469   rect in rect_di
-00020560: 6374 2e69 7465 6d73 2829 3a0a 2020 2020  ct.items():.    
-00020570: 2020 2020 2020 2020 782c 2079 2c20 772c          x, y, w,
-00020580: 2068 203d 2072 6563 740a 2020 2020 2020   h = rect.      
-00020590: 2020 2020 2020 7863 656e 7465 7220 3d20        xcenter = 
-000205a0: 7820 2b20 7720 2f20 3220 2b20 7370 6163  x + w / 2 + spac
-000205b0: 696e 6720 2f20 320a 2020 2020 2020 2020  ing / 2.        
-000205c0: 2020 2020 7963 656e 7465 7220 3d20 7920      ycenter = y 
-000205d0: 2b20 6820 2f20 3220 2b20 7370 6163 696e  + h / 2 + spacin
-000205e0: 6720 2f20 320a 2020 2020 2020 2020 2020  g / 2.          
-000205f0: 2020 6420 3d20 445f 7061 636b 6564 2e61    d = D_packed.a
-00020600: 6464 5f72 6566 2844 5f6c 6973 745b 6e5d  dd_ref(D_list[n]
-00020610: 290a 2020 2020 2020 2020 2020 2020 642e  ).            d.
-00020620: 6365 6e74 6572 203d 2028 7863 656e 7465  center = (xcente
-00020630: 7220 2a20 7072 6563 6973 696f 6e2c 2079  r * precision, y
-00020640: 6365 6e74 6572 202a 2070 7265 6369 7369  center * precisi
-00020650: 6f6e 290a 2020 2020 2020 2020 445f 7061  on).        D_pa
-00020660: 636b 6564 5f6c 6973 742e 6170 7065 6e64  cked_list.append
-00020670: 2844 5f70 6163 6b65 6429 0a0a 2020 2020  (D_packed)..    
-00020680: 7265 7475 726e 2044 5f70 6163 6b65 645f  return D_packed_
-00020690: 6c69 7374 0a0a 0a64 6566 205f 7261 7374  list...def _rast
-000206a0: 6572 697a 655f 706f 6c79 676f 6e73 2870  erize_polygons(p
-000206b0: 6f6c 7967 6f6e 732c 2062 6f75 6e64 733d  olygons, bounds=
-000206c0: 5b5b 2d31 3030 2c20 2d31 3030 5d2c 205b  [[-100, -100], [
-000206d0: 3130 302c 2031 3030 5d5d 2c20 6478 3d31  100, 100]], dx=1
-000206e0: 2c20 6479 3d31 293a 0a20 2020 2022 2222  , dy=1):.    """
-000206f0: 436f 6e76 6572 7473 2070 6f6c 7967 6f6e  Converts polygon
-00020700: 7320 746f 2061 2062 6c61 636b 2f77 6869  s to a black/whi
-00020710: 7465 2028 312f 3029 206d 6174 7269 7822  te (1/0) matrix"
-00020720: 2222 0a20 2020 2074 7279 3a0a 2020 2020  "".    try:.    
-00020730: 2020 2020 6672 6f6d 2073 6b69 6d61 6765      from skimage
-00020740: 2069 6d70 6f72 7420 6472 6177 0a20 2020   import draw.   
-00020750: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00020760: 6e3a 0a20 2020 2020 2020 2072 6169 7365  n:.        raise
-00020770: 2049 6d70 6f72 7445 7272 6f72 280a 2020   ImportError(.  
-00020780: 2020 2020 2020 2020 2020 2254 6865 2066            "The f
-00020790: 696c 6c20 6675 6e63 7469 6f6e 2072 6571  ill function req
-000207a0: 7569 7265 7320 7468 6520 6d6f 6475 6c65  uires the module
-000207b0: 2022 0a20 2020 2020 2020 2020 2020 2027   ".            '
-000207c0: 2273 6369 6b69 742d 696d 6167 6522 2074  "scikit-image" t
-000207d0: 6f20 6f70 6572 6174 652e 2020 506c 6561  o operate.  Plea
-000207e0: 7365 2072 6574 7279 2027 0a20 2020 2020  se retry '.     
-000207f0: 2020 2020 2020 2022 6166 7465 7220 696e         "after in
-00020800: 7374 616c 6c69 6e67 2073 6369 6b69 742d  stalling scikit-
-00020810: 696d 6167 653a 5c6e 5c6e 220a 2020 2020  image:\n\n".    
-00020820: 2020 2020 2020 2020 2224 2070 6970 2069          "$ pip i
-00020830: 6e73 7461 6c6c 202d 2d75 7067 7261 6465  nstall --upgrade
-00020840: 2073 6369 6b69 742d 696d 6167 6522 0a20   scikit-image". 
-00020850: 2020 2020 2020 2029 0a0a 2020 2020 2320         )..    # 
-00020860: 5072 6570 6172 6520 706f 6c79 676f 6e20  Prepare polygon 
-00020870: 6172 7261 7920 6279 2073 6869 6674 696e  array by shiftin
-00020880: 6720 616c 6c20 706f 696e 7473 2069 6e74  g all points int
-00020890: 6f20 7468 6520 6669 7273 7420 7175 6164  o the first quad
-000208a0: 7261 6e74 2061 6e64 0a20 2020 2023 2073  rant and.    # s
-000208b0: 6570 6172 6174 696e 6720 706f 696e 7473  eparating points
-000208c0: 2069 6e74 6f20 7820 616e 6420 7920 6c69   into x and y li
-000208d0: 7374 730a 2020 2020 7870 7473 203d 205b  sts.    xpts = [
-000208e0: 5d0a 2020 2020 7970 7473 203d 205b 5d0a  ].    ypts = [].
-000208f0: 2020 2020 666f 7220 7020 696e 2070 6f6c      for p in pol
-00020900: 7967 6f6e 733a 0a20 2020 2020 2020 2070  ygons:.        p
-00020910: 5f61 7272 6179 203d 206e 702e 6173 6172  _array = np.asar
-00020920: 7261 7928 7029 0a20 2020 2020 2020 2078  ray(p).        x
-00020930: 203d 2070 5f61 7272 6179 5b3a 2c20 305d   = p_array[:, 0]
-00020940: 0a20 2020 2020 2020 2079 203d 2070 5f61  .        y = p_a
-00020950: 7272 6179 5b3a 2c20 315d 0a20 2020 2020  rray[:, 1].     
-00020960: 2020 2078 7074 732e 6170 7065 6e64 2828     xpts.append((
-00020970: 7820 2d20 626f 756e 6473 5b30 5d5b 305d  x - bounds[0][0]
-00020980: 2920 2f20 6478 202d 2030 2e35 290a 2020  ) / dx - 0.5).  
-00020990: 2020 2020 2020 7970 7473 2e61 7070 656e        ypts.appen
-000209a0: 6428 2879 202d 2062 6f75 6e64 735b 305d  d((y - bounds[0]
-000209b0: 5b31 5d29 202f 2064 7920 2d20 302e 3529  [1]) / dy - 0.5)
-000209c0: 0a0a 2020 2020 2320 496e 6974 6961 6c69  ..    # Initiali
-000209d0: 7a65 2074 6865 2072 6173 7465 7220 6d61  ze the raster ma
-000209e0: 7472 6978 2077 6527 6c6c 2062 6520 7772  trix we'll be wr
-000209f0: 6974 696e 6720 746f 0a20 2020 2078 7369  iting to.    xsi
-00020a00: 7a65 203d 2069 6e74 286e 702e 6365 696c  ze = int(np.ceil
-00020a10: 2862 6f75 6e64 735b 315d 5b30 5d20 2d20  (bounds[1][0] - 
-00020a20: 626f 756e 6473 5b30 5d5b 305d 2920 2f20  bounds[0][0]) / 
-00020a30: 6478 290a 2020 2020 7973 697a 6520 3d20  dx).    ysize = 
-00020a40: 696e 7428 6e70 2e63 6569 6c28 626f 756e  int(np.ceil(boun
-00020a50: 6473 5b31 5d5b 315d 202d 2062 6f75 6e64  ds[1][1] - bound
-00020a60: 735b 305d 5b31 5d29 202f 2064 7929 0a20  s[0][1]) / dy). 
-00020a70: 2020 2072 6173 7465 7220 3d20 6e70 2e7a     raster = np.z
-00020a80: 6572 6f73 2828 7973 697a 652c 2078 7369  eros((ysize, xsi
-00020a90: 7a65 292c 2064 7479 7065 3d62 6f6f 6c29  ze), dtype=bool)
-00020aa0: 0a0a 2020 2020 2320 544f 444f 3a20 5265  ..    # TODO: Re
-00020ab0: 706c 6163 6520 706f 6c79 676f 6e5f 7065  place polygon_pe
-00020ac0: 7269 6d65 7465 7220 7769 7468 2074 6865  rimeter with the
-00020ad0: 2073 7570 6572 636f 7665 7220 7665 7273   supercover vers
-00020ae0: 696f 6e0a 2020 2020 666f 7220 6e20 696e  ion.    for n in
-00020af0: 2072 616e 6765 286c 656e 2878 7074 7329   range(len(xpts)
-00020b00: 293a 0a20 2020 2020 2020 2072 722c 2063  ):.        rr, c
-00020b10: 6320 3d20 6472 6177 2e70 6f6c 7967 6f6e  c = draw.polygon
-00020b20: 2879 7074 735b 6e5d 2c20 7870 7473 5b6e  (ypts[n], xpts[n
-00020b30: 5d2c 2073 6861 7065 3d72 6173 7465 722e  ], shape=raster.
-00020b40: 7368 6170 6529 0a20 2020 2020 2020 2072  shape).        r
-00020b50: 7270 2c20 6363 7020 3d20 6472 6177 2e70  rp, ccp = draw.p
-00020b60: 6f6c 7967 6f6e 5f70 6572 696d 6574 6572  olygon_perimeter
-00020b70: 280a 2020 2020 2020 2020 2020 2020 7970  (.            yp
-00020b80: 7473 5b6e 5d2c 2078 7074 735b 6e5d 2c20  ts[n], xpts[n], 
-00020b90: 7368 6170 653d 7261 7374 6572 2e73 6861  shape=raster.sha
-00020ba0: 7065 2c20 636c 6970 3d46 616c 7365 0a20  pe, clip=False. 
-00020bb0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00020bc0: 2072 6173 7465 725b 7272 2c20 6363 5d20   raster[rr, cc] 
-00020bd0: 3d20 310a 2020 2020 2020 2020 7261 7374  = 1.        rast
-00020be0: 6572 5b72 7270 2c20 6363 705d 203d 2031  er[rrp, ccp] = 1
-00020bf0: 0a0a 2020 2020 7265 7475 726e 2072 6173  ..    return ras
-00020c00: 7465 720a 0a0a 6465 6620 5f72 6173 7465  ter...def _raste
-00020c10: 725f 696e 6465 785f 746f 5f63 6f6f 7264  r_index_to_coord
-00020c20: 7328 692c 206a 2c20 626f 756e 6473 3d5b  s(i, j, bounds=[
-00020c30: 5b2d 3130 302c 202d 3130 305d 2c20 5b31  [-100, -100], [1
-00020c40: 3030 2c20 3130 305d 5d2c 2064 783d 312c  00, 100]], dx=1,
-00020c50: 2064 793d 3129 3a0a 2020 2020 2222 2243   dy=1):.    """C
-00020c60: 6f6e 7665 7274 7320 2869 2c6a 2920 696e  onverts (i,j) in
-00020c70: 6465 7820 6f66 2072 6173 7465 7220 6d61  dex of raster ma
-00020c80: 7472 6978 2074 6f20 7265 616c 2063 6f6f  trix to real coo
-00020c90: 7264 696e 6174 6573 2222 220a 2020 2020  rdinates""".    
-00020ca0: 7820 3d20 286a 202b 2030 2e35 2920 2a20  x = (j + 0.5) * 
-00020cb0: 6478 202b 2062 6f75 6e64 735b 305d 5b30  dx + bounds[0][0
-00020cc0: 5d0a 2020 2020 7920 3d20 2869 202b 2030  ].    y = (i + 0
-00020cd0: 2e35 2920 2a20 6479 202b 2062 6f75 6e64  .5) * dy + bound
-00020ce0: 735b 305d 5b31 5d0a 2020 2020 7265 7475  s[0][1].    retu
-00020cf0: 726e 2078 2c20 790a 0a0a 6465 6620 5f65  rn x, y...def _e
-00020d00: 7870 616e 645f 7261 7374 6572 2872 6173  xpand_raster(ras
-00020d10: 7465 722c 2064 6973 7461 6e63 653d 2834  ter, distance=(4
-00020d20: 2c20 3229 293a 0a20 2020 2022 2222 4578  , 2)):.    """Ex
-00020d30: 7061 6e64 7320 616c 6c20 626c 6163 6b20  pands all black 
-00020d40: 2831 2920 7069 7865 6c73 2069 6e20 7468  (1) pixels in th
-00020d50: 6520 7261 7374 6572 2222 220a 2020 2020  e raster""".    
-00020d60: 7472 793a 0a20 2020 2020 2020 2066 726f  try:.        fro
-00020d70: 6d20 736b 696d 6167 6520 696d 706f 7274  m skimage import
-00020d80: 2064 7261 772c 206d 6f72 7068 6f6c 6f67   draw, morpholog
-00020d90: 790a 2020 2020 6578 6365 7074 2045 7863  y.    except Exc
-00020da0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-00020db0: 7261 6973 6520 496d 706f 7274 4572 726f  raise ImportErro
-00020dc0: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
-00020dd0: 5468 6520 6669 6c6c 2066 756e 6374 696f  The fill functio
-00020de0: 6e20 7265 7175 6972 6573 2074 6865 206d  n requires the m
-00020df0: 6f64 756c 6520 220a 2020 2020 2020 2020  odule ".        
-00020e00: 2020 2020 2722 7363 696b 6974 2d69 6d61      '"scikit-ima
-00020e10: 6765 2220 746f 206f 7065 7261 7465 2e20  ge" to operate. 
-00020e20: 2050 6c65 6173 6520 7265 7472 7920 270a   Please retry '.
-00020e30: 2020 2020 2020 2020 2020 2020 2261 6674              "aft
-00020e40: 6572 2069 6e73 7461 6c6c 696e 6720 7363  er installing sc
-00020e50: 696b 6974 2d69 6d61 6765 3a5c 6e5c 6e22  ikit-image:\n\n"
-00020e60: 0a20 2020 2020 2020 2020 2020 2022 2420  .            "$ 
-00020e70: 7069 7020 696e 7374 616c 6c20 2d2d 7570  pip install --up
-00020e80: 6772 6164 6520 7363 696b 6974 2d69 6d61  grade scikit-ima
-00020e90: 6765 220a 2020 2020 2020 2020 290a 2020  ge".        ).  
-00020ea0: 2020 6966 2064 6973 7461 6e63 655b 305d    if distance[0]
-00020eb0: 203c 3d20 302e 3520 616e 6420 6469 7374   <= 0.5 and dist
-00020ec0: 616e 6365 5b31 5d20 3c3d 2030 2e35 3a0a  ance[1] <= 0.5:.
-00020ed0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00020ee0: 6173 7465 720a 0a20 2020 206e 756d 5f70  aster..    num_p
-00020ef0: 6978 656c 7320 3d20 6e70 2e61 7272 6179  ixels = np.array
-00020f00: 286e 702e 6365 696c 2864 6973 7461 6e63  (np.ceil(distanc
-00020f10: 6529 2c20 6474 7970 653d 696e 7429 0a20  e), dtype=int). 
-00020f20: 2020 206e 6569 6768 626f 7268 6f6f 6420     neighborhood 
-00020f30: 3d20 6e70 2e7a 6572 6f73 2828 6e75 6d5f  = np.zeros((num_
-00020f40: 7069 7865 6c73 5b31 5d20 2a20 3220 2b20  pixels[1] * 2 + 
-00020f50: 312c 206e 756d 5f70 6978 656c 735b 305d  1, num_pixels[0]
-00020f60: 202a 2032 202b 2031 292c 2064 7479 7065   * 2 + 1), dtype
-00020f70: 3d62 6f6f 6c29 0a20 2020 2072 722c 2063  =bool).    rr, c
-00020f80: 6320 3d20 6472 6177 2e65 6c6c 6970 7365  c = draw.ellipse
-00020f90: 280a 2020 2020 2020 2020 6e75 6d5f 7069  (.        num_pi
-00020fa0: 7865 6c73 5b31 5d2c 206e 756d 5f70 6978  xels[1], num_pix
-00020fb0: 656c 735b 305d 2c20 6469 7374 616e 6365  els[0], distance
-00020fc0: 5b31 5d20 2b20 302e 352c 2064 6973 7461  [1] + 0.5, dista
-00020fd0: 6e63 655b 305d 202b 2030 2e35 0a20 2020  nce[0] + 0.5.   
-00020fe0: 2029 0a20 2020 206e 6569 6768 626f 7268   ).    neighborh
-00020ff0: 6f6f 645b 7272 2c20 6363 5d20 3d20 310a  ood[rr, cc] = 1.
-00021000: 0a20 2020 2072 6574 7572 6e20 6d6f 7270  .    return morp
-00021010: 686f 6c6f 6779 2e62 696e 6172 795f 6469  hology.binary_di
-00021020: 6c61 7469 6f6e 2869 6d61 6765 3d72 6173  lation(image=ras
-00021030: 7465 722c 2066 6f6f 7470 7269 6e74 3d6e  ter, footprint=n
-00021040: 6569 6768 626f 7268 6f6f 6429 0a0a 0a64  eighborhood)...d
-00021050: 6566 205f 6669 6c6c 5f63 656c 6c5f 7265  ef _fill_cell_re
-00021060: 6374 616e 676c 6528 0a20 2020 2073 697a  ctangle(.    siz
-00021070: 653d 2832 302c 2032 3029 2c0a 2020 2020  e=(20, 20),.    
-00021080: 6c61 7965 7273 3d28 302c 2031 2c20 3329  layers=(0, 1, 3)
-00021090: 2c0a 2020 2020 6465 6e73 6974 6965 733d  ,.    densities=
-000210a0: 2830 2e35 2c20 302e 3235 2c20 302e 3729  (0.5, 0.25, 0.7)
-000210b0: 2c0a 2020 2020 696e 7665 7274 6564 3d28  ,.    inverted=(
-000210c0: 4661 6c73 652c 2046 616c 7365 2c20 4661  False, False, Fa
-000210d0: 6c73 6529 2c0a 293a 0a20 2020 2022 2222  lse),.):.    """
-000210e0: 4372 6561 7465 7320 6120 7369 6e67 6c65  Creates a single
-000210f0: 2044 6576 6963 6520 6f6e 206d 756c 7469   Device on multi
-00021100: 706c 6520 6c61 7965 7273 2074 6f20 6265  ple layers to be
-00021110: 2075 7365 6420 6173 2066 696c 6c0a 0a20   used as fill.. 
-00021120: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-00021130: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-00021140: 2073 697a 6520 3a20 6172 7261 792d 6c69   size : array-li
-00021150: 6b65 206f 6620 696e 7420 6f72 2066 6c6f  ke of int or flo
-00021160: 6174 0a20 2020 2020 2020 2078 2c20 7920  at.        x, y 
-00021170: 6469 6d65 6e73 696f 6e73 206f 6620 7468  dimensions of th
-00021180: 6520 6669 6c6c 2061 7265 6120 666f 7220  e fill area for 
-00021190: 616c 6c20 6c61 7965 7273 2e0a 2020 2020  all layers..    
-000211a0: 6c61 7965 7273 203a 2069 6e74 2c20 6172  layers : int, ar
-000211b0: 7261 792d 6c69 6b65 5b32 5d2c 206f 7220  ray-like[2], or 
-000211c0: 7365 740a 2020 2020 2020 2020 5370 6563  set.        Spec
-000211d0: 6966 6963 206c 6179 6572 2873 2920 746f  ific layer(s) to
-000211e0: 2070 7574 2066 696c 6c20 6365 6c6c 2072   put fill cell r
-000211f0: 6563 7461 6e67 6c65 2067 656f 6d65 7472  ectangle geometr
-00021200: 7920 6f6e 2e0a 2020 2020 6465 6e73 6974  y on..    densit
-00021210: 6965 7320 3a20 6172 7261 792d 6c69 6b65  ies : array-like
-00021220: 206f 6620 696e 7420 6f72 2066 6c6f 6174   of int or float
-00021230: 0a20 2020 2020 2020 2046 696c 6c20 6465  .        Fill de
-00021240: 6e73 6974 6965 7320 666f 7220 6561 6368  nsities for each
-00021250: 206c 6179 6572 2073 7065 6369 6669 6564   layer specified
-00021260: 2069 6e20 6060 6c61 7965 7273 6060 2e20   in ``layers``. 
-00021270: 4d75 7374 2062 6520 7468 6520 7361 6d65  Must be the same
-00021280: 0a20 2020 2020 2020 2073 697a 6520 6173  .        size as
-00021290: 2060 606c 6179 6572 7360 602e 0a20 2020   ``layers``..   
-000212a0: 2069 6e76 6572 7465 6420 3a20 6172 7261   inverted : arra
-000212b0: 792d 6c69 6b65 206f 7220 626f 6f6c 0a20  y-like or bool. 
-000212c0: 2020 2020 2020 2049 6620 7472 7565 2c20         If true, 
-000212d0: 696e 7665 7274 7320 7468 6520 6669 6c6c  inverts the fill
-000212e0: 2061 7265 6120 666f 7220 636f 7272 6573   area for corres
-000212f0: 706f 6e64 696e 6720 6c61 7965 722e 204d  ponding layer. M
-00021300: 7573 7420 6265 2074 6865 0a20 2020 2020  ust be the.     
-00021310: 2020 2073 616d 6520 7369 7a65 2061 7320     same size as 
-00021320: 6060 6c61 7965 7273 6060 2e0a 0a20 2020  ``layers``...   
-00021330: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
-00021340: 2d2d 2d2d 0a20 2020 2044 203a 2044 6576  ----.    D : Dev
-00021350: 6963 650a 2020 2020 2020 2020 4120 4465  ice.        A De
-00021360: 7669 6365 2063 6f6e 7461 696e 696e 6720  vice containing 
-00021370: 6669 6c6c 6564 2063 656c 6c20 7265 6374  filled cell rect
-00021380: 616e 676c 6573 2e0a 2020 2020 2222 220a  angles..    """.
-00021390: 2020 2020 4420 3d20 4465 7669 6365 2822      D = Device("
-000213a0: 6669 6c6c 6365 6c6c 2229 0a20 2020 2066  fillcell").    f
-000213b0: 6f72 206c 6179 6572 2c20 6465 6e73 6974  or layer, densit
-000213c0: 792c 2069 6e76 2069 6e20 7a69 7028 6c61  y, inv in zip(la
-000213d0: 7965 7273 2c20 6465 6e73 6974 6965 732c  yers, densities,
-000213e0: 2069 6e76 6572 7465 6429 3a0a 2020 2020   inverted):.    
-000213f0: 2020 2020 7265 6374 616e 676c 655f 7369      rectangle_si
-00021400: 7a65 203d 206e 702e 6172 7261 7928 7369  ze = np.array(si
-00021410: 7a65 2920 2a20 7371 7274 2864 656e 7369  ze) * sqrt(densi
-00021420: 7479 290a 2020 2020 2020 2020 2320 7220  ty).        # r 
-00021430: 3d20 442e 6164 645f 7265 6628 7265 6374  = D.add_ref(rect
-00021440: 616e 676c 6528 7369 7a65 203d 2072 6563  angle(size = rec
-00021450: 7461 6e67 6c65 5f73 697a 652c 206c 6179  tangle_size, lay
-00021460: 6572 203d 206c 6179 6572 2929 0a20 2020  er = layer)).   
-00021470: 2020 2020 2052 203d 2072 6563 7461 6e67       R = rectang
-00021480: 6c65 2873 697a 653d 7265 6374 616e 676c  le(size=rectangl
-00021490: 655f 7369 7a65 2c20 6c61 7965 723d 6c61  e_size, layer=la
-000214a0: 7965 7229 0a20 2020 2020 2020 2052 2e63  yer).        R.c
-000214b0: 656e 7465 7220 3d20 2830 2c20 3029 0a20  enter = (0, 0). 
-000214c0: 2020 2020 2020 2069 6620 696e 7620 6973         if inv is
-000214d0: 2054 7275 653a 0a20 2020 2020 2020 2020   True:.         
-000214e0: 2020 2041 203d 2072 6563 7461 6e67 6c65     A = rectangle
-000214f0: 2873 697a 653d 7369 7a65 290a 2020 2020  (size=size).    
-00021500: 2020 2020 2020 2020 412e 6365 6e74 6572          A.center
-00021510: 203d 2028 302c 2030 290a 2020 2020 2020   = (0, 0).      
-00021520: 2020 2020 2020 4120 3d20 412e 6765 745f        A = A.get_
-00021530: 706f 6c79 676f 6e73 2829 0a20 2020 2020  polygons().     
-00021540: 2020 2020 2020 2042 203d 2052 2e67 6574         B = R.get
-00021550: 5f70 6f6c 7967 6f6e 7328 290a 2020 2020  _polygons().    
-00021560: 2020 2020 2020 2020 7020 3d20 6764 7370          p = gdsp
-00021570: 792e 626f 6f6c 6561 6e28 412c 2042 2c20  y.boolean(A, B, 
-00021580: 6f70 6572 6174 696f 6e3d 226e 6f74 2229  operation="not")
-00021590: 0a20 2020 2020 2020 2020 2020 2044 2e61  .            D.a
-000215a0: 6464 5f70 6f6c 7967 6f6e 2870 2c20 6c61  dd_polygon(p, la
-000215b0: 7965 723d 6c61 7965 7229 0a20 2020 2020  yer=layer).     
-000215c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000215d0: 2020 2020 2044 2e61 6464 5f72 6566 2852       D.add_ref(R
-000215e0: 290a 2020 2020 7265 7475 726e 2044 0a0a  ).    return D..
-000215f0: 0a64 6566 205f 6c6f 6f70 5f6f 7665 7228  .def _loop_over(
-00021600: 7661 7229 3a0a 2020 2020 2222 2243 6865  var):.    """Che
-00021610: 636b 7320 6966 2061 2076 6172 6961 626c  cks if a variabl
-00021620: 6520 6973 2069 6e20 7468 6520 666f 726d  e is in the form
-00021630: 206f 6620 616e 2069 7465 7261 626c 6520   of an iterable 
-00021640: 286c 6973 742f 7475 706c 6529 0a20 2020  (list/tuple).   
-00021650: 2061 6e64 2069 6620 6e6f 742c 2072 6574   and if not, ret
-00021660: 7572 6e73 2069 7420 6173 2061 206c 6973  urns it as a lis
-00021670: 742e 2020 5573 6566 756c 2066 6f72 2061  t.  Useful for a
-00021680: 6c6c 6f77 696e 6720 6172 6775 6d65 6e74  llowing argument
-00021690: 0a20 2020 2069 6e70 7574 7320 746f 2062  .    inputs to b
-000216a0: 6520 6569 7468 6572 206c 6973 7473 2028  e either lists (
-000216b0: 652e 672e 205b 312c 2033 2c20 345d 2920  e.g. [1, 3, 4]) 
-000216c0: 6f72 2073 696e 676c 652d 7661 6c75 6564  or single-valued
-000216d0: 2028 652e 672e 2033 292e 0a0a 2020 2020   (e.g. 3)...    
-000216e0: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-000216f0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7661  ---------.    va
-00021700: 7220 3a20 696e 7420 6f72 2066 6c6f 6174  r : int or float
-00021710: 206f 7220 6c69 7374 0a20 2020 2020 2020   or list.       
-00021720: 2056 6172 6961 626c 6520 746f 2063 6865   Variable to che
-00021730: 636b 2066 6f72 2069 7465 7261 6269 6c69  ck for iterabili
-00021740: 7479 2e0a 0a20 2020 2052 6574 7572 6e73  ty...    Returns
-00021750: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-00021760: 2076 6172 203a 206c 6973 740a 2020 2020   var : list.    
-00021770: 2020 2020 5661 7269 6162 6c65 2063 6f6e      Variable con
-00021780: 7665 7274 6564 2074 6f20 6c69 7374 2069  verted to list i
-00021790: 6620 7369 6e67 6c65 2d76 616c 7565 6420  f single-valued 
-000217a0: 696e 7075 742e 0a20 2020 2022 2222 0a0a  input..    """..
-000217b0: 2020 2020 6966 2068 6173 6174 7472 2876      if hasattr(v
-000217c0: 6172 2c20 225f 5f69 7465 725f 5f22 293a  ar, "__iter__"):
-000217d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000217e0: 7661 720a 2020 2020 656c 7365 3a0a 2020  var.    else:.  
-000217f0: 2020 2020 2020 7265 7475 726e 205b 7661        return [va
-00021800: 725d 0a0a 0a64 6566 2066 696c 6c5f 7265  r]...def fill_re
-00021810: 6374 616e 676c 6528 0a20 2020 2044 2c0a  ctangle(.    D,.
-00021820: 2020 2020 6669 6c6c 5f73 697a 653d 2834      fill_size=(4
-00021830: 302c 2031 3029 2c0a 2020 2020 6176 6f69  0, 10),.    avoi
-00021840: 645f 6c61 7965 7273 3d22 616c 6c22 2c0a  d_layers="all",.
-00021850: 2020 2020 696e 636c 7564 655f 6c61 7965      include_laye
-00021860: 7273 3d4e 6f6e 652c 0a20 2020 206d 6172  rs=None,.    mar
-00021870: 6769 6e3d 3130 302c 0a20 2020 2066 696c  gin=100,.    fil
-00021880: 6c5f 6c61 7965 7273 3d28 302c 2031 2c20  l_layers=(0, 1, 
-00021890: 3329 2c0a 2020 2020 6669 6c6c 5f64 656e  3),.    fill_den
-000218a0: 7369 7469 6573 3d28 302e 352c 2030 2e32  sities=(0.5, 0.2
-000218b0: 352c 2030 2e37 292c 0a20 2020 2066 696c  5, 0.7),.    fil
-000218c0: 6c5f 696e 7665 7274 6564 3d4e 6f6e 652c  l_inverted=None,
-000218d0: 0a20 2020 2062 626f 783d 4e6f 6e65 2c0a  .    bbox=None,.
-000218e0: 293a 0a20 2020 2022 2222 4372 6561 7465  ):.    """Create
-000218f0: 7320 6120 7265 6374 616e 6775 6c61 7220  s a rectangular 
-00021900: 6669 6c6c 2070 6174 7465 726e 2061 6e64  fill pattern and
-00021910: 2066 696c 6c73 2061 6c6c 2065 6d70 7479   fills all empty
-00021920: 2061 7265 6173 0a20 2020 2069 6e20 7468   areas.    in th
-00021930: 6520 696e 7075 7420 6465 7669 6365 2044  e input device D
-00021940: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
-00021950: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-00021960: 2020 2020 4420 3a20 4465 7669 6365 0a20      D : Device. 
-00021970: 2020 2020 2020 2044 6576 6963 6520 746f         Device to
-00021980: 2062 6520 6669 6c6c 6564 0a20 2020 2066   be filled.    f
-00021990: 696c 6c5f 7369 7a65 203a 2061 7272 6179  ill_size : array
-000219a0: 2d6c 696b 655b 325d 0a20 2020 2020 2020  -like[2].       
-000219b0: 2052 6563 7461 6e67 756c 6172 2073 697a   Rectangular siz
-000219c0: 6520 6f66 2074 6865 2066 696c 6c20 656c  e of the fill el
-000219d0: 656d 656e 740a 2020 2020 6176 6f69 645f  ement.    avoid_
-000219e0: 6c61 7965 7273 203a 2027 616c 6c27 206f  layers : 'all' o
-000219f0: 7220 6c69 7374 206f 6620 6c61 7965 7273  r list of layers
-00021a00: 0a20 2020 2020 2020 204c 6179 6572 7320  .        Layers 
-00021a10: 746f 2062 6520 6176 6f69 6465 6420 286e  to be avoided (n
-00021a20: 6f74 2066 696c 6c65 6429 2069 6e20 440a  ot filled) in D.
-00021a30: 2020 2020 696e 636c 7564 655f 6c61 7965      include_laye
-00021a40: 7273 203a 0a20 2020 2020 2020 204c 6179  rs :.        Lay
-00021a50: 6572 7320 746f 2062 6520 696e 636c 7564  ers to be includ
-00021a60: 6564 2028 6669 6c6c 6564 2920 696e 2044  ed (filled) in D
-00021a70: 2c20 7375 7065 7263 6564 6573 2061 766f  , supercedes avo
-00021a80: 6964 5f6c 6179 6572 730a 2020 2020 6d61  id_layers.    ma
-00021a90: 7267 696e 203a 2069 6e74 206f 7220 666c  rgin : int or fl
-00021aa0: 6f61 740a 2020 2020 2020 2020 4d61 7267  oat.        Marg
-00021ab0: 696e 2073 7061 6369 6e67 2061 726f 756e  in spacing aroun
-00021ac0: 6420 6176 6f69 6465 6420 6172 6561 7320  d avoided areas 
-00021ad0: 2d2d 2066 696c 6c20 7769 6c6c 206e 6f74  -- fill will not
-00021ae0: 2063 6f6d 6520 7769 7468 696e 0a20 2020   come within.   
-00021af0: 2020 2020 2060 6d61 7267 696e 6020 6f66       `margin` of
-00021b00: 2074 6865 2067 656f 6d65 7472 7920 696e   the geometry in
-00021b10: 2044 0a20 2020 2066 696c 6c5f 6c61 7965   D.    fill_laye
-00021b20: 7273 203a 206c 6973 7420 6f66 206c 6179  rs : list of lay
-00021b30: 6572 730a 2020 2020 2020 2020 4465 6669  ers.        Defi
-00021b40: 6e65 7320 7468 6520 6669 6c6c 2070 6174  nes the fill pat
-00021b50: 7465 726e 206c 6179 6572 730a 2020 2020  tern layers.    
-00021b60: 6669 6c6c 5f64 656e 7369 7469 6573 203a  fill_densities :
-00021b70: 2066 6c6f 6174 2062 6574 7765 656e 2030   float between 0
-00021b80: 2061 6e64 2031 0a20 2020 2020 2020 2044   and 1.        D
-00021b90: 6566 696e 6573 2074 6865 2066 696c 6c20  efines the fill 
-00021ba0: 7061 7474 6572 6e20 6465 6e73 6974 7920  pattern density 
-00021bb0: 2831 2e30 203d 3d20 6675 6c6c 7920 6669  (1.0 == fully fi
-00021bc0: 6c6c 6564 290a 2020 2020 6669 6c6c 5f69  lled).    fill_i
-00021bd0: 6e76 6572 7465 6420 3a20 626f 6f6c 0a20  nverted : bool. 
-00021be0: 2020 2020 2020 2049 6e76 6572 7473 2074         Inverts t
-00021bf0: 6865 2066 696c 6c20 7061 7474 6572 6e0a  he fill pattern.
-00021c00: 2020 2020 6262 6f78 203a 2061 7272 6179      bbox : array
-00021c10: 2d6c 696b 655b 325d 5b32 5d0a 2020 2020  -like[2][2].    
-00021c20: 2020 2020 4c69 6d69 7420 7468 6520 6669      Limit the fi
-00021c30: 6c6c 2070 6174 7465 726e 2074 6f20 7468  ll pattern to th
-00021c40: 6520 6172 6561 2064 6566 696e 6564 2062  e area defined b
-00021c50: 7920 7468 6973 2062 6f75 6e64 696e 6720  y this bounding 
-00021c60: 626f 780a 0a20 2020 2052 6574 7572 6e73  box..    Returns
-00021c70: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-00021c80: 2046 203a 2044 6576 6963 650a 0a20 2020   F : Device..   
-00021c90: 2022 2222 0a20 2020 2023 2043 7265 6174   """.    # Creat
-00021ca0: 6520 7468 6520 6669 6c6c 2063 656c 6c2e  e the fill cell.
-00021cb0: 0a20 2020 2023 2049 6620 6669 6c6c 5f69  .    # If fill_i
-00021cc0: 6e76 6572 7465 6420 6973 206e 6f74 2073  nverted is not s
-00021cd0: 7065 6369 6669 6564 2c20 6173 7375 6d65  pecified, assume
-00021ce0: 2061 6c6c 2046 616c 7365 0a20 2020 2066   all False.    f
-00021cf0: 696c 6c5f 6c61 7965 7273 203d 205f 6c6f  ill_layers = _lo
-00021d00: 6f70 5f6f 7665 7228 6669 6c6c 5f6c 6179  op_over(fill_lay
-00021d10: 6572 7329 0a20 2020 2066 696c 6c5f 6465  ers).    fill_de
-00021d20: 6e73 6974 6965 7320 3d20 5f6c 6f6f 705f  nsities = _loop_
-00021d30: 6f76 6572 2866 696c 6c5f 6465 6e73 6974  over(fill_densit
-00021d40: 6965 7329 0a20 2020 2069 6620 6669 6c6c  ies).    if fill
-00021d50: 5f69 6e76 6572 7465 6420 6973 204e 6f6e  _inverted is Non
-00021d60: 653a 0a20 2020 2020 2020 2066 696c 6c5f  e:.        fill_
-00021d70: 696e 7665 7274 6564 203d 205b 4661 6c73  inverted = [Fals
-00021d80: 655d 202a 206c 656e 2866 696c 6c5f 6c61  e] * len(fill_la
-00021d90: 7965 7273 290a 2020 2020 6669 6c6c 5f69  yers).    fill_i
-00021da0: 6e76 6572 7465 6420 3d20 5f6c 6f6f 705f  nverted = _loop_
-00021db0: 6f76 6572 2866 696c 6c5f 696e 7665 7274  over(fill_invert
-00021dc0: 6564 290a 2020 2020 6966 206c 656e 2866  ed).    if len(f
-00021dd0: 696c 6c5f 6c61 7965 7273 2920 213d 206c  ill_layers) != l
-00021de0: 656e 2866 696c 6c5f 6465 6e73 6974 6965  en(fill_densitie
-00021df0: 7329 3a0a 2020 2020 2020 2020 7261 6973  s):.        rais
-00021e00: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
-00021e10: 2020 2020 2020 2020 2020 225b 5048 4944            "[PHID
-00021e20: 4c5d 2070 6869 646c 2e67 656f 6d65 7472  L] phidl.geometr
-00021e30: 792e 6669 6c6c 5f72 6563 7461 6e67 6c65  y.fill_rectangle
-00021e40: 2829 2022 0a20 2020 2020 2020 2020 2020  () ".           
-00021e50: 2022 6066 696c 6c5f 6c61 7965 7273 6020   "`fill_layers` 
-00021e60: 616e 6420 6066 696c 6c5f 6465 6e73 6974  and `fill_densit
-00021e70: 6965 7360 2070 6172 616d 6574 6572 7320  ies` parameters 
-00021e80: 220a 2020 2020 2020 2020 2020 2020 226d  ".            "m
-00021e90: 7573 7420 6265 206c 6973 7473 206f 6620  ust be lists of 
-00021ea0: 7468 6520 7361 6d65 206c 656e 6774 6822  the same length"
-00021eb0: 0a20 2020 2020 2020 2029 0a20 2020 2069  .        ).    i
-00021ec0: 6620 6c65 6e28 6669 6c6c 5f6c 6179 6572  f len(fill_layer
-00021ed0: 7329 2021 3d20 6c65 6e28 6669 6c6c 5f69  s) != len(fill_i
-00021ee0: 6e76 6572 7465 6429 3a0a 2020 2020 2020  nverted):.      
-00021ef0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00021f00: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00021f10: 225b 5048 4944 4c5d 2070 6869 646c 2e67  "[PHIDL] phidl.g
-00021f20: 656f 6d65 7472 792e 6669 6c6c 5f72 6563  eometry.fill_rec
-00021f30: 7461 6e67 6c65 2829 2022 0a20 2020 2020  tangle() ".     
-00021f40: 2020 2020 2020 2022 6066 696c 6c5f 6c61         "`fill_la
-00021f50: 7965 7273 6020 616e 6420 6066 696c 6c5f  yers` and `fill_
-00021f60: 696e 7665 7274 6564 6020 7061 7261 6d65  inverted` parame
-00021f70: 7465 7273 206d 7573 7420 220a 2020 2020  ters must ".    
-00021f80: 2020 2020 2020 2020 2262 6520 6c69 7374          "be list
-00021f90: 7320 6f66 2074 6865 2073 616d 6520 6c65  s of the same le
-00021fa0: 6e67 7468 220a 2020 2020 2020 2020 290a  ngth".        ).
-00021fb0: 0a20 2020 2066 696c 6c5f 6365 6c6c 203d  .    fill_cell =
-00021fc0: 205f 6669 6c6c 5f63 656c 6c5f 7265 6374   _fill_cell_rect
-00021fd0: 616e 676c 6528 0a20 2020 2020 2020 2073  angle(.        s
-00021fe0: 697a 653d 6669 6c6c 5f73 697a 652c 0a20  ize=fill_size,. 
-00021ff0: 2020 2020 2020 206c 6179 6572 733d 6669         layers=fi
-00022000: 6c6c 5f6c 6179 6572 732c 0a20 2020 2020  ll_layers,.     
-00022010: 2020 2064 656e 7369 7469 6573 3d66 696c     densities=fil
-00022020: 6c5f 6465 6e73 6974 6965 732c 0a20 2020  l_densities,.   
-00022030: 2020 2020 2069 6e76 6572 7465 643d 6669       inverted=fi
-00022040: 6c6c 5f69 6e76 6572 7465 642c 0a20 2020  ll_inverted,.   
-00022050: 2029 0a20 2020 2046 203d 2044 6576 6963   ).    F = Devic
-00022060: 6528 6e61 6d65 3d22 6669 6c6c 5f70 6174  e(name="fill_pat
-00022070: 7465 726e 2229 0a0a 2020 2020 6966 2061  tern")..    if a
-00022080: 766f 6964 5f6c 6179 6572 7320 3d3d 2022  void_layers == "
-00022090: 616c 6c22 3a0a 2020 2020 2020 2020 6578  all":.        ex
-000220a0: 636c 7564 655f 706f 6c79 7320 3d20 442e  clude_polys = D.
-000220b0: 6765 745f 706f 6c79 676f 6e73 2862 795f  get_polygons(by_
-000220c0: 7370 6563 3d46 616c 7365 2c20 6465 7074  spec=False, dept
-000220d0: 683d 4e6f 6e65 290a 2020 2020 656c 7365  h=None).    else
-000220e0: 3a0a 2020 2020 2020 2020 6176 6f69 645f  :.        avoid_
-000220f0: 6c61 7965 7273 203d 205b 5f70 6172 7365  layers = [_parse
-00022100: 5f6c 6179 6572 286c 2920 666f 7220 6c20  _layer(l) for l 
-00022110: 696e 205f 6c6f 6f70 5f6f 7665 7228 6176  in _loop_over(av
-00022120: 6f69 645f 6c61 7965 7273 295d 0a20 2020  oid_layers)].   
-00022130: 2020 2020 2065 7863 6c75 6465 5f70 6f6c       exclude_pol
-00022140: 7973 203d 2044 2e67 6574 5f70 6f6c 7967  ys = D.get_polyg
-00022150: 6f6e 7328 6279 5f73 7065 633d 5472 7565  ons(by_spec=True
-00022160: 2c20 6465 7074 683d 4e6f 6e65 290a 2020  , depth=None).  
-00022170: 2020 2020 2020 6578 636c 7564 655f 706f        exclude_po
-00022180: 6c79 7320 3d20 7b0a 2020 2020 2020 2020  lys = {.        
-00022190: 2020 2020 6b65 793a 2065 7863 6c75 6465      key: exclude
-000221a0: 5f70 6f6c 7973 5b6b 6579 5d20 666f 7220  _polys[key] for 
-000221b0: 6b65 7920 696e 2065 7863 6c75 6465 5f70  key in exclude_p
-000221c0: 6f6c 7973 2069 6620 6b65 7920 696e 2061  olys if key in a
-000221d0: 766f 6964 5f6c 6179 6572 730a 2020 2020  void_layers.    
-000221e0: 2020 2020 7d0a 2020 2020 2020 2020 6578      }.        ex
-000221f0: 636c 7564 655f 706f 6c79 7320 3d20 6974  clude_polys = it
-00022200: 6572 746f 6f6c 732e 6368 6169 6e2e 6672  ertools.chain.fr
-00022210: 6f6d 5f69 7465 7261 626c 6528 6578 636c  om_iterable(excl
-00022220: 7564 655f 706f 6c79 732e 7661 6c75 6573  ude_polys.values
-00022230: 2829 290a 0a20 2020 2069 6620 696e 636c  ())..    if incl
-00022240: 7564 655f 6c61 7965 7273 2069 7320 4e6f  ude_layers is No
-00022250: 6e65 3a0a 2020 2020 2020 2020 696e 636c  ne:.        incl
-00022260: 7564 655f 706f 6c79 7320 3d20 5b5d 0a20  ude_polys = []. 
-00022270: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00022280: 2069 6e63 6c75 6465 5f6c 6179 6572 7320   include_layers 
-00022290: 3d20 5b5f 7061 7273 655f 6c61 7965 7228  = [_parse_layer(
-000222a0: 6c29 2066 6f72 206c 2069 6e20 5f6c 6f6f  l) for l in _loo
-000222b0: 705f 6f76 6572 2869 6e63 6c75 6465 5f6c  p_over(include_l
-000222c0: 6179 6572 7329 5d0a 2020 2020 2020 2020  ayers)].        
-000222d0: 696e 636c 7564 655f 706f 6c79 7320 3d20  include_polys = 
-000222e0: 442e 6765 745f 706f 6c79 676f 6e73 2862  D.get_polygons(b
-000222f0: 795f 7370 6563 3d54 7275 652c 2064 6570  y_spec=True, dep
-00022300: 7468 3d4e 6f6e 6529 0a20 2020 2020 2020  th=None).       
-00022310: 2069 6e63 6c75 6465 5f70 6f6c 7973 203d   include_polys =
-00022320: 207b 0a20 2020 2020 2020 2020 2020 206b   {.            k
-00022330: 6579 3a20 696e 636c 7564 655f 706f 6c79  ey: include_poly
-00022340: 735b 6b65 795d 2066 6f72 206b 6579 2069  s[key] for key i
-00022350: 6e20 696e 636c 7564 655f 706f 6c79 7320  n include_polys 
-00022360: 6966 206b 6579 2069 6e20 696e 636c 7564  if key in includ
-00022370: 655f 6c61 7965 7273 0a20 2020 2020 2020  e_layers.       
-00022380: 207d 0a20 2020 2020 2020 2069 6e63 6c75   }.        inclu
-00022390: 6465 5f70 6f6c 7973 203d 2069 7465 7274  de_polys = itert
-000223a0: 6f6f 6c73 2e63 6861 696e 2e66 726f 6d5f  ools.chain.from_
-000223b0: 6974 6572 6162 6c65 2869 6e63 6c75 6465  iterable(include
-000223c0: 5f70 6f6c 7973 2e76 616c 7565 7328 2929  _polys.values())
-000223d0: 0a0a 2020 2020 6966 2062 626f 7820 6973  ..    if bbox is
-000223e0: 204e 6f6e 653a 0a20 2020 2020 2020 2062   None:.        b
-000223f0: 626f 7820 3d20 442e 6262 6f78 0a0a 2020  box = D.bbox..  
-00022400: 2020 7261 7374 6572 203d 205f 7261 7374    raster = _rast
-00022410: 6572 697a 655f 706f 6c79 676f 6e73 280a  erize_polygons(.
-00022420: 2020 2020 2020 2020 706f 6c79 676f 6e73          polygons
-00022430: 3d65 7863 6c75 6465 5f70 6f6c 7973 2c20  =exclude_polys, 
-00022440: 626f 756e 6473 3d62 626f 782c 2064 783d  bounds=bbox, dx=
-00022450: 6669 6c6c 5f73 697a 655b 305d 2c20 6479  fill_size[0], dy
-00022460: 3d66 696c 6c5f 7369 7a65 5b31 5d0a 2020  =fill_size[1].  
-00022470: 2020 290a 2020 2020 7261 7374 6572 203d    ).    raster =
-00022480: 2072 6173 7465 7220 2620 7e5f 7261 7374   raster & ~_rast
-00022490: 6572 697a 655f 706f 6c79 676f 6e73 280a  erize_polygons(.
-000224a0: 2020 2020 2020 2020 706f 6c79 676f 6e73          polygons
-000224b0: 3d69 6e63 6c75 6465 5f70 6f6c 7973 2c20  =include_polys, 
-000224c0: 626f 756e 6473 3d62 626f 782c 2064 783d  bounds=bbox, dx=
-000224d0: 6669 6c6c 5f73 697a 655b 305d 2c20 6479  fill_size[0], dy
-000224e0: 3d66 696c 6c5f 7369 7a65 5b31 5d0a 2020  =fill_size[1].  
-000224f0: 2020 290a 2020 2020 7261 7374 6572 203d    ).    raster =
-00022500: 205f 6578 7061 6e64 5f72 6173 7465 7228   _expand_raster(
-00022510: 7261 7374 6572 2c20 6469 7374 616e 6365  raster, distance
-00022520: 3d6d 6172 6769 6e20 2f20 6e70 2e61 7272  =margin / np.arr
-00022530: 6179 2866 696c 6c5f 7369 7a65 2929 0a0a  ay(fill_size))..
-00022540: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-00022550: 6765 286e 702e 7369 7a65 2872 6173 7465  ge(np.size(raste
-00022560: 722c 2030 2929 3a0a 2020 2020 2020 2020  r, 0)):.        
-00022570: 7375 625f 7261 7374 6572 7320 3d20 5b6c  sub_rasters = [l
-00022580: 6973 7428 6729 2066 6f72 206b 2c20 6720  ist(g) for k, g 
-00022590: 696e 2069 7465 7274 6f6f 6c73 2e67 726f  in itertools.gro
-000225a0: 7570 6279 2872 6173 7465 725b 695d 295d  upby(raster[i])]
-000225b0: 0a20 2020 2020 2020 206a 203d 2030 0a20  .        j = 0. 
-000225c0: 2020 2020 2020 2066 6f72 2073 2069 6e20         for s in 
-000225d0: 7375 625f 7261 7374 6572 733a 0a20 2020  sub_rasters:.   
-000225e0: 2020 2020 2020 2020 2069 6620 735b 305d           if s[0]
-000225f0: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-00022600: 2020 2020 2020 2078 2c20 7920 3d20 5f72         x, y = _r
-00022610: 6173 7465 725f 696e 6465 785f 746f 5f63  aster_index_to_c
-00022620: 6f6f 7264 7328 692c 206a 2c20 6262 6f78  oords(i, j, bbox
-00022630: 2c20 6669 6c6c 5f73 697a 655b 305d 2c20  , fill_size[0], 
-00022640: 6669 6c6c 5f73 697a 655b 315d 290a 2020  fill_size[1]).  
-00022650: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00022660: 462e 6164 6428 6764 7370 792e 4365 6c6c  F.add(gdspy.Cell
-00022670: 4172 7261 7928 7265 665f 6365 6c6c 203d  Array(ref_cell =
-00022680: 2066 696c 6c5f 6365 6c6c 2c0a 2020 2020   fill_cell,.    
-00022690: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-000226a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000226b0: 2020 2020 636f 6c75 6d6e 7320 3d20 6c65      columns = le
-000226c0: 6e28 7329 2c20 726f 7773 203d 2031 2c0a  n(s), rows = 1,.
-000226d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000226e0: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-000226f0: 2020 2020 2020 2020 7370 6163 696e 6720          spacing 
-00022700: 3d20 6669 6c6c 5f73 697a 652c 2029 290a  = fill_size, )).
-00022710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022720: 6120 3d20 462e 6164 645f 6172 7261 7928  a = F.add_array(
-00022730: 6669 6c6c 5f63 656c 6c2c 2063 6f6c 756d  fill_cell, colum
-00022740: 6e73 3d6c 656e 2873 292c 2072 6f77 733d  ns=len(s), rows=
-00022750: 312c 2073 7061 6369 6e67 3d66 696c 6c5f  1, spacing=fill_
-00022760: 7369 7a65 290a 2020 2020 2020 2020 2020  size).          
-00022770: 2020 2020 2020 612e 6d6f 7665 2828 782c        a.move((x,
-00022780: 2079 2929 0a20 2020 2020 2020 2020 2020   y)).           
-00022790: 206a 202b 3d20 6c65 6e28 7329 0a0a 2020   j += len(s)..  
-000227a0: 2020 7265 7475 726e 2046 0a0a 0a23 203d    return F...# =
-000227b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000227c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000227d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000227e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000227f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 230a  =============.#.
-00022800: 2320 5068 6f74 6f6e 6963 730a 230a 2320  # Photonics.#.# 
-00022810: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022820: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022830: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022840: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022850: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a  ==============..
-00022860: 0a64 6566 2070 6f6c 7967 6f6e 5f70 6f72  .def polygon_por
-00022870: 7473 2878 7074 733d 5b2d 312c 202d 312c  ts(xpts=[-1, -1,
-00022880: 2030 2c20 305d 2c20 7970 7473 3d5b 302c   0, 0], ypts=[0,
-00022890: 2031 2c20 312c 2030 5d2c 206c 6179 6572   1, 1, 0], layer
-000228a0: 3d30 293a 0a20 2020 2022 2222 4372 6561  =0):.    """Crea
-000228b0: 7465 7320 6120 706f 6c79 676f 6e20 7769  tes a polygon wi
-000228c0: 7468 2070 6f72 7473 206f 6e20 616c 6c20  th ports on all 
-000228d0: 6564 6765 732e 0a0a 2020 2020 5061 7261  edges...    Para
-000228e0: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-000228f0: 2d2d 2d2d 2d0a 2020 2020 7870 7473 203a  -----.    xpts :
-00022900: 2061 7272 6179 2d6c 696b 650a 2020 2020   array-like.    
-00022910: 2020 2020 782d 636f 6f72 6469 6e61 7465      x-coordinate
-00022920: 2076 616c 7565 7320 6f66 2074 6865 2070   values of the p
-00022930: 6f6c 7967 6f6e 2076 6572 7469 6365 732e  olygon vertices.
-00022940: 0a20 2020 2079 7074 7320 3a20 6172 7261  .    ypts : arra
-00022950: 792d 6c69 6b65 0a20 2020 2020 2020 2079  y-like.        y
-00022960: 2d63 6f6f 7264 696e 6174 6520 7661 6c75  -coordinate valu
-00022970: 6573 206f 6620 7468 6520 706f 6c79 676f  es of the polygo
-00022980: 6e20 7665 7274 6963 6573 2e0a 2020 2020  n vertices..    
-00022990: 6c61 7965 7220 3a20 696e 742c 2061 7272  layer : int, arr
-000229a0: 6179 2d6c 696b 655b 325d 2c20 6f72 2073  ay-like[2], or s
-000229b0: 6574 0a20 2020 2020 2020 2053 7065 6369  et.        Speci
-000229c0: 6669 6320 6c61 7965 7228 7329 2074 6f20  fic layer(s) to 
-000229d0: 7075 7420 706f 6c79 676f 6e20 6765 6f6d  put polygon geom
-000229e0: 6574 7279 206f 6e2e 0a0a 2020 2020 5265  etry on...    Re
-000229f0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00022a00: 2d0a 2020 2020 5020 3a20 4465 7669 6365  -.    P : Device
-00022a10: 0a20 2020 2020 2020 2041 2044 6576 6963  .        A Devic
-00022a20: 6520 636f 6e74 6169 6e69 6e67 2061 2070  e containing a p
-00022a30: 6f6c 7967 6f6e 2077 6974 6820 706f 7274  olygon with port
-00022a40: 7320 6f6e 2061 6c6c 2065 6467 6573 2e0a  s on all edges..
-00022a50: 2020 2020 2222 220a 2020 2020 2320 7265      """.    # re
-00022a60: 7475 726e 7320 6120 706f 6c79 676f 6e20  turns a polygon 
-00022a70: 7769 7468 2070 6f72 7473 206f 6e20 616c  with ports on al
-00022a80: 6c20 6564 6765 730a 2020 2020 5020 3d20  l edges.    P = 
-00022a90: 4465 7669 6365 2822 706f 6c79 676f 6e22  Device("polygon"
-00022aa0: 290a 2020 2020 502e 6164 645f 706f 6c79  ).    P.add_poly
-00022ab0: 676f 6e28 5b78 7074 732c 2079 7074 735d  gon([xpts, ypts]
-00022ac0: 2c20 6c61 7965 723d 6c61 7965 7229 0a20  , layer=layer). 
-00022ad0: 2020 206e 203d 206c 656e 2878 7074 7329     n = len(xpts)
-00022ae0: 0a20 2020 2078 7074 732e 6170 7065 6e64  .    xpts.append
-00022af0: 2878 7074 735b 305d 290a 2020 2020 7970  (xpts[0]).    yp
-00022b00: 7473 2e61 7070 656e 6428 7970 7473 5b30  ts.append(ypts[0
-00022b10: 5d29 0a20 2020 2023 2064 6574 6572 6d69  ]).    # determi
-00022b20: 6e65 2069 6620 636c 6f63 6b77 6973 6520  ne if clockwise 
-00022b30: 6f72 2063 6f75 6e74 6572 636c 6f63 6b77  or counterclockw
-00022b40: 6973 650a 2020 2020 6363 203d 2030 0a20  ise.    cc = 0. 
-00022b50: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-00022b60: 6528 302c 206e 293a 0a20 2020 2020 2020  e(0, n):.       
-00022b70: 2063 6320 2b3d 2028 7870 7473 5b69 202b   cc += (xpts[i +
-00022b80: 2031 5d20 2d20 7870 7473 5b69 5d29 202a   1] - xpts[i]) *
-00022b90: 2028 7970 7473 5b69 202b 2031 5d20 2b20   (ypts[i + 1] + 
-00022ba0: 7970 7473 5b69 5d29 0a0a 2020 2020 666f  ypts[i])..    fo
-00022bb0: 7220 6920 696e 2072 616e 6765 2830 2c20  r i in range(0, 
-00022bc0: 6e29 3a0a 2020 2020 2020 2020 6d69 6470  n):.        midp
-00022bd0: 6f69 6e74 5f6e 203d 205b 2878 7074 735b  oint_n = [(xpts[
-00022be0: 6920 2b20 315d 202b 2078 7074 735b 695d  i + 1] + xpts[i]
-00022bf0: 2920 2f20 322c 2028 7970 7473 5b69 202b  ) / 2, (ypts[i +
-00022c00: 2031 5d20 2b20 7970 7473 5b69 5d29 202f   1] + ypts[i]) /
-00022c10: 2032 5d0a 2020 2020 2020 2020 6f72 6965   2].        orie
-00022c20: 6e74 6174 696f 6e5f 6e20 3d20 280a 2020  ntation_n = (.  
-00022c30: 2020 2020 2020 2020 2020 6e70 2e61 7263            np.arc
-00022c40: 7461 6e32 280a 2020 2020 2020 2020 2020  tan2(.          
-00022c50: 2020 2020 2020 6e70 2e73 6967 6e28 6363        np.sign(cc
-00022c60: 2920 2a20 2878 7074 735b 6920 2b20 315d  ) * (xpts[i + 1]
-00022c70: 202d 2078 7074 735b 695d 292c 0a20 2020   - xpts[i]),.   
-00022c80: 2020 2020 2020 2020 2020 2020 206e 702e               np.
-00022c90: 7369 676e 2863 6329 202a 2028 7970 7473  sign(cc) * (ypts
-00022ca0: 5b69 5d20 2d20 7970 7473 5b69 202b 2031  [i] - ypts[i + 1
-00022cb0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-00022cc0: 290a 2020 2020 2020 2020 2020 2020 2a20  ).            * 
-00022cd0: 3138 300a 2020 2020 2020 2020 2020 2020  180.            
-00022ce0: 2f20 7069 0a20 2020 2020 2020 2029 0a20  / pi.        ). 
-00022cf0: 2020 2020 2020 2077 6964 7468 5f6e 203d         width_n =
-00022d00: 206e 702e 6162 7328 0a20 2020 2020 2020   np.abs(.       
-00022d10: 2020 2020 2073 7172 7428 2878 7074 735b       sqrt((xpts[
-00022d20: 6920 2b20 315d 202d 2078 7074 735b 695d  i + 1] - xpts[i]
-00022d30: 2920 2a2a 2032 202b 2028 7970 7473 5b69  ) ** 2 + (ypts[i
-00022d40: 202b 2031 5d20 2d20 7970 7473 5b69 5d29   + 1] - ypts[i])
-00022d50: 202a 2a20 3229 0a20 2020 2020 2020 2029   ** 2).        )
-00022d60: 0a20 2020 2020 2020 2050 2e61 6464 5f70  .        P.add_p
-00022d70: 6f72 7428 0a20 2020 2020 2020 2020 2020  ort(.           
-00022d80: 206e 616d 653d 7374 7228 6920 2b20 3129   name=str(i + 1)
-00022d90: 2c0a 2020 2020 2020 2020 2020 2020 6d69  ,.            mi
-00022da0: 6470 6f69 6e74 3d6d 6964 706f 696e 745f  dpoint=midpoint_
-00022db0: 6e2c 0a20 2020 2020 2020 2020 2020 2077  n,.            w
-00022dc0: 6964 7468 3d77 6964 7468 5f6e 2c0a 2020  idth=width_n,.  
-00022dd0: 2020 2020 2020 2020 2020 6f72 6965 6e74            orient
-00022de0: 6174 696f 6e3d 6f72 6965 6e74 6174 696f  ation=orientatio
-00022df0: 6e5f 6e2c 0a20 2020 2020 2020 2029 0a0a  n_n,.        )..
-00022e00: 2020 2020 7265 7475 726e 2050 0a0a 0a23      return P...#
-00022e10: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
-00022e20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022e30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022e40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022e50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
-00022e60: 2320 4578 616d 706c 6520 636f 6465 0a23  # Example code.#
-00022e70: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
-00022e80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022e90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022ea0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022eb0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
-00022ec0: 0a23 2050 203d 2070 6f6c 7967 6f6e 2878  .# P = polygon(x
-00022ed0: 7074 733d 5b2d 312c 2d33 2c20 302c 2030  pts=[-1,-3, 0, 0
-00022ee0: 5d2c 2079 7074 7320 3d20 5b30 2c20 312c  ], ypts = [0, 1,
-00022ef0: 2032 2c20 305d 2c20 6c61 7965 7220 3d20   2, 0], layer = 
-00022f00: 3329 0a23 2071 7569 636b 706c 6f74 2850  3).# quickplot(P
-00022f10: 290a 0a0a 4064 6576 6963 655f 6c72 755f  )...@device_lru_
-00022f20: 6361 6368 650a 6465 6620 6772 6174 696e  cache.def gratin
-00022f30: 6728 0a20 2020 206e 756d 5f70 6572 696f  g(.    num_perio
-00022f40: 6473 3d32 302c 0a20 2020 2070 6572 696f  ds=20,.    perio
-00022f50: 643d 302e 3735 2c0a 2020 2020 6669 6c6c  d=0.75,.    fill
-00022f60: 5f66 6163 746f 723d 302e 352c 0a20 2020  _factor=0.5,.   
-00022f70: 2077 6964 7468 5f67 7261 7469 6e67 3d35   width_grating=5
-00022f80: 2c0a 2020 2020 6c65 6e67 7468 5f74 6170  ,.    length_tap
-00022f90: 6572 3d31 302c 0a20 2020 2077 6964 7468  er=10,.    width
-00022fa0: 3d30 2e34 2c0a 2020 2020 7061 7274 6961  =0.4,.    partia
-00022fb0: 6c5f 6574 6368 3d46 616c 7365 2c0a 293a  l_etch=False,.):
-00022fc0: 0a20 2020 2022 2222 5369 6d70 6c65 2067  .    """Simple g
-00022fd0: 7261 7469 6e67 2073 7472 7563 7475 7265  rating structure
-00022fe0: 2066 6f72 2070 686f 746f 6e69 6373 0a0a   for photonics..
-00022ff0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-00023000: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-00023010: 2020 6e75 6d5f 7065 7269 6f64 7320 3a20    num_periods : 
-00023020: 696e 740a 2020 2020 2020 2020 4e75 6d62  int.        Numb
-00023030: 6572 206f 6620 6772 6174 696e 6773 2e0a  er of gratings..
-00023040: 2020 2020 7065 7269 6f64 203a 2069 6e74      period : int
-00023050: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
-00023060: 2020 4469 7374 616e 6365 2062 6574 7765    Distance betwe
-00023070: 656e 2067 7261 7469 6e67 732e 0a20 2020  en gratings..   
-00023080: 2066 696c 6c5f 6661 6374 6f72 203a 2069   fill_factor : i
-00023090: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
-000230a0: 2020 2020 5468 6963 6b6e 6573 7320 6f66      Thickness of
-000230b0: 2074 6865 2067 7261 7469 6e67 732e 0a20   the gratings.. 
-000230c0: 2020 2077 6964 7468 5f67 7261 7469 6e67     width_grating
-000230d0: 203a 2069 6e74 206f 7220 666c 6f61 740a   : int or float.
-000230e0: 2020 2020 2020 2020 5769 6474 6820 6f66          Width of
-000230f0: 2074 6865 2067 7261 7469 6e67 732e 0a20   the gratings.. 
-00023100: 2020 206c 656e 6774 685f 7461 7065 7220     length_taper 
-00023110: 3a20 696e 7420 6f72 2066 6c6f 6174 0a20  : int or float. 
-00023120: 2020 2020 2020 204c 656e 6774 6820 6f66         Length of
-00023130: 2074 6865 2074 6170 6572 2073 6563 7469   the taper secti
-00023140: 6f6e 2e0a 2020 2020 7769 6474 6820 3a20  on..    width : 
-00023150: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
-00023160: 2020 2020 2057 6964 7468 206f 6620 7468       Width of th
-00023170: 6520 656e 6420 6f66 2074 6865 2074 6170  e end of the tap
-00023180: 6572 2073 6563 7469 6f6e 2e0a 2020 2020  er section..    
-00023190: 7061 7274 6961 6c5f 6574 6368 203a 2062  partial_etch : b
-000231a0: 6f6f 6c0a 2020 2020 2020 2020 4966 2054  ool.        If T
-000231b0: 7275 652c 206d 616b 6573 2061 6e20 756e  rue, makes an un
-000231c0: 7461 7065 7265 642c 2070 6172 7469 616c  tapered, partial
-000231d0: 6c79 2d65 7463 6865 6420 6772 6174 696e  ly-etched gratin
-000231e0: 672e 0a0a 2020 2020 5265 7475 726e 730a  g...    Returns.
-000231f0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-00023200: 4720 3a20 4465 7669 6365 0a20 2020 2020  G : Device.     
-00023210: 2020 2041 2044 6576 6963 6520 636f 6e74     A Device cont
-00023220: 6169 6e69 6e67 2061 2066 6962 6572 2067  aining a fiber g
-00023230: 7261 7469 6e67 2067 656f 6d65 7472 792e  rating geometry.
-00023240: 0a20 2020 2022 2222 0a20 2020 2023 2072  .    """.    # r
-00023250: 6574 7572 6e73 2061 2066 6962 6572 2067  eturns a fiber g
-00023260: 7261 7469 6e67 0a20 2020 2047 203d 2044  rating.    G = D
-00023270: 6576 6963 6528 2267 7261 7469 6e67 2229  evice("grating")
-00023280: 0a0a 2020 2020 2320 6d61 6b65 2074 6865  ..    # make the
-00023290: 2064 6565 7020 6574 6368 6564 2067 7261   deep etched gra
-000232a0: 7469 6e67 0a20 2020 2069 6620 7061 7274  ting.    if part
-000232b0: 6961 6c5f 6574 6368 2069 7320 4661 6c73  ial_etch is Fals
-000232c0: 653a 0a20 2020 2020 2020 2023 206d 616b  e:.        # mak
-000232d0: 6520 7468 6520 6772 6174 696e 6720 7465  e the grating te
-000232e0: 6574 680a 2020 2020 2020 2020 666f 7220  eth.        for 
-000232f0: 6920 696e 2072 616e 6765 286e 756d 5f70  i in range(num_p
-00023300: 6572 696f 6473 293a 0a20 2020 2020 2020  eriods):.       
-00023310: 2020 2020 2063 6772 6174 696e 6720 3d20       cgrating = 
-00023320: 472e 6164 645f 7265 6628 0a20 2020 2020  G.add_ref(.     
-00023330: 2020 2020 2020 2020 2020 2063 6f6d 7061             compa
-00023340: 7373 2873 697a 653d 5b70 6572 696f 6420  ss(size=[period 
-00023350: 2a20 6669 6c6c 5f66 6163 746f 722c 2077  * fill_factor, w
-00023360: 6964 7468 5f67 7261 7469 6e67 5d2c 206c  idth_grating], l
-00023370: 6179 6572 3d30 290a 2020 2020 2020 2020  ayer=0).        
-00023380: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00023390: 2020 6367 7261 7469 6e67 2e78 202b 3d20    cgrating.x += 
-000233a0: 6920 2a20 7065 7269 6f64 0a0a 2020 2020  i * period..    
-000233b0: 2020 2020 2320 6d61 6b65 2074 6865 2074      # make the t
-000233c0: 6170 6572 0a20 2020 2020 2020 2074 6772  aper.        tgr
-000233d0: 6174 696e 6720 3d20 472e 6164 645f 7265  ating = G.add_re
-000233e0: 6628 0a20 2020 2020 2020 2020 2020 2074  f(.            t
-000233f0: 6170 6572 280a 2020 2020 2020 2020 2020  aper(.          
-00023400: 2020 2020 2020 6c65 6e67 7468 3d6c 656e        length=len
-00023410: 6774 685f 7461 7065 722c 0a20 2020 2020  gth_taper,.     
-00023420: 2020 2020 2020 2020 2020 2077 6964 7468             width
-00023430: 313d 7769 6474 685f 6772 6174 696e 672c  1=width_grating,
-00023440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023450: 2077 6964 7468 323d 7769 6474 682c 0a20   width2=width,. 
-00023460: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00023470: 6f72 743d 4e6f 6e65 2c0a 2020 2020 2020  ort=None,.      
-00023480: 2020 2020 2020 2020 2020 6c61 7965 723d            layer=
-00023490: 302c 0a20 2020 2020 2020 2020 2020 2029  0,.            )
-000234a0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-000234b0: 2020 2074 6772 6174 696e 672e 786d 696e     tgrating.xmin
-000234c0: 203d 2063 6772 6174 696e 672e 786d 6178   = cgrating.xmax
-000234d0: 0a20 2020 2020 2020 2023 2064 6566 696e  .        # defin
-000234e0: 6520 7468 6520 706f 7274 206f 6620 7468  e the port of th
-000234f0: 6520 6772 6174 696e 670a 2020 2020 2020  e grating.      
-00023500: 2020 7020 3d20 472e 6164 645f 706f 7274    p = G.add_port
-00023510: 2870 6f72 743d 7467 7261 7469 6e67 2e70  (port=tgrating.p
-00023520: 6f72 7473 5b32 5d2c 206e 616d 653d 3129  orts[2], name=1)
-00023530: 0a20 2020 2023 206d 616b 6520 6120 7061  .    # make a pa
-00023540: 7274 6961 6c6c 7920 6574 6368 6564 2067  rtially etched g
-00023550: 7261 7469 6e67 0a20 2020 2069 6620 7061  rating.    if pa
-00023560: 7274 6961 6c5f 6574 6368 2069 7320 5472  rtial_etch is Tr
-00023570: 7565 3a0a 2020 2020 2020 2020 2320 6861  ue:.        # ha
-00023580: 7264 2063 6f64 6564 206f 7665 726c 6170  rd coded overlap
-00023590: 0a20 2020 2020 2020 2070 6172 7465 7463  .        partetc
-000235a0: 685f 6f76 6572 6861 6e67 203d 2035 0a20  h_overhang = 5. 
-000235b0: 2020 2020 2020 2023 206d 616b 6520 7468         # make th
-000235c0: 6520 6574 6368 6564 2061 7265 6173 2028  e etched areas (
-000235d0: 6f70 706f 7369 7465 2074 6f20 7465 6574  opposite to teet
-000235e0: 6829 0a20 2020 2020 2020 2066 6f72 2069  h).        for i
-000235f0: 2069 6e20 7261 6e67 6528 6e75 6d5f 7065   in range(num_pe
-00023600: 7269 6f64 7329 3a0a 2020 2020 2020 2020  riods):.        
-00023610: 2020 2020 6367 7261 7469 6e67 203d 2047      cgrating = G
-00023620: 2e61 6464 5f72 6566 280a 2020 2020 2020  .add_ref(.      
-00023630: 2020 2020 2020 2020 2020 636f 6d70 6173            compas
-00023640: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-00023650: 2020 2020 2020 2073 697a 653d 5b0a 2020         size=[.  
-00023660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023670: 2020 2020 2020 7065 7269 6f64 202a 2028        period * (
-00023680: 3120 2d20 6669 6c6c 5f66 6163 746f 7229  1 - fill_factor)
-00023690: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000236a0: 2020 2020 2020 2020 2020 7769 6474 685f            width_
-000236b0: 6772 6174 696e 6720 2b20 7061 7274 6574  grating + partet
-000236c0: 6368 5f6f 7665 7268 616e 6720 2a20 322c  ch_overhang * 2,
-000236d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000236e0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-000236f0: 2020 2020 2020 2020 2020 2020 6c61 7965              laye
-00023700: 723d 312c 0a20 2020 2020 2020 2020 2020  r=1,.           
-00023710: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00023720: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00023730: 2063 6772 6174 696e 672e 7820 2b3d 2069   cgrating.x += i
-00023740: 202a 2070 6572 696f 640a 2020 2020 2020   * period.      
-00023750: 2020 2320 6465 6669 6e65 2074 6865 2070    # define the p
-00023760: 6f72 7420 6f66 2074 6865 2067 7261 7469  ort of the grati
-00023770: 6e67 0a20 2020 2020 2020 2070 203d 2047  ng.        p = G
-00023780: 2e61 6464 5f70 6f72 7428 706f 7274 3d63  .add_port(port=c
-00023790: 6772 6174 696e 672e 706f 7274 735b 2245  grating.ports["E
-000237a0: 225d 2c20 6e61 6d65 3d31 290a 2020 2020  "], name=1).    
-000237b0: 2020 2020 702e 6d69 6470 6f69 6e74 203d      p.midpoint =
-000237c0: 2070 2e6d 6964 706f 696e 7420 2b20 6e70   p.midpoint + np
-000237d0: 2e61 7272 6179 285b 2831 202d 2066 696c  .array([(1 - fil
-000237e0: 6c5f 6661 6374 6f72 2920 2a20 7065 7269  l_factor) * peri
-000237f0: 6f64 2c20 305d 290a 0a20 2020 2020 2020  od, 0])..       
-00023800: 2023 2064 7261 7720 7468 6520 6465 6570   # draw the deep
-00023810: 2065 7463 6865 6420 7371 7561 7265 2061   etched square a
-00023820: 726f 756e 6420 7468 6520 6772 6174 696e  round the gratin
-00023830: 670a 2020 2020 2020 2020 472e 6164 645f  g.        G.add_
-00023840: 7265 6628 2020 2320 6465 6570 626f 780a  ref(  # deepbox.
-00023850: 2020 2020 2020 2020 2020 2020 636f 6d70              comp
-00023860: 6173 7328 7369 7a65 3d5b 6e75 6d5f 7065  ass(size=[num_pe
-00023870: 7269 6f64 7320 2a20 7065 7269 6f64 2c20  riods * period, 
-00023880: 7769 6474 685f 6772 6174 696e 675d 2c20  width_grating], 
-00023890: 6c61 7965 723d 3029 0a20 2020 2020 2020  layer=0).       
-000238a0: 2029 0a20 2020 2072 6574 7572 6e20 470a   ).    return G.
-000238b0: 0a0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ..# ============
+0001c540: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001c550: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
+0001c560: 230a 2320 5761 7665 6775 6964 6520 6375  #.# Waveguide cu
+0001c570: 7276 6573 0a23 0a23 203d 3d3d 3d3d 3d3d  rves.#.# =======
+0001c580: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001c590: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001c5a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001c5b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001c5c0: 3d3d 3d3d 3d3d 3d0a 0a0a 6465 6620 7261  =======...def ra
+0001c5d0: 6365 7472 6163 6b5f 6772 6164 7561 6c28  cetrack_gradual(
+0001c5e0: 7769 6474 683d 302e 332c 2052 3d35 2c20  width=0.3, R=5, 
+0001c5f0: 4e3d 332c 206c 6179 6572 3d30 293a 0a20  N=3, layer=0):. 
+0001c600: 2020 2022 2222 4372 6561 7465 7320 6120     """Creates a 
+0001c610: 6772 6164 7561 6c20 7261 6365 7472 6163  gradual racetrac
+0001c620: 6b20 6265 6e74 2067 656f 6d65 7472 792e  k bent geometry.
+0001c630: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+0001c640: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+0001c650: 2020 2020 7769 6474 6820 3a20 696e 7420      width : int 
+0001c660: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
+0001c670: 2057 6964 7468 206f 6620 7468 6520 7472   Width of the tr
+0001c680: 6163 6b2e 0a20 2020 2052 203a 2069 6e74  ack..    R : int
+0001c690: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
+0001c6a0: 2020 5261 6469 7573 206f 6620 7468 6520    Radius of the 
+0001c6b0: 7472 6163 6b20 6174 2069 7473 206d 6f73  track at its mos
+0001c6c0: 7420 6375 7276 6564 2070 6f69 6e74 2e0a  t curved point..
+0001c6d0: 2020 2020 4e20 3a20 696e 7420 6f72 2066      N : int or f
+0001c6e0: 6c6f 6174 0a20 2020 2020 2020 2052 6164  loat.        Rad
+0001c6f0: 6975 7320 6f66 2074 6865 2074 7261 636b  ius of the track
+0001c700: 2061 7420 6974 7320 6c65 6173 7420 6375   at its least cu
+0001c710: 7276 6564 2070 6f69 6e74 2e0a 2020 2020  rved point..    
+0001c720: 6c61 7965 7220 3a20 696e 742c 2061 7272  layer : int, arr
+0001c730: 6179 2d6c 696b 655b 325d 2c20 6f72 2073  ay-like[2], or s
+0001c740: 6574 0a20 2020 2020 2020 2053 7065 6369  et.        Speci
+0001c750: 6669 6320 6c61 7965 7228 7329 2074 6f20  fic layer(s) to 
+0001c760: 7075 7420 706f 6c79 676f 6e20 6765 6f6d  put polygon geom
+0001c770: 6574 7279 206f 6e2e 0a0a 2020 2020 5265  etry on...    Re
+0001c780: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+0001c790: 2d0a 2020 2020 4420 3a20 4465 7669 6365  -.    D : Device
+0001c7a0: 0a20 2020 2020 2020 2041 2044 6576 6963  .        A Devic
+0001c7b0: 6520 636f 6e74 6169 6e69 6e67 2061 2067  e containing a g
+0001c7c0: 7261 6475 616c 2072 6163 6574 7261 636b  radual racetrack
+0001c7d0: 2062 656e 7420 6765 6f6d 6574 7279 2e0a   bent geometry..
+0001c7e0: 2020 2020 2222 220a 2020 2020 6375 7276      """.    curv
+0001c7f0: 655f 6675 6e20 3d20 6c61 6d62 6461 2074  e_fun = lambda t
+0001c800: 3a20 5f72 6163 6574 7261 636b 5f67 7261  : _racetrack_gra
+0001c810: 6475 616c 5f70 6172 616d 6574 7269 6328  dual_parametric(
+0001c820: 742c 2052 3d35 2c20 4e3d 3329 0a20 2020  t, R=5, N=3).   
+0001c830: 2072 6f75 7465 5f70 6174 6820 3d20 6764   route_path = gd
+0001c840: 7370 792e 5061 7468 2877 6964 7468 3d77  spy.Path(width=w
+0001c850: 6964 7468 2c20 696e 6974 6961 6c5f 706f  idth, initial_po
+0001c860: 696e 743d 5b30 2c20 305d 290a 2020 2020  int=[0, 0]).    
+0001c870: 726f 7574 655f 7061 7468 2e70 6172 616d  route_path.param
+0001c880: 6574 7269 6328 0a20 2020 2020 2020 2063  etric(.        c
+0001c890: 7572 7665 5f66 756e 2c0a 2020 2020 2020  urve_fun,.      
+0001c8a0: 2020 6e75 6d62 6572 5f6f 665f 6576 616c    number_of_eval
+0001c8b0: 7561 7469 6f6e 733d 3939 2c0a 2020 2020  uations=99,.    
+0001c8c0: 2020 2020 6d61 785f 706f 696e 7473 3d34      max_points=4
+0001c8d0: 3030 302c 0a20 2020 2020 2020 2066 696e  000,.        fin
+0001c8e0: 616c 5f64 6973 7461 6e63 653d 4e6f 6e65  al_distance=None
+0001c8f0: 2c0a 2020 2020 2020 2020 6c61 7965 723d  ,.        layer=
+0001c900: 6c61 7965 722c 0a20 2020 2029 0a20 2020  layer,.    ).   
+0001c910: 2044 203d 2044 6576 6963 6528 2272 6163   D = Device("rac
+0001c920: 6574 7261 636b 2229 0a20 2020 2044 2e61  etrack").    D.a
+0001c930: 6464 2872 6f75 7465 5f70 6174 6829 0a20  dd(route_path). 
+0001c940: 2020 2072 6574 7572 6e20 440a 0a0a 6465     return D...de
+0001c950: 6620 5f72 6163 6574 7261 636b 5f67 7261  f _racetrack_gra
+0001c960: 6475 616c 5f70 6172 616d 6574 7269 6328  dual_parametric(
+0001c970: 742c 2052 2c20 4e29 3a0a 2020 2020 2222  t, R, N):.    ""
+0001c980: 2254 616b 6573 2069 6e20 6120 7061 7261  "Takes in a para
+0001c990: 6d65 7472 6963 2076 616c 7565 2060 6074  metric value ``t
+0001c9a0: 6060 206f 6e20 2830 2c31 292c 2072 6574  `` on (0,1), ret
+0001c9b0: 7572 6e73 2074 6865 2078 2c79 2063 6f6f  urns the x,y coo
+0001c9c0: 7264 696e 6174 6573 0a20 2020 206f 6620  rdinates.    of 
+0001c9d0: 6120 7261 6365 7472 6163 6b20 6265 6e74  a racetrack bent
+0001c9e0: 2061 6363 6f72 6469 6e67 2074 6f0a 2020   according to.  
+0001c9f0: 2020 3230 3039 3038 3130 5f45 4f53 345f    20090810_EOS4_
+0001ca00: 6d6f 6475 6c61 746f 725f 6465 7369 676e  modulator_design
+0001ca10: 735f 6578 6365 7270 7446 6f72 4a61 736f  s_excerptForJaso
+0001ca20: 6e47 7261 6475 616c 4265 6e64 732e 7070  nGradualBends.pp
+0001ca30: 740a 0a20 2020 2050 6172 616d 6574 6572  t..    Parameter
+0001ca40: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+0001ca50: 0a20 2020 2074 203a 2061 7272 6179 2d6c  .    t : array-l
+0001ca60: 696b 655b 4e5d 0a20 2020 2020 2020 2050  ike[N].        P
+0001ca70: 6172 616d 6574 7269 6320 7661 6c75 6573  arametric values
+0001ca80: 2066 6f72 2074 6865 2072 6163 6574 7261   for the racetra
+0001ca90: 636b 2e0a 2020 2020 5220 3a20 696e 7420  ck..    R : int 
+0001caa0: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
+0001cab0: 2052 6164 6975 7320 6f66 2074 6865 2074   Radius of the t
+0001cac0: 7261 636b 2061 7420 6974 7320 6d6f 7374  rack at its most
+0001cad0: 2063 7572 7665 6420 706f 696e 742e 0a20   curved point.. 
+0001cae0: 2020 204e 203a 2069 6e74 206f 7220 666c     N : int or fl
+0001caf0: 6f61 740a 2020 2020 2020 2020 5261 6469  oat.        Radi
+0001cb00: 7573 206f 6620 7468 6520 7472 6163 6b20  us of the track 
+0001cb10: 6174 2069 7473 206c 6561 7374 2063 7572  at its least cur
+0001cb20: 7665 6420 706f 696e 742e 0a0a 2020 2020  ved point...    
+0001cb30: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+0001cb40: 2d2d 2d0a 2020 2020 7820 3a20 6172 7261  ---.    x : arra
+0001cb50: 792d 6c69 6b65 5b4e 5d0a 2020 2020 2020  y-like[N].      
+0001cb60: 2020 782d 636f 6f72 6469 6e61 7465 7320    x-coordinates 
+0001cb70: 6f66 2074 6865 2072 6163 6574 7261 636b  of the racetrack
+0001cb80: 2063 7572 7665 2e0a 2020 2020 7920 3a20   curve..    y : 
+0001cb90: 6172 7261 792d 6c69 6b65 5b4e 5d0a 2020  array-like[N].  
+0001cba0: 2020 2020 2020 792d 636f 6f72 6469 6e61        y-coordina
+0001cbb0: 7465 7320 6f66 2074 6865 2072 6163 6574  tes of the racet
+0001cbc0: 7261 636b 2063 7572 7665 2e0a 2020 2020  rack curve..    
+0001cbd0: 2222 220a 2020 2020 7830 203d 2052 202f  """.    x0 = R /
+0001cbe0: 2032 202a 2a20 2831 202f 204e 290a 2020   2 ** (1 / N).  
+0001cbf0: 2020 526d 696e 203d 2032 202a 2a20 2830    Rmin = 2 ** (0
+0001cc00: 2e35 202d 2031 202f 204e 2920 2f20 284e  .5 - 1 / N) / (N
+0001cc10: 202d 2031 2920 2a20 520a 2020 2020 5230   - 1) * R.    R0
+0001cc20: 203d 2052 202d 2028 7830 202d 2052 6d69   = R - (x0 - Rmi
+0001cc30: 6e20 2f20 7371 7274 2832 2929 0a20 2020  n / sqrt(2)).   
+0001cc40: 2074 203d 206e 702e 6172 7261 7928 7429   t = np.array(t)
+0001cc50: 0a20 2020 2078 2c20 7920 3d20 6e70 2e7a  .    x, y = np.z
+0001cc60: 6572 6f73 2874 2e73 6861 7065 292c 206e  eros(t.shape), n
+0001cc70: 702e 7a65 726f 7328 742e 7368 6170 6529  p.zeros(t.shape)
+0001cc80: 0a0a 2020 2020 2320 446f 696e 6720 7468  ..    # Doing th
+0001cc90: 6520 6d61 7468 0a20 2020 2078 203d 2063  e math.    x = c
+0001cca0: 6f73 2874 202a 2070 6920 2f20 3229 202a  os(t * pi / 2) *
+0001ccb0: 2052 3020 2023 2074 2028 302d 3129 2077   R0  # t (0-1) w
+0001ccc0: 6869 6c65 2078 2028 3020 746f 2052 3029  hile x (0 to R0)
+0001ccd0: 0a20 2020 2069 6920 3d20 2852 6d69 6e20  .    ii = (Rmin 
+0001cce0: 2f20 7371 7274 2832 2920 3c20 7829 2026  / sqrt(2) < x) &
+0001ccf0: 2028 7820 3c3d 2052 3029 0a20 2020 206a   (x <= R0).    j
+0001cd00: 6a20 3d20 2830 203c 2078 2920 2620 2878  j = (0 < x) & (x
+0001cd10: 203c 3d20 526d 696e 202f 2073 7172 7428   <= Rmin / sqrt(
+0001cd20: 3229 290a 2020 2020 795b 6969 5d20 3d20  2)).    y[ii] = 
+0001cd30: 2852 2a2a 4e20 2d20 2878 5b69 695d 202b  (R**N - (x[ii] +
+0001cd40: 2028 7830 202d 2052 6d69 6e20 2f20 7371   (x0 - Rmin / sq
+0001cd50: 7274 2832 2929 2920 2a2a 204e 2920 2a2a  rt(2))) ** N) **
+0001cd60: 2028 3120 2f20 4e29 0a20 2020 2079 5b6a   (1 / N).    y[j
+0001cd70: 6a5d 203d 2028 7830 202d 2052 6d69 6e20  j] = (x0 - Rmin 
+0001cd80: 2f20 7371 7274 2832 2929 202b 2073 7172  / sqrt(2)) + sqr
+0001cd90: 7428 526d 696e 2a2a 3220 2d20 785b 6a6a  t(Rmin**2 - x[jj
+0001cda0: 5d20 2a2a 2032 290a 2020 2020 7265 7475  ] ** 2).    retu
+0001cdb0: 726e 2078 2c20 790a 0a0a 2320 3d3d 3d3d  rn x, y...# ====
+0001cdc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001cdd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001cde0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001cdf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001ce00: 3d3d 3d3d 3d3d 3d3d 3d3d 0a23 2045 7861  ==========.# Exa
+0001ce10: 6d70 6c65 2063 6f64 650a 2320 3d3d 3d3d  mple code.# ====
+0001ce20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001ce30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001ce40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001ce50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001ce60: 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a 2320 4420  ==========..# D 
+0001ce70: 3d20 7261 6365 7472 6163 6b5f 6772 6164  = racetrack_grad
+0001ce80: 7561 6c28 7769 6474 6820 3d20 302e 332c  ual(width = 0.3,
+0001ce90: 2052 203d 2035 2c20 4e20 3d20 3329 0a23   R = 5, N = 3).#
+0001cea0: 2071 7569 636b 706c 6f74 2844 290a 0a0a   quickplot(D)...
+0001ceb0: 2320 7420 3d20 6e70 2e6c 696e 7370 6163  # t = np.linspac
+0001cec0: 6528 302c 3129 0a23 2078 2c79 203d 205f  e(0,1).# x,y = _
+0001ced0: 7261 6365 7472 6163 6b5f 6772 6164 7561  racetrack_gradua
+0001cee0: 6c5f 7061 7261 6d65 7472 6963 2874 2c20  l_parametric(t, 
+0001cef0: 5220 3d20 352c 204e 203d 2033 290a 2320  R = 5, N = 3).# 
+0001cf00: 706c 742e 706c 6f74 2878 2c79 290a 2320  plt.plot(x,y).# 
+0001cf10: 706c 742e 6178 6973 2827 6571 7561 6c27  plt.axis('equal'
+0001cf20: 290a 0a0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d  )...# ==========
+0001cf30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001cf40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001cf50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001cf60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001cf70: 3d3d 3d3d 0a23 0a23 2041 7261 6e67 652c  ====.#.# Arange,
+0001cf80: 2070 6163 6b69 6e67 2061 6e64 2066 696c   packing and fil
+0001cf90: 6c0a 230a 2320 3d3d 3d3d 3d3d 3d3d 3d3d  l.#.# ==========
+0001cfa0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001cfb0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001cfc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001cfd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001cfe0: 3d3d 3d3d 0a0a 0a64 6566 2067 7269 6428  ====...def grid(
+0001cff0: 0a20 2020 2064 6576 6963 655f 6c69 7374  .    device_list
+0001d000: 2c0a 2020 2020 7370 6163 696e 673d 2835  ,.    spacing=(5
+0001d010: 2c20 3130 292c 0a20 2020 2073 6570 6172  , 10),.    separ
+0001d020: 6174 696f 6e3d 5472 7565 2c0a 2020 2020  ation=True,.    
+0001d030: 7368 6170 653d 4e6f 6e65 2c0a 2020 2020  shape=None,.    
+0001d040: 616c 6967 6e5f 783d 2278 222c 0a20 2020  align_x="x",.   
+0001d050: 2061 6c69 676e 5f79 3d22 7922 2c0a 2020   align_y="y",.  
+0001d060: 2020 6564 6765 5f78 3d22 7822 2c0a 2020    edge_x="x",.  
+0001d070: 2020 6564 6765 5f79 3d22 796d 6178 222c    edge_y="ymax",
+0001d080: 0a29 3a0a 2020 2020 2222 2250 6c61 6365  .):.    """Place
+0001d090: 7320 7468 6520 6465 7669 6365 7320 696e  s the devices in
+0001d0a0: 2074 6865 2060 6465 7669 6365 5f6c 6973   the `device_lis
+0001d0b0: 7460 2028 3144 206f 7220 3244 2920 6f6e  t` (1D or 2D) on
+0001d0c0: 2061 2067 7269 642e 0a0a 2020 2020 5061   a grid...    Pa
+0001d0d0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+0001d0e0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6465 7669  -------.    devi
+0001d0f0: 6365 5f6c 6973 7420 3a20 6172 7261 792d  ce_list : array-
+0001d100: 6c69 6b65 5b4e 5d20 6f66 2044 6576 6963  like[N] of Devic
+0001d110: 650a 2020 2020 2020 2020 4465 7669 6365  e.        Device
+0001d120: 7320 746f 2062 6520 706c 6163 6564 206f  s to be placed o
+0001d130: 6e74 6f20 6120 6772 6964 2e0a 2020 2020  nto a grid..    
+0001d140: 7370 6163 696e 6720 3a20 696e 742c 2066  spacing : int, f
+0001d150: 6c6f 6174 2c20 6f72 2061 7272 6179 2d6c  loat, or array-l
+0001d160: 696b 655b 325d 206f 6620 696e 7420 6f72  ike[2] of int or
+0001d170: 2066 6c6f 6174 0a20 2020 2020 2020 2053   float.        S
+0001d180: 7061 6369 6e67 2062 6574 7765 656e 2061  pacing between a
+0001d190: 646a 6163 656e 7420 656c 656d 656e 7473  djacent elements
+0001d1a0: 206f 6e20 7468 6520 6772 6964 2c20 6361   on the grid, ca
+0001d1b0: 6e20 6265 2061 2074 7570 6c65 2066 6f72  n be a tuple for
+0001d1c0: 0a20 2020 2020 2020 2064 6966 6665 7265  .        differe
+0001d1d0: 6e74 2064 6973 7461 6e63 6573 2069 6e20  nt distances in 
+0001d1e0: 7769 6474 6820 616e 6420 6865 6967 6874  width and height
+0001d1f0: 2028 782c 7929 2e0a 2020 2020 7365 7061   (x,y)..    sepa
+0001d200: 7261 7469 6f6e 203a 2062 6f6f 6c0a 2020  ration : bool.  
+0001d210: 2020 2020 2020 4966 2054 7275 652c 2067        If True, g
+0001d220: 7561 7261 6e74 6565 7320 656c 656d 656e  uarantees elemen
+0001d230: 7473 2061 7265 2073 7065 7061 7261 7465  ts are speparate
+0001d240: 6420 7769 7468 2061 2066 6978 6564 2073  d with a fixed s
+0001d250: 7061 6369 6e67 0a20 2020 2020 2020 2062  pacing.        b
+0001d260: 6574 7765 656e 3b20 6966 2020 4661 6c73  etween; if  Fals
+0001d270: 652c 2065 6c65 6d65 6e74 7320 6172 6520  e, elements are 
+0001d280: 7370 6163 6564 2065 7665 6e6c 7920 616c  spaced evenly al
+0001d290: 6f6e 6720 6120 6772 6964 2e0a 2020 2020  ong a grid..    
+0001d2a0: 7368 6170 6520 3a20 6172 7261 792d 6c69  shape : array-li
+0001d2b0: 6b65 5b32 5d0a 2020 2020 2020 2020 782c  ke[2].        x,
+0001d2c0: 2079 2073 6861 7065 206f 6620 7468 6520   y shape of the 
+0001d2d0: 6772 6964 2028 6173 2069 6620 6e70 2e72  grid (as if np.r
+0001d2e0: 6573 6861 7065 2829 2077 6572 6520 7275  eshape() were ru
+0001d2f0: 6e20 7769 7468 2073 6861 7065 5b3a 3a2d  n with shape[::-
+0001d300: 315d 292e 2049 6620 6e6f 2073 6861 7065  1]). If no shape
+0001d310: 2069 7320 6769 7665 6e20 616e 6420 7468   is given and th
+0001d320: 650a 2020 2020 2020 2020 6c69 7374 2069  e.        list i
+0001d330: 7320 3144 2c20 7468 6520 6f75 7470 7574  s 1D, the output
+0001d340: 2069 7320 6173 2069 6620 6e70 2e72 6573   is as if np.res
+0001d350: 6861 7065 2077 6572 6520 7275 6e20 7769  hape were run wi
+0001d360: 7468 2028 2d31 2c20 7369 7a65 206f 6620  th (-1, size of 
+0001d370: 6c69 7374 292e 0a20 2020 2061 6c69 676e  list)..    align
+0001d380: 5f78 203a 207b 2778 272c 2027 786d 696e  _x : {'x', 'xmin
+0001d390: 272c 2027 786d 6178 277d 0a20 2020 2020  ', 'xmax'}.     
+0001d3a0: 2020 2057 6869 6368 2065 6467 6520 746f     Which edge to
+0001d3b0: 2070 6572 666f 726d 2074 6865 2078 2028   perform the x (
+0001d3c0: 636f 6c75 6d6e 2920 616c 6967 6e6d 656e  column) alignmen
+0001d3d0: 7420 616c 6f6e 670a 2020 2020 616c 6967  t along.    alig
+0001d3e0: 6e5f 7920 3a20 7b27 7927 2c20 2779 6d69  n_y : {'y', 'ymi
+0001d3f0: 6e27 2c20 2779 6d61 7827 7d0a 2020 2020  n', 'ymax'}.    
+0001d400: 2020 2020 5768 6963 6820 6564 6765 2074      Which edge t
+0001d410: 6f20 7065 7266 6f72 6d20 7468 6520 7920  o perform the y 
+0001d420: 2872 6f77 2920 616c 6967 6e6d 656e 7420  (row) alignment 
+0001d430: 616c 6f6e 670a 2020 2020 6564 6765 5f78  along.    edge_x
+0001d440: 203a 207b 2778 272c 2027 786d 696e 272c   : {'x', 'xmin',
+0001d450: 2027 786d 6178 277d 0a20 2020 2020 2020   'xmax'}.       
+0001d460: 2057 6869 6368 2065 6467 6520 746f 2070   Which edge to p
+0001d470: 6572 666f 726d 2074 6865 2078 2028 636f  erform the x (co
+0001d480: 6c75 6d6e 2920 6469 7374 7269 6275 7469  lumn) distributi
+0001d490: 6f6e 2061 6c6f 6e67 2028 756e 7573 6564  on along (unused
+0001d4a0: 2069 660a 2020 2020 2020 2020 7365 7061   if.        sepa
+0001d4b0: 7261 7469 6f6e 203d 3d20 5472 7565 290a  ration == True).
+0001d4c0: 2020 2020 6564 6765 5f79 203a 207b 2779      edge_y : {'y
+0001d4d0: 272c 2027 796d 696e 272c 2027 796d 6178  ', 'ymin', 'ymax
+0001d4e0: 277d 0a20 2020 2020 2020 2057 6869 6368  '}.        Which
+0001d4f0: 2065 6467 6520 746f 2070 6572 666f 726d   edge to perform
+0001d500: 2074 6865 2079 2028 726f 7729 2064 6973   the y (row) dis
+0001d510: 7472 6962 7574 696f 6e20 616c 6f6e 6720  tribution along 
+0001d520: 2875 6e75 7365 6420 6966 0a20 2020 2020  (unused if.     
+0001d530: 2020 2073 6570 6172 6174 696f 6e20 3d3d     separation ==
+0001d540: 2054 7275 6529 0a0a 2020 2020 5265 7475   True)..    Retu
+0001d550: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+0001d560: 2020 2020 6465 7669 6365 5f6d 6174 7269      device_matri
+0001d570: 7820 3a20 4465 7669 6365 0a20 2020 2020  x : Device.     
+0001d580: 2020 2041 2044 6576 6963 6520 636f 6e74     A Device cont
+0001d590: 6169 6e69 6e67 2061 6c6c 2074 6865 2044  aining all the D
+0001d5a0: 6576 6963 6573 2069 6e20 6064 6576 6963  evices in `devic
+0001d5b0: 655f 6c69 7374 6020 696e 2061 2067 7269  e_list` in a gri
+0001d5c0: 642e 0a20 2020 2022 2222 0a0a 2020 2020  d..    """..    
+0001d5d0: 6465 7669 6365 5f61 7272 6179 203d 206e  device_array = n
+0001d5e0: 702e 6173 6172 7261 7928 6465 7669 6365  p.asarray(device
+0001d5f0: 5f6c 6973 7429 0a20 2020 2073 7061 6369  _list).    spaci
+0001d600: 6e67 203d 206e 702e 6272 6f61 6463 6173  ng = np.broadcas
+0001d610: 745f 746f 2873 7061 6369 6e67 2c20 3229  t_to(spacing, 2)
+0001d620: 0a20 2020 2023 2043 6865 636b 2061 7267  .    # Check arg
+0001d630: 756d 656e 7473 0a20 2020 2069 6620 6465  uments.    if de
+0001d640: 7669 6365 5f61 7272 6179 2e6e 6469 6d20  vice_array.ndim 
+0001d650: 6e6f 7420 696e 2028 312c 2032 293a 0a20  not in (1, 2):. 
+0001d660: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+0001d670: 7565 4572 726f 7228 225b 5048 4944 4c5d  ueError("[PHIDL]
+0001d680: 2067 7269 6428 2920 5468 6520 6465 7669   grid() The devi
+0001d690: 6365 5f6c 6973 7420 6e65 6564 7320 746f  ce_list needs to
+0001d6a0: 2062 6520 3144 206f 7220 3244 2e22 290a   be 1D or 2D.").
+0001d6b0: 2020 2020 6966 2073 6861 7065 2069 7320      if shape is 
+0001d6c0: 6e6f 7420 4e6f 6e65 2061 6e64 206c 656e  not None and len
+0001d6d0: 2873 6861 7065 2920 213d 2032 3a0a 2020  (shape) != 2:.  
+0001d6e0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+0001d6f0: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
+0001d700: 2020 2020 225b 5048 4944 4c5d 2067 7269      "[PHIDL] gri
+0001d710: 6428 2920 7368 6170 6520 6172 6775 6d65  d() shape argume
+0001d720: 6e74 206d 7573 7420 6265 204e 6f6e 6520  nt must be None 
+0001d730: 6f72 220a 2020 2020 2020 2020 2020 2020  or".            
+0001d740: 2b20 2220 6861 7665 2061 206c 656e 6774  + " have a lengt
+0001d750: 6820 6f66 2032 2c20 666f 7220 6578 616d  h of 2, for exam
+0001d760: 706c 6520 7368 6170 653d 2834 2c36 2922  ple shape=(4,6)"
+0001d770: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0001d780: 2320 4368 6563 6b20 7468 6174 2073 6861  # Check that sha
+0001d790: 7065 2069 7320 7661 6c69 6420 616e 6420  pe is valid and 
+0001d7a0: 7265 7368 6170 6520 6172 7261 7920 6966  reshape array if
+0001d7b0: 206e 6565 6465 640a 2020 2020 6966 2028   needed.    if (
+0001d7c0: 7368 6170 6520 6973 204e 6f6e 6529 2061  shape is None) a
+0001d7d0: 6e64 2028 6465 7669 6365 5f61 7272 6179  nd (device_array
+0001d7e0: 2e6e 6469 6d20 3d3d 2032 293a 2020 2320  .ndim == 2):  # 
+0001d7f0: 416c 7265 6164 7920 696e 2064 6573 6972  Already in desir
+0001d800: 6564 2073 6861 7065 0a20 2020 2020 2020  ed shape.       
+0001d810: 2073 6861 7065 203d 2064 6576 6963 655f   shape = device_
+0001d820: 6172 7261 792e 7368 6170 650a 2020 2020  array.shape.    
+0001d830: 656c 6966 2028 7368 6170 6520 6973 204e  elif (shape is N
+0001d840: 6f6e 6529 2061 6e64 2028 6465 7669 6365  one) and (device
+0001d850: 5f61 7272 6179 2e6e 6469 6d20 3d3d 2031  _array.ndim == 1
+0001d860: 293a 0a20 2020 2020 2020 2073 6861 7065  ):.        shape
+0001d870: 203d 2028 2d31 2c20 6465 7669 6365 5f61   = (-1, device_a
+0001d880: 7272 6179 2e73 697a 6529 0a20 2020 2065  rray.size).    e
+0001d890: 6c69 6620 3020 3c20 7368 6170 655b 305d  lif 0 < shape[0]
+0001d8a0: 202a 2073 6861 7065 5b31 5d20 3c20 6465   * shape[1] < de
+0001d8b0: 7669 6365 5f61 7272 6179 2e73 697a 653a  vice_array.size:
+0001d8c0: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
+0001d8d0: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
+0001d8e0: 2020 2020 2020 2022 5b50 4849 444c 5d20         "[PHIDL] 
+0001d8f0: 6772 6964 2829 2054 6865 2073 6861 7065  grid() The shape
+0001d900: 2069 7320 746f 6f20 736d 616c 6c20 666f   is too small fo
+0001d910: 7220 616c 6c20 7468 6520 6974 656d 7320  r all the items 
+0001d920: 696e 2064 6576 6963 655f 6c69 7374 220a  in device_list".
+0001d930: 2020 2020 2020 2020 290a 2020 2020 656c          ).    el
+0001d940: 7365 3a0a 2020 2020 2020 2020 2320 4368  se:.        # Ch
+0001d950: 616e 6765 2028 782c 7929 2073 6861 7065  ange (x,y) shape
+0001d960: 2074 6f20 2879 2c78 2920 7368 6170 6520   to (y,x) shape 
+0001d970: 746f 2066 6f6c 6c6f 7720 6465 6661 756c  to follow defaul
+0001d980: 7420 726f 772c 2063 6f6c 756d 6e20 666f  t row, column fo
+0001d990: 726d 6174 2069 6e20 6e70 2e72 6573 6861  rmat in np.resha
+0001d9a0: 7065 0a20 2020 2020 2020 2073 6861 7065  pe.        shape
+0001d9b0: 203d 2073 6861 7065 5b3a 3a2d 315d 0a0a   = shape[::-1]..
+0001d9c0: 2020 2020 2020 2020 6966 206e 702e 6d69          if np.mi
+0001d9d0: 6e28 7368 6170 6529 203d 3d20 2d31 3a0a  n(shape) == -1:.
+0001d9e0: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
+0001d9f0: 7368 6170 6520 3d20 6e70 2e6d 6178 2873  shape = np.max(s
+0001da00: 6861 7065 290a 2020 2020 2020 2020 2020  hape).          
+0001da10: 2020 6d69 6e5f 6465 7669 6365 7320 3d20    min_devices = 
+0001da20: 696e 7428 6e70 2e63 6569 6c28 6465 7669  int(np.ceil(devi
+0001da30: 6365 5f61 7272 6179 2e73 697a 6520 2f20  ce_array.size / 
+0001da40: 6d61 785f 7368 6170 6529 202a 206d 6178  max_shape) * max
+0001da50: 5f73 6861 7065 290a 2020 2020 2020 2020  _shape).        
+0001da60: 2020 2020 6578 7472 615f 6465 7669 6365      extra_device
+0001da70: 7320 3d20 6d69 6e5f 6465 7669 6365 7320  s = min_devices 
+0001da80: 2d20 6465 7669 6365 5f61 7272 6179 2e73  - device_array.s
+0001da90: 697a 650a 2020 2020 2020 2020 656c 7365  ize.        else
+0001daa0: 3a0a 2020 2020 2020 2020 2020 2020 6578  :.            ex
+0001dab0: 7472 615f 6465 7669 6365 7320 3d20 7368  tra_devices = sh
+0001dac0: 6170 655b 305d 202a 2073 6861 7065 5b31  ape[0] * shape[1
+0001dad0: 5d20 2d20 6465 7669 6365 5f61 7272 6179  ] - device_array
+0001dae0: 2e73 697a 650a 2020 2020 2020 2020 6966  .size.        if
+0001daf0: 2065 7874 7261 5f64 6576 6963 6573 2021   extra_devices !
+0001db00: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+0001db10: 2064 6576 6963 655f 6172 7261 7920 3d20   device_array = 
+0001db20: 6e70 2e61 7070 656e 6428 0a20 2020 2020  np.append(.     
+0001db30: 2020 2020 2020 2020 2020 2064 6576 6963             devic
+0001db40: 655f 6172 7261 792c 0a20 2020 2020 2020  e_array,.       
+0001db50: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
+0001db60: 2020 2020 2020 2020 2020 2020 2020 204e                 N
+0001db70: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0001db80: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
+0001db90: 2020 2020 2020 202a 2065 7874 7261 5f64         * extra_d
+0001dba0: 6576 6963 6573 2c0a 2020 2020 2020 2020  evices,.        
+0001dbb0: 2020 2020 290a 2020 2020 6465 7669 6365      ).    device
+0001dbc0: 5f61 7272 6179 203d 206e 702e 7265 7368  _array = np.resh
+0001dbd0: 6170 6528 6465 7669 6365 5f61 7272 6179  ape(device_array
+0001dbe0: 2c20 7368 6170 6529 0a0a 2020 2020 2320  , shape)..    # 
+0001dbf0: 4372 6561 7465 2061 2062 6c61 6e6b 2044  Create a blank D
+0001dc00: 6576 6963 6520 616e 6420 7265 6665 7265  evice and refere
+0001dc10: 6e63 6520 616c 6c20 7468 6520 4465 7669  nce all the Devi
+0001dc20: 6365 7320 696e 2069 740a 2020 2020 4420  ces in it.    D 
+0001dc30: 3d20 4465 7669 6365 2822 6772 6964 2229  = Device("grid")
+0001dc40: 0a20 2020 2072 6566 5f61 7272 6179 203d  .    ref_array =
+0001dc50: 206e 702e 656d 7074 7928 6465 7669 6365   np.empty(device
+0001dc60: 5f61 7272 6179 2e73 6861 7065 2c20 6474  _array.shape, dt
+0001dc70: 7970 653d 6f62 6a65 6374 290a 2020 2020  ype=object).    
+0001dc80: 6475 6d6d 7920 3d20 4465 7669 6365 2829  dummy = Device()
+0001dc90: 0a20 2020 2066 6f72 2069 6478 2c20 6420  .    for idx, d 
+0001dca0: 696e 206e 702e 6e64 656e 756d 6572 6174  in np.ndenumerat
+0001dcb0: 6528 6465 7669 6365 5f61 7272 6179 293a  e(device_array):
+0001dcc0: 0a20 2020 2020 2020 2069 6620 6420 6973  .        if d is
+0001dcd0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0001dce0: 2020 2020 2020 2072 6566 5f61 7272 6179         ref_array
+0001dcf0: 5b69 6478 5d20 3d20 4420 3c3c 2064 0a20  [idx] = D << d. 
+0001dd00: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001dd10: 2020 2020 2020 2020 2072 6566 5f61 7272           ref_arr
+0001dd20: 6179 5b69 6478 5d20 3d20 4420 3c3c 2064  ay[idx] = D << d
+0001dd30: 756d 6d79 2020 2320 4372 6561 7465 2064  ummy  # Create d
+0001dd40: 756d 6d79 2064 6576 6963 6573 0a0a 2020  ummy devices..  
+0001dd50: 2020 726f 7773 203d 205b 4772 6f75 7028    rows = [Group(
+0001dd60: 7265 665f 6172 7261 795b 6e2c 203a 5d29  ref_array[n, :])
+0001dd70: 2066 6f72 206e 2069 6e20 7261 6e67 6528   for n in range(
+0001dd80: 7265 665f 6172 7261 792e 7368 6170 655b  ref_array.shape[
+0001dd90: 305d 295d 0a20 2020 2063 6f6c 7320 3d20  0])].    cols = 
+0001dda0: 5b47 726f 7570 2872 6566 5f61 7272 6179  [Group(ref_array
+0001ddb0: 5b3a 2c20 6e5d 2920 666f 7220 6e20 696e  [:, n]) for n in
+0001ddc0: 2072 616e 6765 2872 6566 5f61 7272 6179   range(ref_array
+0001ddd0: 2e73 6861 7065 5b31 5d29 5d0a 0a20 2020  .shape[1])]..   
+0001dde0: 2023 2041 6c69 676e 2072 6f77 7320 616e   # Align rows an
+0001ddf0: 6420 636f 6c75 6d6e 7320 696e 6465 7065  d columns indepe
+0001de00: 6e64 656e 746c 790a 2020 2020 666f 7220  ndently.    for 
+0001de10: 6e2c 2072 2069 6e20 656e 756d 6572 6174  n, r in enumerat
+0001de20: 6528 726f 7773 293a 0a20 2020 2020 2020  e(rows):.       
+0001de30: 2072 2e61 6c69 676e 2861 6c69 676e 6d65   r.align(alignme
+0001de40: 6e74 3d61 6c69 676e 5f79 290a 2020 2020  nt=align_y).    
+0001de50: 666f 7220 6e2c 2063 2069 6e20 656e 756d  for n, c in enum
+0001de60: 6572 6174 6528 636f 6c73 293a 0a20 2020  erate(cols):.   
+0001de70: 2020 2020 2063 2e61 6c69 676e 2861 6c69       c.align(ali
+0001de80: 676e 6d65 6e74 3d61 6c69 676e 5f78 290a  gnment=align_x).
+0001de90: 0a20 2020 2023 2044 6973 7472 6962 7574  .    # Distribut
+0001dea0: 6520 726f 7773 2061 6e64 2063 6f6c 756d  e rows and colum
+0001deb0: 6e73 0a20 2020 2047 726f 7570 2863 6f6c  ns.    Group(col
+0001dec0: 7329 2e64 6973 7472 6962 7574 6528 0a20  s).distribute(. 
+0001ded0: 2020 2020 2020 2064 6972 6563 7469 6f6e         direction
+0001dee0: 3d22 7822 2c20 7370 6163 696e 673d 7370  ="x", spacing=sp
+0001def0: 6163 696e 675b 305d 2c20 7365 7061 7261  acing[0], separa
+0001df00: 7469 6f6e 3d73 6570 6172 6174 696f 6e2c  tion=separation,
+0001df10: 2065 6467 653d 6564 6765 5f78 0a20 2020   edge=edge_x.   
+0001df20: 2029 0a20 2020 2047 726f 7570 2872 6f77   ).    Group(row
+0001df30: 735b 3a3a 2d31 5d29 2e64 6973 7472 6962  s[::-1]).distrib
+0001df40: 7574 6528 0a20 2020 2020 2020 2064 6972  ute(.        dir
+0001df50: 6563 7469 6f6e 3d22 7922 2c20 7370 6163  ection="y", spac
+0001df60: 696e 673d 7370 6163 696e 675b 315d 2c20  ing=spacing[1], 
+0001df70: 7365 7061 7261 7469 6f6e 3d73 6570 6172  separation=separ
+0001df80: 6174 696f 6e2c 2065 6467 653d 6564 6765  ation, edge=edge
+0001df90: 5f79 0a20 2020 2029 0a0a 2020 2020 2320  _y.    )..    # 
+0001dfa0: 7265 7475 726e 2064 6576 6963 655f 6d61  return device_ma
+0001dfb0: 7472 6978 0a20 2020 2072 6574 7572 6e20  trix.    return 
+0001dfc0: 440a 0a0a 6465 6620 5f70 6172 616d 6574  D...def _paramet
+0001dfd0: 6572 5f63 6f6d 6269 6e61 7469 6f6e 7328  er_combinations(
+0001dfe0: 7061 7261 6d65 7465 7273 5f64 6963 7429  parameters_dict)
+0001dff0: 3a0a 2020 2020 2222 2243 7265 6174 6573  :.    """Creates
+0001e000: 2070 6172 616d 6574 6572 2063 6f6d 6269   parameter combi
+0001e010: 6e61 7469 6f6e 7320 6672 6f6d 2061 2064  nations from a d
+0001e020: 6963 7420 6669 6c6c 6564 2077 6974 6820  ict filled with 
+0001e030: 6c69 7374 2076 616c 7565 732c 2065 2e67  list values, e.g
+0001e040: 2e0a 2020 2020 7061 7261 6d65 7465 7273  ..    parameters
+0001e050: 5f64 6963 7420 3d20 7b0a 2020 2020 2020  _dict = {.      
+0001e060: 2020 2777 6964 7468 2720 3a20 5b30 2e31    'width' : [0.1
+0001e070: 2c30 2e32 5d2c 0a20 2020 2020 2020 2027  ,0.2],.        '
+0001e080: 6c65 6e67 7468 2720 3a20 5b34 2c35 2c36  length' : [4,5,6
+0001e090: 5d2c 0a20 2020 2020 2020 2027 6865 6967  ],.        'heig
+0001e0a0: 6874 2720 3a20 5b32 325d 0a20 2020 2020  ht' : [22].     
+0001e0b0: 2020 207d 0a20 2020 2057 696c 6c20 7072     }.    Will pr
+0001e0c0: 6f64 7563 6520 6120 6c69 7374 206f 6620  oduce a list of 
+0001e0d0: 6469 6374 696f 6e61 7269 6573 2c20 6561  dictionaries, ea
+0001e0e0: 6368 206f 6620 7768 6963 6820 6361 6e20  ch of which can 
+0001e0f0: 6265 2075 7365 6420 6173 206b 7761 7267  be used as kwarg
+0001e100: 7320 696e 7075 743a 0a20 2020 2020 2020  s input:.       
+0001e110: 205b 7b27 6865 6967 6874 273a 2032 322c   [{'height': 22,
+0001e120: 2027 6c65 6e67 7468 273a 2034 2c20 2777   'length': 4, 'w
+0001e130: 6964 7468 273a 2030 2e31 7d2c 0a20 2020  idth': 0.1},.   
+0001e140: 2020 2020 2020 7b27 6865 6967 6874 273a        {'height':
+0001e150: 2032 322c 2027 6c65 6e67 7468 273a 2035   22, 'length': 5
+0001e160: 2c20 2777 6964 7468 273a 2030 2e31 7d2c  , 'width': 0.1},
+0001e170: 0a20 2020 2020 2020 2020 7b27 6865 6967  .         {'heig
+0001e180: 6874 273a 2032 322c 2027 6c65 6e67 7468  ht': 22, 'length
+0001e190: 273a 2036 2c20 2777 6964 7468 273a 2030  ': 6, 'width': 0
+0001e1a0: 2e31 7d2c 0a20 2020 2020 2020 2020 7b27  .1},.         {'
+0001e1b0: 6865 6967 6874 273a 2032 322c 2027 6c65  height': 22, 'le
+0001e1c0: 6e67 7468 273a 2034 2c20 2777 6964 7468  ngth': 4, 'width
+0001e1d0: 273a 2030 2e32 7d2c 0a20 2020 2020 2020  ': 0.2},.       
+0001e1e0: 2020 7b27 6865 6967 6874 273a 2032 322c    {'height': 22,
+0001e1f0: 2027 6c65 6e67 7468 273a 2035 2c20 2777   'length': 5, 'w
+0001e200: 6964 7468 273a 2030 2e32 7d2c 0a20 2020  idth': 0.2},.   
+0001e210: 2020 2020 2020 7b27 6865 6967 6874 273a        {'height':
+0001e220: 2032 322c 2027 6c65 6e67 7468 273a 2036   22, 'length': 6
+0001e230: 2c20 2777 6964 7468 273a 2030 2e32 7d5d  , 'width': 0.2}]
+0001e240: 2222 220a 2020 2020 7661 6c75 655f 636f  """.    value_co
+0001e250: 6d62 696e 6174 696f 6e73 203d 206c 6973  mbinations = lis
+0001e260: 7428 6974 6572 746f 6f6c 732e 7072 6f64  t(itertools.prod
+0001e270: 7563 7428 2a70 6172 616d 6574 6572 735f  uct(*parameters_
+0001e280: 6469 6374 2e76 616c 7565 7328 2929 290a  dict.values())).
+0001e290: 2020 2020 6b65 7973 203d 206c 6973 7428      keys = list(
+0001e2a0: 7061 7261 6d65 7465 7273 5f64 6963 742e  parameters_dict.
+0001e2b0: 6b65 7973 2829 290a 2020 2020 7265 7475  keys()).    retu
+0001e2c0: 726e 205b 0a20 2020 2020 2020 207b 6b65  rn [.        {ke
+0001e2d0: 7973 5b6e 5d3a 2076 616c 7565 735b 6e5d  ys[n]: values[n]
+0001e2e0: 2066 6f72 206e 2069 6e20 7261 6e67 6528   for n in range(
+0001e2f0: 6c65 6e28 6b65 7973 2929 7d20 666f 7220  len(keys))} for 
+0001e300: 7661 6c75 6573 2069 6e20 7661 6c75 655f  values in value_
+0001e310: 636f 6d62 696e 6174 696f 6e73 0a20 2020  combinations.   
+0001e320: 205d 0a0a 0a64 6566 205f 6765 6e5f 7061   ]...def _gen_pa
+0001e330: 7261 6d5f 7661 7269 6174 696f 6e73 280a  ram_variations(.
+0001e340: 2020 2020 6675 6e63 7469 6f6e 2c20 7061      function, pa
+0001e350: 7261 6d5f 7661 7269 6174 696f 6e73 2c20  ram_variations, 
+0001e360: 7061 7261 6d5f 6465 6661 756c 7473 3d7b  param_defaults={
+0001e370: 7d2c 2070 6172 616d 5f6f 7665 7272 6964  }, param_overrid
+0001e380: 653d 7b7d 2c20 6c61 6265 6c5f 6c61 7965  e={}, label_laye
+0001e390: 723d 3235 350a 293a 0a20 2020 2022 2222  r=255.):.    """
+0001e3a0: 5461 6b65 7320 652e 672e 0a0a 2020 2020  Takes e.g...    
+0001e3b0: 7061 7261 6d5f 7661 7269 6174 696f 6e73  param_variations
+0001e3c0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+0001e3d0: 2027 6368 616e 6e65 6c5f 7769 6474 6827   'channel_width'
+0001e3e0: 203a 205b 312c 322c 335d 0a20 2020 2020   : [1,2,3].     
+0001e3f0: 2020 2020 2020 2027 6761 7465 5f77 6964         'gate_wid
+0001e400: 7468 2720 3a20 5b30 2e31 2c30 2e32 2c30  th' : [0.1,0.2,0
+0001e410: 2e34 5d2c 0a20 2020 2020 2020 2020 2020  .4],.           
+0001e420: 207d 0a20 2020 2020 2020 6f72 2065 7175   }.       or equ
+0001e430: 6976 616c 656e 746c 790a 2020 2020 7061  ivalently.    pa
+0001e440: 7261 6d5f 7661 7269 6174 696f 6e73 203d  ram_variations =
+0001e450: 2064 6963 7428 0a20 2020 2020 2020 2020   dict(.         
+0001e460: 2020 2063 6861 6e6e 656c 5f77 6964 7468     channel_width
+0001e470: 203d 205b 312c 322c 335d 2c0a 2020 2020   = [1,2,3],.    
+0001e480: 2020 2020 2020 2020 6761 7465 5f77 6964          gate_wid
+0001e490: 7468 203d 205b 302e 312c 302e 322c 302e  th = [0.1,0.2,0.
+0001e4a0: 345d 2c0a 2020 2020 2020 2020 2020 2020  4],.            
+0001e4b0: 290a 2020 2020 2222 220a 2020 2020 7061  ).    """.    pa
+0001e4c0: 7261 6d65 7465 725f 6c69 7374 203d 205f  rameter_list = _
+0001e4d0: 7061 7261 6d65 7465 725f 636f 6d62 696e  parameter_combin
+0001e4e0: 6174 696f 6e73 2870 6172 616d 5f76 6172  ations(param_var
+0001e4f0: 6961 7469 6f6e 7329 0a0a 2020 2020 2320  iations)..    # 
+0001e500: 506f 7020 6f75 7420 616e 7920 4e6f 6e65  Pop out any None
+0001e510: 2076 616c 7565 730a 2020 2020 5b70 6172   values.    [par
+0001e520: 616d 732e 706f 7028 284e 6f6e 652c 2022  ams.pop((None, "
+0001e530: 7822 292c 204e 6f6e 6529 2066 6f72 2070  x"), None) for p
+0001e540: 6172 616d 7320 696e 2070 6172 616d 6574  arams in paramet
+0001e550: 6572 5f6c 6973 745d 0a20 2020 205b 7061  er_list].    [pa
+0001e560: 7261 6d73 2e70 6f70 2828 4e6f 6e65 2c20  rams.pop((None, 
+0001e570: 2279 2229 2c20 4e6f 6e65 2920 666f 7220  "y"), None) for 
+0001e580: 7061 7261 6d73 2069 6e20 7061 7261 6d65  params in parame
+0001e590: 7465 725f 6c69 7374 5d0a 0a20 2020 2044  ter_list]..    D
+0001e5a0: 5f6c 6973 7420 3d20 5b5d 0a20 2020 2066  _list = [].    f
+0001e5b0: 6f72 2070 6172 616d 7320 696e 2070 6172  or params in par
+0001e5c0: 616d 6574 6572 5f6c 6973 743a 0a20 2020  ameter_list:.   
+0001e5d0: 2020 2020 206e 6577 5f70 6172 616d 7320       new_params 
+0001e5e0: 3d20 6469 6374 2829 0a20 2020 2020 2020  = dict().       
+0001e5f0: 206e 6577 5f70 6172 616d 732e 7570 6461   new_params.upda
+0001e600: 7465 2870 6172 616d 7329 0a20 2020 2020  te(params).     
+0001e610: 2020 206e 6577 5f70 6172 616d 732e 7570     new_params.up
+0001e620: 6461 7465 2870 6172 616d 5f6f 7665 7272  date(param_overr
+0001e630: 6964 6529 0a20 2020 2020 2020 2044 5f6e  ide).        D_n
+0001e640: 6577 203d 206d 616b 655f 6465 7669 6365  ew = make_device
+0001e650: 2866 756e 6374 696f 6e2c 2063 6f6e 6669  (function, confi
+0001e660: 673d 7061 7261 6d5f 6465 6661 756c 7473  g=param_defaults
+0001e670: 2c20 2a2a 6e65 775f 7061 7261 6d73 290a  , **new_params).
+0001e680: 2020 2020 2020 2020 6c61 6265 6c5f 7465          label_te
+0001e690: 7874 203d 2022 220a 2020 2020 2020 2020  xt = "".        
+0001e6a0: 666f 7220 6e61 6d65 2c20 7661 6c75 6520  for name, value 
+0001e6b0: 696e 2070 6172 616d 732e 6974 656d 7328  in params.items(
+0001e6c0: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
+0001e6d0: 6162 656c 5f74 6578 7420 2b3d 2028 6622  abel_text += (f"
+0001e6e0: 7b6e 616d 657d 3d7b 7661 6c75 657d 2229  {name}={value}")
+0001e6f0: 202b 2022 5c6e 220a 2020 2020 2020 2020   + "\n".        
+0001e700: 6966 206c 6162 656c 5f6c 6179 6572 2069  if label_layer i
+0001e710: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0001e720: 2020 2020 2020 2020 445f 6e65 772e 6164          D_new.ad
+0001e730: 645f 6c61 6265 6c28 7465 7874 3d6c 6162  d_label(text=lab
+0001e740: 656c 5f74 6578 742c 2070 6f73 6974 696f  el_text, positio
+0001e750: 6e3d 445f 6e65 772e 6365 6e74 6572 2c20  n=D_new.center, 
+0001e760: 6c61 7965 723d 6c61 6265 6c5f 6c61 7965  layer=label_laye
+0001e770: 7229 0a0a 2020 2020 2020 2020 445f 6c69  r)..        D_li
+0001e780: 7374 2e61 7070 656e 6428 445f 6e65 7729  st.append(D_new)
+0001e790: 0a20 2020 2072 6574 7572 6e20 445f 6c69  .    return D_li
+0001e7a0: 7374 0a0a 0a64 6566 2067 7269 6473 7765  st...def gridswe
+0001e7b0: 6570 280a 2020 2020 6675 6e63 7469 6f6e  ep(.    function
+0001e7c0: 2c0a 2020 2020 7061 7261 6d5f 783d 7b22  ,.    param_x={"
+0001e7d0: 7769 6474 6822 3a20 5b31 2c20 352c 2036  width": [1, 5, 6
+0001e7e0: 2c20 375d 7d2c 0a20 2020 2070 6172 616d  , 7]},.    param
+0001e7f0: 5f79 3d7b 226c 656e 6774 6822 3a20 5b31  _y={"length": [1
+0001e800: 2e31 2c20 322c 2037 305d 7d2c 0a20 2020  .1, 2, 70]},.   
+0001e810: 2070 6172 616d 5f64 6566 6175 6c74 733d   param_defaults=
+0001e820: 7b7d 2c0a 2020 2020 7061 7261 6d5f 6f76  {},.    param_ov
+0001e830: 6572 7269 6465 3d7b 7d2c 0a20 2020 2073  erride={},.    s
+0001e840: 7061 6369 6e67 3d28 3530 2c20 3130 3029  pacing=(50, 100)
+0001e850: 2c0a 2020 2020 7365 7061 7261 7469 6f6e  ,.    separation
+0001e860: 3d54 7275 652c 0a20 2020 2061 6c69 676e  =True,.    align
+0001e870: 5f78 3d22 7822 2c0a 2020 2020 616c 6967  _x="x",.    alig
+0001e880: 6e5f 793d 2279 222c 0a20 2020 2065 6467  n_y="y",.    edg
+0001e890: 655f 783d 2278 222c 0a20 2020 2065 6467  e_x="x",.    edg
+0001e8a0: 655f 793d 2279 6d69 6e22 2c0a 2020 2020  e_y="ymin",.    
+0001e8b0: 6c61 6265 6c5f 6c61 7965 723d 3235 352c  label_layer=255,
+0001e8c0: 0a29 3a0a 2020 2020 2222 2243 7265 6174  .):.    """Creat
+0001e8d0: 6573 2061 2070 6172 616d 6574 6572 2073  es a parameter s
+0001e8e0: 7765 6570 206f 6620 6465 7669 6365 7320  weep of devices 
+0001e8f0: 616e 6420 706c 6163 6573 2074 6865 6d20  and places them 
+0001e900: 6f6e 2061 2067 7269 6420 7769 7468 0a20  on a grid with. 
+0001e910: 2020 206c 6162 656c 7320 666f 7220 6561     labels for ea
+0001e920: 6368 2064 6576 6963 652e 2046 6f72 2069  ch device. For i
+0001e930: 6e73 7461 6e63 652c 2067 6976 656e 2061  nstance, given a
+0001e940: 2066 756e 6374 696f 6e20 6465 6669 6e65   function define
+0001e950: 6420 6c69 6b65 0a20 2020 2060 6d79 7368  d like.    `mysh
+0001e960: 6170 6528 7769 6474 682c 2068 6569 6768  ape(width, heigh
+0001e970: 742c 206f 6666 7365 742c 206c 6179 6572  t, offset, layer
+0001e980: 2960 2061 6e64 2074 6865 2066 6f6c 6c6f  )` and the follo
+0001e990: 7769 6e67 2070 6172 616d 6574 6572 733a  wing parameters:
+0001e9a0: 0a20 2020 2020 2020 2070 6172 616d 5f78  .        param_x
+0001e9b0: 203d 207b 2777 6964 7468 2720 3a20 205b   = {'width' :  [
+0001e9c0: 342c 2035 2c20 365d 2020 7d2c 0a20 2020  4, 5, 6]  },.   
+0001e9d0: 2020 2020 2070 6172 616d 5f79 203d 207b       param_y = {
+0001e9e0: 2768 6569 6768 7427 203a 205b 372c 2039  'height' : [7, 9
+0001e9f0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0001ea00: 2020 2020 2020 276c 6179 6572 2720 3a20        'layer' : 
+0001ea10: 205b 312c 2032 2c20 335d 2020 7d2c 0a20   [1, 2, 3]  },. 
+0001ea20: 2020 2020 2020 2070 6172 616d 5f64 6566         param_def
+0001ea30: 6175 6c74 7320 3d20 7b27 7363 616c 6527  aults = {'scale'
+0001ea40: 203a 2031 7d0a 0a20 2020 2067 7269 6473   : 1}..    grids
+0001ea50: 7765 6570 2829 2070 726f 6475 6365 2061  weep() produce a
+0001ea60: 2067 7269 6420 6f66 2064 6576 6963 6573   grid of devices
+0001ea70: 2077 6974 6820 7468 6520 666f 6c6c 6f77   with the follow
+0001ea80: 696e 6720 6c61 796f 7574 2f70 6172 616d  ing layout/param
+0001ea90: 6574 6572 733a 0a20 2020 2020 2020 2028  eters:.        (
+0001eaa0: 773d 342c 2068 3d37 2c20 733d 312c 206c  w=4, h=7, s=1, l
+0001eab0: 3d31 2920 2020 2028 773d 352c 2068 3d37  =1)    (w=5, h=7
+0001eac0: 2c20 733d 312c 206c 3d31 2920 2020 2028  , s=1, l=1)    (
+0001ead0: 773d 362c 2068 3d37 2c20 733d 312c 206c  w=6, h=7, s=1, l
+0001eae0: 3d31 290a 2020 2020 2020 2020 2877 3d34  =1).        (w=4
+0001eaf0: 2c20 683d 372c 2073 3d31 2c20 6c3d 3229  , h=7, s=1, l=2)
+0001eb00: 2020 2020 2877 3d35 2c20 683d 372c 2073      (w=5, h=7, s
+0001eb10: 3d31 2c20 6c3d 3229 2020 2020 2877 3d36  =1, l=2)    (w=6
+0001eb20: 2c20 683d 372c 2073 3d31 2c20 6c3d 3229  , h=7, s=1, l=2)
+0001eb30: 0a20 2020 2020 2020 2028 773d 342c 2068  .        (w=4, h
+0001eb40: 3d37 2c20 733d 312c 206c 3d33 2920 2020  =7, s=1, l=3)   
+0001eb50: 2028 773d 352c 2068 3d37 2c20 733d 312c   (w=5, h=7, s=1,
+0001eb60: 206c 3d33 2920 2020 2028 773d 362c 2068   l=3)    (w=6, h
+0001eb70: 3d37 2c20 733d 312c 206c 3d33 290a 2020  =7, s=1, l=3).  
+0001eb80: 2020 2020 2020 2877 3d34 2c20 683d 392c        (w=4, h=9,
+0001eb90: 2073 3d31 2c20 6c3d 3129 2020 2020 2877   s=1, l=1)    (w
+0001eba0: 3d35 2c20 683d 392c 2073 3d31 2c20 6c3d  =5, h=9, s=1, l=
+0001ebb0: 3129 2020 2020 2877 3d36 2c20 683d 392c  1)    (w=6, h=9,
+0001ebc0: 2073 3d31 2c20 6c3d 3129 0a20 2020 2020   s=1, l=1).     
+0001ebd0: 2020 2028 773d 342c 2068 3d39 2c20 733d     (w=4, h=9, s=
+0001ebe0: 312c 206c 3d32 2920 2020 2028 773d 352c  1, l=2)    (w=5,
+0001ebf0: 2068 3d39 2c20 733d 312c 206c 3d32 2920   h=9, s=1, l=2) 
+0001ec00: 2020 2028 773d 362c 2068 3d39 2c20 733d     (w=6, h=9, s=
+0001ec10: 312c 206c 3d32 290a 2020 2020 2020 2020  1, l=2).        
+0001ec20: 2877 3d34 2c20 683d 392c 2073 3d31 2c20  (w=4, h=9, s=1, 
+0001ec30: 6c3d 3329 2020 2020 2877 3d35 2c20 683d  l=3)    (w=5, h=
+0001ec40: 392c 2073 3d31 2c20 6c3d 3329 2020 2020  9, s=1, l=3)    
+0001ec50: 2877 3d36 2c20 683d 392c 2073 3d31 2c20  (w=6, h=9, s=1, 
+0001ec60: 6c3d 3329 0a0a 0a20 2020 2050 6172 616d  l=3)...    Param
+0001ec70: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
+0001ec80: 2d2d 2d2d 0a20 2020 2066 756e 6374 696f  ----.    functio
+0001ec90: 6e20 3a20 6675 6e63 7469 6f6e 2074 6861  n : function tha
+0001eca0: 7420 7072 6f64 7563 6573 2061 2044 6576  t produces a Dev
+0001ecb0: 6963 650a 2020 2020 2020 2020 5468 6520  ice.        The 
+0001ecc0: 6675 6e63 7469 6f6e 2077 6869 6368 2077  function which w
+0001ecd0: 696c 6c20 6265 2075 7365 6420 746f 2063  ill be used to c
+0001ece0: 7265 6174 6520 7468 6520 696e 6469 7669  reate the indivi
+0001ecf0: 6475 616c 2064 6576 6963 6573 2069 6e20  dual devices in 
+0001ed00: 7468 650a 2020 2020 2020 2020 6772 6964  the.        grid
+0001ed10: 2e20 204d 7573 7420 6f6e 6c79 2072 6574  .  Must only ret
+0001ed20: 7572 6e20 6120 7369 6e67 6c65 2044 6576  urn a single Dev
+0001ed30: 6963 6520 2865 2e67 2e20 616e 7920 6f66  ice (e.g. any of
+0001ed40: 2074 6865 2066 756e 6374 696f 6e73 2069   the functions i
+0001ed50: 6e0a 2020 2020 2020 2020 7067 2e67 656f  n.        pg.geo
+0001ed60: 6d65 7472 7929 0a20 2020 2070 6172 616d  metry).    param
+0001ed70: 5f78 203a 2064 6963 742c 2069 6e74 2c20  _x : dict, int, 
+0001ed80: 4e6f 6e65 0a20 2020 2020 2020 2041 2064  None.        A d
+0001ed90: 6963 7469 6f6e 6172 7920 6f66 206f 6e65  ictionary of one
+0001eda0: 206f 7220 6d6f 7265 2070 6172 616d 6574   or more paramet
+0001edb0: 6572 7320 746f 2073 7765 6570 2069 6e20  ers to sweep in 
+0001edc0: 7468 6520 782d 6469 7265 6374 696f 6e2e  the x-direction.
+0001edd0: 0a20 2020 2020 2020 2049 6620 4e6f 6e65  .        If None
+0001ede0: 2c20 646f 206e 6f74 2073 7765 6570 2e20  , do not sweep. 
+0001edf0: 4966 2069 6e74 2c20 7265 7065 6174 204e  If int, repeat N
+0001ee00: 2074 696d 6573 2069 6e20 782d 6469 7265   times in x-dire
+0001ee10: 6374 696f 6e0a 2020 2020 7061 7261 6d5f  ction.    param_
+0001ee20: 7920 3a20 6469 6374 2c20 696e 742c 204e  y : dict, int, N
+0001ee30: 6f6e 650a 2020 2020 2020 2020 4120 6469  one.        A di
+0001ee40: 6374 696f 6e61 7279 206f 6620 6f6e 6520  ctionary of one 
+0001ee50: 6f72 206d 6f72 6520 7061 7261 6d65 7465  or more paramete
+0001ee60: 7273 2074 6f20 7377 6565 7020 696e 2074  rs to sweep in t
+0001ee70: 6865 2079 2d64 6972 6563 7469 6f6e 2e0a  he y-direction..
+0001ee80: 2020 2020 2020 2020 4966 204e 6f6e 652c          If None,
+0001ee90: 2064 6f20 6e6f 7420 7377 6565 702e 2049   do not sweep. I
+0001eea0: 6620 696e 742c 2072 6570 6561 7420 4e20  f int, repeat N 
+0001eeb0: 7469 6d65 7320 696e 2079 2d64 6972 6563  times in y-direc
+0001eec0: 7469 6f6e 0a20 2020 2070 6172 616d 5f64  tion.    param_d
+0001eed0: 6566 6175 6c74 7320 3a20 6469 6374 0a20  efaults : dict. 
+0001eee0: 2020 2020 2020 2044 6566 6175 6c74 2070         Default p
+0001eef0: 6172 616d 6574 6572 7320 746f 2070 6173  arameters to pas
+0001ef00: 7320 746f 2065 7665 7279 2064 6576 6963  s to every devic
+0001ef10: 6520 696e 2074 6865 2067 7269 640a 2020  e in the grid.  
+0001ef20: 2020 7061 7261 6d5f 6f76 6572 7269 6465    param_override
+0001ef30: 203a 2064 6963 740a 2020 2020 2020 2020   : dict.        
+0001ef40: 5061 7261 6d65 7465 7273 2074 6861 7420  Parameters that 
+0001ef50: 7769 6c6c 206f 7665 7272 6964 6520 6070  will override `p
+0001ef60: 6172 616d 5f64 6566 6175 6c74 7360 2c20  aram_defaults`, 
+0001ef70: 6571 7569 7661 6c65 6e74 2074 6f20 6368  equivalent to ch
+0001ef80: 616e 6769 6e67 0a20 2020 2020 2020 2070  anging.        p
+0001ef90: 6172 616d 5f64 6566 6175 6c74 7320 2875  aram_defaults (u
+0001efa0: 7365 6675 6c20 290a 2020 2020 7370 6163  seful ).    spac
+0001efb0: 696e 6720 3a20 696e 742c 2066 6c6f 6174  ing : int, float
+0001efc0: 2c20 6f72 2061 7272 6179 2d6c 696b 655b  , or array-like[
+0001efd0: 325d 206f 6620 696e 7420 6f72 2066 6c6f  2] of int or flo
+0001efe0: 6174 0a20 2020 2020 2020 2053 7061 6369  at.        Spaci
+0001eff0: 6e67 2062 6574 7765 656e 2061 646a 6163  ng between adjac
+0001f000: 656e 7420 656c 656d 656e 7473 206f 6e20  ent elements on 
+0001f010: 7468 6520 6772 6964 2c20 6361 6e20 6265  the grid, can be
+0001f020: 2061 2074 7570 6c65 2066 6f72 0a20 2020   a tuple for.   
+0001f030: 2020 2020 2064 6966 6665 7265 6e74 2064       different d
+0001f040: 6973 7461 6e63 6573 2069 6e20 7769 6474  istances in widt
+0001f050: 6820 616e 6420 6865 6967 6874 2028 782c  h and height (x,
+0001f060: 7929 2e0a 2020 2020 7365 7061 7261 7469  y)..    separati
+0001f070: 6f6e 203a 2062 6f6f 6c0a 2020 2020 2020  on : bool.      
+0001f080: 2020 4966 2054 7275 652c 2067 7561 7261    If True, guara
+0001f090: 6e74 6565 7320 656c 656d 656e 7473 2061  ntees elements a
+0001f0a0: 7265 2073 6570 6172 6174 6564 2077 6974  re separated wit
+0001f0b0: 6820 6120 6669 7865 6420 7370 6163 696e  h a fixed spacin
+0001f0c0: 670a 2020 2020 2020 2020 6265 7477 6565  g.        betwee
+0001f0d0: 6e3b 2069 6620 4661 6c73 652c 2065 6c65  n; if False, ele
+0001f0e0: 6d65 6e74 7320 6172 6520 7370 6163 6564  ments are spaced
+0001f0f0: 2065 7665 6e6c 7920 616c 6f6e 6720 6120   evenly along a 
+0001f100: 6772 6964 2e0a 2020 2020 7368 6170 6520  grid..    shape 
+0001f110: 3a20 6172 7261 792d 6c69 6b65 5b32 5d0a  : array-like[2].
+0001f120: 2020 2020 2020 2020 782c 2079 2073 6861          x, y sha
+0001f130: 7065 206f 6620 7468 6520 6772 6964 2028  pe of the grid (
+0001f140: 7365 6520 6e70 2e72 6573 6861 7065 292e  see np.reshape).
+0001f150: 2049 6620 6e6f 2073 6861 7065 2069 7320   If no shape is 
+0001f160: 6769 7665 6e20 616e 6420 7468 650a 2020  given and the.  
+0001f170: 2020 2020 2020 6c69 7374 2069 7320 3144        list is 1D
+0001f180: 2c20 7468 6520 6f75 7470 7574 2069 7320  , the output is 
+0001f190: 6173 2069 6620 6e70 2e72 6573 6861 7065  as if np.reshape
+0001f1a0: 2077 6572 6520 7275 6e20 7769 7468 2028   were run with (
+0001f1b0: 312c 202d 3129 2e0a 2020 2020 616c 6967  1, -1)..    alig
+0001f1c0: 6e5f 7820 3a20 7b27 7827 2c20 2778 6d69  n_x : {'x', 'xmi
+0001f1d0: 6e27 2c20 2778 6d61 7827 7d0a 2020 2020  n', 'xmax'}.    
+0001f1e0: 2020 2020 5768 6963 6820 6564 6765 2074      Which edge t
+0001f1f0: 6f20 7065 7266 6f72 6d20 7468 6520 7820  o perform the x 
+0001f200: 2863 6f6c 756d 6e29 2061 6c69 676e 6d65  (column) alignme
+0001f210: 6e74 2061 6c6f 6e67 0a20 2020 2061 6c69  nt along.    ali
+0001f220: 676e 5f79 203a 207b 2779 272c 2027 796d  gn_y : {'y', 'ym
+0001f230: 696e 272c 2027 796d 6178 277d 0a20 2020  in', 'ymax'}.   
+0001f240: 2020 2020 2057 6869 6368 2065 6467 6520       Which edge 
+0001f250: 746f 2070 6572 666f 726d 2074 6865 2079  to perform the y
+0001f260: 2028 726f 7729 2061 6c69 676e 6d65 6e74   (row) alignment
+0001f270: 2061 6c6f 6e67 0a20 2020 2065 6467 655f   along.    edge_
+0001f280: 7820 3a20 7b27 7827 2c20 2778 6d69 6e27  x : {'x', 'xmin'
+0001f290: 2c20 2778 6d61 7827 7d0a 2020 2020 2020  , 'xmax'}.      
+0001f2a0: 2020 5768 6963 6820 6564 6765 2074 6f20    Which edge to 
+0001f2b0: 7065 7266 6f72 6d20 7468 6520 7820 2863  perform the x (c
+0001f2c0: 6f6c 756d 6e29 2064 6973 7472 6962 7574  olumn) distribut
+0001f2d0: 696f 6e20 616c 6f6e 6720 2875 6e75 7365  ion along (unuse
+0001f2e0: 6420 6966 0a20 2020 2020 2020 2073 6570  d if.        sep
+0001f2f0: 6172 6174 696f 6e20 3d3d 2054 7275 6529  aration == True)
+0001f300: 0a20 2020 2065 6467 655f 7920 3a20 7b27  .    edge_y : {'
+0001f310: 7927 2c20 2779 6d69 6e27 2c20 2779 6d61  y', 'ymin', 'yma
+0001f320: 7827 7d0a 2020 2020 2020 2020 5768 6963  x'}.        Whic
+0001f330: 6820 6564 6765 2074 6f20 7065 7266 6f72  h edge to perfor
+0001f340: 6d20 7468 6520 7920 2872 6f77 2920 6469  m the y (row) di
+0001f350: 7374 7269 6275 7469 6f6e 2061 6c6f 6e67  stribution along
+0001f360: 2028 756e 7573 6564 2069 660a 2020 2020   (unused if.    
+0001f370: 2020 2020 7365 7061 7261 7469 6f6e 203d      separation =
+0001f380: 3d20 5472 7565 290a 2020 2020 6c61 6265  = True).    labe
+0001f390: 6c5f 6c61 7965 7220 3a20 4e6f 6e65 206f  l_layer : None o
+0001f3a0: 7220 6c61 7965 720a 2020 2020 2020 2020  r layer.        
+0001f3b0: 4966 206e 6f74 204e 6f6e 652c 2077 696c  If not None, wil
+0001f3c0: 6c20 706c 6163 6520 6120 6c61 6265 6c20  l place a label 
+0001f3d0: 7468 6174 2064 6573 6372 6962 6573 2074  that describes t
+0001f3e0: 6865 2070 6172 616d 6574 6572 7320 6f6e  he parameters on
+0001f3f0: 2074 6865 2064 6576 6963 650a 0a20 2020   the device..   
+0001f400: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
+0001f410: 2d2d 2d2d 0a20 2020 2064 6576 6963 655f  ----.    device_
+0001f420: 6d61 7472 6978 203a 2044 6576 6963 650a  matrix : Device.
+0001f430: 2020 2020 2020 2020 4120 4465 7669 6365          A Device
+0001f440: 2063 6f6e 7461 696e 696e 6720 616c 6c20   containing all 
+0001f450: 7468 6520 4465 7669 6365 7320 696e 2060  the Devices in `
+0001f460: 6465 7669 6365 5f6c 6973 7460 2069 6e20  device_list` in 
+0001f470: 6120 6772 6964 2e0a 2020 2020 2222 220a  a grid..    """.
+0001f480: 2020 2020 6966 2070 6172 616d 5f78 2069      if param_x i
+0001f490: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001f4a0: 7061 7261 6d5f 7820 3d20 7b28 4e6f 6e65  param_x = {(None
+0001f4b0: 2c20 2278 2229 3a20 5b4e 6f6e 655d 7d0a  , "x"): [None]}.
+0001f4c0: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+0001f4d0: 6e63 6528 7061 7261 6d5f 782c 2069 6e74  nce(param_x, int
+0001f4e0: 293a 0a20 2020 2020 2020 2070 6172 616d  ):.        param
+0001f4f0: 5f78 203d 207b 284e 6f6e 652c 2022 7822  _x = {(None, "x"
+0001f500: 293a 205b 4e6f 6e65 5d20 2a20 7061 7261  ): [None] * para
+0001f510: 6d5f 787d 0a20 2020 2069 6620 7061 7261  m_x}.    if para
+0001f520: 6d5f 7920 6973 204e 6f6e 653a 0a20 2020  m_y is None:.   
+0001f530: 2020 2020 2070 6172 616d 5f79 203d 207b       param_y = {
+0001f540: 284e 6f6e 652c 2022 7922 293a 205b 4e6f  (None, "y"): [No
+0001f550: 6e65 5d7d 0a20 2020 2065 6c69 6620 6973  ne]}.    elif is
+0001f560: 696e 7374 616e 6365 2870 6172 616d 5f79  instance(param_y
+0001f570: 2c20 696e 7429 3a0a 2020 2020 2020 2020  , int):.        
+0001f580: 7061 7261 6d5f 7920 3d20 7b28 4e6f 6e65  param_y = {(None
+0001f590: 2c20 2279 2229 3a20 5b4e 6f6e 655d 202a  , "y"): [None] *
+0001f5a0: 2070 6172 616d 5f79 7d0a 0a20 2020 2070   param_y}..    p
+0001f5b0: 6172 616d 5f76 6172 6961 7469 6f6e 7320  aram_variations 
+0001f5c0: 3d20 4f72 6465 7265 6444 6963 7428 290a  = OrderedDict().
+0001f5d0: 2020 2020 7061 7261 6d5f 7661 7269 6174      param_variat
+0001f5e0: 696f 6e73 2e75 7064 6174 6528 7061 7261  ions.update(para
+0001f5f0: 6d5f 7929 0a20 2020 2070 6172 616d 5f76  m_y).    param_v
+0001f600: 6172 6961 7469 6f6e 732e 7570 6461 7465  ariations.update
+0001f610: 2870 6172 616d 5f78 290a 0a20 2020 2044  (param_x)..    D
+0001f620: 5f6c 6973 7420 3d20 5f67 656e 5f70 6172  _list = _gen_par
+0001f630: 616d 5f76 6172 6961 7469 6f6e 7328 0a20  am_variations(. 
+0001f640: 2020 2020 2020 2066 756e 6374 696f 6e3d         function=
+0001f650: 6675 6e63 7469 6f6e 2c0a 2020 2020 2020  function,.      
+0001f660: 2020 7061 7261 6d5f 7661 7269 6174 696f    param_variatio
+0001f670: 6e73 3d70 6172 616d 5f76 6172 6961 7469  ns=param_variati
+0001f680: 6f6e 732c 0a20 2020 2020 2020 2070 6172  ons,.        par
+0001f690: 616d 5f64 6566 6175 6c74 733d 7061 7261  am_defaults=para
+0001f6a0: 6d5f 6465 6661 756c 7473 2c0a 2020 2020  m_defaults,.    
+0001f6b0: 2020 2020 7061 7261 6d5f 6f76 6572 7269      param_overri
+0001f6c0: 6465 3d70 6172 616d 5f6f 7665 7272 6964  de=param_overrid
+0001f6d0: 652c 0a20 2020 2020 2020 206c 6162 656c  e,.        label
+0001f6e0: 5f6c 6179 6572 3d6c 6162 656c 5f6c 6179  _layer=label_lay
+0001f6f0: 6572 2c0a 2020 2020 290a 0a20 2020 206e  er,.    )..    n
+0001f700: 756d 5f78 5f70 6172 616d 6574 6572 7320  um_x_parameters 
+0001f710: 3d20 6c65 6e28 5f70 6172 616d 6574 6572  = len(_parameter
+0001f720: 5f63 6f6d 6269 6e61 7469 6f6e 7328 7061  _combinations(pa
+0001f730: 7261 6d5f 7829 290a 2020 2020 6e75 6d5f  ram_x)).    num_
+0001f740: 795f 7061 7261 6d65 7465 7273 203d 206c  y_parameters = l
+0001f750: 656e 285f 7061 7261 6d65 7465 725f 636f  en(_parameter_co
+0001f760: 6d62 696e 6174 696f 6e73 2870 6172 616d  mbinations(param
+0001f770: 5f79 2929 0a20 2020 2044 203d 2067 7269  _y)).    D = gri
+0001f780: 6428 0a20 2020 2020 2020 2044 5f6c 6973  d(.        D_lis
+0001f790: 742c 0a20 2020 2020 2020 2073 7061 6369  t,.        spaci
+0001f7a0: 6e67 3d73 7061 6369 6e67 2c0a 2020 2020  ng=spacing,.    
+0001f7b0: 2020 2020 7365 7061 7261 7469 6f6e 3d73      separation=s
+0001f7c0: 6570 6172 6174 696f 6e2c 0a20 2020 2020  eparation,.     
+0001f7d0: 2020 2073 6861 7065 3d28 6e75 6d5f 785f     shape=(num_x_
+0001f7e0: 7061 7261 6d65 7465 7273 2c20 6e75 6d5f  parameters, num_
+0001f7f0: 795f 7061 7261 6d65 7465 7273 292c 0a20  y_parameters),. 
+0001f800: 2020 2020 2020 2061 6c69 676e 5f78 3d61         align_x=a
+0001f810: 6c69 676e 5f78 2c0a 2020 2020 2020 2020  lign_x,.        
+0001f820: 616c 6967 6e5f 793d 616c 6967 6e5f 792c  align_y=align_y,
+0001f830: 0a20 2020 2020 2020 2065 6467 655f 783d  .        edge_x=
+0001f840: 6564 6765 5f78 2c0a 2020 2020 2020 2020  edge_x,.        
+0001f850: 6564 6765 5f79 3d65 6467 655f 792c 0a20  edge_y=edge_y,. 
+0001f860: 2020 2029 0a0a 2020 2020 6c61 6265 6c5f     )..    label_
+0001f870: 7465 7874 203d 207b 7d0a 2020 2020 6c61  text = {}.    la
+0001f880: 6265 6c5f 7465 7874 2e75 7064 6174 6528  bel_text.update(
+0001f890: 7061 7261 6d5f 6465 6661 756c 7473 290a  param_defaults).
+0001f8a0: 2020 2020 6c61 6265 6c5f 7465 7874 2e75      label_text.u
+0001f8b0: 7064 6174 6528 7061 7261 6d5f 6f76 6572  pdate(param_over
+0001f8c0: 7269 6465 290a 2020 2020 6966 206c 6162  ride).    if lab
+0001f8d0: 656c 5f6c 6179 6572 2069 7320 6e6f 7420  el_layer is not 
+0001f8e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 442e  None:.        D.
+0001f8f0: 6164 645f 6c61 6265 6c28 7465 7874 3d73  add_label(text=s
+0001f900: 7472 286c 6162 656c 5f74 6578 7429 2c20  tr(label_text), 
+0001f910: 706f 7369 7469 6f6e 3d28 442e 786d 696e  position=(D.xmin
+0001f920: 2c20 442e 796d 696e 292c 206c 6179 6572  , D.ymin), layer
+0001f930: 3d6c 6162 656c 5f6c 6179 6572 290a 0a20  =label_layer).. 
+0001f940: 2020 2072 6574 7572 6e20 440a 0a0a 6465     return D...de
+0001f950: 6620 5f70 6163 6b5f 7369 6e67 6c65 5f62  f _pack_single_b
+0001f960: 696e 280a 2020 2020 7265 6374 5f64 6963  in(.    rect_dic
+0001f970: 742c 2061 7370 6563 745f 7261 7469 6f2c  t, aspect_ratio,
+0001f980: 206d 6178 5f73 697a 652c 2073 6f72 745f   max_size, sort_
+0001f990: 6279 5f61 7265 612c 2064 656e 7369 7479  by_area, density
+0001f9a0: 2c20 7072 6563 6973 696f 6e2c 2076 6572  , precision, ver
+0001f9b0: 626f 7365 0a29 3a0a 2020 2020 2222 2254  bose.):.    """T
+0001f9c0: 616b 6573 2061 2060 7265 6374 5f64 6963  akes a `rect_dic
+0001f9d0: 7460 2061 7267 756d 656e 7420 6f66 2074  t` argument of t
+0001f9e0: 6865 2066 6f72 6d20 7b69 643a 2877 2c20  he form {id:(w, 
+0001f9f0: 6829 7d20 616e 6420 7472 6965 7320 746f  h)} and tries to
+0001fa00: 0a20 2020 2070 6163 6b20 6974 2069 6e74  .    pack it int
+0001fa10: 6f20 6120 6269 6e20 6173 2073 6d61 6c6c  o a bin as small
+0001fa20: 2061 7320 706f 7373 6962 6c65 2077 6974   as possible wit
+0001fa30: 6820 6173 7065 6374 2072 6174 696f 2060  h aspect ratio `
+0001fa40: 6173 7065 6374 5f72 6174 696f 602e 0a20  aspect_ratio`.. 
+0001fa50: 2020 2057 696c 6c20 6974 6572 6174 6976     Will iterativ
+0001fa60: 656c 7920 6772 6f77 2074 6865 2062 696e  ely grow the bin
+0001fa70: 2073 697a 6520 756e 7469 6c20 6576 6572   size until ever
+0001fa80: 7974 6869 6e67 2066 6974 7320 6f72 2074  ything fits or t
+0001fa90: 6865 2062 696e 2073 697a 650a 2020 2020  he bin size.    
+0001faa0: 7265 6163 6865 7320 606d 6178 5f73 697a  reaches `max_siz
+0001fab0: 6560 2e20 5265 7475 726e 7320 6120 6469  e`. Returns a di
+0001fac0: 6374 696f 6e61 7279 206f 6620 7468 6520  ctionary of the 
+0001fad0: 7061 636b 6564 2072 6563 7461 6e67 6c65  packed rectangle
+0001fae0: 736e 2069 6e20 7468 650a 2020 2020 666f  sn in the.    fo
+0001faf0: 726d 207b 6964 3a28 782c 2079 2c20 772c  rm {id:(x, y, w,
+0001fb00: 2068 297d 2c20 616e 6420 6120 6469 6374   h)}, and a dict
+0001fb10: 696f 6e61 7279 206f 6620 7265 6d61 696e  ionary of remain
+0001fb20: 696e 6720 756e 7061 636b 6564 2072 6563  ing unpacked rec
+0001fb30: 7473 2e0a 2020 2020 2222 220a 2020 2020  ts..    """.    
+0001fb40: 7472 793a 0a20 2020 2020 2020 2069 6d70  try:.        imp
+0001fb50: 6f72 7420 7265 6374 7061 636b 0a20 2020  ort rectpack.   
+0001fb60: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0001fb70: 6e3a 0a20 2020 2020 2020 2072 6169 7365  n:.        raise
+0001fb80: 2049 6d70 6f72 7445 7272 6f72 280a 2020   ImportError(.  
+0001fb90: 2020 2020 2020 2020 2020 225b 5048 4944            "[PHID
+0001fba0: 4c5d 2054 6865 2070 6163 6b65 7228 2920  L] The packer() 
+0001fbb0: 6675 6e63 7469 6f6e 2072 6571 7569 7265  function require
+0001fbc0: 7320 7468 6520 220a 2020 2020 2020 2020  s the ".        
+0001fbd0: 2020 2020 276d 6f64 756c 6520 2272 6563      'module "rec
+0001fbe0: 7470 6163 6b22 2074 6f20 6f70 6572 6174  tpack" to operat
+0001fbf0: 652e 2020 506c 6561 7365 2072 6574 7279  e.  Please retry
+0001fc00: 2027 0a20 2020 2020 2020 2020 2020 2022   '.            "
+0001fc10: 6166 7465 7220 696e 7374 616c 6c69 6e67  after installing
+0001fc20: 2072 6563 7470 6163 6b3a 5c6e 5c6e 220a   rectpack:\n\n".
+0001fc30: 2020 2020 2020 2020 2020 2020 2224 2070              "$ p
+0001fc40: 6970 2069 6e73 7461 6c6c 2072 6563 7470  ip install rectp
+0001fc50: 6163 6b22 0a20 2020 2020 2020 2029 0a0a  ack".        )..
+0001fc60: 2020 2020 2320 436f 6d70 7574 6520 746f      # Compute to
+0001fc70: 7461 6c20 6172 6561 2061 6e64 2075 7365  tal area and use
+0001fc80: 2069 7420 666f 7220 616e 2069 6e69 7469   it for an initi
+0001fc90: 616c 2065 7374 696d 6174 6520 6f66 2074  al estimate of t
+0001fca0: 6865 2062 696e 2073 697a 650a 2020 2020  he bin size.    
+0001fcb0: 746f 7461 6c5f 6172 6561 203d 2030 0a20  total_area = 0. 
+0001fcc0: 2020 2066 6f72 2072 2069 6e20 7265 6374     for r in rect
+0001fcd0: 5f64 6963 742e 7661 6c75 6573 2829 3a0a  _dict.values():.
+0001fce0: 2020 2020 2020 2020 746f 7461 6c5f 6172          total_ar
+0001fcf0: 6561 202b 3d20 725b 305d 202a 2072 5b31  ea += r[0] * r[1
+0001fd00: 5d0a 2020 2020 2320 4e6f 726d 616c 697a  ].    # Normaliz
+0001fd10: 650a 2020 2020 6173 7065 6374 5f72 6174  e.    aspect_rat
+0001fd20: 696f 203d 206e 702e 6173 6172 7261 7928  io = np.asarray(
+0001fd30: 6173 7065 6374 5f72 6174 696f 2920 2f20  aspect_ratio) / 
+0001fd40: 6e70 2e6c 696e 616c 672e 6e6f 726d 2861  np.linalg.norm(a
+0001fd50: 7370 6563 745f 7261 7469 6f29 0a0a 2020  spect_ratio)..  
+0001fd60: 2020 2320 5365 7475 7020 7661 7269 6162    # Setup variab
+0001fd70: 6c65 730a 2020 2020 626f 785f 7369 7a65  les.    box_size
+0001fd80: 203d 206e 702e 6173 6172 7261 7928 6173   = np.asarray(as
+0001fd90: 7065 6374 5f72 6174 696f 202a 206e 702e  pect_ratio * np.
+0001fda0: 7371 7274 2874 6f74 616c 5f61 7265 6129  sqrt(total_area)
+0001fdb0: 2c20 6474 7970 653d 6e70 2e66 6c6f 6174  , dtype=np.float
+0001fdc0: 3634 290a 2020 2020 626f 785f 7369 7a65  64).    box_size
+0001fdd0: 203d 206e 702e 636c 6970 2862 6f78 5f73   = np.clip(box_s
+0001fde0: 697a 652c 204e 6f6e 652c 206d 6178 5f73  ize, None, max_s
+0001fdf0: 697a 6529 0a20 2020 2069 6620 736f 7274  ize).    if sort
+0001fe00: 5f62 795f 6172 6561 3a0a 2020 2020 2020  _by_area:.      
+0001fe10: 2020 7270 5f73 6f72 7420 3d20 7265 6374    rp_sort = rect
+0001fe20: 7061 636b 2e53 4f52 545f 4152 4541 0a20  pack.SORT_AREA. 
+0001fe30: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001fe40: 2072 705f 736f 7274 203d 2072 6563 7470   rp_sort = rectp
+0001fe50: 6163 6b2e 534f 5254 5f4e 4f4e 450a 0a20  ack.SORT_NONE.. 
+0001fe60: 2020 2023 2052 6570 6561 7465 646c 7920     # Repeatedly 
+0001fe70: 7275 6e20 7468 6520 7265 6374 616e 676c  run the rectangl
+0001fe80: 652d 7061 636b 696e 6720 616c 676f 7269  e-packing algori
+0001fe90: 7468 6d20 7769 7468 2069 6e63 7265 6173  thm with increas
+0001fea0: 696e 676c 7920 6c61 7267 6572 0a20 2020  ingly larger.   
+0001feb0: 2023 2061 7265 6173 2075 6e74 696c 2065   # areas until e
+0001fec0: 7665 7279 7468 696e 6720 6669 7473 206f  verything fits o
+0001fed0: 7220 7765 2776 6520 7265 6163 6865 6420  r we've reached 
+0001fee0: 7468 6520 6d61 7869 6d75 6d20 7369 7a65  the maximum size
+0001fef0: 0a20 2020 2077 6869 6c65 2054 7275 653a  .    while True:
+0001ff00: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+0001ff10: 6520 7468 6520 7061 636b 6572 206f 626a  e the packer obj
+0001ff20: 6563 740a 2020 2020 2020 2020 7265 6374  ect.        rect
+0001ff30: 5f70 6163 6b65 7220 3d20 7265 6374 7061  _packer = rectpa
+0001ff40: 636b 2e6e 6577 5061 636b 6572 280a 2020  ck.newPacker(.  
+0001ff50: 2020 2020 2020 2020 2020 6d6f 6465 3d72            mode=r
+0001ff60: 6563 7470 6163 6b2e 5061 636b 696e 674d  ectpack.PackingM
+0001ff70: 6f64 652e 4f66 666c 696e 652c 0a20 2020  ode.Offline,.   
+0001ff80: 2020 2020 2020 2020 2070 6163 6b5f 616c           pack_al
+0001ff90: 676f 3d72 6563 7470 6163 6b2e 4d61 7852  go=rectpack.MaxR
+0001ffa0: 6563 7473 426c 7366 2c0a 2020 2020 2020  ectsBlsf,.      
+0001ffb0: 2020 2020 2020 736f 7274 5f61 6c67 6f3d        sort_algo=
+0001ffc0: 7270 5f73 6f72 742c 0a20 2020 2020 2020  rp_sort,.       
+0001ffd0: 2020 2020 2062 696e 5f61 6c67 6f3d 7265       bin_algo=re
+0001ffe0: 6374 7061 636b 2e50 6163 6b69 6e67 4269  ctpack.PackingBi
+0001fff0: 6e2e 4242 462c 0a20 2020 2020 2020 2020  n.BBF,.         
+00020000: 2020 2072 6f74 6174 696f 6e3d 4661 6c73     rotation=Fals
+00020010: 652c 0a20 2020 2020 2020 2029 0a0a 2020  e,.        )..  
+00020020: 2020 2020 2020 2320 4164 6420 6561 6368        # Add each
+00020030: 2072 6563 7461 6e67 6c65 2074 6f20 7468   rectangle to th
+00020040: 6520 7061 636b 6572 2c20 6372 6561 7465  e packer, create
+00020050: 2061 2073 696e 676c 6520 6269 6e2c 2061   a single bin, a
+00020060: 6e64 2070 6163 6b0a 2020 2020 2020 2020  nd pack.        
+00020070: 666f 7220 7269 642c 2072 2069 6e20 7265  for rid, r in re
+00020080: 6374 5f64 6963 742e 6974 656d 7328 293a  ct_dict.items():
+00020090: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
+000200a0: 745f 7061 636b 6572 2e61 6464 5f72 6563  t_packer.add_rec
+000200b0: 7428 7769 6474 683d 725b 305d 2c20 6865  t(width=r[0], he
+000200c0: 6967 6874 3d72 5b31 5d2c 2072 6964 3d72  ight=r[1], rid=r
+000200d0: 6964 290a 2020 2020 2020 2020 7265 6374  id).        rect
+000200e0: 5f70 6163 6b65 722e 6164 645f 6269 6e28  _packer.add_bin(
+000200f0: 7769 6474 683d 626f 785f 7369 7a65 5b30  width=box_size[0
+00020100: 5d2c 2068 6569 6768 743d 626f 785f 7369  ], height=box_si
+00020110: 7a65 5b31 5d29 0a20 2020 2020 2020 2072  ze[1]).        r
+00020120: 6563 745f 7061 636b 6572 2e70 6163 6b28  ect_packer.pack(
+00020130: 290a 0a20 2020 2020 2020 2023 2041 646a  )..        # Adj
+00020140: 7573 7420 7468 6520 626f 7820 7369 7a65  ust the box size
+00020150: 2066 6f72 206e 6578 7420 7469 6d65 0a20   for next time. 
+00020160: 2020 2020 2020 2062 6f78 5f73 697a 6520         box_size 
+00020170: 2a3d 2064 656e 7369 7479 2020 2320 496e  *= density  # In
+00020180: 6372 6561 7365 2061 7265 6120 746f 2074  crease area to t
+00020190: 7279 2074 6f20 6669 740a 2020 2020 2020  ry to fit.      
+000201a0: 2020 626f 785f 7369 7a65 203d 206e 702e    box_size = np.
+000201b0: 636c 6970 2862 6f78 5f73 697a 652c 204e  clip(box_size, N
+000201c0: 6f6e 652c 206d 6178 5f73 697a 6529 0a20  one, max_size). 
+000201d0: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+000201e0: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+000201f0: 7269 6e74 280a 2020 2020 2020 2020 2020  rint(.          
+00020200: 2020 2020 2020 2254 7279 696e 6720 746f        "Trying to
+00020210: 2070 6163 6b20 696e 2062 696e 2073 697a   pack in bin siz
+00020220: 6520 220a 2020 2020 2020 2020 2020 2020  e ".            
+00020230: 2020 2020 2228 2530 2e32 662c 2025 302e      "(%0.2f, %0.
+00020240: 3266 2922 2025 2074 7570 6c65 2862 6f78  2f)" % tuple(box
+00020250: 5f73 697a 6520 2a20 7072 6563 6973 696f  _size * precisio
+00020260: 6e29 0a20 2020 2020 2020 2020 2020 2029  n).            )
+00020270: 0a0a 2020 2020 2020 2020 2320 5175 6974  ..        # Quit
+00020280: 2074 6865 206c 6f6f 7020 6966 2077 6527   the loop if we'
+00020290: 7665 2070 6163 6b65 6420 616c 6c20 7468  ve packed all th
+000202a0: 6520 7265 6374 616e 676c 6573 0a20 2020  e rectangles.   
+000202b0: 2020 2020 2023 206f 7220 7265 6163 6865       # or reache
+000202c0: 6420 7468 6520 6d61 7820 7369 7a65 0a20  d the max size. 
+000202d0: 2020 2020 2020 2069 6620 6c65 6e28 7265         if len(re
+000202e0: 6374 5f70 6163 6b65 722e 7265 6374 5f6c  ct_packer.rect_l
+000202f0: 6973 7428 2929 203d 3d20 6c65 6e28 7265  ist()) == len(re
+00020300: 6374 5f64 6963 7429 3a0a 2020 2020 2020  ct_dict):.      
+00020310: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
+00020320: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00020330: 2020 7072 696e 7428 2253 7563 6365 7373    print("Success
+00020340: 2122 290a 2020 2020 2020 2020 2020 2020  !").            
+00020350: 6272 6561 6b0a 2020 2020 2020 2020 656c  break.        el
+00020360: 6966 2061 6c6c 2862 6f78 5f73 697a 6520  if all(box_size 
+00020370: 3e3d 206d 6178 5f73 697a 6529 3a0a 2020  >= max_size):.  
+00020380: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+00020390: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+000203a0: 2020 2020 2020 7072 696e 7428 2252 6561        print("Rea
+000203b0: 6368 6564 206d 6178 5f73 697a 652c 2063  ched max_size, c
+000203c0: 7265 6174 696e 6720 2220 2261 6e20 6164  reating " "an ad
+000203d0: 6469 7469 6f6e 616c 2062 696e 2229 0a20  ditional bin"). 
+000203e0: 2020 2020 2020 2020 2020 2062 7265 616b             break
+000203f0: 0a0a 2020 2020 2320 5365 7061 7261 7465  ..    # Separate
+00020400: 2070 6163 6b65 6420 6672 6f6d 2075 6e70   packed from unp
+00020410: 6163 6b65 6420 7265 6374 616e 676c 6573  acked rectangles
+00020420: 2c20 6d61 6b65 2064 6963 7473 206f 6620  , make dicts of 
+00020430: 666f 726d 0a20 2020 2023 207b 6964 3a28  form.    # {id:(
+00020440: 782c 792c 772c 6829 7d0a 2020 2020 7061  x,y,w,h)}.    pa
+00020450: 636b 6564 5f72 6563 745f 6469 6374 203d  cked_rect_dict =
+00020460: 207b 725b 2d31 5d3a 2072 5b3a 2d31 5d20   {r[-1]: r[:-1] 
+00020470: 666f 7220 7220 696e 2072 6563 745f 7061  for r in rect_pa
+00020480: 636b 6572 5b30 5d2e 7265 6374 5f6c 6973  cker[0].rect_lis
+00020490: 7428 297d 0a20 2020 2075 6e70 6163 6b65  t()}.    unpacke
+000204a0: 645f 7265 6374 5f64 6963 7420 3d20 7b7d  d_rect_dict = {}
+000204b0: 0a20 2020 2066 6f72 206b 2c20 7620 696e  .    for k, v in
+000204c0: 2072 6563 745f 6469 6374 2e69 7465 6d73   rect_dict.items
+000204d0: 2829 3a0a 2020 2020 2020 2020 6966 206b  ():.        if k
+000204e0: 206e 6f74 2069 6e20 7061 636b 6564 5f72   not in packed_r
+000204f0: 6563 745f 6469 6374 3a0a 2020 2020 2020  ect_dict:.      
+00020500: 2020 2020 2020 756e 7061 636b 6564 5f72        unpacked_r
+00020510: 6563 745f 6469 6374 5b6b 5d20 3d20 760a  ect_dict[k] = v.
+00020520: 0a20 2020 2072 6574 7572 6e20 2870 6163  .    return (pac
+00020530: 6b65 645f 7265 6374 5f64 6963 742c 2075  ked_rect_dict, u
+00020540: 6e70 6163 6b65 645f 7265 6374 5f64 6963  npacked_rect_dic
+00020550: 7429 0a0a 0a64 6566 2070 6163 6b65 7228  t)...def packer(
+00020560: 0a20 2020 2044 5f6c 6973 742c 0a20 2020  .    D_list,.   
+00020570: 2073 7061 6369 6e67 3d31 302c 0a20 2020   spacing=10,.   
+00020580: 2061 7370 6563 745f 7261 7469 6f3d 2831   aspect_ratio=(1
+00020590: 2c20 3129 2c0a 2020 2020 6d61 785f 7369  , 1),.    max_si
+000205a0: 7a65 3d28 4e6f 6e65 2c20 4e6f 6e65 292c  ze=(None, None),
+000205b0: 0a20 2020 2073 6f72 745f 6279 5f61 7265  .    sort_by_are
+000205c0: 613d 5472 7565 2c0a 2020 2020 6465 6e73  a=True,.    dens
+000205d0: 6974 793d 312e 312c 0a20 2020 2070 7265  ity=1.1,.    pre
+000205e0: 6369 7369 6f6e 3d31 652d 322c 0a20 2020  cision=1e-2,.   
+000205f0: 2076 6572 626f 7365 3d46 616c 7365 2c0a   verbose=False,.
+00020600: 293a 0a20 2020 2022 2222 5061 636b 7320  ):.    """Packs 
+00020610: 6765 6f6d 6574 7269 6573 2074 6f67 6574  geometries toget
+00020620: 6865 7220 696e 746f 2072 6563 7461 6e67  her into rectang
+00020630: 756c 6172 2062 696e 732e 0a0a 2020 2020  ular bins...    
+00020640: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+00020650: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 445f  ---------.    D_
+00020660: 6c69 7374 203a 2061 7272 6179 2d6c 696b  list : array-lik
+00020670: 6520 6f66 2044 6576 6963 6573 0a20 2020  e of Devices.   
+00020680: 2020 2020 2049 6e70 7574 2044 6576 6963       Input Devic
+00020690: 6573 2074 6f20 6265 2070 6163 6b65 642e  es to be packed.
+000206a0: 0a20 2020 2073 7061 6369 6e67 203a 2069  .    spacing : i
+000206b0: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
+000206c0: 2020 2020 5468 6520 6d69 6e69 6d75 6d20      The minimum 
+000206d0: 6469 7374 616e 6365 2062 6574 7765 656e  distance between
+000206e0: 2061 646a 6163 656e 7420 7368 6170 6573   adjacent shapes
+000206f0: 2e0a 2020 2020 6173 7065 6374 5f72 6174  ..    aspect_rat
+00020700: 696f 203a 2061 7272 6179 2d6c 696b 650a  io : array-like.
+00020710: 2020 2020 2020 2020 5468 6520 2877 6964          The (wid
+00020720: 7468 2c20 6865 6967 6874 2920 7261 7469  th, height) rati
+00020730: 6f20 6f66 2074 6865 2072 6563 7461 6e67  o of the rectang
+00020740: 756c 6172 2062 696e 2e0a 2020 2020 6d61  ular bin..    ma
+00020750: 785f 7369 7a65 203a 2061 7272 6179 2d6c  x_size : array-l
+00020760: 696b 650a 2020 2020 2020 2020 4c69 6d69  ike.        Limi
+00020770: 7473 2074 6865 2073 697a 6520 696e 746f  ts the size into
+00020780: 2077 6869 6368 2074 6865 2073 6861 7065   which the shape
+00020790: 7320 7769 6c6c 2062 6520 7061 636b 6564  s will be packed
+000207a0: 2e0a 2020 2020 736f 7274 5f62 795f 6172  ..    sort_by_ar
+000207b0: 6561 203a 2062 6f6f 6c0a 2020 2020 2020  ea : bool.      
+000207c0: 2020 4966 2074 7275 652c 2070 7265 2d73    If true, pre-s
+000207d0: 6f72 7473 2074 6865 2073 6861 7065 7320  orts the shapes 
+000207e0: 6279 2061 7265 612e 0a20 2020 2064 656e  by area..    den
+000207f0: 7369 7479 203a 2069 6e74 206f 7220 666c  sity : int or fl
+00020800: 6f61 740a 2020 2020 2020 2020 4465 6e73  oat.        Dens
+00020810: 6974 7920 6f66 2070 6163 6b69 6e67 2e20  ity of packing. 
+00020820: 5661 6c75 6573 2063 6c6f 7365 7220 746f  Values closer to
+00020830: 2031 2070 6163 6b20 7469 6768 7465 7220   1 pack tighter 
+00020840: 6275 7420 7265 7175 6972 6520 6d6f 7265  but require more
+00020850: 0a20 2020 2020 2020 2063 6f6d 7075 7461  .        computa
+00020860: 7469 6f6e 2e0a 2020 2020 7072 6563 6973  tion..    precis
+00020870: 696f 6e20 3a20 666c 6f61 740a 2020 2020  ion : float.    
+00020880: 2020 2020 4465 7369 7265 6420 7072 6563      Desired prec
+00020890: 6973 696f 6e20 666f 7220 726f 756e 6469  ision for roundi
+000208a0: 6e67 2076 6572 7465 7820 636f 6f72 6469  ng vertex coordi
+000208b0: 6e61 7465 732e 0a20 2020 2076 6572 626f  nates..    verbo
+000208c0: 7365 203a 2062 6f6f 6c0a 2020 2020 2020  se : bool.      
+000208d0: 2020 5768 6574 6865 7220 746f 2064 6973    Whether to dis
+000208e0: 706c 6179 2072 6573 756c 7473 206f 6620  play results of 
+000208f0: 7061 636b 696e 6720 6174 7465 6d70 7473  packing attempts
+00020900: 0a0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
+00020910: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2044     -------.    D
+00020920: 5f70 6163 6b65 645f 6c69 7374 203a 2044  _packed_list : D
+00020930: 6576 6963 6520 6f72 206c 6973 7420 6f66  evice or list of
+00020940: 2044 6576 6963 6573 0a20 2020 2020 2020   Devices.       
+00020950: 2041 2044 6576 6963 6520 6f72 206c 6973   A Device or lis
+00020960: 7420 6f66 2044 6576 6963 6573 2063 6f6e  t of Devices con
+00020970: 7461 696e 696e 6720 616c 6c20 7468 6520  taining all the 
+00020980: 7061 636b 6564 2072 6563 7461 6e67 756c  packed rectangul
+00020990: 6172 0a20 2020 2020 2020 2062 696e 7320  ar.        bins 
+000209a0: 6765 6e65 7261 7465 642e 0a0a 2020 2020  generated...    
+000209b0: 4e6f 7465 730a 2020 2020 2d2d 2d2d 2d0a  Notes.    -----.
+000209c0: 2020 2020 4966 2061 206d 6178 2d73 697a      If a max-siz
+000209d0: 6520 6973 2073 7065 6369 6669 6564 2c20  e is specified, 
+000209e0: 7468 6520 6675 6e63 7469 6f6e 2077 696c  the function wil
+000209f0: 6c20 6372 6561 7465 2061 7320 6d61 6e79  l create as many
+00020a00: 2062 696e 7320 6173 0a20 2020 206e 6563   bins as.    nec
+00020a10: 6573 7361 7279 2074 6f20 7061 636b 2061  essary to pack a
+00020a20: 6c6c 2074 6865 2067 656f 6d65 7472 6965  ll the geometrie
+00020a30: 7320 616e 6420 7468 656e 2072 6574 7572  s and then retur
+00020a40: 6e20 6120 6c69 7374 206f 6620 7468 650a  n a list of the.
+00020a50: 2020 2020 6669 6c6c 6564 2d62 696e 2044      filled-bin D
+00020a60: 6576 6963 6573 2e0a 2020 2020 2222 220a  evices..    """.
+00020a70: 2020 2020 6966 2064 656e 7369 7479 203c      if density <
+00020a80: 2031 2e30 313a 0a20 2020 2020 2020 2072   1.01:.        r
+00020a90: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00020aa0: 0a20 2020 2020 2020 2020 2020 2022 5b50  .            "[P
+00020ab0: 4849 444c 5d20 7061 636b 6572 2829 2077  HIDL] packer() w
+00020ac0: 6173 2067 6976 656e 2061 2060 6465 6e73  as given a `dens
+00020ad0: 6974 7960 2061 7267 756d 656e 7420 220a  ity` argument ".
+00020ae0: 2020 2020 2020 2020 2020 2020 2274 6861              "tha
+00020af0: 7420 6973 2074 6f6f 2073 6d61 6c6c 2e20  t is too small. 
+00020b00: 2054 6865 2064 656e 7369 7479 2061 7267   The density arg
+00020b10: 756d 656e 7420 6d75 7374 2062 6520 220a  ument must be ".
+00020b20: 2020 2020 2020 2020 2020 2020 223e 3d20              ">= 
+00020b30: 312e 3031 220a 2020 2020 2020 2020 290a  1.01".        ).
+00020b40: 0a20 2020 2023 2053 616e 7469 7a65 206d  .    # Santize m
+00020b50: 6178 5f73 697a 6520 7661 7269 6162 6c65  ax_size variable
+00020b60: 0a20 2020 206d 6178 5f73 697a 6520 3d20  .    max_size = 
+00020b70: 5b6e 702e 696e 6620 6966 2076 2069 7320  [np.inf if v is 
+00020b80: 4e6f 6e65 2065 6c73 6520 7620 666f 7220  None else v for 
+00020b90: 7620 696e 206d 6178 5f73 697a 655d 0a20  v in max_size]. 
+00020ba0: 2020 206d 6178 5f73 697a 6520 3d20 6e70     max_size = np
+00020bb0: 2e61 7361 7272 6179 286d 6178 5f73 697a  .asarray(max_siz
+00020bc0: 652c 2064 7479 7065 3d6e 702e 666c 6f61  e, dtype=np.floa
+00020bd0: 7436 3429 2020 2320 496e 2063 6173 6520  t64)  # In case 
+00020be0: 6974 2773 2069 6e74 6567 6572 730a 2020  it's integers.  
+00020bf0: 2020 6d61 785f 7369 7a65 203d 206d 6178    max_size = max
+00020c00: 5f73 697a 6520 2f20 7072 6563 6973 696f  _size / precisio
+00020c10: 6e0a 0a20 2020 2023 2043 6f6e 7665 7274  n..    # Convert
+00020c20: 2044 6576 6963 6573 2074 6f20 7265 6374   Devices to rect
+00020c30: 616e 676c 6573 0a20 2020 2072 6563 745f  angles.    rect_
+00020c40: 6469 6374 203d 207b 7d0a 2020 2020 666f  dict = {}.    fo
+00020c50: 7220 6e2c 2044 2069 6e20 656e 756d 6572  r n, D in enumer
+00020c60: 6174 6528 445f 6c69 7374 293a 0a20 2020  ate(D_list):.   
+00020c70: 2020 2020 2077 2c20 6820 3d20 2844 2e73       w, h = (D.s
+00020c80: 697a 6520 2b20 7370 6163 696e 6729 202f  ize + spacing) /
+00020c90: 2070 7265 6369 7369 6f6e 0a20 2020 2020   precision.     
+00020ca0: 2020 2077 2c20 6820 3d20 696e 7428 7729     w, h = int(w)
+00020cb0: 2c20 696e 7428 6829 0a20 2020 2020 2020  , int(h).       
+00020cc0: 2069 6620 2877 203e 206d 6178 5f73 697a   if (w > max_siz
+00020cd0: 655b 305d 2920 6f72 2028 6820 3e20 6d61  e[0]) or (h > ma
+00020ce0: 785f 7369 7a65 5b31 5d29 3a0a 2020 2020  x_size[1]):.    
+00020cf0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00020d00: 6c75 6545 7272 6f72 280a 2020 2020 2020  lueError(.      
+00020d10: 2020 2020 2020 2020 2020 225b 5048 4944            "[PHID
+00020d20: 4c5d 2070 6163 6b65 7228 2920 6661 696c  L] packer() fail
+00020d30: 6564 2062 6563 6175 7365 206f 6e65 206f  ed because one o
+00020d40: 6620 220a 2020 2020 2020 2020 2020 2020  f ".            
+00020d50: 2020 2020 2274 6865 206f 626a 6563 7473      "the objects
+00020d60: 2069 6e20 6044 5f6c 6973 7460 2069 7320   in `D_list` is 
+00020d70: 6861 7320 616e 2078 206f 7220 220a 2020  has an x or ".  
+00020d80: 2020 2020 2020 2020 2020 2020 2020 2279                "y
+00020d90: 2064 696d 656e 7369 6f6e 206c 6172 6765   dimension large
+00020da0: 7220 7468 616e 2060 6d61 785f 7369 7a65  r than `max_size
+00020db0: 6020 616e 6420 220a 2020 2020 2020 2020  ` and ".        
+00020dc0: 2020 2020 2020 2020 2273 6f20 6361 6e6e          "so cann
+00020dd0: 6f74 2062 6520 7061 636b 6564 220a 2020  ot be packed".  
+00020de0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00020df0: 2020 2020 7265 6374 5f64 6963 745b 6e5d      rect_dict[n]
+00020e00: 203d 2028 772c 2068 290a 0a20 2020 2070   = (w, h)..    p
+00020e10: 6163 6b65 645f 6c69 7374 203d 205b 5d0a  acked_list = [].
+00020e20: 2020 2020 7768 696c 6520 6c65 6e28 7265      while len(re
+00020e30: 6374 5f64 6963 7429 203e 2030 3a0a 2020  ct_dict) > 0:.  
+00020e40: 2020 2020 2020 2870 6163 6b65 645f 7265        (packed_re
+00020e50: 6374 5f64 6963 742c 2072 6563 745f 6469  ct_dict, rect_di
+00020e60: 6374 2920 3d20 5f70 6163 6b5f 7369 6e67  ct) = _pack_sing
+00020e70: 6c65 5f62 696e 280a 2020 2020 2020 2020  le_bin(.        
+00020e80: 2020 2020 7265 6374 5f64 6963 742c 0a20      rect_dict,. 
+00020e90: 2020 2020 2020 2020 2020 2061 7370 6563             aspec
+00020ea0: 745f 7261 7469 6f3d 6173 7065 6374 5f72  t_ratio=aspect_r
+00020eb0: 6174 696f 2c0a 2020 2020 2020 2020 2020  atio,.          
+00020ec0: 2020 6d61 785f 7369 7a65 3d6d 6178 5f73    max_size=max_s
+00020ed0: 697a 652c 0a20 2020 2020 2020 2020 2020  ize,.           
+00020ee0: 2073 6f72 745f 6279 5f61 7265 613d 736f   sort_by_area=so
+00020ef0: 7274 5f62 795f 6172 6561 2c0a 2020 2020  rt_by_area,.    
+00020f00: 2020 2020 2020 2020 6465 6e73 6974 793d          density=
+00020f10: 6465 6e73 6974 792c 0a20 2020 2020 2020  density,.       
+00020f20: 2020 2020 2070 7265 6369 7369 6f6e 3d70       precision=p
+00020f30: 7265 6369 7369 6f6e 2c0a 2020 2020 2020  recision,.      
+00020f40: 2020 2020 2020 7665 7262 6f73 653d 7665        verbose=ve
+00020f50: 7262 6f73 652c 0a20 2020 2020 2020 2029  rbose,.        )
+00020f60: 0a20 2020 2020 2020 2070 6163 6b65 645f  .        packed_
+00020f70: 6c69 7374 2e61 7070 656e 6428 7061 636b  list.append(pack
+00020f80: 6564 5f72 6563 745f 6469 6374 290a 0a20  ed_rect_dict).. 
+00020f90: 2020 2044 5f70 6163 6b65 645f 6c69 7374     D_packed_list
+00020fa0: 203d 205b 5d0a 2020 2020 666f 7220 7265   = [].    for re
+00020fb0: 6374 5f64 6963 7420 696e 2070 6163 6b65  ct_dict in packe
+00020fc0: 645f 6c69 7374 3a0a 2020 2020 2020 2020  d_list:.        
+00020fd0: 445f 7061 636b 6564 203d 2044 6576 6963  D_packed = Devic
+00020fe0: 6528 290a 2020 2020 2020 2020 666f 7220  e().        for 
+00020ff0: 6e2c 2072 6563 7420 696e 2072 6563 745f  n, rect in rect_
+00021000: 6469 6374 2e69 7465 6d73 2829 3a0a 2020  dict.items():.  
+00021010: 2020 2020 2020 2020 2020 782c 2079 2c20            x, y, 
+00021020: 772c 2068 203d 2072 6563 740a 2020 2020  w, h = rect.    
+00021030: 2020 2020 2020 2020 7863 656e 7465 7220          xcenter 
+00021040: 3d20 7820 2b20 7720 2f20 3220 2b20 7370  = x + w / 2 + sp
+00021050: 6163 696e 6720 2f20 320a 2020 2020 2020  acing / 2.      
+00021060: 2020 2020 2020 7963 656e 7465 7220 3d20        ycenter = 
+00021070: 7920 2b20 6820 2f20 3220 2b20 7370 6163  y + h / 2 + spac
+00021080: 696e 6720 2f20 320a 2020 2020 2020 2020  ing / 2.        
+00021090: 2020 2020 6420 3d20 445f 7061 636b 6564      d = D_packed
+000210a0: 2e61 6464 5f72 6566 2844 5f6c 6973 745b  .add_ref(D_list[
+000210b0: 6e5d 290a 2020 2020 2020 2020 2020 2020  n]).            
+000210c0: 642e 6365 6e74 6572 203d 2028 7863 656e  d.center = (xcen
+000210d0: 7465 7220 2a20 7072 6563 6973 696f 6e2c  ter * precision,
+000210e0: 2079 6365 6e74 6572 202a 2070 7265 6369   ycenter * preci
+000210f0: 7369 6f6e 290a 2020 2020 2020 2020 445f  sion).        D_
+00021100: 7061 636b 6564 5f6c 6973 742e 6170 7065  packed_list.appe
+00021110: 6e64 2844 5f70 6163 6b65 6429 0a0a 2020  nd(D_packed)..  
+00021120: 2020 7265 7475 726e 2044 5f70 6163 6b65    return D_packe
+00021130: 645f 6c69 7374 0a0a 0a64 6566 205f 7261  d_list...def _ra
+00021140: 7374 6572 697a 655f 706f 6c79 676f 6e73  sterize_polygons
+00021150: 2870 6f6c 7967 6f6e 732c 2062 6f75 6e64  (polygons, bound
+00021160: 733d 5b5b 2d31 3030 2c20 2d31 3030 5d2c  s=[[-100, -100],
+00021170: 205b 3130 302c 2031 3030 5d5d 2c20 6478   [100, 100]], dx
+00021180: 3d31 2c20 6479 3d31 293a 0a20 2020 2022  =1, dy=1):.    "
+00021190: 2222 436f 6e76 6572 7473 2070 6f6c 7967  ""Converts polyg
+000211a0: 6f6e 7320 746f 2061 2062 6c61 636b 2f77  ons to a black/w
+000211b0: 6869 7465 2028 312f 3029 206d 6174 7269  hite (1/0) matri
+000211c0: 7822 2222 0a20 2020 2074 7279 3a0a 2020  x""".    try:.  
+000211d0: 2020 2020 2020 6672 6f6d 2073 6b69 6d61        from skima
+000211e0: 6765 2069 6d70 6f72 7420 6472 6177 0a20  ge import draw. 
+000211f0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+00021200: 696f 6e3a 0a20 2020 2020 2020 2072 6169  ion:.        rai
+00021210: 7365 2049 6d70 6f72 7445 7272 6f72 280a  se ImportError(.
+00021220: 2020 2020 2020 2020 2020 2020 2254 6865              "The
+00021230: 2066 696c 6c20 6675 6e63 7469 6f6e 2072   fill function r
+00021240: 6571 7569 7265 7320 7468 6520 6d6f 6475  equires the modu
+00021250: 6c65 2022 0a20 2020 2020 2020 2020 2020  le ".           
+00021260: 2027 2273 6369 6b69 742d 696d 6167 6522   '"scikit-image"
+00021270: 2074 6f20 6f70 6572 6174 652e 2020 506c   to operate.  Pl
+00021280: 6561 7365 2072 6574 7279 2027 0a20 2020  ease retry '.   
+00021290: 2020 2020 2020 2020 2022 6166 7465 7220           "after 
+000212a0: 696e 7374 616c 6c69 6e67 2073 6369 6b69  installing sciki
+000212b0: 742d 696d 6167 653a 5c6e 5c6e 220a 2020  t-image:\n\n".  
+000212c0: 2020 2020 2020 2020 2020 2224 2070 6970            "$ pip
+000212d0: 2069 6e73 7461 6c6c 202d 2d75 7067 7261   install --upgra
+000212e0: 6465 2073 6369 6b69 742d 696d 6167 6522  de scikit-image"
+000212f0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00021300: 2320 5072 6570 6172 6520 706f 6c79 676f  # Prepare polygo
+00021310: 6e20 6172 7261 7920 6279 2073 6869 6674  n array by shift
+00021320: 696e 6720 616c 6c20 706f 696e 7473 2069  ing all points i
+00021330: 6e74 6f20 7468 6520 6669 7273 7420 7175  nto the first qu
+00021340: 6164 7261 6e74 2061 6e64 0a20 2020 2023  adrant and.    #
+00021350: 2073 6570 6172 6174 696e 6720 706f 696e   separating poin
+00021360: 7473 2069 6e74 6f20 7820 616e 6420 7920  ts into x and y 
+00021370: 6c69 7374 730a 2020 2020 7870 7473 203d  lists.    xpts =
+00021380: 205b 5d0a 2020 2020 7970 7473 203d 205b   [].    ypts = [
+00021390: 5d0a 2020 2020 666f 7220 7020 696e 2070  ].    for p in p
+000213a0: 6f6c 7967 6f6e 733a 0a20 2020 2020 2020  olygons:.       
+000213b0: 2070 5f61 7272 6179 203d 206e 702e 6173   p_array = np.as
+000213c0: 6172 7261 7928 7029 0a20 2020 2020 2020  array(p).       
+000213d0: 2078 203d 2070 5f61 7272 6179 5b3a 2c20   x = p_array[:, 
+000213e0: 305d 0a20 2020 2020 2020 2079 203d 2070  0].        y = p
+000213f0: 5f61 7272 6179 5b3a 2c20 315d 0a20 2020  _array[:, 1].   
+00021400: 2020 2020 2078 7074 732e 6170 7065 6e64       xpts.append
+00021410: 2828 7820 2d20 626f 756e 6473 5b30 5d5b  ((x - bounds[0][
+00021420: 305d 2920 2f20 6478 202d 2030 2e35 290a  0]) / dx - 0.5).
+00021430: 2020 2020 2020 2020 7970 7473 2e61 7070          ypts.app
+00021440: 656e 6428 2879 202d 2062 6f75 6e64 735b  end((y - bounds[
+00021450: 305d 5b31 5d29 202f 2064 7920 2d20 302e  0][1]) / dy - 0.
+00021460: 3529 0a0a 2020 2020 2320 496e 6974 6961  5)..    # Initia
+00021470: 6c69 7a65 2074 6865 2072 6173 7465 7220  lize the raster 
+00021480: 6d61 7472 6978 2077 6527 6c6c 2062 6520  matrix we'll be 
+00021490: 7772 6974 696e 6720 746f 0a20 2020 2078  writing to.    x
+000214a0: 7369 7a65 203d 2069 6e74 286e 702e 6365  size = int(np.ce
+000214b0: 696c 2862 6f75 6e64 735b 315d 5b30 5d20  il(bounds[1][0] 
+000214c0: 2d20 626f 756e 6473 5b30 5d5b 305d 2920  - bounds[0][0]) 
+000214d0: 2f20 6478 290a 2020 2020 7973 697a 6520  / dx).    ysize 
+000214e0: 3d20 696e 7428 6e70 2e63 6569 6c28 626f  = int(np.ceil(bo
+000214f0: 756e 6473 5b31 5d5b 315d 202d 2062 6f75  unds[1][1] - bou
+00021500: 6e64 735b 305d 5b31 5d29 202f 2064 7929  nds[0][1]) / dy)
+00021510: 0a20 2020 2072 6173 7465 7220 3d20 6e70  .    raster = np
+00021520: 2e7a 6572 6f73 2828 7973 697a 652c 2078  .zeros((ysize, x
+00021530: 7369 7a65 292c 2064 7479 7065 3d62 6f6f  size), dtype=boo
+00021540: 6c29 0a0a 2020 2020 2320 544f 444f 3a20  l)..    # TODO: 
+00021550: 5265 706c 6163 6520 706f 6c79 676f 6e5f  Replace polygon_
+00021560: 7065 7269 6d65 7465 7220 7769 7468 2074  perimeter with t
+00021570: 6865 2073 7570 6572 636f 7665 7220 7665  he supercover ve
+00021580: 7273 696f 6e0a 2020 2020 666f 7220 6e20  rsion.    for n 
+00021590: 696e 2072 616e 6765 286c 656e 2878 7074  in range(len(xpt
+000215a0: 7329 293a 0a20 2020 2020 2020 2072 722c  s)):.        rr,
+000215b0: 2063 6320 3d20 6472 6177 2e70 6f6c 7967   cc = draw.polyg
+000215c0: 6f6e 2879 7074 735b 6e5d 2c20 7870 7473  on(ypts[n], xpts
+000215d0: 5b6e 5d2c 2073 6861 7065 3d72 6173 7465  [n], shape=raste
+000215e0: 722e 7368 6170 6529 0a20 2020 2020 2020  r.shape).       
+000215f0: 2072 7270 2c20 6363 7020 3d20 6472 6177   rrp, ccp = draw
+00021600: 2e70 6f6c 7967 6f6e 5f70 6572 696d 6574  .polygon_perimet
+00021610: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00021620: 7970 7473 5b6e 5d2c 2078 7074 735b 6e5d  ypts[n], xpts[n]
+00021630: 2c20 7368 6170 653d 7261 7374 6572 2e73  , shape=raster.s
+00021640: 6861 7065 2c20 636c 6970 3d46 616c 7365  hape, clip=False
+00021650: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00021660: 2020 2072 6173 7465 725b 7272 2c20 6363     raster[rr, cc
+00021670: 5d20 3d20 310a 2020 2020 2020 2020 7261  ] = 1.        ra
+00021680: 7374 6572 5b72 7270 2c20 6363 705d 203d  ster[rrp, ccp] =
+00021690: 2031 0a0a 2020 2020 7265 7475 726e 2072   1..    return r
+000216a0: 6173 7465 720a 0a0a 6465 6620 5f72 6173  aster...def _ras
+000216b0: 7465 725f 696e 6465 785f 746f 5f63 6f6f  ter_index_to_coo
+000216c0: 7264 7328 692c 206a 2c20 626f 756e 6473  rds(i, j, bounds
+000216d0: 3d5b 5b2d 3130 302c 202d 3130 305d 2c20  =[[-100, -100], 
+000216e0: 5b31 3030 2c20 3130 305d 5d2c 2064 783d  [100, 100]], dx=
+000216f0: 312c 2064 793d 3129 3a0a 2020 2020 2222  1, dy=1):.    ""
+00021700: 2243 6f6e 7665 7274 7320 2869 2c6a 2920  "Converts (i,j) 
+00021710: 696e 6465 7820 6f66 2072 6173 7465 7220  index of raster 
+00021720: 6d61 7472 6978 2074 6f20 7265 616c 2063  matrix to real c
+00021730: 6f6f 7264 696e 6174 6573 2222 220a 2020  oordinates""".  
+00021740: 2020 7820 3d20 286a 202b 2030 2e35 2920    x = (j + 0.5) 
+00021750: 2a20 6478 202b 2062 6f75 6e64 735b 305d  * dx + bounds[0]
+00021760: 5b30 5d0a 2020 2020 7920 3d20 2869 202b  [0].    y = (i +
+00021770: 2030 2e35 2920 2a20 6479 202b 2062 6f75   0.5) * dy + bou
+00021780: 6e64 735b 305d 5b31 5d0a 2020 2020 7265  nds[0][1].    re
+00021790: 7475 726e 2078 2c20 790a 0a0a 6465 6620  turn x, y...def 
+000217a0: 5f65 7870 616e 645f 7261 7374 6572 2872  _expand_raster(r
+000217b0: 6173 7465 722c 2064 6973 7461 6e63 653d  aster, distance=
+000217c0: 2834 2c20 3229 293a 0a20 2020 2022 2222  (4, 2)):.    """
+000217d0: 4578 7061 6e64 7320 616c 6c20 626c 6163  Expands all blac
+000217e0: 6b20 2831 2920 7069 7865 6c73 2069 6e20  k (1) pixels in 
+000217f0: 7468 6520 7261 7374 6572 2222 220a 2020  the raster""".  
+00021800: 2020 7472 793a 0a20 2020 2020 2020 2066    try:.        f
+00021810: 726f 6d20 736b 696d 6167 6520 696d 706f  rom skimage impo
+00021820: 7274 2064 7261 772c 206d 6f72 7068 6f6c  rt draw, morphol
+00021830: 6f67 790a 2020 2020 6578 6365 7074 2045  ogy.    except E
+00021840: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+00021850: 2020 7261 6973 6520 496d 706f 7274 4572    raise ImportEr
+00021860: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00021870: 2022 5468 6520 6669 6c6c 2066 756e 6374   "The fill funct
+00021880: 696f 6e20 7265 7175 6972 6573 2074 6865  ion requires the
+00021890: 206d 6f64 756c 6520 220a 2020 2020 2020   module ".      
+000218a0: 2020 2020 2020 2722 7363 696b 6974 2d69        '"scikit-i
+000218b0: 6d61 6765 2220 746f 206f 7065 7261 7465  mage" to operate
+000218c0: 2e20 2050 6c65 6173 6520 7265 7472 7920  .  Please retry 
+000218d0: 270a 2020 2020 2020 2020 2020 2020 2261  '.            "a
+000218e0: 6674 6572 2069 6e73 7461 6c6c 696e 6720  fter installing 
+000218f0: 7363 696b 6974 2d69 6d61 6765 3a5c 6e5c  scikit-image:\n\
+00021900: 6e22 0a20 2020 2020 2020 2020 2020 2022  n".            "
+00021910: 2420 7069 7020 696e 7374 616c 6c20 2d2d  $ pip install --
+00021920: 7570 6772 6164 6520 7363 696b 6974 2d69  upgrade scikit-i
+00021930: 6d61 6765 220a 2020 2020 2020 2020 290a  mage".        ).
+00021940: 2020 2020 6966 2064 6973 7461 6e63 655b      if distance[
+00021950: 305d 203c 3d20 302e 3520 616e 6420 6469  0] <= 0.5 and di
+00021960: 7374 616e 6365 5b31 5d20 3c3d 2030 2e35  stance[1] <= 0.5
+00021970: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00021980: 2072 6173 7465 720a 0a20 2020 206e 756d   raster..    num
+00021990: 5f70 6978 656c 7320 3d20 6e70 2e61 7272  _pixels = np.arr
+000219a0: 6179 286e 702e 6365 696c 2864 6973 7461  ay(np.ceil(dista
+000219b0: 6e63 6529 2c20 6474 7970 653d 696e 7429  nce), dtype=int)
+000219c0: 0a20 2020 206e 6569 6768 626f 7268 6f6f  .    neighborhoo
+000219d0: 6420 3d20 6e70 2e7a 6572 6f73 2828 6e75  d = np.zeros((nu
+000219e0: 6d5f 7069 7865 6c73 5b31 5d20 2a20 3220  m_pixels[1] * 2 
+000219f0: 2b20 312c 206e 756d 5f70 6978 656c 735b  + 1, num_pixels[
+00021a00: 305d 202a 2032 202b 2031 292c 2064 7479  0] * 2 + 1), dty
+00021a10: 7065 3d62 6f6f 6c29 0a20 2020 2072 722c  pe=bool).    rr,
+00021a20: 2063 6320 3d20 6472 6177 2e65 6c6c 6970   cc = draw.ellip
+00021a30: 7365 280a 2020 2020 2020 2020 6e75 6d5f  se(.        num_
+00021a40: 7069 7865 6c73 5b31 5d2c 206e 756d 5f70  pixels[1], num_p
+00021a50: 6978 656c 735b 305d 2c20 6469 7374 616e  ixels[0], distan
+00021a60: 6365 5b31 5d20 2b20 302e 352c 2064 6973  ce[1] + 0.5, dis
+00021a70: 7461 6e63 655b 305d 202b 2030 2e35 0a20  tance[0] + 0.5. 
+00021a80: 2020 2029 0a20 2020 206e 6569 6768 626f     ).    neighbo
+00021a90: 7268 6f6f 645b 7272 2c20 6363 5d20 3d20  rhood[rr, cc] = 
+00021aa0: 310a 0a20 2020 2072 6574 7572 6e20 6d6f  1..    return mo
+00021ab0: 7270 686f 6c6f 6779 2e62 696e 6172 795f  rphology.binary_
+00021ac0: 6469 6c61 7469 6f6e 2869 6d61 6765 3d72  dilation(image=r
+00021ad0: 6173 7465 722c 2066 6f6f 7470 7269 6e74  aster, footprint
+00021ae0: 3d6e 6569 6768 626f 7268 6f6f 6429 0a0a  =neighborhood)..
+00021af0: 0a64 6566 205f 6669 6c6c 5f63 656c 6c5f  .def _fill_cell_
+00021b00: 7265 6374 616e 676c 6528 0a20 2020 2073  rectangle(.    s
+00021b10: 697a 653d 2832 302c 2032 3029 2c0a 2020  ize=(20, 20),.  
+00021b20: 2020 6c61 7965 7273 3d28 302c 2031 2c20    layers=(0, 1, 
+00021b30: 3329 2c0a 2020 2020 6465 6e73 6974 6965  3),.    densitie
+00021b40: 733d 2830 2e35 2c20 302e 3235 2c20 302e  s=(0.5, 0.25, 0.
+00021b50: 3729 2c0a 2020 2020 696e 7665 7274 6564  7),.    inverted
+00021b60: 3d28 4661 6c73 652c 2046 616c 7365 2c20  =(False, False, 
+00021b70: 4661 6c73 6529 2c0a 293a 0a20 2020 2022  False),.):.    "
+00021b80: 2222 4372 6561 7465 7320 6120 7369 6e67  ""Creates a sing
+00021b90: 6c65 2044 6576 6963 6520 6f6e 206d 756c  le Device on mul
+00021ba0: 7469 706c 6520 6c61 7965 7273 2074 6f20  tiple layers to 
+00021bb0: 6265 2075 7365 6420 6173 2066 696c 6c0a  be used as fill.
+00021bc0: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00021bd0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00021be0: 2020 2073 697a 6520 3a20 6172 7261 792d     size : array-
+00021bf0: 6c69 6b65 206f 6620 696e 7420 6f72 2066  like of int or f
+00021c00: 6c6f 6174 0a20 2020 2020 2020 2078 2c20  loat.        x, 
+00021c10: 7920 6469 6d65 6e73 696f 6e73 206f 6620  y dimensions of 
+00021c20: 7468 6520 6669 6c6c 2061 7265 6120 666f  the fill area fo
+00021c30: 7220 616c 6c20 6c61 7965 7273 2e0a 2020  r all layers..  
+00021c40: 2020 6c61 7965 7273 203a 2069 6e74 2c20    layers : int, 
+00021c50: 6172 7261 792d 6c69 6b65 5b32 5d2c 206f  array-like[2], o
+00021c60: 7220 7365 740a 2020 2020 2020 2020 5370  r set.        Sp
+00021c70: 6563 6966 6963 206c 6179 6572 2873 2920  ecific layer(s) 
+00021c80: 746f 2070 7574 2066 696c 6c20 6365 6c6c  to put fill cell
+00021c90: 2072 6563 7461 6e67 6c65 2067 656f 6d65   rectangle geome
+00021ca0: 7472 7920 6f6e 2e0a 2020 2020 6465 6e73  try on..    dens
+00021cb0: 6974 6965 7320 3a20 6172 7261 792d 6c69  ities : array-li
+00021cc0: 6b65 206f 6620 696e 7420 6f72 2066 6c6f  ke of int or flo
+00021cd0: 6174 0a20 2020 2020 2020 2046 696c 6c20  at.        Fill 
+00021ce0: 6465 6e73 6974 6965 7320 666f 7220 6561  densities for ea
+00021cf0: 6368 206c 6179 6572 2073 7065 6369 6669  ch layer specifi
+00021d00: 6564 2069 6e20 6060 6c61 7965 7273 6060  ed in ``layers``
+00021d10: 2e20 4d75 7374 2062 6520 7468 6520 7361  . Must be the sa
+00021d20: 6d65 0a20 2020 2020 2020 2073 697a 6520  me.        size 
+00021d30: 6173 2060 606c 6179 6572 7360 602e 0a20  as ``layers``.. 
+00021d40: 2020 2069 6e76 6572 7465 6420 3a20 6172     inverted : ar
+00021d50: 7261 792d 6c69 6b65 206f 7220 626f 6f6c  ray-like or bool
+00021d60: 0a20 2020 2020 2020 2049 6620 7472 7565  .        If true
+00021d70: 2c20 696e 7665 7274 7320 7468 6520 6669  , inverts the fi
+00021d80: 6c6c 2061 7265 6120 666f 7220 636f 7272  ll area for corr
+00021d90: 6573 706f 6e64 696e 6720 6c61 7965 722e  esponding layer.
+00021da0: 204d 7573 7420 6265 2074 6865 0a20 2020   Must be the.   
+00021db0: 2020 2020 2073 616d 6520 7369 7a65 2061       same size a
+00021dc0: 7320 6060 6c61 7965 7273 6060 2e0a 0a20  s ``layers``... 
+00021dd0: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
+00021de0: 2d2d 2d2d 2d2d 0a20 2020 2044 203a 2044  ------.    D : D
+00021df0: 6576 6963 650a 2020 2020 2020 2020 4120  evice.        A 
+00021e00: 4465 7669 6365 2063 6f6e 7461 696e 696e  Device containin
+00021e10: 6720 6669 6c6c 6564 2063 656c 6c20 7265  g filled cell re
+00021e20: 6374 616e 676c 6573 2e0a 2020 2020 2222  ctangles..    ""
+00021e30: 220a 2020 2020 4420 3d20 4465 7669 6365  ".    D = Device
+00021e40: 2822 6669 6c6c 6365 6c6c 2229 0a20 2020  ("fillcell").   
+00021e50: 2066 6f72 206c 6179 6572 2c20 6465 6e73   for layer, dens
+00021e60: 6974 792c 2069 6e76 2069 6e20 7a69 7028  ity, inv in zip(
+00021e70: 6c61 7965 7273 2c20 6465 6e73 6974 6965  layers, densitie
+00021e80: 732c 2069 6e76 6572 7465 6429 3a0a 2020  s, inverted):.  
+00021e90: 2020 2020 2020 7265 6374 616e 676c 655f        rectangle_
+00021ea0: 7369 7a65 203d 206e 702e 6172 7261 7928  size = np.array(
+00021eb0: 7369 7a65 2920 2a20 7371 7274 2864 656e  size) * sqrt(den
+00021ec0: 7369 7479 290a 2020 2020 2020 2020 2320  sity).        # 
+00021ed0: 7220 3d20 442e 6164 645f 7265 6628 7265  r = D.add_ref(re
+00021ee0: 6374 616e 676c 6528 7369 7a65 203d 2072  ctangle(size = r
+00021ef0: 6563 7461 6e67 6c65 5f73 697a 652c 206c  ectangle_size, l
+00021f00: 6179 6572 203d 206c 6179 6572 2929 0a20  ayer = layer)). 
+00021f10: 2020 2020 2020 2052 203d 2072 6563 7461         R = recta
+00021f20: 6e67 6c65 2873 697a 653d 7265 6374 616e  ngle(size=rectan
+00021f30: 676c 655f 7369 7a65 2c20 6c61 7965 723d  gle_size, layer=
+00021f40: 6c61 7965 7229 0a20 2020 2020 2020 2052  layer).        R
+00021f50: 2e63 656e 7465 7220 3d20 2830 2c20 3029  .center = (0, 0)
+00021f60: 0a20 2020 2020 2020 2069 6620 696e 7620  .        if inv 
+00021f70: 6973 2054 7275 653a 0a20 2020 2020 2020  is True:.       
+00021f80: 2020 2020 2041 203d 2072 6563 7461 6e67       A = rectang
+00021f90: 6c65 2873 697a 653d 7369 7a65 290a 2020  le(size=size).  
+00021fa0: 2020 2020 2020 2020 2020 412e 6365 6e74            A.cent
+00021fb0: 6572 203d 2028 302c 2030 290a 2020 2020  er = (0, 0).    
+00021fc0: 2020 2020 2020 2020 4120 3d20 412e 6765          A = A.ge
+00021fd0: 745f 706f 6c79 676f 6e73 2829 0a20 2020  t_polygons().   
+00021fe0: 2020 2020 2020 2020 2042 203d 2052 2e67           B = R.g
+00021ff0: 6574 5f70 6f6c 7967 6f6e 7328 290a 2020  et_polygons().  
+00022000: 2020 2020 2020 2020 2020 7020 3d20 6764            p = gd
+00022010: 7370 792e 626f 6f6c 6561 6e28 412c 2042  spy.boolean(A, B
+00022020: 2c20 6f70 6572 6174 696f 6e3d 226e 6f74  , operation="not
+00022030: 2229 0a20 2020 2020 2020 2020 2020 2044  ").            D
+00022040: 2e61 6464 5f70 6f6c 7967 6f6e 2870 2c20  .add_polygon(p, 
+00022050: 6c61 7965 723d 6c61 7965 7229 0a20 2020  layer=layer).   
+00022060: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00022070: 2020 2020 2020 2044 2e61 6464 5f72 6566         D.add_ref
+00022080: 2852 290a 2020 2020 7265 7475 726e 2044  (R).    return D
+00022090: 0a0a 0a64 6566 205f 6c6f 6f70 5f6f 7665  ...def _loop_ove
+000220a0: 7228 7661 7229 3a0a 2020 2020 2222 2243  r(var):.    """C
+000220b0: 6865 636b 7320 6966 2061 2076 6172 6961  hecks if a varia
+000220c0: 626c 6520 6973 2069 6e20 7468 6520 666f  ble is in the fo
+000220d0: 726d 206f 6620 616e 2069 7465 7261 626c  rm of an iterabl
+000220e0: 6520 286c 6973 742f 7475 706c 6529 0a20  e (list/tuple). 
+000220f0: 2020 2061 6e64 2069 6620 6e6f 742c 2072     and if not, r
+00022100: 6574 7572 6e73 2069 7420 6173 2061 206c  eturns it as a l
+00022110: 6973 742e 2020 5573 6566 756c 2066 6f72  ist.  Useful for
+00022120: 2061 6c6c 6f77 696e 6720 6172 6775 6d65   allowing argume
+00022130: 6e74 0a20 2020 2069 6e70 7574 7320 746f  nt.    inputs to
+00022140: 2062 6520 6569 7468 6572 206c 6973 7473   be either lists
+00022150: 2028 652e 672e 205b 312c 2033 2c20 345d   (e.g. [1, 3, 4]
+00022160: 2920 6f72 2073 696e 676c 652d 7661 6c75  ) or single-valu
+00022170: 6564 2028 652e 672e 2033 292e 0a0a 2020  ed (e.g. 3)...  
+00022180: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00022190: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+000221a0: 7661 7220 3a20 696e 7420 6f72 2066 6c6f  var : int or flo
+000221b0: 6174 206f 7220 6c69 7374 0a20 2020 2020  at or list.     
+000221c0: 2020 2056 6172 6961 626c 6520 746f 2063     Variable to c
+000221d0: 6865 636b 2066 6f72 2069 7465 7261 6269  heck for iterabi
+000221e0: 6c69 7479 2e0a 0a20 2020 2052 6574 7572  lity...    Retur
+000221f0: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+00022200: 2020 2076 6172 203a 206c 6973 740a 2020     var : list.  
+00022210: 2020 2020 2020 5661 7269 6162 6c65 2063        Variable c
+00022220: 6f6e 7665 7274 6564 2074 6f20 6c69 7374  onverted to list
+00022230: 2069 6620 7369 6e67 6c65 2d76 616c 7565   if single-value
+00022240: 6420 696e 7075 742e 0a20 2020 2022 2222  d input..    """
+00022250: 0a0a 2020 2020 6966 2068 6173 6174 7472  ..    if hasattr
+00022260: 2876 6172 2c20 225f 5f69 7465 725f 5f22  (var, "__iter__"
+00022270: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00022280: 6e20 7661 720a 2020 2020 656c 7365 3a0a  n var.    else:.
+00022290: 2020 2020 2020 2020 7265 7475 726e 205b          return [
+000222a0: 7661 725d 0a0a 0a64 6566 2066 696c 6c5f  var]...def fill_
+000222b0: 7265 6374 616e 676c 6528 0a20 2020 2044  rectangle(.    D
+000222c0: 2c0a 2020 2020 6669 6c6c 5f73 697a 653d  ,.    fill_size=
+000222d0: 2834 302c 2031 3029 2c0a 2020 2020 6176  (40, 10),.    av
+000222e0: 6f69 645f 6c61 7965 7273 3d22 616c 6c22  oid_layers="all"
+000222f0: 2c0a 2020 2020 696e 636c 7564 655f 6c61  ,.    include_la
+00022300: 7965 7273 3d4e 6f6e 652c 0a20 2020 206d  yers=None,.    m
+00022310: 6172 6769 6e3d 3130 302c 0a20 2020 2066  argin=100,.    f
+00022320: 696c 6c5f 6c61 7965 7273 3d28 302c 2031  ill_layers=(0, 1
+00022330: 2c20 3329 2c0a 2020 2020 6669 6c6c 5f64  , 3),.    fill_d
+00022340: 656e 7369 7469 6573 3d28 302e 352c 2030  ensities=(0.5, 0
+00022350: 2e32 352c 2030 2e37 292c 0a20 2020 2066  .25, 0.7),.    f
+00022360: 696c 6c5f 696e 7665 7274 6564 3d4e 6f6e  ill_inverted=Non
+00022370: 652c 0a20 2020 2062 626f 783d 4e6f 6e65  e,.    bbox=None
+00022380: 2c0a 293a 0a20 2020 2022 2222 4372 6561  ,.):.    """Crea
+00022390: 7465 7320 6120 7265 6374 616e 6775 6c61  tes a rectangula
+000223a0: 7220 6669 6c6c 2070 6174 7465 726e 2061  r fill pattern a
+000223b0: 6e64 2066 696c 6c73 2061 6c6c 2065 6d70  nd fills all emp
+000223c0: 7479 2061 7265 6173 0a20 2020 2069 6e20  ty areas.    in 
+000223d0: 7468 6520 696e 7075 7420 6465 7669 6365  the input device
+000223e0: 2044 0a0a 2020 2020 5061 7261 6d65 7465   D..    Paramete
+000223f0: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+00022400: 2d0a 2020 2020 4420 3a20 4465 7669 6365  -.    D : Device
+00022410: 0a20 2020 2020 2020 2044 6576 6963 6520  .        Device 
+00022420: 746f 2062 6520 6669 6c6c 6564 0a20 2020  to be filled.   
+00022430: 2066 696c 6c5f 7369 7a65 203a 2061 7272   fill_size : arr
+00022440: 6179 2d6c 696b 655b 325d 0a20 2020 2020  ay-like[2].     
+00022450: 2020 2052 6563 7461 6e67 756c 6172 2073     Rectangular s
+00022460: 697a 6520 6f66 2074 6865 2066 696c 6c20  ize of the fill 
+00022470: 656c 656d 656e 740a 2020 2020 6176 6f69  element.    avoi
+00022480: 645f 6c61 7965 7273 203a 2027 616c 6c27  d_layers : 'all'
+00022490: 206f 7220 6c69 7374 206f 6620 6c61 7965   or list of laye
+000224a0: 7273 0a20 2020 2020 2020 204c 6179 6572  rs.        Layer
+000224b0: 7320 746f 2062 6520 6176 6f69 6465 6420  s to be avoided 
+000224c0: 286e 6f74 2066 696c 6c65 6429 2069 6e20  (not filled) in 
+000224d0: 440a 2020 2020 696e 636c 7564 655f 6c61  D.    include_la
+000224e0: 7965 7273 203a 0a20 2020 2020 2020 204c  yers :.        L
+000224f0: 6179 6572 7320 746f 2062 6520 696e 636c  ayers to be incl
+00022500: 7564 6564 2028 6669 6c6c 6564 2920 696e  uded (filled) in
+00022510: 2044 2c20 7375 7065 7263 6564 6573 2061   D, supercedes a
+00022520: 766f 6964 5f6c 6179 6572 730a 2020 2020  void_layers.    
+00022530: 6d61 7267 696e 203a 2069 6e74 206f 7220  margin : int or 
+00022540: 666c 6f61 740a 2020 2020 2020 2020 4d61  float.        Ma
+00022550: 7267 696e 2073 7061 6369 6e67 2061 726f  rgin spacing aro
+00022560: 756e 6420 6176 6f69 6465 6420 6172 6561  und avoided area
+00022570: 7320 2d2d 2066 696c 6c20 7769 6c6c 206e  s -- fill will n
+00022580: 6f74 2063 6f6d 6520 7769 7468 696e 0a20  ot come within. 
+00022590: 2020 2020 2020 2060 6d61 7267 696e 6020         `margin` 
+000225a0: 6f66 2074 6865 2067 656f 6d65 7472 7920  of the geometry 
+000225b0: 696e 2044 0a20 2020 2066 696c 6c5f 6c61  in D.    fill_la
+000225c0: 7965 7273 203a 206c 6973 7420 6f66 206c  yers : list of l
+000225d0: 6179 6572 730a 2020 2020 2020 2020 4465  ayers.        De
+000225e0: 6669 6e65 7320 7468 6520 6669 6c6c 2070  fines the fill p
+000225f0: 6174 7465 726e 206c 6179 6572 730a 2020  attern layers.  
+00022600: 2020 6669 6c6c 5f64 656e 7369 7469 6573    fill_densities
+00022610: 203a 2066 6c6f 6174 2062 6574 7765 656e   : float between
+00022620: 2030 2061 6e64 2031 0a20 2020 2020 2020   0 and 1.       
+00022630: 2044 6566 696e 6573 2074 6865 2066 696c   Defines the fil
+00022640: 6c20 7061 7474 6572 6e20 6465 6e73 6974  l pattern densit
+00022650: 7920 2831 2e30 203d 3d20 6675 6c6c 7920  y (1.0 == fully 
+00022660: 6669 6c6c 6564 290a 2020 2020 6669 6c6c  filled).    fill
+00022670: 5f69 6e76 6572 7465 6420 3a20 626f 6f6c  _inverted : bool
+00022680: 0a20 2020 2020 2020 2049 6e76 6572 7473  .        Inverts
+00022690: 2074 6865 2066 696c 6c20 7061 7474 6572   the fill patter
+000226a0: 6e0a 2020 2020 6262 6f78 203a 2061 7272  n.    bbox : arr
+000226b0: 6179 2d6c 696b 655b 325d 5b32 5d0a 2020  ay-like[2][2].  
+000226c0: 2020 2020 2020 4c69 6d69 7420 7468 6520        Limit the 
+000226d0: 6669 6c6c 2070 6174 7465 726e 2074 6f20  fill pattern to 
+000226e0: 7468 6520 6172 6561 2064 6566 696e 6564  the area defined
+000226f0: 2062 7920 7468 6973 2062 6f75 6e64 696e   by this boundin
+00022700: 6720 626f 780a 0a20 2020 2052 6574 7572  g box..    Retur
+00022710: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+00022720: 2020 2046 203a 2044 6576 6963 650a 0a20     F : Device.. 
+00022730: 2020 2022 2222 0a20 2020 2023 2043 7265     """.    # Cre
+00022740: 6174 6520 7468 6520 6669 6c6c 2063 656c  ate the fill cel
+00022750: 6c2e 0a20 2020 2023 2049 6620 6669 6c6c  l..    # If fill
+00022760: 5f69 6e76 6572 7465 6420 6973 206e 6f74  _inverted is not
+00022770: 2073 7065 6369 6669 6564 2c20 6173 7375   specified, assu
+00022780: 6d65 2061 6c6c 2046 616c 7365 0a20 2020  me all False.   
+00022790: 2066 696c 6c5f 6c61 7965 7273 203d 205f   fill_layers = _
+000227a0: 6c6f 6f70 5f6f 7665 7228 6669 6c6c 5f6c  loop_over(fill_l
+000227b0: 6179 6572 7329 0a20 2020 2066 696c 6c5f  ayers).    fill_
+000227c0: 6465 6e73 6974 6965 7320 3d20 5f6c 6f6f  densities = _loo
+000227d0: 705f 6f76 6572 2866 696c 6c5f 6465 6e73  p_over(fill_dens
+000227e0: 6974 6965 7329 0a20 2020 2069 6620 6669  ities).    if fi
+000227f0: 6c6c 5f69 6e76 6572 7465 6420 6973 204e  ll_inverted is N
+00022800: 6f6e 653a 0a20 2020 2020 2020 2066 696c  one:.        fil
+00022810: 6c5f 696e 7665 7274 6564 203d 205b 4661  l_inverted = [Fa
+00022820: 6c73 655d 202a 206c 656e 2866 696c 6c5f  lse] * len(fill_
+00022830: 6c61 7965 7273 290a 2020 2020 6669 6c6c  layers).    fill
+00022840: 5f69 6e76 6572 7465 6420 3d20 5f6c 6f6f  _inverted = _loo
+00022850: 705f 6f76 6572 2866 696c 6c5f 696e 7665  p_over(fill_inve
+00022860: 7274 6564 290a 2020 2020 6966 206c 656e  rted).    if len
+00022870: 2866 696c 6c5f 6c61 7965 7273 2920 213d  (fill_layers) !=
+00022880: 206c 656e 2866 696c 6c5f 6465 6e73 6974   len(fill_densit
+00022890: 6965 7329 3a0a 2020 2020 2020 2020 7261  ies):.        ra
+000228a0: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
+000228b0: 2020 2020 2020 2020 2020 2020 225b 5048              "[PH
+000228c0: 4944 4c5d 2070 6869 646c 2e67 656f 6d65  IDL] phidl.geome
+000228d0: 7472 792e 6669 6c6c 5f72 6563 7461 6e67  try.fill_rectang
+000228e0: 6c65 2829 2022 0a20 2020 2020 2020 2020  le() ".         
+000228f0: 2020 2022 6066 696c 6c5f 6c61 7965 7273     "`fill_layers
+00022900: 6020 616e 6420 6066 696c 6c5f 6465 6e73  ` and `fill_dens
+00022910: 6974 6965 7360 2070 6172 616d 6574 6572  ities` parameter
+00022920: 7320 220a 2020 2020 2020 2020 2020 2020  s ".            
+00022930: 226d 7573 7420 6265 206c 6973 7473 206f  "must be lists o
+00022940: 6620 7468 6520 7361 6d65 206c 656e 6774  f the same lengt
+00022950: 6822 0a20 2020 2020 2020 2029 0a20 2020  h".        ).   
+00022960: 2069 6620 6c65 6e28 6669 6c6c 5f6c 6179   if len(fill_lay
+00022970: 6572 7329 2021 3d20 6c65 6e28 6669 6c6c  ers) != len(fill
+00022980: 5f69 6e76 6572 7465 6429 3a0a 2020 2020  _inverted):.    
+00022990: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+000229a0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+000229b0: 2020 225b 5048 4944 4c5d 2070 6869 646c    "[PHIDL] phidl
+000229c0: 2e67 656f 6d65 7472 792e 6669 6c6c 5f72  .geometry.fill_r
+000229d0: 6563 7461 6e67 6c65 2829 2022 0a20 2020  ectangle() ".   
+000229e0: 2020 2020 2020 2020 2022 6066 696c 6c5f           "`fill_
+000229f0: 6c61 7965 7273 6020 616e 6420 6066 696c  layers` and `fil
+00022a00: 6c5f 696e 7665 7274 6564 6020 7061 7261  l_inverted` para
+00022a10: 6d65 7465 7273 206d 7573 7420 220a 2020  meters must ".  
+00022a20: 2020 2020 2020 2020 2020 2262 6520 6c69            "be li
+00022a30: 7374 7320 6f66 2074 6865 2073 616d 6520  sts of the same 
+00022a40: 6c65 6e67 7468 220a 2020 2020 2020 2020  length".        
+00022a50: 290a 0a20 2020 2066 696c 6c5f 6365 6c6c  )..    fill_cell
+00022a60: 203d 205f 6669 6c6c 5f63 656c 6c5f 7265   = _fill_cell_re
+00022a70: 6374 616e 676c 6528 0a20 2020 2020 2020  ctangle(.       
+00022a80: 2073 697a 653d 6669 6c6c 5f73 697a 652c   size=fill_size,
+00022a90: 0a20 2020 2020 2020 206c 6179 6572 733d  .        layers=
+00022aa0: 6669 6c6c 5f6c 6179 6572 732c 0a20 2020  fill_layers,.   
+00022ab0: 2020 2020 2064 656e 7369 7469 6573 3d66       densities=f
+00022ac0: 696c 6c5f 6465 6e73 6974 6965 732c 0a20  ill_densities,. 
+00022ad0: 2020 2020 2020 2069 6e76 6572 7465 643d         inverted=
+00022ae0: 6669 6c6c 5f69 6e76 6572 7465 642c 0a20  fill_inverted,. 
+00022af0: 2020 2029 0a20 2020 2046 203d 2044 6576     ).    F = Dev
+00022b00: 6963 6528 6e61 6d65 3d22 6669 6c6c 5f70  ice(name="fill_p
+00022b10: 6174 7465 726e 2229 0a0a 2020 2020 6966  attern")..    if
+00022b20: 2061 766f 6964 5f6c 6179 6572 7320 3d3d   avoid_layers ==
+00022b30: 2022 616c 6c22 3a0a 2020 2020 2020 2020   "all":.        
+00022b40: 6578 636c 7564 655f 706f 6c79 7320 3d20  exclude_polys = 
+00022b50: 442e 6765 745f 706f 6c79 676f 6e73 2862  D.get_polygons(b
+00022b60: 795f 7370 6563 3d46 616c 7365 2c20 6465  y_spec=False, de
+00022b70: 7074 683d 4e6f 6e65 290a 2020 2020 656c  pth=None).    el
+00022b80: 7365 3a0a 2020 2020 2020 2020 6176 6f69  se:.        avoi
+00022b90: 645f 6c61 7965 7273 203d 205b 5f70 6172  d_layers = [_par
+00022ba0: 7365 5f6c 6179 6572 286c 2920 666f 7220  se_layer(l) for 
+00022bb0: 6c20 696e 205f 6c6f 6f70 5f6f 7665 7228  l in _loop_over(
+00022bc0: 6176 6f69 645f 6c61 7965 7273 295d 0a20  avoid_layers)]. 
+00022bd0: 2020 2020 2020 2065 7863 6c75 6465 5f70         exclude_p
+00022be0: 6f6c 7973 203d 2044 2e67 6574 5f70 6f6c  olys = D.get_pol
+00022bf0: 7967 6f6e 7328 6279 5f73 7065 633d 5472  ygons(by_spec=Tr
+00022c00: 7565 2c20 6465 7074 683d 4e6f 6e65 290a  ue, depth=None).
+00022c10: 2020 2020 2020 2020 6578 636c 7564 655f          exclude_
+00022c20: 706f 6c79 7320 3d20 7b0a 2020 2020 2020  polys = {.      
+00022c30: 2020 2020 2020 6b65 793a 2065 7863 6c75        key: exclu
+00022c40: 6465 5f70 6f6c 7973 5b6b 6579 5d20 666f  de_polys[key] fo
+00022c50: 7220 6b65 7920 696e 2065 7863 6c75 6465  r key in exclude
+00022c60: 5f70 6f6c 7973 2069 6620 6b65 7920 696e  _polys if key in
+00022c70: 2061 766f 6964 5f6c 6179 6572 730a 2020   avoid_layers.  
+00022c80: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00022c90: 6578 636c 7564 655f 706f 6c79 7320 3d20  exclude_polys = 
+00022ca0: 6974 6572 746f 6f6c 732e 6368 6169 6e2e  itertools.chain.
+00022cb0: 6672 6f6d 5f69 7465 7261 626c 6528 6578  from_iterable(ex
+00022cc0: 636c 7564 655f 706f 6c79 732e 7661 6c75  clude_polys.valu
+00022cd0: 6573 2829 290a 0a20 2020 2069 6620 696e  es())..    if in
+00022ce0: 636c 7564 655f 6c61 7965 7273 2069 7320  clude_layers is 
+00022cf0: 4e6f 6e65 3a0a 2020 2020 2020 2020 696e  None:.        in
+00022d00: 636c 7564 655f 706f 6c79 7320 3d20 5b5d  clude_polys = []
+00022d10: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00022d20: 2020 2069 6e63 6c75 6465 5f6c 6179 6572     include_layer
+00022d30: 7320 3d20 5b5f 7061 7273 655f 6c61 7965  s = [_parse_laye
+00022d40: 7228 6c29 2066 6f72 206c 2069 6e20 5f6c  r(l) for l in _l
+00022d50: 6f6f 705f 6f76 6572 2869 6e63 6c75 6465  oop_over(include
+00022d60: 5f6c 6179 6572 7329 5d0a 2020 2020 2020  _layers)].      
+00022d70: 2020 696e 636c 7564 655f 706f 6c79 7320    include_polys 
+00022d80: 3d20 442e 6765 745f 706f 6c79 676f 6e73  = D.get_polygons
+00022d90: 2862 795f 7370 6563 3d54 7275 652c 2064  (by_spec=True, d
+00022da0: 6570 7468 3d4e 6f6e 6529 0a20 2020 2020  epth=None).     
+00022db0: 2020 2069 6e63 6c75 6465 5f70 6f6c 7973     include_polys
+00022dc0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00022dd0: 206b 6579 3a20 696e 636c 7564 655f 706f   key: include_po
+00022de0: 6c79 735b 6b65 795d 2066 6f72 206b 6579  lys[key] for key
+00022df0: 2069 6e20 696e 636c 7564 655f 706f 6c79   in include_poly
+00022e00: 7320 6966 206b 6579 2069 6e20 696e 636c  s if key in incl
+00022e10: 7564 655f 6c61 7965 7273 0a20 2020 2020  ude_layers.     
+00022e20: 2020 207d 0a20 2020 2020 2020 2069 6e63     }.        inc
+00022e30: 6c75 6465 5f70 6f6c 7973 203d 2069 7465  lude_polys = ite
+00022e40: 7274 6f6f 6c73 2e63 6861 696e 2e66 726f  rtools.chain.fro
+00022e50: 6d5f 6974 6572 6162 6c65 2869 6e63 6c75  m_iterable(inclu
+00022e60: 6465 5f70 6f6c 7973 2e76 616c 7565 7328  de_polys.values(
+00022e70: 2929 0a0a 2020 2020 6966 2062 626f 7820  ))..    if bbox 
+00022e80: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00022e90: 2062 626f 7820 3d20 442e 6262 6f78 0a0a   bbox = D.bbox..
+00022ea0: 2020 2020 7261 7374 6572 203d 205f 7261      raster = _ra
+00022eb0: 7374 6572 697a 655f 706f 6c79 676f 6e73  sterize_polygons
+00022ec0: 280a 2020 2020 2020 2020 706f 6c79 676f  (.        polygo
+00022ed0: 6e73 3d65 7863 6c75 6465 5f70 6f6c 7973  ns=exclude_polys
+00022ee0: 2c20 626f 756e 6473 3d62 626f 782c 2064  , bounds=bbox, d
+00022ef0: 783d 6669 6c6c 5f73 697a 655b 305d 2c20  x=fill_size[0], 
+00022f00: 6479 3d66 696c 6c5f 7369 7a65 5b31 5d0a  dy=fill_size[1].
+00022f10: 2020 2020 290a 2020 2020 7261 7374 6572      ).    raster
+00022f20: 203d 2072 6173 7465 7220 2620 7e5f 7261   = raster & ~_ra
+00022f30: 7374 6572 697a 655f 706f 6c79 676f 6e73  sterize_polygons
+00022f40: 280a 2020 2020 2020 2020 706f 6c79 676f  (.        polygo
+00022f50: 6e73 3d69 6e63 6c75 6465 5f70 6f6c 7973  ns=include_polys
+00022f60: 2c20 626f 756e 6473 3d62 626f 782c 2064  , bounds=bbox, d
+00022f70: 783d 6669 6c6c 5f73 697a 655b 305d 2c20  x=fill_size[0], 
+00022f80: 6479 3d66 696c 6c5f 7369 7a65 5b31 5d0a  dy=fill_size[1].
+00022f90: 2020 2020 290a 2020 2020 7261 7374 6572      ).    raster
+00022fa0: 203d 205f 6578 7061 6e64 5f72 6173 7465   = _expand_raste
+00022fb0: 7228 7261 7374 6572 2c20 6469 7374 616e  r(raster, distan
+00022fc0: 6365 3d6d 6172 6769 6e20 2f20 6e70 2e61  ce=margin / np.a
+00022fd0: 7272 6179 2866 696c 6c5f 7369 7a65 2929  rray(fill_size))
+00022fe0: 0a0a 2020 2020 666f 7220 6920 696e 2072  ..    for i in r
+00022ff0: 616e 6765 286e 702e 7369 7a65 2872 6173  ange(np.size(ras
+00023000: 7465 722c 2030 2929 3a0a 2020 2020 2020  ter, 0)):.      
+00023010: 2020 7375 625f 7261 7374 6572 7320 3d20    sub_rasters = 
+00023020: 5b6c 6973 7428 6729 2066 6f72 206b 2c20  [list(g) for k, 
+00023030: 6720 696e 2069 7465 7274 6f6f 6c73 2e67  g in itertools.g
+00023040: 726f 7570 6279 2872 6173 7465 725b 695d  roupby(raster[i]
+00023050: 295d 0a20 2020 2020 2020 206a 203d 2030  )].        j = 0
+00023060: 0a20 2020 2020 2020 2066 6f72 2073 2069  .        for s i
+00023070: 6e20 7375 625f 7261 7374 6572 733a 0a20  n sub_rasters:. 
+00023080: 2020 2020 2020 2020 2020 2069 6620 735b             if s[
+00023090: 305d 203d 3d20 303a 0a20 2020 2020 2020  0] == 0:.       
+000230a0: 2020 2020 2020 2020 2078 2c20 7920 3d20           x, y = 
+000230b0: 5f72 6173 7465 725f 696e 6465 785f 746f  _raster_index_to
+000230c0: 5f63 6f6f 7264 7328 692c 206a 2c20 6262  _coords(i, j, bb
+000230d0: 6f78 2c20 6669 6c6c 5f73 697a 655b 305d  ox, fill_size[0]
+000230e0: 2c20 6669 6c6c 5f73 697a 655b 315d 290a  , fill_size[1]).
+000230f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023100: 2320 462e 6164 6428 6764 7370 792e 4365  # F.add(gdspy.Ce
+00023110: 6c6c 4172 7261 7928 7265 665f 6365 6c6c  llArray(ref_cell
+00023120: 203d 2066 696c 6c5f 6365 6c6c 2c0a 2020   = fill_cell,.  
+00023130: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00023140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023150: 2020 2020 2020 636f 6c75 6d6e 7320 3d20        columns = 
+00023160: 6c65 6e28 7329 2c20 726f 7773 203d 2031  len(s), rows = 1
+00023170: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00023180: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+00023190: 2020 2020 2020 2020 2020 7370 6163 696e            spacin
+000231a0: 6720 3d20 6669 6c6c 5f73 697a 652c 2029  g = fill_size, )
+000231b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000231c0: 2020 6120 3d20 462e 6164 645f 6172 7261    a = F.add_arra
+000231d0: 7928 6669 6c6c 5f63 656c 6c2c 2063 6f6c  y(fill_cell, col
+000231e0: 756d 6e73 3d6c 656e 2873 292c 2072 6f77  umns=len(s), row
+000231f0: 733d 312c 2073 7061 6369 6e67 3d66 696c  s=1, spacing=fil
+00023200: 6c5f 7369 7a65 290a 2020 2020 2020 2020  l_size).        
+00023210: 2020 2020 2020 2020 612e 6d6f 7665 2828          a.move((
+00023220: 782c 2079 2929 0a20 2020 2020 2020 2020  x, y)).         
+00023230: 2020 206a 202b 3d20 6c65 6e28 7329 0a0a     j += len(s)..
+00023240: 2020 2020 7265 7475 726e 2046 0a0a 0a23      return F...#
+00023250: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
+00023260: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00023270: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00023280: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00023290: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
+000232a0: 230a 2320 5068 6f74 6f6e 6963 730a 230a  #.# Photonics.#.
+000232b0: 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  # ==============
+000232c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000232d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000232e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000232f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00023300: 0a0a 0a64 6566 2070 6f6c 7967 6f6e 5f70  ...def polygon_p
+00023310: 6f72 7473 2878 7074 733d 5b2d 312c 202d  orts(xpts=[-1, -
+00023320: 312c 2030 2c20 305d 2c20 7970 7473 3d5b  1, 0, 0], ypts=[
+00023330: 302c 2031 2c20 312c 2030 5d2c 206c 6179  0, 1, 1, 0], lay
+00023340: 6572 3d30 293a 0a20 2020 2022 2222 4372  er=0):.    """Cr
+00023350: 6561 7465 7320 6120 706f 6c79 676f 6e20  eates a polygon 
+00023360: 7769 7468 2070 6f72 7473 206f 6e20 616c  with ports on al
+00023370: 6c20 6564 6765 732e 0a0a 2020 2020 5061  l edges...    Pa
+00023380: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00023390: 2d2d 2d2d 2d2d 2d0a 2020 2020 7870 7473  -------.    xpts
+000233a0: 203a 2061 7272 6179 2d6c 696b 650a 2020   : array-like.  
+000233b0: 2020 2020 2020 782d 636f 6f72 6469 6e61        x-coordina
+000233c0: 7465 2076 616c 7565 7320 6f66 2074 6865  te values of the
+000233d0: 2070 6f6c 7967 6f6e 2076 6572 7469 6365   polygon vertice
+000233e0: 732e 0a20 2020 2079 7074 7320 3a20 6172  s..    ypts : ar
+000233f0: 7261 792d 6c69 6b65 0a20 2020 2020 2020  ray-like.       
+00023400: 2079 2d63 6f6f 7264 696e 6174 6520 7661   y-coordinate va
+00023410: 6c75 6573 206f 6620 7468 6520 706f 6c79  lues of the poly
+00023420: 676f 6e20 7665 7274 6963 6573 2e0a 2020  gon vertices..  
+00023430: 2020 6c61 7965 7220 3a20 696e 742c 2061    layer : int, a
+00023440: 7272 6179 2d6c 696b 655b 325d 2c20 6f72  rray-like[2], or
+00023450: 2073 6574 0a20 2020 2020 2020 2053 7065   set.        Spe
+00023460: 6369 6669 6320 6c61 7965 7228 7329 2074  cific layer(s) t
+00023470: 6f20 7075 7420 706f 6c79 676f 6e20 6765  o put polygon ge
+00023480: 6f6d 6574 7279 206f 6e2e 0a0a 2020 2020  ometry on...    
+00023490: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+000234a0: 2d2d 2d0a 2020 2020 5020 3a20 4465 7669  ---.    P : Devi
+000234b0: 6365 0a20 2020 2020 2020 2041 2044 6576  ce.        A Dev
+000234c0: 6963 6520 636f 6e74 6169 6e69 6e67 2061  ice containing a
+000234d0: 2070 6f6c 7967 6f6e 2077 6974 6820 706f   polygon with po
+000234e0: 7274 7320 6f6e 2061 6c6c 2065 6467 6573  rts on all edges
+000234f0: 2e0a 2020 2020 2222 220a 2020 2020 2320  ..    """.    # 
+00023500: 7265 7475 726e 7320 6120 706f 6c79 676f  returns a polygo
+00023510: 6e20 7769 7468 2070 6f72 7473 206f 6e20  n with ports on 
+00023520: 616c 6c20 6564 6765 730a 2020 2020 5020  all edges.    P 
+00023530: 3d20 4465 7669 6365 2822 706f 6c79 676f  = Device("polygo
+00023540: 6e22 290a 2020 2020 502e 6164 645f 706f  n").    P.add_po
+00023550: 6c79 676f 6e28 5b78 7074 732c 2079 7074  lygon([xpts, ypt
+00023560: 735d 2c20 6c61 7965 723d 6c61 7965 7229  s], layer=layer)
+00023570: 0a20 2020 206e 203d 206c 656e 2878 7074  .    n = len(xpt
+00023580: 7329 0a20 2020 2078 7074 732e 6170 7065  s).    xpts.appe
+00023590: 6e64 2878 7074 735b 305d 290a 2020 2020  nd(xpts[0]).    
+000235a0: 7970 7473 2e61 7070 656e 6428 7970 7473  ypts.append(ypts
+000235b0: 5b30 5d29 0a20 2020 2023 2064 6574 6572  [0]).    # deter
+000235c0: 6d69 6e65 2069 6620 636c 6f63 6b77 6973  mine if clockwis
+000235d0: 6520 6f72 2063 6f75 6e74 6572 636c 6f63  e or countercloc
+000235e0: 6b77 6973 650a 2020 2020 6363 203d 2030  kwise.    cc = 0
+000235f0: 0a20 2020 2066 6f72 2069 2069 6e20 7261  .    for i in ra
+00023600: 6e67 6528 302c 206e 293a 0a20 2020 2020  nge(0, n):.     
+00023610: 2020 2063 6320 2b3d 2028 7870 7473 5b69     cc += (xpts[i
+00023620: 202b 2031 5d20 2d20 7870 7473 5b69 5d29   + 1] - xpts[i])
+00023630: 202a 2028 7970 7473 5b69 202b 2031 5d20   * (ypts[i + 1] 
+00023640: 2b20 7970 7473 5b69 5d29 0a0a 2020 2020  + ypts[i])..    
+00023650: 666f 7220 6920 696e 2072 616e 6765 2830  for i in range(0
+00023660: 2c20 6e29 3a0a 2020 2020 2020 2020 6d69  , n):.        mi
+00023670: 6470 6f69 6e74 5f6e 203d 205b 2878 7074  dpoint_n = [(xpt
+00023680: 735b 6920 2b20 315d 202b 2078 7074 735b  s[i + 1] + xpts[
+00023690: 695d 2920 2f20 322c 2028 7970 7473 5b69  i]) / 2, (ypts[i
+000236a0: 202b 2031 5d20 2b20 7970 7473 5b69 5d29   + 1] + ypts[i])
+000236b0: 202f 2032 5d0a 2020 2020 2020 2020 6f72   / 2].        or
+000236c0: 6965 6e74 6174 696f 6e5f 6e20 3d20 280a  ientation_n = (.
+000236d0: 2020 2020 2020 2020 2020 2020 6e70 2e61              np.a
+000236e0: 7263 7461 6e32 280a 2020 2020 2020 2020  rctan2(.        
+000236f0: 2020 2020 2020 2020 6e70 2e73 6967 6e28          np.sign(
+00023700: 6363 2920 2a20 2878 7074 735b 6920 2b20  cc) * (xpts[i + 
+00023710: 315d 202d 2078 7074 735b 695d 292c 0a20  1] - xpts[i]),. 
+00023720: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00023730: 702e 7369 676e 2863 6329 202a 2028 7970  p.sign(cc) * (yp
+00023740: 7473 5b69 5d20 2d20 7970 7473 5b69 202b  ts[i] - ypts[i +
+00023750: 2031 5d29 2c0a 2020 2020 2020 2020 2020   1]),.          
+00023760: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00023770: 2a20 3138 300a 2020 2020 2020 2020 2020  * 180.          
+00023780: 2020 2f20 7069 0a20 2020 2020 2020 2029    / pi.        )
+00023790: 0a20 2020 2020 2020 2077 6964 7468 5f6e  .        width_n
+000237a0: 203d 206e 702e 6162 7328 0a20 2020 2020   = np.abs(.     
+000237b0: 2020 2020 2020 2073 7172 7428 2878 7074         sqrt((xpt
+000237c0: 735b 6920 2b20 315d 202d 2078 7074 735b  s[i + 1] - xpts[
+000237d0: 695d 2920 2a2a 2032 202b 2028 7970 7473  i]) ** 2 + (ypts
+000237e0: 5b69 202b 2031 5d20 2d20 7970 7473 5b69  [i + 1] - ypts[i
+000237f0: 5d29 202a 2a20 3229 0a20 2020 2020 2020  ]) ** 2).       
+00023800: 2029 0a20 2020 2020 2020 2050 2e61 6464   ).        P.add
+00023810: 5f70 6f72 7428 0a20 2020 2020 2020 2020  _port(.         
+00023820: 2020 206e 616d 653d 7374 7228 6920 2b20     name=str(i + 
+00023830: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
+00023840: 6d69 6470 6f69 6e74 3d6d 6964 706f 696e  midpoint=midpoin
+00023850: 745f 6e2c 0a20 2020 2020 2020 2020 2020  t_n,.           
+00023860: 2077 6964 7468 3d77 6964 7468 5f6e 2c0a   width=width_n,.
+00023870: 2020 2020 2020 2020 2020 2020 6f72 6965              orie
+00023880: 6e74 6174 696f 6e3d 6f72 6965 6e74 6174  ntation=orientat
+00023890: 696f 6e5f 6e2c 0a20 2020 2020 2020 2029  ion_n,.        )
+000238a0: 0a0a 2020 2020 7265 7475 726e 2050 0a0a  ..    return P..
+000238b0: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
 000238c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 000238d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 000238e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 000238f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00023900: 3d3d 0a23 2045 7861 6d70 6c65 2063 6f64  ==.# Example cod
-00023910: 650a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  e.# ============
+00023900: 3d0a 2320 4578 616d 706c 6520 636f 6465  =.# Example code
+00023910: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
 00023920: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 00023930: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 00023940: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 00023950: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00023960: 3d3d 0a0a 2320 4720 3d20 6772 6174 696e  ==..# G = gratin
-00023970: 6728 6e75 6d5f 7065 7269 6f64 7320 3d20  g(num_periods = 
-00023980: 3230 2c20 7065 7269 6f64 203d 2030 2e37  20, period = 0.7
-00023990: 352c 2066 696c 6c5f 6661 6374 6f72 203d  5, fill_factor =
-000239a0: 2030 2e35 2c0a 2320 2020 2020 2020 2020   0.5,.#         
-000239b0: 2020 2020 7769 6474 685f 6772 6174 696e      width_gratin
-000239c0: 6720 3d20 3230 2c20 6c65 6e67 7468 5f74  g = 20, length_t
-000239d0: 6170 6572 203d 2031 302c 2077 6964 7468  aper = 10, width
-000239e0: 203d 2030 2e34 2c0a 2320 2020 2020 2020   = 0.4,.#       
-000239f0: 2020 2020 2020 7061 7274 6961 6c5f 6574        partial_et
-00023a00: 6368 203d 2046 616c 7365 290a 2320 7175  ch = False).# qu
-00023a10: 6963 6b70 6c6f 7428 4729 0a0a 0a23 203d  ickplot(G)...# =
-00023a20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00023a30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00023a40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00023a50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00023a60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 230a  =============.#.
-00023a70: 2320 5465 7374 2053 7472 7563 7475 7265  # Test Structure
-00023a80: 730a 230a 2320 3d3d 3d3d 3d3d 3d3d 3d3d  s.#.# ==========
-00023a90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00023aa0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00023ab0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00023ac0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00023ad0: 3d3d 3d3d 0a0a 0a23 2056 6961 2052 6f75  ====...# Via Rou
-00023ae0: 7465 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  te -------------
-00023af0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00023b00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 6465 6620  -----------.def 
-00023b10: 5f76 6961 5f69 7465 7261 626c 6528 0a20  _via_iterable(. 
-00023b20: 2020 2076 6961 5f73 7061 6369 6e67 2c20     via_spacing, 
-00023b30: 7769 7265 5f77 6964 7468 2c20 7769 7269  wire_width, wiri
-00023b40: 6e67 315f 6c61 7965 722c 2077 6972 696e  ng1_layer, wirin
-00023b50: 6732 5f6c 6179 6572 2c20 7669 615f 6c61  g2_layer, via_la
-00023b60: 7965 722c 2076 6961 5f77 6964 7468 0a29  yer, via_width.)
-00023b70: 3a0a 2020 2020 2222 2248 656c 7065 7220  :.    """Helper 
-00023b80: 6675 6e63 7469 6f6e 2066 6f72 2074 6573  function for tes
-00023b90: 745f 7669 610a 0a20 2020 2050 6172 616d  t_via..    Param
-00023ba0: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
-00023bb0: 2d2d 2d2d 0a20 2020 2076 6961 5f73 7061  ----.    via_spa
-00023bc0: 6369 6e67 203a 2069 6e74 206f 7220 666c  cing : int or fl
-00023bd0: 6f61 740a 2020 2020 2020 2020 4469 7374  oat.        Dist
-00023be0: 616e 6365 2062 6574 7765 656e 2076 6961  ance between via
-00023bf0: 732e 0a20 2020 2077 6972 655f 7769 6474  s..    wire_widt
-00023c00: 6820 3a20 696e 7420 6f72 2066 6c6f 6174  h : int or float
-00023c10: 0a20 2020 2020 2020 2054 6865 2077 6964  .        The wid
-00023c20: 7468 206f 6620 7468 6520 7769 7265 732e  th of the wires.
-00023c30: 0a20 2020 2077 6972 696e 6731 5f6c 6179  .    wiring1_lay
-00023c40: 6572 203a 2069 6e74 0a20 2020 2020 2020  er : int.       
-00023c50: 2053 7065 6369 6669 6320 6c61 7965 7220   Specific layer 
-00023c60: 746f 2070 7574 2074 6865 2074 6f70 2077  to put the top w
-00023c70: 6972 696e 6720 6f6e 2e0a 2020 2020 7769  iring on..    wi
-00023c80: 7269 6e67 325f 6c61 7965 7220 3a20 696e  ring2_layer : in
-00023c90: 740a 2020 2020 2020 2020 5370 6563 6966  t.        Specif
-00023ca0: 6963 206c 6179 6572 2074 6f20 7075 7420  ic layer to put 
-00023cb0: 7468 6520 626f 7474 6f6d 2077 6972 696e  the bottom wirin
-00023cc0: 6720 6f6e 2e0a 2020 2020 7669 615f 6c61  g on..    via_la
-00023cd0: 7965 7220 3a20 696e 740a 2020 2020 2020  yer : int.      
-00023ce0: 2020 5370 6563 6966 6963 206c 6179 6572    Specific layer
-00023cf0: 2074 6f20 7075 7420 7468 6520 7669 6173   to put the vias
-00023d00: 206f 6e2e 0a20 2020 2076 6961 5f77 6964   on..    via_wid
-00023d10: 7468 203a 2069 6e74 206f 7220 666c 6f61  th : int or floa
-00023d20: 740a 2020 2020 2020 2020 4469 616d 6574  t.        Diamet
-00023d30: 6572 206f 6620 7468 6520 7669 6173 2e0a  er of the vias..
-00023d40: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
-00023d50: 202d 2d2d 2d2d 2d2d 0a20 2020 2056 4920   -------.    VI 
-00023d60: 3a20 4465 7669 6365 0a0a 2020 2020 2222  : Device..    ""
-00023d70: 220a 2020 2020 5649 203d 2044 6576 6963  ".    VI = Devic
-00023d80: 6528 2274 6573 745f 7669 615f 6974 6572  e("test_via_iter
-00023d90: 2229 0a20 2020 2077 6972 6531 203d 2056  ").    wire1 = V
-00023da0: 492e 6164 645f 7265 6628 636f 6d70 6173  I.add_ref(compas
-00023db0: 7328 7369 7a65 3d28 7669 615f 7370 6163  s(size=(via_spac
-00023dc0: 696e 672c 2077 6972 655f 7769 6474 6829  ing, wire_width)
-00023dd0: 2c20 6c61 7965 723d 7769 7269 6e67 315f  , layer=wiring1_
-00023de0: 6c61 7965 7229 290a 2020 2020 7769 7265  layer)).    wire
-00023df0: 3220 3d20 5649 2e61 6464 5f72 6566 2863  2 = VI.add_ref(c
-00023e00: 6f6d 7061 7373 2873 697a 653d 2876 6961  ompass(size=(via
-00023e10: 5f73 7061 6369 6e67 2c20 7769 7265 5f77  _spacing, wire_w
-00023e20: 6964 7468 292c 206c 6179 6572 3d77 6972  idth), layer=wir
-00023e30: 696e 6732 5f6c 6179 6572 2929 0a20 2020  ing2_layer)).   
-00023e40: 2076 6961 3120 3d20 5649 2e61 6464 5f72   via1 = VI.add_r
-00023e50: 6566 2863 6f6d 7061 7373 2873 697a 653d  ef(compass(size=
-00023e60: 2876 6961 5f77 6964 7468 2c20 7669 615f  (via_width, via_
-00023e70: 7769 6474 6829 2c20 6c61 7965 723d 7669  width), layer=vi
-00023e80: 615f 6c61 7965 7229 290a 2020 2020 7669  a_layer)).    vi
-00023e90: 6132 203d 2056 492e 6164 645f 7265 6628  a2 = VI.add_ref(
-00023ea0: 636f 6d70 6173 7328 7369 7a65 3d28 7669  compass(size=(vi
-00023eb0: 615f 7769 6474 682c 2076 6961 5f77 6964  a_width, via_wid
-00023ec0: 7468 292c 206c 6179 6572 3d76 6961 5f6c  th), layer=via_l
-00023ed0: 6179 6572 2929 0a20 2020 2077 6972 6531  ayer)).    wire1
-00023ee0: 2e63 6f6e 6e65 6374 2870 6f72 743d 2245  .connect(port="E
-00023ef0: 222c 2064 6573 7469 6e61 7469 6f6e 3d77  ", destination=w
-00023f00: 6972 6532 2e70 6f72 7473 5b22 5722 5d2c  ire2.ports["W"],
-00023f10: 206f 7665 726c 6170 3d77 6972 655f 7769   overlap=wire_wi
-00023f20: 6474 6829 0a20 2020 2076 6961 312e 636f  dth).    via1.co
-00023f30: 6e6e 6563 7428 0a20 2020 2020 2020 2070  nnect(.        p
-00023f40: 6f72 743d 2257 222c 2064 6573 7469 6e61  ort="W", destina
-00023f50: 7469 6f6e 3d77 6972 6531 2e70 6f72 7473  tion=wire1.ports
-00023f60: 5b22 4522 5d2c 206f 7665 726c 6170 3d28  ["E"], overlap=(
-00023f70: 7769 7265 5f77 6964 7468 202b 2076 6961  wire_width + via
-00023f80: 5f77 6964 7468 2920 2f20 320a 2020 2020  _width) / 2.    
-00023f90: 290a 2020 2020 7669 6132 2e63 6f6e 6e65  ).    via2.conne
-00023fa0: 6374 280a 2020 2020 2020 2020 706f 7274  ct(.        port
-00023fb0: 3d22 5722 2c20 6465 7374 696e 6174 696f  ="W", destinatio
-00023fc0: 6e3d 7769 7265 322e 706f 7274 735b 2245  n=wire2.ports["E
-00023fd0: 225d 2c20 6f76 6572 6c61 703d 2877 6972  "], overlap=(wir
-00023fe0: 655f 7769 6474 6820 2b20 7669 615f 7769  e_width + via_wi
-00023ff0: 6474 6829 202f 2032 0a20 2020 2029 0a20  dth) / 2.    ). 
-00024000: 2020 2056 492e 6164 645f 706f 7274 286e     VI.add_port(n
-00024010: 616d 653d 2257 222c 2070 6f72 743d 7769  ame="W", port=wi
-00024020: 7265 312e 706f 7274 735b 2257 225d 290a  re1.ports["W"]).
-00024030: 2020 2020 5649 2e61 6464 5f70 6f72 7428      VI.add_port(
-00024040: 6e61 6d65 3d22 4522 2c20 706f 7274 3d77  name="E", port=w
-00024050: 6972 6532 2e70 6f72 7473 5b22 4522 5d29  ire2.ports["E"])
-00024060: 0a20 2020 2056 492e 6164 645f 706f 7274  .    VI.add_port
-00024070: 280a 2020 2020 2020 2020 6e61 6d65 3d22  (.        name="
-00024080: 5322 2c0a 2020 2020 2020 2020 6d69 6470  S",.        midp
-00024090: 6f69 6e74 3d5b 2831 202a 2077 6972 655f  oint=[(1 * wire_
-000240a0: 7769 6474 6829 202b 2077 6972 655f 7769  width) + wire_wi
-000240b0: 6474 6820 2f20 322c 202d 7769 7265 5f77  dth / 2, -wire_w
-000240c0: 6964 7468 202f 2032 5d2c 0a20 2020 2020  idth / 2],.     
-000240d0: 2020 2077 6964 7468 3d77 6972 655f 7769     width=wire_wi
-000240e0: 6474 682c 0a20 2020 2020 2020 206f 7269  dth,.        ori
-000240f0: 656e 7461 7469 6f6e 3d2d 3930 2c0a 2020  entation=-90,.  
-00024100: 2020 290a 2020 2020 5649 2e61 6464 5f70    ).    VI.add_p
-00024110: 6f72 7428 0a20 2020 2020 2020 206e 616d  ort(.        nam
-00024120: 653d 224e 222c 0a20 2020 2020 2020 206d  e="N",.        m
-00024130: 6964 706f 696e 743d 5b28 3120 2a20 7769  idpoint=[(1 * wi
-00024140: 7265 5f77 6964 7468 2920 2b20 7769 7265  re_width) + wire
-00024150: 5f77 6964 7468 202f 2032 2c20 7769 7265  _width / 2, wire
-00024160: 5f77 6964 7468 202f 2032 5d2c 0a20 2020  _width / 2],.   
-00024170: 2020 2020 2077 6964 7468 3d77 6972 655f       width=wire_
-00024180: 7769 6474 682c 0a20 2020 2020 2020 206f  width,.        o
-00024190: 7269 656e 7461 7469 6f6e 3d39 302c 0a20  rientation=90,. 
-000241a0: 2020 2029 0a0a 2020 2020 7265 7475 726e     )..    return
-000241b0: 2056 490a 0a0a 6465 6620 7465 7374 5f76   VI...def test_v
-000241c0: 6961 280a 2020 2020 6e75 6d5f 7669 6173  ia(.    num_vias
-000241d0: 3d31 3030 2c0a 2020 2020 7769 7265 5f77  =100,.    wire_w
-000241e0: 6964 7468 3d31 302c 0a20 2020 2076 6961  idth=10,.    via
-000241f0: 5f77 6964 7468 3d31 352c 0a20 2020 2076  _width=15,.    v
-00024200: 6961 5f73 7061 6369 6e67 3d34 302c 0a20  ia_spacing=40,. 
-00024210: 2020 2070 6164 5f73 697a 653d 2833 3030     pad_size=(300
-00024220: 2c20 3330 3029 2c0a 2020 2020 6d69 6e5f  , 300),.    min_
-00024230: 7061 645f 7370 6163 696e 673d 302c 0a20  pad_spacing=0,. 
-00024240: 2020 2070 6164 5f6c 6179 6572 3d30 2c0a     pad_layer=0,.
-00024250: 2020 2020 7769 7269 6e67 315f 6c61 7965      wiring1_laye
-00024260: 723d 312c 0a20 2020 2077 6972 696e 6732  r=1,.    wiring2
-00024270: 5f6c 6179 6572 3d32 2c0a 2020 2020 7669  _layer=2,.    vi
-00024280: 615f 6c61 7965 723d 332c 0a29 3a0a 2020  a_layer=3,.):.  
-00024290: 2020 2222 2256 6961 2063 6861 696e 2074    """Via chain t
-000242a0: 6573 7420 7374 7275 6374 7572 650a 0a20  est structure.. 
-000242b0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-000242c0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-000242d0: 206e 756d 5f76 6961 7320 3a20 696e 740a   num_vias : int.
-000242e0: 2020 2020 2020 2020 5468 6520 746f 7461          The tota
-000242f0: 6c20 6e75 6d62 6572 206f 6620 7265 7175  l number of requ
-00024300: 6573 7465 6420 7669 6173 2028 6d75 7374  ested vias (must
-00024310: 2062 6520 616e 2065 7665 6e20 6e75 6d62   be an even numb
-00024320: 6572 292e 0a20 2020 2077 6972 655f 7769  er)..    wire_wi
-00024330: 6474 6820 3a20 696e 7420 6f72 2066 6c6f  dth : int or flo
-00024340: 6174 0a20 2020 2020 2020 2054 6865 2077  at.        The w
-00024350: 6964 7468 206f 6620 7468 6520 7769 7265  idth of the wire
-00024360: 732e 0a20 2020 2076 6961 5f77 6964 7468  s..    via_width
-00024370: 203a 2069 6e74 206f 7220 666c 6f61 740a   : int or float.
-00024380: 2020 2020 2020 2020 4469 616d 6574 6572          Diameter
-00024390: 206f 6620 7468 6520 7669 6173 2e0a 2020   of the vias..  
-000243a0: 2020 7669 615f 7370 6163 696e 6720 3a20    via_spacing : 
-000243b0: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
-000243c0: 2020 2020 2044 6973 7461 6e63 6520 6265       Distance be
-000243d0: 7477 6565 6e20 7669 6173 2e0a 2020 2020  tween vias..    
-000243e0: 7061 645f 7369 7a65 203a 2061 7272 6179  pad_size : array
-000243f0: 2d6c 696b 655b 325d 0a20 2020 2020 2020  -like[2].       
-00024400: 2028 7769 6474 682c 2068 6569 6768 7429   (width, height)
-00024410: 206f 6620 7468 6520 7061 6473 2e0a 2020   of the pads..  
-00024420: 2020 6d69 6e5f 7061 645f 7370 6163 696e    min_pad_spacin
-00024430: 6720 3a20 696e 7420 6f72 2066 6c6f 6174  g : int or float
-00024440: 0a20 2020 2020 2020 2044 6566 696e 6573  .        Defines
-00024450: 2074 6865 206d 696e 696d 756d 2064 6973   the minimum dis
-00024460: 7461 6e63 6520 6265 7477 6565 6e20 7468  tance between th
-00024470: 6520 7477 6f20 7061 6473 2e0a 2020 2020  e two pads..    
-00024480: 7061 645f 6c61 7965 7220 3a20 696e 740a  pad_layer : int.
-00024490: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
-000244a0: 206c 6179 6572 2074 6f20 7075 7420 7468   layer to put th
-000244b0: 6520 7061 6473 206f 6e2e 0a20 2020 2077  e pads on..    w
-000244c0: 6972 696e 6731 5f6c 6179 6572 203a 2069  iring1_layer : i
-000244d0: 6e74 0a20 2020 2020 2020 2053 7065 6369  nt.        Speci
-000244e0: 6669 6320 6c61 7965 7220 746f 2070 7574  fic layer to put
-000244f0: 2074 6865 2074 6f70 2077 6972 696e 6720   the top wiring 
-00024500: 6f6e 2e0a 2020 2020 7769 7269 6e67 325f  on..    wiring2_
-00024510: 6c61 7965 7220 3a20 696e 740a 2020 2020  layer : int.    
-00024520: 2020 2020 5370 6563 6966 6963 206c 6179      Specific lay
-00024530: 6572 2074 6f20 7075 7420 7468 6520 626f  er to put the bo
-00024540: 7474 6f6d 2077 6972 696e 6720 6f6e 2e0a  ttom wiring on..
-00024550: 2020 2020 7669 615f 6c61 7965 7220 3a20      via_layer : 
-00024560: 696e 740a 2020 2020 2020 2020 5370 6563  int.        Spec
-00024570: 6966 6963 206c 6179 6572 2074 6f20 7075  ific layer to pu
-00024580: 7420 7468 6520 7669 6173 206f 6e2e 0a0a  t the vias on...
-00024590: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-000245a0: 2d2d 2d2d 2d2d 2d0a 2020 2020 5652 203a  -------.    VR :
-000245b0: 2044 6576 6963 650a 2020 2020 2020 2020   Device.        
-000245c0: 4120 4465 7669 6365 2063 6f6e 7461 696e  A Device contain
-000245d0: 696e 6720 7468 6520 7465 7374 2076 6961  ing the test via
-000245e0: 2073 7472 7563 7475 7265 732e 0a0a 2020   structures...  
-000245f0: 2020 5573 6167 650a 2020 2020 2d2d 2d2d    Usage.    ----
-00024600: 2d0a 2020 2020 4361 6c6c 2076 6961 5f72  -.    Call via_r
-00024610: 6f75 7465 5f74 6573 745f 7374 7275 6374  oute_test_struct
-00024620: 7572 6528 2920 6279 2069 6e64 6963 6174  ure() by indicat
-00024630: 696e 6720 7468 6520 6e75 6d62 6572 206f  ing the number o
-00024640: 6620 7669 6173 2079 6f75 2077 616e 740a  f vias you want.
-00024650: 2020 2020 6472 6177 6e2e 2059 6f75 2063      drawn. You c
-00024660: 616e 2061 6c73 6f20 6368 616e 6765 2074  an also change t
-00024670: 6865 206f 7468 6572 2070 6172 616d 6574  he other paramet
-00024680: 6572 7320 686f 7765 7665 7220 6966 2079  ers however if y
-00024690: 6f75 2064 6f20 6e6f 740a 2020 2020 7370  ou do not.    sp
-000246a0: 6563 6966 6979 2061 2076 616c 7565 2066  ecifiy a value f
-000246b0: 6f72 2061 2070 6172 616d 6574 6572 2069  or a parameter i
-000246c0: 7420 7769 6c6c 206a 7573 7420 7573 6520  t will just use 
-000246d0: 7468 6520 6465 6661 756c 7420 7661 6c75  the default valu
-000246e0: 650a 2020 2020 4578 3a3a 0a0a 2020 2020  e.    Ex::..    
-000246f0: 2020 2020 7669 615f 726f 7574 655f 7465      via_route_te
-00024700: 7374 5f73 7472 7563 7475 7265 286e 756d  st_structure(num
-00024710: 5f76 6961 733d 3534 290a 0a20 2020 202d  _vias=54)..    -
-00024720: 206f 7220 2d3a 3a0a 0a20 2020 2020 2020   or -::..       
-00024730: 2076 6961 5f72 6f75 7465 5f74 6573 745f   via_route_test_
-00024740: 7374 7275 6374 7572 6528 6e75 6d5f 7669  structure(num_vi
-00024750: 6173 3d31 322c 2070 6164 5f73 697a 653d  as=12, pad_size=
-00024760: 2831 3030 2c31 3030 292c 7769 7265 5f77  (100,100),wire_w
-00024770: 6964 7468 3d38 290a 0a20 2020 2065 783a  idth=8)..    ex:
-00024780: 2076 6961 5f72 6f75 7465 2835 342c 206d   via_route(54, m
-00024790: 696e 5f70 6164 5f73 7061 6369 6e67 3d33  in_pad_spacing=3
-000247a0: 3030 290a 2020 2020 2222 220a 2020 2020  00).    """.    
-000247b0: 5652 203d 2044 6576 6963 6528 2274 6573  VR = Device("tes
-000247c0: 745f 7669 6122 290a 2020 2020 7061 6431  t_via").    pad1
-000247d0: 203d 2056 522e 6164 645f 7265 6628 7265   = VR.add_ref(re
-000247e0: 6374 616e 676c 6528 7369 7a65 3d70 6164  ctangle(size=pad
-000247f0: 5f73 697a 652c 206c 6179 6572 3d70 6164  _size, layer=pad
-00024800: 5f6c 6179 6572 2929 0a20 2020 2070 6164  _layer)).    pad
-00024810: 315f 6f76 6572 6c61 7920 3d20 5652 2e61  1_overlay = VR.a
-00024820: 6464 5f72 6566 2872 6563 7461 6e67 6c65  dd_ref(rectangle
-00024830: 2873 697a 653d 7061 645f 7369 7a65 2c20  (size=pad_size, 
-00024840: 6c61 7965 723d 7769 7269 6e67 315f 6c61  layer=wiring1_la
-00024850: 7965 7229 290a 2020 2020 7061 6432 203d  yer)).    pad2 =
-00024860: 2056 522e 6164 645f 7265 6628 7265 6374   VR.add_ref(rect
-00024870: 616e 676c 6528 7369 7a65 3d70 6164 5f73  angle(size=pad_s
-00024880: 697a 652c 206c 6179 6572 3d70 6164 5f6c  ize, layer=pad_l
-00024890: 6179 6572 2929 0a20 2020 2070 6164 325f  ayer)).    pad2_
-000248a0: 6f76 6572 6c61 7920 3d20 5652 2e61 6464  overlay = VR.add
-000248b0: 5f72 6566 2872 6563 7461 6e67 6c65 2873  _ref(rectangle(s
-000248c0: 697a 653d 7061 645f 7369 7a65 2c20 6c61  ize=pad_size, la
-000248d0: 7965 723d 7769 7269 6e67 315f 6c61 7965  yer=wiring1_laye
-000248e0: 7229 290a 2020 2020 6e75 6220 3d20 5652  r)).    nub = VR
-000248f0: 2e61 6464 5f72 6566 2863 6f6d 7061 7373  .add_ref(compass
-00024900: 2873 697a 653d 2833 202a 2077 6972 655f  (size=(3 * wire_
-00024910: 7769 6474 682c 2077 6972 655f 7769 6474  width, wire_widt
-00024920: 6829 2c20 6c61 7965 723d 7061 645f 6c61  h), layer=pad_la
-00024930: 7965 7229 290a 2020 2020 6e75 625f 6f76  yer)).    nub_ov
-00024940: 6572 6c61 7920 3d20 5652 2e61 6464 5f72  erlay = VR.add_r
-00024950: 6566 280a 2020 2020 2020 2020 636f 6d70  ef(.        comp
-00024960: 6173 7328 7369 7a65 3d28 3320 2a20 7769  ass(size=(3 * wi
-00024970: 7265 5f77 6964 7468 2c20 7769 7265 5f77  re_width, wire_w
-00024980: 6964 7468 292c 206c 6179 6572 3d77 6972  idth), layer=wir
-00024990: 696e 6731 5f6c 6179 6572 290a 2020 2020  ing1_layer).    
-000249a0: 290a 2020 2020 6865 6164 203d 2056 522e  ).    head = VR.
-000249b0: 6164 645f 7265 6628 636f 6d70 6173 7328  add_ref(compass(
-000249c0: 7369 7a65 3d28 7769 7265 5f77 6964 7468  size=(wire_width
-000249d0: 2c20 7769 7265 5f77 6964 7468 292c 206c  , wire_width), l
-000249e0: 6179 6572 3d70 6164 5f6c 6179 6572 2929  ayer=pad_layer))
-000249f0: 0a20 2020 2068 6561 645f 6f76 6572 6c61  .    head_overla
-00024a00: 7920 3d20 5652 2e61 6464 5f72 6566 280a  y = VR.add_ref(.
-00024a10: 2020 2020 2020 2020 636f 6d70 6173 7328          compass(
-00024a20: 7369 7a65 3d28 7769 7265 5f77 6964 7468  size=(wire_width
-00024a30: 2c20 7769 7265 5f77 6964 7468 292c 206c  , wire_width), l
-00024a40: 6179 6572 3d77 6972 696e 6731 5f6c 6179  ayer=wiring1_lay
-00024a50: 6572 290a 2020 2020 290a 2020 2020 6e75  er).    ).    nu
-00024a60: 622e 796d 6178 203d 2070 6164 312e 796d  b.ymax = pad1.ym
-00024a70: 6178 202d 2035 0a20 2020 206e 7562 2e78  ax - 5.    nub.x
-00024a80: 6d69 6e20 3d20 7061 6431 2e78 6d61 780a  min = pad1.xmax.
-00024a90: 2020 2020 6e75 625f 6f76 6572 6c61 792e      nub_overlay.
-00024aa0: 796d 6178 203d 2070 6164 312e 796d 6178  ymax = pad1.ymax
-00024ab0: 202d 2035 0a20 2020 206e 7562 5f6f 7665   - 5.    nub_ove
-00024ac0: 726c 6179 2e78 6d69 6e20 3d20 7061 6431  rlay.xmin = pad1
-00024ad0: 2e78 6d61 780a 2020 2020 6865 6164 2e63  .xmax.    head.c
-00024ae0: 6f6e 6e65 6374 2870 6f72 743d 2257 222c  onnect(port="W",
-00024af0: 2064 6573 7469 6e61 7469 6f6e 3d6e 7562   destination=nub
-00024b00: 2e70 6f72 7473 5b22 4522 5d29 0a20 2020  .ports["E"]).   
-00024b10: 2068 6561 645f 6f76 6572 6c61 792e 636f   head_overlay.co
-00024b20: 6e6e 6563 7428 706f 7274 3d22 5722 2c20  nnect(port="W", 
-00024b30: 6465 7374 696e 6174 696f 6e3d 6e75 625f  destination=nub_
-00024b40: 6f76 6572 6c61 792e 706f 7274 735b 2245  overlay.ports["E
-00024b50: 225d 290a 2020 2020 7061 6431 5f6f 7665  "]).    pad1_ove
-00024b60: 726c 6179 2e78 6d69 6e20 3d20 7061 6431  rlay.xmin = pad1
-00024b70: 2e78 6d69 6e0a 2020 2020 7061 6431 5f6f  .xmin.    pad1_o
-00024b80: 7665 726c 6179 2e79 6d69 6e20 3d20 7061  verlay.ymin = pa
-00024b90: 6431 2e79 6d69 6e0a 0a20 2020 206f 6c64  d1.ymin..    old
-00024ba0: 5f70 6f72 7420 3d20 6865 6164 2e70 6f72  _port = head.por
-00024bb0: 7473 5b22 5322 5d0a 2020 2020 636f 756e  ts["S"].    coun
-00024bc0: 7420 3d20 300a 2020 2020 7769 6474 685f  t = 0.    width_
-00024bd0: 7669 615f 6974 6572 203d 2032 202a 2076  via_iter = 2 * v
-00024be0: 6961 5f73 7061 6369 6e67 202d 2032 202a  ia_spacing - 2 *
-00024bf0: 2077 6972 655f 7769 6474 680a 0a20 2020   wire_width..   
-00024c00: 2070 6164 322e 786d 696e 203d 2070 6164   pad2.xmin = pad
-00024c10: 312e 786d 6178 202b 206d 696e 5f70 6164  1.xmax + min_pad
-00024c20: 5f73 7061 6369 6e67 0a20 2020 2075 7020  _spacing.    up 
-00024c30: 3d20 4661 6c73 650a 2020 2020 646f 776e  = False.    down
-00024c40: 203d 2054 7275 650a 2020 2020 6564 6765   = True.    edge
-00024c50: 203d 2054 7275 650a 2020 2020 6375 7272   = True.    curr
-00024c60: 656e 745f 7769 6474 6820 3d20 3320 2a20  ent_width = 3 * 
-00024c70: 7769 7265 5f77 6964 7468 202b 2077 6972  wire_width + wir
-00024c80: 655f 7769 6474 6820 2023 2077 6964 7468  e_width  # width
-00024c90: 206f 6620 6e75 6220 616e 6420 3120 6f76   of nub and 1 ov
-00024ca0: 6572 6c61 700a 2020 2020 6f62 6a5f 6f6c  erlap.    obj_ol
-00024cb0: 6420 3d20 6865 6164 0a20 2020 206f 626a  d = head.    obj
-00024cc0: 203d 2068 6561 640a 2020 2020 7669 615f   = head.    via_
-00024cd0: 6974 6572 6162 6c65 203d 205f 7669 615f  iterable = _via_
-00024ce0: 6974 6572 6162 6c65 280a 2020 2020 2020  iterable(.      
-00024cf0: 2020 7669 615f 7370 6163 696e 672c 2077    via_spacing, w
-00024d00: 6972 655f 7769 6474 682c 2077 6972 696e  ire_width, wirin
-00024d10: 6731 5f6c 6179 6572 2c20 7769 7269 6e67  g1_layer, wiring
-00024d20: 325f 6c61 7965 722c 2076 6961 5f6c 6179  2_layer, via_lay
-00024d30: 6572 2c20 7669 615f 7769 6474 680a 2020  er, via_width.  
-00024d40: 2020 290a 2020 2020 7768 696c 6520 2863    ).    while (c
-00024d50: 6f75 6e74 202b 2032 2920 3c3d 206e 756d  ount + 2) <= num
-00024d60: 5f76 6961 733a 0a20 2020 2020 2020 206f  _vias:.        o
-00024d70: 626a 203d 2056 522e 6164 645f 7265 6628  bj = VR.add_ref(
-00024d80: 7669 615f 6974 6572 6162 6c65 290a 2020  via_iterable).  
-00024d90: 2020 2020 2020 6f62 6a2e 636f 6e6e 6563        obj.connec
-00024da0: 7428 706f 7274 3d22 5722 2c20 6465 7374  t(port="W", dest
-00024db0: 696e 6174 696f 6e3d 6f6c 645f 706f 7274  ination=old_port
-00024dc0: 2c20 6f76 6572 6c61 703d 7769 7265 5f77  , overlap=wire_w
-00024dd0: 6964 7468 290a 2020 2020 2020 2020 6f6c  idth).        ol
-00024de0: 645f 706f 7274 203d 206f 626a 2e70 6f72  d_port = obj.por
-00024df0: 7473 5b22 4522 5d0a 2020 2020 2020 2020  ts["E"].        
-00024e00: 6564 6765 203d 2046 616c 7365 0a20 2020  edge = False.   
-00024e10: 2020 2020 2069 6620 6f62 6a2e 796d 6178       if obj.ymax
-00024e20: 203e 2070 6164 312e 796d 6178 3a0a 2020   > pad1.ymax:.  
-00024e30: 2020 2020 2020 2020 2020 6f62 6a2e 636f            obj.co
-00024e40: 6e6e 6563 7428 706f 7274 3d22 5722 2c20  nnect(port="W", 
-00024e50: 6465 7374 696e 6174 696f 6e3d 6f62 6a5f  destination=obj_
-00024e60: 6f6c 642e 706f 7274 735b 2253 225d 2c20  old.ports["S"], 
-00024e70: 6f76 6572 6c61 703d 7769 7265 5f77 6964  overlap=wire_wid
-00024e80: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
-00024e90: 6f6c 645f 706f 7274 203d 206f 626a 2e70  old_port = obj.p
-00024ea0: 6f72 7473 5b22 5322 5d0a 2020 2020 2020  orts["S"].      
-00024eb0: 2020 2020 2020 6375 7272 656e 745f 7769        current_wi
-00024ec0: 6474 6820 2b3d 2077 6964 7468 5f76 6961  dth += width_via
-00024ed0: 5f69 7465 720a 2020 2020 2020 2020 2020  _iter.          
-00024ee0: 2020 646f 776e 203d 2054 7275 650a 2020    down = True.  
-00024ef0: 2020 2020 2020 2020 2020 7570 203d 2046            up = F
-00024f00: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
-00024f10: 2065 6467 6520 3d20 5472 7565 0a0a 2020   edge = True..  
-00024f20: 2020 2020 2020 656c 6966 206f 626a 2e79        elif obj.y
-00024f30: 6d69 6e20 3c20 7061 6431 2e79 6d69 6e3a  min < pad1.ymin:
-00024f40: 0a20 2020 2020 2020 2020 2020 206f 626a  .            obj
-00024f50: 2e63 6f6e 6e65 6374 2870 6f72 743d 2257  .connect(port="W
-00024f60: 222c 2064 6573 7469 6e61 7469 6f6e 3d6f  ", destination=o
-00024f70: 626a 5f6f 6c64 2e70 6f72 7473 5b22 4e22  bj_old.ports["N"
-00024f80: 5d2c 206f 7665 726c 6170 3d77 6972 655f  ], overlap=wire_
-00024f90: 7769 6474 6829 0a20 2020 2020 2020 2020  width).         
-00024fa0: 2020 206f 6c64 5f70 6f72 7420 3d20 6f62     old_port = ob
-00024fb0: 6a2e 706f 7274 735b 224e 225d 0a20 2020  j.ports["N"].   
-00024fc0: 2020 2020 2020 2020 2063 7572 7265 6e74           current
-00024fd0: 5f77 6964 7468 202b 3d20 7769 6474 685f  _width += width_
-00024fe0: 7669 615f 6974 6572 0a20 2020 2020 2020  via_iter.       
-00024ff0: 2020 2020 2075 7020 3d20 5472 7565 0a20       up = True. 
-00025000: 2020 2020 2020 2020 2020 2064 6f77 6e20             down 
-00025010: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-00025020: 2020 2020 6564 6765 203d 2054 7275 650a      edge = True.
-00025030: 2020 2020 2020 2020 636f 756e 7420 3d20          count = 
-00025040: 636f 756e 7420 2b20 320a 2020 2020 2020  count + 2.      
-00025050: 2020 6f62 6a5f 6f6c 6420 3d20 6f62 6a0a    obj_old = obj.
-00025060: 0a20 2020 2069 6620 280a 2020 2020 2020  .    if (.      
-00025070: 2020 6375 7272 656e 745f 7769 6474 6820    current_width 
-00025080: 3c20 6d69 6e5f 7061 645f 7370 6163 696e  < min_pad_spacin
-00025090: 670a 2020 2020 2020 2020 616e 6420 286d  g.        and (m
-000250a0: 696e 5f70 6164 5f73 7061 6369 6e67 202d  in_pad_spacing -
-000250b0: 2063 7572 7265 6e74 5f77 6964 7468 2920   current_width) 
-000250c0: 3e20 3320 2a20 7769 7265 5f77 6964 7468  > 3 * wire_width
-000250d0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-000250e0: 7461 696c 203d 2056 522e 6164 645f 7265  tail = VR.add_re
-000250f0: 6628 0a20 2020 2020 2020 2020 2020 2063  f(.            c
-00025100: 6f6d 7061 7373 280a 2020 2020 2020 2020  ompass(.        
-00025110: 2020 2020 2020 2020 7369 7a65 3d28 6d69          size=(mi
-00025120: 6e5f 7061 645f 7370 6163 696e 6720 2d20  n_pad_spacing - 
-00025130: 6375 7272 656e 745f 7769 6474 6820 2b20  current_width + 
-00025140: 7769 7265 5f77 6964 7468 2c20 7769 7265  wire_width, wire
-00025150: 5f77 6964 7468 292c 0a20 2020 2020 2020  _width),.       
-00025160: 2020 2020 2020 2020 206c 6179 6572 3d77           layer=w
-00025170: 6972 696e 6731 5f6c 6179 6572 2c0a 2020  iring1_layer,.  
-00025180: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00025190: 2020 2020 290a 2020 2020 2020 2020 7461      ).        ta
-000251a0: 696c 5f6f 7665 726c 6179 203d 2056 522e  il_overlay = VR.
-000251b0: 6164 645f 7265 6628 0a20 2020 2020 2020  add_ref(.       
-000251c0: 2020 2020 2063 6f6d 7061 7373 280a 2020       compass(.  
-000251d0: 2020 2020 2020 2020 2020 2020 2020 7369                si
-000251e0: 7a65 3d28 6d69 6e5f 7061 645f 7370 6163  ze=(min_pad_spac
-000251f0: 696e 6720 2d20 6375 7272 656e 745f 7769  ing - current_wi
-00025200: 6474 6820 2b20 7769 7265 5f77 6964 7468  dth + wire_width
-00025210: 2c20 7769 7265 5f77 6964 7468 292c 0a20  , wire_width),. 
-00025220: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00025230: 6179 6572 3d70 6164 5f6c 6179 6572 2c0a  ayer=pad_layer,.
-00025240: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00025250: 2020 2020 2020 290a 2020 2020 656c 7365        ).    else
-00025260: 3a0a 2020 2020 2020 2020 7461 696c 203d  :.        tail =
-00025270: 2056 522e 6164 645f 7265 6628 0a20 2020   VR.add_ref(.   
-00025280: 2020 2020 2020 2020 2063 6f6d 7061 7373           compass
-00025290: 2873 697a 653d 2833 202a 2077 6972 655f  (size=(3 * wire_
-000252a0: 7769 6474 682c 2077 6972 655f 7769 6474  width, wire_widt
-000252b0: 6829 2c20 6c61 7965 723d 7769 7269 6e67  h), layer=wiring
-000252c0: 315f 6c61 7965 7229 0a20 2020 2020 2020  1_layer).       
-000252d0: 2029 0a20 2020 2020 2020 2074 6169 6c5f   ).        tail_
-000252e0: 6f76 6572 6c61 7920 3d20 5652 2e61 6464  overlay = VR.add
-000252f0: 5f72 6566 280a 2020 2020 2020 2020 2020  _ref(.          
-00025300: 2020 636f 6d70 6173 7328 7369 7a65 3d28    compass(size=(
-00025310: 3320 2a20 7769 7265 5f77 6964 7468 2c20  3 * wire_width, 
-00025320: 7769 7265 5f77 6964 7468 292c 206c 6179  wire_width), lay
-00025330: 6572 3d77 6972 696e 6731 5f6c 6179 6572  er=wiring1_layer
-00025340: 290a 2020 2020 2020 2020 290a 0a20 2020  ).        )..   
-00025350: 2069 6620 7570 2061 6e64 206e 6f74 2065   if up and not e
-00025360: 6467 653a 0a20 2020 2020 2020 2074 6169  dge:.        tai
-00025370: 6c2e 636f 6e6e 6563 7428 706f 7274 3d22  l.connect(port="
-00025380: 5722 2c20 6465 7374 696e 6174 696f 6e3d  W", destination=
-00025390: 6f62 6a2e 706f 7274 735b 2253 225d 2c20  obj.ports["S"], 
-000253a0: 6f76 6572 6c61 703d 7769 7265 5f77 6964  overlap=wire_wid
-000253b0: 7468 290a 2020 2020 2020 2020 7461 696c  th).        tail
-000253c0: 5f6f 7665 726c 6179 2e63 6f6e 6e65 6374  _overlay.connect
-000253d0: 2870 6f72 743d 2257 222c 2064 6573 7469  (port="W", desti
-000253e0: 6e61 7469 6f6e 3d6f 626a 2e70 6f72 7473  nation=obj.ports
-000253f0: 5b22 5322 5d2c 206f 7665 726c 6170 3d77  ["S"], overlap=w
-00025400: 6972 655f 7769 6474 6829 0a20 2020 2065  ire_width).    e
-00025410: 6c69 6620 646f 776e 2061 6e64 206e 6f74  lif down and not
-00025420: 2065 6467 653a 0a20 2020 2020 2020 2074   edge:.        t
-00025430: 6169 6c2e 636f 6e6e 6563 7428 706f 7274  ail.connect(port
-00025440: 3d22 5722 2c20 6465 7374 696e 6174 696f  ="W", destinatio
-00025450: 6e3d 6f62 6a2e 706f 7274 735b 224e 225d  n=obj.ports["N"]
-00025460: 2c20 6f76 6572 6c61 703d 7769 7265 5f77  , overlap=wire_w
-00025470: 6964 7468 290a 2020 2020 2020 2020 7461  idth).        ta
-00025480: 696c 5f6f 7665 726c 6179 2e63 6f6e 6e65  il_overlay.conne
-00025490: 6374 2870 6f72 743d 2257 222c 2064 6573  ct(port="W", des
-000254a0: 7469 6e61 7469 6f6e 3d6f 626a 2e70 6f72  tination=obj.por
-000254b0: 7473 5b22 4e22 5d2c 206f 7665 726c 6170  ts["N"], overlap
-000254c0: 3d77 6972 655f 7769 6474 6829 0a20 2020  =wire_width).   
-000254d0: 2065 6c73 653a 0a20 2020 2020 2020 2074   else:.        t
-000254e0: 6169 6c2e 636f 6e6e 6563 7428 706f 7274  ail.connect(port
-000254f0: 3d22 5722 2c20 6465 7374 696e 6174 696f  ="W", destinatio
-00025500: 6e3d 6f62 6a2e 706f 7274 735b 2245 225d  n=obj.ports["E"]
-00025510: 2c20 6f76 6572 6c61 703d 7769 7265 5f77  , overlap=wire_w
-00025520: 6964 7468 290a 2020 2020 2020 2020 7461  idth).        ta
-00025530: 696c 5f6f 7665 726c 6179 2e63 6f6e 6e65  il_overlay.conne
-00025540: 6374 2870 6f72 743d 2257 222c 2064 6573  ct(port="W", des
-00025550: 7469 6e61 7469 6f6e 3d6f 626a 2e70 6f72  tination=obj.por
-00025560: 7473 5b22 4522 5d2c 206f 7665 726c 6170  ts["E"], overlap
-00025570: 3d77 6972 655f 7769 6474 6829 0a0a 2020  =wire_width)..  
-00025580: 2020 7061 6432 2e78 6d69 6e20 3d20 7461    pad2.xmin = ta
-00025590: 696c 2e78 6d61 780a 2020 2020 7061 6432  il.xmax.    pad2
-000255a0: 5f6f 7665 726c 6179 2e78 6d69 6e20 3d20  _overlay.xmin = 
-000255b0: 7061 6432 2e78 6d69 6e0a 2020 2020 7061  pad2.xmin.    pa
-000255c0: 6432 5f6f 7665 726c 6179 2e79 6d69 6e20  d2_overlay.ymin 
-000255d0: 3d20 7061 6432 2e79 6d69 6e0a 0a20 2020  = pad2.ymin..   
-000255e0: 2072 6574 7572 6e20 5652 0a0a 0a64 6566   return VR...def
-000255f0: 2074 6573 745f 636f 6d62 280a 2020 2020   test_comb(.    
-00025600: 7061 645f 7369 7a65 3d28 3230 302c 2032  pad_size=(200, 2
-00025610: 3030 292c 0a20 2020 2077 6972 655f 7769  00),.    wire_wi
-00025620: 6474 683d 312c 0a20 2020 2077 6972 655f  dth=1,.    wire_
-00025630: 6761 703d 332c 0a20 2020 2063 6f6d 625f  gap=3,.    comb_
-00025640: 6c61 7965 723d 302c 0a20 2020 206f 7665  layer=0,.    ove
-00025650: 726c 6170 5f7a 6967 7a61 675f 6c61 7965  rlap_zigzag_laye
-00025660: 723d 312c 0a20 2020 2063 6f6d 625f 7061  r=1,.    comb_pa
-00025670: 645f 6c61 7965 723d 322c 0a20 2020 2063  d_layer=2,.    c
-00025680: 6f6d 625f 676e 645f 6c61 7965 723d 332c  omb_gnd_layer=3,
-00025690: 0a20 2020 206f 7665 726c 6170 5f70 6164  .    overlap_pad
-000256a0: 5f6c 6179 6572 3d34 2c0a 293a 0a20 2020  _layer=4,.):.   
-000256b0: 2022 2222 4f76 6572 6c61 7020 636f 6d62   """Overlap comb
-000256c0: 2074 6573 7420 7374 7275 6374 7572 6520   test structure 
-000256d0: 666f 7220 6368 6563 6b69 6e67 2077 6865  for checking whe
-000256e0: 7468 6572 2074 776f 206c 6179 6572 730a  ther two layers.
-000256f0: 2020 2020 6172 6520 656c 6563 7472 6963      are electric
-00025700: 616c 6c79 2069 736f 6c61 7465 640a 0a20  ally isolated.. 
-00025710: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-00025720: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-00025730: 2070 6164 5f73 697a 6520 3a20 6172 7261   pad_size : arra
-00025740: 792d 6c69 6b65 0a20 2020 2020 2020 2078  y-like.        x
-00025750: 2061 6e64 2079 2064 696d 656e 7369 6f6e   and y dimension
-00025760: 7320 6f66 2074 6865 2063 6f6d 6220 7061  s of the comb pa
-00025770: 6473 2e0a 2020 2020 7769 7265 5f77 6964  ds..    wire_wid
-00025780: 7468 203a 2069 6e74 206f 7220 666c 6f61  th : int or floa
-00025790: 740a 2020 2020 2020 2020 5769 6474 6820  t.        Width 
-000257a0: 6f66 2074 6865 2074 6573 7420 636f 6d62  of the test comb
-000257b0: 2074 6565 7468 2e0a 2020 2020 7769 7265   teeth..    wire
-000257c0: 5f67 6170 203a 2069 6e74 206f 7220 666c  _gap : int or fl
-000257d0: 6f61 740a 2020 2020 2020 2020 5369 7a65  oat.        Size
-000257e0: 206f 6620 7468 6520 6761 7020 6265 7477   of the gap betw
-000257f0: 6565 6e20 636f 6d62 2074 6565 7468 2e0a  een comb teeth..
-00025800: 2020 2020 636f 6d62 5f6c 6179 6572 203a      comb_layer :
-00025810: 2069 6e74 2c20 6172 7261 792d 6c69 6b65   int, array-like
-00025820: 5b32 5d2c 206f 7220 7365 740a 2020 2020  [2], or set.    
-00025830: 2020 2020 5370 6563 6966 6963 206c 6179      Specific lay
-00025840: 6572 2873 2920 746f 2070 7574 2063 6f6d  er(s) to put com
-00025850: 6220 6765 6f6d 6574 7279 206f 6e2e 0a20  b geometry on.. 
-00025860: 2020 206f 7665 726c 6170 5f7a 6967 7a61     overlap_zigza
-00025870: 675f 6c61 7965 7220 3a20 696e 742c 2061  g_layer : int, a
-00025880: 7272 6179 2d6c 696b 655b 325d 2c20 6f72  rray-like[2], or
-00025890: 2073 6574 0a20 2020 2020 2020 2053 7065   set.        Spe
-000258a0: 6369 6669 6320 6c61 7965 7228 7329 2074  cific layer(s) t
-000258b0: 6f20 7075 7420 6f76 6572 6c61 7020 7a69  o put overlap zi
-000258c0: 677a 6167 2067 656f 6d65 7472 7920 6f6e  gzag geometry on
-000258d0: 2e0a 2020 2020 636f 6d62 5f70 6164 5f6c  ..    comb_pad_l
-000258e0: 6179 6572 203a 2069 6e74 2c20 6172 7261  ayer : int, arra
-000258f0: 792d 6c69 6b65 5b32 5d2c 206f 7220 7365  y-like[2], or se
-00025900: 740a 2020 2020 2020 2020 5370 6563 6966  t.        Specif
-00025910: 6963 206c 6179 6572 2873 2920 746f 2070  ic layer(s) to p
-00025920: 7574 2063 6f6d 6220 7061 6473 206f 6e2e  ut comb pads on.
-00025930: 0a20 2020 2063 6f6d 625f 676e 645f 6c61  .    comb_gnd_la
-00025940: 7965 7220 3a20 696e 742c 2061 7272 6179  yer : int, array
-00025950: 2d6c 696b 655b 325d 2c20 6f72 2073 6574  -like[2], or set
-00025960: 0a20 2020 2020 2020 2053 7065 6369 6669  .        Specifi
-00025970: 6320 6c61 7965 7228 7329 2074 6f20 7075  c layer(s) to pu
-00025980: 7420 7468 6520 636f 6d62 2067 726f 756e  t the comb groun
-00025990: 6420 6f6e 2e0a 2020 2020 6f76 6572 6c61  d on..    overla
-000259a0: 705f 7061 645f 6c61 7965 7220 3a20 696e  p_pad_layer : in
-000259b0: 742c 2061 7272 6179 2d6c 696b 655b 325d  t, array-like[2]
-000259c0: 2c20 6f72 2073 6574 0a20 2020 2020 2020  , or set.       
-000259d0: 2053 7065 6369 6669 6320 6c61 7965 7228   Specific layer(
-000259e0: 7329 2074 6f20 7075 7420 6f76 6572 6c61  s) to put overla
-000259f0: 7020 7061 6473 206f 6e2e 0a0a 2020 2020  p pads on...    
-00025a00: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
-00025a10: 2d2d 2d0a 2020 2020 4349 203a 2044 6576  ---.    CI : Dev
-00025a20: 6963 650a 2020 2020 2020 2020 4120 4465  ice.        A De
-00025a30: 7669 6365 2063 6f6e 7461 696e 696e 6720  vice containing 
-00025a40: 6120 7465 7374 2063 6f6d 6220 6765 6f6d  a test comb geom
-00025a50: 6574 7279 2e0a 0a20 2020 204e 6f74 6573  etry...    Notes
-00025a60: 0a20 2020 202d 2d2d 2d2d 0a20 2020 2043  .    -----.    C
-00025a70: 616c 6c20 636f 6d62 5f69 6e73 756c 6174  all comb_insulat
-00025a80: 696f 6e5f 7465 7374 5f73 7472 7563 7475  ion_test_structu
-00025a90: 7265 2829 2077 6974 6820 616e 7920 6f66  re() with any of
-00025aa0: 2074 6865 2070 6172 616d 6574 6572 7320   the parameters 
-00025ab0: 7368 6f77 6e0a 2020 2020 6265 6c6f 7720  shown.    below 
-00025ac0: 7768 6963 6820 796f 7527 6420 6c69 6b65  which you'd like
-00025ad0: 2074 6f20 6368 616e 6765 2e20 596f 7520   to change. You 
-00025ae0: 6f6e 6c79 206e 6565 6420 746f 2073 7570  only need to sup
-00025af0: 706c 7920 7468 6520 7061 7261 6d65 7465  ply the paramete
-00025b00: 7273 0a20 2020 2077 6869 6368 2079 6f75  rs.    which you
-00025b10: 2069 6e74 656e 6420 6f6e 2063 6861 6e67   intend on chang
-00025b20: 696e 6720 596f 7520 6361 6e20 616c 7465  ing You can alte
-00025b30: 726e 6174 6976 656c 7920 6361 6c6c 2069  rnatively call i
-00025b40: 7420 7769 7468 206e 6f0a 2020 2020 7061  t with no.    pa
-00025b50: 7261 6d65 7465 7273 2061 6e64 2069 7420  rameters and it 
-00025b60: 7769 6c6c 2074 616b 6520 616c 6c20 7468  will take all th
-00025b70: 6520 6465 6661 756c 7420 7661 6c75 6573  e default values
-00025b80: 2073 686f 776e 2062 656c 6f77 2e0a 0a20   shown below... 
-00025b90: 2020 2045 783a 3a0a 2020 2020 2020 2020     Ex::.        
-00025ba0: 636f 6d62 5f69 6e73 756c 6174 696f 6e5f  comb_insulation_
-00025bb0: 7465 7374 5f73 7472 7563 7475 7265 2870  test_structure(p
-00025bc0: 6164 5f73 697a 653d 2831 3735 2c31 3735  ad_size=(175,175
-00025bd0: 292c 2077 6972 655f 7769 6474 683d 322c  ), wire_width=2,
-00025be0: 2077 6972 655f 6761 703d 3529 0a20 2020   wire_gap=5).   
-00025bf0: 202d 206f 7220 2d3a 3a0a 2020 2020 2020   - or -::.      
-00025c00: 2020 636f 6d62 5f69 6e73 756c 6174 696f    comb_insulatio
-00025c10: 6e5f 7465 7374 5f73 7472 7563 7475 7265  n_test_structure
-00025c20: 2829 0a20 2020 2022 2222 0a20 2020 2043  ().    """.    C
-00025c30: 4920 3d20 4465 7669 6365 2822 7465 7374  I = Device("test
-00025c40: 5f63 6f6d 6222 290a 0a20 2020 2023 2069  _comb")..    # i
-00025c50: 6620 636f 6d62 5f70 6164 5f6c 6179 6572  f comb_pad_layer
-00025c60: 2069 7320 4e6f 6e65 3a20 636f 6d62 5f70   is None: comb_p
-00025c70: 6164 5f6c 6179 6572 203d 2063 6f6d 625f  ad_layer = comb_
-00025c80: 6c61 7965 720a 2020 2020 2320 6966 2063  layer.    # if c
-00025c90: 6f6d 625f 676e 645f 6c61 7965 7220 6973  omb_gnd_layer is
-00025ca0: 204e 6f6e 653a 2063 6f6d 625f 676e 645f   None: comb_gnd_
-00025cb0: 6c61 7965 7220 3d20 636f 6d62 5f6c 6179  layer = comb_lay
-00025cc0: 6572 0a20 2020 2023 2069 6620 6f76 6572  er.    # if over
-00025cd0: 6c61 705f 7061 645f 6c61 7965 7220 6973  lap_pad_layer is
-00025ce0: 204e 6f6e 653a 206f 7665 726c 6170 5f70   None: overlap_p
-00025cf0: 6164 5f6c 6179 6572 203d 206f 7665 726c  ad_layer = overl
-00025d00: 6170 5f7a 6967 7a61 675f 6c61 7965 720a  ap_zigzag_layer.
-00025d10: 2020 2020 7769 7265 5f73 7061 6369 6e67      wire_spacing
-00025d20: 203d 2077 6972 655f 7769 6474 6820 2b20   = wire_width + 
-00025d30: 7769 7265 5f67 6170 202a 2032 0a0a 2020  wire_gap * 2..  
-00025d40: 2020 2320 7061 6420 6f76 6572 6c61 7973    # pad overlays
-00025d50: 0a20 2020 206f 7665 726c 6179 5f70 6164  .    overlay_pad
-00025d60: 6220 3d20 4349 2e61 6464 5f72 6566 280a  b = CI.add_ref(.
-00025d70: 2020 2020 2020 2020 7265 6374 616e 676c          rectangl
-00025d80: 6528 0a20 2020 2020 2020 2020 2020 2073  e(.            s
-00025d90: 697a 653d 2870 6164 5f73 697a 655b 305d  ize=(pad_size[0]
-00025da0: 202a 2039 202f 2031 302c 2070 6164 5f73   * 9 / 10, pad_s
-00025db0: 697a 655b 315d 202a 2039 202f 2031 3029  ize[1] * 9 / 10)
-00025dc0: 2c20 6c61 7965 723d 6f76 6572 6c61 705f  , layer=overlap_
-00025dd0: 7061 645f 6c61 7965 720a 2020 2020 2020  pad_layer.      
-00025de0: 2020 290a 2020 2020 290a 2020 2020 6f76    ).    ).    ov
-00025df0: 6572 6c61 795f 7061 646c 203d 2043 492e  erlay_padl = CI.
-00025e00: 6164 645f 7265 6628 0a20 2020 2020 2020  add_ref(.       
-00025e10: 2072 6563 7461 6e67 6c65 280a 2020 2020   rectangle(.    
-00025e20: 2020 2020 2020 2020 7369 7a65 3d28 7061          size=(pa
-00025e30: 645f 7369 7a65 5b30 5d20 2a20 3920 2f20  d_size[0] * 9 / 
-00025e40: 3130 2c20 7061 645f 7369 7a65 5b31 5d20  10, pad_size[1] 
-00025e50: 2a20 3920 2f20 3130 292c 206c 6179 6572  * 9 / 10), layer
-00025e60: 3d63 6f6d 625f 7061 645f 6c61 7965 720a  =comb_pad_layer.
-00025e70: 2020 2020 2020 2020 290a 2020 2020 290a          ).    ).
-00025e80: 2020 2020 6f76 6572 6c61 795f 7061 6474      overlay_padt
-00025e90: 203d 2043 492e 6164 645f 7265 6628 0a20   = CI.add_ref(. 
-00025ea0: 2020 2020 2020 2072 6563 7461 6e67 6c65         rectangle
-00025eb0: 280a 2020 2020 2020 2020 2020 2020 7369  (.            si
-00025ec0: 7a65 3d28 7061 645f 7369 7a65 5b30 5d20  ze=(pad_size[0] 
-00025ed0: 2a20 3920 2f20 3130 2c20 7061 645f 7369  * 9 / 10, pad_si
-00025ee0: 7a65 5b31 5d20 2a20 3920 2f20 3130 292c  ze[1] * 9 / 10),
-00025ef0: 206c 6179 6572 3d63 6f6d 625f 7061 645f   layer=comb_pad_
-00025f00: 6c61 7965 720a 2020 2020 2020 2020 290a  layer.        ).
-00025f10: 2020 2020 290a 2020 2020 6f76 6572 6c61      ).    overla
-00025f20: 795f 7061 6472 203d 2043 492e 6164 645f  y_padr = CI.add_
-00025f30: 7265 6628 0a20 2020 2020 2020 2072 6563  ref(.        rec
-00025f40: 7461 6e67 6c65 280a 2020 2020 2020 2020  tangle(.        
-00025f50: 2020 2020 7369 7a65 3d28 7061 645f 7369      size=(pad_si
-00025f60: 7a65 5b30 5d20 2a20 3920 2f20 3130 2c20  ze[0] * 9 / 10, 
-00025f70: 7061 645f 7369 7a65 5b31 5d20 2a20 3920  pad_size[1] * 9 
-00025f80: 2f20 3130 292c 206c 6179 6572 3d63 6f6d  / 10), layer=com
-00025f90: 625f 676e 645f 6c61 7965 720a 2020 2020  b_gnd_layer.    
-00025fa0: 2020 2020 290a 2020 2020 290a 2020 2020      ).    ).    
-00025fb0: 6f76 6572 6c61 795f 7061 646c 2e78 6d69  overlay_padl.xmi
-00025fc0: 6e20 3d20 300a 2020 2020 6f76 6572 6c61  n = 0.    overla
-00025fd0: 795f 7061 646c 2e79 6d69 6e20 3d20 300a  y_padl.ymin = 0.
-00025fe0: 2020 2020 6f76 6572 6c61 795f 7061 6462      overlay_padb
-00025ff0: 2e79 6d61 7820 3d20 300a 2020 2020 6f76  .ymax = 0.    ov
-00026000: 6572 6c61 795f 7061 6462 2e78 6d69 6e20  erlay_padb.xmin 
-00026010: 3d20 6f76 6572 6c61 795f 7061 646c 2e78  = overlay_padl.x
-00026020: 6d61 7820 2b20 7061 645f 7369 7a65 5b31  max + pad_size[1
-00026030: 5d20 2f20 350a 2020 2020 6f76 6572 6c61  ] / 5.    overla
-00026040: 795f 7061 6472 2e79 6d69 6e20 3d20 6f76  y_padr.ymin = ov
-00026050: 6572 6c61 795f 7061 646c 2e79 6d69 6e0a  erlay_padl.ymin.
-00026060: 2020 2020 6f76 6572 6c61 795f 7061 6472      overlay_padr
-00026070: 2e78 6d69 6e20 3d20 6f76 6572 6c61 795f  .xmin = overlay_
-00026080: 7061 6462 2e78 6d61 7820 2b20 7061 645f  padb.xmax + pad_
-00026090: 7369 7a65 5b31 5d20 2f20 350a 2020 2020  size[1] / 5.    
-000260a0: 6f76 6572 6c61 795f 7061 6474 2e78 6d69  overlay_padt.xmi
-000260b0: 6e20 3d20 6f76 6572 6c61 795f 7061 646c  n = overlay_padl
-000260c0: 2e78 6d61 7820 2b20 7061 645f 7369 7a65  .xmax + pad_size
-000260d0: 5b31 5d20 2f20 350a 2020 2020 6f76 6572  [1] / 5.    over
-000260e0: 6c61 795f 7061 6474 2e79 6d69 6e20 3d20  lay_padt.ymin = 
-000260f0: 6f76 6572 6c61 795f 7061 646c 2e79 6d61  overlay_padl.yma
-00026100: 780a 0a20 2020 2023 2070 6164 730a 2020  x..    # pads.  
-00026110: 2020 7061 646c 203d 2043 492e 6164 645f    padl = CI.add_
-00026120: 7265 6628 7265 6374 616e 676c 6528 7369  ref(rectangle(si
-00026130: 7a65 3d70 6164 5f73 697a 652c 206c 6179  ze=pad_size, lay
-00026140: 6572 3d63 6f6d 625f 6c61 7965 7229 290a  er=comb_layer)).
-00026150: 2020 2020 7061 6474 203d 2043 492e 6164      padt = CI.ad
-00026160: 645f 7265 6628 7265 6374 616e 676c 6528  d_ref(rectangle(
-00026170: 7369 7a65 3d70 6164 5f73 697a 652c 206c  size=pad_size, l
-00026180: 6179 6572 3d63 6f6d 625f 6c61 7965 7229  ayer=comb_layer)
-00026190: 290a 2020 2020 7061 6472 203d 2043 492e  ).    padr = CI.
-000261a0: 6164 645f 7265 6628 7265 6374 616e 676c  add_ref(rectangl
-000261b0: 6528 7369 7a65 3d70 6164 5f73 697a 652c  e(size=pad_size,
-000261c0: 206c 6179 6572 3d63 6f6d 625f 6c61 7965   layer=comb_laye
-000261d0: 7229 290a 2020 2020 7061 6462 203d 2043  r)).    padb = C
-000261e0: 492e 6164 645f 7265 6628 7265 6374 616e  I.add_ref(rectan
-000261f0: 676c 6528 7369 7a65 3d70 6164 5f73 697a  gle(size=pad_siz
-00026200: 652c 206c 6179 6572 3d6f 7665 726c 6170  e, layer=overlap
-00026210: 5f7a 6967 7a61 675f 6c61 7965 7229 290a  _zigzag_layer)).
-00026220: 2020 2020 7061 646c 5f6e 7562 203d 2043      padl_nub = C
-00026230: 492e 6164 645f 7265 6628 0a20 2020 2020  I.add_ref(.     
-00026240: 2020 2072 6563 7461 6e67 6c65 2873 697a     rectangle(siz
-00026250: 653d 2870 6164 5f73 697a 655b 305d 202f  e=(pad_size[0] /
-00026260: 2034 2c20 7061 645f 7369 7a65 5b31 5d20   4, pad_size[1] 
-00026270: 2f20 3229 2c20 6c61 7965 723d 636f 6d62  / 2), layer=comb
-00026280: 5f6c 6179 6572 290a 2020 2020 290a 2020  _layer).    ).  
-00026290: 2020 7061 6472 5f6e 7562 203d 2043 492e    padr_nub = CI.
-000262a0: 6164 645f 7265 6628 0a20 2020 2020 2020  add_ref(.       
-000262b0: 2072 6563 7461 6e67 6c65 2873 697a 653d   rectangle(size=
-000262c0: 2870 6164 5f73 697a 655b 305d 202f 2034  (pad_size[0] / 4
-000262d0: 2c20 7061 645f 7369 7a65 5b31 5d20 2f20  , pad_size[1] / 
-000262e0: 3229 2c20 6c61 7965 723d 636f 6d62 5f6c  2), layer=comb_l
-000262f0: 6179 6572 290a 2020 2020 290a 2020 2020  ayer).    ).    
-00026300: 7061 646c 2e78 6d69 6e20 3d20 6f76 6572  padl.xmin = over
-00026310: 6c61 795f 7061 646c 2e78 6d69 6e0a 2020  lay_padl.xmin.  
-00026320: 2020 7061 646c 2e63 656e 7465 7220 3d20    padl.center = 
-00026330: 5b70 6164 6c2e 6365 6e74 6572 5b30 5d2c  [padl.center[0],
-00026340: 206f 7665 726c 6179 5f70 6164 6c2e 6365   overlay_padl.ce
-00026350: 6e74 6572 5b31 5d5d 0a20 2020 2070 6164  nter[1]].    pad
-00026360: 742e 796d 6178 203d 206f 7665 726c 6179  t.ymax = overlay
-00026370: 5f70 6164 742e 796d 6178 0a20 2020 2070  _padt.ymax.    p
-00026380: 6164 742e 6365 6e74 6572 203d 205b 6f76  adt.center = [ov
-00026390: 6572 6c61 795f 7061 6474 2e63 656e 7465  erlay_padt.cente
-000263a0: 725b 305d 2c20 7061 6474 2e63 656e 7465  r[0], padt.cente
-000263b0: 725b 315d 5d0a 2020 2020 7061 6472 2e78  r[1]].    padr.x
-000263c0: 6d61 7820 3d20 6f76 6572 6c61 795f 7061  max = overlay_pa
-000263d0: 6472 2e78 6d61 780a 2020 2020 7061 6472  dr.xmax.    padr
-000263e0: 2e63 656e 7465 7220 3d20 5b70 6164 722e  .center = [padr.
-000263f0: 6365 6e74 6572 5b30 5d2c 206f 7665 726c  center[0], overl
-00026400: 6179 5f70 6164 722e 6365 6e74 6572 5b31  ay_padr.center[1
-00026410: 5d5d 0a20 2020 2070 6164 622e 796d 696e  ]].    padb.ymin
-00026420: 203d 206f 7665 726c 6179 5f70 6164 622e   = overlay_padb.
-00026430: 796d 696e 0a20 2020 2070 6164 622e 6365  ymin.    padb.ce
-00026440: 6e74 6572 203d 205b 6f76 6572 6c61 795f  nter = [overlay_
-00026450: 7061 6462 2e63 656e 7465 725b 305d 2c20  padb.center[0], 
-00026460: 7061 6462 2e63 656e 7465 725b 315d 5d0a  padb.center[1]].
-00026470: 2020 2020 7061 646c 5f6e 7562 2e78 6d69      padl_nub.xmi
-00026480: 6e20 3d20 7061 646c 2e78 6d61 780a 2020  n = padl.xmax.  
-00026490: 2020 7061 646c 5f6e 7562 2e63 656e 7465    padl_nub.cente
-000264a0: 7220 3d20 5b70 6164 6c5f 6e75 622e 6365  r = [padl_nub.ce
-000264b0: 6e74 6572 5b30 5d2c 2070 6164 6c2e 6365  nter[0], padl.ce
-000264c0: 6e74 6572 5b31 5d5d 0a20 2020 2070 6164  nter[1]].    pad
-000264d0: 725f 6e75 622e 786d 6178 203d 2070 6164  r_nub.xmax = pad
-000264e0: 722e 786d 696e 0a20 2020 2070 6164 725f  r.xmin.    padr_
-000264f0: 6e75 622e 6365 6e74 6572 203d 205b 7061  nub.center = [pa
-00026500: 6472 5f6e 7562 2e63 656e 7465 725b 305d  dr_nub.center[0]
-00026510: 2c20 7061 6472 2e63 656e 7465 725b 315d  , padr.center[1]
-00026520: 5d0a 0a20 2020 2023 2063 6f6e 6e65 6374  ]..    # connect
-00026530: 6564 207a 6967 0a20 2020 2068 6561 6420  ed zig.    head 
-00026540: 3d20 4349 2e61 6464 5f72 6566 2863 6f6d  = CI.add_ref(com
-00026550: 7061 7373 2873 697a 653d 2870 6164 5f73  pass(size=(pad_s
-00026560: 697a 655b 305d 202f 2031 322c 2077 6972  ize[0] / 12, wir
-00026570: 655f 7769 6474 6829 2c20 6c61 7965 723d  e_width), layer=
-00026580: 636f 6d62 5f6c 6179 6572 2929 0a20 2020  comb_layer)).   
-00026590: 2068 6561 642e 786d 696e 203d 2070 6164   head.xmin = pad
-000265a0: 6c5f 6e75 622e 786d 6178 0a20 2020 2068  l_nub.xmax.    h
-000265b0: 6561 642e 796d 6178 203d 2070 6164 6c5f  ead.ymax = padl_
-000265c0: 6e75 622e 796d 6178 0a20 2020 2063 6f6e  nub.ymax.    con
-000265d0: 6e65 6374 6f72 203d 2043 492e 6164 645f  nector = CI.add_
-000265e0: 7265 6628 636f 6d70 6173 7328 7369 7a65  ref(compass(size
-000265f0: 3d28 7769 7265 5f77 6964 7468 2c20 7769  =(wire_width, wi
-00026600: 7265 5f77 6964 7468 292c 206c 6179 6572  re_width), layer
-00026610: 3d63 6f6d 625f 6c61 7965 7229 290a 2020  =comb_layer)).  
-00026620: 2020 636f 6e6e 6563 746f 722e 636f 6e6e    connector.conn
-00026630: 6563 7428 706f 7274 3d22 5722 2c20 6465  ect(port="W", de
-00026640: 7374 696e 6174 696f 6e3d 6865 6164 2e70  stination=head.p
-00026650: 6f72 7473 5b22 4522 5d29 0a20 2020 206f  orts["E"]).    o
-00026660: 6c64 5f70 6f72 7420 3d20 636f 6e6e 6563  ld_port = connec
-00026670: 746f 722e 706f 7274 735b 2253 225d 0a20  tor.ports["S"]. 
-00026680: 2020 2074 6f70 203d 2054 7275 650a 2020     top = True.  
-00026690: 2020 6f62 6a20 3d20 636f 6e6e 6563 746f    obj = connecto
-000266a0: 720a 2020 2020 7768 696c 6520 6f62 6a2e  r.    while obj.
-000266b0: 786d 6178 202b 2070 6164 5f73 697a 655b  xmax + pad_size[
-000266c0: 305d 202f 2031 3220 3c20 7061 6472 5f6e  0] / 12 < padr_n
-000266d0: 7562 2e78 6d69 6e3a 0a20 2020 2020 2020  ub.xmin:.       
-000266e0: 2023 206c 6f6e 6720 7a69 6720 7a61 6720   # long zig zag 
-000266f0: 7265 6374 616e 676c 650a 2020 2020 2020  rectangle.      
-00026700: 2020 6f62 6a20 3d20 4349 2e61 6464 5f72    obj = CI.add_r
-00026710: 6566 280a 2020 2020 2020 2020 2020 2020  ef(.            
-00026720: 636f 6d70 6173 7328 0a20 2020 2020 2020  compass(.       
-00026730: 2020 2020 2020 2020 2073 697a 653d 2870           size=(p
-00026740: 6164 5f73 697a 655b 315d 202f 2032 202d  ad_size[1] / 2 -
-00026750: 2032 202a 2077 6972 655f 7769 6474 682c   2 * wire_width,
-00026760: 2077 6972 655f 7769 6474 6829 2c20 6c61   wire_width), la
-00026770: 7965 723d 636f 6d62 5f6c 6179 6572 0a20  yer=comb_layer. 
-00026780: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00026790: 2020 2020 2029 0a20 2020 2020 2020 206f       ).        o
-000267a0: 626a 2e63 6f6e 6e65 6374 2870 6f72 743d  bj.connect(port=
-000267b0: 2257 222c 2064 6573 7469 6e61 7469 6f6e  "W", destination
-000267c0: 3d6f 6c64 5f70 6f72 7429 0a20 2020 2020  =old_port).     
-000267d0: 2020 206f 6c64 5f70 6f72 7420 3d20 6f62     old_port = ob
-000267e0: 6a2e 706f 7274 735b 2245 225d 0a20 2020  j.ports["E"].   
-000267f0: 2020 2020 2069 6620 746f 703a 0a20 2020       if top:.   
-00026800: 2020 2020 2020 2020 2023 207a 6967 207a           # zig z
-00026810: 6167 2065 6467 6520 7265 6374 616e 676c  ag edge rectangl
-00026820: 650a 2020 2020 2020 2020 2020 2020 6f62  e.            ob
-00026830: 6a20 3d20 4349 2e61 6464 5f72 6566 2863  j = CI.add_ref(c
-00026840: 6f6d 7061 7373 2873 697a 653d 2877 6972  ompass(size=(wir
-00026850: 655f 7769 6474 682c 2077 6972 655f 7769  e_width, wire_wi
-00026860: 6474 6829 2c20 6c61 7965 723d 636f 6d62  dth), layer=comb
-00026870: 5f6c 6179 6572 2929 0a20 2020 2020 2020  _layer)).       
-00026880: 2020 2020 206f 626a 2e63 6f6e 6e65 6374       obj.connect
-00026890: 2870 6f72 743d 224e 222c 2064 6573 7469  (port="N", desti
-000268a0: 6e61 7469 6f6e 3d6f 6c64 5f70 6f72 7429  nation=old_port)
-000268b0: 0a20 2020 2020 2020 2020 2020 2074 6f70  .            top
-000268c0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-000268d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000268e0: 2020 2023 207a 6967 207a 6167 2065 6467     # zig zag edg
-000268f0: 6520 7265 6374 616e 676c 650a 2020 2020  e rectangle.    
-00026900: 2020 2020 2020 2020 6f62 6a20 3d20 4349          obj = CI
-00026910: 2e61 6464 5f72 6566 2863 6f6d 7061 7373  .add_ref(compass
-00026920: 2873 697a 653d 2877 6972 655f 7769 6474  (size=(wire_widt
-00026930: 682c 2077 6972 655f 7769 6474 6829 2c20  h, wire_width), 
-00026940: 6c61 7965 723d 636f 6d62 5f6c 6179 6572  layer=comb_layer
-00026950: 2929 0a20 2020 2020 2020 2020 2020 206f  )).            o
-00026960: 626a 2e63 6f6e 6e65 6374 2870 6f72 743d  bj.connect(port=
-00026970: 2253 222c 2064 6573 7469 6e61 7469 6f6e  "S", destination
-00026980: 3d6f 6c64 5f70 6f72 7429 0a20 2020 2020  =old_port).     
-00026990: 2020 2020 2020 2074 6f70 203d 2054 7275         top = Tru
-000269a0: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-000269b0: 636f 6d62 2072 6563 7461 6e67 650a 2020  comb rectange.  
-000269c0: 2020 2020 2020 2020 2020 636f 6d62 203d            comb =
-000269d0: 2043 492e 6164 645f 7265 6628 0a20 2020   CI.add_ref(.   
-000269e0: 2020 2020 2020 2020 2020 2020 2072 6563               rec
-000269f0: 7461 6e67 6c65 280a 2020 2020 2020 2020  tangle(.        
-00026a00: 2020 2020 2020 2020 2020 2020 7369 7a65              size
-00026a10: 3d28 0a20 2020 2020 2020 2020 2020 2020  =(.             
-00026a20: 2020 2020 2020 2020 2020 2028 7061 6474             (padt
-00026a30: 2e79 6d69 6e20 2d20 6865 6164 2e79 6d61  .ymin - head.yma
-00026a40: 7829 0a20 2020 2020 2020 2020 2020 2020  x).             
-00026a50: 2020 2020 2020 2020 2020 202b 2070 6164             + pad
-00026a60: 5f73 697a 655b 315d 202f 2032 0a20 2020  _size[1] / 2.   
-00026a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026a80: 2020 2020 202d 2028 7769 7265 5f73 7061       - (wire_spa
-00026a90: 6369 6e67 202b 2077 6972 655f 7769 6474  cing + wire_widt
-00026aa0: 6829 202f 2032 2c0a 2020 2020 2020 2020  h) / 2,.        
-00026ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026ac0: 7769 7265 5f77 6964 7468 2c0a 2020 2020  wire_width,.    
-00026ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026ae0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00026af0: 2020 2020 2020 206c 6179 6572 3d63 6f6d         layer=com
-00026b00: 625f 6c61 7965 722c 0a20 2020 2020 2020  b_layer,.       
-00026b10: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00026b20: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00026b30: 2020 2020 2063 6f6d 622e 726f 7461 7465       comb.rotate
-00026b40: 2839 3029 0a20 2020 2020 2020 2020 2020  (90).           
-00026b50: 2063 6f6d 622e 796d 6178 203d 2070 6164   comb.ymax = pad
-00026b60: 742e 796d 696e 0a20 2020 2020 2020 2020  t.ymin.         
-00026b70: 2020 2063 6f6d 622e 786d 6178 203d 206f     comb.xmax = o
-00026b80: 626a 2e78 6d61 7820 2d20 2877 6972 655f  bj.xmax - (wire_
-00026b90: 7370 6163 696e 6720 2b20 7769 7265 5f77  spacing + wire_w
-00026ba0: 6964 7468 2920 2f20 320a 2020 2020 2020  idth) / 2.      
-00026bb0: 2020 6f6c 645f 706f 7274 203d 206f 626a    old_port = obj
-00026bc0: 2e70 6f72 7473 5b22 4522 5d0a 2020 2020  .ports["E"].    
-00026bd0: 2020 2020 6f62 6a20 3d20 4349 2e61 6464      obj = CI.add
-00026be0: 5f72 6566 2863 6f6d 7061 7373 2873 697a  _ref(compass(siz
-00026bf0: 653d 2877 6972 655f 7370 6163 696e 672c  e=(wire_spacing,
-00026c00: 2077 6972 655f 7769 6474 6829 2c20 6c61   wire_width), la
-00026c10: 7965 723d 636f 6d62 5f6c 6179 6572 2929  yer=comb_layer))
-00026c20: 0a20 2020 2020 2020 206f 626a 2e63 6f6e  .        obj.con
-00026c30: 6e65 6374 2870 6f72 743d 2257 222c 2064  nect(port="W", d
-00026c40: 6573 7469 6e61 7469 6f6e 3d6f 6c64 5f70  estination=old_p
-00026c50: 6f72 7429 0a20 2020 2020 2020 206f 6c64  ort).        old
-00026c60: 5f70 6f72 7420 3d20 6f62 6a2e 706f 7274  _port = obj.port
-00026c70: 735b 2245 225d 0a20 2020 2020 2020 206f  s["E"].        o
-00026c80: 626a 203d 2043 492e 6164 645f 7265 6628  bj = CI.add_ref(
-00026c90: 636f 6d70 6173 7328 7369 7a65 3d28 7769  compass(size=(wi
-00026ca0: 7265 5f77 6964 7468 2c20 7769 7265 5f77  re_width, wire_w
-00026cb0: 6964 7468 292c 206c 6179 6572 3d63 6f6d  idth), layer=com
-00026cc0: 625f 6c61 7965 7229 290a 2020 2020 2020  b_layer)).      
-00026cd0: 2020 6f62 6a2e 636f 6e6e 6563 7428 706f    obj.connect(po
-00026ce0: 7274 3d22 5722 2c20 6465 7374 696e 6174  rt="W", destinat
-00026cf0: 696f 6e3d 6f6c 645f 706f 7274 290a 2020  ion=old_port).  
-00026d00: 2020 2020 2020 6966 2074 6f70 3a0a 2020        if top:.  
-00026d10: 2020 2020 2020 2020 2020 6f6c 645f 706f            old_po
-00026d20: 7274 203d 206f 626a 2e70 6f72 7473 5b22  rt = obj.ports["
-00026d30: 5322 5d0a 2020 2020 2020 2020 656c 7365  S"].        else
-00026d40: 3a0a 2020 2020 2020 2020 2020 2020 6f6c  :.            ol
-00026d50: 645f 706f 7274 203d 206f 626a 2e70 6f72  d_port = obj.por
-00026d60: 7473 5b22 4e22 5d0a 2020 2020 6f6c 645f  ts["N"].    old_
-00026d70: 706f 7274 203d 206f 626a 2e70 6f72 7473  port = obj.ports
-00026d80: 5b22 4522 5d0a 2020 2020 6966 2070 6164  ["E"].    if pad
-00026d90: 725f 6e75 622e 786d 696e 202d 206f 626a  r_nub.xmin - obj
-00026da0: 2e78 6d61 7820 3e20 303a 0a20 2020 2020  .xmax > 0:.     
-00026db0: 2020 2074 6169 6c20 3d20 4349 2e61 6464     tail = CI.add
-00026dc0: 5f72 6566 280a 2020 2020 2020 2020 2020  _ref(.          
-00026dd0: 2020 636f 6d70 6173 7328 7369 7a65 3d28    compass(size=(
-00026de0: 7061 6472 5f6e 7562 2e78 6d69 6e20 2d20  padr_nub.xmin - 
-00026df0: 6f62 6a2e 786d 6178 2c20 7769 7265 5f77  obj.xmax, wire_w
-00026e00: 6964 7468 292c 206c 6179 6572 3d63 6f6d  idth), layer=com
-00026e10: 625f 6c61 7965 7229 0a20 2020 2020 2020  b_layer).       
-00026e20: 2029 0a20 2020 2065 6c73 653a 0a20 2020   ).    else:.   
-00026e30: 2020 2020 2074 6169 6c20 3d20 4349 2e61       tail = CI.a
-00026e40: 6464 5f72 6566 2863 6f6d 7061 7373 2873  dd_ref(compass(s
-00026e50: 697a 653d 2877 6972 655f 7769 6474 682c  ize=(wire_width,
-00026e60: 2077 6972 655f 7769 6474 6829 2c20 6c61   wire_width), la
-00026e70: 7965 723d 636f 6d62 5f6c 6179 6572 2929  yer=comb_layer))
-00026e80: 0a20 2020 2074 6169 6c2e 636f 6e6e 6563  .    tail.connec
-00026e90: 7428 706f 7274 3d22 5722 2c20 6465 7374  t(port="W", dest
-00026ea0: 696e 6174 696f 6e3d 6f6c 645f 706f 7274  ination=old_port
-00026eb0: 290a 0a20 2020 2023 2064 6973 636f 6e6e  )..    # disconn
-00026ec0: 6563 7465 6420 7a69 670a 2020 2020 6468  ected zig.    dh
-00026ed0: 6561 6420 3d20 4349 2e61 6464 5f72 6566  ead = CI.add_ref
-00026ee0: 280a 2020 2020 2020 2020 636f 6d70 6173  (.        compas
-00026ef0: 7328 0a20 2020 2020 2020 2020 2020 2073  s(.            s
-00026f00: 697a 653d 2870 6164 725f 6e75 622e 796d  ize=(padr_nub.ym
-00026f10: 696e 202d 2070 6164 622e 796d 6178 202d  in - padb.ymax -
-00026f20: 2077 6972 655f 7769 6474 682c 2077 6972   wire_width, wir
-00026f30: 655f 7769 6474 6829 2c0a 2020 2020 2020  e_width),.      
-00026f40: 2020 2020 2020 6c61 7965 723d 6f76 6572        layer=over
-00026f50: 6c61 705f 7a69 677a 6167 5f6c 6179 6572  lap_zigzag_layer
-00026f60: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00026f70: 290a 2020 2020 6468 6561 642e 726f 7461  ).    dhead.rota
-00026f80: 7465 2839 3029 0a20 2020 2064 6865 6164  te(90).    dhead
-00026f90: 2e79 6d69 6e20 3d20 7061 6462 2e79 6d61  .ymin = padb.yma
-00026fa0: 780a 2020 2020 6468 6561 642e 786d 6178  x.    dhead.xmax
-00026fb0: 203d 2074 6169 6c2e 786d 696e 202d 2028   = tail.xmin - (
-00026fc0: 7769 7265 5f73 7061 6369 6e67 202b 2077  wire_spacing + w
-00026fd0: 6972 655f 7769 6474 6829 202f 2032 0a20  ire_width) / 2. 
-00026fe0: 2020 2063 6f6e 6e65 6374 6f72 203d 2043     connector = C
-00026ff0: 492e 6164 645f 7265 6628 0a20 2020 2020  I.add_ref(.     
-00027000: 2020 2063 6f6d 7061 7373 2873 697a 653d     compass(size=
-00027010: 2877 6972 655f 7769 6474 682c 2077 6972  (wire_width, wir
-00027020: 655f 7769 6474 6829 2c20 6c61 7965 723d  e_width), layer=
-00027030: 6f76 6572 6c61 705f 7a69 677a 6167 5f6c  overlap_zigzag_l
-00027040: 6179 6572 290a 2020 2020 290a 2020 2020  ayer).    ).    
-00027050: 636f 6e6e 6563 746f 722e 636f 6e6e 6563  connector.connec
-00027060: 7428 706f 7274 3d22 5322 2c20 6465 7374  t(port="S", dest
-00027070: 696e 6174 696f 6e3d 6468 6561 642e 706f  ination=dhead.po
-00027080: 7274 735b 2245 225d 290a 2020 2020 6f6c  rts["E"]).    ol
-00027090: 645f 706f 7274 203d 2063 6f6e 6e65 6374  d_port = connect
-000270a0: 6f72 2e70 6f72 7473 5b22 4e22 5d0a 2020  or.ports["N"].  
-000270b0: 2020 7269 6768 7420 3d20 5472 7565 0a20    right = True. 
-000270c0: 2020 206f 626a 203d 2063 6f6e 6e65 6374     obj = connect
-000270d0: 6f72 0a20 2020 2077 6869 6c65 206f 626a  or.    while obj
-000270e0: 2e79 6d61 7820 2b20 7769 7265 5f73 7061  .ymax + wire_spa
-000270f0: 6369 6e67 202b 2077 6972 655f 7769 6474  cing + wire_widt
-00027100: 6820 3c20 6865 6164 2e79 6d61 783a 0a20  h < head.ymax:. 
-00027110: 2020 2020 2020 206f 626a 203d 2043 492e         obj = CI.
-00027120: 6164 645f 7265 6628 0a20 2020 2020 2020  add_ref(.       
-00027130: 2020 2020 2063 6f6d 7061 7373 2873 697a       compass(siz
-00027140: 653d 2877 6972 655f 7370 6163 696e 672c  e=(wire_spacing,
-00027150: 2077 6972 655f 7769 6474 6829 2c20 6c61   wire_width), la
-00027160: 7965 723d 6f76 6572 6c61 705f 7a69 677a  yer=overlap_zigz
-00027170: 6167 5f6c 6179 6572 290a 2020 2020 2020  ag_layer).      
-00027180: 2020 290a 2020 2020 2020 2020 6f62 6a2e    ).        obj.
-00027190: 636f 6e6e 6563 7428 706f 7274 3d22 5722  connect(port="W"
-000271a0: 2c20 6465 7374 696e 6174 696f 6e3d 6f6c  , destination=ol
-000271b0: 645f 706f 7274 290a 2020 2020 2020 2020  d_port).        
-000271c0: 6f6c 645f 706f 7274 203d 206f 626a 2e70  old_port = obj.p
-000271d0: 6f72 7473 5b22 4522 5d0a 2020 2020 2020  orts["E"].      
-000271e0: 2020 6966 2072 6967 6874 3a0a 2020 2020    if right:.    
-000271f0: 2020 2020 2020 2020 6f62 6a20 3d20 4349          obj = CI
-00027200: 2e61 6464 5f72 6566 280a 2020 2020 2020  .add_ref(.      
-00027210: 2020 2020 2020 2020 2020 636f 6d70 6173            compas
-00027220: 7328 7369 7a65 3d28 7769 7265 5f77 6964  s(size=(wire_wid
-00027230: 7468 2c20 7769 7265 5f77 6964 7468 292c  th, wire_width),
-00027240: 206c 6179 6572 3d6f 7665 726c 6170 5f7a   layer=overlap_z
-00027250: 6967 7a61 675f 6c61 7965 7229 0a20 2020  igzag_layer).   
-00027260: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00027270: 2020 2020 2020 206f 626a 2e63 6f6e 6e65         obj.conne
-00027280: 6374 2870 6f72 743d 2257 222c 2064 6573  ct(port="W", des
-00027290: 7469 6e61 7469 6f6e 3d6f 6c64 5f70 6f72  tination=old_por
-000272a0: 7429 0a20 2020 2020 2020 2020 2020 2072  t).            r
-000272b0: 6967 6874 203d 2046 616c 7365 0a20 2020  ight = False.   
-000272c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000272d0: 2020 2020 2020 206f 626a 203d 2043 492e         obj = CI.
-000272e0: 6164 645f 7265 6628 0a20 2020 2020 2020  add_ref(.       
-000272f0: 2020 2020 2020 2020 2063 6f6d 7061 7373           compass
-00027300: 2873 697a 653d 2877 6972 655f 7769 6474  (size=(wire_widt
-00027310: 682c 2077 6972 655f 7769 6474 6829 2c20  h, wire_width), 
-00027320: 6c61 7965 723d 6f76 6572 6c61 705f 7a69  layer=overlap_zi
-00027330: 677a 6167 5f6c 6179 6572 290a 2020 2020  gzag_layer).    
-00027340: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00027350: 2020 2020 2020 6f62 6a2e 636f 6e6e 6563        obj.connec
-00027360: 7428 706f 7274 3d22 4522 2c20 6465 7374  t(port="E", dest
-00027370: 696e 6174 696f 6e3d 6f6c 645f 706f 7274  ination=old_port
-00027380: 290a 2020 2020 2020 2020 2020 2020 7269  ).            ri
-00027390: 6768 7420 3d20 5472 7565 0a20 2020 2020  ght = True.     
-000273a0: 2020 206f 6c64 5f70 6f72 7420 3d20 6f62     old_port = ob
-000273b0: 6a2e 706f 7274 735b 224e 225d 0a20 2020  j.ports["N"].   
-000273c0: 2020 2020 206f 626a 203d 2043 492e 6164       obj = CI.ad
-000273d0: 645f 7265 6628 0a20 2020 2020 2020 2020  d_ref(.         
-000273e0: 2020 2063 6f6d 7061 7373 280a 2020 2020     compass(.    
-000273f0: 2020 2020 2020 2020 2020 2020 7369 7a65              size
-00027400: 3d28 0a20 2020 2020 2020 2020 2020 2020  =(.             
-00027410: 2020 2020 2020 2064 6865 6164 2e78 6d69         dhead.xmi
-00027420: 6e20 2d20 2868 6561 642e 786d 6178 202b  n - (head.xmax +
-00027430: 2068 6561 642e 786d 696e 202b 2077 6972   head.xmin + wir
-00027440: 655f 7769 6474 6829 202f 2032 2c0a 2020  e_width) / 2,.  
-00027450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027460: 2020 7769 7265 5f77 6964 7468 2c0a 2020    wire_width,.  
-00027470: 2020 2020 2020 2020 2020 2020 2020 292c                ),
-00027480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027490: 206c 6179 6572 3d6f 7665 726c 6170 5f7a   layer=overlap_z
-000274a0: 6967 7a61 675f 6c61 7965 722c 0a20 2020  igzag_layer,.   
-000274b0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000274c0: 2020 2029 0a20 2020 2020 2020 206f 626a     ).        obj
-000274d0: 2e63 6f6e 6e65 6374 2870 6f72 743d 2245  .connect(port="E
-000274e0: 222c 2064 6573 7469 6e61 7469 6f6e 3d6f  ", destination=o
-000274f0: 6c64 5f70 6f72 7429 0a20 2020 2020 2020  ld_port).       
-00027500: 206f 6c64 5f70 6f72 7420 3d20 6f62 6a2e   old_port = obj.
-00027510: 706f 7274 735b 2257 225d 0a20 2020 2020  ports["W"].     
-00027520: 2020 206f 626a 203d 2043 492e 6164 645f     obj = CI.add_
-00027530: 7265 6628 0a20 2020 2020 2020 2020 2020  ref(.           
-00027540: 2063 6f6d 7061 7373 2873 697a 653d 2877   compass(size=(w
-00027550: 6972 655f 7769 6474 682c 2077 6972 655f  ire_width, wire_
-00027560: 7769 6474 6829 2c20 6c61 7965 723d 6f76  width), layer=ov
-00027570: 6572 6c61 705f 7a69 677a 6167 5f6c 6179  erlap_zigzag_lay
-00027580: 6572 290a 2020 2020 2020 2020 290a 2020  er).        ).  
-00027590: 2020 2020 2020 6f62 6a2e 636f 6e6e 6563        obj.connec
-000275a0: 7428 706f 7274 3d22 5322 2c20 6465 7374  t(port="S", dest
-000275b0: 696e 6174 696f 6e3d 6f6c 645f 706f 7274  ination=old_port
-000275c0: 290a 2020 2020 2020 2020 6966 2072 6967  ).        if rig
-000275d0: 6874 3a0a 2020 2020 2020 2020 2020 2020  ht:.            
-000275e0: 6f6c 645f 706f 7274 203d 206f 626a 2e70  old_port = obj.p
-000275f0: 6f72 7473 5b22 5722 5d0a 2020 2020 2020  orts["W"].      
-00027600: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00027610: 2020 2020 6f6c 645f 706f 7274 203d 206f      old_port = o
-00027620: 626a 2e70 6f72 7473 5b22 4522 5d0a 0a20  bj.ports["E"].. 
-00027630: 2020 2072 6574 7572 6e20 4349 0a0a 0a64     return CI...d
-00027640: 6566 205f 7465 7374 5f69 635f 7769 7265  ef _test_ic_wire
-00027650: 5f73 7465 7028 7468 6963 6b5f 7769 6474  _step(thick_widt
-00027660: 683d 3130 2c20 7468 696e 5f77 6964 7468  h=10, thin_width
-00027670: 3d31 2c20 7769 7265 5f6c 6179 6572 3d32  =1, wire_layer=2
-00027680: 293a 0a20 2020 2022 2222 4865 6c70 6572  ):.    """Helper
-00027690: 2066 756e 6374 696f 6e20 7573 6564 2074   function used t
-000276a0: 6f20 6d61 6b65 2074 6865 2049 4320 7374  o make the IC st
-000276b0: 6570 2077 6972 6520 7374 7275 6374 7572  ep wire structur
-000276c0: 652e 2222 220a 2020 2020 5753 3420 3d20  e.""".    WS4 = 
-000276d0: 4465 7669 6365 2822 7465 7374 5f69 635f  Device("test_ic_
-000276e0: 7374 6570 2229 0a20 2020 2077 6972 655f  step").    wire_
-000276f0: 7374 6570 6120 3d20 5753 342e 6164 645f  stepa = WS4.add_
-00027700: 7265 6628 0a20 2020 2020 2020 206f 7074  ref(.        opt
-00027710: 696d 616c 5f73 7465 7028 7468 6963 6b5f  imal_step(thick_
-00027720: 7769 6474 6820 2f20 322c 2074 6869 6e5f  width / 2, thin_
-00027730: 7769 6474 6820 2f20 322c 206c 6179 6572  width / 2, layer
-00027740: 3d77 6972 655f 6c61 7965 7229 0a20 2020  =wire_layer).   
-00027750: 2029 0a20 2020 2077 6972 655f 7374 6570   ).    wire_step
-00027760: 6220 3d20 5753 342e 6164 645f 7265 6628  b = WS4.add_ref(
-00027770: 0a20 2020 2020 2020 206f 7074 696d 616c  .        optimal
-00027780: 5f73 7465 7028 7468 696e 5f77 6964 7468  _step(thin_width
-00027790: 202f 2032 2c20 7468 6963 6b5f 7769 6474   / 2, thick_widt
-000277a0: 6820 2f20 322c 206c 6179 6572 3d77 6972  h / 2, layer=wir
-000277b0: 655f 6c61 7965 7229 0a20 2020 2029 0a20  e_layer).    ). 
-000277c0: 2020 2077 6972 655f 7374 6570 6320 3d20     wire_stepc = 
-000277d0: 5753 342e 6164 645f 7265 6628 0a20 2020  WS4.add_ref(.   
-000277e0: 2020 2020 206f 7074 696d 616c 5f73 7465       optimal_ste
-000277f0: 7028 7468 6963 6b5f 7769 6474 6820 2f20  p(thick_width / 
-00027800: 322c 2074 6869 6e5f 7769 6474 6820 2f20  2, thin_width / 
-00027810: 322c 206c 6179 6572 3d77 6972 655f 6c61  2, layer=wire_la
-00027820: 7965 7229 0a20 2020 2029 0a20 2020 2077  yer).    ).    w
-00027830: 6972 655f 7374 6570 6420 3d20 5753 342e  ire_stepd = WS4.
-00027840: 6164 645f 7265 6628 0a20 2020 2020 2020  add_ref(.       
-00027850: 206f 7074 696d 616c 5f73 7465 7028 7468   optimal_step(th
-00027860: 696e 5f77 6964 7468 202f 2032 2c20 7468  in_width / 2, th
-00027870: 6963 6b5f 7769 6474 6820 2f20 322c 206c  ick_width / 2, l
-00027880: 6179 6572 3d77 6972 655f 6c61 7965 7229  ayer=wire_layer)
-00027890: 0a20 2020 2029 0a20 2020 2077 6972 655f  .    ).    wire_
-000278a0: 7374 6570 622e 726f 7461 7465 2831 3830  stepb.rotate(180
-000278b0: 290a 2020 2020 7769 7265 5f73 7465 7062  ).    wire_stepb
-000278c0: 2e78 6d69 6e20 3d20 7769 7265 5f73 7465  .xmin = wire_ste
-000278d0: 7061 2e78 6d69 6e0a 2020 2020 7769 7265  pa.xmin.    wire
-000278e0: 5f73 7465 7063 2e72 6f74 6174 6528 3138  _stepc.rotate(18
-000278f0: 3029 0a20 2020 2077 6972 655f 7374 6570  0).    wire_step
-00027900: 632e 786d 696e 203d 2077 6972 655f 7374  c.xmin = wire_st
-00027910: 6570 612e 786d 6178 0a20 2020 2077 6972  epa.xmax.    wir
-00027920: 655f 7374 6570 642e 786d 696e 203d 2077  e_stepd.xmin = w
-00027930: 6972 655f 7374 6570 632e 786d 696e 0a20  ire_stepc.xmin. 
-00027940: 2020 2072 6574 7572 6e20 5753 340a 0a0a     return WS4...
-00027950: 6465 6620 7465 7374 5f69 6328 0a20 2020  def test_ic(.   
-00027960: 2077 6972 655f 7769 6474 6873 3d5b 302e   wire_widths=[0.
-00027970: 3235 2c20 302e 352c 2031 2c20 322c 2034  25, 0.5, 1, 2, 4
-00027980: 5d2c 0a20 2020 2077 6972 655f 7769 6474  ],.    wire_widt
-00027990: 6873 5f77 6964 653d 5b30 2e37 352c 2031  hs_wide=[0.75, 1
-000279a0: 2e35 2c20 332c 2034 2c20 365d 2c0a 2020  .5, 3, 4, 6],.  
-000279b0: 2020 7061 645f 7369 7a65 3d28 3230 302c    pad_size=(200,
-000279c0: 2032 3030 292c 0a20 2020 2070 6164 5f67   200),.    pad_g
-000279d0: 6170 3d37 352c 0a20 2020 2077 6972 655f  ap=75,.    wire_
-000279e0: 6c61 7965 723d 302c 0a20 2020 2070 6164  layer=0,.    pad
-000279f0: 5f6c 6179 6572 3d31 2c0a 2020 2020 676e  _layer=1,.    gn
-00027a00: 645f 6c61 7965 723d 312c 0a29 3a0a 2020  d_layer=1,.):.  
-00027a10: 2020 2222 2243 7269 7469 6361 6c20 6375    """Critical cu
-00027a20: 7272 656e 7420 7465 7374 2073 7472 7563  rrent test struc
-00027a30: 7475 7265 2066 6f72 2073 7570 6572 636f  ture for superco
-00027a40: 6e64 7563 7469 6e67 2077 6972 6573 2e0a  nducting wires..
-00027a50: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
-00027a60: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-00027a70: 2020 2077 6972 655f 7769 6474 6873 203a     wire_widths :
-00027a80: 2061 7272 6179 2d6c 696b 655b 4e5d 0a20   array-like[N]. 
-00027a90: 2020 2020 2020 2054 6865 2077 6964 7468         The width
-00027aa0: 7320 6f66 2074 6865 2074 6869 6e6e 6573  s of the thinnes
-00027ab0: 7420 7061 7274 7320 6f66 2074 6865 2074  t parts of the t
-00027ac0: 6573 7420 7769 7265 732e 0a20 2020 2077  est wires..    w
-00027ad0: 6972 655f 7769 6474 6873 5f77 6964 6520  ire_widths_wide 
-00027ae0: 3a20 6172 7261 792d 6c69 6b65 5b4e 5d0a  : array-like[N].
-00027af0: 2020 2020 2020 2020 5468 6520 7769 6474          The widt
-00027b00: 6873 206f 6620 7468 6520 7468 6963 6b65  hs of the thicke
-00027b10: 7374 2070 6172 7473 206f 6620 7468 6520  st parts of the 
-00027b20: 7465 7374 2077 6972 6573 2e0a 2020 2020  test wires..    
-00027b30: 7061 645f 7369 7a65 203a 2061 7272 6179  pad_size : array
-00027b40: 2d6c 696b 655b 325d 206f 6620 696e 7420  -like[2] of int 
-00027b50: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
-00027b60: 2028 7769 6474 682c 2068 6569 6768 7429   (width, height)
-00027b70: 206f 6620 7468 6520 7061 6473 2e0a 2020   of the pads..  
-00027b80: 2020 7061 645f 6761 7020 3a20 696e 7420    pad_gap : int 
-00027b90: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
-00027ba0: 2044 6973 7461 6e63 6520 6265 7477 6565   Distance betwee
-00027bb0: 6e20 7468 6520 7061 6473 2061 6e64 2074  n the pads and t
-00027bc0: 6865 2067 726f 756e 6420 706c 616e 652e  he ground plane.
-00027bd0: 0a20 2020 2077 6972 655f 6c61 7965 7220  .    wire_layer 
-00027be0: 3a20 696e 740a 2020 2020 2020 2020 5370  : int.        Sp
-00027bf0: 6563 6966 6963 206c 6179 6572 2873 2920  ecific layer(s) 
-00027c00: 746f 2070 7574 2074 6865 2077 6972 6573  to put the wires
-00027c10: 206f 6e2e 0a20 2020 2070 6164 5f6c 6179   on..    pad_lay
-00027c20: 6572 203a 2069 6e74 0a20 2020 2020 2020  er : int.       
-00027c30: 2053 7065 6369 6669 6320 6c61 7965 7228   Specific layer(
-00027c40: 7329 2074 6f20 7075 7420 7468 6520 7061  s) to put the pa
-00027c50: 6473 206f 6e2e 0a20 2020 2067 6e64 5f6c  ds on..    gnd_l
-00027c60: 6179 6572 203a 2069 6e74 206f 7220 4e6f  ayer : int or No
-00027c70: 6e65 0a20 2020 2020 2020 2053 7065 6369  ne.        Speci
-00027c80: 6669 6320 6c61 7965 7228 7329 2074 6f20  fic layer(s) to 
-00027c90: 7075 7420 7468 6520 6772 6f75 6e64 2070  put the ground p
-00027ca0: 6c61 6e65 206f 6e2e 0a0a 2020 2020 5265  lane on...    Re
-00027cb0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00027cc0: 2d0a 2020 2020 4465 7669 6365 0a20 2020  -.    Device.   
-00027cd0: 2020 2020 2041 2044 6576 6963 6520 636f       A Device co
-00027ce0: 6e74 6169 6e69 6e67 2074 6865 2063 7269  ntaining the cri
-00027cf0: 7469 6361 6c2d 6375 7272 656e 7420 7465  tical-current te
-00027d00: 7374 2073 7472 7563 7475 7265 2e0a 2020  st structure..  
-00027d10: 2020 2222 220a 2020 2020 4943 5320 3d20    """.    ICS = 
-00027d20: 4465 7669 6365 2822 7465 7374 5f69 6322  Device("test_ic"
-00027d30: 290a 0a20 2020 2023 2069 6620 676e 645f  )..    # if gnd_
-00027d40: 6c61 7965 7220 6973 204e 6f6e 653a 2067  layer is None: g
-00027d50: 6e64 5f6c 6179 6572 203d 2070 6164 5f6c  nd_layer = pad_l
-00027d60: 6179 6572 0a20 2020 2074 7261 6e73 6c61  ayer.    transla
-00027d70: 7469 6f6e 203d 2030 0a20 2020 2070 6164  tion = 0.    pad
-00027d80: 6220 3d20 4943 532e 6164 645f 7265 6628  b = ICS.add_ref(
-00027d90: 0a20 2020 2020 2020 2072 6563 7461 6e67  .        rectang
-00027da0: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
-00027db0: 7369 7a65 3d28 6e70 2e73 697a 6528 7769  size=(np.size(wi
-00027dc0: 7265 5f77 6964 7468 7329 202a 2028 7061  re_widths) * (pa
-00027dd0: 645f 7369 7a65 5b30 5d20 2a20 3620 2f20  d_size[0] * 6 / 
-00027de0: 3529 2c20 7061 645f 7369 7a65 5b31 5d29  5), pad_size[1])
-00027df0: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
-00027e00: 7965 723d 7769 7265 5f6c 6179 6572 2c0a  yer=wire_layer,.
-00027e10: 2020 2020 2020 2020 290a 2020 2020 290a          ).    ).
-00027e20: 0a20 2020 2070 6164 625f 6f76 6572 6c61  .    padb_overla
-00027e30: 7920 3d20 4943 532e 6164 645f 7265 6628  y = ICS.add_ref(
-00027e40: 0a20 2020 2020 2020 2072 6563 7461 6e67  .        rectang
-00027e50: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
-00027e60: 7369 7a65 3d28 0a20 2020 2020 2020 2020  size=(.         
-00027e70: 2020 2020 2020 2028 6e70 2e73 697a 6528         (np.size(
-00027e80: 7769 7265 5f77 6964 7468 7329 202a 2028  wire_widths) * (
-00027e90: 7061 645f 7369 7a65 5b30 5d20 2a20 3620  pad_size[0] * 6 
-00027ea0: 2f20 3529 2920 2a20 3920 2f20 3130 2c0a  / 5)) * 9 / 10,.
-00027eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027ec0: 7061 645f 7369 7a65 5b31 5d20 2a20 3920  pad_size[1] * 9 
-00027ed0: 2f20 3130 2c0a 2020 2020 2020 2020 2020  / 10,.          
-00027ee0: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-00027ef0: 206c 6179 6572 3d67 6e64 5f6c 6179 6572   layer=gnd_layer
-00027f00: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00027f10: 290a 2020 2020 7061 6462 5f6f 7665 726c  ).    padb_overl
-00027f20: 6179 2e63 656e 7465 7220 3d20 7061 6462  ay.center = padb
-00027f30: 2e63 656e 7465 720a 2020 2020 7061 6462  .center.    padb
-00027f40: 5f6f 7665 726c 6179 2e79 6d69 6e20 3d20  _overlay.ymin = 
-00027f50: 7061 6462 2e79 6d69 6e0a 2020 2020 666f  padb.ymin.    fo
-00027f60: 7220 692c 2078 2069 6e20 656e 756d 6572  r i, x in enumer
-00027f70: 6174 6528 7769 7265 5f77 6964 7468 735f  ate(wire_widths_
-00027f80: 7769 6465 293a 0a20 2020 2020 2020 2070  wide):.        p
-00027f90: 6164 7420 3d20 4943 532e 6164 645f 7265  adt = ICS.add_re
-00027fa0: 6628 7265 6374 616e 676c 6528 7061 645f  f(rectangle(pad_
-00027fb0: 7369 7a65 2c20 7769 7265 5f6c 6179 6572  size, wire_layer
-00027fc0: 2929 0a20 2020 2020 2020 2070 6164 742e  )).        padt.
-00027fd0: 786d 696e 203d 2070 6164 622e 786d 696e  xmin = padb.xmin
-00027fe0: 202b 2074 7261 6e73 6c61 7469 6f6e 0a20   + translation. 
-00027ff0: 2020 2020 2020 2070 6164 742e 796d 696e         padt.ymin
-00028000: 203d 2070 6164 622e 796d 6178 202b 2070   = padb.ymax + p
-00028010: 6164 5f67 6170 0a20 2020 2020 2020 2070  ad_gap.        p
-00028020: 6164 745f 6f76 6572 6c61 7920 3d20 4943  adt_overlay = IC
-00028030: 532e 6164 645f 7265 6628 0a20 2020 2020  S.add_ref(.     
-00028040: 2020 2020 2020 2072 6563 7461 6e67 6c65         rectangle
-00028050: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00028060: 2020 7369 7a65 3d28 7061 645f 7369 7a65    size=(pad_size
-00028070: 5b30 5d20 2a20 3920 2f20 3130 2c20 7061  [0] * 9 / 10, pa
-00028080: 645f 7369 7a65 5b31 5d20 2a20 3920 2f20  d_size[1] * 9 / 
-00028090: 3130 292c 206c 6179 6572 3d70 6164 5f6c  10), layer=pad_l
-000280a0: 6179 6572 0a20 2020 2020 2020 2020 2020  ayer.           
-000280b0: 2029 0a20 2020 2020 2020 2029 0a20 2020   ).        ).   
-000280c0: 2020 2020 2070 6164 745f 6f76 6572 6c61       padt_overla
-000280d0: 792e 6365 6e74 6572 203d 2070 6164 742e  y.center = padt.
-000280e0: 6365 6e74 6572 0a20 2020 2020 2020 2070  center.        p
-000280f0: 6164 745f 6f76 6572 6c61 792e 796d 6178  adt_overlay.ymax
-00028100: 203d 2070 6164 742e 796d 6178 0a20 2020   = padt.ymax.   
-00028110: 2020 2020 2064 6966 6665 7265 6e63 6520       difference 
-00028120: 3d20 7061 6474 2e79 6d69 6e20 2d20 7061  = padt.ymin - pa
-00028130: 6462 2e79 6d61 780a 2020 2020 2020 2020  db.ymax.        
-00028140: 7769 7265 5f73 7465 7020 3d20 4943 532e  wire_step = ICS.
-00028150: 6164 645f 7265 6628 0a20 2020 2020 2020  add_ref(.       
-00028160: 2020 2020 205f 7465 7374 5f69 635f 7769       _test_ic_wi
-00028170: 7265 5f73 7465 7028 0a20 2020 2020 2020  re_step(.       
-00028180: 2020 2020 2020 2020 2077 6972 655f 7769           wire_wi
-00028190: 6474 6873 5f77 6964 655b 695d 2c20 7769  dths_wide[i], wi
-000281a0: 7265 5f77 6964 7468 735b 695d 2c20 7769  re_widths[i], wi
-000281b0: 7265 5f6c 6179 6572 3d77 6972 655f 6c61  re_layer=wire_la
-000281c0: 7965 720a 2020 2020 2020 2020 2020 2020  yer.            
-000281d0: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-000281e0: 2020 2020 7769 7265 5f73 7465 702e 726f      wire_step.ro
-000281f0: 7461 7465 2839 3029 0a20 2020 2020 2020  tate(90).       
-00028200: 2077 6972 655f 7374 6570 2e63 656e 7465   wire_step.cente
-00028210: 7220 3d20 2870 6164 742e 6365 6e74 6572  r = (padt.center
-00028220: 5b30 5d2c 2070 6164 622e 796d 6178 202b  [0], padb.ymax +
-00028230: 2064 6966 6665 7265 6e63 6520 2f20 3229   difference / 2)
-00028240: 0a20 2020 2020 2020 2074 7261 6e73 6c61  .        transla
-00028250: 7469 6f6e 203d 2074 7261 6e73 6c61 7469  tion = translati
-00028260: 6f6e 202b 2070 6164 5f73 697a 655b 305d  on + pad_size[0]
-00028270: 202a 2031 3220 2f20 3130 0a20 2020 2020   * 12 / 10.     
-00028280: 2020 2063 6f6e 6e5f 7769 7265 5f74 6f70     conn_wire_top
-00028290: 203d 2049 4353 2e61 6464 5f72 6566 280a   = ICS.add_ref(.
-000282a0: 2020 2020 2020 2020 2020 2020 7265 6374              rect
-000282b0: 616e 676c 6528 0a20 2020 2020 2020 2020  angle(.         
-000282c0: 2020 2020 2020 2073 697a 653d 2877 6972         size=(wir
-000282d0: 655f 7769 6474 6873 5f77 6964 655b 695d  e_widths_wide[i]
-000282e0: 2c20 7061 6474 2e79 6d69 6e20 2d20 7769  , padt.ymin - wi
-000282f0: 7265 5f73 7465 702e 796d 6178 292c 206c  re_step.ymax), l
-00028300: 6179 6572 3d77 6972 655f 6c61 7965 720a  ayer=wire_layer.
-00028310: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00028320: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00028330: 636f 6e6e 5f77 6972 655f 626f 7474 6f6d  conn_wire_bottom
-00028340: 203d 2049 4353 2e61 6464 5f72 6566 280a   = ICS.add_ref(.
-00028350: 2020 2020 2020 2020 2020 2020 7265 6374              rect
-00028360: 616e 676c 6528 0a20 2020 2020 2020 2020  angle(.         
-00028370: 2020 2020 2020 2073 697a 653d 2877 6972         size=(wir
-00028380: 655f 7769 6474 6873 5f77 6964 655b 695d  e_widths_wide[i]
-00028390: 2c20 7769 7265 5f73 7465 702e 796d 696e  , wire_step.ymin
-000283a0: 202d 2070 6164 622e 796d 6178 292c 206c   - padb.ymax), l
-000283b0: 6179 6572 3d77 6972 655f 6c61 7965 720a  ayer=wire_layer.
-000283c0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000283d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000283e0: 636f 6e6e 5f77 6972 655f 746f 702e 796d  conn_wire_top.ym
-000283f0: 6178 203d 2070 6164 742e 796d 696e 0a20  ax = padt.ymin. 
-00028400: 2020 2020 2020 2063 6f6e 6e5f 7769 7265         conn_wire
-00028410: 5f74 6f70 2e78 6d69 6e20 3d20 7769 7265  _top.xmin = wire
-00028420: 5f73 7465 702e 786d 696e 0a20 2020 2020  _step.xmin.     
-00028430: 2020 2063 6f6e 6e5f 7769 7265 5f62 6f74     conn_wire_bot
-00028440: 746f 6d2e 796d 696e 203d 2070 6164 622e  tom.ymin = padb.
-00028450: 796d 6178 0a20 2020 2020 2020 2063 6f6e  ymax.        con
-00028460: 6e5f 7769 7265 5f62 6f74 746f 6d2e 786d  n_wire_bottom.xm
-00028470: 696e 203d 2077 6972 655f 7374 6570 2e78  in = wire_step.x
-00028480: 6d69 6e0a 0a20 2020 2072 6574 7572 6e20  min..    return 
-00028490: 4943 530a 0a0a 6465 6620 7465 7374 5f72  ICS...def test_r
-000284a0: 6573 280a 2020 2020 7061 645f 7369 7a65  es(.    pad_size
-000284b0: 3d5b 3530 2c20 3530 5d2c 206e 756d 5f73  =[50, 50], num_s
-000284c0: 7175 6172 6573 3d31 3030 302c 2077 6964  quares=1000, wid
-000284d0: 7468 3d31 2c20 7265 735f 6c61 7965 723d  th=1, res_layer=
-000284e0: 302c 2070 6164 5f6c 6179 6572 3d31 2c20  0, pad_layer=1, 
-000284f0: 676e 645f 6c61 7965 723d 320a 293a 0a20  gnd_layer=2.):. 
-00028500: 2020 2022 2222 4372 6561 7465 7320 616e     """Creates an
-00028510: 2065 6666 6963 6965 6e74 2072 6573 6f6e   efficient reson
-00028520: 6174 6f72 2073 7472 7563 7475 7265 2066  ator structure f
-00028530: 6f72 2061 2077 6166 6572 206c 6179 6f75  or a wafer layou
-00028540: 742e 0a0a 2020 2020 5061 7261 6d65 7465  t...    Paramete
-00028550: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-00028560: 2d0a 2020 2020 7061 645f 7369 7a65 203a  -.    pad_size :
-00028570: 2061 7272 6179 2d6c 696b 655b 325d 206f   array-like[2] o
-00028580: 6620 696e 7420 6f72 2066 6c6f 6174 0a20  f int or float. 
-00028590: 2020 2020 2020 2028 7769 6474 682c 2068         (width, h
-000285a0: 6569 6768 7429 206f 6620 7468 6520 7477  eight) of the tw
-000285b0: 6f20 6d61 7463 6865 6420 696d 7065 6461  o matched impeda
-000285c0: 6e63 6520 7061 6473 2069 6e20 6d69 6372  nce pads in micr
-000285d0: 6f6e 732e 0a20 2020 206e 756d 5f73 7175  ons..    num_squ
-000285e0: 6172 6573 203a 2069 6e74 206f 7220 666c  ares : int or fl
-000285f0: 6f61 740a 2020 2020 2020 2020 4e75 6d62  oat.        Numb
-00028600: 6572 206f 6620 7371 7561 7265 7320 636f  er of squares co
-00028610: 6d70 7269 7369 6e67 2074 6865 2072 6573  mprising the res
-00028620: 6f6e 6174 6f72 2077 6972 652e 0a20 2020  onator wire..   
-00028630: 2077 6964 7468 203a 2069 6e74 206f 7220   width : int or 
-00028640: 666c 6f61 740a 2020 2020 2020 2020 5468  float.        Th
-00028650: 6520 7769 6474 6820 6f66 2074 6865 2073  e width of the s
-00028660: 7175 6172 6573 2069 6e20 6d69 6372 6f6e  quares in micron
-00028670: 732e 0a20 2020 2072 6573 5f6c 6179 6572  s..    res_layer
-00028680: 203a 2069 6e74 0a20 2020 2020 2020 2053   : int.        S
-00028690: 7065 6369 6669 6320 6c61 7965 7228 7329  pecific layer(s)
-000286a0: 2074 6f20 7075 7420 7468 6520 7265 736f   to put the reso
-000286b0: 6e61 746f 7220 7374 7275 6374 7572 6520  nator structure 
-000286c0: 6f6e 2e0a 2020 2020 7061 645f 6c61 7965  on..    pad_laye
-000286d0: 7220 3a20 696e 7420 6f72 204e 6f6e 650a  r : int or None.
-000286e0: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
-000286f0: 206c 6179 6572 2873 2920 746f 2070 7574   layer(s) to put
-00028700: 2074 6865 2070 6164 7320 6f6e 2e0a 2020   the pads on..  
-00028710: 2020 676e 645f 6c61 7965 7220 3a20 2069    gnd_layer :  i
-00028720: 6e74 206f 7220 4e6f 6e65 0a20 2020 2020  nt or None.     
-00028730: 2020 2053 7065 6369 6669 6320 6c61 7965     Specific laye
-00028740: 7228 7329 2074 6f20 7075 7420 7468 6520  r(s) to put the 
-00028750: 6772 6f75 6e64 2070 6c61 6e65 206f 6e2e  ground plane on.
-00028760: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
-00028770: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 5020    -------.    P 
-00028780: 3a20 4465 7669 6365 0a20 2020 2020 2020  : Device.       
-00028790: 2041 2044 6576 6963 6520 636f 6e74 6169   A Device contai
-000287a0: 6e69 6e67 2061 6e20 6566 6669 6369 656e  ning an efficien
-000287b0: 7420 7265 736f 6e61 746f 7220 7374 7275  t resonator stru
-000287c0: 6374 7572 652e 0a20 2020 2022 2222 0a20  cture..    """. 
-000287d0: 2020 2078 203d 2070 6164 5f73 697a 655b     x = pad_size[
-000287e0: 305d 0a20 2020 207a 203d 2070 6164 5f73  0].    z = pad_s
-000287f0: 697a 655b 315d 0a0a 2020 2020 2320 4368  ize[1]..    # Ch
-00028800: 6563 6b69 6e67 2076 616c 6964 6974 7920  ecking validity 
-00028810: 6f66 2069 6e70 7574 0a20 2020 2069 6620  of input.    if 
-00028820: 7820 3c3d 2030 206f 7220 7a20 3c3d 2030  x <= 0 or z <= 0
-00028830: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-00028840: 5661 6c75 6545 7272 6f72 2822 5061 6420  ValueError("Pad 
-00028850: 6d75 7374 2068 6176 6520 706f 7369 7469  must have positi
-00028860: 7665 2c20 7265 616c 2064 696d 656e 7369  ve, real dimensi
-00028870: 6f6e 7322 290a 2020 2020 656c 6966 2077  ons").    elif w
-00028880: 6964 7468 203e 207a 3a0a 2020 2020 2020  idth > z:.      
-00028890: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-000288a0: 6f72 2822 5769 6474 6820 6f66 2063 656c  or("Width of cel
-000288b0: 6c20 6361 6e6e 6f74 2062 6520 6772 6561  l cannot be grea
-000288c0: 7465 7220 7468 616e 2068 6569 6768 7420  ter than height 
-000288d0: 6f66 2070 6164 2229 0a20 2020 2065 6c69  of pad").    eli
-000288e0: 6620 6e75 6d5f 7371 7561 7265 7320 3c3d  f num_squares <=
-000288f0: 2030 3a0a 2020 2020 2020 2020 7261 6973   0:.        rais
-00028900: 6520 5661 6c75 6545 7272 6f72 2822 4e75  e ValueError("Nu
-00028910: 6d62 6572 206f 6620 7371 7561 7265 7320  mber of squares 
-00028920: 6d75 7374 2062 6520 6120 706f 7369 7469  must be a positi
-00028930: 7665 2072 6561 6c20 6e75 6d62 6572 2229  ve real number")
-00028940: 0a20 2020 2065 6c69 6620 7769 6474 6820  .    elif width 
-00028950: 3c3d 2030 3a0a 2020 2020 2020 2020 7261  <= 0:.        ra
-00028960: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
-00028970: 5769 6474 6820 6f66 2063 656c 6c20 6d75  Width of cell mu
-00028980: 7374 2062 6520 6120 706f 7369 7469 7665  st be a positive
-00028990: 2072 6561 6c20 6e75 6d62 6572 2229 0a0a   real number")..
-000289a0: 2020 2020 2320 5065 7266 6f72 6d69 6e67      # Performing
-000289b0: 2070 7265 6c69 6d69 6e61 7279 2063 616c   preliminary cal
-000289c0: 6375 6c61 7469 6f6e 730a 2020 2020 6e75  culations.    nu
-000289d0: 6d5f 726f 7773 203d 2069 6e74 286e 702e  m_rows = int(np.
-000289e0: 666c 6f6f 7228 7a20 2f20 2832 202a 2077  floor(z / (2 * w
-000289f0: 6964 7468 2929 290a 2020 2020 6966 206e  idth))).    if n
-00028a00: 756d 5f72 6f77 7320 2520 3220 3d3d 2030  um_rows % 2 == 0
-00028a10: 3a0a 2020 2020 2020 2020 6e75 6d5f 726f  :.        num_ro
-00028a20: 7773 202d 3d20 310a 2020 2020 6e75 6d5f  ws -= 1.    num_
-00028a30: 636f 6c75 6d6e 7320 3d20 6e75 6d5f 726f  columns = num_ro
-00028a40: 7773 202d 2031 0a20 2020 2073 7175 6172  ws - 1.    squar
-00028a50: 6573 5f69 6e5f 726f 7720 3d20 286e 756d  es_in_row = (num
-00028a60: 5f73 7175 6172 6573 202d 206e 756d 5f63  _squares - num_c
-00028a70: 6f6c 756d 6e73 202d 2032 2920 2f20 6e75  olumns - 2) / nu
-00028a80: 6d5f 726f 7773 0a0a 2020 2020 2320 436f  m_rows..    # Co
-00028a90: 6d70 656e 7361 7469 6e67 2066 6f72 2077  mpensating for w
-00028aa0: 6569 7264 2065 6467 6520 6361 7365 730a  eird edge cases.
-00028ab0: 2020 2020 6966 2073 7175 6172 6573 5f69      if squares_i
-00028ac0: 6e5f 726f 7720 3c20 313a 0a20 2020 2020  n_row < 1:.     
-00028ad0: 2020 206e 756d 5f72 6f77 7320 3d20 696e     num_rows = in
-00028ae0: 7428 726f 756e 6428 6e75 6d5f 726f 7773  t(round(num_rows
-00028af0: 202f 2032 2920 2d20 3229 0a20 2020 2020   / 2) - 2).     
-00028b00: 2020 2073 7175 6172 6573 5f69 6e5f 726f     squares_in_ro
-00028b10: 7720 3d20 310a 2020 2020 6966 2077 6964  w = 1.    if wid
-00028b20: 7468 202a 2032 203e 207a 3a0a 2020 2020  th * 2 > z:.    
-00028b30: 2020 2020 6e75 6d5f 726f 7773 203d 2031      num_rows = 1
-00028b40: 0a20 2020 2020 2020 2073 7175 6172 6573  .        squares
-00028b50: 5f69 6e5f 726f 7720 3d20 6e75 6d5f 7371  _in_row = num_sq
-00028b60: 7561 7265 7320 2d20 320a 0a20 2020 206c  uares - 2..    l
-00028b70: 656e 6774 685f 726f 7720 3d20 7371 7561  ength_row = squa
-00028b80: 7265 735f 696e 5f72 6f77 202a 2077 6964  res_in_row * wid
-00028b90: 7468 0a0a 2020 2020 2320 4372 6561 7469  th..    # Creati
-00028ba0: 6e67 2072 6f77 2f63 6f6c 756d 6e20 636f  ng row/column co
-00028bb0: 726e 6572 2063 6f6d 6269 6e61 7469 6f6e  rner combination
-00028bc0: 2073 7472 7563 7475 7265 0a20 2020 2054   structure.    T
-00028bd0: 203d 2044 6576 6963 6528 290a 2020 2020   = Device().    
-00028be0: 526f 7720 3d20 7265 6374 616e 676c 6528  Row = rectangle(
-00028bf0: 7369 7a65 3d28 6c65 6e67 7468 5f72 6f77  size=(length_row
-00028c00: 2c20 7769 6474 6829 2c20 6c61 7965 723d  , width), layer=
-00028c10: 7265 735f 6c61 7965 7229 0a20 2020 2043  res_layer).    C
-00028c20: 6f6c 203d 2072 6563 7461 6e67 6c65 2873  ol = rectangle(s
-00028c30: 697a 653d 2877 6964 7468 2c20 7769 6474  ize=(width, widt
-00028c40: 6829 2c20 6c61 7965 723d 7265 735f 6c61  h), layer=res_la
-00028c50: 7965 7229 0a0a 2020 2020 542e 6164 645f  yer)..    T.add_
-00028c60: 7265 6628 526f 7729 0a20 2020 2063 6f6c  ref(Row).    col
-00028c70: 203d 2054 2e61 6464 5f72 6566 2843 6f6c   = T.add_ref(Col
-00028c80: 290a 2020 2020 636f 6c2e 6d6f 7665 285b  ).    col.move([
-00028c90: 6c65 6e67 7468 5f72 6f77 202d 2077 6964  length_row - wid
-00028ca0: 7468 2c20 2d77 6964 7468 5d29 0a0a 2020  th, -width])..  
-00028cb0: 2020 2320 4372 6561 7469 6e67 2065 6e74    # Creating ent
-00028cc0: 6972 6520 7761 7665 6775 6964 6520 6e65  ire waveguide ne
-00028cd0: 740a 2020 2020 4e20 3d20 4465 7669 6365  t.    N = Device
-00028ce0: 2822 6e65 7422 290a 2020 2020 6e20 3d20  ("net").    n = 
-00028cf0: 310a 2020 2020 666f 7220 6920 696e 2072  1.    for i in r
-00028d00: 616e 6765 286e 756d 5f72 6f77 7329 3a0a  ange(num_rows):.
-00028d10: 2020 2020 2020 2020 6966 2069 2021 3d20          if i != 
-00028d20: 6e75 6d5f 726f 7773 202d 2031 3a0a 2020  num_rows - 1:.  
-00028d30: 2020 2020 2020 2020 2020 6420 3d20 4e2e            d = N.
-00028d40: 6164 645f 7265 6628 5429 0a20 2020 2020  add_ref(T).     
-00028d50: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00028d60: 2020 2020 2064 203d 204e 2e61 6464 5f72       d = N.add_r
-00028d70: 6566 2852 6f77 290a 2020 2020 2020 2020  ef(Row).        
-00028d80: 6966 206e 2025 2032 203d 3d20 303a 0a20  if n % 2 == 0:. 
-00028d90: 2020 2020 2020 2020 2020 2064 2e6d 6972             d.mir
-00028da0: 726f 7228 7031 3d28 642e 782c 2064 2e79  ror(p1=(d.x, d.y
-00028db0: 6d61 7829 2c20 7032 3d28 642e 782c 2064  max), p2=(d.x, d
-00028dc0: 2e79 6d69 6e29 290a 2020 2020 2020 2020  .ymin)).        
-00028dd0: 642e 6d6f 7665 7928 2d28 6e20 2d20 3129  d.movey(-(n - 1)
-00028de0: 202a 2054 2e79 7369 7a65 290a 2020 2020   * T.ysize).    
-00028df0: 2020 2020 6e20 2b3d 2031 0a20 2020 2064      n += 1.    d
-00028e00: 203d 204e 2e61 6464 5f72 6566 2843 6f6c   = N.add_ref(Col
-00028e10: 292e 6d6f 7665 7828 2d77 6964 7468 290a  ).movex(-width).
-00028e20: 2020 2020 6420 3d20 4e2e 6164 645f 7265      d = N.add_re
-00028e30: 6628 436f 6c29 2e6d 6f76 6528 5b6c 656e  f(Col).move([len
-00028e40: 6774 685f 726f 772c 202d 286e 202d 2032  gth_row, -(n - 2
-00028e50: 2920 2a20 542e 7973 697a 655d 290a 0a20  ) * T.ysize]).. 
-00028e60: 2020 2023 2043 7265 6174 696e 6720 7061     # Creating pa
-00028e70: 6473 0a20 2020 2050 203d 2044 6576 6963  ds.    P = Devic
-00028e80: 6528 2274 6573 745f 7265 7322 290a 2020  e("test_res").  
-00028e90: 2020 5061 6431 203d 2072 6563 7461 6e67    Pad1 = rectang
-00028ea0: 6c65 2873 697a 653d 2878 2c20 7a29 2c20  le(size=(x, z), 
-00028eb0: 6c61 7965 723d 7061 645f 6c61 7965 7229  layer=pad_layer)
-00028ec0: 0a20 2020 2050 6164 3220 3d20 7265 6374  .    Pad2 = rect
-00028ed0: 616e 676c 6528 7369 7a65 3d28 7820 2b20  angle(size=(x + 
-00028ee0: 352c 207a 292c 206c 6179 6572 3d70 6164  5, z), layer=pad
-00028ef0: 5f6c 6179 6572 290a 2020 2020 476e 6431  _layer).    Gnd1
-00028f00: 203d 206f 6666 7365 7428 5061 6431 2c20   = offset(Pad1, 
-00028f10: 6469 7374 616e 6365 3d2d 352c 206c 6179  distance=-5, lay
-00028f20: 6572 3d67 6e64 5f6c 6179 6572 290a 2020  er=gnd_layer).  
-00028f30: 2020 476e 6432 203d 206f 6666 7365 7428    Gnd2 = offset(
-00028f40: 5061 6432 2c20 6469 7374 616e 6365 3d2d  Pad2, distance=-
-00028f50: 352c 206c 6179 6572 3d67 6e64 5f6c 6179  5, layer=gnd_lay
-00028f60: 6572 290a 2020 2020 7061 6431 203d 2050  er).    pad1 = P
-00028f70: 2e61 6464 5f72 6566 2850 6164 3129 2e6d  .add_ref(Pad1).m
-00028f80: 6f76 6578 282d 7820 2d20 7769 6474 6829  ovex(-x - width)
-00028f90: 0a20 2020 2070 6164 3220 3d20 502e 6164  .    pad2 = P.ad
-00028fa0: 645f 7265 6628 5061 6431 292e 6d6f 7665  d_ref(Pad1).move
-00028fb0: 7828 6c65 6e67 7468 5f72 6f77 202b 2077  x(length_row + w
-00028fc0: 6964 7468 290a 2020 2020 502e 6164 645f  idth).    P.add_
-00028fd0: 7265 6628 476e 6431 292e 6365 6e74 6572  ref(Gnd1).center
-00028fe0: 203d 2070 6164 312e 6365 6e74 6572 2020   = pad1.center  
-00028ff0: 2320 676e 6431 0a20 2020 2067 6e64 3220  # gnd1.    gnd2 
-00029000: 3d20 502e 6164 645f 7265 6628 476e 6432  = P.add_ref(Gnd2
-00029010: 290a 2020 2020 502e 6164 645f 7265 6628  ).    P.add_ref(
-00029020: 4e29 2e79 203d 2070 6164 312e 7920 2023  N).y = pad1.y  #
-00029030: 206e 6574 730a 2020 2020 676e 6432 2e63   nets.    gnd2.c
-00029040: 656e 7465 7220 3d20 7061 6432 2e63 656e  enter = pad2.cen
-00029050: 7465 720a 2020 2020 676e 6432 2e6d 6f76  ter.    gnd2.mov
-00029060: 6578 2832 2e35 290a 0a20 2020 2072 6574  ex(2.5)..    ret
-00029070: 7572 6e20 500a 0a0a 2320 3d3d 3d3d 3d3d  urn P...# ======
-00029080: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029090: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000290a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000290b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000290c0: 3d3d 3d3d 3d3d 3d3d 0a23 0a23 204f 7074  ========.#.# Opt
-000290d0: 696d 616c 2063 7572 7265 6e74 2d63 726f  imal current-cro
-000290e0: 7764 696e 6720 7375 7065 7263 6f6e 6475  wding supercondu
-000290f0: 6374 696e 6720 7374 7275 6374 7572 6573  cting structures
-00029100: 0a23 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d  .#.# ===========
-00029110: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029120: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029130: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029140: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029150: 3d3d 3d0a 0a0a 4064 6576 6963 655f 6c72  ===...@device_lr
-00029160: 755f 6361 6368 650a 6465 6620 6f70 7469  u_cache.def opti
-00029170: 6d61 6c5f 6861 6972 7069 6e28 7769 6474  mal_hairpin(widt
-00029180: 683d 302e 322c 2070 6974 6368 3d30 2e36  h=0.2, pitch=0.6
-00029190: 2c20 6c65 6e67 7468 3d31 302c 2074 7572  , length=10, tur
-000291a0: 6e5f 7261 7469 6f3d 342c 206e 756d 5f70  n_ratio=4, num_p
-000291b0: 7473 3d35 302c 206c 6179 6572 3d30 293a  ts=50, layer=0):
-000291c0: 0a20 2020 2022 2222 4372 6561 7465 7320  .    """Creates 
-000291d0: 616e 206f 7074 696d 616c 6c79 2d72 6f75  an optimally-rou
-000291e0: 6e64 6564 2068 6169 7270 696e 2067 656f  nded hairpin geo
-000291f0: 6d65 7472 792c 2077 6974 6820 6120 3138  metry, with a 18
-00029200: 3020 6465 6772 6565 2074 7572 6e0a 2020  0 degree turn.  
-00029210: 2020 6f6e 2074 6865 2072 6967 6874 2065    on the right e
-00029220: 6e64 206f 6620 7468 6520 706f 6c79 676f  nd of the polygo
-00029230: 6e20 636f 6e6e 6563 7465 6420 746f 2074  n connected to t
-00029240: 776f 2070 726f 6e67 7320 6578 7465 6e64  wo prongs extend
-00029250: 696e 6720 746f 7761 7264 730a 2020 2020  ing towards.    
-00029260: 706f 7274 7320 6f6e 2074 6865 206c 6566  ports on the lef
-00029270: 7420 656e 642e 0a0a 2020 2020 5061 7261  t end...    Para
-00029280: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-00029290: 2d2d 2d2d 2d0a 2020 2020 7769 6474 6820  -----.    width 
-000292a0: 3a20 696e 7420 6f72 2066 6c6f 6174 0a20  : int or float. 
-000292b0: 2020 2020 2020 2057 6964 7468 206f 6620         Width of 
-000292c0: 7468 6520 6861 6972 7069 6e20 6c65 6164  the hairpin lead
-000292d0: 732e 0a20 2020 2070 6974 6368 203a 2069  s..    pitch : i
-000292e0: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
-000292f0: 2020 2020 4469 7374 616e 6365 2062 6574      Distance bet
-00029300: 7765 656e 2074 6865 2074 776f 2068 6169  ween the two hai
-00029310: 7270 696e 206c 6561 6473 2e20 4d75 7374  rpin leads. Must
-00029320: 2062 6520 6772 6561 7465 7220 7468 616e   be greater than
-00029330: 2077 6964 7468 2e0a 2020 2020 6c65 6e67   width..    leng
-00029340: 7468 203a 2069 6e74 206f 7220 666c 6f61  th : int or floa
-00029350: 740a 2020 2020 2020 2020 4c65 6e67 7468  t.        Length
-00029360: 206f 6620 7468 6520 6861 6972 7069 6e20   of the hairpin 
-00029370: 6672 6f6d 2074 6865 2063 6f6e 6e65 6374  from the connect
-00029380: 6f72 7320 746f 2074 6865 206f 7070 6f73  ors to the oppos
-00029390: 6974 6520 656e 6420 6f66 2074 6865 0a20  ite end of the. 
-000293a0: 2020 2020 2020 2063 7572 7665 2e0a 2020         curve..  
-000293b0: 2020 7475 726e 5f72 6174 696f 203a 2069    turn_ratio : i
-000293c0: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
-000293d0: 2020 2020 5370 6563 6966 6965 7320 686f      Specifies ho
-000293e0: 7720 6d75 6368 206f 6620 7468 6520 6861  w much of the ha
-000293f0: 6972 7069 6e20 6973 2064 6564 6963 6174  irpin is dedicat
-00029400: 6564 2074 6f20 7468 6520 3138 3020 6465  ed to the 180 de
-00029410: 6772 6565 2074 7572 6e2e 0a20 2020 2020  gree turn..     
-00029420: 2020 2041 2074 7572 6e5f 7261 7469 6f20     A turn_ratio 
-00029430: 6f66 2031 3020 7769 6c6c 2072 6573 756c  of 10 will resul
-00029440: 7420 696e 2032 3025 206f 6620 7468 6520  t in 20% of the 
-00029450: 6861 6972 7069 6e20 6265 696e 6720 636f  hairpin being co
-00029460: 6d70 7269 7365 6420 6f66 2074 6865 2074  mprised of the t
-00029470: 7572 6e2e 0a20 2020 206e 756d 5f70 7473  urn..    num_pts
-00029480: 203a 2069 6e74 0a20 2020 2020 2020 204e   : int.        N
-00029490: 756d 6265 7220 6f66 2070 6f69 6e74 7320  umber of points 
-000294a0: 636f 6e73 7469 7475 7469 6e67 2074 6865  constituting the
-000294b0: 2031 3830 2064 6567 7265 6520 7475 726e   180 degree turn
-000294c0: 2e0a 2020 2020 6c61 7965 7220 3a20 696e  ..    layer : in
-000294d0: 742c 2061 7272 6179 2d6c 696b 655b 325d  t, array-like[2]
-000294e0: 2c20 6f72 2073 6574 0a20 2020 2020 2020  , or set.       
-000294f0: 2053 7065 6369 6669 6320 6c61 7965 7228   Specific layer(
-00029500: 7329 2074 6f20 7075 7420 706f 6c79 676f  s) to put polygo
-00029510: 6e20 6765 6f6d 6574 7279 206f 6e2e 0a0a  n geometry on...
-00029520: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-00029530: 2d2d 2d2d 2d2d 2d0a 2020 2020 4420 3a20  -------.    D : 
-00029540: 4465 7669 6365 0a20 2020 2020 2020 2041  Device.        A
-00029550: 2044 6576 6963 6520 636f 6e74 6169 6e69   Device containi
-00029560: 6e67 2061 6e20 6f70 7469 6d61 6c6c 792d  ng an optimally-
-00029570: 726f 756e 6465 6420 6861 6972 7069 6e20  rounded hairpin 
-00029580: 6765 6f6d 6574 7279 2e0a 0a20 2020 204e  geometry...    N
-00029590: 6f74 6573 0a20 2020 202d 2d2d 2d2d 0a20  otes.    -----. 
-000295a0: 2020 2048 6169 7270 696e 2070 6974 6368     Hairpin pitch
-000295b0: 206d 7573 7420 6265 2067 7265 6174 6572   must be greater
-000295c0: 2074 6861 6e20 7769 6474 682e 0a0a 2020   than width...  
-000295d0: 2020 4f70 7469 6d61 6c20 7374 7275 6374    Optimal struct
-000295e0: 7572 6520 6672 6f6d 2068 7474 7073 3a2f  ure from https:/
-000295f0: 2f64 6f69 2e6f 7267 2f31 302e 3131 3033  /doi.org/10.1103
-00029600: 2f50 6879 7352 6576 422e 3834 2e31 3734  /PhysRevB.84.174
-00029610: 3531 300a 2020 2020 436c 656d 2c20 4a2e  510.    Clem, J.
-00029620: 2c20 2620 4265 7267 6772 656e 2c20 4b2e  , & Berggren, K.
-00029630: 2028 3230 3131 292e 2047 656f 6d65 7472   (2011). Geometr
-00029640: 792d 6465 7065 6e64 656e 7420 6372 6974  y-dependent crit
-00029650: 6963 616c 2063 7572 7265 6e74 7320 696e  ical currents in
-00029660: 0a20 2020 2073 7570 6572 636f 6e64 7563  .    superconduc
-00029670: 7469 6e67 206e 616e 6f63 6972 6375 6974  ting nanocircuit
-00029680: 732e 2050 6879 7369 6361 6c20 5265 7669  s. Physical Revi
-00029690: 6577 2042 2c20 3834 2831 3729 2c20 31e2  ew B, 84(17), 1.
-000296a0: 8093 3237 2e0a 2020 2020 2222 220a 2020  ..27..    """.  
-000296b0: 2020 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d    # ============
-000296c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000296d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000296e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000296f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a20  ==============. 
-00029700: 2020 2023 2020 4372 6561 7465 2074 6865     #  Create the
-00029710: 2062 6173 6963 2067 656f 6d65 7472 790a   basic geometry.
-00029720: 2020 2020 2320 3d3d 3d3d 3d3d 3d3d 3d3d      # ==========
-00029730: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029740: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029750: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029760: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029770: 0a20 2020 2061 203d 2028 7069 7463 6820  .    a = (pitch 
-00029780: 2b20 7769 6474 6829 202f 2032 0a20 2020  + width) / 2.   
-00029790: 2079 203d 202d 2870 6974 6368 202d 2077   y = -(pitch - w
-000297a0: 6964 7468 2920 2f20 320a 2020 2020 7820  idth) / 2.    x 
-000297b0: 3d20 2d70 6974 6368 0a20 2020 2064 6c20  = -pitch.    dl 
-000297c0: 3d20 7769 6474 6820 2f20 286e 756d 5f70  = width / (num_p
-000297d0: 7473 202a 2032 290a 2020 2020 6e20 3d20  ts * 2).    n = 
-000297e0: 300a 0a20 2020 2023 2047 6574 2070 6f69  0..    # Get poi
-000297f0: 6e74 7320 6f66 2069 6465 616c 2063 7572  nts of ideal cur
-00029800: 7665 2066 726f 6d20 636f 6e66 6f72 6d61  ve from conforma
-00029810: 6c20 6d61 7070 696e 670a 2020 2020 2320  l mapping.    # 
-00029820: 544f 444f 2054 6869 7320 6973 2061 6e20  TODO This is an 
-00029830: 696e 6566 6669 6369 656e 7420 7761 7920  inefficient way 
-00029840: 6f66 2066 696e 6469 6e67 2070 6f69 6e74  of finding point
-00029850: 7320 7468 6174 2079 6f75 206e 6565 640a  s that you need.
-00029860: 2020 2020 7870 7473 203d 205b 785d 0a20      xpts = [x]. 
-00029870: 2020 2079 7074 7320 3d20 5b79 5d0a 2020     ypts = [y].  
-00029880: 2020 7768 696c 6520 2879 203c 2030 2920    while (y < 0) 
-00029890: 2620 286e 203c 2031 6536 293a 0a20 2020  & (n < 1e6):.   
-000298a0: 2020 2020 2073 203d 2078 202b 2031 6a20       s = x + 1j 
-000298b0: 2a20 790a 2020 2020 2020 2020 7720 3d20  * y.        w = 
-000298c0: 7371 7274 2831 202d 206e 702e 6578 7028  sqrt(1 - np.exp(
-000298d0: 7069 202a 2073 202f 2061 2929 0a20 2020  pi * s / a)).   
-000298e0: 2020 2020 2077 7820 3d20 6e70 2e72 6561       wx = np.rea
-000298f0: 6c28 7729 0a20 2020 2020 2020 2077 7920  l(w).        wy 
-00029900: 3d20 6e70 2e69 6d61 6728 7729 0a20 2020  = np.imag(w).   
-00029910: 2020 2020 2077 7820 3d20 7778 202f 2073       wx = wx / s
-00029920: 7172 7428 7778 2a2a 3220 2b20 7779 2a2a  qrt(wx**2 + wy**
-00029930: 3229 0a20 2020 2020 2020 2077 7920 3d20  2).        wy = 
-00029940: 7779 202f 2073 7172 7428 7778 2a2a 3220  wy / sqrt(wx**2 
-00029950: 2b20 7779 2a2a 3229 0a20 2020 2020 2020  + wy**2).       
-00029960: 2078 203d 2078 202b 2077 7820 2a20 646c   x = x + wx * dl
-00029970: 0a20 2020 2020 2020 2079 203d 2079 202b  .        y = y +
-00029980: 2077 7920 2a20 646c 0a20 2020 2020 2020   wy * dl.       
-00029990: 2078 7074 732e 6170 7065 6e64 2878 290a   xpts.append(x).
-000299a0: 2020 2020 2020 2020 7970 7473 2e61 7070          ypts.app
-000299b0: 656e 6428 7929 0a20 2020 2020 2020 206e  end(y).        n
-000299c0: 203d 206e 202b 2031 0a20 2020 2079 7074   = n + 1.    ypt
-000299d0: 735b 2d31 5d20 3d20 3020 2023 2053 6574  s[-1] = 0  # Set
-000299e0: 206c 6173 7420 706f 696e 7420 6265 206f   last point be o
-000299f0: 6e20 7468 6520 783d 3020 6178 6973 2066  n the x=0 axis f
-00029a00: 6f72 2073 616b 6520 6f66 2063 6c65 616e  or sake of clean
-00029a10: 6c69 6e65 7373 0a20 2020 2064 735f 6661  liness.    ds_fa
-00029a20: 6374 6f72 203d 2069 6e74 286c 656e 2878  ctor = int(len(x
-00029a30: 7074 7329 202f 206e 756d 5f70 7473 2920  pts) / num_pts) 
-00029a40: 2023 2044 6f77 6e73 616d 706c 6520 7468   # Downsample th
-00029a50: 6520 746f 7461 6c20 6e75 6d62 6572 206f  e total number o
-00029a60: 6620 706f 696e 7473 0a20 2020 2078 7074  f points.    xpt
-00029a70: 7320 3d20 7870 7473 5b3a 3a2d 6473 5f66  s = xpts[::-ds_f
-00029a80: 6163 746f 725d 0a20 2020 2078 7074 7320  actor].    xpts 
-00029a90: 3d20 7870 7473 5b3a 3a2d 315d 2020 2320  = xpts[::-1]  # 
-00029aa0: 5468 6973 206c 6f6f 6b73 2063 6f6e 6675  This looks confu
-00029ab0: 7369 6e67 2c20 6275 7420 6974 2773 206a  sing, but it's j
-00029ac0: 7573 7420 666c 6970 7069 6e67 2074 6865  ust flipping the
-00029ad0: 2061 7272 6179 7320 6172 6f75 6e64 0a20   arrays around. 
-00029ae0: 2020 2079 7074 7320 3d20 7970 7473 5b3a     ypts = ypts[:
-00029af0: 3a2d 6473 5f66 6163 746f 725d 0a20 2020  :-ds_factor].   
-00029b00: 2079 7074 7320 3d20 7970 7473 5b3a 3a2d   ypts = ypts[::-
-00029b10: 315d 2020 2320 736f 2074 6865 206c 6173  1]  # so the las
-00029b20: 7420 706f 696e 7420 6973 2067 7561 7261  t point is guara
-00029b30: 6e74 6565 6420 746f 2062 6520 696e 636c  nteed to be incl
-00029b40: 7564 6564 2077 6865 6e20 646f 776e 7361  uded when downsa
-00029b50: 6d70 6c65 640a 0a20 2020 2023 2041 6464  mpled..    # Add
-00029b60: 2070 6f69 6e74 7320 666f 7220 7468 6520   points for the 
-00029b70: 7265 7374 206f 6620 6d65 616e 6465 720a  rest of meander.
-00029b80: 2020 2020 7870 7473 2e61 7070 656e 6428      xpts.append(
-00029b90: 7870 7473 5b2d 315d 202b 2074 7572 6e5f  xpts[-1] + turn_
-00029ba0: 7261 7469 6f20 2a20 7769 6474 6829 0a20  ratio * width). 
-00029bb0: 2020 2079 7074 732e 6170 7065 6e64 2830     ypts.append(0
-00029bc0: 290a 2020 2020 7870 7473 2e61 7070 656e  ).    xpts.appen
-00029bd0: 6428 7870 7473 5b2d 315d 290a 2020 2020  d(xpts[-1]).    
-00029be0: 7970 7473 2e61 7070 656e 6428 2d61 290a  ypts.append(-a).
-00029bf0: 2020 2020 7870 7473 2e61 7070 656e 6428      xpts.append(
-00029c00: 7870 7473 5b30 5d29 0a20 2020 2079 7074  xpts[0]).    ypt
-00029c10: 732e 6170 7065 6e64 282d 6129 0a20 2020  s.append(-a).   
-00029c20: 2078 7074 732e 6170 7065 6e64 286d 6178   xpts.append(max
-00029c30: 2878 7074 7329 202d 206c 656e 6774 6829  (xpts) - length)
-00029c40: 0a20 2020 2079 7074 732e 6170 7065 6e64  .    ypts.append
-00029c50: 282d 6129 0a20 2020 2078 7074 732e 6170  (-a).    xpts.ap
-00029c60: 7065 6e64 2878 7074 735b 2d31 5d29 0a20  pend(xpts[-1]). 
-00029c70: 2020 2079 7074 732e 6170 7065 6e64 282d     ypts.append(-
-00029c80: 6120 2b20 7769 6474 6829 0a20 2020 2078  a + width).    x
-00029c90: 7074 732e 6170 7065 6e64 2878 7074 735b  pts.append(xpts[
-00029ca0: 305d 290a 2020 2020 7970 7473 2e61 7070  0]).    ypts.app
-00029cb0: 656e 6428 7970 7473 5b30 5d29 0a0a 2020  end(ypts[0])..  
-00029cc0: 2020 7870 7473 203d 206e 702e 6172 7261    xpts = np.arra
-00029cd0: 7928 7870 7473 290a 2020 2020 7970 7473  y(xpts).    ypts
-00029ce0: 203d 206e 702e 6172 7261 7928 7970 7473   = np.array(ypts
-00029cf0: 290a 0a20 2020 2023 203d 3d3d 3d3d 3d3d  )..    # =======
-00029d00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029d10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029d20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029d30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029d40: 3d3d 3d0a 2020 2020 2320 2043 7265 6174  ===.    #  Creat
-00029d50: 6520 6120 626c 616e 6b20 6465 7669 6365  e a blank device
-00029d60: 2c20 6164 6420 7468 6520 6765 6f6d 6574  , add the geomet
-00029d70: 7279 2c20 616e 6420 6465 6669 6e65 2074  ry, and define t
-00029d80: 6865 2070 6f72 7473 0a20 2020 2023 203d  he ports.    # =
-00029d90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029da0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029db0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029dc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029dd0: 3d3d 3d3d 3d3d 3d3d 3d0a 2020 2020 4420  =========.    D 
-00029de0: 3d20 4465 7669 6365 286e 616d 653d 2268  = Device(name="h
-00029df0: 6169 7270 696e 2229 0a20 2020 2044 2e61  airpin").    D.a
-00029e00: 6464 5f70 6f6c 7967 6f6e 285b 7870 7473  dd_polygon([xpts
-00029e10: 2c20 7970 7473 5d2c 206c 6179 6572 3d6c  , ypts], layer=l
-00029e20: 6179 6572 290a 2020 2020 442e 6164 645f  ayer).    D.add_
-00029e30: 706f 6c79 676f 6e28 5b78 7074 732c 202d  polygon([xpts, -
-00029e40: 7970 7473 5d2c 206c 6179 6572 3d6c 6179  ypts], layer=lay
-00029e50: 6572 290a 0a20 2020 2078 706f 7274 7320  er)..    xports 
-00029e60: 3d20 6d69 6e28 7870 7473 290a 2020 2020  = min(xpts).    
-00029e70: 7970 6f72 7473 203d 202d 6120 2b20 7769  yports = -a + wi
-00029e80: 6474 6820 2f20 320a 2020 2020 442e 6164  dth / 2.    D.ad
-00029e90: 645f 706f 7274 286e 616d 653d 312c 206d  d_port(name=1, m
-00029ea0: 6964 706f 696e 743d 5b78 706f 7274 732c  idpoint=[xports,
-00029eb0: 202d 7970 6f72 7473 5d2c 2077 6964 7468   -yports], width
-00029ec0: 3d77 6964 7468 2c20 6f72 6965 6e74 6174  =width, orientat
-00029ed0: 696f 6e3d 3138 3029 0a20 2020 2044 2e61  ion=180).    D.a
-00029ee0: 6464 5f70 6f72 7428 6e61 6d65 3d32 2c20  dd_port(name=2, 
-00029ef0: 6d69 6470 6f69 6e74 3d5b 7870 6f72 7473  midpoint=[xports
-00029f00: 2c20 7970 6f72 7473 5d2c 2077 6964 7468  , yports], width
-00029f10: 3d77 6964 7468 2c20 6f72 6965 6e74 6174  =width, orientat
-00029f20: 696f 6e3d 3138 3029 0a0a 2020 2020 7265  ion=180)..    re
-00029f30: 7475 726e 2044 0a0a 0a40 6465 7669 6365  turn D...@device
-00029f40: 5f6c 7275 5f63 6163 6865 0a64 6566 206f  _lru_cache.def o
-00029f50: 7074 696d 616c 5f73 7465 7028 0a20 2020  ptimal_step(.   
-00029f60: 2073 7461 7274 5f77 6964 7468 3d31 302c   start_width=10,
-00029f70: 0a20 2020 2065 6e64 5f77 6964 7468 3d32  .    end_width=2
-00029f80: 322c 0a20 2020 206e 756d 5f70 7473 3d35  2,.    num_pts=5
-00029f90: 302c 0a20 2020 2077 6964 7468 5f74 6f6c  0,.    width_tol
-00029fa0: 3d31 652d 332c 0a20 2020 2061 6e74 6963  =1e-3,.    antic
-00029fb0: 726f 7764 696e 675f 6661 6374 6f72 3d31  rowding_factor=1
-00029fc0: 2e32 2c0a 2020 2020 7379 6d6d 6574 7269  .2,.    symmetri
-00029fd0: 633d 4661 6c73 652c 0a20 2020 206c 6179  c=False,.    lay
-00029fe0: 6572 3d30 2c0a 293a 0a20 2020 2022 2222  er=0,.):.    """
-00029ff0: 4372 6561 7465 7320 616e 206f 7074 696d  Creates an optim
-0002a000: 616c 6c79 2d72 6f75 6e64 6564 2073 7465  ally-rounded ste
-0002a010: 7020 6765 6f6d 6574 7279 2e0a 0a20 2020  p geometry...   
-0002a020: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-0002a030: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2073  ----------.    s
-0002a040: 7461 7274 5f77 6964 7468 203a 2069 6e74  tart_width : int
-0002a050: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
-0002a060: 2020 5769 6474 6820 6f66 2074 6865 2063    Width of the c
-0002a070: 6f6e 6e65 6374 6f72 206f 6e20 7468 6520  onnector on the 
-0002a080: 6c65 6674 2065 6e64 206f 6620 7468 6520  left end of the 
-0002a090: 7374 6570 2e0a 2020 2020 656e 645f 7769  step..    end_wi
-0002a0a0: 6474 6820 3a20 696e 7420 6f72 2066 6c6f  dth : int or flo
-0002a0b0: 6174 0a20 2020 2020 2020 2057 6964 7468  at.        Width
-0002a0c0: 206f 6620 7468 6520 636f 6e6e 6563 746f   of the connecto
-0002a0d0: 7220 6f6e 2074 6865 2072 6967 6874 2065  r on the right e
-0002a0e0: 6e64 206f 6620 7468 6520 7374 6570 2e0a  nd of the step..
-0002a0f0: 2020 2020 6e75 6d5f 7074 7320 3a20 696e      num_pts : in
-0002a100: 740a 2020 2020 2020 2020 5468 6520 6e75  t.        The nu
-0002a110: 6d62 6572 206f 6620 706f 696e 7473 2063  mber of points c
-0002a120: 6f6d 7072 6973 696e 6720 7468 6520 656e  omprising the en
-0002a130: 7469 7265 2073 7465 7020 6765 6f6d 6574  tire step geomet
-0002a140: 7279 2e0a 2020 2020 7769 6474 685f 746f  ry..    width_to
-0002a150: 6c20 3a20 666c 6f61 740a 2020 2020 2020  l : float.      
-0002a160: 2020 506f 696e 7420 6174 2077 6869 6368    Point at which
-0002a170: 2074 6f20 7465 726d 696e 6174 6520 7468   to terminate th
-0002a180: 6520 6361 6c63 756c 6174 696f 6e20 6f66  e calculation of
-0002a190: 2074 6865 206f 7074 696d 616c 2073 7465   the optimal ste
-0002a1a0: 700a 2020 2020 616e 7469 6372 6f77 6469  p.    anticrowdi
-0002a1b0: 6e67 5f66 6163 746f 7220 3a20 696e 7420  ng_factor : int 
-0002a1c0: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
-0002a1d0: 2046 6163 746f 7220 746f 2072 6564 7563   Factor to reduc
-0002a1e0: 6520 6375 7272 656e 7420 6372 6f77 6469  e current crowdi
-0002a1f0: 6e67 2062 7920 656c 6f6e 6761 7469 6e67  ng by elongating
-0002a200: 0a20 2020 2020 2020 2074 6865 2073 7472  .        the str
-0002a210: 7563 7475 7265 2061 6e64 2072 6564 7563  ucture and reduc
-0002a220: 696e 6720 7468 6520 6375 7276 6174 7572  ing the curvatur
-0002a230: 650a 2020 2020 7379 6d6d 6574 7269 6320  e.    symmetric 
-0002a240: 3a20 626f 6f6c 0a20 2020 2020 2020 2049  : bool.        I
-0002a250: 6620 5472 7565 2c20 6164 6473 2061 206d  f True, adds a m
-0002a260: 6972 726f 7265 6420 636f 7079 206f 6620  irrored copy of 
-0002a270: 7468 6520 7374 6570 2061 6372 6f73 7320  the step across 
-0002a280: 7468 6520 782d 6178 6973 2074 6f20 7468  the x-axis to th
-0002a290: 650a 2020 2020 2020 2020 6765 6f6d 6574  e.        geomet
-0002a2a0: 7279 2061 6e64 2061 646a 7573 7473 2074  ry and adjusts t
-0002a2b0: 6865 2077 6964 7468 206f 6620 7468 6520  he width of the 
-0002a2c0: 706f 7274 732e 0a20 2020 206c 6179 6572  ports..    layer
-0002a2d0: 203a 2069 6e74 2c20 6172 7261 792d 6c69   : int, array-li
-0002a2e0: 6b65 5b32 5d2c 206f 7220 7365 740a 2020  ke[2], or set.  
-0002a2f0: 2020 2020 2020 5370 6563 6966 6963 206c        Specific l
-0002a300: 6179 6572 2873 2920 746f 2070 7574 2070  ayer(s) to put p
-0002a310: 6f6c 7967 6f6e 2067 656f 6d65 7472 7920  olygon geometry 
-0002a320: 6f6e 2e0a 0a20 2020 2052 6574 7572 6e73  on...    Returns
-0002a330: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-0002a340: 2044 203a 2044 6576 6963 650a 2020 2020   D : Device.    
-0002a350: 2020 2020 4120 4465 7669 6365 2063 6f6e      A Device con
-0002a360: 7461 696e 696e 6720 616e 206f 7074 696d  taining an optim
-0002a370: 616c 6c79 2d72 6f75 6e64 6564 2073 7465  ally-rounded ste
-0002a380: 702e 0a0a 2020 2020 4e6f 7465 730a 2020  p...    Notes.  
-0002a390: 2020 2d2d 2d2d 2d0a 2020 2020 4f70 7469    -----.    Opti
-0002a3a0: 6d61 6c20 7374 7275 6374 7572 6520 6672  mal structure fr
-0002a3b0: 6f6d 2068 7474 7073 3a2f 2f64 6f69 2e6f  om https://doi.o
-0002a3c0: 7267 2f31 302e 3131 3033 2f50 6879 7352  rg/10.1103/PhysR
-0002a3d0: 6576 422e 3834 2e31 3734 3531 300a 2020  evB.84.174510.  
-0002a3e0: 2020 436c 656d 2c20 4a2e 2c20 2620 4265    Clem, J., & Be
-0002a3f0: 7267 6772 656e 2c20 4b2e 2028 3230 3131  rggren, K. (2011
-0002a400: 292e 2047 656f 6d65 7472 792d 6465 7065  ). Geometry-depe
-0002a410: 6e64 656e 7420 6372 6974 6963 616c 2063  ndent critical c
-0002a420: 7572 7265 6e74 7320 696e 0a20 2020 2073  urrents in.    s
-0002a430: 7570 6572 636f 6e64 7563 7469 6e67 206e  uperconducting n
-0002a440: 616e 6f63 6972 6375 6974 732e 2050 6879  anocircuits. Phy
-0002a450: 7369 6361 6c20 5265 7669 6577 2042 2c20  sical Review B, 
-0002a460: 3834 2831 3729 2c20 31e2 8093 3237 2e0a  84(17), 1...27..
-0002a470: 2020 2020 2222 220a 0a20 2020 2023 203d      """..    # =
-0002a480: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002a490: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002a4a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002a4b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002a4c0: 3d3d 3d3d 3d3d 3d3d 3d0a 2020 2020 2320  =========.    # 
-0002a4d0: 2043 7265 6174 6520 7468 6520 6261 7369   Create the basi
-0002a4e0: 6320 6765 6f6d 6574 7279 0a20 2020 2023  c geometry.    #
-0002a4f0: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
-0002a500: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002a510: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002a520: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002a530: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2020 2020  ===========.    
-0002a540: 6465 6620 7374 6570 5f70 6f69 6e74 7328  def step_points(
-0002a550: 6574 612c 2057 2c20 6129 3a0a 2020 2020  eta, W, a):.    
-0002a560: 2020 2020 2320 5265 7475 726e 7320 706f      # Returns po
-0002a570: 696e 7473 2066 726f 6d20 6120 756e 6974  ints from a unit
-0002a580: 2073 656d 6963 6972 636c 6520 696e 2074   semicircle in t
-0002a590: 6865 2077 2028 3d20 7520 2b20 6976 2920  he w (= u + iv) 
-0002a5a0: 706c 616e 6520 746f 0a20 2020 2020 2020  plane to.       
-0002a5b0: 2023 2074 6865 206f 7074 696d 616c 2063   # the optimal c
-0002a5c0: 7572 7665 2069 6e20 7468 6520 7a65 7461  urve in the zeta
-0002a5d0: 2028 3d20 7820 2b20 6979 2920 706c 616e   (= x + iy) plan
-0002a5e0: 6520 7768 6963 6820 7472 616e 7369 7469  e which transiti
-0002a5f0: 6f6e 730a 2020 2020 2020 2020 2320 6120  ons.        # a 
-0002a600: 7769 7265 2066 726f 6d20 6120 7769 6474  wire from a widt
-0002a610: 6820 6f66 2027 5727 2074 6f20 6120 7769  h of 'W' to a wi
-0002a620: 6474 6820 6f66 2027 6127 0a20 2020 2020  dth of 'a'.     
-0002a630: 2020 2023 2065 7461 2074 616b 6573 2076     # eta takes v
-0002a640: 616c 7565 2030 2074 6f20 7069 0a0a 2020  alue 0 to pi..  
-0002a650: 2020 2020 2020 5720 3d20 6e70 2e61 7272        W = np.arr
-0002a660: 6179 2857 2c20 6474 7970 653d 636f 6d70  ay(W, dtype=comp
-0002a670: 6c65 7829 0a20 2020 2020 2020 2061 203d  lex).        a =
-0002a680: 206e 702e 6172 7261 7928 612c 2064 7479   np.array(a, dty
-0002a690: 7065 3d63 6f6d 706c 6578 290a 0a20 2020  pe=complex)..   
-0002a6a0: 2020 2020 2067 616d 6d61 203d 2028 6120       gamma = (a 
-0002a6b0: 2a20 6120 2b20 5720 2a20 5729 202f 2028  * a + W * W) / (
-0002a6c0: 6120 2a20 6120 2d20 5720 2a20 5729 0a0a  a * a - W * W)..
-0002a6d0: 2020 2020 2020 2020 7720 3d20 6e70 2e65          w = np.e
-0002a6e0: 7870 2831 6a20 2a20 6574 6129 0a0a 2020  xp(1j * eta)..  
-0002a6f0: 2020 2020 2020 7a65 7461 203d 2028 0a20        zeta = (. 
-0002a700: 2020 2020 2020 2020 2020 2034 0a20 2020             4.   
-0002a710: 2020 2020 2020 2020 202a 2031 6a0a 2020           * 1j.  
-0002a720: 2020 2020 2020 2020 2020 2f20 7069 0a20            / pi. 
-0002a730: 2020 2020 2020 2020 2020 202a 2028 0a20             * (. 
-0002a740: 2020 2020 2020 2020 2020 2020 2020 2057                 W
-0002a750: 202a 206e 702e 6172 6374 616e 2873 7172   * np.arctan(sqr
-0002a760: 7428 2877 202d 2067 616d 6d61 2920 2f20  t((w - gamma) / 
-0002a770: 2867 616d 6d61 202b 2031 2929 290a 2020  (gamma + 1))).  
-0002a780: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
-0002a790: 6120 2a20 6e70 2e61 7263 7461 6e28 7371  a * np.arctan(sq
-0002a7a0: 7274 2828 6761 6d6d 6120 2d20 3129 202f  rt((gamma - 1) /
-0002a7b0: 2028 7720 2d20 6761 6d6d 6129 2929 0a20   (w - gamma))). 
-0002a7c0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0002a7d0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0002a7e0: 7820 3d20 6e70 2e72 6561 6c28 7a65 7461  x = np.real(zeta
-0002a7f0: 290a 2020 2020 2020 2020 7920 3d20 6e70  ).        y = np
-0002a800: 2e69 6d61 6728 7a65 7461 290a 2020 2020  .imag(zeta).    
-0002a810: 2020 2020 7265 7475 726e 2078 2c20 790a      return x, y.
-0002a820: 0a20 2020 2064 6566 2069 6e76 6572 745f  .    def invert_
-0002a830: 7374 6570 5f70 6f69 6e74 2878 5f64 6573  step_point(x_des
-0002a840: 6972 6564 3d2d 3130 2c20 795f 6465 7369  ired=-10, y_desi
-0002a850: 7265 643d 4e6f 6e65 2c20 573d 312c 2061  red=None, W=1, a
-0002a860: 3d32 293a 0a20 2020 2020 2020 2023 2046  =2):.        # F
-0002a870: 696e 6473 2074 6865 2065 7461 2061 7373  inds the eta ass
-0002a880: 6f63 6961 7465 6420 7769 7468 2074 6865  ociated with the
-0002a890: 2076 616c 7565 2078 5f64 6573 6972 6564   value x_desired
-0002a8a0: 2061 6c6f 6e67 2074 6865 0a20 2020 2020   along the.     
-0002a8b0: 2020 2023 206f 7074 696d 616c 2063 7572     # optimal cur
-0002a8c0: 7665 0a20 2020 2020 2020 2064 6566 2066  ve.        def f
-0002a8d0: 6828 6574 6129 3a0a 2020 2020 2020 2020  h(eta):.        
-0002a8e0: 2020 2020 6775 6573 7365 645f 782c 2067      guessed_x, g
-0002a8f0: 7565 7373 6564 5f79 203d 2073 7465 705f  uessed_y = step_
-0002a900: 706f 696e 7473 2865 7461 2c20 573d 572c  points(eta, W=W,
-0002a910: 2061 3d61 290a 2020 2020 2020 2020 2020   a=a).          
-0002a920: 2020 6966 2079 5f64 6573 6972 6564 2069    if y_desired i
-0002a930: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0002a940: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-0002a950: 6775 6573 7365 645f 7820 2d20 785f 6465  guessed_x - x_de
-0002a960: 7369 7265 6429 202a 2a20 3220 2023 2054  sired) ** 2  # T
-0002a970: 6865 2065 7272 6f72 0a20 2020 2020 2020  he error.       
-0002a980: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002a990: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002a9a0: 6e20 2867 7565 7373 6564 5f79 202d 2079  n (guessed_y - y
-0002a9b0: 5f64 6573 6972 6564 2920 2a2a 2032 0a0a  _desired) ** 2..
-0002a9c0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0002a9d0: 2020 2020 2020 2020 2066 726f 6d20 7363           from sc
-0002a9e0: 6970 792e 6f70 7469 6d69 7a65 2069 6d70  ipy.optimize imp
-0002a9f0: 6f72 7420 666d 696e 626f 756e 640a 2020  ort fminbound.  
-0002aa00: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-0002aa10: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-0002aa20: 2020 2020 7261 6973 6520 496d 706f 7274      raise Import
-0002aa30: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0002aa40: 2020 2020 2020 2022 205b 5048 4944 4c5d         " [PHIDL]
-0002aa50: 2054 6f20 7275 6e20 7468 6520 6f70 7469   To run the opti
-0002aa60: 6d61 6c2d 6375 7276 6520 6765 6f6d 6574  mal-curve geomet
-0002aa70: 7279 2022 0a20 2020 2020 2020 2020 2020  ry ".           
-0002aa80: 2020 2020 2022 6675 6e63 7469 6f6e 7320       "functions 
-0002aa90: 796f 7520 6e65 6564 2073 6369 7079 2c20  you need scipy, 
-0002aaa0: 706c 6561 7365 2069 6e73 7461 6c6c 2022  please install "
-0002aab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002aac0: 2022 6974 2077 6974 6820 6070 6970 2069   "it with `pip i
-0002aad0: 6e73 7461 6c6c 2073 6369 7079 6022 0a20  nstall scipy`". 
-0002aae0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0002aaf0: 2020 2020 2066 6f75 6e64 5f65 7461 203d       found_eta =
-0002ab00: 2066 6d69 6e62 6f75 6e64 2866 682c 2078   fminbound(fh, x
-0002ab10: 313d 302c 2078 323d 7069 2c20 6172 6773  1=0, x2=pi, args
-0002ab20: 3d28 2929 0a20 2020 2020 2020 2072 6574  =()).        ret
-0002ab30: 7572 6e20 7374 6570 5f70 6f69 6e74 7328  urn step_points(
-0002ab40: 666f 756e 645f 6574 612c 2057 3d57 2c20  found_eta, W=W, 
-0002ab50: 613d 6129 0a0a 2020 2020 6966 2073 7461  a=a)..    if sta
-0002ab60: 7274 5f77 6964 7468 203e 2065 6e64 5f77  rt_width > end_w
-0002ab70: 6964 7468 3a0a 2020 2020 2020 2020 7265  idth:.        re
-0002ab80: 7665 7273 6520 3d20 5472 7565 0a20 2020  verse = True.   
-0002ab90: 2020 2020 2073 7461 7274 5f77 6964 7468       start_width
-0002aba0: 2c20 656e 645f 7769 6474 6820 3d20 656e  , end_width = en
-0002abb0: 645f 7769 6474 682c 2073 7461 7274 5f77  d_width, start_w
-0002abc0: 6964 7468 0a20 2020 2065 6c73 653a 0a20  idth.    else:. 
-0002abd0: 2020 2020 2020 2072 6576 6572 7365 203d         reverse =
-0002abe0: 2046 616c 7365 0a0a 2020 2020 4420 3d20   False..    D = 
-0002abf0: 4465 7669 6365 286e 616d 653d 2273 7465  Device(name="ste
-0002ac00: 7022 290a 2020 2020 6966 2073 7461 7274  p").    if start
-0002ac10: 5f77 6964 7468 203d 3d20 656e 645f 7769  _width == end_wi
-0002ac20: 6474 683a 2020 2320 4a75 7374 2072 6574  dth:  # Just ret
-0002ac30: 7572 6e20 6120 7371 7561 7265 0a20 2020  urn a square.   
-0002ac40: 2020 2020 2069 6620 7379 6d6d 6574 7269       if symmetri
-0002ac50: 633a 0a20 2020 2020 2020 2020 2020 2079  c:.            y
-0002ac60: 7074 7320 3d20 5b0a 2020 2020 2020 2020  pts = [.        
-0002ac70: 2020 2020 2020 2020 2d73 7461 7274 5f77          -start_w
-0002ac80: 6964 7468 202f 2032 2c0a 2020 2020 2020  idth / 2,.      
-0002ac90: 2020 2020 2020 2020 2020 7374 6172 745f            start_
-0002aca0: 7769 6474 6820 2f20 322c 0a20 2020 2020  width / 2,.     
-0002acb0: 2020 2020 2020 2020 2020 2073 7461 7274             start
-0002acc0: 5f77 6964 7468 202f 2032 2c0a 2020 2020  _width / 2,.    
-0002acd0: 2020 2020 2020 2020 2020 2020 2d73 7461              -sta
-0002ace0: 7274 5f77 6964 7468 202f 2032 2c0a 2020  rt_width / 2,.  
-0002acf0: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
-0002ad00: 2020 2020 2020 2020 7870 7473 203d 205b          xpts = [
-0002ad10: 302c 2030 2c20 7374 6172 745f 7769 6474  0, 0, start_widt
-0002ad20: 682c 2073 7461 7274 5f77 6964 7468 5d0a  h, start_width].
-0002ad30: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-0002ad40: 796d 6d65 7472 6963 3a0a 2020 2020 2020  ymmetric:.      
-0002ad50: 2020 2020 2020 7970 7473 203d 205b 302c        ypts = [0,
-0002ad60: 2073 7461 7274 5f77 6964 7468 2c20 7374   start_width, st
-0002ad70: 6172 745f 7769 6474 682c 2030 5d0a 2020  art_width, 0].  
-0002ad80: 2020 2020 2020 2020 2020 7870 7473 203d            xpts =
-0002ad90: 205b 302c 2030 2c20 7374 6172 745f 7769   [0, 0, start_wi
-0002ada0: 6474 682c 2073 7461 7274 5f77 6964 7468  dth, start_width
-0002adb0: 5d0a 2020 2020 2020 2020 442e 696e 666f  ].        D.info
-0002adc0: 5b22 6e75 6d5f 7371 7561 7265 7322 5d20  ["num_squares"] 
-0002add0: 3d20 310a 2020 2020 656c 7365 3a0a 2020  = 1.    else:.  
-0002ade0: 2020 2020 2020 786d 696e 2c20 796d 696e        xmin, ymin
-0002adf0: 203d 2069 6e76 6572 745f 7374 6570 5f70   = invert_step_p
-0002ae00: 6f69 6e74 280a 2020 2020 2020 2020 2020  oint(.          
-0002ae10: 2020 795f 6465 7369 7265 643d 7374 6172    y_desired=star
-0002ae20: 745f 7769 6474 6820 2a20 2831 202b 2077  t_width * (1 + w
-0002ae30: 6964 7468 5f74 6f6c 292c 2057 3d73 7461  idth_tol), W=sta
-0002ae40: 7274 5f77 6964 7468 2c20 613d 656e 645f  rt_width, a=end_
-0002ae50: 7769 6474 680a 2020 2020 2020 2020 290a  width.        ).
-0002ae60: 2020 2020 2020 2020 786d 6178 2c20 796d          xmax, ym
-0002ae70: 6178 203d 2069 6e76 6572 745f 7374 6570  ax = invert_step
-0002ae80: 5f70 6f69 6e74 280a 2020 2020 2020 2020  _point(.        
-0002ae90: 2020 2020 795f 6465 7369 7265 643d 656e      y_desired=en
-0002aea0: 645f 7769 6474 6820 2a20 2831 202d 2077  d_width * (1 - w
-0002aeb0: 6964 7468 5f74 6f6c 292c 2057 3d73 7461  idth_tol), W=sta
-0002aec0: 7274 5f77 6964 7468 2c20 613d 656e 645f  rt_width, a=end_
-0002aed0: 7769 6474 680a 2020 2020 2020 2020 290a  width.        ).
-0002aee0: 0a20 2020 2020 2020 2078 7074 7320 3d20  .        xpts = 
-0002aef0: 6e70 2e6c 696e 7370 6163 6528 786d 696e  np.linspace(xmin
-0002af00: 2c20 786d 6178 2c20 6e75 6d5f 7074 7329  , xmax, num_pts)
-0002af10: 2e74 6f6c 6973 7428 290a 2020 2020 2020  .tolist().      
-0002af20: 2020 7970 7473 203d 205b 5d0a 2020 2020    ypts = [].    
-0002af30: 2020 2020 666f 7220 7820 696e 2078 7074      for x in xpt
-0002af40: 733a 0a20 2020 2020 2020 2020 2020 2078  s:.            x
-0002af50: 2c20 7920 3d20 696e 7665 7274 5f73 7465  , y = invert_ste
-0002af60: 705f 706f 696e 7428 785f 6465 7369 7265  p_point(x_desire
-0002af70: 643d 782c 2057 3d73 7461 7274 5f77 6964  d=x, W=start_wid
-0002af80: 7468 2c20 613d 656e 645f 7769 6474 6829  th, a=end_width)
-0002af90: 0a20 2020 2020 2020 2020 2020 2079 7074  .            ypt
-0002afa0: 732e 6170 7065 6e64 2879 290a 0a20 2020  s.append(y)..   
-0002afb0: 2020 2020 2079 7074 735b 2d31 5d20 3d20       ypts[-1] = 
-0002afc0: 656e 645f 7769 6474 680a 2020 2020 2020  end_width.      
-0002afd0: 2020 7970 7473 5b30 5d20 3d20 7374 6172    ypts[0] = star
-0002afe0: 745f 7769 6474 680a 2020 2020 2020 2020  t_width.        
-0002aff0: 795f 6e75 6d5f 7371 203d 206e 702e 6172  y_num_sq = np.ar
-0002b000: 7261 7928 7970 7473 290a 2020 2020 2020  ray(ypts).      
-0002b010: 2020 785f 6e75 6d5f 7371 203d 206e 702e    x_num_sq = np.
-0002b020: 6172 7261 7928 7870 7473 290a 0a20 2020  array(xpts)..   
-0002b030: 2020 2020 2069 6620 6e6f 7420 7379 6d6d       if not symm
-0002b040: 6574 7269 633a 0a20 2020 2020 2020 2020  etric:.         
-0002b050: 2020 2078 7074 732e 6170 7065 6e64 2878     xpts.append(x
-0002b060: 7074 735b 2d31 5d29 0a20 2020 2020 2020  pts[-1]).       
-0002b070: 2020 2020 2079 7074 732e 6170 7065 6e64       ypts.append
-0002b080: 2830 290a 2020 2020 2020 2020 2020 2020  (0).            
-0002b090: 7870 7473 2e61 7070 656e 6428 7870 7473  xpts.append(xpts
-0002b0a0: 5b30 5d29 0a20 2020 2020 2020 2020 2020  [0]).           
-0002b0b0: 2079 7074 732e 6170 7065 6e64 2830 290a   ypts.append(0).
-0002b0c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002b0d0: 2020 2020 2020 2020 2020 7870 7473 202b            xpts +
-0002b0e0: 3d20 5b78 2066 6f72 2078 2069 6e20 7870  = [x for x in xp
-0002b0f0: 7473 5b3a 3a2d 315d 5d0a 2020 2020 2020  ts[::-1]].      
-0002b100: 2020 2020 2020 7970 7473 202b 3d20 5b2d        ypts += [-
-0002b110: 7920 666f 7220 7920 696e 2079 7074 735b  y for y in ypts[
-0002b120: 3a3a 2d31 5d5d 0a20 2020 2020 2020 2020  ::-1]].         
-0002b130: 2020 2078 7074 7320 3d20 5b78 202f 2032     xpts = [x / 2
-0002b140: 2066 6f72 2078 2069 6e20 7870 7473 5d0a   for x in xpts].
-0002b150: 2020 2020 2020 2020 2020 2020 7970 7473              ypts
-0002b160: 203d 205b 7920 2f20 3220 666f 7220 7920   = [y / 2 for y 
-0002b170: 696e 2079 7074 735d 0a0a 2020 2020 2020  in ypts]..      
-0002b180: 2020 2320 616e 7469 6372 6f77 6469 6e67    # anticrowding
-0002b190: 5f66 6163 746f 7220 7374 7265 7463 6865  _factor stretche
-0002b1a0: 7320 7468 6520 7769 7265 206f 7574 3b20  s the wire out; 
-0002b1b0: 6120 7374 7265 7463 6865 6420 7769 7265  a stretched wire
-0002b1c0: 2069 7320 610a 2020 2020 2020 2020 2320   is a.        # 
-0002b1d0: 6765 6e74 6c65 7220 7472 616e 7369 7469  gentler transiti
-0002b1e0: 6f6e 2c20 736f 2074 6865 7265 2773 206c  on, so there's l
-0002b1f0: 6573 7320 6368 616e 6365 206f 6620 6375  ess chance of cu
-0002b200: 7272 656e 7420 6372 6f77 6469 6e67 2069  rrent crowding i
-0002b210: 660a 2020 2020 2020 2020 2320 7468 6520  f.        # the 
-0002b220: 6661 6272 6963 6174 696f 6e20 6973 6e27  fabrication isn'
-0002b230: 7420 7065 7266 6563 7420 6275 7420 6173  t perfect but as
-0002b240: 2061 2072 6573 756c 742c 2074 6865 2077   a result, the w
-0002b250: 6972 6520 6973 6e27 7420 6173 0a20 2020  ire isn't as.   
-0002b260: 2020 2020 2023 2073 686f 7274 2061 7320       # short as 
-0002b270: 6974 2063 6f75 6c64 2062 650a 2020 2020  it could be.    
-0002b280: 2020 2020 7870 7473 203d 2028 6e70 2e61      xpts = (np.a
-0002b290: 7272 6179 2878 7074 7329 202a 2061 6e74  rray(xpts) * ant
-0002b2a0: 6963 726f 7764 696e 675f 6661 6374 6f72  icrowding_factor
-0002b2b0: 292e 746f 6c69 7374 2829 0a0a 2020 2020  ).tolist()..    
-0002b2c0: 2020 2020 6966 2072 6576 6572 7365 2069      if reverse i
-0002b2d0: 7320 5472 7565 3a0a 2020 2020 2020 2020  s True:.        
-0002b2e0: 2020 2020 7870 7473 203d 2028 2d6e 702e      xpts = (-np.
-0002b2f0: 6172 7261 7928 7870 7473 2929 2e74 6f6c  array(xpts)).tol
-0002b300: 6973 7428 290a 2020 2020 2020 2020 2020  ist().          
-0002b310: 2020 7374 6172 745f 7769 6474 682c 2065    start_width, e
-0002b320: 6e64 5f77 6964 7468 203d 2065 6e64 5f77  nd_width = end_w
-0002b330: 6964 7468 2c20 7374 6172 745f 7769 6474  idth, start_widt
-0002b340: 680a 0a20 2020 2020 2020 2044 2e69 6e66  h..        D.inf
-0002b350: 6f5b 226e 756d 5f73 7175 6172 6573 225d  o["num_squares"]
-0002b360: 203d 206e 702e 7375 6d28 0a20 2020 2020   = np.sum(.     
-0002b370: 2020 2020 2020 206e 702e 6469 6666 2878         np.diff(x
-0002b380: 5f6e 756d 5f73 7129 202f 2028 2879 5f6e  _num_sq) / ((y_n
-0002b390: 756d 5f73 715b 3a2d 315d 202b 2079 5f6e  um_sq[:-1] + y_n
-0002b3a0: 756d 5f73 715b 313a 5d29 202f 2032 290a  um_sq[1:]) / 2).
-0002b3b0: 2020 2020 2020 2020 290a 0a20 2020 2023          )..    #
-0002b3c0: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
-0002b3d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002b3e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002b3f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002b400: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2020 2020  ===========.    
-0002b410: 2320 2043 7265 6174 6520 6120 626c 616e  #  Create a blan
-0002b420: 6b20 6465 7669 6365 2c20 6164 6420 7468  k device, add th
-0002b430: 6520 6765 6f6d 6574 7279 2c20 616e 6420  e geometry, and 
-0002b440: 6465 6669 6e65 2074 6865 2070 6f72 7473  define the ports
-0002b450: 0a20 2020 2023 203d 3d3d 3d3d 3d3d 3d3d  .    # =========
-0002b460: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002b470: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002b480: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002b490: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002b4a0: 3d0a 2020 2020 442e 6164 645f 706f 6c79  =.    D.add_poly
-0002b4b0: 676f 6e28 5b78 7074 732c 2079 7074 735d  gon([xpts, ypts]
-0002b4c0: 2c20 6c61 7965 723d 6c61 7965 7229 0a0a  , layer=layer)..
-0002b4d0: 2020 2020 6966 206e 6f74 2073 796d 6d65      if not symme
-0002b4e0: 7472 6963 3a0a 2020 2020 2020 2020 442e  tric:.        D.
-0002b4f0: 6164 645f 706f 7274 280a 2020 2020 2020  add_port(.      
-0002b500: 2020 2020 2020 6e61 6d65 3d31 2c0a 2020        name=1,.  
-0002b510: 2020 2020 2020 2020 2020 6d69 6470 6f69            midpoi
-0002b520: 6e74 3d5b 6d69 6e28 7870 7473 292c 2073  nt=[min(xpts), s
-0002b530: 7461 7274 5f77 6964 7468 202f 2032 5d2c  tart_width / 2],
-0002b540: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
-0002b550: 7468 3d73 7461 7274 5f77 6964 7468 2c0a  th=start_width,.
-0002b560: 2020 2020 2020 2020 2020 2020 6f72 6965              orie
-0002b570: 6e74 6174 696f 6e3d 3138 302c 0a20 2020  ntation=180,.   
-0002b580: 2020 2020 2029 0a20 2020 2020 2020 2044       ).        D
-0002b590: 2e61 6464 5f70 6f72 7428 0a20 2020 2020  .add_port(.     
-0002b5a0: 2020 2020 2020 206e 616d 653d 322c 206d         name=2, m
-0002b5b0: 6964 706f 696e 743d 5b6d 6178 2878 7074  idpoint=[max(xpt
-0002b5c0: 7329 2c20 656e 645f 7769 6474 6820 2f20  s), end_width / 
-0002b5d0: 325d 2c20 7769 6474 683d 656e 645f 7769  2], width=end_wi
-0002b5e0: 6474 682c 206f 7269 656e 7461 7469 6f6e  dth, orientation
-0002b5f0: 3d30 0a20 2020 2020 2020 2029 0a20 2020  =0.        ).   
-0002b600: 2069 6620 7379 6d6d 6574 7269 633a 0a20   if symmetric:. 
-0002b610: 2020 2020 2020 2044 2e61 6464 5f70 6f72         D.add_por
-0002b620: 7428 6e61 6d65 3d31 2c20 6d69 6470 6f69  t(name=1, midpoi
-0002b630: 6e74 3d5b 6d69 6e28 7870 7473 292c 2030  nt=[min(xpts), 0
-0002b640: 5d2c 2077 6964 7468 3d73 7461 7274 5f77  ], width=start_w
-0002b650: 6964 7468 2c20 6f72 6965 6e74 6174 696f  idth, orientatio
-0002b660: 6e3d 3138 3029 0a20 2020 2020 2020 2044  n=180).        D
-0002b670: 2e61 6464 5f70 6f72 7428 6e61 6d65 3d32  .add_port(name=2
-0002b680: 2c20 6d69 6470 6f69 6e74 3d5b 6d61 7828  , midpoint=[max(
-0002b690: 7870 7473 292c 2030 5d2c 2077 6964 7468  xpts), 0], width
-0002b6a0: 3d65 6e64 5f77 6964 7468 2c20 6f72 6965  =end_width, orie
-0002b6b0: 6e74 6174 696f 6e3d 3029 0a0a 2020 2020  ntation=0)..    
-0002b6c0: 7265 7475 726e 2044 0a0a 0a64 6566 206f  return D...def o
-0002b6d0: 7074 696d 616c 5f39 3064 6567 2877 6964  ptimal_90deg(wid
-0002b6e0: 7468 3d31 3030 2e30 2c20 6e75 6d5f 7074  th=100.0, num_pt
-0002b6f0: 733d 3135 2c20 6c65 6e67 7468 5f61 646a  s=15, length_adj
-0002b700: 7573 743d 312c 206c 6179 6572 3d30 293a  ust=1, layer=0):
-0002b710: 0a20 2020 2022 2222 4372 6561 7465 7320  .    """Creates 
-0002b720: 616e 206f 7074 696d 616c 6c79 2d72 6f75  an optimally-rou
-0002b730: 6e64 6564 2039 3020 6465 6772 6565 2062  nded 90 degree b
-0002b740: 656e 6420 7468 6174 2069 7320 7368 6172  end that is shar
-0002b750: 7020 6f6e 2074 6865 206f 7574 6572 0a20  p on the outer. 
-0002b760: 2020 2063 6f72 6e65 722e 0a0a 2020 2020     corner...    
-0002b770: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-0002b780: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7769  ---------.    wi
-0002b790: 6474 6820 3a20 696e 7420 6f72 2066 6c6f  dth : int or flo
-0002b7a0: 6174 0a20 2020 2020 2020 2057 6964 7468  at.        Width
-0002b7b0: 206f 6620 7468 6520 706f 7274 7320 6f6e   of the ports on
-0002b7c0: 2065 6974 6865 7220 7369 6465 206f 6620   either side of 
-0002b7d0: 7468 6520 6265 6e64 2e0a 2020 2020 6e75  the bend..    nu
-0002b7e0: 6d5f 7074 7320 3a20 696e 740a 2020 2020  m_pts : int.    
-0002b7f0: 2020 2020 5468 6520 6e75 6d62 6572 206f      The number o
-0002b800: 6620 706f 696e 7473 2063 6f6d 7072 6973  f points compris
-0002b810: 696e 6720 7468 6520 6375 7276 6564 2073  ing the curved s
-0002b820: 6563 7469 6f6e 206f 6620 7468 6520 6265  ection of the be
-0002b830: 6e64 2e0a 2020 2020 6c65 6e67 7468 5f61  nd..    length_a
-0002b840: 646a 7573 7420 3a20 696e 7420 6f72 2066  djust : int or f
-0002b850: 6c6f 6174 0a20 2020 2020 2020 2041 646a  loat.        Adj
-0002b860: 7573 7473 2074 6865 206c 656e 6774 6820  usts the length 
-0002b870: 6f66 2074 6865 206e 6f6e 2d63 7572 7665  of the non-curve
-0002b880: 6420 706f 7274 696f 6e20 6f66 2074 6865  d portion of the
-0002b890: 2062 656e 642e 0a20 2020 206c 6179 6572   bend..    layer
-0002b8a0: 203a 2069 6e74 2c20 6172 7261 792d 6c69   : int, array-li
-0002b8b0: 6b65 5b32 5d2c 206f 7220 7365 740a 2020  ke[2], or set.  
-0002b8c0: 2020 2020 2020 5370 6563 6966 6963 206c        Specific l
-0002b8d0: 6179 6572 2873 2920 746f 2070 7574 2070  ayer(s) to put p
-0002b8e0: 6f6c 7967 6f6e 2067 656f 6d65 7472 7920  olygon geometry 
-0002b8f0: 6f6e 2e0a 0a20 2020 2052 6574 7572 6e73  on...    Returns
-0002b900: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-0002b910: 2044 203a 2044 6576 6963 650a 2020 2020   D : Device.    
-0002b920: 2020 2020 4120 4465 7669 6365 2063 6f6e      A Device con
-0002b930: 7461 696e 696e 6720 616e 206f 7074 696d  taining an optim
-0002b940: 616c 6c79 2d72 6f75 6e64 6564 2039 3020  ally-rounded 90 
-0002b950: 6465 6772 6565 2062 656e 642e 0a0a 2020  degree bend...  
-0002b960: 2020 4e6f 7465 730a 2020 2020 2d2d 2d2d    Notes.    ----
-0002b970: 2d0a 2020 2020 4f70 7469 6d61 6c20 7374  -.    Optimal st
-0002b980: 7275 6374 7572 6520 6672 6f6d 2068 7474  ructure from htt
-0002b990: 7073 3a2f 2f64 6f69 2e6f 7267 2f31 302e  ps://doi.org/10.
-0002b9a0: 3131 3033 2f50 6879 7352 6576 422e 3834  1103/PhysRevB.84
-0002b9b0: 2e31 3734 3531 300a 2020 2020 436c 656d  .174510.    Clem
-0002b9c0: 2c20 4a2e 2c20 2620 4265 7267 6772 656e  , J., & Berggren
-0002b9d0: 2c20 4b2e 2028 3230 3131 292e 2047 656f  , K. (2011). Geo
-0002b9e0: 6d65 7472 792d 6465 7065 6e64 656e 7420  metry-dependent 
-0002b9f0: 6372 6974 6963 616c 2063 7572 7265 6e74  critical current
-0002ba00: 7320 696e 0a20 2020 2073 7570 6572 636f  s in.    superco
-0002ba10: 6e64 7563 7469 6e67 206e 616e 6f63 6972  nducting nanocir
-0002ba20: 6375 6974 732e 2050 6879 7369 6361 6c20  cuits. Physical 
-0002ba30: 5265 7669 6577 2042 2c20 3834 2831 3729  Review B, 84(17)
-0002ba40: 2c20 31e2 8093 3237 2e0a 2020 2020 2222  , 1...27..    ""
-0002ba50: 220a 2020 2020 4420 3d20 4465 7669 6365  ".    D = Device
-0002ba60: 2822 3930 6465 6722 290a 0a20 2020 2023  ("90deg")..    #
-0002ba70: 2047 6574 2070 6f69 6e74 7320 6f66 2069   Get points of i
-0002ba80: 6465 616c 2063 7572 7665 0a20 2020 2061  deal curve.    a
-0002ba90: 203d 2032 202a 2077 6964 7468 0a20 2020   = 2 * width.   
-0002baa0: 2076 203d 206e 702e 6c6f 6773 7061 6365   v = np.logspace
-0002bab0: 282d 6c65 6e67 7468 5f61 646a 7573 742c  (-length_adjust,
-0002bac0: 206c 656e 6774 685f 6164 6a75 7374 2c20   length_adjust, 
-0002bad0: 6e75 6d5f 7074 7329 0a20 2020 2078 6920  num_pts).    xi 
-0002bae0: 3d20 280a 2020 2020 2020 2020 6120 2f20  = (.        a / 
-0002baf0: 322e 3020 2a20 2828 3120 2b20 3220 2f20  2.0 * ((1 + 2 / 
-0002bb00: 7069 202a 206e 702e 6172 6373 696e 6828  pi * np.arcsinh(
-0002bb10: 3120 2f20 7629 2920 2b20 316a 202a 2028  1 / v)) + 1j * (
-0002bb20: 3120 2b20 3220 2f20 7069 202a 206e 702e  1 + 2 / pi * np.
-0002bb30: 6172 6373 696e 6828 7629 2929 0a20 2020  arcsinh(v))).   
-0002bb40: 2029 0a20 2020 2078 7074 7320 3d20 6c69   ).    xpts = li
-0002bb50: 7374 286e 702e 7265 616c 2878 6929 290a  st(np.real(xi)).
-0002bb60: 2020 2020 7970 7473 203d 206c 6973 7428      ypts = list(
-0002bb70: 6e70 2e69 6d61 6728 7869 2929 0a0a 2020  np.imag(xi))..  
-0002bb80: 2020 2320 4164 6420 706f 696e 7473 2066    # Add points f
-0002bb90: 6f72 2074 6865 2072 6573 7420 6f66 2063  or the rest of c
-0002bba0: 7572 7665 0a20 2020 2064 203d 2032 202a  urve.    d = 2 *
-0002bbb0: 2078 7074 735b 305d 2020 2320 4661 7274   xpts[0]  # Fart
-0002bbc0: 6865 7374 2070 6f69 6e74 206f 7574 202a  hest point out *
-0002bbd0: 2032 2c20 726f 756e 6465 6420 746f 206e   2, rounded to n
-0002bbe0: 6561 7265 7374 2031 3030 0a20 2020 2078  earest 100.    x
-0002bbf0: 7074 732e 6170 7065 6e64 2877 6964 7468  pts.append(width
-0002bc00: 290a 2020 2020 7970 7473 2e61 7070 656e  ).    ypts.appen
-0002bc10: 6428 6429 0a20 2020 2078 7074 732e 6170  d(d).    xpts.ap
-0002bc20: 7065 6e64 2830 290a 2020 2020 7970 7473  pend(0).    ypts
-0002bc30: 2e61 7070 656e 6428 6429 0a20 2020 2078  .append(d).    x
-0002bc40: 7074 732e 6170 7065 6e64 2830 290a 2020  pts.append(0).  
-0002bc50: 2020 7970 7473 2e61 7070 656e 6428 3029    ypts.append(0)
-0002bc60: 0a20 2020 2078 7074 732e 6170 7065 6e64  .    xpts.append
-0002bc70: 2864 290a 2020 2020 7970 7473 2e61 7070  (d).    ypts.app
-0002bc80: 656e 6428 3029 0a20 2020 2078 7074 732e  end(0).    xpts.
-0002bc90: 6170 7065 6e64 2864 290a 2020 2020 7970  append(d).    yp
-0002bca0: 7473 2e61 7070 656e 6428 7769 6474 6829  ts.append(width)
-0002bcb0: 0a20 2020 2078 7074 732e 6170 7065 6e64  .    xpts.append
-0002bcc0: 2878 7074 735b 305d 290a 2020 2020 7970  (xpts[0]).    yp
-0002bcd0: 7473 2e61 7070 656e 6428 7970 7473 5b30  ts.append(ypts[0
-0002bce0: 5d29 0a0a 2020 2020 442e 6164 645f 706f  ])..    D.add_po
-0002bcf0: 6c79 676f 6e28 5b78 7074 732c 2079 7074  lygon([xpts, ypt
-0002bd00: 735d 2c20 6c61 7965 723d 6c61 7965 7229  s], layer=layer)
-0002bd10: 0a0a 2020 2020 442e 6164 645f 706f 7274  ..    D.add_port
-0002bd20: 286e 616d 653d 312c 206d 6964 706f 696e  (name=1, midpoin
-0002bd30: 743d 5b61 202f 2034 2c20 645d 2c20 7769  t=[a / 4, d], wi
-0002bd40: 6474 683d 6120 2f20 322c 206f 7269 656e  dth=a / 2, orien
-0002bd50: 7461 7469 6f6e 3d39 3029 0a20 2020 2044  tation=90).    D
-0002bd60: 2e61 6464 5f70 6f72 7428 6e61 6d65 3d32  .add_port(name=2
-0002bd70: 2c20 6d69 6470 6f69 6e74 3d5b 642c 2061  , midpoint=[d, a
-0002bd80: 202f 2034 5d2c 2077 6964 7468 3d61 202f   / 4], width=a /
-0002bd90: 2032 2c20 6f72 6965 6e74 6174 696f 6e3d   2, orientation=
-0002bda0: 3029 0a20 2020 2072 6574 7572 6e20 440a  0).    return D.
-0002bdb0: 0a0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ..# ============
-0002bdc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002bdd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002bde0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002bdf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002be00: 3d3d 0a23 2045 7861 6d70 6c65 2063 6f64  ==.# Example cod
-0002be10: 650a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  e.# ============
-0002be20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002be30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002be40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002be50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002be60: 3d3d 0a0a 2320 6861 6972 7069 6e20 3d20  ==..# hairpin = 
-0002be70: 6f70 7469 6d61 6c5f 6861 6972 7069 6e28  optimal_hairpin(
-0002be80: 7769 6474 6820 3d20 312c 2070 6974 6368  width = 1, pitch
-0002be90: 203d 2033 2c20 6c65 6e67 7468 203d 2033   = 3, length = 3
-0002bea0: 302c 206e 756d 5f70 7473 203d 2032 3029  0, num_pts = 20)
-0002beb0: 0a23 2071 7569 636b 706c 6f74 2868 6169  .# quickplot(hai
-0002bec0: 7270 696e 290a 0a0a 2320 7374 6570 203d  rpin)...# step =
-0002bed0: 206f 7074 696d 616c 5f73 7465 7028 7374   optimal_step(st
-0002bee0: 6172 745f 7769 6474 6820 3d20 352c 2065  art_width = 5, e
-0002bef0: 6e64 5f77 6964 7468 203d 2031 2c20 6e75  nd_width = 1, nu
-0002bf00: 6d5f 7074 7320 3d20 3830 2c20 7769 6474  m_pts = 80, widt
-0002bf10: 685f 746f 6c20 3d20 3165 2d33 290a 2320  h_tol = 1e-3).# 
-0002bf20: 7175 6963 6b70 6c6f 7428 7374 6570 290a  quickplot(step).
-0002bf30: 0a0a 2320 7475 726e 203d 206f 7074 696d  ..# turn = optim
-0002bf40: 616c 5f39 3064 6567 2877 6964 7468 203d  al_90deg(width =
-0002bf50: 2039 302c 206c 656e 6774 685f 6164 6a75   90, length_adju
-0002bf60: 7374 203d 2031 290a 2320 7175 6963 6b70  st = 1).# quickp
-0002bf70: 6c6f 7428 7475 726e 290a 0a0a 2320 3d3d  lot(turn)...# ==
-0002bf80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002bf90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002bfa0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002bfb0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002bfc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a23 0a23  ============.#.#
-0002bfd0: 2053 7570 6572 636f 6e64 7563 7469 6e67   Superconducting
-0002bfe0: 2064 6576 6963 6573 0a23 0a23 203d 3d3d   devices.#.# ===
-0002bff0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002c000: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002c010: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002c020: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002c030: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a0a 4064  ===========...@d
-0002c040: 6576 6963 655f 6c72 755f 6361 6368 650a  evice_lru_cache.
-0002c050: 6465 6620 736e 7370 6428 0a20 2020 2077  def snspd(.    w
-0002c060: 6972 655f 7769 6474 683d 302e 322c 0a20  ire_width=0.2,. 
-0002c070: 2020 2077 6972 655f 7069 7463 683d 302e     wire_pitch=0.
-0002c080: 362c 0a20 2020 2073 697a 653d 2831 302c  6,.    size=(10,
-0002c090: 2038 292c 0a20 2020 206e 756d 5f73 7175   8),.    num_squ
-0002c0a0: 6172 6573 3d4e 6f6e 652c 0a20 2020 2074  ares=None,.    t
-0002c0b0: 7572 6e5f 7261 7469 6f3d 342c 0a20 2020  urn_ratio=4,.   
-0002c0c0: 2074 6572 6d69 6e61 6c73 5f73 616d 655f   terminals_same_
-0002c0d0: 7369 6465 3d46 616c 7365 2c0a 2020 2020  side=False,.    
-0002c0e0: 6c61 7965 723d 302c 0a29 3a0a 2020 2020  layer=0,.):.    
-0002c0f0: 2222 2243 7265 6174 6573 2061 6e20 6f70  """Creates an op
-0002c100: 7469 6d61 6c6c 792d 726f 756e 6465 6420  timally-rounded 
-0002c110: 534e 5350 442e 0a0a 2020 2020 5061 7261  SNSPD...    Para
-0002c120: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-0002c130: 2d2d 2d2d 2d0a 2020 2020 7769 6474 6820  -----.    width 
-0002c140: 3a20 696e 7420 6f72 2066 6c6f 6174 0a20  : int or float. 
-0002c150: 2020 2020 2020 2057 6964 7468 206f 6620         Width of 
-0002c160: 7468 6520 7769 7265 2e0a 2020 2020 7069  the wire..    pi
-0002c170: 7463 6820 3a20 696e 7420 6f72 2066 6c6f  tch : int or flo
-0002c180: 6174 0a20 2020 2020 2020 2044 6973 7461  at.        Dista
-0002c190: 6e63 6520 6265 7477 6565 6e20 7477 6f20  nce between two 
-0002c1a0: 6164 6a61 6365 6e74 2077 6972 6573 2e20  adjacent wires. 
-0002c1b0: 4d75 7374 2062 6520 6772 6561 7465 7220  Must be greater 
-0002c1c0: 7468 616e 2060 7769 6474 6860 2e0a 2020  than `width`..  
-0002c1d0: 2020 7369 7a65 203a 204e 6f6e 6520 6f72    size : None or
-0002c1e0: 2061 7272 6179 2d6c 696b 655b 325d 206f   array-like[2] o
-0002c1f0: 6620 696e 7420 6f72 2066 6c6f 6174 0a20  f int or float. 
-0002c200: 2020 2020 2020 2028 7769 6474 682c 2068         (width, h
-0002c210: 6569 6768 7429 206f 6620 7468 6520 7265  eight) of the re
-0002c220: 6374 616e 676c 6520 666f 726d 6564 2062  ctangle formed b
-0002c230: 7920 7468 6520 6f75 7465 7220 626f 756e  y the outer boun
-0002c240: 6461 7279 206f 6620 7468 650a 2020 2020  dary of the.    
-0002c250: 2020 2020 534e 5350 442e 204d 7573 7420      SNSPD. Must 
-0002c260: 6265 206e 6f6e 6520 6966 2060 6e75 6d5f  be none if `num_
-0002c270: 7371 7561 7265 7360 2069 7320 7370 6563  squares` is spec
-0002c280: 6966 6965 642e 0a20 2020 206e 756d 5f73  ified..    num_s
-0002c290: 7175 6172 6573 203a 2069 6e74 206f 7220  quares : int or 
-0002c2a0: 4e6f 6e65 0a20 2020 2020 2020 2054 6f74  None.        Tot
-0002c2b0: 616c 206e 756d 6265 7220 6f66 2073 7175  al number of squ
-0002c2c0: 6172 6573 2069 6e73 6964 6520 7468 6520  ares inside the 
-0002c2d0: 534e 5350 4420 6c65 6e67 7468 2e20 4d75  SNSPD length. Mu
-0002c2e0: 7374 2062 6520 6e6f 6e65 2069 660a 2020  st be none if.  
-0002c2f0: 2020 2020 2020 6073 697a 6560 2069 7320        `size` is 
-0002c300: 7370 6563 6966 6965 642e 0a20 2020 2074  specified..    t
-0002c310: 7572 6e5f 7261 7469 6f20 3a20 696e 7420  urn_ratio : int 
-0002c320: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
-0002c330: 2053 7065 6369 6669 6573 2068 6f77 206d   Specifies how m
-0002c340: 7563 6820 6f66 2074 6865 2053 4e53 5044  uch of the SNSPD
-0002c350: 2077 6964 7468 2069 7320 6465 6469 6361   width is dedica
-0002c360: 7465 6420 746f 2074 6865 2031 3830 2064  ted to the 180 d
-0002c370: 6567 7265 650a 2020 2020 2020 2020 7475  egree.        tu
-0002c380: 726e 2e20 4120 6074 7572 6e5f 7261 7469  rn. A `turn_rati
-0002c390: 6f60 206f 6620 3130 2077 696c 6c20 7265  o` of 10 will re
-0002c3a0: 7375 6c74 2069 6e20 3230 2520 6f66 2074  sult in 20% of t
-0002c3b0: 6865 2077 6964 7468 2062 6569 6e67 0a20  he width being. 
-0002c3c0: 2020 2020 2020 2063 6f6d 7072 6973 6564         comprised
-0002c3d0: 206f 6620 7468 6520 7475 726e 2e0a 2020   of the turn..  
-0002c3e0: 2020 7465 726d 696e 616c 735f 7361 6d65    terminals_same
-0002c3f0: 5f73 6964 6520 3a20 626f 6f6c 0a20 2020  _side : bool.   
-0002c400: 2020 2020 2049 6620 5472 7565 2c20 626f       If True, bo
-0002c410: 7468 2070 6f72 7473 2077 696c 6c20 6265  th ports will be
-0002c420: 206c 6f63 6174 6564 206f 6e20 7468 6520   located on the 
-0002c430: 7361 6d65 2073 6964 6520 6f66 2074 6865  same side of the
-0002c440: 2053 4e53 5044 2e0a 2020 2020 6c61 7965   SNSPD..    laye
-0002c450: 7220 3a20 696e 742c 2061 7272 6179 2d6c  r : int, array-l
-0002c460: 696b 655b 325d 2c20 6f72 2073 6574 0a20  ike[2], or set. 
-0002c470: 2020 2020 2020 2053 7065 6369 6669 6320         Specific 
-0002c480: 6c61 7965 7228 7329 2074 6f20 7075 7420  layer(s) to put 
-0002c490: 706f 6c79 676f 6e20 6765 6f6d 6574 7279  polygon geometry
-0002c4a0: 206f 6e2e 0a0a 2020 2020 5265 7475 726e   on...    Return
-0002c4b0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-0002c4c0: 2020 4420 3a20 4465 7669 6365 0a20 2020    D : Device.   
-0002c4d0: 2020 2020 2041 2044 6576 6963 6520 636f       A Device co
-0002c4e0: 6e74 6169 6e69 6e67 2061 6e20 6f70 7469  ntaining an opti
-0002c4f0: 6d61 6c6c 792d 726f 756e 6465 6420 534e  mally-rounded SN
-0002c500: 5350 442e 0a20 2020 2022 2222 0a20 2020  SPD..    """.   
-0002c510: 2023 2043 6f6e 7665 6e69 656e 6365 2074   # Convenience t
-0002c520: 6573 7473 2074 6f20 6175 746f 2d73 6861  ests to auto-sha
-0002c530: 7065 2074 6865 2073 697a 6520 6261 7365  pe the size base
-0002c540: 640a 2020 2020 2320 6f6e 2074 6865 206e  d.    # on the n
-0002c550: 756d 6265 7220 6f66 2073 7175 6172 6573  umber of squares
-0002c560: 0a20 2020 2069 6620 6e75 6d5f 7371 7561  .    if num_squa
-0002c570: 7265 7320 6973 206e 6f74 204e 6f6e 6520  res is not None 
-0002c580: 616e 6420 280a 2020 2020 2020 2020 2873  and (.        (s
-0002c590: 697a 6520 6973 204e 6f6e 6529 206f 7220  ize is None) or 
-0002c5a0: 2828 7369 7a65 5b30 5d20 6973 204e 6f6e  ((size[0] is Non
-0002c5b0: 6529 2061 6e64 2028 7369 7a65 5b31 5d29  e) and (size[1])
-0002c5c0: 2069 7320 4e6f 6e65 290a 2020 2020 293a   is None).    ):
-0002c5d0: 0a20 2020 2020 2020 2078 7920 3d20 6e70  .        xy = np
-0002c5e0: 2e73 7172 7428 6e75 6d5f 7371 7561 7265  .sqrt(num_square
-0002c5f0: 7320 2a20 7769 7265 5f70 6974 6368 202a  s * wire_pitch *
-0002c600: 2077 6972 655f 7769 6474 6829 0a20 2020   wire_width).   
-0002c610: 2020 2020 2073 697a 6520 3d20 5b78 792c       size = [xy,
-0002c620: 2078 795d 0a20 2020 2020 2020 206e 756d   xy].        num
-0002c630: 5f73 7175 6172 6573 203d 204e 6f6e 650a  _squares = None.
-0002c640: 2020 2020 6966 205b 7369 7a65 5b30 5d2c      if [size[0],
-0002c650: 2073 697a 655b 315d 2c20 6e75 6d5f 7371   size[1], num_sq
-0002c660: 7561 7265 735d 2e63 6f75 6e74 284e 6f6e  uares].count(Non
-0002c670: 6529 2021 3d20 313a 0a20 2020 2020 2020  e) != 1:.       
-0002c680: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-0002c690: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
-0002c6a0: 5b50 4849 444c 5d20 736e 7370 6428 2920  [PHIDL] snspd() 
-0002c6b0: 7265 7175 6972 6573 2074 6861 7420 6578  requires that ex
-0002c6c0: 6163 746c 7920 4f4e 4520 7661 6c75 6520  actly ONE value 
-0002c6d0: 6f66 2022 0a20 2020 2020 2020 2020 2020  of ".           
-0002c6e0: 2022 7468 6520 6172 6775 6d65 6e74 7320   "the arguments 
-0002c6f0: 6060 6e75 6d5f 7371 7561 7265 7360 6020  ``num_squares`` 
-0002c700: 616e 6420 6060 7369 7a65 6060 2062 6520  and ``size`` be 
-0002c710: 4e6f 6e65 2022 0a20 2020 2020 2020 2020  None ".         
-0002c720: 2020 2022 746f 2070 7265 7665 6e74 206f     "to prevent o
-0002c730: 7665 7263 6f6e 7374 7261 696e 696e 672c  verconstraining,
-0002c740: 2066 6f72 2065 7861 6d70 6c65 3a5c 6e22   for example:\n"
-0002c750: 0a20 2020 2020 2020 2020 2020 2022 3e3e  .            ">>
-0002c760: 3e20 736e 7370 6428 7369 7a65 203d 2028  > snspd(size = (
-0002c770: 332c 204e 6f6e 6529 2c20 6e75 6d5f 7371  3, None), num_sq
-0002c780: 7561 7265 7320 3d20 3230 3030 2922 0a20  uares = 2000)". 
-0002c790: 2020 2020 2020 2029 0a20 2020 2069 6620         ).    if 
-0002c7a0: 7369 7a65 5b30 5d20 6973 204e 6f6e 653a  size[0] is None:
-0002c7b0: 0a20 2020 2020 2020 2079 7369 7a65 203d  .        ysize =
-0002c7c0: 2073 697a 655b 315d 0a20 2020 2020 2020   size[1].       
-0002c7d0: 2078 7369 7a65 203d 206e 756d 5f73 7175   xsize = num_squ
-0002c7e0: 6172 6573 202a 2077 6972 655f 7069 7463  ares * wire_pitc
-0002c7f0: 6820 2a20 7769 7265 5f77 6964 7468 202f  h * wire_width /
-0002c800: 2079 7369 7a65 0a20 2020 2065 6c69 6620   ysize.    elif 
-0002c810: 7369 7a65 5b31 5d20 6973 204e 6f6e 653a  size[1] is None:
-0002c820: 0a20 2020 2020 2020 2078 7369 7a65 203d  .        xsize =
-0002c830: 2073 697a 655b 305d 0a20 2020 2020 2020   size[0].       
-0002c840: 2079 7369 7a65 203d 206e 756d 5f73 7175   ysize = num_squ
-0002c850: 6172 6573 202a 2077 6972 655f 7069 7463  ares * wire_pitc
-0002c860: 6820 2a20 7769 7265 5f77 6964 7468 202f  h * wire_width /
-0002c870: 2078 7369 7a65 0a20 2020 2065 6c73 653a   xsize.    else:
-0002c880: 0a20 2020 2020 2020 2078 7369 7a65 203d  .        xsize =
-0002c890: 2073 697a 655b 305d 0a20 2020 2020 2020   size[0].       
-0002c8a0: 2079 7369 7a65 203d 2073 697a 655b 315d   ysize = size[1]
-0002c8b0: 0a0a 2020 2020 6e75 6d5f 6d65 616e 6465  ..    num_meande
-0002c8c0: 7273 203d 2069 6e74 286e 702e 6365 696c  rs = int(np.ceil
-0002c8d0: 2879 7369 7a65 202f 2077 6972 655f 7069  (ysize / wire_pi
-0002c8e0: 7463 6829 290a 0a20 2020 2044 203d 2044  tch))..    D = D
-0002c8f0: 6576 6963 6528 6e61 6d65 3d22 736e 7370  evice(name="snsp
-0002c900: 6422 290a 2020 2020 6861 6972 7069 6e20  d").    hairpin 
+00023960: 3d0a 0a23 2050 203d 2070 6f6c 7967 6f6e  =..# P = polygon
+00023970: 2878 7074 733d 5b2d 312c 2d33 2c20 302c  (xpts=[-1,-3, 0,
+00023980: 2030 5d2c 2079 7074 7320 3d20 5b30 2c20   0], ypts = [0, 
+00023990: 312c 2032 2c20 305d 2c20 6c61 7965 7220  1, 2, 0], layer 
+000239a0: 3d20 3329 0a23 2071 7569 636b 706c 6f74  = 3).# quickplot
+000239b0: 2850 290a 0a0a 4064 6576 6963 655f 6c72  (P)...@device_lr
+000239c0: 755f 6361 6368 650a 6465 6620 6772 6174  u_cache.def grat
+000239d0: 696e 6728 0a20 2020 206e 756d 5f70 6572  ing(.    num_per
+000239e0: 696f 6473 3d32 302c 0a20 2020 2070 6572  iods=20,.    per
+000239f0: 696f 643d 302e 3735 2c0a 2020 2020 6669  iod=0.75,.    fi
+00023a00: 6c6c 5f66 6163 746f 723d 302e 352c 0a20  ll_factor=0.5,. 
+00023a10: 2020 2077 6964 7468 5f67 7261 7469 6e67     width_grating
+00023a20: 3d35 2c0a 2020 2020 6c65 6e67 7468 5f74  =5,.    length_t
+00023a30: 6170 6572 3d31 302c 0a20 2020 2077 6964  aper=10,.    wid
+00023a40: 7468 3d30 2e34 2c0a 2020 2020 7061 7274  th=0.4,.    part
+00023a50: 6961 6c5f 6574 6368 3d46 616c 7365 2c0a  ial_etch=False,.
+00023a60: 293a 0a20 2020 2022 2222 5369 6d70 6c65  ):.    """Simple
+00023a70: 2067 7261 7469 6e67 2073 7472 7563 7475   grating structu
+00023a80: 7265 2066 6f72 2070 686f 746f 6e69 6373  re for photonics
+00023a90: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00023aa0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+00023ab0: 2020 2020 6e75 6d5f 7065 7269 6f64 7320      num_periods 
+00023ac0: 3a20 696e 740a 2020 2020 2020 2020 4e75  : int.        Nu
+00023ad0: 6d62 6572 206f 6620 6772 6174 696e 6773  mber of gratings
+00023ae0: 2e0a 2020 2020 7065 7269 6f64 203a 2069  ..    period : i
+00023af0: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
+00023b00: 2020 2020 4469 7374 616e 6365 2062 6574      Distance bet
+00023b10: 7765 656e 2067 7261 7469 6e67 732e 0a20  ween gratings.. 
+00023b20: 2020 2066 696c 6c5f 6661 6374 6f72 203a     fill_factor :
+00023b30: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
+00023b40: 2020 2020 2020 5468 6963 6b6e 6573 7320        Thickness 
+00023b50: 6f66 2074 6865 2067 7261 7469 6e67 732e  of the gratings.
+00023b60: 0a20 2020 2077 6964 7468 5f67 7261 7469  .    width_grati
+00023b70: 6e67 203a 2069 6e74 206f 7220 666c 6f61  ng : int or floa
+00023b80: 740a 2020 2020 2020 2020 5769 6474 6820  t.        Width 
+00023b90: 6f66 2074 6865 2067 7261 7469 6e67 732e  of the gratings.
+00023ba0: 0a20 2020 206c 656e 6774 685f 7461 7065  .    length_tape
+00023bb0: 7220 3a20 696e 7420 6f72 2066 6c6f 6174  r : int or float
+00023bc0: 0a20 2020 2020 2020 204c 656e 6774 6820  .        Length 
+00023bd0: 6f66 2074 6865 2074 6170 6572 2073 6563  of the taper sec
+00023be0: 7469 6f6e 2e0a 2020 2020 7769 6474 6820  tion..    width 
+00023bf0: 3a20 696e 7420 6f72 2066 6c6f 6174 0a20  : int or float. 
+00023c00: 2020 2020 2020 2057 6964 7468 206f 6620         Width of 
+00023c10: 7468 6520 656e 6420 6f66 2074 6865 2074  the end of the t
+00023c20: 6170 6572 2073 6563 7469 6f6e 2e0a 2020  aper section..  
+00023c30: 2020 7061 7274 6961 6c5f 6574 6368 203a    partial_etch :
+00023c40: 2062 6f6f 6c0a 2020 2020 2020 2020 4966   bool.        If
+00023c50: 2054 7275 652c 206d 616b 6573 2061 6e20   True, makes an 
+00023c60: 756e 7461 7065 7265 642c 2070 6172 7469  untapered, parti
+00023c70: 616c 6c79 2d65 7463 6865 6420 6772 6174  ally-etched grat
+00023c80: 696e 672e 0a0a 2020 2020 5265 7475 726e  ing...    Return
+00023c90: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
+00023ca0: 2020 4720 3a20 4465 7669 6365 0a20 2020    G : Device.   
+00023cb0: 2020 2020 2041 2044 6576 6963 6520 636f       A Device co
+00023cc0: 6e74 6169 6e69 6e67 2061 2066 6962 6572  ntaining a fiber
+00023cd0: 2067 7261 7469 6e67 2067 656f 6d65 7472   grating geometr
+00023ce0: 792e 0a20 2020 2022 2222 0a20 2020 2023  y..    """.    #
+00023cf0: 2072 6574 7572 6e73 2061 2066 6962 6572   returns a fiber
+00023d00: 2067 7261 7469 6e67 0a20 2020 2047 203d   grating.    G =
+00023d10: 2044 6576 6963 6528 2267 7261 7469 6e67   Device("grating
+00023d20: 2229 0a0a 2020 2020 2320 6d61 6b65 2074  ")..    # make t
+00023d30: 6865 2064 6565 7020 6574 6368 6564 2067  he deep etched g
+00023d40: 7261 7469 6e67 0a20 2020 2069 6620 7061  rating.    if pa
+00023d50: 7274 6961 6c5f 6574 6368 2069 7320 4661  rtial_etch is Fa
+00023d60: 6c73 653a 0a20 2020 2020 2020 2023 206d  lse:.        # m
+00023d70: 616b 6520 7468 6520 6772 6174 696e 6720  ake the grating 
+00023d80: 7465 6574 680a 2020 2020 2020 2020 666f  teeth.        fo
+00023d90: 7220 6920 696e 2072 616e 6765 286e 756d  r i in range(num
+00023da0: 5f70 6572 696f 6473 293a 0a20 2020 2020  _periods):.     
+00023db0: 2020 2020 2020 2063 6772 6174 696e 6720         cgrating 
+00023dc0: 3d20 472e 6164 645f 7265 6628 0a20 2020  = G.add_ref(.   
+00023dd0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+00023de0: 7061 7373 2873 697a 653d 5b70 6572 696f  pass(size=[perio
+00023df0: 6420 2a20 6669 6c6c 5f66 6163 746f 722c  d * fill_factor,
+00023e00: 2077 6964 7468 5f67 7261 7469 6e67 5d2c   width_grating],
+00023e10: 206c 6179 6572 3d30 290a 2020 2020 2020   layer=0).      
+00023e20: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00023e30: 2020 2020 6367 7261 7469 6e67 2e78 202b      cgrating.x +
+00023e40: 3d20 6920 2a20 7065 7269 6f64 0a0a 2020  = i * period..  
+00023e50: 2020 2020 2020 2320 6d61 6b65 2074 6865        # make the
+00023e60: 2074 6170 6572 0a20 2020 2020 2020 2074   taper.        t
+00023e70: 6772 6174 696e 6720 3d20 472e 6164 645f  grating = G.add_
+00023e80: 7265 6628 0a20 2020 2020 2020 2020 2020  ref(.           
+00023e90: 2074 6170 6572 280a 2020 2020 2020 2020   taper(.        
+00023ea0: 2020 2020 2020 2020 6c65 6e67 7468 3d6c          length=l
+00023eb0: 656e 6774 685f 7461 7065 722c 0a20 2020  ength_taper,.   
+00023ec0: 2020 2020 2020 2020 2020 2020 2077 6964               wid
+00023ed0: 7468 313d 7769 6474 685f 6772 6174 696e  th1=width_gratin
+00023ee0: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
+00023ef0: 2020 2077 6964 7468 323d 7769 6474 682c     width2=width,
+00023f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023f10: 2070 6f72 743d 4e6f 6e65 2c0a 2020 2020   port=None,.    
+00023f20: 2020 2020 2020 2020 2020 2020 6c61 7965              laye
+00023f30: 723d 302c 0a20 2020 2020 2020 2020 2020  r=0,.           
+00023f40: 2029 0a20 2020 2020 2020 2029 0a20 2020   ).        ).   
+00023f50: 2020 2020 2074 6772 6174 696e 672e 786d       tgrating.xm
+00023f60: 696e 203d 2063 6772 6174 696e 672e 786d  in = cgrating.xm
+00023f70: 6178 0a20 2020 2020 2020 2023 2064 6566  ax.        # def
+00023f80: 696e 6520 7468 6520 706f 7274 206f 6620  ine the port of 
+00023f90: 7468 6520 6772 6174 696e 670a 2020 2020  the grating.    
+00023fa0: 2020 2020 7020 3d20 472e 6164 645f 706f      p = G.add_po
+00023fb0: 7274 2870 6f72 743d 7467 7261 7469 6e67  rt(port=tgrating
+00023fc0: 2e70 6f72 7473 5b32 5d2c 206e 616d 653d  .ports[2], name=
+00023fd0: 3129 0a20 2020 2023 206d 616b 6520 6120  1).    # make a 
+00023fe0: 7061 7274 6961 6c6c 7920 6574 6368 6564  partially etched
+00023ff0: 2067 7261 7469 6e67 0a20 2020 2069 6620   grating.    if 
+00024000: 7061 7274 6961 6c5f 6574 6368 2069 7320  partial_etch is 
+00024010: 5472 7565 3a0a 2020 2020 2020 2020 2320  True:.        # 
+00024020: 6861 7264 2063 6f64 6564 206f 7665 726c  hard coded overl
+00024030: 6170 0a20 2020 2020 2020 2070 6172 7465  ap.        parte
+00024040: 7463 685f 6f76 6572 6861 6e67 203d 2035  tch_overhang = 5
+00024050: 0a20 2020 2020 2020 2023 206d 616b 6520  .        # make 
+00024060: 7468 6520 6574 6368 6564 2061 7265 6173  the etched areas
+00024070: 2028 6f70 706f 7369 7465 2074 6f20 7465   (opposite to te
+00024080: 6574 6829 0a20 2020 2020 2020 2066 6f72  eth).        for
+00024090: 2069 2069 6e20 7261 6e67 6528 6e75 6d5f   i in range(num_
+000240a0: 7065 7269 6f64 7329 3a0a 2020 2020 2020  periods):.      
+000240b0: 2020 2020 2020 6367 7261 7469 6e67 203d        cgrating =
+000240c0: 2047 2e61 6464 5f72 6566 280a 2020 2020   G.add_ref(.    
+000240d0: 2020 2020 2020 2020 2020 2020 636f 6d70              comp
+000240e0: 6173 7328 0a20 2020 2020 2020 2020 2020  ass(.           
+000240f0: 2020 2020 2020 2020 2073 697a 653d 5b0a           size=[.
+00024100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024110: 2020 2020 2020 2020 7065 7269 6f64 202a          period *
+00024120: 2028 3120 2d20 6669 6c6c 5f66 6163 746f   (1 - fill_facto
+00024130: 7229 2c0a 2020 2020 2020 2020 2020 2020  r),.            
+00024140: 2020 2020 2020 2020 2020 2020 7769 6474              widt
+00024150: 685f 6772 6174 696e 6720 2b20 7061 7274  h_grating + part
+00024160: 6574 6368 5f6f 7665 7268 616e 6720 2a20  etch_overhang * 
+00024170: 322c 0a20 2020 2020 2020 2020 2020 2020  2,.             
+00024180: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00024190: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+000241a0: 7965 723d 312c 0a20 2020 2020 2020 2020  yer=1,.         
+000241b0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000241c0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000241d0: 2020 2063 6772 6174 696e 672e 7820 2b3d     cgrating.x +=
+000241e0: 2069 202a 2070 6572 696f 640a 2020 2020   i * period.    
+000241f0: 2020 2020 2320 6465 6669 6e65 2074 6865      # define the
+00024200: 2070 6f72 7420 6f66 2074 6865 2067 7261   port of the gra
+00024210: 7469 6e67 0a20 2020 2020 2020 2070 203d  ting.        p =
+00024220: 2047 2e61 6464 5f70 6f72 7428 706f 7274   G.add_port(port
+00024230: 3d63 6772 6174 696e 672e 706f 7274 735b  =cgrating.ports[
+00024240: 2245 225d 2c20 6e61 6d65 3d31 290a 2020  "E"], name=1).  
+00024250: 2020 2020 2020 702e 6d69 6470 6f69 6e74        p.midpoint
+00024260: 203d 2070 2e6d 6964 706f 696e 7420 2b20   = p.midpoint + 
+00024270: 6e70 2e61 7272 6179 285b 2831 202d 2066  np.array([(1 - f
+00024280: 696c 6c5f 6661 6374 6f72 2920 2a20 7065  ill_factor) * pe
+00024290: 7269 6f64 2c20 305d 290a 0a20 2020 2020  riod, 0])..     
+000242a0: 2020 2023 2064 7261 7720 7468 6520 6465     # draw the de
+000242b0: 6570 2065 7463 6865 6420 7371 7561 7265  ep etched square
+000242c0: 2061 726f 756e 6420 7468 6520 6772 6174   around the grat
+000242d0: 696e 670a 2020 2020 2020 2020 472e 6164  ing.        G.ad
+000242e0: 645f 7265 6628 2020 2320 6465 6570 626f  d_ref(  # deepbo
+000242f0: 780a 2020 2020 2020 2020 2020 2020 636f  x.            co
+00024300: 6d70 6173 7328 7369 7a65 3d5b 6e75 6d5f  mpass(size=[num_
+00024310: 7065 7269 6f64 7320 2a20 7065 7269 6f64  periods * period
+00024320: 2c20 7769 6474 685f 6772 6174 696e 675d  , width_grating]
+00024330: 2c20 6c61 7965 723d 3029 0a20 2020 2020  , layer=0).     
+00024340: 2020 2029 0a20 2020 2072 6574 7572 6e20     ).    return 
+00024350: 470a 0a0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d  G...# ==========
+00024360: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00024370: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00024380: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00024390: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000243a0: 3d3d 3d3d 0a23 2045 7861 6d70 6c65 2063  ====.# Example c
+000243b0: 6f64 650a 2320 3d3d 3d3d 3d3d 3d3d 3d3d  ode.# ==========
+000243c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000243d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000243e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000243f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00024400: 3d3d 3d3d 0a0a 2320 4720 3d20 6772 6174  ====..# G = grat
+00024410: 696e 6728 6e75 6d5f 7065 7269 6f64 7320  ing(num_periods 
+00024420: 3d20 3230 2c20 7065 7269 6f64 203d 2030  = 20, period = 0
+00024430: 2e37 352c 2066 696c 6c5f 6661 6374 6f72  .75, fill_factor
+00024440: 203d 2030 2e35 2c0a 2320 2020 2020 2020   = 0.5,.#       
+00024450: 2020 2020 2020 7769 6474 685f 6772 6174        width_grat
+00024460: 696e 6720 3d20 3230 2c20 6c65 6e67 7468  ing = 20, length
+00024470: 5f74 6170 6572 203d 2031 302c 2077 6964  _taper = 10, wid
+00024480: 7468 203d 2030 2e34 2c0a 2320 2020 2020  th = 0.4,.#     
+00024490: 2020 2020 2020 2020 7061 7274 6961 6c5f          partial_
+000244a0: 6574 6368 203d 2046 616c 7365 290a 2320  etch = False).# 
+000244b0: 7175 6963 6b70 6c6f 7428 4729 0a0a 0a23  quickplot(G)...#
+000244c0: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
+000244d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000244e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000244f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00024500: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
+00024510: 230a 2320 5465 7374 2053 7472 7563 7475  #.# Test Structu
+00024520: 7265 730a 230a 2320 3d3d 3d3d 3d3d 3d3d  res.#.# ========
+00024530: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00024540: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00024550: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00024560: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00024570: 3d3d 3d3d 3d3d 0a0a 0a23 2056 6961 2052  ======...# Via R
+00024580: 6f75 7465 202d 2d2d 2d2d 2d2d 2d2d 2d2d  oute -----------
+00024590: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000245a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 6465  -------------.de
+000245b0: 6620 5f76 6961 5f69 7465 7261 626c 6528  f _via_iterable(
+000245c0: 0a20 2020 2076 6961 5f73 7061 6369 6e67  .    via_spacing
+000245d0: 2c20 7769 7265 5f77 6964 7468 2c20 7769  , wire_width, wi
+000245e0: 7269 6e67 315f 6c61 7965 722c 2077 6972  ring1_layer, wir
+000245f0: 696e 6732 5f6c 6179 6572 2c20 7669 615f  ing2_layer, via_
+00024600: 6c61 7965 722c 2076 6961 5f77 6964 7468  layer, via_width
+00024610: 0a29 3a0a 2020 2020 2222 2248 656c 7065  .):.    """Helpe
+00024620: 7220 6675 6e63 7469 6f6e 2066 6f72 2074  r function for t
+00024630: 6573 745f 7669 610a 0a20 2020 2050 6172  est_via..    Par
+00024640: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+00024650: 2d2d 2d2d 2d2d 0a20 2020 2076 6961 5f73  ------.    via_s
+00024660: 7061 6369 6e67 203a 2069 6e74 206f 7220  pacing : int or 
+00024670: 666c 6f61 740a 2020 2020 2020 2020 4469  float.        Di
+00024680: 7374 616e 6365 2062 6574 7765 656e 2076  stance between v
+00024690: 6961 732e 0a20 2020 2077 6972 655f 7769  ias..    wire_wi
+000246a0: 6474 6820 3a20 696e 7420 6f72 2066 6c6f  dth : int or flo
+000246b0: 6174 0a20 2020 2020 2020 2054 6865 2077  at.        The w
+000246c0: 6964 7468 206f 6620 7468 6520 7769 7265  idth of the wire
+000246d0: 732e 0a20 2020 2077 6972 696e 6731 5f6c  s..    wiring1_l
+000246e0: 6179 6572 203a 2069 6e74 0a20 2020 2020  ayer : int.     
+000246f0: 2020 2053 7065 6369 6669 6320 6c61 7965     Specific laye
+00024700: 7220 746f 2070 7574 2074 6865 2074 6f70  r to put the top
+00024710: 2077 6972 696e 6720 6f6e 2e0a 2020 2020   wiring on..    
+00024720: 7769 7269 6e67 325f 6c61 7965 7220 3a20  wiring2_layer : 
+00024730: 696e 740a 2020 2020 2020 2020 5370 6563  int.        Spec
+00024740: 6966 6963 206c 6179 6572 2074 6f20 7075  ific layer to pu
+00024750: 7420 7468 6520 626f 7474 6f6d 2077 6972  t the bottom wir
+00024760: 696e 6720 6f6e 2e0a 2020 2020 7669 615f  ing on..    via_
+00024770: 6c61 7965 7220 3a20 696e 740a 2020 2020  layer : int.    
+00024780: 2020 2020 5370 6563 6966 6963 206c 6179      Specific lay
+00024790: 6572 2074 6f20 7075 7420 7468 6520 7669  er to put the vi
+000247a0: 6173 206f 6e2e 0a20 2020 2076 6961 5f77  as on..    via_w
+000247b0: 6964 7468 203a 2069 6e74 206f 7220 666c  idth : int or fl
+000247c0: 6f61 740a 2020 2020 2020 2020 4469 616d  oat.        Diam
+000247d0: 6574 6572 206f 6620 7468 6520 7669 6173  eter of the vias
+000247e0: 2e0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
+000247f0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2056     -------.    V
+00024800: 4920 3a20 4465 7669 6365 0a0a 2020 2020  I : Device..    
+00024810: 2222 220a 2020 2020 5649 203d 2044 6576  """.    VI = Dev
+00024820: 6963 6528 2274 6573 745f 7669 615f 6974  ice("test_via_it
+00024830: 6572 2229 0a20 2020 2077 6972 6531 203d  er").    wire1 =
+00024840: 2056 492e 6164 645f 7265 6628 636f 6d70   VI.add_ref(comp
+00024850: 6173 7328 7369 7a65 3d28 7669 615f 7370  ass(size=(via_sp
+00024860: 6163 696e 672c 2077 6972 655f 7769 6474  acing, wire_widt
+00024870: 6829 2c20 6c61 7965 723d 7769 7269 6e67  h), layer=wiring
+00024880: 315f 6c61 7965 7229 290a 2020 2020 7769  1_layer)).    wi
+00024890: 7265 3220 3d20 5649 2e61 6464 5f72 6566  re2 = VI.add_ref
+000248a0: 2863 6f6d 7061 7373 2873 697a 653d 2876  (compass(size=(v
+000248b0: 6961 5f73 7061 6369 6e67 2c20 7769 7265  ia_spacing, wire
+000248c0: 5f77 6964 7468 292c 206c 6179 6572 3d77  _width), layer=w
+000248d0: 6972 696e 6732 5f6c 6179 6572 2929 0a20  iring2_layer)). 
+000248e0: 2020 2076 6961 3120 3d20 5649 2e61 6464     via1 = VI.add
+000248f0: 5f72 6566 2863 6f6d 7061 7373 2873 697a  _ref(compass(siz
+00024900: 653d 2876 6961 5f77 6964 7468 2c20 7669  e=(via_width, vi
+00024910: 615f 7769 6474 6829 2c20 6c61 7965 723d  a_width), layer=
+00024920: 7669 615f 6c61 7965 7229 290a 2020 2020  via_layer)).    
+00024930: 7669 6132 203d 2056 492e 6164 645f 7265  via2 = VI.add_re
+00024940: 6628 636f 6d70 6173 7328 7369 7a65 3d28  f(compass(size=(
+00024950: 7669 615f 7769 6474 682c 2076 6961 5f77  via_width, via_w
+00024960: 6964 7468 292c 206c 6179 6572 3d76 6961  idth), layer=via
+00024970: 5f6c 6179 6572 2929 0a20 2020 2077 6972  _layer)).    wir
+00024980: 6531 2e63 6f6e 6e65 6374 2870 6f72 743d  e1.connect(port=
+00024990: 2245 222c 2064 6573 7469 6e61 7469 6f6e  "E", destination
+000249a0: 3d77 6972 6532 2e70 6f72 7473 5b22 5722  =wire2.ports["W"
+000249b0: 5d2c 206f 7665 726c 6170 3d77 6972 655f  ], overlap=wire_
+000249c0: 7769 6474 6829 0a20 2020 2076 6961 312e  width).    via1.
+000249d0: 636f 6e6e 6563 7428 0a20 2020 2020 2020  connect(.       
+000249e0: 2070 6f72 743d 2257 222c 2064 6573 7469   port="W", desti
+000249f0: 6e61 7469 6f6e 3d77 6972 6531 2e70 6f72  nation=wire1.por
+00024a00: 7473 5b22 4522 5d2c 206f 7665 726c 6170  ts["E"], overlap
+00024a10: 3d28 7769 7265 5f77 6964 7468 202b 2076  =(wire_width + v
+00024a20: 6961 5f77 6964 7468 2920 2f20 320a 2020  ia_width) / 2.  
+00024a30: 2020 290a 2020 2020 7669 6132 2e63 6f6e    ).    via2.con
+00024a40: 6e65 6374 280a 2020 2020 2020 2020 706f  nect(.        po
+00024a50: 7274 3d22 5722 2c20 6465 7374 696e 6174  rt="W", destinat
+00024a60: 696f 6e3d 7769 7265 322e 706f 7274 735b  ion=wire2.ports[
+00024a70: 2245 225d 2c20 6f76 6572 6c61 703d 2877  "E"], overlap=(w
+00024a80: 6972 655f 7769 6474 6820 2b20 7669 615f  ire_width + via_
+00024a90: 7769 6474 6829 202f 2032 0a20 2020 2029  width) / 2.    )
+00024aa0: 0a20 2020 2056 492e 6164 645f 706f 7274  .    VI.add_port
+00024ab0: 286e 616d 653d 2257 222c 2070 6f72 743d  (name="W", port=
+00024ac0: 7769 7265 312e 706f 7274 735b 2257 225d  wire1.ports["W"]
+00024ad0: 290a 2020 2020 5649 2e61 6464 5f70 6f72  ).    VI.add_por
+00024ae0: 7428 6e61 6d65 3d22 4522 2c20 706f 7274  t(name="E", port
+00024af0: 3d77 6972 6532 2e70 6f72 7473 5b22 4522  =wire2.ports["E"
+00024b00: 5d29 0a20 2020 2056 492e 6164 645f 706f  ]).    VI.add_po
+00024b10: 7274 280a 2020 2020 2020 2020 6e61 6d65  rt(.        name
+00024b20: 3d22 5322 2c0a 2020 2020 2020 2020 6d69  ="S",.        mi
+00024b30: 6470 6f69 6e74 3d5b 2831 202a 2077 6972  dpoint=[(1 * wir
+00024b40: 655f 7769 6474 6829 202b 2077 6972 655f  e_width) + wire_
+00024b50: 7769 6474 6820 2f20 322c 202d 7769 7265  width / 2, -wire
+00024b60: 5f77 6964 7468 202f 2032 5d2c 0a20 2020  _width / 2],.   
+00024b70: 2020 2020 2077 6964 7468 3d77 6972 655f       width=wire_
+00024b80: 7769 6474 682c 0a20 2020 2020 2020 206f  width,.        o
+00024b90: 7269 656e 7461 7469 6f6e 3d2d 3930 2c0a  rientation=-90,.
+00024ba0: 2020 2020 290a 2020 2020 5649 2e61 6464      ).    VI.add
+00024bb0: 5f70 6f72 7428 0a20 2020 2020 2020 206e  _port(.        n
+00024bc0: 616d 653d 224e 222c 0a20 2020 2020 2020  ame="N",.       
+00024bd0: 206d 6964 706f 696e 743d 5b28 3120 2a20   midpoint=[(1 * 
+00024be0: 7769 7265 5f77 6964 7468 2920 2b20 7769  wire_width) + wi
+00024bf0: 7265 5f77 6964 7468 202f 2032 2c20 7769  re_width / 2, wi
+00024c00: 7265 5f77 6964 7468 202f 2032 5d2c 0a20  re_width / 2],. 
+00024c10: 2020 2020 2020 2077 6964 7468 3d77 6972         width=wir
+00024c20: 655f 7769 6474 682c 0a20 2020 2020 2020  e_width,.       
+00024c30: 206f 7269 656e 7461 7469 6f6e 3d39 302c   orientation=90,
+00024c40: 0a20 2020 2029 0a0a 2020 2020 7265 7475  .    )..    retu
+00024c50: 726e 2056 490a 0a0a 6465 6620 7465 7374  rn VI...def test
+00024c60: 5f76 6961 280a 2020 2020 6e75 6d5f 7669  _via(.    num_vi
+00024c70: 6173 3d31 3030 2c0a 2020 2020 7769 7265  as=100,.    wire
+00024c80: 5f77 6964 7468 3d31 302c 0a20 2020 2076  _width=10,.    v
+00024c90: 6961 5f77 6964 7468 3d31 352c 0a20 2020  ia_width=15,.   
+00024ca0: 2076 6961 5f73 7061 6369 6e67 3d34 302c   via_spacing=40,
+00024cb0: 0a20 2020 2070 6164 5f73 697a 653d 2833  .    pad_size=(3
+00024cc0: 3030 2c20 3330 3029 2c0a 2020 2020 6d69  00, 300),.    mi
+00024cd0: 6e5f 7061 645f 7370 6163 696e 673d 302c  n_pad_spacing=0,
+00024ce0: 0a20 2020 2070 6164 5f6c 6179 6572 3d30  .    pad_layer=0
+00024cf0: 2c0a 2020 2020 7769 7269 6e67 315f 6c61  ,.    wiring1_la
+00024d00: 7965 723d 312c 0a20 2020 2077 6972 696e  yer=1,.    wirin
+00024d10: 6732 5f6c 6179 6572 3d32 2c0a 2020 2020  g2_layer=2,.    
+00024d20: 7669 615f 6c61 7965 723d 332c 0a29 3a0a  via_layer=3,.):.
+00024d30: 2020 2020 2222 2256 6961 2063 6861 696e      """Via chain
+00024d40: 2074 6573 7420 7374 7275 6374 7572 650a   test structure.
+00024d50: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00024d60: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00024d70: 2020 206e 756d 5f76 6961 7320 3a20 696e     num_vias : in
+00024d80: 740a 2020 2020 2020 2020 5468 6520 746f  t.        The to
+00024d90: 7461 6c20 6e75 6d62 6572 206f 6620 7265  tal number of re
+00024da0: 7175 6573 7465 6420 7669 6173 2028 6d75  quested vias (mu
+00024db0: 7374 2062 6520 616e 2065 7665 6e20 6e75  st be an even nu
+00024dc0: 6d62 6572 292e 0a20 2020 2077 6972 655f  mber)..    wire_
+00024dd0: 7769 6474 6820 3a20 696e 7420 6f72 2066  width : int or f
+00024de0: 6c6f 6174 0a20 2020 2020 2020 2054 6865  loat.        The
+00024df0: 2077 6964 7468 206f 6620 7468 6520 7769   width of the wi
+00024e00: 7265 732e 0a20 2020 2076 6961 5f77 6964  res..    via_wid
+00024e10: 7468 203a 2069 6e74 206f 7220 666c 6f61  th : int or floa
+00024e20: 740a 2020 2020 2020 2020 4469 616d 6574  t.        Diamet
+00024e30: 6572 206f 6620 7468 6520 7669 6173 2e0a  er of the vias..
+00024e40: 2020 2020 7669 615f 7370 6163 696e 6720      via_spacing 
+00024e50: 3a20 696e 7420 6f72 2066 6c6f 6174 0a20  : int or float. 
+00024e60: 2020 2020 2020 2044 6973 7461 6e63 6520         Distance 
+00024e70: 6265 7477 6565 6e20 7669 6173 2e0a 2020  between vias..  
+00024e80: 2020 7061 645f 7369 7a65 203a 2061 7272    pad_size : arr
+00024e90: 6179 2d6c 696b 655b 325d 0a20 2020 2020  ay-like[2].     
+00024ea0: 2020 2028 7769 6474 682c 2068 6569 6768     (width, heigh
+00024eb0: 7429 206f 6620 7468 6520 7061 6473 2e0a  t) of the pads..
+00024ec0: 2020 2020 6d69 6e5f 7061 645f 7370 6163      min_pad_spac
+00024ed0: 696e 6720 3a20 696e 7420 6f72 2066 6c6f  ing : int or flo
+00024ee0: 6174 0a20 2020 2020 2020 2044 6566 696e  at.        Defin
+00024ef0: 6573 2074 6865 206d 696e 696d 756d 2064  es the minimum d
+00024f00: 6973 7461 6e63 6520 6265 7477 6565 6e20  istance between 
+00024f10: 7468 6520 7477 6f20 7061 6473 2e0a 2020  the two pads..  
+00024f20: 2020 7061 645f 6c61 7965 7220 3a20 696e    pad_layer : in
+00024f30: 740a 2020 2020 2020 2020 5370 6563 6966  t.        Specif
+00024f40: 6963 206c 6179 6572 2074 6f20 7075 7420  ic layer to put 
+00024f50: 7468 6520 7061 6473 206f 6e2e 0a20 2020  the pads on..   
+00024f60: 2077 6972 696e 6731 5f6c 6179 6572 203a   wiring1_layer :
+00024f70: 2069 6e74 0a20 2020 2020 2020 2053 7065   int.        Spe
+00024f80: 6369 6669 6320 6c61 7965 7220 746f 2070  cific layer to p
+00024f90: 7574 2074 6865 2074 6f70 2077 6972 696e  ut the top wirin
+00024fa0: 6720 6f6e 2e0a 2020 2020 7769 7269 6e67  g on..    wiring
+00024fb0: 325f 6c61 7965 7220 3a20 696e 740a 2020  2_layer : int.  
+00024fc0: 2020 2020 2020 5370 6563 6966 6963 206c        Specific l
+00024fd0: 6179 6572 2074 6f20 7075 7420 7468 6520  ayer to put the 
+00024fe0: 626f 7474 6f6d 2077 6972 696e 6720 6f6e  bottom wiring on
+00024ff0: 2e0a 2020 2020 7669 615f 6c61 7965 7220  ..    via_layer 
+00025000: 3a20 696e 740a 2020 2020 2020 2020 5370  : int.        Sp
+00025010: 6563 6966 6963 206c 6179 6572 2074 6f20  ecific layer to 
+00025020: 7075 7420 7468 6520 7669 6173 206f 6e2e  put the vias on.
+00025030: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+00025040: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 5652    -------.    VR
+00025050: 203a 2044 6576 6963 650a 2020 2020 2020   : Device.      
+00025060: 2020 4120 4465 7669 6365 2063 6f6e 7461    A Device conta
+00025070: 696e 696e 6720 7468 6520 7465 7374 2076  ining the test v
+00025080: 6961 2073 7472 7563 7475 7265 732e 0a0a  ia structures...
+00025090: 2020 2020 5573 6167 650a 2020 2020 2d2d      Usage.    --
+000250a0: 2d2d 2d0a 2020 2020 4361 6c6c 2076 6961  ---.    Call via
+000250b0: 5f72 6f75 7465 5f74 6573 745f 7374 7275  _route_test_stru
+000250c0: 6374 7572 6528 2920 6279 2069 6e64 6963  cture() by indic
+000250d0: 6174 696e 6720 7468 6520 6e75 6d62 6572  ating the number
+000250e0: 206f 6620 7669 6173 2079 6f75 2077 616e   of vias you wan
+000250f0: 740a 2020 2020 6472 6177 6e2e 2059 6f75  t.    drawn. You
+00025100: 2063 616e 2061 6c73 6f20 6368 616e 6765   can also change
+00025110: 2074 6865 206f 7468 6572 2070 6172 616d   the other param
+00025120: 6574 6572 7320 686f 7765 7665 7220 6966  eters however if
+00025130: 2079 6f75 2064 6f20 6e6f 740a 2020 2020   you do not.    
+00025140: 7370 6563 6966 6979 2061 2076 616c 7565  specifiy a value
+00025150: 2066 6f72 2061 2070 6172 616d 6574 6572   for a parameter
+00025160: 2069 7420 7769 6c6c 206a 7573 7420 7573   it will just us
+00025170: 6520 7468 6520 6465 6661 756c 7420 7661  e the default va
+00025180: 6c75 650a 2020 2020 4578 3a3a 0a0a 2020  lue.    Ex::..  
+00025190: 2020 2020 2020 7669 615f 726f 7574 655f        via_route_
+000251a0: 7465 7374 5f73 7472 7563 7475 7265 286e  test_structure(n
+000251b0: 756d 5f76 6961 733d 3534 290a 0a20 2020  um_vias=54)..   
+000251c0: 202d 206f 7220 2d3a 3a0a 0a20 2020 2020   - or -::..     
+000251d0: 2020 2076 6961 5f72 6f75 7465 5f74 6573     via_route_tes
+000251e0: 745f 7374 7275 6374 7572 6528 6e75 6d5f  t_structure(num_
+000251f0: 7669 6173 3d31 322c 2070 6164 5f73 697a  vias=12, pad_siz
+00025200: 653d 2831 3030 2c31 3030 292c 7769 7265  e=(100,100),wire
+00025210: 5f77 6964 7468 3d38 290a 0a20 2020 2065  _width=8)..    e
+00025220: 783a 2076 6961 5f72 6f75 7465 2835 342c  x: via_route(54,
+00025230: 206d 696e 5f70 6164 5f73 7061 6369 6e67   min_pad_spacing
+00025240: 3d33 3030 290a 2020 2020 2222 220a 2020  =300).    """.  
+00025250: 2020 5652 203d 2044 6576 6963 6528 2274    VR = Device("t
+00025260: 6573 745f 7669 6122 290a 2020 2020 7061  est_via").    pa
+00025270: 6431 203d 2056 522e 6164 645f 7265 6628  d1 = VR.add_ref(
+00025280: 7265 6374 616e 676c 6528 7369 7a65 3d70  rectangle(size=p
+00025290: 6164 5f73 697a 652c 206c 6179 6572 3d70  ad_size, layer=p
+000252a0: 6164 5f6c 6179 6572 2929 0a20 2020 2070  ad_layer)).    p
+000252b0: 6164 315f 6f76 6572 6c61 7920 3d20 5652  ad1_overlay = VR
+000252c0: 2e61 6464 5f72 6566 2872 6563 7461 6e67  .add_ref(rectang
+000252d0: 6c65 2873 697a 653d 7061 645f 7369 7a65  le(size=pad_size
+000252e0: 2c20 6c61 7965 723d 7769 7269 6e67 315f  , layer=wiring1_
+000252f0: 6c61 7965 7229 290a 2020 2020 7061 6432  layer)).    pad2
+00025300: 203d 2056 522e 6164 645f 7265 6628 7265   = VR.add_ref(re
+00025310: 6374 616e 676c 6528 7369 7a65 3d70 6164  ctangle(size=pad
+00025320: 5f73 697a 652c 206c 6179 6572 3d70 6164  _size, layer=pad
+00025330: 5f6c 6179 6572 2929 0a20 2020 2070 6164  _layer)).    pad
+00025340: 325f 6f76 6572 6c61 7920 3d20 5652 2e61  2_overlay = VR.a
+00025350: 6464 5f72 6566 2872 6563 7461 6e67 6c65  dd_ref(rectangle
+00025360: 2873 697a 653d 7061 645f 7369 7a65 2c20  (size=pad_size, 
+00025370: 6c61 7965 723d 7769 7269 6e67 315f 6c61  layer=wiring1_la
+00025380: 7965 7229 290a 2020 2020 6e75 6220 3d20  yer)).    nub = 
+00025390: 5652 2e61 6464 5f72 6566 2863 6f6d 7061  VR.add_ref(compa
+000253a0: 7373 2873 697a 653d 2833 202a 2077 6972  ss(size=(3 * wir
+000253b0: 655f 7769 6474 682c 2077 6972 655f 7769  e_width, wire_wi
+000253c0: 6474 6829 2c20 6c61 7965 723d 7061 645f  dth), layer=pad_
+000253d0: 6c61 7965 7229 290a 2020 2020 6e75 625f  layer)).    nub_
+000253e0: 6f76 6572 6c61 7920 3d20 5652 2e61 6464  overlay = VR.add
+000253f0: 5f72 6566 280a 2020 2020 2020 2020 636f  _ref(.        co
+00025400: 6d70 6173 7328 7369 7a65 3d28 3320 2a20  mpass(size=(3 * 
+00025410: 7769 7265 5f77 6964 7468 2c20 7769 7265  wire_width, wire
+00025420: 5f77 6964 7468 292c 206c 6179 6572 3d77  _width), layer=w
+00025430: 6972 696e 6731 5f6c 6179 6572 290a 2020  iring1_layer).  
+00025440: 2020 290a 2020 2020 6865 6164 203d 2056    ).    head = V
+00025450: 522e 6164 645f 7265 6628 636f 6d70 6173  R.add_ref(compas
+00025460: 7328 7369 7a65 3d28 7769 7265 5f77 6964  s(size=(wire_wid
+00025470: 7468 2c20 7769 7265 5f77 6964 7468 292c  th, wire_width),
+00025480: 206c 6179 6572 3d70 6164 5f6c 6179 6572   layer=pad_layer
+00025490: 2929 0a20 2020 2068 6561 645f 6f76 6572  )).    head_over
+000254a0: 6c61 7920 3d20 5652 2e61 6464 5f72 6566  lay = VR.add_ref
+000254b0: 280a 2020 2020 2020 2020 636f 6d70 6173  (.        compas
+000254c0: 7328 7369 7a65 3d28 7769 7265 5f77 6964  s(size=(wire_wid
+000254d0: 7468 2c20 7769 7265 5f77 6964 7468 292c  th, wire_width),
+000254e0: 206c 6179 6572 3d77 6972 696e 6731 5f6c   layer=wiring1_l
+000254f0: 6179 6572 290a 2020 2020 290a 2020 2020  ayer).    ).    
+00025500: 6e75 622e 796d 6178 203d 2070 6164 312e  nub.ymax = pad1.
+00025510: 796d 6178 202d 2035 0a20 2020 206e 7562  ymax - 5.    nub
+00025520: 2e78 6d69 6e20 3d20 7061 6431 2e78 6d61  .xmin = pad1.xma
+00025530: 780a 2020 2020 6e75 625f 6f76 6572 6c61  x.    nub_overla
+00025540: 792e 796d 6178 203d 2070 6164 312e 796d  y.ymax = pad1.ym
+00025550: 6178 202d 2035 0a20 2020 206e 7562 5f6f  ax - 5.    nub_o
+00025560: 7665 726c 6179 2e78 6d69 6e20 3d20 7061  verlay.xmin = pa
+00025570: 6431 2e78 6d61 780a 2020 2020 6865 6164  d1.xmax.    head
+00025580: 2e63 6f6e 6e65 6374 2870 6f72 743d 2257  .connect(port="W
+00025590: 222c 2064 6573 7469 6e61 7469 6f6e 3d6e  ", destination=n
+000255a0: 7562 2e70 6f72 7473 5b22 4522 5d29 0a20  ub.ports["E"]). 
+000255b0: 2020 2068 6561 645f 6f76 6572 6c61 792e     head_overlay.
+000255c0: 636f 6e6e 6563 7428 706f 7274 3d22 5722  connect(port="W"
+000255d0: 2c20 6465 7374 696e 6174 696f 6e3d 6e75  , destination=nu
+000255e0: 625f 6f76 6572 6c61 792e 706f 7274 735b  b_overlay.ports[
+000255f0: 2245 225d 290a 2020 2020 7061 6431 5f6f  "E"]).    pad1_o
+00025600: 7665 726c 6179 2e78 6d69 6e20 3d20 7061  verlay.xmin = pa
+00025610: 6431 2e78 6d69 6e0a 2020 2020 7061 6431  d1.xmin.    pad1
+00025620: 5f6f 7665 726c 6179 2e79 6d69 6e20 3d20  _overlay.ymin = 
+00025630: 7061 6431 2e79 6d69 6e0a 0a20 2020 206f  pad1.ymin..    o
+00025640: 6c64 5f70 6f72 7420 3d20 6865 6164 2e70  ld_port = head.p
+00025650: 6f72 7473 5b22 5322 5d0a 2020 2020 636f  orts["S"].    co
+00025660: 756e 7420 3d20 300a 2020 2020 7769 6474  unt = 0.    widt
+00025670: 685f 7669 615f 6974 6572 203d 2032 202a  h_via_iter = 2 *
+00025680: 2076 6961 5f73 7061 6369 6e67 202d 2032   via_spacing - 2
+00025690: 202a 2077 6972 655f 7769 6474 680a 0a20   * wire_width.. 
+000256a0: 2020 2070 6164 322e 786d 696e 203d 2070     pad2.xmin = p
+000256b0: 6164 312e 786d 6178 202b 206d 696e 5f70  ad1.xmax + min_p
+000256c0: 6164 5f73 7061 6369 6e67 0a20 2020 2075  ad_spacing.    u
+000256d0: 7020 3d20 4661 6c73 650a 2020 2020 646f  p = False.    do
+000256e0: 776e 203d 2054 7275 650a 2020 2020 6564  wn = True.    ed
+000256f0: 6765 203d 2054 7275 650a 2020 2020 6375  ge = True.    cu
+00025700: 7272 656e 745f 7769 6474 6820 3d20 3320  rrent_width = 3 
+00025710: 2a20 7769 7265 5f77 6964 7468 202b 2077  * wire_width + w
+00025720: 6972 655f 7769 6474 6820 2023 2077 6964  ire_width  # wid
+00025730: 7468 206f 6620 6e75 6220 616e 6420 3120  th of nub and 1 
+00025740: 6f76 6572 6c61 700a 2020 2020 6f62 6a5f  overlap.    obj_
+00025750: 6f6c 6420 3d20 6865 6164 0a20 2020 206f  old = head.    o
+00025760: 626a 203d 2068 6561 640a 2020 2020 7669  bj = head.    vi
+00025770: 615f 6974 6572 6162 6c65 203d 205f 7669  a_iterable = _vi
+00025780: 615f 6974 6572 6162 6c65 280a 2020 2020  a_iterable(.    
+00025790: 2020 2020 7669 615f 7370 6163 696e 672c      via_spacing,
+000257a0: 2077 6972 655f 7769 6474 682c 2077 6972   wire_width, wir
+000257b0: 696e 6731 5f6c 6179 6572 2c20 7769 7269  ing1_layer, wiri
+000257c0: 6e67 325f 6c61 7965 722c 2076 6961 5f6c  ng2_layer, via_l
+000257d0: 6179 6572 2c20 7669 615f 7769 6474 680a  ayer, via_width.
+000257e0: 2020 2020 290a 2020 2020 7768 696c 6520      ).    while 
+000257f0: 2863 6f75 6e74 202b 2032 2920 3c3d 206e  (count + 2) <= n
+00025800: 756d 5f76 6961 733a 0a20 2020 2020 2020  um_vias:.       
+00025810: 206f 626a 203d 2056 522e 6164 645f 7265   obj = VR.add_re
+00025820: 6628 7669 615f 6974 6572 6162 6c65 290a  f(via_iterable).
+00025830: 2020 2020 2020 2020 6f62 6a2e 636f 6e6e          obj.conn
+00025840: 6563 7428 706f 7274 3d22 5722 2c20 6465  ect(port="W", de
+00025850: 7374 696e 6174 696f 6e3d 6f6c 645f 706f  stination=old_po
+00025860: 7274 2c20 6f76 6572 6c61 703d 7769 7265  rt, overlap=wire
+00025870: 5f77 6964 7468 290a 2020 2020 2020 2020  _width).        
+00025880: 6f6c 645f 706f 7274 203d 206f 626a 2e70  old_port = obj.p
+00025890: 6f72 7473 5b22 4522 5d0a 2020 2020 2020  orts["E"].      
+000258a0: 2020 6564 6765 203d 2046 616c 7365 0a20    edge = False. 
+000258b0: 2020 2020 2020 2069 6620 6f62 6a2e 796d         if obj.ym
+000258c0: 6178 203e 2070 6164 312e 796d 6178 3a0a  ax > pad1.ymax:.
+000258d0: 2020 2020 2020 2020 2020 2020 6f62 6a2e              obj.
+000258e0: 636f 6e6e 6563 7428 706f 7274 3d22 5722  connect(port="W"
+000258f0: 2c20 6465 7374 696e 6174 696f 6e3d 6f62  , destination=ob
+00025900: 6a5f 6f6c 642e 706f 7274 735b 2253 225d  j_old.ports["S"]
+00025910: 2c20 6f76 6572 6c61 703d 7769 7265 5f77  , overlap=wire_w
+00025920: 6964 7468 290a 2020 2020 2020 2020 2020  idth).          
+00025930: 2020 6f6c 645f 706f 7274 203d 206f 626a    old_port = obj
+00025940: 2e70 6f72 7473 5b22 5322 5d0a 2020 2020  .ports["S"].    
+00025950: 2020 2020 2020 2020 6375 7272 656e 745f          current_
+00025960: 7769 6474 6820 2b3d 2077 6964 7468 5f76  width += width_v
+00025970: 6961 5f69 7465 720a 2020 2020 2020 2020  ia_iter.        
+00025980: 2020 2020 646f 776e 203d 2054 7275 650a      down = True.
+00025990: 2020 2020 2020 2020 2020 2020 7570 203d              up =
+000259a0: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
+000259b0: 2020 2065 6467 6520 3d20 5472 7565 0a0a     edge = True..
+000259c0: 2020 2020 2020 2020 656c 6966 206f 626a          elif obj
+000259d0: 2e79 6d69 6e20 3c20 7061 6431 2e79 6d69  .ymin < pad1.ymi
+000259e0: 6e3a 0a20 2020 2020 2020 2020 2020 206f  n:.            o
+000259f0: 626a 2e63 6f6e 6e65 6374 2870 6f72 743d  bj.connect(port=
+00025a00: 2257 222c 2064 6573 7469 6e61 7469 6f6e  "W", destination
+00025a10: 3d6f 626a 5f6f 6c64 2e70 6f72 7473 5b22  =obj_old.ports["
+00025a20: 4e22 5d2c 206f 7665 726c 6170 3d77 6972  N"], overlap=wir
+00025a30: 655f 7769 6474 6829 0a20 2020 2020 2020  e_width).       
+00025a40: 2020 2020 206f 6c64 5f70 6f72 7420 3d20       old_port = 
+00025a50: 6f62 6a2e 706f 7274 735b 224e 225d 0a20  obj.ports["N"]. 
+00025a60: 2020 2020 2020 2020 2020 2063 7572 7265             curre
+00025a70: 6e74 5f77 6964 7468 202b 3d20 7769 6474  nt_width += widt
+00025a80: 685f 7669 615f 6974 6572 0a20 2020 2020  h_via_iter.     
+00025a90: 2020 2020 2020 2075 7020 3d20 5472 7565         up = True
+00025aa0: 0a20 2020 2020 2020 2020 2020 2064 6f77  .            dow
+00025ab0: 6e20 3d20 4661 6c73 650a 2020 2020 2020  n = False.      
+00025ac0: 2020 2020 2020 6564 6765 203d 2054 7275        edge = Tru
+00025ad0: 650a 2020 2020 2020 2020 636f 756e 7420  e.        count 
+00025ae0: 3d20 636f 756e 7420 2b20 320a 2020 2020  = count + 2.    
+00025af0: 2020 2020 6f62 6a5f 6f6c 6420 3d20 6f62      obj_old = ob
+00025b00: 6a0a 0a20 2020 2069 6620 280a 2020 2020  j..    if (.    
+00025b10: 2020 2020 6375 7272 656e 745f 7769 6474      current_widt
+00025b20: 6820 3c20 6d69 6e5f 7061 645f 7370 6163  h < min_pad_spac
+00025b30: 696e 670a 2020 2020 2020 2020 616e 6420  ing.        and 
+00025b40: 286d 696e 5f70 6164 5f73 7061 6369 6e67  (min_pad_spacing
+00025b50: 202d 2063 7572 7265 6e74 5f77 6964 7468   - current_width
+00025b60: 2920 3e20 3320 2a20 7769 7265 5f77 6964  ) > 3 * wire_wid
+00025b70: 7468 0a20 2020 2029 3a0a 2020 2020 2020  th.    ):.      
+00025b80: 2020 7461 696c 203d 2056 522e 6164 645f    tail = VR.add_
+00025b90: 7265 6628 0a20 2020 2020 2020 2020 2020  ref(.           
+00025ba0: 2063 6f6d 7061 7373 280a 2020 2020 2020   compass(.      
+00025bb0: 2020 2020 2020 2020 2020 7369 7a65 3d28            size=(
+00025bc0: 6d69 6e5f 7061 645f 7370 6163 696e 6720  min_pad_spacing 
+00025bd0: 2d20 6375 7272 656e 745f 7769 6474 6820  - current_width 
+00025be0: 2b20 7769 7265 5f77 6964 7468 2c20 7769  + wire_width, wi
+00025bf0: 7265 5f77 6964 7468 292c 0a20 2020 2020  re_width),.     
+00025c00: 2020 2020 2020 2020 2020 206c 6179 6572             layer
+00025c10: 3d77 6972 696e 6731 5f6c 6179 6572 2c0a  =wiring1_layer,.
+00025c20: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00025c30: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00025c40: 7461 696c 5f6f 7665 726c 6179 203d 2056  tail_overlay = V
+00025c50: 522e 6164 645f 7265 6628 0a20 2020 2020  R.add_ref(.     
+00025c60: 2020 2020 2020 2063 6f6d 7061 7373 280a         compass(.
+00025c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025c80: 7369 7a65 3d28 6d69 6e5f 7061 645f 7370  size=(min_pad_sp
+00025c90: 6163 696e 6720 2d20 6375 7272 656e 745f  acing - current_
+00025ca0: 7769 6474 6820 2b20 7769 7265 5f77 6964  width + wire_wid
+00025cb0: 7468 2c20 7769 7265 5f77 6964 7468 292c  th, wire_width),
+00025cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025cd0: 206c 6179 6572 3d70 6164 5f6c 6179 6572   layer=pad_layer
+00025ce0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00025cf0: 2020 2020 2020 2020 290a 2020 2020 656c          ).    el
+00025d00: 7365 3a0a 2020 2020 2020 2020 7461 696c  se:.        tail
+00025d10: 203d 2056 522e 6164 645f 7265 6628 0a20   = VR.add_ref(. 
+00025d20: 2020 2020 2020 2020 2020 2063 6f6d 7061             compa
+00025d30: 7373 2873 697a 653d 2833 202a 2077 6972  ss(size=(3 * wir
+00025d40: 655f 7769 6474 682c 2077 6972 655f 7769  e_width, wire_wi
+00025d50: 6474 6829 2c20 6c61 7965 723d 7769 7269  dth), layer=wiri
+00025d60: 6e67 315f 6c61 7965 7229 0a20 2020 2020  ng1_layer).     
+00025d70: 2020 2029 0a20 2020 2020 2020 2074 6169     ).        tai
+00025d80: 6c5f 6f76 6572 6c61 7920 3d20 5652 2e61  l_overlay = VR.a
+00025d90: 6464 5f72 6566 280a 2020 2020 2020 2020  dd_ref(.        
+00025da0: 2020 2020 636f 6d70 6173 7328 7369 7a65      compass(size
+00025db0: 3d28 3320 2a20 7769 7265 5f77 6964 7468  =(3 * wire_width
+00025dc0: 2c20 7769 7265 5f77 6964 7468 292c 206c  , wire_width), l
+00025dd0: 6179 6572 3d77 6972 696e 6731 5f6c 6179  ayer=wiring1_lay
+00025de0: 6572 290a 2020 2020 2020 2020 290a 0a20  er).        ).. 
+00025df0: 2020 2069 6620 7570 2061 6e64 206e 6f74     if up and not
+00025e00: 2065 6467 653a 0a20 2020 2020 2020 2074   edge:.        t
+00025e10: 6169 6c2e 636f 6e6e 6563 7428 706f 7274  ail.connect(port
+00025e20: 3d22 5722 2c20 6465 7374 696e 6174 696f  ="W", destinatio
+00025e30: 6e3d 6f62 6a2e 706f 7274 735b 2253 225d  n=obj.ports["S"]
+00025e40: 2c20 6f76 6572 6c61 703d 7769 7265 5f77  , overlap=wire_w
+00025e50: 6964 7468 290a 2020 2020 2020 2020 7461  idth).        ta
+00025e60: 696c 5f6f 7665 726c 6179 2e63 6f6e 6e65  il_overlay.conne
+00025e70: 6374 2870 6f72 743d 2257 222c 2064 6573  ct(port="W", des
+00025e80: 7469 6e61 7469 6f6e 3d6f 626a 2e70 6f72  tination=obj.por
+00025e90: 7473 5b22 5322 5d2c 206f 7665 726c 6170  ts["S"], overlap
+00025ea0: 3d77 6972 655f 7769 6474 6829 0a20 2020  =wire_width).   
+00025eb0: 2065 6c69 6620 646f 776e 2061 6e64 206e   elif down and n
+00025ec0: 6f74 2065 6467 653a 0a20 2020 2020 2020  ot edge:.       
+00025ed0: 2074 6169 6c2e 636f 6e6e 6563 7428 706f   tail.connect(po
+00025ee0: 7274 3d22 5722 2c20 6465 7374 696e 6174  rt="W", destinat
+00025ef0: 696f 6e3d 6f62 6a2e 706f 7274 735b 224e  ion=obj.ports["N
+00025f00: 225d 2c20 6f76 6572 6c61 703d 7769 7265  "], overlap=wire
+00025f10: 5f77 6964 7468 290a 2020 2020 2020 2020  _width).        
+00025f20: 7461 696c 5f6f 7665 726c 6179 2e63 6f6e  tail_overlay.con
+00025f30: 6e65 6374 2870 6f72 743d 2257 222c 2064  nect(port="W", d
+00025f40: 6573 7469 6e61 7469 6f6e 3d6f 626a 2e70  estination=obj.p
+00025f50: 6f72 7473 5b22 4e22 5d2c 206f 7665 726c  orts["N"], overl
+00025f60: 6170 3d77 6972 655f 7769 6474 6829 0a20  ap=wire_width). 
+00025f70: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00025f80: 2074 6169 6c2e 636f 6e6e 6563 7428 706f   tail.connect(po
+00025f90: 7274 3d22 5722 2c20 6465 7374 696e 6174  rt="W", destinat
+00025fa0: 696f 6e3d 6f62 6a2e 706f 7274 735b 2245  ion=obj.ports["E
+00025fb0: 225d 2c20 6f76 6572 6c61 703d 7769 7265  "], overlap=wire
+00025fc0: 5f77 6964 7468 290a 2020 2020 2020 2020  _width).        
+00025fd0: 7461 696c 5f6f 7665 726c 6179 2e63 6f6e  tail_overlay.con
+00025fe0: 6e65 6374 2870 6f72 743d 2257 222c 2064  nect(port="W", d
+00025ff0: 6573 7469 6e61 7469 6f6e 3d6f 626a 2e70  estination=obj.p
+00026000: 6f72 7473 5b22 4522 5d2c 206f 7665 726c  orts["E"], overl
+00026010: 6170 3d77 6972 655f 7769 6474 6829 0a0a  ap=wire_width)..
+00026020: 2020 2020 7061 6432 2e78 6d69 6e20 3d20      pad2.xmin = 
+00026030: 7461 696c 2e78 6d61 780a 2020 2020 7061  tail.xmax.    pa
+00026040: 6432 5f6f 7665 726c 6179 2e78 6d69 6e20  d2_overlay.xmin 
+00026050: 3d20 7061 6432 2e78 6d69 6e0a 2020 2020  = pad2.xmin.    
+00026060: 7061 6432 5f6f 7665 726c 6179 2e79 6d69  pad2_overlay.ymi
+00026070: 6e20 3d20 7061 6432 2e79 6d69 6e0a 0a20  n = pad2.ymin.. 
+00026080: 2020 2072 6574 7572 6e20 5652 0a0a 0a64     return VR...d
+00026090: 6566 2074 6573 745f 636f 6d62 280a 2020  ef test_comb(.  
+000260a0: 2020 7061 645f 7369 7a65 3d28 3230 302c    pad_size=(200,
+000260b0: 2032 3030 292c 0a20 2020 2077 6972 655f   200),.    wire_
+000260c0: 7769 6474 683d 312c 0a20 2020 2077 6972  width=1,.    wir
+000260d0: 655f 6761 703d 332c 0a20 2020 2063 6f6d  e_gap=3,.    com
+000260e0: 625f 6c61 7965 723d 302c 0a20 2020 206f  b_layer=0,.    o
+000260f0: 7665 726c 6170 5f7a 6967 7a61 675f 6c61  verlap_zigzag_la
+00026100: 7965 723d 312c 0a20 2020 2063 6f6d 625f  yer=1,.    comb_
+00026110: 7061 645f 6c61 7965 723d 322c 0a20 2020  pad_layer=2,.   
+00026120: 2063 6f6d 625f 676e 645f 6c61 7965 723d   comb_gnd_layer=
+00026130: 332c 0a20 2020 206f 7665 726c 6170 5f70  3,.    overlap_p
+00026140: 6164 5f6c 6179 6572 3d34 2c0a 293a 0a20  ad_layer=4,.):. 
+00026150: 2020 2022 2222 4f76 6572 6c61 7020 636f     """Overlap co
+00026160: 6d62 2074 6573 7420 7374 7275 6374 7572  mb test structur
+00026170: 6520 666f 7220 6368 6563 6b69 6e67 2077  e for checking w
+00026180: 6865 7468 6572 2074 776f 206c 6179 6572  hether two layer
+00026190: 730a 2020 2020 6172 6520 656c 6563 7472  s.    are electr
+000261a0: 6963 616c 6c79 2069 736f 6c61 7465 640a  ically isolated.
+000261b0: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+000261c0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+000261d0: 2020 2070 6164 5f73 697a 6520 3a20 6172     pad_size : ar
+000261e0: 7261 792d 6c69 6b65 0a20 2020 2020 2020  ray-like.       
+000261f0: 2078 2061 6e64 2079 2064 696d 656e 7369   x and y dimensi
+00026200: 6f6e 7320 6f66 2074 6865 2063 6f6d 6220  ons of the comb 
+00026210: 7061 6473 2e0a 2020 2020 7769 7265 5f77  pads..    wire_w
+00026220: 6964 7468 203a 2069 6e74 206f 7220 666c  idth : int or fl
+00026230: 6f61 740a 2020 2020 2020 2020 5769 6474  oat.        Widt
+00026240: 6820 6f66 2074 6865 2074 6573 7420 636f  h of the test co
+00026250: 6d62 2074 6565 7468 2e0a 2020 2020 7769  mb teeth..    wi
+00026260: 7265 5f67 6170 203a 2069 6e74 206f 7220  re_gap : int or 
+00026270: 666c 6f61 740a 2020 2020 2020 2020 5369  float.        Si
+00026280: 7a65 206f 6620 7468 6520 6761 7020 6265  ze of the gap be
+00026290: 7477 6565 6e20 636f 6d62 2074 6565 7468  tween comb teeth
+000262a0: 2e0a 2020 2020 636f 6d62 5f6c 6179 6572  ..    comb_layer
+000262b0: 203a 2069 6e74 2c20 6172 7261 792d 6c69   : int, array-li
+000262c0: 6b65 5b32 5d2c 206f 7220 7365 740a 2020  ke[2], or set.  
+000262d0: 2020 2020 2020 5370 6563 6966 6963 206c        Specific l
+000262e0: 6179 6572 2873 2920 746f 2070 7574 2063  ayer(s) to put c
+000262f0: 6f6d 6220 6765 6f6d 6574 7279 206f 6e2e  omb geometry on.
+00026300: 0a20 2020 206f 7665 726c 6170 5f7a 6967  .    overlap_zig
+00026310: 7a61 675f 6c61 7965 7220 3a20 696e 742c  zag_layer : int,
+00026320: 2061 7272 6179 2d6c 696b 655b 325d 2c20   array-like[2], 
+00026330: 6f72 2073 6574 0a20 2020 2020 2020 2053  or set.        S
+00026340: 7065 6369 6669 6320 6c61 7965 7228 7329  pecific layer(s)
+00026350: 2074 6f20 7075 7420 6f76 6572 6c61 7020   to put overlap 
+00026360: 7a69 677a 6167 2067 656f 6d65 7472 7920  zigzag geometry 
+00026370: 6f6e 2e0a 2020 2020 636f 6d62 5f70 6164  on..    comb_pad
+00026380: 5f6c 6179 6572 203a 2069 6e74 2c20 6172  _layer : int, ar
+00026390: 7261 792d 6c69 6b65 5b32 5d2c 206f 7220  ray-like[2], or 
+000263a0: 7365 740a 2020 2020 2020 2020 5370 6563  set.        Spec
+000263b0: 6966 6963 206c 6179 6572 2873 2920 746f  ific layer(s) to
+000263c0: 2070 7574 2063 6f6d 6220 7061 6473 206f   put comb pads o
+000263d0: 6e2e 0a20 2020 2063 6f6d 625f 676e 645f  n..    comb_gnd_
+000263e0: 6c61 7965 7220 3a20 696e 742c 2061 7272  layer : int, arr
+000263f0: 6179 2d6c 696b 655b 325d 2c20 6f72 2073  ay-like[2], or s
+00026400: 6574 0a20 2020 2020 2020 2053 7065 6369  et.        Speci
+00026410: 6669 6320 6c61 7965 7228 7329 2074 6f20  fic layer(s) to 
+00026420: 7075 7420 7468 6520 636f 6d62 2067 726f  put the comb gro
+00026430: 756e 6420 6f6e 2e0a 2020 2020 6f76 6572  und on..    over
+00026440: 6c61 705f 7061 645f 6c61 7965 7220 3a20  lap_pad_layer : 
+00026450: 696e 742c 2061 7272 6179 2d6c 696b 655b  int, array-like[
+00026460: 325d 2c20 6f72 2073 6574 0a20 2020 2020  2], or set.     
+00026470: 2020 2053 7065 6369 6669 6320 6c61 7965     Specific laye
+00026480: 7228 7329 2074 6f20 7075 7420 6f76 6572  r(s) to put over
+00026490: 6c61 7020 7061 6473 206f 6e2e 0a0a 2020  lap pads on...  
+000264a0: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+000264b0: 2d2d 2d2d 2d0a 2020 2020 4349 203a 2044  -----.    CI : D
+000264c0: 6576 6963 650a 2020 2020 2020 2020 4120  evice.        A 
+000264d0: 4465 7669 6365 2063 6f6e 7461 696e 696e  Device containin
+000264e0: 6720 6120 7465 7374 2063 6f6d 6220 6765  g a test comb ge
+000264f0: 6f6d 6574 7279 2e0a 0a20 2020 204e 6f74  ometry...    Not
+00026500: 6573 0a20 2020 202d 2d2d 2d2d 0a20 2020  es.    -----.   
+00026510: 2043 616c 6c20 636f 6d62 5f69 6e73 756c   Call comb_insul
+00026520: 6174 696f 6e5f 7465 7374 5f73 7472 7563  ation_test_struc
+00026530: 7475 7265 2829 2077 6974 6820 616e 7920  ture() with any 
+00026540: 6f66 2074 6865 2070 6172 616d 6574 6572  of the parameter
+00026550: 7320 7368 6f77 6e0a 2020 2020 6265 6c6f  s shown.    belo
+00026560: 7720 7768 6963 6820 796f 7527 6420 6c69  w which you'd li
+00026570: 6b65 2074 6f20 6368 616e 6765 2e20 596f  ke to change. Yo
+00026580: 7520 6f6e 6c79 206e 6565 6420 746f 2073  u only need to s
+00026590: 7570 706c 7920 7468 6520 7061 7261 6d65  upply the parame
+000265a0: 7465 7273 0a20 2020 2077 6869 6368 2079  ters.    which y
+000265b0: 6f75 2069 6e74 656e 6420 6f6e 2063 6861  ou intend on cha
+000265c0: 6e67 696e 6720 596f 7520 6361 6e20 616c  nging You can al
+000265d0: 7465 726e 6174 6976 656c 7920 6361 6c6c  ternatively call
+000265e0: 2069 7420 7769 7468 206e 6f0a 2020 2020   it with no.    
+000265f0: 7061 7261 6d65 7465 7273 2061 6e64 2069  parameters and i
+00026600: 7420 7769 6c6c 2074 616b 6520 616c 6c20  t will take all 
+00026610: 7468 6520 6465 6661 756c 7420 7661 6c75  the default valu
+00026620: 6573 2073 686f 776e 2062 656c 6f77 2e0a  es shown below..
+00026630: 0a20 2020 2045 783a 3a0a 2020 2020 2020  .    Ex::.      
+00026640: 2020 636f 6d62 5f69 6e73 756c 6174 696f    comb_insulatio
+00026650: 6e5f 7465 7374 5f73 7472 7563 7475 7265  n_test_structure
+00026660: 2870 6164 5f73 697a 653d 2831 3735 2c31  (pad_size=(175,1
+00026670: 3735 292c 2077 6972 655f 7769 6474 683d  75), wire_width=
+00026680: 322c 2077 6972 655f 6761 703d 3529 0a20  2, wire_gap=5). 
+00026690: 2020 202d 206f 7220 2d3a 3a0a 2020 2020     - or -::.    
+000266a0: 2020 2020 636f 6d62 5f69 6e73 756c 6174      comb_insulat
+000266b0: 696f 6e5f 7465 7374 5f73 7472 7563 7475  ion_test_structu
+000266c0: 7265 2829 0a20 2020 2022 2222 0a20 2020  re().    """.   
+000266d0: 2043 4920 3d20 4465 7669 6365 2822 7465   CI = Device("te
+000266e0: 7374 5f63 6f6d 6222 290a 0a20 2020 2023  st_comb")..    #
+000266f0: 2069 6620 636f 6d62 5f70 6164 5f6c 6179   if comb_pad_lay
+00026700: 6572 2069 7320 4e6f 6e65 3a20 636f 6d62  er is None: comb
+00026710: 5f70 6164 5f6c 6179 6572 203d 2063 6f6d  _pad_layer = com
+00026720: 625f 6c61 7965 720a 2020 2020 2320 6966  b_layer.    # if
+00026730: 2063 6f6d 625f 676e 645f 6c61 7965 7220   comb_gnd_layer 
+00026740: 6973 204e 6f6e 653a 2063 6f6d 625f 676e  is None: comb_gn
+00026750: 645f 6c61 7965 7220 3d20 636f 6d62 5f6c  d_layer = comb_l
+00026760: 6179 6572 0a20 2020 2023 2069 6620 6f76  ayer.    # if ov
+00026770: 6572 6c61 705f 7061 645f 6c61 7965 7220  erlap_pad_layer 
+00026780: 6973 204e 6f6e 653a 206f 7665 726c 6170  is None: overlap
+00026790: 5f70 6164 5f6c 6179 6572 203d 206f 7665  _pad_layer = ove
+000267a0: 726c 6170 5f7a 6967 7a61 675f 6c61 7965  rlap_zigzag_laye
+000267b0: 720a 2020 2020 7769 7265 5f73 7061 6369  r.    wire_spaci
+000267c0: 6e67 203d 2077 6972 655f 7769 6474 6820  ng = wire_width 
+000267d0: 2b20 7769 7265 5f67 6170 202a 2032 0a0a  + wire_gap * 2..
+000267e0: 2020 2020 2320 7061 6420 6f76 6572 6c61      # pad overla
+000267f0: 7973 0a20 2020 206f 7665 726c 6179 5f70  ys.    overlay_p
+00026800: 6164 6220 3d20 4349 2e61 6464 5f72 6566  adb = CI.add_ref
+00026810: 280a 2020 2020 2020 2020 7265 6374 616e  (.        rectan
+00026820: 676c 6528 0a20 2020 2020 2020 2020 2020  gle(.           
+00026830: 2073 697a 653d 2870 6164 5f73 697a 655b   size=(pad_size[
+00026840: 305d 202a 2039 202f 2031 302c 2070 6164  0] * 9 / 10, pad
+00026850: 5f73 697a 655b 315d 202a 2039 202f 2031  _size[1] * 9 / 1
+00026860: 3029 2c20 6c61 7965 723d 6f76 6572 6c61  0), layer=overla
+00026870: 705f 7061 645f 6c61 7965 720a 2020 2020  p_pad_layer.    
+00026880: 2020 2020 290a 2020 2020 290a 2020 2020      ).    ).    
+00026890: 6f76 6572 6c61 795f 7061 646c 203d 2043  overlay_padl = C
+000268a0: 492e 6164 645f 7265 6628 0a20 2020 2020  I.add_ref(.     
+000268b0: 2020 2072 6563 7461 6e67 6c65 280a 2020     rectangle(.  
+000268c0: 2020 2020 2020 2020 2020 7369 7a65 3d28            size=(
+000268d0: 7061 645f 7369 7a65 5b30 5d20 2a20 3920  pad_size[0] * 9 
+000268e0: 2f20 3130 2c20 7061 645f 7369 7a65 5b31  / 10, pad_size[1
+000268f0: 5d20 2a20 3920 2f20 3130 292c 206c 6179  ] * 9 / 10), lay
+00026900: 6572 3d63 6f6d 625f 7061 645f 6c61 7965  er=comb_pad_laye
+00026910: 720a 2020 2020 2020 2020 290a 2020 2020  r.        ).    
+00026920: 290a 2020 2020 6f76 6572 6c61 795f 7061  ).    overlay_pa
+00026930: 6474 203d 2043 492e 6164 645f 7265 6628  dt = CI.add_ref(
+00026940: 0a20 2020 2020 2020 2072 6563 7461 6e67  .        rectang
+00026950: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
+00026960: 7369 7a65 3d28 7061 645f 7369 7a65 5b30  size=(pad_size[0
+00026970: 5d20 2a20 3920 2f20 3130 2c20 7061 645f  ] * 9 / 10, pad_
+00026980: 7369 7a65 5b31 5d20 2a20 3920 2f20 3130  size[1] * 9 / 10
+00026990: 292c 206c 6179 6572 3d63 6f6d 625f 7061  ), layer=comb_pa
+000269a0: 645f 6c61 7965 720a 2020 2020 2020 2020  d_layer.        
+000269b0: 290a 2020 2020 290a 2020 2020 6f76 6572  ).    ).    over
+000269c0: 6c61 795f 7061 6472 203d 2043 492e 6164  lay_padr = CI.ad
+000269d0: 645f 7265 6628 0a20 2020 2020 2020 2072  d_ref(.        r
+000269e0: 6563 7461 6e67 6c65 280a 2020 2020 2020  ectangle(.      
+000269f0: 2020 2020 2020 7369 7a65 3d28 7061 645f        size=(pad_
+00026a00: 7369 7a65 5b30 5d20 2a20 3920 2f20 3130  size[0] * 9 / 10
+00026a10: 2c20 7061 645f 7369 7a65 5b31 5d20 2a20  , pad_size[1] * 
+00026a20: 3920 2f20 3130 292c 206c 6179 6572 3d63  9 / 10), layer=c
+00026a30: 6f6d 625f 676e 645f 6c61 7965 720a 2020  omb_gnd_layer.  
+00026a40: 2020 2020 2020 290a 2020 2020 290a 2020        ).    ).  
+00026a50: 2020 6f76 6572 6c61 795f 7061 646c 2e78    overlay_padl.x
+00026a60: 6d69 6e20 3d20 300a 2020 2020 6f76 6572  min = 0.    over
+00026a70: 6c61 795f 7061 646c 2e79 6d69 6e20 3d20  lay_padl.ymin = 
+00026a80: 300a 2020 2020 6f76 6572 6c61 795f 7061  0.    overlay_pa
+00026a90: 6462 2e79 6d61 7820 3d20 300a 2020 2020  db.ymax = 0.    
+00026aa0: 6f76 6572 6c61 795f 7061 6462 2e78 6d69  overlay_padb.xmi
+00026ab0: 6e20 3d20 6f76 6572 6c61 795f 7061 646c  n = overlay_padl
+00026ac0: 2e78 6d61 7820 2b20 7061 645f 7369 7a65  .xmax + pad_size
+00026ad0: 5b31 5d20 2f20 350a 2020 2020 6f76 6572  [1] / 5.    over
+00026ae0: 6c61 795f 7061 6472 2e79 6d69 6e20 3d20  lay_padr.ymin = 
+00026af0: 6f76 6572 6c61 795f 7061 646c 2e79 6d69  overlay_padl.ymi
+00026b00: 6e0a 2020 2020 6f76 6572 6c61 795f 7061  n.    overlay_pa
+00026b10: 6472 2e78 6d69 6e20 3d20 6f76 6572 6c61  dr.xmin = overla
+00026b20: 795f 7061 6462 2e78 6d61 7820 2b20 7061  y_padb.xmax + pa
+00026b30: 645f 7369 7a65 5b31 5d20 2f20 350a 2020  d_size[1] / 5.  
+00026b40: 2020 6f76 6572 6c61 795f 7061 6474 2e78    overlay_padt.x
+00026b50: 6d69 6e20 3d20 6f76 6572 6c61 795f 7061  min = overlay_pa
+00026b60: 646c 2e78 6d61 7820 2b20 7061 645f 7369  dl.xmax + pad_si
+00026b70: 7a65 5b31 5d20 2f20 350a 2020 2020 6f76  ze[1] / 5.    ov
+00026b80: 6572 6c61 795f 7061 6474 2e79 6d69 6e20  erlay_padt.ymin 
+00026b90: 3d20 6f76 6572 6c61 795f 7061 646c 2e79  = overlay_padl.y
+00026ba0: 6d61 780a 0a20 2020 2023 2070 6164 730a  max..    # pads.
+00026bb0: 2020 2020 7061 646c 203d 2043 492e 6164      padl = CI.ad
+00026bc0: 645f 7265 6628 7265 6374 616e 676c 6528  d_ref(rectangle(
+00026bd0: 7369 7a65 3d70 6164 5f73 697a 652c 206c  size=pad_size, l
+00026be0: 6179 6572 3d63 6f6d 625f 6c61 7965 7229  ayer=comb_layer)
+00026bf0: 290a 2020 2020 7061 6474 203d 2043 492e  ).    padt = CI.
+00026c00: 6164 645f 7265 6628 7265 6374 616e 676c  add_ref(rectangl
+00026c10: 6528 7369 7a65 3d70 6164 5f73 697a 652c  e(size=pad_size,
+00026c20: 206c 6179 6572 3d63 6f6d 625f 6c61 7965   layer=comb_laye
+00026c30: 7229 290a 2020 2020 7061 6472 203d 2043  r)).    padr = C
+00026c40: 492e 6164 645f 7265 6628 7265 6374 616e  I.add_ref(rectan
+00026c50: 676c 6528 7369 7a65 3d70 6164 5f73 697a  gle(size=pad_siz
+00026c60: 652c 206c 6179 6572 3d63 6f6d 625f 6c61  e, layer=comb_la
+00026c70: 7965 7229 290a 2020 2020 7061 6462 203d  yer)).    padb =
+00026c80: 2043 492e 6164 645f 7265 6628 7265 6374   CI.add_ref(rect
+00026c90: 616e 676c 6528 7369 7a65 3d70 6164 5f73  angle(size=pad_s
+00026ca0: 697a 652c 206c 6179 6572 3d6f 7665 726c  ize, layer=overl
+00026cb0: 6170 5f7a 6967 7a61 675f 6c61 7965 7229  ap_zigzag_layer)
+00026cc0: 290a 2020 2020 7061 646c 5f6e 7562 203d  ).    padl_nub =
+00026cd0: 2043 492e 6164 645f 7265 6628 0a20 2020   CI.add_ref(.   
+00026ce0: 2020 2020 2072 6563 7461 6e67 6c65 2873       rectangle(s
+00026cf0: 697a 653d 2870 6164 5f73 697a 655b 305d  ize=(pad_size[0]
+00026d00: 202f 2034 2c20 7061 645f 7369 7a65 5b31   / 4, pad_size[1
+00026d10: 5d20 2f20 3229 2c20 6c61 7965 723d 636f  ] / 2), layer=co
+00026d20: 6d62 5f6c 6179 6572 290a 2020 2020 290a  mb_layer).    ).
+00026d30: 2020 2020 7061 6472 5f6e 7562 203d 2043      padr_nub = C
+00026d40: 492e 6164 645f 7265 6628 0a20 2020 2020  I.add_ref(.     
+00026d50: 2020 2072 6563 7461 6e67 6c65 2873 697a     rectangle(siz
+00026d60: 653d 2870 6164 5f73 697a 655b 305d 202f  e=(pad_size[0] /
+00026d70: 2034 2c20 7061 645f 7369 7a65 5b31 5d20   4, pad_size[1] 
+00026d80: 2f20 3229 2c20 6c61 7965 723d 636f 6d62  / 2), layer=comb
+00026d90: 5f6c 6179 6572 290a 2020 2020 290a 2020  _layer).    ).  
+00026da0: 2020 7061 646c 2e78 6d69 6e20 3d20 6f76    padl.xmin = ov
+00026db0: 6572 6c61 795f 7061 646c 2e78 6d69 6e0a  erlay_padl.xmin.
+00026dc0: 2020 2020 7061 646c 2e63 656e 7465 7220      padl.center 
+00026dd0: 3d20 5b70 6164 6c2e 6365 6e74 6572 5b30  = [padl.center[0
+00026de0: 5d2c 206f 7665 726c 6179 5f70 6164 6c2e  ], overlay_padl.
+00026df0: 6365 6e74 6572 5b31 5d5d 0a20 2020 2070  center[1]].    p
+00026e00: 6164 742e 796d 6178 203d 206f 7665 726c  adt.ymax = overl
+00026e10: 6179 5f70 6164 742e 796d 6178 0a20 2020  ay_padt.ymax.   
+00026e20: 2070 6164 742e 6365 6e74 6572 203d 205b   padt.center = [
+00026e30: 6f76 6572 6c61 795f 7061 6474 2e63 656e  overlay_padt.cen
+00026e40: 7465 725b 305d 2c20 7061 6474 2e63 656e  ter[0], padt.cen
+00026e50: 7465 725b 315d 5d0a 2020 2020 7061 6472  ter[1]].    padr
+00026e60: 2e78 6d61 7820 3d20 6f76 6572 6c61 795f  .xmax = overlay_
+00026e70: 7061 6472 2e78 6d61 780a 2020 2020 7061  padr.xmax.    pa
+00026e80: 6472 2e63 656e 7465 7220 3d20 5b70 6164  dr.center = [pad
+00026e90: 722e 6365 6e74 6572 5b30 5d2c 206f 7665  r.center[0], ove
+00026ea0: 726c 6179 5f70 6164 722e 6365 6e74 6572  rlay_padr.center
+00026eb0: 5b31 5d5d 0a20 2020 2070 6164 622e 796d  [1]].    padb.ym
+00026ec0: 696e 203d 206f 7665 726c 6179 5f70 6164  in = overlay_pad
+00026ed0: 622e 796d 696e 0a20 2020 2070 6164 622e  b.ymin.    padb.
+00026ee0: 6365 6e74 6572 203d 205b 6f76 6572 6c61  center = [overla
+00026ef0: 795f 7061 6462 2e63 656e 7465 725b 305d  y_padb.center[0]
+00026f00: 2c20 7061 6462 2e63 656e 7465 725b 315d  , padb.center[1]
+00026f10: 5d0a 2020 2020 7061 646c 5f6e 7562 2e78  ].    padl_nub.x
+00026f20: 6d69 6e20 3d20 7061 646c 2e78 6d61 780a  min = padl.xmax.
+00026f30: 2020 2020 7061 646c 5f6e 7562 2e63 656e      padl_nub.cen
+00026f40: 7465 7220 3d20 5b70 6164 6c5f 6e75 622e  ter = [padl_nub.
+00026f50: 6365 6e74 6572 5b30 5d2c 2070 6164 6c2e  center[0], padl.
+00026f60: 6365 6e74 6572 5b31 5d5d 0a20 2020 2070  center[1]].    p
+00026f70: 6164 725f 6e75 622e 786d 6178 203d 2070  adr_nub.xmax = p
+00026f80: 6164 722e 786d 696e 0a20 2020 2070 6164  adr.xmin.    pad
+00026f90: 725f 6e75 622e 6365 6e74 6572 203d 205b  r_nub.center = [
+00026fa0: 7061 6472 5f6e 7562 2e63 656e 7465 725b  padr_nub.center[
+00026fb0: 305d 2c20 7061 6472 2e63 656e 7465 725b  0], padr.center[
+00026fc0: 315d 5d0a 0a20 2020 2023 2063 6f6e 6e65  1]]..    # conne
+00026fd0: 6374 6564 207a 6967 0a20 2020 2068 6561  cted zig.    hea
+00026fe0: 6420 3d20 4349 2e61 6464 5f72 6566 2863  d = CI.add_ref(c
+00026ff0: 6f6d 7061 7373 2873 697a 653d 2870 6164  ompass(size=(pad
+00027000: 5f73 697a 655b 305d 202f 2031 322c 2077  _size[0] / 12, w
+00027010: 6972 655f 7769 6474 6829 2c20 6c61 7965  ire_width), laye
+00027020: 723d 636f 6d62 5f6c 6179 6572 2929 0a20  r=comb_layer)). 
+00027030: 2020 2068 6561 642e 786d 696e 203d 2070     head.xmin = p
+00027040: 6164 6c5f 6e75 622e 786d 6178 0a20 2020  adl_nub.xmax.   
+00027050: 2068 6561 642e 796d 6178 203d 2070 6164   head.ymax = pad
+00027060: 6c5f 6e75 622e 796d 6178 0a20 2020 2063  l_nub.ymax.    c
+00027070: 6f6e 6e65 6374 6f72 203d 2043 492e 6164  onnector = CI.ad
+00027080: 645f 7265 6628 636f 6d70 6173 7328 7369  d_ref(compass(si
+00027090: 7a65 3d28 7769 7265 5f77 6964 7468 2c20  ze=(wire_width, 
+000270a0: 7769 7265 5f77 6964 7468 292c 206c 6179  wire_width), lay
+000270b0: 6572 3d63 6f6d 625f 6c61 7965 7229 290a  er=comb_layer)).
+000270c0: 2020 2020 636f 6e6e 6563 746f 722e 636f      connector.co
+000270d0: 6e6e 6563 7428 706f 7274 3d22 5722 2c20  nnect(port="W", 
+000270e0: 6465 7374 696e 6174 696f 6e3d 6865 6164  destination=head
+000270f0: 2e70 6f72 7473 5b22 4522 5d29 0a20 2020  .ports["E"]).   
+00027100: 206f 6c64 5f70 6f72 7420 3d20 636f 6e6e   old_port = conn
+00027110: 6563 746f 722e 706f 7274 735b 2253 225d  ector.ports["S"]
+00027120: 0a20 2020 2074 6f70 203d 2054 7275 650a  .    top = True.
+00027130: 2020 2020 6f62 6a20 3d20 636f 6e6e 6563      obj = connec
+00027140: 746f 720a 2020 2020 7768 696c 6520 6f62  tor.    while ob
+00027150: 6a2e 786d 6178 202b 2070 6164 5f73 697a  j.xmax + pad_siz
+00027160: 655b 305d 202f 2031 3220 3c20 7061 6472  e[0] / 12 < padr
+00027170: 5f6e 7562 2e78 6d69 6e3a 0a20 2020 2020  _nub.xmin:.     
+00027180: 2020 2023 206c 6f6e 6720 7a69 6720 7a61     # long zig za
+00027190: 6720 7265 6374 616e 676c 650a 2020 2020  g rectangle.    
+000271a0: 2020 2020 6f62 6a20 3d20 4349 2e61 6464      obj = CI.add
+000271b0: 5f72 6566 280a 2020 2020 2020 2020 2020  _ref(.          
+000271c0: 2020 636f 6d70 6173 7328 0a20 2020 2020    compass(.     
+000271d0: 2020 2020 2020 2020 2020 2073 697a 653d             size=
+000271e0: 2870 6164 5f73 697a 655b 315d 202f 2032  (pad_size[1] / 2
+000271f0: 202d 2032 202a 2077 6972 655f 7769 6474   - 2 * wire_widt
+00027200: 682c 2077 6972 655f 7769 6474 6829 2c20  h, wire_width), 
+00027210: 6c61 7965 723d 636f 6d62 5f6c 6179 6572  layer=comb_layer
+00027220: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00027230: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00027240: 206f 626a 2e63 6f6e 6e65 6374 2870 6f72   obj.connect(por
+00027250: 743d 2257 222c 2064 6573 7469 6e61 7469  t="W", destinati
+00027260: 6f6e 3d6f 6c64 5f70 6f72 7429 0a20 2020  on=old_port).   
+00027270: 2020 2020 206f 6c64 5f70 6f72 7420 3d20       old_port = 
+00027280: 6f62 6a2e 706f 7274 735b 2245 225d 0a20  obj.ports["E"]. 
+00027290: 2020 2020 2020 2069 6620 746f 703a 0a20         if top:. 
+000272a0: 2020 2020 2020 2020 2020 2023 207a 6967             # zig
+000272b0: 207a 6167 2065 6467 6520 7265 6374 616e   zag edge rectan
+000272c0: 676c 650a 2020 2020 2020 2020 2020 2020  gle.            
+000272d0: 6f62 6a20 3d20 4349 2e61 6464 5f72 6566  obj = CI.add_ref
+000272e0: 2863 6f6d 7061 7373 2873 697a 653d 2877  (compass(size=(w
+000272f0: 6972 655f 7769 6474 682c 2077 6972 655f  ire_width, wire_
+00027300: 7769 6474 6829 2c20 6c61 7965 723d 636f  width), layer=co
+00027310: 6d62 5f6c 6179 6572 2929 0a20 2020 2020  mb_layer)).     
+00027320: 2020 2020 2020 206f 626a 2e63 6f6e 6e65         obj.conne
+00027330: 6374 2870 6f72 743d 224e 222c 2064 6573  ct(port="N", des
+00027340: 7469 6e61 7469 6f6e 3d6f 6c64 5f70 6f72  tination=old_por
+00027350: 7429 0a20 2020 2020 2020 2020 2020 2074  t).            t
+00027360: 6f70 203d 2046 616c 7365 0a20 2020 2020  op = False.     
+00027370: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00027380: 2020 2020 2023 207a 6967 207a 6167 2065       # zig zag e
+00027390: 6467 6520 7265 6374 616e 676c 650a 2020  dge rectangle.  
+000273a0: 2020 2020 2020 2020 2020 6f62 6a20 3d20            obj = 
+000273b0: 4349 2e61 6464 5f72 6566 2863 6f6d 7061  CI.add_ref(compa
+000273c0: 7373 2873 697a 653d 2877 6972 655f 7769  ss(size=(wire_wi
+000273d0: 6474 682c 2077 6972 655f 7769 6474 6829  dth, wire_width)
+000273e0: 2c20 6c61 7965 723d 636f 6d62 5f6c 6179  , layer=comb_lay
+000273f0: 6572 2929 0a20 2020 2020 2020 2020 2020  er)).           
+00027400: 206f 626a 2e63 6f6e 6e65 6374 2870 6f72   obj.connect(por
+00027410: 743d 2253 222c 2064 6573 7469 6e61 7469  t="S", destinati
+00027420: 6f6e 3d6f 6c64 5f70 6f72 7429 0a20 2020  on=old_port).   
+00027430: 2020 2020 2020 2020 2074 6f70 203d 2054           top = T
+00027440: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+00027450: 2320 636f 6d62 2072 6563 7461 6e67 650a  # comb rectange.
+00027460: 2020 2020 2020 2020 2020 2020 636f 6d62              comb
+00027470: 203d 2043 492e 6164 645f 7265 6628 0a20   = CI.add_ref(. 
+00027480: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00027490: 6563 7461 6e67 6c65 280a 2020 2020 2020  ectangle(.      
+000274a0: 2020 2020 2020 2020 2020 2020 2020 7369                si
+000274b0: 7a65 3d28 0a20 2020 2020 2020 2020 2020  ze=(.           
+000274c0: 2020 2020 2020 2020 2020 2020 2028 7061               (pa
+000274d0: 6474 2e79 6d69 6e20 2d20 6865 6164 2e79  dt.ymin - head.y
+000274e0: 6d61 7829 0a20 2020 2020 2020 2020 2020  max).           
+000274f0: 2020 2020 2020 2020 2020 2020 202b 2070               + p
+00027500: 6164 5f73 697a 655b 315d 202f 2032 0a20  ad_size[1] / 2. 
+00027510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027520: 2020 2020 2020 202d 2028 7769 7265 5f73         - (wire_s
+00027530: 7061 6369 6e67 202b 2077 6972 655f 7769  pacing + wire_wi
+00027540: 6474 6829 202f 2032 2c0a 2020 2020 2020  dth) / 2,.      
+00027550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027560: 2020 7769 7265 5f77 6964 7468 2c0a 2020    wire_width,.  
+00027570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027580: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
+00027590: 2020 2020 2020 2020 206c 6179 6572 3d63           layer=c
+000275a0: 6f6d 625f 6c61 7965 722c 0a20 2020 2020  omb_layer,.     
+000275b0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000275c0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000275d0: 2020 2020 2020 2063 6f6d 622e 726f 7461         comb.rota
+000275e0: 7465 2839 3029 0a20 2020 2020 2020 2020  te(90).         
+000275f0: 2020 2063 6f6d 622e 796d 6178 203d 2070     comb.ymax = p
+00027600: 6164 742e 796d 696e 0a20 2020 2020 2020  adt.ymin.       
+00027610: 2020 2020 2063 6f6d 622e 786d 6178 203d       comb.xmax =
+00027620: 206f 626a 2e78 6d61 7820 2d20 2877 6972   obj.xmax - (wir
+00027630: 655f 7370 6163 696e 6720 2b20 7769 7265  e_spacing + wire
+00027640: 5f77 6964 7468 2920 2f20 320a 2020 2020  _width) / 2.    
+00027650: 2020 2020 6f6c 645f 706f 7274 203d 206f      old_port = o
+00027660: 626a 2e70 6f72 7473 5b22 4522 5d0a 2020  bj.ports["E"].  
+00027670: 2020 2020 2020 6f62 6a20 3d20 4349 2e61        obj = CI.a
+00027680: 6464 5f72 6566 2863 6f6d 7061 7373 2873  dd_ref(compass(s
+00027690: 697a 653d 2877 6972 655f 7370 6163 696e  ize=(wire_spacin
+000276a0: 672c 2077 6972 655f 7769 6474 6829 2c20  g, wire_width), 
+000276b0: 6c61 7965 723d 636f 6d62 5f6c 6179 6572  layer=comb_layer
+000276c0: 2929 0a20 2020 2020 2020 206f 626a 2e63  )).        obj.c
+000276d0: 6f6e 6e65 6374 2870 6f72 743d 2257 222c  onnect(port="W",
+000276e0: 2064 6573 7469 6e61 7469 6f6e 3d6f 6c64   destination=old
+000276f0: 5f70 6f72 7429 0a20 2020 2020 2020 206f  _port).        o
+00027700: 6c64 5f70 6f72 7420 3d20 6f62 6a2e 706f  ld_port = obj.po
+00027710: 7274 735b 2245 225d 0a20 2020 2020 2020  rts["E"].       
+00027720: 206f 626a 203d 2043 492e 6164 645f 7265   obj = CI.add_re
+00027730: 6628 636f 6d70 6173 7328 7369 7a65 3d28  f(compass(size=(
+00027740: 7769 7265 5f77 6964 7468 2c20 7769 7265  wire_width, wire
+00027750: 5f77 6964 7468 292c 206c 6179 6572 3d63  _width), layer=c
+00027760: 6f6d 625f 6c61 7965 7229 290a 2020 2020  omb_layer)).    
+00027770: 2020 2020 6f62 6a2e 636f 6e6e 6563 7428      obj.connect(
+00027780: 706f 7274 3d22 5722 2c20 6465 7374 696e  port="W", destin
+00027790: 6174 696f 6e3d 6f6c 645f 706f 7274 290a  ation=old_port).
+000277a0: 2020 2020 2020 2020 6966 2074 6f70 3a0a          if top:.
+000277b0: 2020 2020 2020 2020 2020 2020 6f6c 645f              old_
+000277c0: 706f 7274 203d 206f 626a 2e70 6f72 7473  port = obj.ports
+000277d0: 5b22 5322 5d0a 2020 2020 2020 2020 656c  ["S"].        el
+000277e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000277f0: 6f6c 645f 706f 7274 203d 206f 626a 2e70  old_port = obj.p
+00027800: 6f72 7473 5b22 4e22 5d0a 2020 2020 6f6c  orts["N"].    ol
+00027810: 645f 706f 7274 203d 206f 626a 2e70 6f72  d_port = obj.por
+00027820: 7473 5b22 4522 5d0a 2020 2020 6966 2070  ts["E"].    if p
+00027830: 6164 725f 6e75 622e 786d 696e 202d 206f  adr_nub.xmin - o
+00027840: 626a 2e78 6d61 7820 3e20 303a 0a20 2020  bj.xmax > 0:.   
+00027850: 2020 2020 2074 6169 6c20 3d20 4349 2e61       tail = CI.a
+00027860: 6464 5f72 6566 280a 2020 2020 2020 2020  dd_ref(.        
+00027870: 2020 2020 636f 6d70 6173 7328 7369 7a65      compass(size
+00027880: 3d28 7061 6472 5f6e 7562 2e78 6d69 6e20  =(padr_nub.xmin 
+00027890: 2d20 6f62 6a2e 786d 6178 2c20 7769 7265  - obj.xmax, wire
+000278a0: 5f77 6964 7468 292c 206c 6179 6572 3d63  _width), layer=c
+000278b0: 6f6d 625f 6c61 7965 7229 0a20 2020 2020  omb_layer).     
+000278c0: 2020 2029 0a20 2020 2065 6c73 653a 0a20     ).    else:. 
+000278d0: 2020 2020 2020 2074 6169 6c20 3d20 4349         tail = CI
+000278e0: 2e61 6464 5f72 6566 2863 6f6d 7061 7373  .add_ref(compass
+000278f0: 2873 697a 653d 2877 6972 655f 7769 6474  (size=(wire_widt
+00027900: 682c 2077 6972 655f 7769 6474 6829 2c20  h, wire_width), 
+00027910: 6c61 7965 723d 636f 6d62 5f6c 6179 6572  layer=comb_layer
+00027920: 2929 0a20 2020 2074 6169 6c2e 636f 6e6e  )).    tail.conn
+00027930: 6563 7428 706f 7274 3d22 5722 2c20 6465  ect(port="W", de
+00027940: 7374 696e 6174 696f 6e3d 6f6c 645f 706f  stination=old_po
+00027950: 7274 290a 0a20 2020 2023 2064 6973 636f  rt)..    # disco
+00027960: 6e6e 6563 7465 6420 7a69 670a 2020 2020  nnected zig.    
+00027970: 6468 6561 6420 3d20 4349 2e61 6464 5f72  dhead = CI.add_r
+00027980: 6566 280a 2020 2020 2020 2020 636f 6d70  ef(.        comp
+00027990: 6173 7328 0a20 2020 2020 2020 2020 2020  ass(.           
+000279a0: 2073 697a 653d 2870 6164 725f 6e75 622e   size=(padr_nub.
+000279b0: 796d 696e 202d 2070 6164 622e 796d 6178  ymin - padb.ymax
+000279c0: 202d 2077 6972 655f 7769 6474 682c 2077   - wire_width, w
+000279d0: 6972 655f 7769 6474 6829 2c0a 2020 2020  ire_width),.    
+000279e0: 2020 2020 2020 2020 6c61 7965 723d 6f76          layer=ov
+000279f0: 6572 6c61 705f 7a69 677a 6167 5f6c 6179  erlap_zigzag_lay
+00027a00: 6572 2c0a 2020 2020 2020 2020 290a 2020  er,.        ).  
+00027a10: 2020 290a 2020 2020 6468 6561 642e 726f    ).    dhead.ro
+00027a20: 7461 7465 2839 3029 0a20 2020 2064 6865  tate(90).    dhe
+00027a30: 6164 2e79 6d69 6e20 3d20 7061 6462 2e79  ad.ymin = padb.y
+00027a40: 6d61 780a 2020 2020 6468 6561 642e 786d  max.    dhead.xm
+00027a50: 6178 203d 2074 6169 6c2e 786d 696e 202d  ax = tail.xmin -
+00027a60: 2028 7769 7265 5f73 7061 6369 6e67 202b   (wire_spacing +
+00027a70: 2077 6972 655f 7769 6474 6829 202f 2032   wire_width) / 2
+00027a80: 0a20 2020 2063 6f6e 6e65 6374 6f72 203d  .    connector =
+00027a90: 2043 492e 6164 645f 7265 6628 0a20 2020   CI.add_ref(.   
+00027aa0: 2020 2020 2063 6f6d 7061 7373 2873 697a       compass(siz
+00027ab0: 653d 2877 6972 655f 7769 6474 682c 2077  e=(wire_width, w
+00027ac0: 6972 655f 7769 6474 6829 2c20 6c61 7965  ire_width), laye
+00027ad0: 723d 6f76 6572 6c61 705f 7a69 677a 6167  r=overlap_zigzag
+00027ae0: 5f6c 6179 6572 290a 2020 2020 290a 2020  _layer).    ).  
+00027af0: 2020 636f 6e6e 6563 746f 722e 636f 6e6e    connector.conn
+00027b00: 6563 7428 706f 7274 3d22 5322 2c20 6465  ect(port="S", de
+00027b10: 7374 696e 6174 696f 6e3d 6468 6561 642e  stination=dhead.
+00027b20: 706f 7274 735b 2245 225d 290a 2020 2020  ports["E"]).    
+00027b30: 6f6c 645f 706f 7274 203d 2063 6f6e 6e65  old_port = conne
+00027b40: 6374 6f72 2e70 6f72 7473 5b22 4e22 5d0a  ctor.ports["N"].
+00027b50: 2020 2020 7269 6768 7420 3d20 5472 7565      right = True
+00027b60: 0a20 2020 206f 626a 203d 2063 6f6e 6e65  .    obj = conne
+00027b70: 6374 6f72 0a20 2020 2077 6869 6c65 206f  ctor.    while o
+00027b80: 626a 2e79 6d61 7820 2b20 7769 7265 5f73  bj.ymax + wire_s
+00027b90: 7061 6369 6e67 202b 2077 6972 655f 7769  pacing + wire_wi
+00027ba0: 6474 6820 3c20 6865 6164 2e79 6d61 783a  dth < head.ymax:
+00027bb0: 0a20 2020 2020 2020 206f 626a 203d 2043  .        obj = C
+00027bc0: 492e 6164 645f 7265 6628 0a20 2020 2020  I.add_ref(.     
+00027bd0: 2020 2020 2020 2063 6f6d 7061 7373 2873         compass(s
+00027be0: 697a 653d 2877 6972 655f 7370 6163 696e  ize=(wire_spacin
+00027bf0: 672c 2077 6972 655f 7769 6474 6829 2c20  g, wire_width), 
+00027c00: 6c61 7965 723d 6f76 6572 6c61 705f 7a69  layer=overlap_zi
+00027c10: 677a 6167 5f6c 6179 6572 290a 2020 2020  gzag_layer).    
+00027c20: 2020 2020 290a 2020 2020 2020 2020 6f62      ).        ob
+00027c30: 6a2e 636f 6e6e 6563 7428 706f 7274 3d22  j.connect(port="
+00027c40: 5722 2c20 6465 7374 696e 6174 696f 6e3d  W", destination=
+00027c50: 6f6c 645f 706f 7274 290a 2020 2020 2020  old_port).      
+00027c60: 2020 6f6c 645f 706f 7274 203d 206f 626a    old_port = obj
+00027c70: 2e70 6f72 7473 5b22 4522 5d0a 2020 2020  .ports["E"].    
+00027c80: 2020 2020 6966 2072 6967 6874 3a0a 2020      if right:.  
+00027c90: 2020 2020 2020 2020 2020 6f62 6a20 3d20            obj = 
+00027ca0: 4349 2e61 6464 5f72 6566 280a 2020 2020  CI.add_ref(.    
+00027cb0: 2020 2020 2020 2020 2020 2020 636f 6d70              comp
+00027cc0: 6173 7328 7369 7a65 3d28 7769 7265 5f77  ass(size=(wire_w
+00027cd0: 6964 7468 2c20 7769 7265 5f77 6964 7468  idth, wire_width
+00027ce0: 292c 206c 6179 6572 3d6f 7665 726c 6170  ), layer=overlap
+00027cf0: 5f7a 6967 7a61 675f 6c61 7965 7229 0a20  _zigzag_layer). 
+00027d00: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00027d10: 2020 2020 2020 2020 206f 626a 2e63 6f6e           obj.con
+00027d20: 6e65 6374 2870 6f72 743d 2257 222c 2064  nect(port="W", d
+00027d30: 6573 7469 6e61 7469 6f6e 3d6f 6c64 5f70  estination=old_p
+00027d40: 6f72 7429 0a20 2020 2020 2020 2020 2020  ort).           
+00027d50: 2072 6967 6874 203d 2046 616c 7365 0a20   right = False. 
+00027d60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00027d70: 2020 2020 2020 2020 206f 626a 203d 2043           obj = C
+00027d80: 492e 6164 645f 7265 6628 0a20 2020 2020  I.add_ref(.     
+00027d90: 2020 2020 2020 2020 2020 2063 6f6d 7061             compa
+00027da0: 7373 2873 697a 653d 2877 6972 655f 7769  ss(size=(wire_wi
+00027db0: 6474 682c 2077 6972 655f 7769 6474 6829  dth, wire_width)
+00027dc0: 2c20 6c61 7965 723d 6f76 6572 6c61 705f  , layer=overlap_
+00027dd0: 7a69 677a 6167 5f6c 6179 6572 290a 2020  zigzag_layer).  
+00027de0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00027df0: 2020 2020 2020 2020 6f62 6a2e 636f 6e6e          obj.conn
+00027e00: 6563 7428 706f 7274 3d22 4522 2c20 6465  ect(port="E", de
+00027e10: 7374 696e 6174 696f 6e3d 6f6c 645f 706f  stination=old_po
+00027e20: 7274 290a 2020 2020 2020 2020 2020 2020  rt).            
+00027e30: 7269 6768 7420 3d20 5472 7565 0a20 2020  right = True.   
+00027e40: 2020 2020 206f 6c64 5f70 6f72 7420 3d20       old_port = 
+00027e50: 6f62 6a2e 706f 7274 735b 224e 225d 0a20  obj.ports["N"]. 
+00027e60: 2020 2020 2020 206f 626a 203d 2043 492e         obj = CI.
+00027e70: 6164 645f 7265 6628 0a20 2020 2020 2020  add_ref(.       
+00027e80: 2020 2020 2063 6f6d 7061 7373 280a 2020       compass(.  
+00027e90: 2020 2020 2020 2020 2020 2020 2020 7369                si
+00027ea0: 7a65 3d28 0a20 2020 2020 2020 2020 2020  ze=(.           
+00027eb0: 2020 2020 2020 2020 2064 6865 6164 2e78           dhead.x
+00027ec0: 6d69 6e20 2d20 2868 6561 642e 786d 6178  min - (head.xmax
+00027ed0: 202b 2068 6561 642e 786d 696e 202b 2077   + head.xmin + w
+00027ee0: 6972 655f 7769 6474 6829 202f 2032 2c0a  ire_width) / 2,.
+00027ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f00: 2020 2020 7769 7265 5f77 6964 7468 2c0a      wire_width,.
+00027f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f20: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00027f30: 2020 206c 6179 6572 3d6f 7665 726c 6170     layer=overlap
+00027f40: 5f7a 6967 7a61 675f 6c61 7965 722c 0a20  _zigzag_layer,. 
+00027f50: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00027f60: 2020 2020 2029 0a20 2020 2020 2020 206f       ).        o
+00027f70: 626a 2e63 6f6e 6e65 6374 2870 6f72 743d  bj.connect(port=
+00027f80: 2245 222c 2064 6573 7469 6e61 7469 6f6e  "E", destination
+00027f90: 3d6f 6c64 5f70 6f72 7429 0a20 2020 2020  =old_port).     
+00027fa0: 2020 206f 6c64 5f70 6f72 7420 3d20 6f62     old_port = ob
+00027fb0: 6a2e 706f 7274 735b 2257 225d 0a20 2020  j.ports["W"].   
+00027fc0: 2020 2020 206f 626a 203d 2043 492e 6164       obj = CI.ad
+00027fd0: 645f 7265 6628 0a20 2020 2020 2020 2020  d_ref(.         
+00027fe0: 2020 2063 6f6d 7061 7373 2873 697a 653d     compass(size=
+00027ff0: 2877 6972 655f 7769 6474 682c 2077 6972  (wire_width, wir
+00028000: 655f 7769 6474 6829 2c20 6c61 7965 723d  e_width), layer=
+00028010: 6f76 6572 6c61 705f 7a69 677a 6167 5f6c  overlap_zigzag_l
+00028020: 6179 6572 290a 2020 2020 2020 2020 290a  ayer).        ).
+00028030: 2020 2020 2020 2020 6f62 6a2e 636f 6e6e          obj.conn
+00028040: 6563 7428 706f 7274 3d22 5322 2c20 6465  ect(port="S", de
+00028050: 7374 696e 6174 696f 6e3d 6f6c 645f 706f  stination=old_po
+00028060: 7274 290a 2020 2020 2020 2020 6966 2072  rt).        if r
+00028070: 6967 6874 3a0a 2020 2020 2020 2020 2020  ight:.          
+00028080: 2020 6f6c 645f 706f 7274 203d 206f 626a    old_port = obj
+00028090: 2e70 6f72 7473 5b22 5722 5d0a 2020 2020  .ports["W"].    
+000280a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000280b0: 2020 2020 2020 6f6c 645f 706f 7274 203d        old_port =
+000280c0: 206f 626a 2e70 6f72 7473 5b22 4522 5d0a   obj.ports["E"].
+000280d0: 0a20 2020 2072 6574 7572 6e20 4349 0a0a  .    return CI..
+000280e0: 0a64 6566 205f 7465 7374 5f69 635f 7769  .def _test_ic_wi
+000280f0: 7265 5f73 7465 7028 7468 6963 6b5f 7769  re_step(thick_wi
+00028100: 6474 683d 3130 2c20 7468 696e 5f77 6964  dth=10, thin_wid
+00028110: 7468 3d31 2c20 7769 7265 5f6c 6179 6572  th=1, wire_layer
+00028120: 3d32 293a 0a20 2020 2022 2222 4865 6c70  =2):.    """Help
+00028130: 6572 2066 756e 6374 696f 6e20 7573 6564  er function used
+00028140: 2074 6f20 6d61 6b65 2074 6865 2049 4320   to make the IC 
+00028150: 7374 6570 2077 6972 6520 7374 7275 6374  step wire struct
+00028160: 7572 652e 2222 220a 2020 2020 5753 3420  ure.""".    WS4 
+00028170: 3d20 4465 7669 6365 2822 7465 7374 5f69  = Device("test_i
+00028180: 635f 7374 6570 2229 0a20 2020 2077 6972  c_step").    wir
+00028190: 655f 7374 6570 6120 3d20 5753 342e 6164  e_stepa = WS4.ad
+000281a0: 645f 7265 6628 0a20 2020 2020 2020 206f  d_ref(.        o
+000281b0: 7074 696d 616c 5f73 7465 7028 7468 6963  ptimal_step(thic
+000281c0: 6b5f 7769 6474 6820 2f20 322c 2074 6869  k_width / 2, thi
+000281d0: 6e5f 7769 6474 6820 2f20 322c 206c 6179  n_width / 2, lay
+000281e0: 6572 3d77 6972 655f 6c61 7965 7229 0a20  er=wire_layer). 
+000281f0: 2020 2029 0a20 2020 2077 6972 655f 7374     ).    wire_st
+00028200: 6570 6220 3d20 5753 342e 6164 645f 7265  epb = WS4.add_re
+00028210: 6628 0a20 2020 2020 2020 206f 7074 696d  f(.        optim
+00028220: 616c 5f73 7465 7028 7468 696e 5f77 6964  al_step(thin_wid
+00028230: 7468 202f 2032 2c20 7468 6963 6b5f 7769  th / 2, thick_wi
+00028240: 6474 6820 2f20 322c 206c 6179 6572 3d77  dth / 2, layer=w
+00028250: 6972 655f 6c61 7965 7229 0a20 2020 2029  ire_layer).    )
+00028260: 0a20 2020 2077 6972 655f 7374 6570 6320  .    wire_stepc 
+00028270: 3d20 5753 342e 6164 645f 7265 6628 0a20  = WS4.add_ref(. 
+00028280: 2020 2020 2020 206f 7074 696d 616c 5f73         optimal_s
+00028290: 7465 7028 7468 6963 6b5f 7769 6474 6820  tep(thick_width 
+000282a0: 2f20 322c 2074 6869 6e5f 7769 6474 6820  / 2, thin_width 
+000282b0: 2f20 322c 206c 6179 6572 3d77 6972 655f  / 2, layer=wire_
+000282c0: 6c61 7965 7229 0a20 2020 2029 0a20 2020  layer).    ).   
+000282d0: 2077 6972 655f 7374 6570 6420 3d20 5753   wire_stepd = WS
+000282e0: 342e 6164 645f 7265 6628 0a20 2020 2020  4.add_ref(.     
+000282f0: 2020 206f 7074 696d 616c 5f73 7465 7028     optimal_step(
+00028300: 7468 696e 5f77 6964 7468 202f 2032 2c20  thin_width / 2, 
+00028310: 7468 6963 6b5f 7769 6474 6820 2f20 322c  thick_width / 2,
+00028320: 206c 6179 6572 3d77 6972 655f 6c61 7965   layer=wire_laye
+00028330: 7229 0a20 2020 2029 0a20 2020 2077 6972  r).    ).    wir
+00028340: 655f 7374 6570 622e 726f 7461 7465 2831  e_stepb.rotate(1
+00028350: 3830 290a 2020 2020 7769 7265 5f73 7465  80).    wire_ste
+00028360: 7062 2e78 6d69 6e20 3d20 7769 7265 5f73  pb.xmin = wire_s
+00028370: 7465 7061 2e78 6d69 6e0a 2020 2020 7769  tepa.xmin.    wi
+00028380: 7265 5f73 7465 7063 2e72 6f74 6174 6528  re_stepc.rotate(
+00028390: 3138 3029 0a20 2020 2077 6972 655f 7374  180).    wire_st
+000283a0: 6570 632e 786d 696e 203d 2077 6972 655f  epc.xmin = wire_
+000283b0: 7374 6570 612e 786d 6178 0a20 2020 2077  stepa.xmax.    w
+000283c0: 6972 655f 7374 6570 642e 786d 696e 203d  ire_stepd.xmin =
+000283d0: 2077 6972 655f 7374 6570 632e 786d 696e   wire_stepc.xmin
+000283e0: 0a20 2020 2072 6574 7572 6e20 5753 340a  .    return WS4.
+000283f0: 0a0a 6465 6620 7465 7374 5f69 6328 0a20  ..def test_ic(. 
+00028400: 2020 2077 6972 655f 7769 6474 6873 3d5b     wire_widths=[
+00028410: 302e 3235 2c20 302e 352c 2031 2c20 322c  0.25, 0.5, 1, 2,
+00028420: 2034 5d2c 0a20 2020 2077 6972 655f 7769   4],.    wire_wi
+00028430: 6474 6873 5f77 6964 653d 5b30 2e37 352c  dths_wide=[0.75,
+00028440: 2031 2e35 2c20 332c 2034 2c20 365d 2c0a   1.5, 3, 4, 6],.
+00028450: 2020 2020 7061 645f 7369 7a65 3d28 3230      pad_size=(20
+00028460: 302c 2032 3030 292c 0a20 2020 2070 6164  0, 200),.    pad
+00028470: 5f67 6170 3d37 352c 0a20 2020 2077 6972  _gap=75,.    wir
+00028480: 655f 6c61 7965 723d 302c 0a20 2020 2070  e_layer=0,.    p
+00028490: 6164 5f6c 6179 6572 3d31 2c0a 2020 2020  ad_layer=1,.    
+000284a0: 676e 645f 6c61 7965 723d 312c 0a29 3a0a  gnd_layer=1,.):.
+000284b0: 2020 2020 2222 2243 7269 7469 6361 6c20      """Critical 
+000284c0: 6375 7272 656e 7420 7465 7374 2073 7472  current test str
+000284d0: 7563 7475 7265 2066 6f72 2073 7570 6572  ucture for super
+000284e0: 636f 6e64 7563 7469 6e67 2077 6972 6573  conducting wires
+000284f0: 2e0a 0a20 2020 2050 6172 616d 6574 6572  ...    Parameter
+00028500: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+00028510: 0a20 2020 2077 6972 655f 7769 6474 6873  .    wire_widths
+00028520: 203a 2061 7272 6179 2d6c 696b 655b 4e5d   : array-like[N]
+00028530: 0a20 2020 2020 2020 2054 6865 2077 6964  .        The wid
+00028540: 7468 7320 6f66 2074 6865 2074 6869 6e6e  ths of the thinn
+00028550: 6573 7420 7061 7274 7320 6f66 2074 6865  est parts of the
+00028560: 2074 6573 7420 7769 7265 732e 0a20 2020   test wires..   
+00028570: 2077 6972 655f 7769 6474 6873 5f77 6964   wire_widths_wid
+00028580: 6520 3a20 6172 7261 792d 6c69 6b65 5b4e  e : array-like[N
+00028590: 5d0a 2020 2020 2020 2020 5468 6520 7769  ].        The wi
+000285a0: 6474 6873 206f 6620 7468 6520 7468 6963  dths of the thic
+000285b0: 6b65 7374 2070 6172 7473 206f 6620 7468  kest parts of th
+000285c0: 6520 7465 7374 2077 6972 6573 2e0a 2020  e test wires..  
+000285d0: 2020 7061 645f 7369 7a65 203a 2061 7272    pad_size : arr
+000285e0: 6179 2d6c 696b 655b 325d 206f 6620 696e  ay-like[2] of in
+000285f0: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
+00028600: 2020 2028 7769 6474 682c 2068 6569 6768     (width, heigh
+00028610: 7429 206f 6620 7468 6520 7061 6473 2e0a  t) of the pads..
+00028620: 2020 2020 7061 645f 6761 7020 3a20 696e      pad_gap : in
+00028630: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
+00028640: 2020 2044 6973 7461 6e63 6520 6265 7477     Distance betw
+00028650: 6565 6e20 7468 6520 7061 6473 2061 6e64  een the pads and
+00028660: 2074 6865 2067 726f 756e 6420 706c 616e   the ground plan
+00028670: 652e 0a20 2020 2077 6972 655f 6c61 7965  e..    wire_laye
+00028680: 7220 3a20 696e 740a 2020 2020 2020 2020  r : int.        
+00028690: 5370 6563 6966 6963 206c 6179 6572 2873  Specific layer(s
+000286a0: 2920 746f 2070 7574 2074 6865 2077 6972  ) to put the wir
+000286b0: 6573 206f 6e2e 0a20 2020 2070 6164 5f6c  es on..    pad_l
+000286c0: 6179 6572 203a 2069 6e74 0a20 2020 2020  ayer : int.     
+000286d0: 2020 2053 7065 6369 6669 6320 6c61 7965     Specific laye
+000286e0: 7228 7329 2074 6f20 7075 7420 7468 6520  r(s) to put the 
+000286f0: 7061 6473 206f 6e2e 0a20 2020 2067 6e64  pads on..    gnd
+00028700: 5f6c 6179 6572 203a 2069 6e74 206f 7220  _layer : int or 
+00028710: 4e6f 6e65 0a20 2020 2020 2020 2053 7065  None.        Spe
+00028720: 6369 6669 6320 6c61 7965 7228 7329 2074  cific layer(s) t
+00028730: 6f20 7075 7420 7468 6520 6772 6f75 6e64  o put the ground
+00028740: 2070 6c61 6e65 206f 6e2e 0a0a 2020 2020   plane on...    
+00028750: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+00028760: 2d2d 2d0a 2020 2020 4465 7669 6365 0a20  ---.    Device. 
+00028770: 2020 2020 2020 2041 2044 6576 6963 6520         A Device 
+00028780: 636f 6e74 6169 6e69 6e67 2074 6865 2063  containing the c
+00028790: 7269 7469 6361 6c2d 6375 7272 656e 7420  ritical-current 
+000287a0: 7465 7374 2073 7472 7563 7475 7265 2e0a  test structure..
+000287b0: 2020 2020 2222 220a 2020 2020 4943 5320      """.    ICS 
+000287c0: 3d20 4465 7669 6365 2822 7465 7374 5f69  = Device("test_i
+000287d0: 6322 290a 0a20 2020 2023 2069 6620 676e  c")..    # if gn
+000287e0: 645f 6c61 7965 7220 6973 204e 6f6e 653a  d_layer is None:
+000287f0: 2067 6e64 5f6c 6179 6572 203d 2070 6164   gnd_layer = pad
+00028800: 5f6c 6179 6572 0a20 2020 2074 7261 6e73  _layer.    trans
+00028810: 6c61 7469 6f6e 203d 2030 0a20 2020 2070  lation = 0.    p
+00028820: 6164 6220 3d20 4943 532e 6164 645f 7265  adb = ICS.add_re
+00028830: 6628 0a20 2020 2020 2020 2072 6563 7461  f(.        recta
+00028840: 6e67 6c65 280a 2020 2020 2020 2020 2020  ngle(.          
+00028850: 2020 7369 7a65 3d28 6e70 2e73 697a 6528    size=(np.size(
+00028860: 7769 7265 5f77 6964 7468 7329 202a 2028  wire_widths) * (
+00028870: 7061 645f 7369 7a65 5b30 5d20 2a20 3620  pad_size[0] * 6 
+00028880: 2f20 3529 2c20 7061 645f 7369 7a65 5b31  / 5), pad_size[1
+00028890: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+000288a0: 6c61 7965 723d 7769 7265 5f6c 6179 6572  layer=wire_layer
+000288b0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+000288c0: 290a 0a20 2020 2070 6164 625f 6f76 6572  )..    padb_over
+000288d0: 6c61 7920 3d20 4943 532e 6164 645f 7265  lay = ICS.add_re
+000288e0: 6628 0a20 2020 2020 2020 2072 6563 7461  f(.        recta
+000288f0: 6e67 6c65 280a 2020 2020 2020 2020 2020  ngle(.          
+00028900: 2020 7369 7a65 3d28 0a20 2020 2020 2020    size=(.       
+00028910: 2020 2020 2020 2020 2028 6e70 2e73 697a           (np.siz
+00028920: 6528 7769 7265 5f77 6964 7468 7329 202a  e(wire_widths) *
+00028930: 2028 7061 645f 7369 7a65 5b30 5d20 2a20   (pad_size[0] * 
+00028940: 3620 2f20 3529 2920 2a20 3920 2f20 3130  6 / 5)) * 9 / 10
+00028950: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00028960: 2020 7061 645f 7369 7a65 5b31 5d20 2a20    pad_size[1] * 
+00028970: 3920 2f20 3130 2c0a 2020 2020 2020 2020  9 / 10,.        
+00028980: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+00028990: 2020 206c 6179 6572 3d67 6e64 5f6c 6179     layer=gnd_lay
+000289a0: 6572 2c0a 2020 2020 2020 2020 290a 2020  er,.        ).  
+000289b0: 2020 290a 2020 2020 7061 6462 5f6f 7665    ).    padb_ove
+000289c0: 726c 6179 2e63 656e 7465 7220 3d20 7061  rlay.center = pa
+000289d0: 6462 2e63 656e 7465 720a 2020 2020 7061  db.center.    pa
+000289e0: 6462 5f6f 7665 726c 6179 2e79 6d69 6e20  db_overlay.ymin 
+000289f0: 3d20 7061 6462 2e79 6d69 6e0a 2020 2020  = padb.ymin.    
+00028a00: 666f 7220 692c 2078 2069 6e20 656e 756d  for i, x in enum
+00028a10: 6572 6174 6528 7769 7265 5f77 6964 7468  erate(wire_width
+00028a20: 735f 7769 6465 293a 0a20 2020 2020 2020  s_wide):.       
+00028a30: 2070 6164 7420 3d20 4943 532e 6164 645f   padt = ICS.add_
+00028a40: 7265 6628 7265 6374 616e 676c 6528 7061  ref(rectangle(pa
+00028a50: 645f 7369 7a65 2c20 7769 7265 5f6c 6179  d_size, wire_lay
+00028a60: 6572 2929 0a20 2020 2020 2020 2070 6164  er)).        pad
+00028a70: 742e 786d 696e 203d 2070 6164 622e 786d  t.xmin = padb.xm
+00028a80: 696e 202b 2074 7261 6e73 6c61 7469 6f6e  in + translation
+00028a90: 0a20 2020 2020 2020 2070 6164 742e 796d  .        padt.ym
+00028aa0: 696e 203d 2070 6164 622e 796d 6178 202b  in = padb.ymax +
+00028ab0: 2070 6164 5f67 6170 0a20 2020 2020 2020   pad_gap.       
+00028ac0: 2070 6164 745f 6f76 6572 6c61 7920 3d20   padt_overlay = 
+00028ad0: 4943 532e 6164 645f 7265 6628 0a20 2020  ICS.add_ref(.   
+00028ae0: 2020 2020 2020 2020 2072 6563 7461 6e67           rectang
+00028af0: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
+00028b00: 2020 2020 7369 7a65 3d28 7061 645f 7369      size=(pad_si
+00028b10: 7a65 5b30 5d20 2a20 3920 2f20 3130 2c20  ze[0] * 9 / 10, 
+00028b20: 7061 645f 7369 7a65 5b31 5d20 2a20 3920  pad_size[1] * 9 
+00028b30: 2f20 3130 292c 206c 6179 6572 3d70 6164  / 10), layer=pad
+00028b40: 5f6c 6179 6572 0a20 2020 2020 2020 2020  _layer.         
+00028b50: 2020 2029 0a20 2020 2020 2020 2029 0a20     ).        ). 
+00028b60: 2020 2020 2020 2070 6164 745f 6f76 6572         padt_over
+00028b70: 6c61 792e 6365 6e74 6572 203d 2070 6164  lay.center = pad
+00028b80: 742e 6365 6e74 6572 0a20 2020 2020 2020  t.center.       
+00028b90: 2070 6164 745f 6f76 6572 6c61 792e 796d   padt_overlay.ym
+00028ba0: 6178 203d 2070 6164 742e 796d 6178 0a20  ax = padt.ymax. 
+00028bb0: 2020 2020 2020 2064 6966 6665 7265 6e63         differenc
+00028bc0: 6520 3d20 7061 6474 2e79 6d69 6e20 2d20  e = padt.ymin - 
+00028bd0: 7061 6462 2e79 6d61 780a 2020 2020 2020  padb.ymax.      
+00028be0: 2020 7769 7265 5f73 7465 7020 3d20 4943    wire_step = IC
+00028bf0: 532e 6164 645f 7265 6628 0a20 2020 2020  S.add_ref(.     
+00028c00: 2020 2020 2020 205f 7465 7374 5f69 635f         _test_ic_
+00028c10: 7769 7265 5f73 7465 7028 0a20 2020 2020  wire_step(.     
+00028c20: 2020 2020 2020 2020 2020 2077 6972 655f             wire_
+00028c30: 7769 6474 6873 5f77 6964 655b 695d 2c20  widths_wide[i], 
+00028c40: 7769 7265 5f77 6964 7468 735b 695d 2c20  wire_widths[i], 
+00028c50: 7769 7265 5f6c 6179 6572 3d77 6972 655f  wire_layer=wire_
+00028c60: 6c61 7965 720a 2020 2020 2020 2020 2020  layer.          
+00028c70: 2020 290a 2020 2020 2020 2020 290a 2020    ).        ).  
+00028c80: 2020 2020 2020 7769 7265 5f73 7465 702e        wire_step.
+00028c90: 726f 7461 7465 2839 3029 0a20 2020 2020  rotate(90).     
+00028ca0: 2020 2077 6972 655f 7374 6570 2e63 656e     wire_step.cen
+00028cb0: 7465 7220 3d20 2870 6164 742e 6365 6e74  ter = (padt.cent
+00028cc0: 6572 5b30 5d2c 2070 6164 622e 796d 6178  er[0], padb.ymax
+00028cd0: 202b 2064 6966 6665 7265 6e63 6520 2f20   + difference / 
+00028ce0: 3229 0a20 2020 2020 2020 2074 7261 6e73  2).        trans
+00028cf0: 6c61 7469 6f6e 203d 2074 7261 6e73 6c61  lation = transla
+00028d00: 7469 6f6e 202b 2070 6164 5f73 697a 655b  tion + pad_size[
+00028d10: 305d 202a 2031 3220 2f20 3130 0a20 2020  0] * 12 / 10.   
+00028d20: 2020 2020 2063 6f6e 6e5f 7769 7265 5f74       conn_wire_t
+00028d30: 6f70 203d 2049 4353 2e61 6464 5f72 6566  op = ICS.add_ref
+00028d40: 280a 2020 2020 2020 2020 2020 2020 7265  (.            re
+00028d50: 6374 616e 676c 6528 0a20 2020 2020 2020  ctangle(.       
+00028d60: 2020 2020 2020 2020 2073 697a 653d 2877           size=(w
+00028d70: 6972 655f 7769 6474 6873 5f77 6964 655b  ire_widths_wide[
+00028d80: 695d 2c20 7061 6474 2e79 6d69 6e20 2d20  i], padt.ymin - 
+00028d90: 7769 7265 5f73 7465 702e 796d 6178 292c  wire_step.ymax),
+00028da0: 206c 6179 6572 3d77 6972 655f 6c61 7965   layer=wire_laye
+00028db0: 720a 2020 2020 2020 2020 2020 2020 290a  r.            ).
+00028dc0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00028dd0: 2020 636f 6e6e 5f77 6972 655f 626f 7474    conn_wire_bott
+00028de0: 6f6d 203d 2049 4353 2e61 6464 5f72 6566  om = ICS.add_ref
+00028df0: 280a 2020 2020 2020 2020 2020 2020 7265  (.            re
+00028e00: 6374 616e 676c 6528 0a20 2020 2020 2020  ctangle(.       
+00028e10: 2020 2020 2020 2020 2073 697a 653d 2877           size=(w
+00028e20: 6972 655f 7769 6474 6873 5f77 6964 655b  ire_widths_wide[
+00028e30: 695d 2c20 7769 7265 5f73 7465 702e 796d  i], wire_step.ym
+00028e40: 696e 202d 2070 6164 622e 796d 6178 292c  in - padb.ymax),
+00028e50: 206c 6179 6572 3d77 6972 655f 6c61 7965   layer=wire_laye
+00028e60: 720a 2020 2020 2020 2020 2020 2020 290a  r.            ).
+00028e70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00028e80: 2020 636f 6e6e 5f77 6972 655f 746f 702e    conn_wire_top.
+00028e90: 796d 6178 203d 2070 6164 742e 796d 696e  ymax = padt.ymin
+00028ea0: 0a20 2020 2020 2020 2063 6f6e 6e5f 7769  .        conn_wi
+00028eb0: 7265 5f74 6f70 2e78 6d69 6e20 3d20 7769  re_top.xmin = wi
+00028ec0: 7265 5f73 7465 702e 786d 696e 0a20 2020  re_step.xmin.   
+00028ed0: 2020 2020 2063 6f6e 6e5f 7769 7265 5f62       conn_wire_b
+00028ee0: 6f74 746f 6d2e 796d 696e 203d 2070 6164  ottom.ymin = pad
+00028ef0: 622e 796d 6178 0a20 2020 2020 2020 2063  b.ymax.        c
+00028f00: 6f6e 6e5f 7769 7265 5f62 6f74 746f 6d2e  onn_wire_bottom.
+00028f10: 786d 696e 203d 2077 6972 655f 7374 6570  xmin = wire_step
+00028f20: 2e78 6d69 6e0a 0a20 2020 2072 6574 7572  .xmin..    retur
+00028f30: 6e20 4943 530a 0a0a 6465 6620 7465 7374  n ICS...def test
+00028f40: 5f72 6573 280a 2020 2020 7061 645f 7369  _res(.    pad_si
+00028f50: 7a65 3d5b 3530 2c20 3530 5d2c 206e 756d  ze=[50, 50], num
+00028f60: 5f73 7175 6172 6573 3d31 3030 302c 2077  _squares=1000, w
+00028f70: 6964 7468 3d31 2c20 7265 735f 6c61 7965  idth=1, res_laye
+00028f80: 723d 302c 2070 6164 5f6c 6179 6572 3d31  r=0, pad_layer=1
+00028f90: 2c20 676e 645f 6c61 7965 723d 320a 293a  , gnd_layer=2.):
+00028fa0: 0a20 2020 2022 2222 4372 6561 7465 7320  .    """Creates 
+00028fb0: 616e 2065 6666 6963 6965 6e74 2072 6573  an efficient res
+00028fc0: 6f6e 6174 6f72 2073 7472 7563 7475 7265  onator structure
+00028fd0: 2066 6f72 2061 2077 6166 6572 206c 6179   for a wafer lay
+00028fe0: 6f75 742e 0a0a 2020 2020 5061 7261 6d65  out...    Parame
+00028ff0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+00029000: 2d2d 2d0a 2020 2020 7061 645f 7369 7a65  ---.    pad_size
+00029010: 203a 2061 7272 6179 2d6c 696b 655b 325d   : array-like[2]
+00029020: 206f 6620 696e 7420 6f72 2066 6c6f 6174   of int or float
+00029030: 0a20 2020 2020 2020 2028 7769 6474 682c  .        (width,
+00029040: 2068 6569 6768 7429 206f 6620 7468 6520   height) of the 
+00029050: 7477 6f20 6d61 7463 6865 6420 696d 7065  two matched impe
+00029060: 6461 6e63 6520 7061 6473 2069 6e20 6d69  dance pads in mi
+00029070: 6372 6f6e 732e 0a20 2020 206e 756d 5f73  crons..    num_s
+00029080: 7175 6172 6573 203a 2069 6e74 206f 7220  quares : int or 
+00029090: 666c 6f61 740a 2020 2020 2020 2020 4e75  float.        Nu
+000290a0: 6d62 6572 206f 6620 7371 7561 7265 7320  mber of squares 
+000290b0: 636f 6d70 7269 7369 6e67 2074 6865 2072  comprising the r
+000290c0: 6573 6f6e 6174 6f72 2077 6972 652e 0a20  esonator wire.. 
+000290d0: 2020 2077 6964 7468 203a 2069 6e74 206f     width : int o
+000290e0: 7220 666c 6f61 740a 2020 2020 2020 2020  r float.        
+000290f0: 5468 6520 7769 6474 6820 6f66 2074 6865  The width of the
+00029100: 2073 7175 6172 6573 2069 6e20 6d69 6372   squares in micr
+00029110: 6f6e 732e 0a20 2020 2072 6573 5f6c 6179  ons..    res_lay
+00029120: 6572 203a 2069 6e74 0a20 2020 2020 2020  er : int.       
+00029130: 2053 7065 6369 6669 6320 6c61 7965 7228   Specific layer(
+00029140: 7329 2074 6f20 7075 7420 7468 6520 7265  s) to put the re
+00029150: 736f 6e61 746f 7220 7374 7275 6374 7572  sonator structur
+00029160: 6520 6f6e 2e0a 2020 2020 7061 645f 6c61  e on..    pad_la
+00029170: 7965 7220 3a20 696e 7420 6f72 204e 6f6e  yer : int or Non
+00029180: 650a 2020 2020 2020 2020 5370 6563 6966  e.        Specif
+00029190: 6963 206c 6179 6572 2873 2920 746f 2070  ic layer(s) to p
+000291a0: 7574 2074 6865 2070 6164 7320 6f6e 2e0a  ut the pads on..
+000291b0: 2020 2020 676e 645f 6c61 7965 7220 3a20      gnd_layer : 
+000291c0: 2069 6e74 206f 7220 4e6f 6e65 0a20 2020   int or None.   
+000291d0: 2020 2020 2053 7065 6369 6669 6320 6c61       Specific la
+000291e0: 7965 7228 7329 2074 6f20 7075 7420 7468  yer(s) to put th
+000291f0: 6520 6772 6f75 6e64 2070 6c61 6e65 206f  e ground plane o
+00029200: 6e2e 0a0a 2020 2020 5265 7475 726e 730a  n...    Returns.
+00029210: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+00029220: 5020 3a20 4465 7669 6365 0a20 2020 2020  P : Device.     
+00029230: 2020 2041 2044 6576 6963 6520 636f 6e74     A Device cont
+00029240: 6169 6e69 6e67 2061 6e20 6566 6669 6369  aining an effici
+00029250: 656e 7420 7265 736f 6e61 746f 7220 7374  ent resonator st
+00029260: 7275 6374 7572 652e 0a20 2020 2022 2222  ructure..    """
+00029270: 0a20 2020 2078 203d 2070 6164 5f73 697a  .    x = pad_siz
+00029280: 655b 305d 0a20 2020 207a 203d 2070 6164  e[0].    z = pad
+00029290: 5f73 697a 655b 315d 0a0a 2020 2020 2320  _size[1]..    # 
+000292a0: 4368 6563 6b69 6e67 2076 616c 6964 6974  Checking validit
+000292b0: 7920 6f66 2069 6e70 7574 0a20 2020 2069  y of input.    i
+000292c0: 6620 7820 3c3d 2030 206f 7220 7a20 3c3d  f x <= 0 or z <=
+000292d0: 2030 3a0a 2020 2020 2020 2020 7261 6973   0:.        rais
+000292e0: 6520 5661 6c75 6545 7272 6f72 2822 5061  e ValueError("Pa
+000292f0: 6420 6d75 7374 2068 6176 6520 706f 7369  d must have posi
+00029300: 7469 7665 2c20 7265 616c 2064 696d 656e  tive, real dimen
+00029310: 7369 6f6e 7322 290a 2020 2020 656c 6966  sions").    elif
+00029320: 2077 6964 7468 203e 207a 3a0a 2020 2020   width > z:.    
+00029330: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00029340: 7272 6f72 2822 5769 6474 6820 6f66 2063  rror("Width of c
+00029350: 656c 6c20 6361 6e6e 6f74 2062 6520 6772  ell cannot be gr
+00029360: 6561 7465 7220 7468 616e 2068 6569 6768  eater than heigh
+00029370: 7420 6f66 2070 6164 2229 0a20 2020 2065  t of pad").    e
+00029380: 6c69 6620 6e75 6d5f 7371 7561 7265 7320  lif num_squares 
+00029390: 3c3d 2030 3a0a 2020 2020 2020 2020 7261  <= 0:.        ra
+000293a0: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
+000293b0: 4e75 6d62 6572 206f 6620 7371 7561 7265  Number of square
+000293c0: 7320 6d75 7374 2062 6520 6120 706f 7369  s must be a posi
+000293d0: 7469 7665 2072 6561 6c20 6e75 6d62 6572  tive real number
+000293e0: 2229 0a20 2020 2065 6c69 6620 7769 6474  ").    elif widt
+000293f0: 6820 3c3d 2030 3a0a 2020 2020 2020 2020  h <= 0:.        
+00029400: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00029410: 2822 5769 6474 6820 6f66 2063 656c 6c20  ("Width of cell 
+00029420: 6d75 7374 2062 6520 6120 706f 7369 7469  must be a positi
+00029430: 7665 2072 6561 6c20 6e75 6d62 6572 2229  ve real number")
+00029440: 0a0a 2020 2020 2320 5065 7266 6f72 6d69  ..    # Performi
+00029450: 6e67 2070 7265 6c69 6d69 6e61 7279 2063  ng preliminary c
+00029460: 616c 6375 6c61 7469 6f6e 730a 2020 2020  alculations.    
+00029470: 6e75 6d5f 726f 7773 203d 2069 6e74 286e  num_rows = int(n
+00029480: 702e 666c 6f6f 7228 7a20 2f20 2832 202a  p.floor(z / (2 *
+00029490: 2077 6964 7468 2929 290a 2020 2020 6966   width))).    if
+000294a0: 206e 756d 5f72 6f77 7320 2520 3220 3d3d   num_rows % 2 ==
+000294b0: 2030 3a0a 2020 2020 2020 2020 6e75 6d5f   0:.        num_
+000294c0: 726f 7773 202d 3d20 310a 2020 2020 6e75  rows -= 1.    nu
+000294d0: 6d5f 636f 6c75 6d6e 7320 3d20 6e75 6d5f  m_columns = num_
+000294e0: 726f 7773 202d 2031 0a20 2020 2073 7175  rows - 1.    squ
+000294f0: 6172 6573 5f69 6e5f 726f 7720 3d20 286e  ares_in_row = (n
+00029500: 756d 5f73 7175 6172 6573 202d 206e 756d  um_squares - num
+00029510: 5f63 6f6c 756d 6e73 202d 2032 2920 2f20  _columns - 2) / 
+00029520: 6e75 6d5f 726f 7773 0a0a 2020 2020 2320  num_rows..    # 
+00029530: 436f 6d70 656e 7361 7469 6e67 2066 6f72  Compensating for
+00029540: 2077 6569 7264 2065 6467 6520 6361 7365   weird edge case
+00029550: 730a 2020 2020 6966 2073 7175 6172 6573  s.    if squares
+00029560: 5f69 6e5f 726f 7720 3c20 313a 0a20 2020  _in_row < 1:.   
+00029570: 2020 2020 206e 756d 5f72 6f77 7320 3d20       num_rows = 
+00029580: 696e 7428 726f 756e 6428 6e75 6d5f 726f  int(round(num_ro
+00029590: 7773 202f 2032 2920 2d20 3229 0a20 2020  ws / 2) - 2).   
+000295a0: 2020 2020 2073 7175 6172 6573 5f69 6e5f       squares_in_
+000295b0: 726f 7720 3d20 310a 2020 2020 6966 2077  row = 1.    if w
+000295c0: 6964 7468 202a 2032 203e 207a 3a0a 2020  idth * 2 > z:.  
+000295d0: 2020 2020 2020 6e75 6d5f 726f 7773 203d        num_rows =
+000295e0: 2031 0a20 2020 2020 2020 2073 7175 6172   1.        squar
+000295f0: 6573 5f69 6e5f 726f 7720 3d20 6e75 6d5f  es_in_row = num_
+00029600: 7371 7561 7265 7320 2d20 320a 0a20 2020  squares - 2..   
+00029610: 206c 656e 6774 685f 726f 7720 3d20 7371   length_row = sq
+00029620: 7561 7265 735f 696e 5f72 6f77 202a 2077  uares_in_row * w
+00029630: 6964 7468 0a0a 2020 2020 2320 4372 6561  idth..    # Crea
+00029640: 7469 6e67 2072 6f77 2f63 6f6c 756d 6e20  ting row/column 
+00029650: 636f 726e 6572 2063 6f6d 6269 6e61 7469  corner combinati
+00029660: 6f6e 2073 7472 7563 7475 7265 0a20 2020  on structure.   
+00029670: 2054 203d 2044 6576 6963 6528 290a 2020   T = Device().  
+00029680: 2020 526f 7720 3d20 7265 6374 616e 676c    Row = rectangl
+00029690: 6528 7369 7a65 3d28 6c65 6e67 7468 5f72  e(size=(length_r
+000296a0: 6f77 2c20 7769 6474 6829 2c20 6c61 7965  ow, width), laye
+000296b0: 723d 7265 735f 6c61 7965 7229 0a20 2020  r=res_layer).   
+000296c0: 2043 6f6c 203d 2072 6563 7461 6e67 6c65   Col = rectangle
+000296d0: 2873 697a 653d 2877 6964 7468 2c20 7769  (size=(width, wi
+000296e0: 6474 6829 2c20 6c61 7965 723d 7265 735f  dth), layer=res_
+000296f0: 6c61 7965 7229 0a0a 2020 2020 542e 6164  layer)..    T.ad
+00029700: 645f 7265 6628 526f 7729 0a20 2020 2063  d_ref(Row).    c
+00029710: 6f6c 203d 2054 2e61 6464 5f72 6566 2843  ol = T.add_ref(C
+00029720: 6f6c 290a 2020 2020 636f 6c2e 6d6f 7665  ol).    col.move
+00029730: 285b 6c65 6e67 7468 5f72 6f77 202d 2077  ([length_row - w
+00029740: 6964 7468 2c20 2d77 6964 7468 5d29 0a0a  idth, -width])..
+00029750: 2020 2020 2320 4372 6561 7469 6e67 2065      # Creating e
+00029760: 6e74 6972 6520 7761 7665 6775 6964 6520  ntire waveguide 
+00029770: 6e65 740a 2020 2020 4e20 3d20 4465 7669  net.    N = Devi
+00029780: 6365 2822 6e65 7422 290a 2020 2020 6e20  ce("net").    n 
+00029790: 3d20 310a 2020 2020 666f 7220 6920 696e  = 1.    for i in
+000297a0: 2072 616e 6765 286e 756d 5f72 6f77 7329   range(num_rows)
+000297b0: 3a0a 2020 2020 2020 2020 6966 2069 2021  :.        if i !
+000297c0: 3d20 6e75 6d5f 726f 7773 202d 2031 3a0a  = num_rows - 1:.
+000297d0: 2020 2020 2020 2020 2020 2020 6420 3d20              d = 
+000297e0: 4e2e 6164 645f 7265 6628 5429 0a20 2020  N.add_ref(T).   
+000297f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00029800: 2020 2020 2020 2064 203d 204e 2e61 6464         d = N.add
+00029810: 5f72 6566 2852 6f77 290a 2020 2020 2020  _ref(Row).      
+00029820: 2020 6966 206e 2025 2032 203d 3d20 303a    if n % 2 == 0:
+00029830: 0a20 2020 2020 2020 2020 2020 2064 2e6d  .            d.m
+00029840: 6972 726f 7228 7031 3d28 642e 782c 2064  irror(p1=(d.x, d
+00029850: 2e79 6d61 7829 2c20 7032 3d28 642e 782c  .ymax), p2=(d.x,
+00029860: 2064 2e79 6d69 6e29 290a 2020 2020 2020   d.ymin)).      
+00029870: 2020 642e 6d6f 7665 7928 2d28 6e20 2d20    d.movey(-(n - 
+00029880: 3129 202a 2054 2e79 7369 7a65 290a 2020  1) * T.ysize).  
+00029890: 2020 2020 2020 6e20 2b3d 2031 0a20 2020        n += 1.   
+000298a0: 2064 203d 204e 2e61 6464 5f72 6566 2843   d = N.add_ref(C
+000298b0: 6f6c 292e 6d6f 7665 7828 2d77 6964 7468  ol).movex(-width
+000298c0: 290a 2020 2020 6420 3d20 4e2e 6164 645f  ).    d = N.add_
+000298d0: 7265 6628 436f 6c29 2e6d 6f76 6528 5b6c  ref(Col).move([l
+000298e0: 656e 6774 685f 726f 772c 202d 286e 202d  ength_row, -(n -
+000298f0: 2032 2920 2a20 542e 7973 697a 655d 290a   2) * T.ysize]).
+00029900: 0a20 2020 2023 2043 7265 6174 696e 6720  .    # Creating 
+00029910: 7061 6473 0a20 2020 2050 203d 2044 6576  pads.    P = Dev
+00029920: 6963 6528 2274 6573 745f 7265 7322 290a  ice("test_res").
+00029930: 2020 2020 5061 6431 203d 2072 6563 7461      Pad1 = recta
+00029940: 6e67 6c65 2873 697a 653d 2878 2c20 7a29  ngle(size=(x, z)
+00029950: 2c20 6c61 7965 723d 7061 645f 6c61 7965  , layer=pad_laye
+00029960: 7229 0a20 2020 2050 6164 3220 3d20 7265  r).    Pad2 = re
+00029970: 6374 616e 676c 6528 7369 7a65 3d28 7820  ctangle(size=(x 
+00029980: 2b20 352c 207a 292c 206c 6179 6572 3d70  + 5, z), layer=p
+00029990: 6164 5f6c 6179 6572 290a 2020 2020 476e  ad_layer).    Gn
+000299a0: 6431 203d 206f 6666 7365 7428 5061 6431  d1 = offset(Pad1
+000299b0: 2c20 6469 7374 616e 6365 3d2d 352c 206c  , distance=-5, l
+000299c0: 6179 6572 3d67 6e64 5f6c 6179 6572 290a  ayer=gnd_layer).
+000299d0: 2020 2020 476e 6432 203d 206f 6666 7365      Gnd2 = offse
+000299e0: 7428 5061 6432 2c20 6469 7374 616e 6365  t(Pad2, distance
+000299f0: 3d2d 352c 206c 6179 6572 3d67 6e64 5f6c  =-5, layer=gnd_l
+00029a00: 6179 6572 290a 2020 2020 7061 6431 203d  ayer).    pad1 =
+00029a10: 2050 2e61 6464 5f72 6566 2850 6164 3129   P.add_ref(Pad1)
+00029a20: 2e6d 6f76 6578 282d 7820 2d20 7769 6474  .movex(-x - widt
+00029a30: 6829 0a20 2020 2070 6164 3220 3d20 502e  h).    pad2 = P.
+00029a40: 6164 645f 7265 6628 5061 6431 292e 6d6f  add_ref(Pad1).mo
+00029a50: 7665 7828 6c65 6e67 7468 5f72 6f77 202b  vex(length_row +
+00029a60: 2077 6964 7468 290a 2020 2020 502e 6164   width).    P.ad
+00029a70: 645f 7265 6628 476e 6431 292e 6365 6e74  d_ref(Gnd1).cent
+00029a80: 6572 203d 2070 6164 312e 6365 6e74 6572  er = pad1.center
+00029a90: 2020 2320 676e 6431 0a20 2020 2067 6e64    # gnd1.    gnd
+00029aa0: 3220 3d20 502e 6164 645f 7265 6628 476e  2 = P.add_ref(Gn
+00029ab0: 6432 290a 2020 2020 502e 6164 645f 7265  d2).    P.add_re
+00029ac0: 6628 4e29 2e79 203d 2070 6164 312e 7920  f(N).y = pad1.y 
+00029ad0: 2023 206e 6574 730a 2020 2020 676e 6432   # nets.    gnd2
+00029ae0: 2e63 656e 7465 7220 3d20 7061 6432 2e63  .center = pad2.c
+00029af0: 656e 7465 720a 2020 2020 676e 6432 2e6d  enter.    gnd2.m
+00029b00: 6f76 6578 2832 2e35 290a 0a20 2020 2072  ovex(2.5)..    r
+00029b10: 6574 7572 6e20 500a 0a0a 2320 3d3d 3d3d  eturn P...# ====
+00029b20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029b30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029b40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029b50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029b60: 3d3d 3d3d 3d3d 3d3d 3d3d 0a23 0a23 204f  ==========.#.# O
+00029b70: 7074 696d 616c 2063 7572 7265 6e74 2d63  ptimal current-c
+00029b80: 726f 7764 696e 6720 7375 7065 7263 6f6e  rowding supercon
+00029b90: 6475 6374 696e 6720 7374 7275 6374 7572  ducting structur
+00029ba0: 6573 0a23 0a23 203d 3d3d 3d3d 3d3d 3d3d  es.#.# =========
+00029bb0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029bc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029bd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029be0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029bf0: 3d3d 3d3d 3d0a 0a0a 4064 6576 6963 655f  =====...@device_
+00029c00: 6c72 755f 6361 6368 650a 6465 6620 6f70  lru_cache.def op
+00029c10: 7469 6d61 6c5f 6861 6972 7069 6e28 7769  timal_hairpin(wi
+00029c20: 6474 683d 302e 322c 2070 6974 6368 3d30  dth=0.2, pitch=0
+00029c30: 2e36 2c20 6c65 6e67 7468 3d31 302c 2074  .6, length=10, t
+00029c40: 7572 6e5f 7261 7469 6f3d 342c 206e 756d  urn_ratio=4, num
+00029c50: 5f70 7473 3d35 302c 206c 6179 6572 3d30  _pts=50, layer=0
+00029c60: 293a 0a20 2020 2022 2222 4372 6561 7465  ):.    """Create
+00029c70: 7320 616e 206f 7074 696d 616c 6c79 2d72  s an optimally-r
+00029c80: 6f75 6e64 6564 2068 6169 7270 696e 2067  ounded hairpin g
+00029c90: 656f 6d65 7472 792c 2077 6974 6820 6120  eometry, with a 
+00029ca0: 3138 3020 6465 6772 6565 2074 7572 6e0a  180 degree turn.
+00029cb0: 2020 2020 6f6e 2074 6865 2072 6967 6874      on the right
+00029cc0: 2065 6e64 206f 6620 7468 6520 706f 6c79   end of the poly
+00029cd0: 676f 6e20 636f 6e6e 6563 7465 6420 746f  gon connected to
+00029ce0: 2074 776f 2070 726f 6e67 7320 6578 7465   two prongs exte
+00029cf0: 6e64 696e 6720 746f 7761 7264 730a 2020  nding towards.  
+00029d00: 2020 706f 7274 7320 6f6e 2074 6865 206c    ports on the l
+00029d10: 6566 7420 656e 642e 0a0a 2020 2020 5061  eft end...    Pa
+00029d20: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00029d30: 2d2d 2d2d 2d2d 2d0a 2020 2020 7769 6474  -------.    widt
+00029d40: 6820 3a20 696e 7420 6f72 2066 6c6f 6174  h : int or float
+00029d50: 0a20 2020 2020 2020 2057 6964 7468 206f  .        Width o
+00029d60: 6620 7468 6520 6861 6972 7069 6e20 6c65  f the hairpin le
+00029d70: 6164 732e 0a20 2020 2070 6974 6368 203a  ads..    pitch :
+00029d80: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
+00029d90: 2020 2020 2020 4469 7374 616e 6365 2062        Distance b
+00029da0: 6574 7765 656e 2074 6865 2074 776f 2068  etween the two h
+00029db0: 6169 7270 696e 206c 6561 6473 2e20 4d75  airpin leads. Mu
+00029dc0: 7374 2062 6520 6772 6561 7465 7220 7468  st be greater th
+00029dd0: 616e 2077 6964 7468 2e0a 2020 2020 6c65  an width..    le
+00029de0: 6e67 7468 203a 2069 6e74 206f 7220 666c  ngth : int or fl
+00029df0: 6f61 740a 2020 2020 2020 2020 4c65 6e67  oat.        Leng
+00029e00: 7468 206f 6620 7468 6520 6861 6972 7069  th of the hairpi
+00029e10: 6e20 6672 6f6d 2074 6865 2063 6f6e 6e65  n from the conne
+00029e20: 6374 6f72 7320 746f 2074 6865 206f 7070  ctors to the opp
+00029e30: 6f73 6974 6520 656e 6420 6f66 2074 6865  osite end of the
+00029e40: 0a20 2020 2020 2020 2063 7572 7665 2e0a  .        curve..
+00029e50: 2020 2020 7475 726e 5f72 6174 696f 203a      turn_ratio :
+00029e60: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
+00029e70: 2020 2020 2020 5370 6563 6966 6965 7320        Specifies 
+00029e80: 686f 7720 6d75 6368 206f 6620 7468 6520  how much of the 
+00029e90: 6861 6972 7069 6e20 6973 2064 6564 6963  hairpin is dedic
+00029ea0: 6174 6564 2074 6f20 7468 6520 3138 3020  ated to the 180 
+00029eb0: 6465 6772 6565 2074 7572 6e2e 0a20 2020  degree turn..   
+00029ec0: 2020 2020 2041 2074 7572 6e5f 7261 7469       A turn_rati
+00029ed0: 6f20 6f66 2031 3020 7769 6c6c 2072 6573  o of 10 will res
+00029ee0: 756c 7420 696e 2032 3025 206f 6620 7468  ult in 20% of th
+00029ef0: 6520 6861 6972 7069 6e20 6265 696e 6720  e hairpin being 
+00029f00: 636f 6d70 7269 7365 6420 6f66 2074 6865  comprised of the
+00029f10: 2074 7572 6e2e 0a20 2020 206e 756d 5f70   turn..    num_p
+00029f20: 7473 203a 2069 6e74 0a20 2020 2020 2020  ts : int.       
+00029f30: 204e 756d 6265 7220 6f66 2070 6f69 6e74   Number of point
+00029f40: 7320 636f 6e73 7469 7475 7469 6e67 2074  s constituting t
+00029f50: 6865 2031 3830 2064 6567 7265 6520 7475  he 180 degree tu
+00029f60: 726e 2e0a 2020 2020 6c61 7965 7220 3a20  rn..    layer : 
+00029f70: 696e 742c 2061 7272 6179 2d6c 696b 655b  int, array-like[
+00029f80: 325d 2c20 6f72 2073 6574 0a20 2020 2020  2], or set.     
+00029f90: 2020 2053 7065 6369 6669 6320 6c61 7965     Specific laye
+00029fa0: 7228 7329 2074 6f20 7075 7420 706f 6c79  r(s) to put poly
+00029fb0: 676f 6e20 6765 6f6d 6574 7279 206f 6e2e  gon geometry on.
+00029fc0: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+00029fd0: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 4420    -------.    D 
+00029fe0: 3a20 4465 7669 6365 0a20 2020 2020 2020  : Device.       
+00029ff0: 2041 2044 6576 6963 6520 636f 6e74 6169   A Device contai
+0002a000: 6e69 6e67 2061 6e20 6f70 7469 6d61 6c6c  ning an optimall
+0002a010: 792d 726f 756e 6465 6420 6861 6972 7069  y-rounded hairpi
+0002a020: 6e20 6765 6f6d 6574 7279 2e0a 0a20 2020  n geometry...   
+0002a030: 204e 6f74 6573 0a20 2020 202d 2d2d 2d2d   Notes.    -----
+0002a040: 0a20 2020 2048 6169 7270 696e 2070 6974  .    Hairpin pit
+0002a050: 6368 206d 7573 7420 6265 2067 7265 6174  ch must be great
+0002a060: 6572 2074 6861 6e20 7769 6474 682e 0a0a  er than width...
+0002a070: 2020 2020 4f70 7469 6d61 6c20 7374 7275      Optimal stru
+0002a080: 6374 7572 6520 6672 6f6d 2068 7474 7073  cture from https
+0002a090: 3a2f 2f64 6f69 2e6f 7267 2f31 302e 3131  ://doi.org/10.11
+0002a0a0: 3033 2f50 6879 7352 6576 422e 3834 2e31  03/PhysRevB.84.1
+0002a0b0: 3734 3531 300a 2020 2020 436c 656d 2c20  74510.    Clem, 
+0002a0c0: 4a2e 2c20 2620 4265 7267 6772 656e 2c20  J., & Berggren, 
+0002a0d0: 4b2e 2028 3230 3131 292e 2047 656f 6d65  K. (2011). Geome
+0002a0e0: 7472 792d 6465 7065 6e64 656e 7420 6372  try-dependent cr
+0002a0f0: 6974 6963 616c 2063 7572 7265 6e74 7320  itical currents 
+0002a100: 696e 0a20 2020 2073 7570 6572 636f 6e64  in.    supercond
+0002a110: 7563 7469 6e67 206e 616e 6f63 6972 6375  ucting nanocircu
+0002a120: 6974 732e 2050 6879 7369 6361 6c20 5265  its. Physical Re
+0002a130: 7669 6577 2042 2c20 3834 2831 3729 2c20  view B, 84(17), 
+0002a140: 31e2 8093 3237 2e0a 2020 2020 2222 220a  1...27..    """.
+0002a150: 2020 2020 2320 3d3d 3d3d 3d3d 3d3d 3d3d      # ==========
+0002a160: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002a170: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002a180: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002a190: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002a1a0: 0a20 2020 2023 2020 4372 6561 7465 2074  .    #  Create t
+0002a1b0: 6865 2062 6173 6963 2067 656f 6d65 7472  he basic geometr
+0002a1c0: 790a 2020 2020 2320 3d3d 3d3d 3d3d 3d3d  y.    # ========
+0002a1d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002a1e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002a1f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002a200: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002a210: 3d3d 0a20 2020 2061 203d 2028 7069 7463  ==.    a = (pitc
+0002a220: 6820 2b20 7769 6474 6829 202f 2032 0a20  h + width) / 2. 
+0002a230: 2020 2079 203d 202d 2870 6974 6368 202d     y = -(pitch -
+0002a240: 2077 6964 7468 2920 2f20 320a 2020 2020   width) / 2.    
+0002a250: 7820 3d20 2d70 6974 6368 0a20 2020 2064  x = -pitch.    d
+0002a260: 6c20 3d20 7769 6474 6820 2f20 286e 756d  l = width / (num
+0002a270: 5f70 7473 202a 2032 290a 2020 2020 6e20  _pts * 2).    n 
+0002a280: 3d20 300a 0a20 2020 2023 2047 6574 2070  = 0..    # Get p
+0002a290: 6f69 6e74 7320 6f66 2069 6465 616c 2063  oints of ideal c
+0002a2a0: 7572 7665 2066 726f 6d20 636f 6e66 6f72  urve from confor
+0002a2b0: 6d61 6c20 6d61 7070 696e 670a 2020 2020  mal mapping.    
+0002a2c0: 2320 544f 444f 2054 6869 7320 6973 2061  # TODO This is a
+0002a2d0: 6e20 696e 6566 6669 6369 656e 7420 7761  n inefficient wa
+0002a2e0: 7920 6f66 2066 696e 6469 6e67 2070 6f69  y of finding poi
+0002a2f0: 6e74 7320 7468 6174 2079 6f75 206e 6565  nts that you nee
+0002a300: 640a 2020 2020 7870 7473 203d 205b 785d  d.    xpts = [x]
+0002a310: 0a20 2020 2079 7074 7320 3d20 5b79 5d0a  .    ypts = [y].
+0002a320: 2020 2020 7768 696c 6520 2879 203c 2030      while (y < 0
+0002a330: 2920 2620 286e 203c 2031 6536 293a 0a20  ) & (n < 1e6):. 
+0002a340: 2020 2020 2020 2073 203d 2078 202b 2031         s = x + 1
+0002a350: 6a20 2a20 790a 2020 2020 2020 2020 7720  j * y.        w 
+0002a360: 3d20 7371 7274 2831 202d 206e 702e 6578  = sqrt(1 - np.ex
+0002a370: 7028 7069 202a 2073 202f 2061 2929 0a20  p(pi * s / a)). 
+0002a380: 2020 2020 2020 2077 7820 3d20 6e70 2e72         wx = np.r
+0002a390: 6561 6c28 7729 0a20 2020 2020 2020 2077  eal(w).        w
+0002a3a0: 7920 3d20 6e70 2e69 6d61 6728 7729 0a20  y = np.imag(w). 
+0002a3b0: 2020 2020 2020 2077 7820 3d20 7778 202f         wx = wx /
+0002a3c0: 2073 7172 7428 7778 2a2a 3220 2b20 7779   sqrt(wx**2 + wy
+0002a3d0: 2a2a 3229 0a20 2020 2020 2020 2077 7920  **2).        wy 
+0002a3e0: 3d20 7779 202f 2073 7172 7428 7778 2a2a  = wy / sqrt(wx**
+0002a3f0: 3220 2b20 7779 2a2a 3229 0a20 2020 2020  2 + wy**2).     
+0002a400: 2020 2078 203d 2078 202b 2077 7820 2a20     x = x + wx * 
+0002a410: 646c 0a20 2020 2020 2020 2079 203d 2079  dl.        y = y
+0002a420: 202b 2077 7920 2a20 646c 0a20 2020 2020   + wy * dl.     
+0002a430: 2020 2078 7074 732e 6170 7065 6e64 2878     xpts.append(x
+0002a440: 290a 2020 2020 2020 2020 7970 7473 2e61  ).        ypts.a
+0002a450: 7070 656e 6428 7929 0a20 2020 2020 2020  ppend(y).       
+0002a460: 206e 203d 206e 202b 2031 0a20 2020 2079   n = n + 1.    y
+0002a470: 7074 735b 2d31 5d20 3d20 3020 2023 2053  pts[-1] = 0  # S
+0002a480: 6574 206c 6173 7420 706f 696e 7420 6265  et last point be
+0002a490: 206f 6e20 7468 6520 783d 3020 6178 6973   on the x=0 axis
+0002a4a0: 2066 6f72 2073 616b 6520 6f66 2063 6c65   for sake of cle
+0002a4b0: 616e 6c69 6e65 7373 0a20 2020 2064 735f  anliness.    ds_
+0002a4c0: 6661 6374 6f72 203d 2069 6e74 286c 656e  factor = int(len
+0002a4d0: 2878 7074 7329 202f 206e 756d 5f70 7473  (xpts) / num_pts
+0002a4e0: 2920 2023 2044 6f77 6e73 616d 706c 6520  )  # Downsample 
+0002a4f0: 7468 6520 746f 7461 6c20 6e75 6d62 6572  the total number
+0002a500: 206f 6620 706f 696e 7473 0a20 2020 2078   of points.    x
+0002a510: 7074 7320 3d20 7870 7473 5b3a 3a2d 6473  pts = xpts[::-ds
+0002a520: 5f66 6163 746f 725d 0a20 2020 2078 7074  _factor].    xpt
+0002a530: 7320 3d20 7870 7473 5b3a 3a2d 315d 2020  s = xpts[::-1]  
+0002a540: 2320 5468 6973 206c 6f6f 6b73 2063 6f6e  # This looks con
+0002a550: 6675 7369 6e67 2c20 6275 7420 6974 2773  fusing, but it's
+0002a560: 206a 7573 7420 666c 6970 7069 6e67 2074   just flipping t
+0002a570: 6865 2061 7272 6179 7320 6172 6f75 6e64  he arrays around
+0002a580: 0a20 2020 2079 7074 7320 3d20 7970 7473  .    ypts = ypts
+0002a590: 5b3a 3a2d 6473 5f66 6163 746f 725d 0a20  [::-ds_factor]. 
+0002a5a0: 2020 2079 7074 7320 3d20 7970 7473 5b3a     ypts = ypts[:
+0002a5b0: 3a2d 315d 2020 2320 736f 2074 6865 206c  :-1]  # so the l
+0002a5c0: 6173 7420 706f 696e 7420 6973 2067 7561  ast point is gua
+0002a5d0: 7261 6e74 6565 6420 746f 2062 6520 696e  ranteed to be in
+0002a5e0: 636c 7564 6564 2077 6865 6e20 646f 776e  cluded when down
+0002a5f0: 7361 6d70 6c65 640a 0a20 2020 2023 2041  sampled..    # A
+0002a600: 6464 2070 6f69 6e74 7320 666f 7220 7468  dd points for th
+0002a610: 6520 7265 7374 206f 6620 6d65 616e 6465  e rest of meande
+0002a620: 720a 2020 2020 7870 7473 2e61 7070 656e  r.    xpts.appen
+0002a630: 6428 7870 7473 5b2d 315d 202b 2074 7572  d(xpts[-1] + tur
+0002a640: 6e5f 7261 7469 6f20 2a20 7769 6474 6829  n_ratio * width)
+0002a650: 0a20 2020 2079 7074 732e 6170 7065 6e64  .    ypts.append
+0002a660: 2830 290a 2020 2020 7870 7473 2e61 7070  (0).    xpts.app
+0002a670: 656e 6428 7870 7473 5b2d 315d 290a 2020  end(xpts[-1]).  
+0002a680: 2020 7970 7473 2e61 7070 656e 6428 2d61    ypts.append(-a
+0002a690: 290a 2020 2020 7870 7473 2e61 7070 656e  ).    xpts.appen
+0002a6a0: 6428 7870 7473 5b30 5d29 0a20 2020 2079  d(xpts[0]).    y
+0002a6b0: 7074 732e 6170 7065 6e64 282d 6129 0a20  pts.append(-a). 
+0002a6c0: 2020 2078 7074 732e 6170 7065 6e64 286d     xpts.append(m
+0002a6d0: 6178 2878 7074 7329 202d 206c 656e 6774  ax(xpts) - lengt
+0002a6e0: 6829 0a20 2020 2079 7074 732e 6170 7065  h).    ypts.appe
+0002a6f0: 6e64 282d 6129 0a20 2020 2078 7074 732e  nd(-a).    xpts.
+0002a700: 6170 7065 6e64 2878 7074 735b 2d31 5d29  append(xpts[-1])
+0002a710: 0a20 2020 2079 7074 732e 6170 7065 6e64  .    ypts.append
+0002a720: 282d 6120 2b20 7769 6474 6829 0a20 2020  (-a + width).   
+0002a730: 2078 7074 732e 6170 7065 6e64 2878 7074   xpts.append(xpt
+0002a740: 735b 305d 290a 2020 2020 7970 7473 2e61  s[0]).    ypts.a
+0002a750: 7070 656e 6428 7970 7473 5b30 5d29 0a0a  ppend(ypts[0])..
+0002a760: 2020 2020 7870 7473 203d 206e 702e 6172      xpts = np.ar
+0002a770: 7261 7928 7870 7473 290a 2020 2020 7970  ray(xpts).    yp
+0002a780: 7473 203d 206e 702e 6172 7261 7928 7970  ts = np.array(yp
+0002a790: 7473 290a 0a20 2020 2023 203d 3d3d 3d3d  ts)..    # =====
+0002a7a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002a7b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002a7c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002a7d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002a7e0: 3d3d 3d3d 3d0a 2020 2020 2320 2043 7265  =====.    #  Cre
+0002a7f0: 6174 6520 6120 626c 616e 6b20 6465 7669  ate a blank devi
+0002a800: 6365 2c20 6164 6420 7468 6520 6765 6f6d  ce, add the geom
+0002a810: 6574 7279 2c20 616e 6420 6465 6669 6e65  etry, and define
+0002a820: 2074 6865 2070 6f72 7473 0a20 2020 2023   the ports.    #
+0002a830: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
+0002a840: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002a850: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002a860: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002a870: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2020 2020  ===========.    
+0002a880: 4420 3d20 4465 7669 6365 286e 616d 653d  D = Device(name=
+0002a890: 2268 6169 7270 696e 2229 0a20 2020 2044  "hairpin").    D
+0002a8a0: 2e61 6464 5f70 6f6c 7967 6f6e 285b 7870  .add_polygon([xp
+0002a8b0: 7473 2c20 7970 7473 5d2c 206c 6179 6572  ts, ypts], layer
+0002a8c0: 3d6c 6179 6572 290a 2020 2020 442e 6164  =layer).    D.ad
+0002a8d0: 645f 706f 6c79 676f 6e28 5b78 7074 732c  d_polygon([xpts,
+0002a8e0: 202d 7970 7473 5d2c 206c 6179 6572 3d6c   -ypts], layer=l
+0002a8f0: 6179 6572 290a 0a20 2020 2078 706f 7274  ayer)..    xport
+0002a900: 7320 3d20 6d69 6e28 7870 7473 290a 2020  s = min(xpts).  
+0002a910: 2020 7970 6f72 7473 203d 202d 6120 2b20    yports = -a + 
+0002a920: 7769 6474 6820 2f20 320a 2020 2020 442e  width / 2.    D.
+0002a930: 6164 645f 706f 7274 286e 616d 653d 312c  add_port(name=1,
+0002a940: 206d 6964 706f 696e 743d 5b78 706f 7274   midpoint=[xport
+0002a950: 732c 202d 7970 6f72 7473 5d2c 2077 6964  s, -yports], wid
+0002a960: 7468 3d77 6964 7468 2c20 6f72 6965 6e74  th=width, orient
+0002a970: 6174 696f 6e3d 3138 3029 0a20 2020 2044  ation=180).    D
+0002a980: 2e61 6464 5f70 6f72 7428 6e61 6d65 3d32  .add_port(name=2
+0002a990: 2c20 6d69 6470 6f69 6e74 3d5b 7870 6f72  , midpoint=[xpor
+0002a9a0: 7473 2c20 7970 6f72 7473 5d2c 2077 6964  ts, yports], wid
+0002a9b0: 7468 3d77 6964 7468 2c20 6f72 6965 6e74  th=width, orient
+0002a9c0: 6174 696f 6e3d 3138 3029 0a0a 2020 2020  ation=180)..    
+0002a9d0: 7265 7475 726e 2044 0a0a 0a40 6465 7669  return D...@devi
+0002a9e0: 6365 5f6c 7275 5f63 6163 6865 0a64 6566  ce_lru_cache.def
+0002a9f0: 206f 7074 696d 616c 5f73 7465 7028 0a20   optimal_step(. 
+0002aa00: 2020 2073 7461 7274 5f77 6964 7468 3d31     start_width=1
+0002aa10: 302c 0a20 2020 2065 6e64 5f77 6964 7468  0,.    end_width
+0002aa20: 3d32 322c 0a20 2020 206e 756d 5f70 7473  =22,.    num_pts
+0002aa30: 3d35 302c 0a20 2020 2077 6964 7468 5f74  =50,.    width_t
+0002aa40: 6f6c 3d31 652d 332c 0a20 2020 2061 6e74  ol=1e-3,.    ant
+0002aa50: 6963 726f 7764 696e 675f 6661 6374 6f72  icrowding_factor
+0002aa60: 3d31 2e32 2c0a 2020 2020 7379 6d6d 6574  =1.2,.    symmet
+0002aa70: 7269 633d 4661 6c73 652c 0a20 2020 206c  ric=False,.    l
+0002aa80: 6179 6572 3d30 2c0a 293a 0a20 2020 2022  ayer=0,.):.    "
+0002aa90: 2222 4372 6561 7465 7320 616e 206f 7074  ""Creates an opt
+0002aaa0: 696d 616c 6c79 2d72 6f75 6e64 6564 2073  imally-rounded s
+0002aab0: 7465 7020 6765 6f6d 6574 7279 2e0a 0a20  tep geometry... 
+0002aac0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+0002aad0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+0002aae0: 2073 7461 7274 5f77 6964 7468 203a 2069   start_width : i
+0002aaf0: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
+0002ab00: 2020 2020 5769 6474 6820 6f66 2074 6865      Width of the
+0002ab10: 2063 6f6e 6e65 6374 6f72 206f 6e20 7468   connector on th
+0002ab20: 6520 6c65 6674 2065 6e64 206f 6620 7468  e left end of th
+0002ab30: 6520 7374 6570 2e0a 2020 2020 656e 645f  e step..    end_
+0002ab40: 7769 6474 6820 3a20 696e 7420 6f72 2066  width : int or f
+0002ab50: 6c6f 6174 0a20 2020 2020 2020 2057 6964  loat.        Wid
+0002ab60: 7468 206f 6620 7468 6520 636f 6e6e 6563  th of the connec
+0002ab70: 746f 7220 6f6e 2074 6865 2072 6967 6874  tor on the right
+0002ab80: 2065 6e64 206f 6620 7468 6520 7374 6570   end of the step
+0002ab90: 2e0a 2020 2020 6e75 6d5f 7074 7320 3a20  ..    num_pts : 
+0002aba0: 696e 740a 2020 2020 2020 2020 5468 6520  int.        The 
+0002abb0: 6e75 6d62 6572 206f 6620 706f 696e 7473  number of points
+0002abc0: 2063 6f6d 7072 6973 696e 6720 7468 6520   comprising the 
+0002abd0: 656e 7469 7265 2073 7465 7020 6765 6f6d  entire step geom
+0002abe0: 6574 7279 2e0a 2020 2020 7769 6474 685f  etry..    width_
+0002abf0: 746f 6c20 3a20 666c 6f61 740a 2020 2020  tol : float.    
+0002ac00: 2020 2020 506f 696e 7420 6174 2077 6869      Point at whi
+0002ac10: 6368 2074 6f20 7465 726d 696e 6174 6520  ch to terminate 
+0002ac20: 7468 6520 6361 6c63 756c 6174 696f 6e20  the calculation 
+0002ac30: 6f66 2074 6865 206f 7074 696d 616c 2073  of the optimal s
+0002ac40: 7465 700a 2020 2020 616e 7469 6372 6f77  tep.    anticrow
+0002ac50: 6469 6e67 5f66 6163 746f 7220 3a20 696e  ding_factor : in
+0002ac60: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
+0002ac70: 2020 2046 6163 746f 7220 746f 2072 6564     Factor to red
+0002ac80: 7563 6520 6375 7272 656e 7420 6372 6f77  uce current crow
+0002ac90: 6469 6e67 2062 7920 656c 6f6e 6761 7469  ding by elongati
+0002aca0: 6e67 0a20 2020 2020 2020 2074 6865 2073  ng.        the s
+0002acb0: 7472 7563 7475 7265 2061 6e64 2072 6564  tructure and red
+0002acc0: 7563 696e 6720 7468 6520 6375 7276 6174  ucing the curvat
+0002acd0: 7572 650a 2020 2020 7379 6d6d 6574 7269  ure.    symmetri
+0002ace0: 6320 3a20 626f 6f6c 0a20 2020 2020 2020  c : bool.       
+0002acf0: 2049 6620 5472 7565 2c20 6164 6473 2061   If True, adds a
+0002ad00: 206d 6972 726f 7265 6420 636f 7079 206f   mirrored copy o
+0002ad10: 6620 7468 6520 7374 6570 2061 6372 6f73  f the step acros
+0002ad20: 7320 7468 6520 782d 6178 6973 2074 6f20  s the x-axis to 
+0002ad30: 7468 650a 2020 2020 2020 2020 6765 6f6d  the.        geom
+0002ad40: 6574 7279 2061 6e64 2061 646a 7573 7473  etry and adjusts
+0002ad50: 2074 6865 2077 6964 7468 206f 6620 7468   the width of th
+0002ad60: 6520 706f 7274 732e 0a20 2020 206c 6179  e ports..    lay
+0002ad70: 6572 203a 2069 6e74 2c20 6172 7261 792d  er : int, array-
+0002ad80: 6c69 6b65 5b32 5d2c 206f 7220 7365 740a  like[2], or set.
+0002ad90: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
+0002ada0: 206c 6179 6572 2873 2920 746f 2070 7574   layer(s) to put
+0002adb0: 2070 6f6c 7967 6f6e 2067 656f 6d65 7472   polygon geometr
+0002adc0: 7920 6f6e 2e0a 0a20 2020 2052 6574 7572  y on...    Retur
+0002add0: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+0002ade0: 2020 2044 203a 2044 6576 6963 650a 2020     D : Device.  
+0002adf0: 2020 2020 2020 4120 4465 7669 6365 2063        A Device c
+0002ae00: 6f6e 7461 696e 696e 6720 616e 206f 7074  ontaining an opt
+0002ae10: 696d 616c 6c79 2d72 6f75 6e64 6564 2073  imally-rounded s
+0002ae20: 7465 702e 0a0a 2020 2020 4e6f 7465 730a  tep...    Notes.
+0002ae30: 2020 2020 2d2d 2d2d 2d0a 2020 2020 4f70      -----.    Op
+0002ae40: 7469 6d61 6c20 7374 7275 6374 7572 6520  timal structure 
+0002ae50: 6672 6f6d 2068 7474 7073 3a2f 2f64 6f69  from https://doi
+0002ae60: 2e6f 7267 2f31 302e 3131 3033 2f50 6879  .org/10.1103/Phy
+0002ae70: 7352 6576 422e 3834 2e31 3734 3531 300a  sRevB.84.174510.
+0002ae80: 2020 2020 436c 656d 2c20 4a2e 2c20 2620      Clem, J., & 
+0002ae90: 4265 7267 6772 656e 2c20 4b2e 2028 3230  Berggren, K. (20
+0002aea0: 3131 292e 2047 656f 6d65 7472 792d 6465  11). Geometry-de
+0002aeb0: 7065 6e64 656e 7420 6372 6974 6963 616c  pendent critical
+0002aec0: 2063 7572 7265 6e74 7320 696e 0a20 2020   currents in.   
+0002aed0: 2073 7570 6572 636f 6e64 7563 7469 6e67   superconducting
+0002aee0: 206e 616e 6f63 6972 6375 6974 732e 2050   nanocircuits. P
+0002aef0: 6879 7369 6361 6c20 5265 7669 6577 2042  hysical Review B
+0002af00: 2c20 3834 2831 3729 2c20 31e2 8093 3237  , 84(17), 1...27
+0002af10: 2e0a 2020 2020 2222 220a 0a20 2020 2023  ..    """..    #
+0002af20: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
+0002af30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002af40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002af50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002af60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2020 2020  ===========.    
+0002af70: 2320 2043 7265 6174 6520 7468 6520 6261  #  Create the ba
+0002af80: 7369 6320 6765 6f6d 6574 7279 0a20 2020  sic geometry.   
+0002af90: 2023 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   # =============
+0002afa0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002afb0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002afc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002afd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2020  =============.  
+0002afe0: 2020 6465 6620 7374 6570 5f70 6f69 6e74    def step_point
+0002aff0: 7328 6574 612c 2057 2c20 6129 3a0a 2020  s(eta, W, a):.  
+0002b000: 2020 2020 2020 2320 5265 7475 726e 7320        # Returns 
+0002b010: 706f 696e 7473 2066 726f 6d20 6120 756e  points from a un
+0002b020: 6974 2073 656d 6963 6972 636c 6520 696e  it semicircle in
+0002b030: 2074 6865 2077 2028 3d20 7520 2b20 6976   the w (= u + iv
+0002b040: 2920 706c 616e 6520 746f 0a20 2020 2020  ) plane to.     
+0002b050: 2020 2023 2074 6865 206f 7074 696d 616c     # the optimal
+0002b060: 2063 7572 7665 2069 6e20 7468 6520 7a65   curve in the ze
+0002b070: 7461 2028 3d20 7820 2b20 6979 2920 706c  ta (= x + iy) pl
+0002b080: 616e 6520 7768 6963 6820 7472 616e 7369  ane which transi
+0002b090: 7469 6f6e 730a 2020 2020 2020 2020 2320  tions.        # 
+0002b0a0: 6120 7769 7265 2066 726f 6d20 6120 7769  a wire from a wi
+0002b0b0: 6474 6820 6f66 2027 5727 2074 6f20 6120  dth of 'W' to a 
+0002b0c0: 7769 6474 6820 6f66 2027 6127 0a20 2020  width of 'a'.   
+0002b0d0: 2020 2020 2023 2065 7461 2074 616b 6573       # eta takes
+0002b0e0: 2076 616c 7565 2030 2074 6f20 7069 0a0a   value 0 to pi..
+0002b0f0: 2020 2020 2020 2020 5720 3d20 6e70 2e61          W = np.a
+0002b100: 7272 6179 2857 2c20 6474 7970 653d 636f  rray(W, dtype=co
+0002b110: 6d70 6c65 7829 0a20 2020 2020 2020 2061  mplex).        a
+0002b120: 203d 206e 702e 6172 7261 7928 612c 2064   = np.array(a, d
+0002b130: 7479 7065 3d63 6f6d 706c 6578 290a 0a20  type=complex).. 
+0002b140: 2020 2020 2020 2067 616d 6d61 203d 2028         gamma = (
+0002b150: 6120 2a20 6120 2b20 5720 2a20 5729 202f  a * a + W * W) /
+0002b160: 2028 6120 2a20 6120 2d20 5720 2a20 5729   (a * a - W * W)
+0002b170: 0a0a 2020 2020 2020 2020 7720 3d20 6e70  ..        w = np
+0002b180: 2e65 7870 2831 6a20 2a20 6574 6129 0a0a  .exp(1j * eta)..
+0002b190: 2020 2020 2020 2020 7a65 7461 203d 2028          zeta = (
+0002b1a0: 0a20 2020 2020 2020 2020 2020 2034 0a20  .            4. 
+0002b1b0: 2020 2020 2020 2020 2020 202a 2031 6a0a             * 1j.
+0002b1c0: 2020 2020 2020 2020 2020 2020 2f20 7069              / pi
+0002b1d0: 0a20 2020 2020 2020 2020 2020 202a 2028  .            * (
+0002b1e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b1f0: 2057 202a 206e 702e 6172 6374 616e 2873   W * np.arctan(s
+0002b200: 7172 7428 2877 202d 2067 616d 6d61 2920  qrt((w - gamma) 
+0002b210: 2f20 2867 616d 6d61 202b 2031 2929 290a  / (gamma + 1))).
+0002b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b230: 2b20 6120 2a20 6e70 2e61 7263 7461 6e28  + a * np.arctan(
+0002b240: 7371 7274 2828 6761 6d6d 6120 2d20 3129  sqrt((gamma - 1)
+0002b250: 202f 2028 7720 2d20 6761 6d6d 6129 2929   / (w - gamma)))
+0002b260: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0002b270: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0002b280: 2020 7820 3d20 6e70 2e72 6561 6c28 7a65    x = np.real(ze
+0002b290: 7461 290a 2020 2020 2020 2020 7920 3d20  ta).        y = 
+0002b2a0: 6e70 2e69 6d61 6728 7a65 7461 290a 2020  np.imag(zeta).  
+0002b2b0: 2020 2020 2020 7265 7475 726e 2078 2c20        return x, 
+0002b2c0: 790a 0a20 2020 2064 6566 2069 6e76 6572  y..    def inver
+0002b2d0: 745f 7374 6570 5f70 6f69 6e74 2878 5f64  t_step_point(x_d
+0002b2e0: 6573 6972 6564 3d2d 3130 2c20 795f 6465  esired=-10, y_de
+0002b2f0: 7369 7265 643d 4e6f 6e65 2c20 573d 312c  sired=None, W=1,
+0002b300: 2061 3d32 293a 0a20 2020 2020 2020 2023   a=2):.        #
+0002b310: 2046 696e 6473 2074 6865 2065 7461 2061   Finds the eta a
+0002b320: 7373 6f63 6961 7465 6420 7769 7468 2074  ssociated with t
+0002b330: 6865 2076 616c 7565 2078 5f64 6573 6972  he value x_desir
+0002b340: 6564 2061 6c6f 6e67 2074 6865 0a20 2020  ed along the.   
+0002b350: 2020 2020 2023 206f 7074 696d 616c 2063       # optimal c
+0002b360: 7572 7665 0a20 2020 2020 2020 2064 6566  urve.        def
+0002b370: 2066 6828 6574 6129 3a0a 2020 2020 2020   fh(eta):.      
+0002b380: 2020 2020 2020 6775 6573 7365 645f 782c        guessed_x,
+0002b390: 2067 7565 7373 6564 5f79 203d 2073 7465   guessed_y = ste
+0002b3a0: 705f 706f 696e 7473 2865 7461 2c20 573d  p_points(eta, W=
+0002b3b0: 572c 2061 3d61 290a 2020 2020 2020 2020  W, a=a).        
+0002b3c0: 2020 2020 6966 2079 5f64 6573 6972 6564      if y_desired
+0002b3d0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0002b3e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002b3f0: 2028 6775 6573 7365 645f 7820 2d20 785f   (guessed_x - x_
+0002b400: 6465 7369 7265 6429 202a 2a20 3220 2023  desired) ** 2  #
+0002b410: 2054 6865 2065 7272 6f72 0a20 2020 2020   The error.     
+0002b420: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002b430: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0002b440: 7572 6e20 2867 7565 7373 6564 5f79 202d  urn (guessed_y -
+0002b450: 2079 5f64 6573 6972 6564 2920 2a2a 2032   y_desired) ** 2
+0002b460: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
+0002b470: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+0002b480: 7363 6970 792e 6f70 7469 6d69 7a65 2069  scipy.optimize i
+0002b490: 6d70 6f72 7420 666d 696e 626f 756e 640a  mport fminbound.
+0002b4a0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0002b4b0: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+0002b4c0: 2020 2020 2020 7261 6973 6520 496d 706f        raise Impo
+0002b4d0: 7274 4572 726f 7228 0a20 2020 2020 2020  rtError(.       
+0002b4e0: 2020 2020 2020 2020 2022 205b 5048 4944           " [PHID
+0002b4f0: 4c5d 2054 6f20 7275 6e20 7468 6520 6f70  L] To run the op
+0002b500: 7469 6d61 6c2d 6375 7276 6520 6765 6f6d  timal-curve geom
+0002b510: 6574 7279 2022 0a20 2020 2020 2020 2020  etry ".         
+0002b520: 2020 2020 2020 2022 6675 6e63 7469 6f6e         "function
+0002b530: 7320 796f 7520 6e65 6564 2073 6369 7079  s you need scipy
+0002b540: 2c20 706c 6561 7365 2069 6e73 7461 6c6c  , please install
+0002b550: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0002b560: 2020 2022 6974 2077 6974 6820 6070 6970     "it with `pip
+0002b570: 2069 6e73 7461 6c6c 2073 6369 7079 6022   install scipy`"
+0002b580: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0002b590: 2020 2020 2020 2066 6f75 6e64 5f65 7461         found_eta
+0002b5a0: 203d 2066 6d69 6e62 6f75 6e64 2866 682c   = fminbound(fh,
+0002b5b0: 2078 313d 302c 2078 323d 7069 2c20 6172   x1=0, x2=pi, ar
+0002b5c0: 6773 3d28 2929 0a20 2020 2020 2020 2072  gs=()).        r
+0002b5d0: 6574 7572 6e20 7374 6570 5f70 6f69 6e74  eturn step_point
+0002b5e0: 7328 666f 756e 645f 6574 612c 2057 3d57  s(found_eta, W=W
+0002b5f0: 2c20 613d 6129 0a0a 2020 2020 6966 2073  , a=a)..    if s
+0002b600: 7461 7274 5f77 6964 7468 203e 2065 6e64  tart_width > end
+0002b610: 5f77 6964 7468 3a0a 2020 2020 2020 2020  _width:.        
+0002b620: 7265 7665 7273 6520 3d20 5472 7565 0a20  reverse = True. 
+0002b630: 2020 2020 2020 2073 7461 7274 5f77 6964         start_wid
+0002b640: 7468 2c20 656e 645f 7769 6474 6820 3d20  th, end_width = 
+0002b650: 656e 645f 7769 6474 682c 2073 7461 7274  end_width, start
+0002b660: 5f77 6964 7468 0a20 2020 2065 6c73 653a  _width.    else:
+0002b670: 0a20 2020 2020 2020 2072 6576 6572 7365  .        reverse
+0002b680: 203d 2046 616c 7365 0a0a 2020 2020 4420   = False..    D 
+0002b690: 3d20 4465 7669 6365 286e 616d 653d 2273  = Device(name="s
+0002b6a0: 7465 7022 290a 2020 2020 6966 2073 7461  tep").    if sta
+0002b6b0: 7274 5f77 6964 7468 203d 3d20 656e 645f  rt_width == end_
+0002b6c0: 7769 6474 683a 2020 2320 4a75 7374 2072  width:  # Just r
+0002b6d0: 6574 7572 6e20 6120 7371 7561 7265 0a20  eturn a square. 
+0002b6e0: 2020 2020 2020 2069 6620 7379 6d6d 6574         if symmet
+0002b6f0: 7269 633a 0a20 2020 2020 2020 2020 2020  ric:.           
+0002b700: 2079 7074 7320 3d20 5b0a 2020 2020 2020   ypts = [.      
+0002b710: 2020 2020 2020 2020 2020 2d73 7461 7274            -start
+0002b720: 5f77 6964 7468 202f 2032 2c0a 2020 2020  _width / 2,.    
+0002b730: 2020 2020 2020 2020 2020 2020 7374 6172              star
+0002b740: 745f 7769 6474 6820 2f20 322c 0a20 2020  t_width / 2,.   
+0002b750: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+0002b760: 7274 5f77 6964 7468 202f 2032 2c0a 2020  rt_width / 2,.  
+0002b770: 2020 2020 2020 2020 2020 2020 2020 2d73                -s
+0002b780: 7461 7274 5f77 6964 7468 202f 2032 2c0a  tart_width / 2,.
+0002b790: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+0002b7a0: 2020 2020 2020 2020 2020 7870 7473 203d            xpts =
+0002b7b0: 205b 302c 2030 2c20 7374 6172 745f 7769   [0, 0, start_wi
+0002b7c0: 6474 682c 2073 7461 7274 5f77 6964 7468  dth, start_width
+0002b7d0: 5d0a 2020 2020 2020 2020 6966 206e 6f74  ].        if not
+0002b7e0: 2073 796d 6d65 7472 6963 3a0a 2020 2020   symmetric:.    
+0002b7f0: 2020 2020 2020 2020 7970 7473 203d 205b          ypts = [
+0002b800: 302c 2073 7461 7274 5f77 6964 7468 2c20  0, start_width, 
+0002b810: 7374 6172 745f 7769 6474 682c 2030 5d0a  start_width, 0].
+0002b820: 2020 2020 2020 2020 2020 2020 7870 7473              xpts
+0002b830: 203d 205b 302c 2030 2c20 7374 6172 745f   = [0, 0, start_
+0002b840: 7769 6474 682c 2073 7461 7274 5f77 6964  width, start_wid
+0002b850: 7468 5d0a 2020 2020 2020 2020 442e 696e  th].        D.in
+0002b860: 666f 5b22 6e75 6d5f 7371 7561 7265 7322  fo["num_squares"
+0002b870: 5d20 3d20 310a 2020 2020 656c 7365 3a0a  ] = 1.    else:.
+0002b880: 2020 2020 2020 2020 786d 696e 2c20 796d          xmin, ym
+0002b890: 696e 203d 2069 6e76 6572 745f 7374 6570  in = invert_step
+0002b8a0: 5f70 6f69 6e74 280a 2020 2020 2020 2020  _point(.        
+0002b8b0: 2020 2020 795f 6465 7369 7265 643d 7374      y_desired=st
+0002b8c0: 6172 745f 7769 6474 6820 2a20 2831 202b  art_width * (1 +
+0002b8d0: 2077 6964 7468 5f74 6f6c 292c 2057 3d73   width_tol), W=s
+0002b8e0: 7461 7274 5f77 6964 7468 2c20 613d 656e  tart_width, a=en
+0002b8f0: 645f 7769 6474 680a 2020 2020 2020 2020  d_width.        
+0002b900: 290a 2020 2020 2020 2020 786d 6178 2c20  ).        xmax, 
+0002b910: 796d 6178 203d 2069 6e76 6572 745f 7374  ymax = invert_st
+0002b920: 6570 5f70 6f69 6e74 280a 2020 2020 2020  ep_point(.      
+0002b930: 2020 2020 2020 795f 6465 7369 7265 643d        y_desired=
+0002b940: 656e 645f 7769 6474 6820 2a20 2831 202d  end_width * (1 -
+0002b950: 2077 6964 7468 5f74 6f6c 292c 2057 3d73   width_tol), W=s
+0002b960: 7461 7274 5f77 6964 7468 2c20 613d 656e  tart_width, a=en
+0002b970: 645f 7769 6474 680a 2020 2020 2020 2020  d_width.        
+0002b980: 290a 0a20 2020 2020 2020 2078 7074 7320  )..        xpts 
+0002b990: 3d20 6e70 2e6c 696e 7370 6163 6528 786d  = np.linspace(xm
+0002b9a0: 696e 2c20 786d 6178 2c20 6e75 6d5f 7074  in, xmax, num_pt
+0002b9b0: 7329 2e74 6f6c 6973 7428 290a 2020 2020  s).tolist().    
+0002b9c0: 2020 2020 7970 7473 203d 205b 5d0a 2020      ypts = [].  
+0002b9d0: 2020 2020 2020 666f 7220 7820 696e 2078        for x in x
+0002b9e0: 7074 733a 0a20 2020 2020 2020 2020 2020  pts:.           
+0002b9f0: 2078 2c20 7920 3d20 696e 7665 7274 5f73   x, y = invert_s
+0002ba00: 7465 705f 706f 696e 7428 785f 6465 7369  tep_point(x_desi
+0002ba10: 7265 643d 782c 2057 3d73 7461 7274 5f77  red=x, W=start_w
+0002ba20: 6964 7468 2c20 613d 656e 645f 7769 6474  idth, a=end_widt
+0002ba30: 6829 0a20 2020 2020 2020 2020 2020 2079  h).            y
+0002ba40: 7074 732e 6170 7065 6e64 2879 290a 0a20  pts.append(y).. 
+0002ba50: 2020 2020 2020 2079 7074 735b 2d31 5d20         ypts[-1] 
+0002ba60: 3d20 656e 645f 7769 6474 680a 2020 2020  = end_width.    
+0002ba70: 2020 2020 7970 7473 5b30 5d20 3d20 7374      ypts[0] = st
+0002ba80: 6172 745f 7769 6474 680a 2020 2020 2020  art_width.      
+0002ba90: 2020 795f 6e75 6d5f 7371 203d 206e 702e    y_num_sq = np.
+0002baa0: 6172 7261 7928 7970 7473 290a 2020 2020  array(ypts).    
+0002bab0: 2020 2020 785f 6e75 6d5f 7371 203d 206e      x_num_sq = n
+0002bac0: 702e 6172 7261 7928 7870 7473 290a 0a20  p.array(xpts).. 
+0002bad0: 2020 2020 2020 2069 6620 6e6f 7420 7379         if not sy
+0002bae0: 6d6d 6574 7269 633a 0a20 2020 2020 2020  mmetric:.       
+0002baf0: 2020 2020 2078 7074 732e 6170 7065 6e64       xpts.append
+0002bb00: 2878 7074 735b 2d31 5d29 0a20 2020 2020  (xpts[-1]).     
+0002bb10: 2020 2020 2020 2079 7074 732e 6170 7065         ypts.appe
+0002bb20: 6e64 2830 290a 2020 2020 2020 2020 2020  nd(0).          
+0002bb30: 2020 7870 7473 2e61 7070 656e 6428 7870    xpts.append(xp
+0002bb40: 7473 5b30 5d29 0a20 2020 2020 2020 2020  ts[0]).         
+0002bb50: 2020 2079 7074 732e 6170 7065 6e64 2830     ypts.append(0
+0002bb60: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0002bb70: 2020 2020 2020 2020 2020 2020 7870 7473              xpts
+0002bb80: 202b 3d20 5b78 2066 6f72 2078 2069 6e20   += [x for x in 
+0002bb90: 7870 7473 5b3a 3a2d 315d 5d0a 2020 2020  xpts[::-1]].    
+0002bba0: 2020 2020 2020 2020 7970 7473 202b 3d20          ypts += 
+0002bbb0: 5b2d 7920 666f 7220 7920 696e 2079 7074  [-y for y in ypt
+0002bbc0: 735b 3a3a 2d31 5d5d 0a20 2020 2020 2020  s[::-1]].       
+0002bbd0: 2020 2020 2078 7074 7320 3d20 5b78 202f       xpts = [x /
+0002bbe0: 2032 2066 6f72 2078 2069 6e20 7870 7473   2 for x in xpts
+0002bbf0: 5d0a 2020 2020 2020 2020 2020 2020 7970  ].            yp
+0002bc00: 7473 203d 205b 7920 2f20 3220 666f 7220  ts = [y / 2 for 
+0002bc10: 7920 696e 2079 7074 735d 0a0a 2020 2020  y in ypts]..    
+0002bc20: 2020 2020 2320 616e 7469 6372 6f77 6469      # anticrowdi
+0002bc30: 6e67 5f66 6163 746f 7220 7374 7265 7463  ng_factor stretc
+0002bc40: 6865 7320 7468 6520 7769 7265 206f 7574  hes the wire out
+0002bc50: 3b20 6120 7374 7265 7463 6865 6420 7769  ; a stretched wi
+0002bc60: 7265 2069 7320 610a 2020 2020 2020 2020  re is a.        
+0002bc70: 2320 6765 6e74 6c65 7220 7472 616e 7369  # gentler transi
+0002bc80: 7469 6f6e 2c20 736f 2074 6865 7265 2773  tion, so there's
+0002bc90: 206c 6573 7320 6368 616e 6365 206f 6620   less chance of 
+0002bca0: 6375 7272 656e 7420 6372 6f77 6469 6e67  current crowding
+0002bcb0: 2069 660a 2020 2020 2020 2020 2320 7468   if.        # th
+0002bcc0: 6520 6661 6272 6963 6174 696f 6e20 6973  e fabrication is
+0002bcd0: 6e27 7420 7065 7266 6563 7420 6275 7420  n't perfect but 
+0002bce0: 6173 2061 2072 6573 756c 742c 2074 6865  as a result, the
+0002bcf0: 2077 6972 6520 6973 6e27 7420 6173 0a20   wire isn't as. 
+0002bd00: 2020 2020 2020 2023 2073 686f 7274 2061         # short a
+0002bd10: 7320 6974 2063 6f75 6c64 2062 650a 2020  s it could be.  
+0002bd20: 2020 2020 2020 7870 7473 203d 2028 6e70        xpts = (np
+0002bd30: 2e61 7272 6179 2878 7074 7329 202a 2061  .array(xpts) * a
+0002bd40: 6e74 6963 726f 7764 696e 675f 6661 6374  nticrowding_fact
+0002bd50: 6f72 292e 746f 6c69 7374 2829 0a0a 2020  or).tolist()..  
+0002bd60: 2020 2020 2020 6966 2072 6576 6572 7365        if reverse
+0002bd70: 2069 7320 5472 7565 3a0a 2020 2020 2020   is True:.      
+0002bd80: 2020 2020 2020 7870 7473 203d 2028 2d6e        xpts = (-n
+0002bd90: 702e 6172 7261 7928 7870 7473 2929 2e74  p.array(xpts)).t
+0002bda0: 6f6c 6973 7428 290a 2020 2020 2020 2020  olist().        
+0002bdb0: 2020 2020 7374 6172 745f 7769 6474 682c      start_width,
+0002bdc0: 2065 6e64 5f77 6964 7468 203d 2065 6e64   end_width = end
+0002bdd0: 5f77 6964 7468 2c20 7374 6172 745f 7769  _width, start_wi
+0002bde0: 6474 680a 0a20 2020 2020 2020 2044 2e69  dth..        D.i
+0002bdf0: 6e66 6f5b 226e 756d 5f73 7175 6172 6573  nfo["num_squares
+0002be00: 225d 203d 206e 702e 7375 6d28 0a20 2020  "] = np.sum(.   
+0002be10: 2020 2020 2020 2020 206e 702e 6469 6666           np.diff
+0002be20: 2878 5f6e 756d 5f73 7129 202f 2028 2879  (x_num_sq) / ((y
+0002be30: 5f6e 756d 5f73 715b 3a2d 315d 202b 2079  _num_sq[:-1] + y
+0002be40: 5f6e 756d 5f73 715b 313a 5d29 202f 2032  _num_sq[1:]) / 2
+0002be50: 290a 2020 2020 2020 2020 290a 0a20 2020  ).        )..   
+0002be60: 2023 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   # =============
+0002be70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002be80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002be90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002bea0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2020  =============.  
+0002beb0: 2020 2320 2043 7265 6174 6520 6120 626c    #  Create a bl
+0002bec0: 616e 6b20 6465 7669 6365 2c20 6164 6420  ank device, add 
+0002bed0: 7468 6520 6765 6f6d 6574 7279 2c20 616e  the geometry, an
+0002bee0: 6420 6465 6669 6e65 2074 6865 2070 6f72  d define the por
+0002bef0: 7473 0a20 2020 2023 203d 3d3d 3d3d 3d3d  ts.    # =======
+0002bf00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002bf10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002bf20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002bf30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002bf40: 3d3d 3d0a 2020 2020 442e 6164 645f 706f  ===.    D.add_po
+0002bf50: 6c79 676f 6e28 5b78 7074 732c 2079 7074  lygon([xpts, ypt
+0002bf60: 735d 2c20 6c61 7965 723d 6c61 7965 7229  s], layer=layer)
+0002bf70: 0a0a 2020 2020 6966 206e 6f74 2073 796d  ..    if not sym
+0002bf80: 6d65 7472 6963 3a0a 2020 2020 2020 2020  metric:.        
+0002bf90: 442e 6164 645f 706f 7274 280a 2020 2020  D.add_port(.    
+0002bfa0: 2020 2020 2020 2020 6e61 6d65 3d31 2c0a          name=1,.
+0002bfb0: 2020 2020 2020 2020 2020 2020 6d69 6470              midp
+0002bfc0: 6f69 6e74 3d5b 6d69 6e28 7870 7473 292c  oint=[min(xpts),
+0002bfd0: 2073 7461 7274 5f77 6964 7468 202f 2032   start_width / 2
+0002bfe0: 5d2c 0a20 2020 2020 2020 2020 2020 2077  ],.            w
+0002bff0: 6964 7468 3d73 7461 7274 5f77 6964 7468  idth=start_width
+0002c000: 2c0a 2020 2020 2020 2020 2020 2020 6f72  ,.            or
+0002c010: 6965 6e74 6174 696f 6e3d 3138 302c 0a20  ientation=180,. 
+0002c020: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002c030: 2044 2e61 6464 5f70 6f72 7428 0a20 2020   D.add_port(.   
+0002c040: 2020 2020 2020 2020 206e 616d 653d 322c           name=2,
+0002c050: 206d 6964 706f 696e 743d 5b6d 6178 2878   midpoint=[max(x
+0002c060: 7074 7329 2c20 656e 645f 7769 6474 6820  pts), end_width 
+0002c070: 2f20 325d 2c20 7769 6474 683d 656e 645f  / 2], width=end_
+0002c080: 7769 6474 682c 206f 7269 656e 7461 7469  width, orientati
+0002c090: 6f6e 3d30 0a20 2020 2020 2020 2029 0a20  on=0.        ). 
+0002c0a0: 2020 2069 6620 7379 6d6d 6574 7269 633a     if symmetric:
+0002c0b0: 0a20 2020 2020 2020 2044 2e61 6464 5f70  .        D.add_p
+0002c0c0: 6f72 7428 6e61 6d65 3d31 2c20 6d69 6470  ort(name=1, midp
+0002c0d0: 6f69 6e74 3d5b 6d69 6e28 7870 7473 292c  oint=[min(xpts),
+0002c0e0: 2030 5d2c 2077 6964 7468 3d73 7461 7274   0], width=start
+0002c0f0: 5f77 6964 7468 2c20 6f72 6965 6e74 6174  _width, orientat
+0002c100: 696f 6e3d 3138 3029 0a20 2020 2020 2020  ion=180).       
+0002c110: 2044 2e61 6464 5f70 6f72 7428 6e61 6d65   D.add_port(name
+0002c120: 3d32 2c20 6d69 6470 6f69 6e74 3d5b 6d61  =2, midpoint=[ma
+0002c130: 7828 7870 7473 292c 2030 5d2c 2077 6964  x(xpts), 0], wid
+0002c140: 7468 3d65 6e64 5f77 6964 7468 2c20 6f72  th=end_width, or
+0002c150: 6965 6e74 6174 696f 6e3d 3029 0a0a 2020  ientation=0)..  
+0002c160: 2020 7265 7475 726e 2044 0a0a 0a64 6566    return D...def
+0002c170: 206f 7074 696d 616c 5f39 3064 6567 2877   optimal_90deg(w
+0002c180: 6964 7468 3d31 3030 2e30 2c20 6e75 6d5f  idth=100.0, num_
+0002c190: 7074 733d 3135 2c20 6c65 6e67 7468 5f61  pts=15, length_a
+0002c1a0: 646a 7573 743d 312c 206c 6179 6572 3d30  djust=1, layer=0
+0002c1b0: 293a 0a20 2020 2022 2222 4372 6561 7465  ):.    """Create
+0002c1c0: 7320 616e 206f 7074 696d 616c 6c79 2d72  s an optimally-r
+0002c1d0: 6f75 6e64 6564 2039 3020 6465 6772 6565  ounded 90 degree
+0002c1e0: 2062 656e 6420 7468 6174 2069 7320 7368   bend that is sh
+0002c1f0: 6172 7020 6f6e 2074 6865 206f 7574 6572  arp on the outer
+0002c200: 0a20 2020 2063 6f72 6e65 722e 0a0a 2020  .    corner...  
+0002c210: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+0002c220: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+0002c230: 7769 6474 6820 3a20 696e 7420 6f72 2066  width : int or f
+0002c240: 6c6f 6174 0a20 2020 2020 2020 2057 6964  loat.        Wid
+0002c250: 7468 206f 6620 7468 6520 706f 7274 7320  th of the ports 
+0002c260: 6f6e 2065 6974 6865 7220 7369 6465 206f  on either side o
+0002c270: 6620 7468 6520 6265 6e64 2e0a 2020 2020  f the bend..    
+0002c280: 6e75 6d5f 7074 7320 3a20 696e 740a 2020  num_pts : int.  
+0002c290: 2020 2020 2020 5468 6520 6e75 6d62 6572        The number
+0002c2a0: 206f 6620 706f 696e 7473 2063 6f6d 7072   of points compr
+0002c2b0: 6973 696e 6720 7468 6520 6375 7276 6564  ising the curved
+0002c2c0: 2073 6563 7469 6f6e 206f 6620 7468 6520   section of the 
+0002c2d0: 6265 6e64 2e0a 2020 2020 6c65 6e67 7468  bend..    length
+0002c2e0: 5f61 646a 7573 7420 3a20 696e 7420 6f72  _adjust : int or
+0002c2f0: 2066 6c6f 6174 0a20 2020 2020 2020 2041   float.        A
+0002c300: 646a 7573 7473 2074 6865 206c 656e 6774  djusts the lengt
+0002c310: 6820 6f66 2074 6865 206e 6f6e 2d63 7572  h of the non-cur
+0002c320: 7665 6420 706f 7274 696f 6e20 6f66 2074  ved portion of t
+0002c330: 6865 2062 656e 642e 0a20 2020 206c 6179  he bend..    lay
+0002c340: 6572 203a 2069 6e74 2c20 6172 7261 792d  er : int, array-
+0002c350: 6c69 6b65 5b32 5d2c 206f 7220 7365 740a  like[2], or set.
+0002c360: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
+0002c370: 206c 6179 6572 2873 2920 746f 2070 7574   layer(s) to put
+0002c380: 2070 6f6c 7967 6f6e 2067 656f 6d65 7472   polygon geometr
+0002c390: 7920 6f6e 2e0a 0a20 2020 2052 6574 7572  y on...    Retur
+0002c3a0: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+0002c3b0: 2020 2044 203a 2044 6576 6963 650a 2020     D : Device.  
+0002c3c0: 2020 2020 2020 4120 4465 7669 6365 2063        A Device c
+0002c3d0: 6f6e 7461 696e 696e 6720 616e 206f 7074  ontaining an opt
+0002c3e0: 696d 616c 6c79 2d72 6f75 6e64 6564 2039  imally-rounded 9
+0002c3f0: 3020 6465 6772 6565 2062 656e 642e 0a0a  0 degree bend...
+0002c400: 2020 2020 4e6f 7465 730a 2020 2020 2d2d      Notes.    --
+0002c410: 2d2d 2d0a 2020 2020 4f70 7469 6d61 6c20  ---.    Optimal 
+0002c420: 7374 7275 6374 7572 6520 6672 6f6d 2068  structure from h
+0002c430: 7474 7073 3a2f 2f64 6f69 2e6f 7267 2f31  ttps://doi.org/1
+0002c440: 302e 3131 3033 2f50 6879 7352 6576 422e  0.1103/PhysRevB.
+0002c450: 3834 2e31 3734 3531 300a 2020 2020 436c  84.174510.    Cl
+0002c460: 656d 2c20 4a2e 2c20 2620 4265 7267 6772  em, J., & Berggr
+0002c470: 656e 2c20 4b2e 2028 3230 3131 292e 2047  en, K. (2011). G
+0002c480: 656f 6d65 7472 792d 6465 7065 6e64 656e  eometry-dependen
+0002c490: 7420 6372 6974 6963 616c 2063 7572 7265  t critical curre
+0002c4a0: 6e74 7320 696e 0a20 2020 2073 7570 6572  nts in.    super
+0002c4b0: 636f 6e64 7563 7469 6e67 206e 616e 6f63  conducting nanoc
+0002c4c0: 6972 6375 6974 732e 2050 6879 7369 6361  ircuits. Physica
+0002c4d0: 6c20 5265 7669 6577 2042 2c20 3834 2831  l Review B, 84(1
+0002c4e0: 3729 2c20 31e2 8093 3237 2e0a 2020 2020  7), 1...27..    
+0002c4f0: 2222 220a 2020 2020 4420 3d20 4465 7669  """.    D = Devi
+0002c500: 6365 2822 3930 6465 6722 290a 0a20 2020  ce("90deg")..   
+0002c510: 2023 2047 6574 2070 6f69 6e74 7320 6f66   # Get points of
+0002c520: 2069 6465 616c 2063 7572 7665 0a20 2020   ideal curve.   
+0002c530: 2061 203d 2032 202a 2077 6964 7468 0a20   a = 2 * width. 
+0002c540: 2020 2076 203d 206e 702e 6c6f 6773 7061     v = np.logspa
+0002c550: 6365 282d 6c65 6e67 7468 5f61 646a 7573  ce(-length_adjus
+0002c560: 742c 206c 656e 6774 685f 6164 6a75 7374  t, length_adjust
+0002c570: 2c20 6e75 6d5f 7074 7329 0a20 2020 2078  , num_pts).    x
+0002c580: 6920 3d20 280a 2020 2020 2020 2020 6120  i = (.        a 
+0002c590: 2f20 322e 3020 2a20 2828 3120 2b20 3220  / 2.0 * ((1 + 2 
+0002c5a0: 2f20 7069 202a 206e 702e 6172 6373 696e  / pi * np.arcsin
+0002c5b0: 6828 3120 2f20 7629 2920 2b20 316a 202a  h(1 / v)) + 1j *
+0002c5c0: 2028 3120 2b20 3220 2f20 7069 202a 206e   (1 + 2 / pi * n
+0002c5d0: 702e 6172 6373 696e 6828 7629 2929 0a20  p.arcsinh(v))). 
+0002c5e0: 2020 2029 0a20 2020 2078 7074 7320 3d20     ).    xpts = 
+0002c5f0: 6c69 7374 286e 702e 7265 616c 2878 6929  list(np.real(xi)
+0002c600: 290a 2020 2020 7970 7473 203d 206c 6973  ).    ypts = lis
+0002c610: 7428 6e70 2e69 6d61 6728 7869 2929 0a0a  t(np.imag(xi))..
+0002c620: 2020 2020 2320 4164 6420 706f 696e 7473      # Add points
+0002c630: 2066 6f72 2074 6865 2072 6573 7420 6f66   for the rest of
+0002c640: 2063 7572 7665 0a20 2020 2064 203d 2032   curve.    d = 2
+0002c650: 202a 2078 7074 735b 305d 2020 2320 4661   * xpts[0]  # Fa
+0002c660: 7274 6865 7374 2070 6f69 6e74 206f 7574  rthest point out
+0002c670: 202a 2032 2c20 726f 756e 6465 6420 746f   * 2, rounded to
+0002c680: 206e 6561 7265 7374 2031 3030 0a20 2020   nearest 100.   
+0002c690: 2078 7074 732e 6170 7065 6e64 2877 6964   xpts.append(wid
+0002c6a0: 7468 290a 2020 2020 7970 7473 2e61 7070  th).    ypts.app
+0002c6b0: 656e 6428 6429 0a20 2020 2078 7074 732e  end(d).    xpts.
+0002c6c0: 6170 7065 6e64 2830 290a 2020 2020 7970  append(0).    yp
+0002c6d0: 7473 2e61 7070 656e 6428 6429 0a20 2020  ts.append(d).   
+0002c6e0: 2078 7074 732e 6170 7065 6e64 2830 290a   xpts.append(0).
+0002c6f0: 2020 2020 7970 7473 2e61 7070 656e 6428      ypts.append(
+0002c700: 3029 0a20 2020 2078 7074 732e 6170 7065  0).    xpts.appe
+0002c710: 6e64 2864 290a 2020 2020 7970 7473 2e61  nd(d).    ypts.a
+0002c720: 7070 656e 6428 3029 0a20 2020 2078 7074  ppend(0).    xpt
+0002c730: 732e 6170 7065 6e64 2864 290a 2020 2020  s.append(d).    
+0002c740: 7970 7473 2e61 7070 656e 6428 7769 6474  ypts.append(widt
+0002c750: 6829 0a20 2020 2078 7074 732e 6170 7065  h).    xpts.appe
+0002c760: 6e64 2878 7074 735b 305d 290a 2020 2020  nd(xpts[0]).    
+0002c770: 7970 7473 2e61 7070 656e 6428 7970 7473  ypts.append(ypts
+0002c780: 5b30 5d29 0a0a 2020 2020 442e 6164 645f  [0])..    D.add_
+0002c790: 706f 6c79 676f 6e28 5b78 7074 732c 2079  polygon([xpts, y
+0002c7a0: 7074 735d 2c20 6c61 7965 723d 6c61 7965  pts], layer=laye
+0002c7b0: 7229 0a0a 2020 2020 442e 6164 645f 706f  r)..    D.add_po
+0002c7c0: 7274 286e 616d 653d 312c 206d 6964 706f  rt(name=1, midpo
+0002c7d0: 696e 743d 5b61 202f 2034 2c20 645d 2c20  int=[a / 4, d], 
+0002c7e0: 7769 6474 683d 6120 2f20 322c 206f 7269  width=a / 2, ori
+0002c7f0: 656e 7461 7469 6f6e 3d39 3029 0a20 2020  entation=90).   
+0002c800: 2044 2e61 6464 5f70 6f72 7428 6e61 6d65   D.add_port(name
+0002c810: 3d32 2c20 6d69 6470 6f69 6e74 3d5b 642c  =2, midpoint=[d,
+0002c820: 2061 202f 2034 5d2c 2077 6964 7468 3d61   a / 4], width=a
+0002c830: 202f 2032 2c20 6f72 6965 6e74 6174 696f   / 2, orientatio
+0002c840: 6e3d 3029 0a20 2020 2072 6574 7572 6e20  n=0).    return 
+0002c850: 440a 0a0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d  D...# ==========
+0002c860: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002c870: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002c880: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002c890: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002c8a0: 3d3d 3d3d 0a23 2045 7861 6d70 6c65 2063  ====.# Example c
+0002c8b0: 6f64 650a 2320 3d3d 3d3d 3d3d 3d3d 3d3d  ode.# ==========
+0002c8c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002c8d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002c8e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002c8f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002c900: 3d3d 3d3d 0a0a 2320 6861 6972 7069 6e20  ====..# hairpin 
 0002c910: 3d20 6f70 7469 6d61 6c5f 6861 6972 7069  = optimal_hairpi
-0002c920: 6e28 0a20 2020 2020 2020 2077 6964 7468  n(.        width
-0002c930: 3d77 6972 655f 7769 6474 682c 0a20 2020  =wire_width,.   
-0002c940: 2020 2020 2070 6974 6368 3d77 6972 655f       pitch=wire_
-0002c950: 7069 7463 682c 0a20 2020 2020 2020 2074  pitch,.        t
-0002c960: 7572 6e5f 7261 7469 6f3d 7475 726e 5f72  urn_ratio=turn_r
-0002c970: 6174 696f 2c0a 2020 2020 2020 2020 6c65  atio,.        le
-0002c980: 6e67 7468 3d78 7369 7a65 202f 2032 2c0a  ngth=xsize / 2,.
-0002c990: 2020 2020 2020 2020 6e75 6d5f 7074 733d          num_pts=
-0002c9a0: 3230 2c0a 2020 2020 2020 2020 6c61 7965  20,.        laye
-0002c9b0: 723d 6c61 7965 722c 0a20 2020 2029 0a0a  r=layer,.    )..
-0002c9c0: 2020 2020 6966 2028 7465 726d 696e 616c      if (terminal
-0002c9d0: 735f 7361 6d65 5f73 6964 6520 6973 2046  s_same_side is F
-0002c9e0: 616c 7365 2920 616e 6420 2828 6e75 6d5f  alse) and ((num_
-0002c9f0: 6d65 616e 6465 7273 2025 2032 2920 3d3d  meanders % 2) ==
-0002ca00: 2030 293a 0a20 2020 2020 2020 206e 756d   0):.        num
-0002ca10: 5f6d 6561 6e64 6572 7320 2b3d 2031 0a20  _meanders += 1. 
-0002ca20: 2020 2065 6c69 6620 2874 6572 6d69 6e61     elif (termina
-0002ca30: 6c73 5f73 616d 655f 7369 6465 2069 7320  ls_same_side is 
-0002ca40: 5472 7565 2920 616e 6420 2828 6e75 6d5f  True) and ((num_
-0002ca50: 6d65 616e 6465 7273 2025 2032 2920 3d3d  meanders % 2) ==
-0002ca60: 2031 293a 0a20 2020 2020 2020 206e 756d   1):.        num
-0002ca70: 5f6d 6561 6e64 6572 7320 2b3d 2031 0a0a  _meanders += 1..
-0002ca80: 2020 2020 7374 6172 745f 6e77 203d 2044      start_nw = D
-0002ca90: 2e61 6464 5f72 6566 2863 6f6d 7061 7373  .add_ref(compass
-0002caa0: 2873 697a 653d 5b78 7369 7a65 202f 2032  (size=[xsize / 2
-0002cab0: 2c20 7769 7265 5f77 6964 7468 5d2c 206c  , wire_width], l
-0002cac0: 6179 6572 3d6c 6179 6572 2929 0a0a 2020  ayer=layer))..  
-0002cad0: 2020 6870 5f70 7265 7620 3d20 442e 6164    hp_prev = D.ad
-0002cae0: 645f 7265 6628 6861 6972 7069 6e29 0a20  d_ref(hairpin). 
-0002caf0: 2020 2068 705f 7072 6576 2e63 6f6e 6e65     hp_prev.conne
-0002cb00: 6374 2831 2c20 7374 6172 745f 6e77 2e70  ct(1, start_nw.p
-0002cb10: 6f72 7473 5b22 4522 5d29 0a20 2020 2061  orts["E"]).    a
-0002cb20: 6c74 6572 6e61 7465 203d 2054 7275 650a  lternate = True.
-0002cb30: 2020 2020 666f 7220 6e20 696e 2072 616e      for n in ran
-0002cb40: 6765 2832 2c20 6e75 6d5f 6d65 616e 6465  ge(2, num_meande
-0002cb50: 7273 293a 0a20 2020 2020 2020 2068 7020  rs):.        hp 
-0002cb60: 3d20 442e 6164 645f 7265 6628 6861 6972  = D.add_ref(hair
-0002cb70: 7069 6e29 0a20 2020 2020 2020 2069 6620  pin).        if 
-0002cb80: 616c 7465 726e 6174 653a 0a20 2020 2020  alternate:.     
-0002cb90: 2020 2020 2020 2068 702e 636f 6e6e 6563         hp.connec
-0002cba0: 7428 322c 2068 705f 7072 6576 2e70 6f72  t(2, hp_prev.por
-0002cbb0: 7473 5b32 5d29 0a20 2020 2020 2020 2020  ts[2]).         
-0002cbc0: 2020 206c 6173 745f 706f 7274 203d 2068     last_port = h
-0002cbd0: 702e 706f 7274 735b 315d 0a20 2020 2020  p.ports[1].     
-0002cbe0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002cbf0: 2020 2020 2068 702e 636f 6e6e 6563 7428       hp.connect(
-0002cc00: 312c 2068 705f 7072 6576 2e70 6f72 7473  1, hp_prev.ports
-0002cc10: 5b31 5d29 0a20 2020 2020 2020 2020 2020  [1]).           
-0002cc20: 206c 6173 745f 706f 7274 203d 2068 702e   last_port = hp.
-0002cc30: 706f 7274 735b 325d 0a20 2020 2020 2020  ports[2].       
-0002cc40: 2068 705f 7072 6576 203d 2068 700a 2020   hp_prev = hp.  
-0002cc50: 2020 2020 2020 616c 7465 726e 6174 6520        alternate 
-0002cc60: 3d20 6e6f 7420 616c 7465 726e 6174 650a  = not alternate.
-0002cc70: 0a20 2020 2066 696e 6973 685f 7365 203d  .    finish_se =
-0002cc80: 2044 2e61 6464 5f72 6566 2863 6f6d 7061   D.add_ref(compa
-0002cc90: 7373 2873 697a 653d 5b78 7369 7a65 202f  ss(size=[xsize /
-0002cca0: 2032 2c20 7769 7265 5f77 6964 7468 5d2c   2, wire_width],
-0002ccb0: 206c 6179 6572 3d6c 6179 6572 2929 0a20   layer=layer)). 
-0002ccc0: 2020 2066 696e 6973 685f 7365 2e63 6f6e     finish_se.con
-0002ccd0: 6e65 6374 2822 4522 2c20 6c61 7374 5f70  nect("E", last_p
-0002cce0: 6f72 7429 0a0a 2020 2020 442e 6164 645f  ort)..    D.add_
-0002ccf0: 706f 7274 2870 6f72 743d 7374 6172 745f  port(port=start_
-0002cd00: 6e77 2e70 6f72 7473 5b22 5722 5d2c 206e  nw.ports["W"], n
-0002cd10: 616d 653d 3129 0a20 2020 2044 2e61 6464  ame=1).    D.add
-0002cd20: 5f70 6f72 7428 706f 7274 3d66 696e 6973  _port(port=finis
-0002cd30: 685f 7365 2e70 6f72 7473 5b22 5722 5d2c  h_se.ports["W"],
-0002cd40: 206e 616d 653d 3229 0a0a 2020 2020 442e   name=2)..    D.
-0002cd50: 696e 666f 5b22 6e75 6d5f 7371 7561 7265  info["num_square
-0002cd60: 7322 5d20 3d20 6e75 6d5f 6d65 616e 6465  s"] = num_meande
-0002cd70: 7273 202a 2028 7873 697a 6520 2f20 7769  rs * (xsize / wi
-0002cd80: 7265 5f77 6964 7468 290a 2020 2020 442e  re_width).    D.
-0002cd90: 696e 666f 5b22 6172 6561 225d 203d 2078  info["area"] = x
-0002cda0: 7369 7a65 202a 2079 7369 7a65 0a20 2020  size * ysize.   
-0002cdb0: 2044 2e69 6e66 6f5b 2273 697a 6522 5d20   D.info["size"] 
-0002cdc0: 3d20 2878 7369 7a65 2c20 7973 697a 6529  = (xsize, ysize)
-0002cdd0: 0a0a 2020 2020 7265 7475 726e 2044 0a0a  ..    return D..
-0002cde0: 0a64 6566 2073 6e73 7064 5f65 7870 616e  .def snspd_expan
-0002cdf0: 6465 6428 0a20 2020 2077 6972 655f 7769  ded(.    wire_wi
-0002ce00: 6474 683d 302e 322c 0a20 2020 2077 6972  dth=0.2,.    wir
-0002ce10: 655f 7069 7463 683d 302e 362c 0a20 2020  e_pitch=0.6,.   
-0002ce20: 2073 697a 653d 2831 302c 2038 292c 0a20   size=(10, 8),. 
-0002ce30: 2020 206e 756d 5f73 7175 6172 6573 3d4e     num_squares=N
-0002ce40: 6f6e 652c 0a20 2020 2063 6f6e 6e65 6374  one,.    connect
-0002ce50: 6f72 5f77 6964 7468 3d31 2c0a 2020 2020  or_width=1,.    
-0002ce60: 636f 6e6e 6563 746f 725f 7379 6d6d 6574  connector_symmet
-0002ce70: 7269 633d 4661 6c73 652c 0a20 2020 2074  ric=False,.    t
-0002ce80: 7572 6e5f 7261 7469 6f3d 342c 0a20 2020  urn_ratio=4,.   
-0002ce90: 2074 6572 6d69 6e61 6c73 5f73 616d 655f   terminals_same_
-0002cea0: 7369 6465 3d46 616c 7365 2c0a 2020 2020  side=False,.    
-0002ceb0: 6c61 7965 723d 302c 0a29 3a0a 2020 2020  layer=0,.):.    
-0002cec0: 2222 2243 7265 6174 6573 2061 6e20 6f70  """Creates an op
-0002ced0: 7469 6d61 6c6c 792d 726f 756e 6465 6420  timally-rounded 
-0002cee0: 534e 5350 4420 7769 7468 2077 6972 6573  SNSPD with wires
-0002cef0: 2063 6f6d 696e 6720 6f75 7420 6f66 2069   coming out of i
-0002cf00: 7420 7468 6174 0a20 2020 2065 7870 616e  t that.    expan
-0002cf10: 642e 0a0a 2020 2020 5061 7261 6d65 7465  d...    Paramete
-0002cf20: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-0002cf30: 2d0a 2020 2020 7769 6474 6820 3a20 696e  -.    width : in
-0002cf40: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
-0002cf50: 2020 2057 6964 7468 206f 6620 7468 6520     Width of the 
-0002cf60: 7769 7265 2e0a 2020 2020 7069 7463 6820  wire..    pitch 
-0002cf70: 3a20 696e 7420 6f72 2066 6c6f 6174 0a20  : int or float. 
-0002cf80: 2020 2020 2020 2044 6973 7461 6e63 6520         Distance 
-0002cf90: 6265 7477 6565 6e20 7477 6f20 6164 6a61  between two adja
-0002cfa0: 6365 6e74 2077 6972 6573 2e20 4d75 7374  cent wires. Must
-0002cfb0: 2062 6520 6772 6561 7465 7220 7468 616e   be greater than
-0002cfc0: 2060 7769 6474 6860 2e0a 2020 2020 7369   `width`..    si
-0002cfd0: 7a65 203a 204e 6f6e 6520 6f72 2061 7272  ze : None or arr
-0002cfe0: 6179 2d6c 696b 655b 325d 206f 6620 696e  ay-like[2] of in
-0002cff0: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
-0002d000: 2020 2028 7769 6474 682c 2068 6569 6768     (width, heigh
-0002d010: 7429 206f 6620 7468 6520 7265 6374 616e  t) of the rectan
-0002d020: 676c 6520 666f 726d 6564 2062 7920 7468  gle formed by th
-0002d030: 6520 6f75 7465 7220 626f 756e 6461 7279  e outer boundary
-0002d040: 206f 6620 7468 650a 2020 2020 2020 2020   of the.        
-0002d050: 534e 5350 442e 204d 7573 7420 6265 206e  SNSPD. Must be n
-0002d060: 6f6e 6520 6966 2060 6e75 6d5f 7371 7561  one if `num_squa
-0002d070: 7265 7360 2069 7320 7370 6563 6966 6965  res` is specifie
-0002d080: 642e 0a20 2020 206e 756d 5f73 7175 6172  d..    num_squar
-0002d090: 6573 203a 2069 6e74 206f 7220 4e6f 6e65  es : int or None
-0002d0a0: 0a20 2020 2020 2020 2054 6f74 616c 206e  .        Total n
-0002d0b0: 756d 6265 7220 6f66 2073 7175 6172 6573  umber of squares
-0002d0c0: 2069 6e73 6964 6520 7468 6520 534e 5350   inside the SNSP
-0002d0d0: 4420 6c65 6e67 7468 2e20 4d75 7374 2062  D length. Must b
-0002d0e0: 6520 6e6f 6e65 2069 660a 2020 2020 2020  e none if.      
-0002d0f0: 2020 6073 697a 6560 2069 7320 7370 6563    `size` is spec
-0002d100: 6966 6965 642e 0a20 2020 2063 6f6e 6e65  ified..    conne
-0002d110: 6374 6f72 5f77 6964 7468 203a 2069 6e74  ctor_width : int
-0002d120: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
-0002d130: 2020 5769 6474 6820 6f66 2074 6865 2063    Width of the c
-0002d140: 6f6e 6e65 6374 6f72 732e 0a20 2020 2063  onnectors..    c
-0002d150: 6f6e 6e65 6374 6f72 5f73 796d 6d65 7472  onnector_symmetr
-0002d160: 6963 203a 2062 6f6f 6c0a 2020 2020 2020  ic : bool.      
-0002d170: 2020 4966 2054 7275 652c 206d 6972 726f    If True, mirro
-0002d180: 7273 2074 6865 2063 6f6e 6e65 6374 6f72  rs the connector
-0002d190: 7320 6163 726f 7373 2074 6865 6972 2066  s across their f
-0002d1a0: 6c61 7420 6564 6765 2061 6e64 2061 6464  lat edge and add
-0002d1b0: 7320 7468 656d 0a20 2020 2020 2020 2074  s them.        t
-0002d1c0: 6f20 7468 6520 636f 6e6e 6563 746f 7220  o the connector 
-0002d1d0: 6765 6f6d 6574 7279 2e0a 2020 2020 7475  geometry..    tu
-0002d1e0: 726e 5f72 6174 696f 203a 2069 6e74 206f  rn_ratio : int o
-0002d1f0: 7220 666c 6f61 740a 2020 2020 2020 2020  r float.        
-0002d200: 5370 6563 6966 6965 7320 686f 7720 6d75  Specifies how mu
-0002d210: 6368 206f 6620 7468 6520 534e 5350 4420  ch of the SNSPD 
-0002d220: 7769 6474 6820 6973 2064 6564 6963 6174  width is dedicat
-0002d230: 6564 2074 6f20 7468 6520 3138 3020 6465  ed to the 180 de
-0002d240: 6772 6565 0a20 2020 2020 2020 2074 7572  gree.        tur
-0002d250: 6e2e 2041 2060 7475 726e 5f72 6174 696f  n. A `turn_ratio
-0002d260: 6020 6f66 2031 3020 7769 6c6c 2072 6573  ` of 10 will res
-0002d270: 756c 7420 696e 2032 3025 206f 6620 7468  ult in 20% of th
-0002d280: 6520 7769 6474 6820 6265 696e 670a 2020  e width being.  
-0002d290: 2020 2020 2020 636f 6d70 7269 7365 6420        comprised 
-0002d2a0: 6f66 2074 6865 2074 7572 6e2e 0a20 2020  of the turn..   
-0002d2b0: 2074 6572 6d69 6e61 6c73 5f73 616d 655f   terminals_same_
-0002d2c0: 7369 6465 203a 2062 6f6f 6c0a 2020 2020  side : bool.    
-0002d2d0: 2020 2020 4966 2054 7275 652c 2062 6f74      If True, bot
-0002d2e0: 6820 706f 7274 7320 7769 6c6c 2062 6520  h ports will be 
-0002d2f0: 6c6f 6361 7465 6420 6f6e 2074 6865 2073  located on the s
-0002d300: 616d 6520 7369 6465 206f 6620 7468 6520  ame side of the 
-0002d310: 534e 5350 442e 0a20 2020 206c 6179 6572  SNSPD..    layer
-0002d320: 203a 2069 6e74 2c20 6172 7261 792d 6c69   : int, array-li
-0002d330: 6b65 5b32 5d2c 206f 7220 7365 740a 2020  ke[2], or set.  
-0002d340: 2020 2020 2020 5370 6563 6966 6963 206c        Specific l
-0002d350: 6179 6572 2873 2920 746f 2070 7574 2070  ayer(s) to put p
-0002d360: 6f6c 7967 6f6e 2067 656f 6d65 7472 7920  olygon geometry 
-0002d370: 6f6e 2e0a 0a20 2020 2052 6574 7572 6e73  on...    Returns
-0002d380: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-0002d390: 2044 203a 2044 6576 6963 650a 2020 2020   D : Device.    
-0002d3a0: 2020 2020 4120 4465 7669 6365 2063 6f6e      A Device con
-0002d3b0: 7461 696e 696e 6720 616e 206f 7074 696d  taining an optim
-0002d3c0: 616c 6c79 2d72 6f75 6e64 6564 2053 4e53  ally-rounded SNS
-0002d3d0: 5044 2077 6974 6820 6578 7061 6e64 696e  PD with expandin
-0002d3e0: 6720 696e 7075 742f 0a20 2020 2020 2020  g input/.       
-0002d3f0: 206f 7574 7075 7420 7769 7265 732e 0a20   output wires.. 
-0002d400: 2020 2022 2222 0a20 2020 2044 203d 2044     """.    D = D
-0002d410: 6576 6963 6528 2273 6e73 7064 5f65 7870  evice("snspd_exp
-0002d420: 616e 6465 6422 290a 2020 2020 5320 3d20  anded").    S = 
-0002d430: 736e 7370 6428 0a20 2020 2020 2020 2077  snspd(.        w
-0002d440: 6972 655f 7769 6474 683d 7769 7265 5f77  ire_width=wire_w
-0002d450: 6964 7468 2c0a 2020 2020 2020 2020 7769  idth,.        wi
-0002d460: 7265 5f70 6974 6368 3d77 6972 655f 7069  re_pitch=wire_pi
-0002d470: 7463 682c 0a20 2020 2020 2020 2073 697a  tch,.        siz
-0002d480: 653d 7369 7a65 2c0a 2020 2020 2020 2020  e=size,.        
-0002d490: 6e75 6d5f 7371 7561 7265 733d 6e75 6d5f  num_squares=num_
-0002d4a0: 7371 7561 7265 732c 0a20 2020 2020 2020  squares,.       
-0002d4b0: 2074 7572 6e5f 7261 7469 6f3d 7475 726e   turn_ratio=turn
-0002d4c0: 5f72 6174 696f 2c0a 2020 2020 2020 2020  _ratio,.        
-0002d4d0: 7465 726d 696e 616c 735f 7361 6d65 5f73  terminals_same_s
-0002d4e0: 6964 653d 7465 726d 696e 616c 735f 7361  ide=terminals_sa
-0002d4f0: 6d65 5f73 6964 652c 0a20 2020 2020 2020  me_side,.       
-0002d500: 206c 6179 6572 3d6c 6179 6572 2c0a 2020   layer=layer,.  
-0002d510: 2020 290a 2020 2020 7320 3d20 442e 6164    ).    s = D.ad
-0002d520: 645f 7265 6628 5329 0a20 2020 2073 7465  d_ref(S).    ste
-0002d530: 705f 6465 7669 6365 203d 206f 7074 696d  p_device = optim
-0002d540: 616c 5f73 7465 7028 0a20 2020 2020 2020  al_step(.       
-0002d550: 2073 7461 7274 5f77 6964 7468 3d77 6972   start_width=wir
-0002d560: 655f 7769 6474 682c 0a20 2020 2020 2020  e_width,.       
-0002d570: 2065 6e64 5f77 6964 7468 3d63 6f6e 6e65   end_width=conne
-0002d580: 6374 6f72 5f77 6964 7468 2c0a 2020 2020  ctor_width,.    
-0002d590: 2020 2020 6e75 6d5f 7074 733d 3130 302c      num_pts=100,
-0002d5a0: 0a20 2020 2020 2020 2061 6e74 6963 726f  .        anticro
-0002d5b0: 7764 696e 675f 6661 6374 6f72 3d32 2c0a  wding_factor=2,.
-0002d5c0: 2020 2020 2020 2020 7769 6474 685f 746f          width_to
-0002d5d0: 6c3d 3165 2d33 2c0a 2020 2020 2020 2020  l=1e-3,.        
-0002d5e0: 7379 6d6d 6574 7269 633d 636f 6e6e 6563  symmetric=connec
-0002d5f0: 746f 725f 7379 6d6d 6574 7269 632c 0a20  tor_symmetric,. 
-0002d600: 2020 2020 2020 206c 6179 6572 3d6c 6179         layer=lay
-0002d610: 6572 2c0a 2020 2020 290a 2020 2020 7374  er,.    ).    st
-0002d620: 6570 3120 3d20 442e 6164 645f 7265 6628  ep1 = D.add_ref(
-0002d630: 7374 6570 5f64 6576 6963 6529 0a20 2020  step_device).   
-0002d640: 2073 7465 7032 203d 2044 2e61 6464 5f72   step2 = D.add_r
-0002d650: 6566 2873 7465 705f 6465 7669 6365 290a  ef(step_device).
-0002d660: 2020 2020 7374 6570 312e 636f 6e6e 6563      step1.connec
-0002d670: 7428 706f 7274 3d31 2c20 6465 7374 696e  t(port=1, destin
-0002d680: 6174 696f 6e3d 732e 706f 7274 735b 315d  ation=s.ports[1]
-0002d690: 290a 2020 2020 7374 6570 322e 636f 6e6e  ).    step2.conn
-0002d6a0: 6563 7428 706f 7274 3d31 2c20 6465 7374  ect(port=1, dest
-0002d6b0: 696e 6174 696f 6e3d 732e 706f 7274 735b  ination=s.ports[
-0002d6c0: 325d 290a 2020 2020 442e 6164 645f 706f  2]).    D.add_po
-0002d6d0: 7274 286e 616d 653d 312c 2070 6f72 743d  rt(name=1, port=
-0002d6e0: 7374 6570 312e 706f 7274 735b 325d 290a  step1.ports[2]).
-0002d6f0: 2020 2020 442e 6164 645f 706f 7274 286e      D.add_port(n
-0002d700: 616d 653d 322c 2070 6f72 743d 7374 6570  ame=2, port=step
-0002d710: 322e 706f 7274 735b 325d 290a 0a20 2020  2.ports[2])..   
-0002d720: 2044 2e69 6e66 6f20 3d20 532e 696e 666f   D.info = S.info
-0002d730: 0a20 2020 2053 2e69 6e66 6f20 3d20 7b7d  .    S.info = {}
-0002d740: 0a0a 2020 2020 7265 7475 726e 2044 0a0a  ..    return D..
-0002d750: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
-0002d760: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002d770: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002d780: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002d790: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002d7a0: 3d0a 2320 4578 616d 706c 6520 636f 6465  =.# Example code
-0002d7b0: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
-0002d7c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002d7d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002d7e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002d7f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002d800: 3d0a 0a23 2073 203d 2073 6e73 7064 2877  =..# s = snspd(w
-0002d810: 6972 655f 7769 6474 6820 3d20 302e 322c  ire_width = 0.2,
-0002d820: 2077 6972 655f 7069 7463 6820 3d20 302e   wire_pitch = 0.
-0002d830: 362c 2073 697a 6520 3d20 5b31 302c 335d  6, size = [10,3]
-0002d840: 2c20 7465 726d 696e 616c 735f 7361 6d65  , terminals_same
-0002d850: 5f73 6964 6520 3d20 5472 7565 290a 2320  _side = True).# 
-0002d860: 7175 6963 6b70 6c6f 7428 7329 0a0a 2320  quickplot(s)..# 
-0002d870: 7320 3d20 736e 7370 6428 7769 7265 5f77  s = snspd(wire_w
-0002d880: 6964 7468 203d 2030 2e32 2c20 7769 7265  idth = 0.2, wire
-0002d890: 5f70 6974 6368 203d 2030 2e36 2c20 7369  _pitch = 0.6, si
-0002d8a0: 7a65 203d 205b 3130 2c20 4e6f 6e65 5d2c  ze = [10, None],
-0002d8b0: 0a23 2020 2020 2020 2020 2020 6e75 6d5f  .#          num_
-0002d8c0: 7371 7561 7265 7320 3d20 3130 3030 2c20  squares = 1000, 
-0002d8d0: 7465 726d 696e 616c 735f 7361 6d65 5f73  terminals_same_s
-0002d8e0: 6964 6520 3d20 5472 7565 290a 2320 7175  ide = True).# qu
-0002d8f0: 6963 6b70 6c6f 7428 7329 0a0a 0a64 6566  ickplot(s)...def
-0002d900: 2073 6e73 7064 5f63 616e 6465 6c61 6272   snspd_candelabr
-0002d910: 6128 2020 2320 6e6f 7161 3a20 4339 3031  a(  # noqa: C901
-0002d920: 0a20 2020 2077 6972 655f 7769 6474 683d  .    wire_width=
-0002d930: 302e 3532 2c0a 2020 2020 7769 7265 5f70  0.52,.    wire_p
-0002d940: 6974 6368 3d30 2e35 362c 0a20 2020 2068  itch=0.56,.    h
-0002d950: 6178 6973 3d39 302c 0a20 2020 2076 6178  axis=90,.    vax
-0002d960: 6973 3d35 302c 0a20 2020 2065 7175 616c  is=50,.    equal
-0002d970: 697a 655f 7061 7468 5f6c 656e 6774 6873  ize_path_lengths
-0002d980: 3d46 616c 7365 2c0a 2020 2020 7877 696e  =False,.    xwin
-0002d990: 673d 4661 6c73 652c 0a20 2020 206c 6179  g=False,.    lay
-0002d9a0: 6572 3d30 2c0a 293a 0a20 2020 2022 2222  er=0,.):.    """
-0002d9b0: 4372 6561 7465 7320 616e 206f 7074 696d  Creates an optim
-0002d9c0: 616c 6c79 2d72 6f75 6e64 6564 2053 4e53  ally-rounded SNS
-0002d9d0: 5044 2077 6974 6820 6c6f 7720 6375 7272  PD with low curr
-0002d9e0: 656e 7420 6372 6f77 6469 6e67 2061 6e64  ent crowding and
-0002d9f0: 0a20 2020 2061 7262 7469 7472 6172 696c  .    arbtitraril
-0002da00: 792d 6869 6768 2066 696c 6c20 6661 6374  y-high fill fact
-0002da10: 6f72 2061 7320 6465 7363 7269 6265 6420  or as described 
-0002da20: 6279 2052 6564 6479 2065 742e 2061 6c2e  by Reddy et. al.
-0002da30: 2c0a 2020 2020 4150 4c20 5068 6f74 6f6e  ,.    APL Photon
-0002da40: 6963 7320 372c 2030 3531 3330 3220 2832  ics 7, 051302 (2
-0002da50: 3032 3229 2020 6874 7470 733a 2f2f 646f  022)  https://do
-0002da60: 692e 6f72 672f 3130 2e31 3036 332f 352e  i.org/10.1063/5.
-0002da70: 3030 3838 3030 370a 0a20 2020 2050 6172  0088007..    Par
-0002da80: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-0002da90: 2d2d 2d2d 2d2d 0a20 2020 2077 6972 655f  ------.    wire_
-0002daa0: 7769 6474 6820 3a20 696e 7420 6f72 2066  width : int or f
-0002dab0: 6c6f 6174 0a20 2020 2020 2020 2057 6964  loat.        Wid
-0002dac0: 7468 206f 6620 7468 6520 7769 7265 2e0a  th of the wire..
-0002dad0: 2020 2020 7769 7265 5f70 6974 6368 203a      wire_pitch :
-0002dae0: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
-0002daf0: 2020 2020 2020 4469 7374 616e 6365 2062        Distance b
-0002db00: 6574 7765 656e 2074 776f 2061 646a 6163  etween two adjac
-0002db10: 656e 7420 7769 7265 732e 204d 7573 7420  ent wires. Must 
-0002db20: 6265 2067 7265 6174 6572 2074 6861 6e20  be greater than 
-0002db30: 6077 6964 7468 602e 0a20 2020 2068 6178  `width`..    hax
-0002db40: 6973 203a 2069 6e74 206f 7220 666c 6f61  is : int or floa
-0002db50: 740a 2020 2020 2020 2020 4c65 6e67 7468  t.        Length
-0002db60: 206f 6620 686f 7269 7a6f 6e74 616c 2064   of horizontal d
-0002db70: 6961 676f 6e61 6c20 6f66 2074 6865 2072  iagonal of the r
-0002db80: 686f 6d62 6f69 6461 6c20 6163 7469 7665  homboidal active
-0002db90: 2061 7265 612e 0a20 2020 2020 2020 2054   area..        T
-0002dba0: 6865 2070 6172 616d 6574 6572 2060 6861  he parameter `ha
-0002dbb0: 7869 7360 2069 7320 7072 696f 7269 7469  xis` is prioriti
-0002dbc0: 7a65 6420 6f76 6572 2060 7661 7869 7360  zed over `vaxis`
-0002dbd0: 2e0a 2020 2020 7661 7869 7320 3a20 696e  ..    vaxis : in
-0002dbe0: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
-0002dbf0: 2020 204c 656e 6774 6820 6f66 2076 6572     Length of ver
-0002dc00: 7469 6361 6c20 6469 6167 6f6e 616c 206f  tical diagonal o
-0002dc10: 6620 7468 6520 7268 6f6d 626f 6964 616c  f the rhomboidal
-0002dc20: 2061 6374 6976 6520 6172 6561 2e0a 2020   active area..  
-0002dc30: 2020 6571 7561 6c69 7a65 5f70 6174 685f    equalize_path_
-0002dc40: 6c65 6e67 7468 7320 3a20 626f 6f6c 0a20  lengths : bool. 
-0002dc50: 2020 2020 2020 2049 6620 5472 7565 2c20         If True, 
-0002dc60: 6164 6473 2077 6972 6520 7365 676d 656e  adds wire segmen
-0002dc70: 7473 2074 6f20 6861 6972 7069 6e20 6265  ts to hairpin be
-0002dc80: 6e64 7320 746f 2065 7175 616c 697a 6520  nds to equalize 
-0002dc90: 7061 7468 206c 656e 6774 6873 0a20 2020  path lengths.   
-0002dca0: 2020 2020 2066 726f 6d20 6365 6e74 6572       from center
-0002dcb0: 2074 6f20 6365 6e74 6572 2066 6f72 2061   to center for a
-0002dcc0: 6c6c 2070 6172 616c 6c65 6c20 7769 7265  ll parallel wire
-0002dcd0: 7320 696e 2061 6374 6976 6520 6172 6561  s in active area
-0002dce0: 2e0a 2020 2020 7877 696e 6720 3a20 626f  ..    xwing : bo
-0002dcf0: 6f6c 0a20 2020 2020 2020 2049 6620 5472  ol.        If Tr
-0002dd00: 7565 2c20 7265 706c 6163 6573 2039 302d  ue, replaces 90-
-0002dd10: 6465 6772 6565 2062 656e 6473 2077 6974  degree bends wit
-0002dd20: 6820 3133 352d 6465 6772 6565 2062 656e  h 135-degree ben
-0002dd30: 6473 2e0a 2020 2020 6c61 7965 7220 3a20  ds..    layer : 
-0002dd40: 696e 740a 2020 2020 2020 2020 5370 6563  int.        Spec
-0002dd50: 6966 6963 206c 6179 6572 2074 6f20 7075  ific layer to pu
-0002dd60: 7420 706f 6c79 676f 6e20 6765 6f6d 6574  t polygon geomet
-0002dd70: 7279 206f 6e2e 0a0a 2020 2020 5265 7475  ry on...    Retu
-0002dd80: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-0002dd90: 2020 2020 4420 3a20 4465 7669 6365 0a20      D : Device. 
-0002dda0: 2020 2020 2020 2041 2044 6576 6963 6520         A Device 
-0002ddb0: 636f 6e74 6169 6e69 6e67 2061 6e20 6f70  containing an op
-0002ddc0: 7469 6d61 6c6c 792d 726f 756e 6465 6420  timally-rounded 
-0002ddd0: 534e 5350 4420 7769 7468 206d 696e 696d  SNSPD with minim
-0002dde0: 697a 6564 2063 7572 7265 6e74 0a20 2020  ized current.   
-0002ddf0: 2020 2020 2063 726f 7764 696e 6720 666f       crowding fo
-0002de00: 7220 616e 7920 6669 6c6c 2066 6163 746f  r any fill facto
-0002de10: 722e 0a20 2020 2022 2222 0a0a 2020 2020  r..    """..    
-0002de20: 6465 6620 6f66 665f 6178 6973 5f75 7475  def off_axis_utu
-0002de30: 726e 280a 2020 2020 2020 2020 7769 7265  rn(.        wire
-0002de40: 5f77 6964 7468 3d30 2e35 322c 0a20 2020  _width=0.52,.   
-0002de50: 2020 2020 2077 6972 655f 7069 7463 683d       wire_pitch=
-0002de60: 302e 3536 2c0a 2020 2020 2020 2020 7066  0.56,.        pf
-0002de70: 6163 743d 3130 2e30 202f 2033 2c0a 2020  act=10.0 / 3,.  
-0002de80: 2020 2020 2020 7368 6172 703d 4661 6c73        sharp=Fals
-0002de90: 652c 0a20 2020 2020 2020 2070 6164 5f6c  e,.        pad_l
-0002dea0: 656e 6774 683d 302c 0a20 2020 2020 2020  ength=0,.       
-0002deb0: 206c 6179 6572 3d30 2c0a 2020 2020 293a   layer=0,.    ):
-0002dec0: 0a20 2020 2020 2020 2022 2222 5265 7475  .        """Retu
-0002ded0: 726e 7320 7068 6964 6c20 6465 7669 6365  rns phidl device
-0002dee0: 206c 6f77 2d63 726f 7764 696e 6720 752d   low-crowding u-
-0002def0: 7475 726e 2066 6f72 2063 616e 6465 6c61  turn for candela
-0002df00: 6272 6120 6d65 616e 6465 722e 2222 220a  bra meander.""".
-0002df10: 2020 2020 2020 2020 6261 7263 203d 206f          barc = o
-0002df20: 7074 696d 616c 5f39 3064 6567 2877 6964  ptimal_90deg(wid
-0002df30: 7468 3d77 6972 655f 7769 6474 682c 206c  th=wire_width, l
-0002df40: 6179 6572 3d6c 6179 6572 290a 2020 2020  ayer=layer).    
-0002df50: 2020 2020 6966 206e 6f74 2073 6861 7270      if not sharp
-0002df60: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0002df70: 466f 7220 6e6f 6e2d 726f 756e 6465 6420  For non-rounded 
-0002df80: 6f75 7465 7220 7261 6469 690a 2020 2020  outer radii.    
-0002df90: 2020 2020 2020 2020 2320 4e6f 7420 6675          # Not fu
-0002dfa0: 6c6c 7920 696d 706c 656d 656e 7465 640a  lly implemented.
-0002dfb0: 2020 2020 2020 2020 2020 2020 706f 7274              port
-0002dfc0: 316d 7020 3d20 5b62 6172 632e 706f 7274  1mp = [barc.port
-0002dfd0: 735b 315d 2e78 2c20 6261 7263 2e70 6f72  s[1].x, barc.por
-0002dfe0: 7473 5b31 5d2e 795d 0a20 2020 2020 2020  ts[1].y].       
-0002dff0: 2020 2020 2070 6f72 7431 6f72 203d 2062       port1or = b
-0002e000: 6172 632e 706f 7274 735b 315d 2e6f 7269  arc.ports[1].ori
-0002e010: 656e 7461 7469 6f6e 0a20 2020 2020 2020  entation.       
-0002e020: 2020 2020 2070 6f72 7432 6d70 203d 205b       port2mp = [
-0002e030: 6261 7263 2e70 6f72 7473 5b32 5d2e 782c  barc.ports[2].x,
-0002e040: 2062 6172 632e 706f 7274 735b 325d 2e79   barc.ports[2].y
-0002e050: 5d0a 2020 2020 2020 2020 2020 2020 706f  ].            po
-0002e060: 7274 326f 7220 3d20 6261 7263 2e70 6f72  rt2or = barc.por
-0002e070: 7473 5b32 5d2e 6f72 6965 6e74 6174 696f  ts[2].orientatio
-0002e080: 6e0a 2020 2020 2020 2020 2020 2020 6261  n.            ba
-0002e090: 7263 203d 2062 6f6f 6c65 616e 280a 2020  rc = boolean(.  
-0002e0a0: 2020 2020 2020 2020 2020 2020 2020 413d                A=
-0002e0b0: 6261 7263 2c0a 2020 2020 2020 2020 2020  barc,.          
-0002e0c0: 2020 2020 2020 423d 636f 7079 2862 6172        B=copy(bar
-0002e0d0: 6329 2e6d 6f76 6528 5b2d 7769 7265 5f77  c).move([-wire_w
-0002e0e0: 6964 7468 2c20 2d77 6972 655f 7769 6474  idth, -wire_widt
-0002e0f0: 685d 292c 0a20 2020 2020 2020 2020 2020  h]),.           
-0002e100: 2020 2020 206f 7065 7261 7469 6f6e 3d22       operation="
-0002e110: 6e6f 7422 2c0a 2020 2020 2020 2020 2020  not",.          
-0002e120: 2020 2020 2020 6c61 7965 723d 6c61 7965        layer=laye
-0002e130: 722c 0a20 2020 2020 2020 2020 2020 2029  r,.            )
-0002e140: 0a20 2020 2020 2020 2020 2020 2062 6172  .            bar
-0002e150: 632e 6164 645f 706f 7274 280a 2020 2020  c.add_port(.    
-0002e160: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0002e170: 3d31 2c20 6d69 6470 6f69 6e74 3d70 6f72  =1, midpoint=por
-0002e180: 7431 6d70 2c20 7769 6474 683d 7769 7265  t1mp, width=wire
-0002e190: 5f77 6964 7468 2c20 6f72 6965 6e74 6174  _width, orientat
-0002e1a0: 696f 6e3d 706f 7274 316f 720a 2020 2020  ion=port1or.    
-0002e1b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002e1c0: 2020 2020 2020 6261 7263 2e61 6464 5f70        barc.add_p
-0002e1d0: 6f72 7428 0a20 2020 2020 2020 2020 2020  ort(.           
-0002e1e0: 2020 2020 206e 616d 653d 322c 206d 6964       name=2, mid
-0002e1f0: 706f 696e 743d 706f 7274 326d 702c 2077  point=port2mp, w
-0002e200: 6964 7468 3d77 6972 655f 7769 6474 682c  idth=wire_width,
-0002e210: 206f 7269 656e 7461 7469 6f6e 3d70 6f72   orientation=por
-0002e220: 7432 6f72 0a20 2020 2020 2020 2020 2020  t2or.           
-0002e230: 2029 0a20 2020 2020 2020 2070 696e 203d   ).        pin =
-0002e240: 206f 7074 696d 616c 5f68 6169 7270 696e   optimal_hairpin
-0002e250: 280a 2020 2020 2020 2020 2020 2020 7769  (.            wi
-0002e260: 6474 683d 7769 7265 5f77 6964 7468 2c0a  dth=wire_width,.
-0002e270: 2020 2020 2020 2020 2020 2020 7069 7463              pitc
-0002e280: 683d 7066 6163 7420 2a20 7769 7265 5f77  h=pfact * wire_w
-0002e290: 6964 7468 2c0a 2020 2020 2020 2020 2020  idth,.          
-0002e2a0: 2020 6c65 6e67 7468 3d38 202a 2077 6972    length=8 * wir
-0002e2b0: 655f 7769 6474 682c 0a20 2020 2020 2020  e_width,.       
-0002e2c0: 2020 2020 206c 6179 6572 3d6c 6179 6572       layer=layer
-0002e2d0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-0002e2e0: 2020 2020 7061 7320 3d20 636f 6d70 6173      pas = compas
-0002e2f0: 7328 7369 7a65 3d28 7769 7265 5f77 6964  s(size=(wire_wid
-0002e300: 7468 2c20 7769 7265 5f70 6974 6368 292c  th, wire_pitch),
-0002e310: 206c 6179 6572 3d6c 6179 6572 290a 2020   layer=layer).  
-0002e320: 2020 2020 2020 4420 3d20 4465 7669 6365        D = Device
-0002e330: 2829 0a20 2020 2020 2020 2061 7263 3120  ().        arc1 
-0002e340: 3d20 442e 6164 645f 7265 6628 6261 7263  = D.add_ref(barc
-0002e350: 290a 2020 2020 2020 2020 6172 6331 2e72  ).        arc1.r
-0002e360: 6f74 6174 6528 3930 290a 2020 2020 2020  otate(90).      
-0002e370: 2020 7069 6e31 203d 2044 2e61 6464 5f72    pin1 = D.add_r
-0002e380: 6566 2870 696e 290a 2020 2020 2020 2020  ef(pin).        
-0002e390: 7069 6e31 2e63 6f6e 6e65 6374 2831 2c20  pin1.connect(1, 
-0002e3a0: 6172 6331 2e70 6f72 7473 5b32 5d29 0a20  arc1.ports[2]). 
-0002e3b0: 2020 2020 2020 2070 6173 3120 3d20 442e         pas1 = D.
-0002e3c0: 6164 645f 7265 6628 7061 7329 0a20 2020  add_ref(pas).   
-0002e3d0: 2020 2020 2070 6173 312e 636f 6e6e 6563       pas1.connec
-0002e3e0: 7428 7061 7331 2e70 6f72 7473 5b22 4e22  t(pas1.ports["N"
-0002e3f0: 5d2c 2070 696e 312e 706f 7274 735b 325d  ], pin1.ports[2]
-0002e400: 290a 2020 2020 2020 2020 6172 6332 203d  ).        arc2 =
-0002e410: 2044 2e61 6464 5f72 6566 2862 6172 6329   D.add_ref(barc)
-0002e420: 0a20 2020 2020 2020 2061 7263 322e 636f  .        arc2.co
-0002e430: 6e6e 6563 7428 322c 2070 6173 312e 706f  nnect(2, pas1.po
-0002e440: 7274 735b 2253 225d 290a 2020 2020 2020  rts["S"]).      
-0002e450: 2020 6966 2070 6164 5f6c 656e 6774 6820    if pad_length 
-0002e460: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-0002e470: 2070 696e 312e 6d6f 7665 7928 7061 645f   pin1.movey(pad_
-0002e480: 6c65 6e67 7468 202a 2030 2e35 290a 2020  length * 0.5).  
-0002e490: 2020 2020 2020 2020 2020 7465 6d70 6320            tempc 
-0002e4a0: 3d20 442e 6164 645f 7265 6628 0a20 2020  = D.add_ref(.   
-0002e4b0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-0002e4c0: 7061 7373 280a 2020 2020 2020 2020 2020  pass(.          
-0002e4d0: 2020 2020 2020 2020 2020 7369 7a65 3d28            size=(
-0002e4e0: 7069 6e31 2e70 6f72 7473 5b31 5d2e 7769  pin1.ports[1].wi
-0002e4f0: 6474 682c 2070 696e 312e 706f 7274 735b  dth, pin1.ports[
-0002e500: 315d 2e79 202d 2061 7263 312e 706f 7274  1].y - arc1.port
-0002e510: 735b 325d 2e79 292c 0a20 2020 2020 2020  s[2].y),.       
-0002e520: 2020 2020 2020 2020 2020 2020 206c 6179               lay
-0002e530: 6572 3d6c 6179 6572 2c0a 2020 2020 2020  er=layer,.      
-0002e540: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0002e550: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002e560: 2020 2020 2020 7465 6d70 632e 636f 6e6e        tempc.conn
-0002e570: 6563 7428 224e 222c 2070 696e 312e 706f  ect("N", pin1.po
-0002e580: 7274 735b 315d 290a 2020 2020 2020 2020  rts[1]).        
-0002e590: 2020 2020 7465 6d70 6320 3d20 442e 6164      tempc = D.ad
-0002e5a0: 645f 7265 6628 0a20 2020 2020 2020 2020  d_ref(.         
-0002e5b0: 2020 2020 2020 2063 6f6d 7061 7373 280a         compass(.
-0002e5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e5d0: 2020 2020 7369 7a65 3d28 7069 6e31 2e70      size=(pin1.p
-0002e5e0: 6f72 7473 5b32 5d2e 7769 6474 682c 2070  orts[2].width, p
-0002e5f0: 696e 312e 706f 7274 735b 325d 2e79 202d  in1.ports[2].y -
-0002e600: 2070 6173 312e 706f 7274 735b 224e 225d   pas1.ports["N"]
-0002e610: 2e79 292c 0a20 2020 2020 2020 2020 2020  .y),.           
-0002e620: 2020 2020 2020 2020 206c 6179 6572 3d6c           layer=l
-0002e630: 6179 6572 2c0a 2020 2020 2020 2020 2020  ayer,.          
-0002e640: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0002e650: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0002e660: 2020 7465 6d70 632e 636f 6e6e 6563 7428    tempc.connect(
-0002e670: 224e 222c 2070 696e 312e 706f 7274 735b  "N", pin1.ports[
-0002e680: 325d 290a 2020 2020 2020 2020 442e 6164  2]).        D.ad
-0002e690: 645f 706f 7274 280a 2020 2020 2020 2020  d_port(.        
-0002e6a0: 2020 2020 6e61 6d65 3d31 2c0a 2020 2020      name=1,.    
-0002e6b0: 2020 2020 2020 2020 6d69 6470 6f69 6e74          midpoint
-0002e6c0: 3d61 7263 312e 706f 7274 735b 315d 2e6d  =arc1.ports[1].m
-0002e6d0: 6964 706f 696e 742c 0a20 2020 2020 2020  idpoint,.       
-0002e6e0: 2020 2020 2077 6964 7468 3d77 6972 655f       width=wire_
-0002e6f0: 7769 6474 682c 0a20 2020 2020 2020 2020  width,.         
-0002e700: 2020 206f 7269 656e 7461 7469 6f6e 3d61     orientation=a
-0002e710: 7263 312e 706f 7274 735b 315d 2e6f 7269  rc1.ports[1].ori
-0002e720: 656e 7461 7469 6f6e 2c0a 2020 2020 2020  entation,.      
-0002e730: 2020 290a 2020 2020 2020 2020 442e 6164    ).        D.ad
-0002e740: 645f 706f 7274 280a 2020 2020 2020 2020  d_port(.        
-0002e750: 2020 2020 6e61 6d65 3d32 2c0a 2020 2020      name=2,.    
-0002e760: 2020 2020 2020 2020 6d69 6470 6f69 6e74          midpoint
-0002e770: 3d61 7263 322e 706f 7274 735b 315d 2e6d  =arc2.ports[1].m
-0002e780: 6964 706f 696e 742c 0a20 2020 2020 2020  idpoint,.       
-0002e790: 2020 2020 2077 6964 7468 3d77 6972 655f       width=wire_
-0002e7a0: 7769 6474 682c 0a20 2020 2020 2020 2020  width,.         
-0002e7b0: 2020 206f 7269 656e 7461 7469 6f6e 3d61     orientation=a
-0002e7c0: 7263 322e 706f 7274 735b 315d 2e6f 7269  rc2.ports[1].ori
-0002e7d0: 656e 7461 7469 6f6e 2c0a 2020 2020 2020  entation,.      
-0002e7e0: 2020 290a 2020 2020 2020 2020 7265 7475    ).        retu
-0002e7f0: 726e 2044 0a0a 2020 2020 6465 6620 7877  rn D..    def xw
-0002e800: 696e 675f 7574 7572 6e28 0a20 2020 2020  ing_uturn(.     
-0002e810: 2020 2077 6972 655f 7769 6474 683d 302e     wire_width=0.
-0002e820: 3532 2c20 7769 7265 5f70 6974 6368 3d30  52, wire_pitch=0
-0002e830: 2e35 362c 2070 6661 6374 3d31 302e 3020  .56, pfact=10.0 
-0002e840: 2f20 332c 2070 6164 5f6c 656e 6774 683d  / 3, pad_length=
-0002e850: 302c 206c 6179 6572 3d30 0a20 2020 2029  0, layer=0.    )
-0002e860: 3a0a 2020 2020 2020 2020 2222 2252 6574  :.        """Ret
-0002e870: 7572 6e73 2070 6869 646c 2064 6576 6963  urns phidl devic
-0002e880: 6520 6c6f 772d 6372 6f77 6469 6e67 2075  e low-crowding u
-0002e890: 2d74 7572 6e20 666f 7220 582d 7769 6e67  -turn for X-wing
-0002e8a0: 206d 6561 6e64 6572 2e22 2222 0a20 2020   meander.""".   
-0002e8b0: 2020 2020 2062 6172 6320 3d20 6172 6328       barc = arc(
-0002e8c0: 0a20 2020 2020 2020 2020 2020 2072 6164  .            rad
-0002e8d0: 6975 733d 7769 7265 5f77 6964 7468 202a  ius=wire_width *
-0002e8e0: 2033 2c20 7769 6474 683d 7769 7265 5f77   3, width=wire_w
-0002e8f0: 6964 7468 2c20 6c61 7965 723d 6c61 7965  idth, layer=laye
-0002e900: 722c 2074 6865 7461 3d34 350a 2020 2020  r, theta=45.    
-0002e910: 2020 2020 292e 726f 7461 7465 2831 3830      ).rotate(180
-0002e920: 290a 0a20 2020 2020 2020 2070 696e 203d  )..        pin =
-0002e930: 206f 7074 696d 616c 5f68 6169 7270 696e   optimal_hairpin
-0002e940: 280a 2020 2020 2020 2020 2020 2020 7769  (.            wi
-0002e950: 6474 683d 7769 7265 5f77 6964 7468 2c0a  dth=wire_width,.
-0002e960: 2020 2020 2020 2020 2020 2020 7069 7463              pitc
-0002e970: 683d 7066 6163 7420 2a20 7769 7265 5f77  h=pfact * wire_w
-0002e980: 6964 7468 2c0a 2020 2020 2020 2020 2020  idth,.          
-0002e990: 2020 6c65 6e67 7468 3d31 3520 2a20 7769    length=15 * wi
-0002e9a0: 7265 5f77 6964 7468 2c0a 2020 2020 2020  re_width,.      
-0002e9b0: 2020 2020 2020 6c61 7965 723d 6c61 7965        layer=laye
-0002e9c0: 722c 0a20 2020 2020 2020 2029 0a0a 2020  r,.        )..  
-0002e9d0: 2020 2020 2020 7061 736c 656e 203d 2070        paslen = p
-0002e9e0: 6661 6374 202a 2077 6972 655f 7769 6474  fact * wire_widt
-0002e9f0: 6820 2d20 6e70 2e73 7172 7428 3229 202a  h - np.sqrt(2) *
-0002ea00: 2077 6972 655f 7069 7463 680a 2020 2020   wire_pitch.    
-0002ea10: 2020 2020 7061 7320 3d20 636f 6d70 6173      pas = compas
-0002ea20: 7328 7369 7a65 3d28 7769 7265 5f77 6964  s(size=(wire_wid
-0002ea30: 7468 2c20 6162 7328 7061 736c 656e 2929  th, abs(paslen))
-0002ea40: 2c20 6c61 7965 723d 6c61 7965 7229 0a20  , layer=layer). 
-0002ea50: 2020 2020 2020 2044 7465 6d70 203d 2044         Dtemp = D
-0002ea60: 6576 6963 6528 290a 2020 2020 2020 2020  evice().        
-0002ea70: 6172 6331 203d 2044 7465 6d70 2e61 6464  arc1 = Dtemp.add
-0002ea80: 5f72 6566 2862 6172 6329 0a20 2020 2020  _ref(barc).     
-0002ea90: 2020 2061 7263 312e 726f 7461 7465 2839     arc1.rotate(9
-0002eaa0: 3029 0a20 2020 2020 2020 2070 696e 3120  0).        pin1 
-0002eab0: 3d20 4474 656d 702e 6164 645f 7265 6628  = Dtemp.add_ref(
-0002eac0: 7069 6e29 0a20 2020 2020 2020 2070 6173  pin).        pas
-0002ead0: 3120 3d20 4474 656d 702e 6164 645f 7265  1 = Dtemp.add_re
-0002eae0: 6628 7061 7329 0a20 2020 2020 2020 2061  f(pas).        a
-0002eaf0: 7263 3220 3d20 4474 656d 702e 6164 645f  rc2 = Dtemp.add_
-0002eb00: 7265 6628 6261 7263 290a 2020 2020 2020  ref(barc).      
-0002eb10: 2020 6966 2070 6173 6c65 6e20 3e20 303a    if paslen > 0:
-0002eb20: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
-0002eb30: 312e 636f 6e6e 6563 7428 7061 7331 2e70  1.connect(pas1.p
-0002eb40: 6f72 7473 5b22 5322 5d2c 2061 7263 312e  orts["S"], arc1.
-0002eb50: 706f 7274 735b 325d 290a 2020 2020 2020  ports[2]).      
-0002eb60: 2020 2020 2020 7069 6e31 2e63 6f6e 6e65        pin1.conne
-0002eb70: 6374 2831 2c20 7061 7331 2e70 6f72 7473  ct(1, pas1.ports
-0002eb80: 5b22 4e22 5d29 0a20 2020 2020 2020 2020  ["N"]).         
-0002eb90: 2020 2061 7263 322e 636f 6e6e 6563 7428     arc2.connect(
-0002eba0: 322c 2070 696e 312e 706f 7274 735b 325d  2, pin1.ports[2]
-0002ebb0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0002ebc0: 2020 2020 2020 2020 2020 2020 7069 6e31              pin1
-0002ebd0: 2e63 6f6e 6e65 6374 2831 2c20 6172 6331  .connect(1, arc1
-0002ebe0: 2e70 6f72 7473 5b32 5d29 0a20 2020 2020  .ports[2]).     
-0002ebf0: 2020 2020 2020 2070 6173 312e 636f 6e6e         pas1.conn
-0002ec00: 6563 7428 224e 222c 2070 696e 312e 706f  ect("N", pin1.po
-0002ec10: 7274 735b 325d 290a 2020 2020 2020 2020  rts[2]).        
-0002ec20: 2020 2020 6172 6332 2e63 6f6e 6e65 6374      arc2.connect
-0002ec30: 2832 2c20 7061 7331 2e70 6f72 7473 5b22  (2, pas1.ports["
-0002ec40: 5322 5d29 0a20 2020 2020 2020 2069 6620  S"]).        if 
-0002ec50: 7061 645f 6c65 6e67 7468 203e 2030 3a0a  pad_length > 0:.
-0002ec60: 2020 2020 2020 2020 2020 2020 7069 6e31              pin1
-0002ec70: 2e6d 6f76 6528 5b70 6164 5f6c 656e 6774  .move([pad_lengt
-0002ec80: 6820 2a20 302e 3520 2f20 6e70 2e73 7172  h * 0.5 / np.sqr
-0002ec90: 7428 3229 2c20 7061 645f 6c65 6e67 7468  t(2), pad_length
-0002eca0: 202a 2030 2e35 202f 206e 702e 7371 7274   * 0.5 / np.sqrt
-0002ecb0: 2832 295d 290a 2020 2020 2020 2020 2020  (2)]).          
-0002ecc0: 2020 6966 2070 6173 6c65 6e20 3e20 303a    if paslen > 0:
-0002ecd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ece0: 2069 6e64 7831 203d 2032 0a20 2020 2020   indx1 = 2.     
-0002ecf0: 2020 2020 2020 2020 2020 2069 6e64 7832             indx2
-0002ed00: 203d 2031 0a20 2020 2020 2020 2020 2020   = 1.           
-0002ed10: 2020 2020 206d 7961 7263 203d 2061 7263       myarc = arc
-0002ed20: 320a 2020 2020 2020 2020 2020 2020 656c  2.            el
-0002ed30: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002ed40: 2020 2020 696e 6478 3120 3d20 310a 2020      indx1 = 1.  
-0002ed50: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0002ed60: 6478 3220 3d20 320a 2020 2020 2020 2020  dx2 = 2.        
-0002ed70: 2020 2020 2020 2020 6d79 6172 6320 3d20          myarc = 
-0002ed80: 6172 6331 0a20 2020 2020 2020 2020 2020  arc1.           
-0002ed90: 2063 6f6d 7064 6973 7420 3d20 6e70 2e73   compdist = np.s
-0002eda0: 7172 7428 0a20 2020 2020 2020 2020 2020  qrt(.           
-0002edb0: 2020 2020 206e 702e 7375 6d28 6e70 2e73       np.sum(np.s
-0002edc0: 7175 6172 6528 7069 6e31 2e70 6f72 7473  quare(pin1.ports
-0002edd0: 5b69 6e64 7831 5d2e 6d69 6470 6f69 6e74  [indx1].midpoint
-0002ede0: 202d 206d 7961 7263 2e70 6f72 7473 5b32   - myarc.ports[2
-0002edf0: 5d2e 6d69 6470 6f69 6e74 2929 0a20 2020  ].midpoint)).   
-0002ee00: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0002ee10: 2020 2020 2020 2074 656d 7063 203d 2044         tempc = D
-0002ee20: 7465 6d70 2e61 6464 5f72 6566 280a 2020  temp.add_ref(.  
-0002ee30: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0002ee40: 6d70 6173 7328 7369 7a65 3d28 7069 6e31  mpass(size=(pin1
-0002ee50: 2e70 6f72 7473 5b69 6e64 7831 5d2e 7769  .ports[indx1].wi
-0002ee60: 6474 682c 2063 6f6d 7064 6973 7429 2c20  dth, compdist), 
-0002ee70: 6c61 7965 723d 6c61 7965 7229 0a20 2020  layer=layer).   
-0002ee80: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0002ee90: 2020 2020 2020 2074 656d 7063 2e63 6f6e         tempc.con
-0002eea0: 6e65 6374 2822 4e22 2c20 7069 6e31 2e70  nect("N", pin1.p
-0002eeb0: 6f72 7473 5b69 6e64 7831 5d29 0a20 2020  orts[indx1]).   
-0002eec0: 2020 2020 2020 2020 2063 6f6d 7064 6973           compdis
-0002eed0: 7420 3d20 6e70 2e73 7172 7428 0a20 2020  t = np.sqrt(.   
-0002eee0: 2020 2020 2020 2020 2020 2020 206e 702e               np.
-0002eef0: 7375 6d28 6e70 2e73 7175 6172 6528 7069  sum(np.square(pi
-0002ef00: 6e31 2e70 6f72 7473 5b69 6e64 7832 5d2e  n1.ports[indx2].
-0002ef10: 6d69 6470 6f69 6e74 202d 2070 6173 312e  midpoint - pas1.
-0002ef20: 706f 7274 735b 224e 225d 2e6d 6964 706f  ports["N"].midpo
-0002ef30: 696e 7429 290a 2020 2020 2020 2020 2020  int)).          
-0002ef40: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0002ef50: 7465 6d70 6320 3d20 4474 656d 702e 6164  tempc = Dtemp.ad
-0002ef60: 645f 7265 6628 0a20 2020 2020 2020 2020  d_ref(.         
-0002ef70: 2020 2020 2020 2063 6f6d 7061 7373 2873         compass(s
-0002ef80: 697a 653d 2870 696e 312e 706f 7274 735b  ize=(pin1.ports[
-0002ef90: 696e 6478 325d 2e77 6964 7468 2c20 636f  indx2].width, co
-0002efa0: 6d70 6469 7374 292c 206c 6179 6572 3d6c  mpdist), layer=l
-0002efb0: 6179 6572 290a 2020 2020 2020 2020 2020  ayer).          
-0002efc0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0002efd0: 7465 6d70 632e 636f 6e6e 6563 7428 224e  tempc.connect("N
-0002efe0: 222c 2070 696e 312e 706f 7274 735b 696e  ", pin1.ports[in
-0002eff0: 6478 325d 290a 0a20 2020 2020 2020 2044  dx2])..        D
-0002f000: 7465 6d70 2e61 6464 5f70 6f72 7428 0a20  temp.add_port(. 
-0002f010: 2020 2020 2020 2020 2020 206e 616d 653d             name=
-0002f020: 312c 0a20 2020 2020 2020 2020 2020 206d  1,.            m
-0002f030: 6964 706f 696e 743d 6172 6331 2e70 6f72  idpoint=arc1.por
-0002f040: 7473 5b31 5d2e 6d69 6470 6f69 6e74 2c0a  ts[1].midpoint,.
-0002f050: 2020 2020 2020 2020 2020 2020 7769 6474              widt
-0002f060: 683d 7769 7265 5f77 6964 7468 2c0a 2020  h=wire_width,.  
-0002f070: 2020 2020 2020 2020 2020 6f72 6965 6e74            orient
-0002f080: 6174 696f 6e3d 6172 6331 2e70 6f72 7473  ation=arc1.ports
-0002f090: 5b31 5d2e 6f72 6965 6e74 6174 696f 6e2c  [1].orientation,
-0002f0a0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0002f0b0: 2020 2044 7465 6d70 2e61 6464 5f70 6f72     Dtemp.add_por
-0002f0c0: 7428 0a20 2020 2020 2020 2020 2020 206e  t(.            n
-0002f0d0: 616d 653d 322c 0a20 2020 2020 2020 2020  ame=2,.         
-0002f0e0: 2020 206d 6964 706f 696e 743d 6172 6332     midpoint=arc2
-0002f0f0: 2e70 6f72 7473 5b31 5d2e 6d69 6470 6f69  .ports[1].midpoi
-0002f100: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-0002f110: 7769 6474 683d 7769 7265 5f77 6964 7468  width=wire_width
-0002f120: 2c0a 2020 2020 2020 2020 2020 2020 6f72  ,.            or
-0002f130: 6965 6e74 6174 696f 6e3d 6172 6332 2e70  ientation=arc2.p
-0002f140: 6f72 7473 5b31 5d2e 6f72 6965 6e74 6174  orts[1].orientat
-0002f150: 696f 6e2c 0a20 2020 2020 2020 2029 0a0a  ion,.        )..
-0002f160: 2020 2020 2020 2020 7265 7475 726e 2044          return D
-0002f170: 7465 6d70 0a0a 2020 2020 4420 3d20 4465  temp..    D = De
-0002f180: 7669 6365 286e 616d 653d 2273 6e73 7064  vice(name="snspd
-0002f190: 5f63 616e 6465 6c61 6272 6122 290a 2020  _candelabra").  
-0002f1a0: 2020 6966 2078 7769 6e67 3a0a 2020 2020    if xwing:.    
-0002f1b0: 2020 2020 4474 656d 7020 3d20 7877 696e      Dtemp = xwin
-0002f1c0: 675f 7574 7572 6e28 7769 7265 5f77 6964  g_uturn(wire_wid
-0002f1d0: 7468 3d77 6972 655f 7769 6474 682c 2077  th=wire_width, w
-0002f1e0: 6972 655f 7069 7463 683d 7769 7265 5f70  ire_pitch=wire_p
-0002f1f0: 6974 6368 2c20 6c61 7965 723d 6c61 7965  itch, layer=laye
-0002f200: 7229 0a20 2020 2065 6c73 653a 0a20 2020  r).    else:.   
-0002f210: 2020 2020 2044 7465 6d70 203d 206f 6666       Dtemp = off
-0002f220: 5f61 7869 735f 7574 7572 6e28 0a20 2020  _axis_uturn(.   
-0002f230: 2020 2020 2020 2020 2077 6972 655f 7769           wire_wi
-0002f240: 6474 683d 7769 7265 5f77 6964 7468 2c20  dth=wire_width, 
-0002f250: 7769 7265 5f70 6974 6368 3d77 6972 655f  wire_pitch=wire_
-0002f260: 7069 7463 682c 206c 6179 6572 3d6c 6179  pitch, layer=lay
-0002f270: 6572 0a20 2020 2020 2020 2029 0a20 2020  er.        ).   
-0002f280: 2044 7465 6d70 5f6d 6972 726f 7265 6420   Dtemp_mirrored 
-0002f290: 3d20 6465 6570 636f 7079 2844 7465 6d70  = deepcopy(Dtemp
-0002f2a0: 292e 6d69 7272 6f72 285b 302c 2030 5d2c  ).mirror([0, 0],
-0002f2b0: 205b 302c 2031 5d29 0a20 2020 2070 6164   [0, 1]).    pad
-0002f2c0: 6469 6e67 203d 2044 7465 6d70 2e78 7369  ding = Dtemp.xsi
-0002f2d0: 7a65 0a20 2020 206d 6178 6c6c 203d 2068  ze.    maxll = h
-0002f2e0: 6178 6973 202d 2032 202a 2070 6164 6469  axis - 2 * paddi
-0002f2f0: 6e67 0a20 2020 2064 6c6c 203d 2061 6273  ng.    dll = abs
-0002f300: 2844 7465 6d70 2e70 6f72 7473 5b31 5d2e  (Dtemp.ports[1].
-0002f310: 7820 2d20 4474 656d 702e 706f 7274 735b  x - Dtemp.ports[
-0002f320: 325d 2e78 2920 2b20 7769 7265 5f70 6974  2].x) + wire_pit
-0002f330: 6368 0a20 2020 2068 616c 665f 6e75 6d5f  ch.    half_num_
-0002f340: 6d65 616e 6465 7273 203d 2069 6e74 286e  meanders = int(n
-0002f350: 702e 6365 696c 2830 2e35 202a 2076 6178  p.ceil(0.5 * vax
-0002f360: 6973 202f 2077 6972 655f 7069 7463 6829  is / wire_pitch)
-0002f370: 2920 2b20 320a 0a20 2020 2069 6620 7877  ) + 2..    if xw
-0002f380: 696e 673a 0a20 2020 2020 2020 2062 656e  ing:.        ben
-0002f390: 6420 3d20 442e 6164 645f 7265 6628 0a20  d = D.add_ref(. 
-0002f3a0: 2020 2020 2020 2020 2020 2061 7263 2872             arc(r
-0002f3b0: 6164 6975 733d 7769 7265 5f77 6964 7468  adius=wire_width
-0002f3c0: 202a 2033 2c20 7769 6474 683d 7769 7265   * 3, width=wire
-0002f3d0: 5f77 6964 7468 2c20 7468 6574 613d 3930  _width, theta=90
-0002f3e0: 2c20 6c61 7965 723d 6c61 7965 7229 0a20  , layer=layer). 
-0002f3f0: 2020 2020 2020 2029 2e72 6f74 6174 6528         ).rotate(
-0002f400: 3138 3029 0a20 2020 2065 6c73 653a 0a20  180).    else:. 
-0002f410: 2020 2020 2020 2062 656e 6420 3d20 442e         bend = D.
-0002f420: 6164 645f 7265 6628 6f70 7469 6d61 6c5f  add_ref(optimal_
-0002f430: 3930 6465 6728 7769 6474 683d 7769 7265  90deg(width=wire
-0002f440: 5f77 6964 7468 2c20 6c61 7965 723d 6c61  _width, layer=la
-0002f450: 7965 7229 290a 2020 2020 6966 2028 6d61  yer)).    if (ma
-0002f460: 786c 6c20 2d20 646c 6c20 2a20 6861 6c66  xll - dll * half
-0002f470: 5f6e 756d 5f6d 6561 6e64 6572 7329 203c  _num_meanders) <
-0002f480: 3d20 302e 303a 0a20 2020 2020 2020 2077  = 0.0:.        w
-0002f490: 6869 6c65 2028 6d61 786c 6c20 2d20 646c  hile (maxll - dl
-0002f4a0: 6c20 2a20 6861 6c66 5f6e 756d 5f6d 6561  l * half_num_mea
-0002f4b0: 6e64 6572 7329 203c 3d20 302e 303a 0a20  nders) <= 0.0:. 
-0002f4c0: 2020 2020 2020 2020 2020 2068 616c 665f             half_
-0002f4d0: 6e75 6d5f 6d65 616e 6465 7273 203d 2068  num_meanders = h
-0002f4e0: 616c 665f 6e75 6d5f 6d65 616e 6465 7273  alf_num_meanders
-0002f4f0: 202d 2031 0a20 2020 2066 7061 7320 3d20   - 1.    fpas = 
-0002f500: 442e 6164 645f 7265 6628 0a20 2020 2020  D.add_ref(.     
-0002f510: 2020 2063 6f6d 7061 7373 2873 697a 653d     compass(size=
-0002f520: 2830 2e35 202a 2028 6d61 786c 6c20 2d20  (0.5 * (maxll - 
-0002f530: 646c 6c20 2a20 6861 6c66 5f6e 756d 5f6d  dll * half_num_m
-0002f540: 6561 6e64 6572 7329 2c20 7769 7265 5f77  eanders), wire_w
-0002f550: 6964 7468 292c 206c 6179 6572 3d6c 6179  idth), layer=lay
-0002f560: 6572 290a 2020 2020 290a 2020 2020 442e  er).    ).    D.
-0002f570: 6d6f 7665 7828 2d62 656e 642e 706f 7274  movex(-bend.port
-0002f580: 735b 315d 2e78 290a 2020 2020 6670 6173  s[1].x).    fpas
-0002f590: 2e63 6f6e 6e65 6374 2866 7061 732e 706f  .connect(fpas.po
-0002f5a0: 7274 735b 2257 225d 2c20 6265 6e64 2e70  rts["W"], bend.p
-0002f5b0: 6f72 7473 5b32 5d29 0a20 2020 206c 6c20  orts[2]).    ll 
-0002f5c0: 3d20 442e 7873 697a 6520 2a20 3220 2d20  = D.xsize * 2 - 
-0002f5d0: 7769 7265 5f77 6964 7468 0a20 2020 2069  wire_width.    i
-0002f5e0: 6620 6571 7561 6c69 7a65 5f70 6174 685f  f equalize_path_
-0002f5f0: 6c65 6e67 7468 733a 0a20 2020 2020 2020  lengths:.       
-0002f600: 2069 6620 7877 696e 673a 0a20 2020 2020   if xwing:.     
-0002f610: 2020 2020 2020 2044 7465 6d70 203d 2078         Dtemp = x
-0002f620: 7769 6e67 5f75 7475 726e 280a 2020 2020  wing_uturn(.    
-0002f630: 2020 2020 2020 2020 2020 2020 7769 7265              wire
-0002f640: 5f77 6964 7468 3d77 6972 655f 7769 6474  _width=wire_widt
-0002f650: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
-0002f660: 2020 2077 6972 655f 7069 7463 683d 7769     wire_pitch=wi
-0002f670: 7265 5f70 6974 6368 2c0a 2020 2020 2020  re_pitch,.      
-0002f680: 2020 2020 2020 2020 2020 7061 645f 6c65            pad_le
-0002f690: 6e67 7468 3d28 6d61 786c 6c20 2d20 6c6c  ngth=(maxll - ll
-0002f6a0: 202d 2064 6c6c 2920 2a20 6571 7561 6c69   - dll) * equali
-0002f6b0: 7a65 5f70 6174 685f 6c65 6e67 7468 732c  ze_path_lengths,
-0002f6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f6d0: 206c 6179 6572 3d6c 6179 6572 2c0a 2020   layer=layer,.  
-0002f6e0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0002f6f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0002f700: 2020 2020 2020 4474 656d 7020 3d20 6f66        Dtemp = of
-0002f710: 665f 6178 6973 5f75 7475 726e 280a 2020  f_axis_uturn(.  
-0002f720: 2020 2020 2020 2020 2020 2020 2020 7769                wi
-0002f730: 7265 5f77 6964 7468 3d77 6972 655f 7769  re_width=wire_wi
-0002f740: 6474 682c 0a20 2020 2020 2020 2020 2020  dth,.           
-0002f750: 2020 2020 2077 6972 655f 7069 7463 683d       wire_pitch=
-0002f760: 7769 7265 5f70 6974 6368 2c0a 2020 2020  wire_pitch,.    
-0002f770: 2020 2020 2020 2020 2020 2020 7061 645f              pad_
-0002f780: 6c65 6e67 7468 3d28 6d61 786c 6c20 2d20  length=(maxll - 
-0002f790: 6c6c 202d 2064 6c6c 2920 2a20 6571 7561  ll - dll) * equa
-0002f7a0: 6c69 7a65 5f70 6174 685f 6c65 6e67 7468  lize_path_length
-0002f7b0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0002f7c0: 2020 206c 6179 6572 3d6c 6179 6572 2c0a     layer=layer,.
-0002f7d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0002f7e0: 2020 7574 7572 6e20 3d20 442e 6164 645f    uturn = D.add_
-0002f7f0: 7265 6628 4474 656d 7029 0a20 2020 2075  ref(Dtemp).    u
-0002f800: 7475 726e 2e63 6f6e 6e65 6374 2831 2c20  turn.connect(1, 
-0002f810: 6670 6173 2e70 6f72 7473 5b22 4522 5d29  fpas.ports["E"])
-0002f820: 0a20 2020 2064 6972 5f6c 6566 7420 3d20  .    dir_left = 
-0002f830: 5472 7565 0a0a 2020 2020 7475 726e 5f70  True..    turn_p
-0002f840: 6164 6469 6e67 203d 206d 6178 6c6c 202d  adding = maxll -
-0002f850: 206c 6c20 2d20 3220 2a20 646c 6c0a 0a20   ll - 2 * dll.. 
-0002f860: 2020 2077 6869 6c65 206c 6c20 3c20 6d61     while ll < ma
-0002f870: 786c 6c20 2d20 646c 6c3a 0a20 2020 2020  xll - dll:.     
-0002f880: 2020 206c 6c20 3d20 6c6c 202b 2064 6c6c     ll = ll + dll
-0002f890: 0a20 2020 2020 2020 2069 6620 6571 7561  .        if equa
-0002f8a0: 6c69 7a65 5f70 6174 685f 6c65 6e67 7468  lize_path_length
-0002f8b0: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-0002f8c0: 6620 7877 696e 673a 0a20 2020 2020 2020  f xwing:.       
-0002f8d0: 2020 2020 2020 2020 2044 7465 6d70 203d           Dtemp =
-0002f8e0: 2078 7769 6e67 5f75 7475 726e 280a 2020   xwing_uturn(.  
-0002f8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f900: 2020 7769 7265 5f77 6964 7468 3d77 6972    wire_width=wir
-0002f910: 655f 7769 6474 682c 0a20 2020 2020 2020  e_width,.       
-0002f920: 2020 2020 2020 2020 2020 2020 2077 6972               wir
-0002f930: 655f 7069 7463 683d 7769 7265 5f70 6974  e_pitch=wire_pit
-0002f940: 6368 2c0a 2020 2020 2020 2020 2020 2020  ch,.            
-0002f950: 2020 2020 2020 2020 7061 645f 6c65 6e67          pad_leng
-0002f960: 7468 3d74 7572 6e5f 7061 6464 696e 6720  th=turn_padding 
-0002f970: 2a20 6571 7561 6c69 7a65 5f70 6174 685f  * equalize_path_
-0002f980: 6c65 6e67 7468 732c 0a20 2020 2020 2020  lengths,.       
-0002f990: 2020 2020 2020 2020 2020 2020 206c 6179               lay
-0002f9a0: 6572 3d6c 6179 6572 2c0a 2020 2020 2020  er=layer,.      
-0002f9b0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0002f9c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002f9d0: 2020 2020 2020 2020 2020 2020 2020 4474                Dt
-0002f9e0: 656d 7020 3d20 6f66 665f 6178 6973 5f75  emp = off_axis_u
-0002f9f0: 7475 726e 280a 2020 2020 2020 2020 2020  turn(.          
-0002fa00: 2020 2020 2020 2020 2020 7769 7265 5f77            wire_w
-0002fa10: 6964 7468 3d77 6972 655f 7769 6474 682c  idth=wire_width,
-0002fa20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002fa30: 2020 2020 2077 6972 655f 7069 7463 683d       wire_pitch=
-0002fa40: 7769 7265 5f70 6974 6368 2c0a 2020 2020  wire_pitch,.    
-0002fa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fa60: 7061 645f 6c65 6e67 7468 3d74 7572 6e5f  pad_length=turn_
-0002fa70: 7061 6464 696e 6720 2a20 6571 7561 6c69  padding * equali
-0002fa80: 7a65 5f70 6174 685f 6c65 6e67 7468 732c  ze_path_lengths,
-0002fa90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002faa0: 2020 2020 206c 6179 6572 3d6c 6179 6572       layer=layer
-0002fab0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002fac0: 2020 290a 2020 2020 2020 2020 7475 726e    ).        turn
-0002fad0: 5f70 6164 6469 6e67 203d 2074 7572 6e5f  _padding = turn_
-0002fae0: 7061 6464 696e 6720 2d20 646c 6c0a 2020  padding - dll.  
-0002faf0: 2020 2020 2020 6e65 7770 6173 203d 2044        newpas = D
-0002fb00: 2e61 6464 5f72 6566 2863 6f6d 7061 7373  .add_ref(compass
-0002fb10: 2873 697a 653d 286c 6c2c 2077 6972 655f  (size=(ll, wire_
-0002fb20: 7769 6474 6829 2c20 6c61 7965 723d 6c61  width), layer=la
-0002fb30: 7965 7229 290a 2020 2020 2020 2020 6966  yer)).        if
-0002fb40: 2064 6972 5f6c 6566 743a 0a20 2020 2020   dir_left:.     
-0002fb50: 2020 2020 2020 206e 6577 7061 732e 636f         newpas.co
-0002fb60: 6e6e 6563 7428 6e65 7770 6173 2e70 6f72  nnect(newpas.por
-0002fb70: 7473 5b22 4522 5d2c 2075 7475 726e 2e70  ts["E"], uturn.p
-0002fb80: 6f72 7473 5b32 5d29 0a20 2020 2020 2020  orts[2]).       
-0002fb90: 2020 2020 2069 6620 6571 7561 6c69 7a65       if equalize
-0002fba0: 5f70 6174 685f 6c65 6e67 7468 733a 0a20  _path_lengths:. 
-0002fbb0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-0002fbc0: 7475 726e 203d 2044 2e61 6464 5f72 6566  turn = D.add_ref
-0002fbd0: 2844 7465 6d70 2e6d 6972 726f 7228 5b30  (Dtemp.mirror([0
-0002fbe0: 2c20 305d 2c20 5b30 2c20 315d 2929 0a20  , 0], [0, 1])). 
-0002fbf0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0002fc00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002fc10: 2075 7475 726e 203d 2044 2e61 6464 5f72   uturn = D.add_r
-0002fc20: 6566 2844 7465 6d70 5f6d 6972 726f 7265  ef(Dtemp_mirrore
-0002fc30: 6429 0a20 2020 2020 2020 2020 2020 2075  d).            u
-0002fc40: 7475 726e 2e63 6f6e 6e65 6374 2831 2c20  turn.connect(1, 
-0002fc50: 6e65 7770 6173 2e70 6f72 7473 5b22 5722  newpas.ports["W"
-0002fc60: 5d29 0a20 2020 2020 2020 2020 2020 2064  ]).            d
-0002fc70: 6972 5f6c 6566 7420 3d20 4661 6c73 650a  ir_left = False.
-0002fc80: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002fc90: 2020 2020 2020 2020 2020 6e65 7770 6173            newpas
-0002fca0: 2e63 6f6e 6e65 6374 286e 6577 7061 732e  .connect(newpas.
-0002fcb0: 706f 7274 735b 2257 225d 2c20 7574 7572  ports["W"], utur
-0002fcc0: 6e2e 706f 7274 735b 325d 290a 2020 2020  n.ports[2]).    
-0002fcd0: 2020 2020 2020 2020 7574 7572 6e20 3d20          uturn = 
-0002fce0: 442e 6164 645f 7265 6628 4474 656d 7029  D.add_ref(Dtemp)
-0002fcf0: 0a20 2020 2020 2020 2020 2020 2075 7475  .            utu
-0002fd00: 726e 2e63 6f6e 6e65 6374 2831 2c20 6e65  rn.connect(1, ne
-0002fd10: 7770 6173 2e70 6f72 7473 5b22 4522 5d29  wpas.ports["E"])
-0002fd20: 0a20 2020 2020 2020 2020 2020 2064 6972  .            dir
-0002fd30: 5f6c 6566 7420 3d20 5472 7565 0a0a 2020  _left = True..  
-0002fd40: 2020 6e65 7770 6173 203d 2044 2e61 6464    newpas = D.add
-0002fd50: 5f72 6566 2863 6f6d 7061 7373 2873 697a  _ref(compass(siz
-0002fd60: 653d 286c 6c20 2f20 322c 2077 6972 655f  e=(ll / 2, wire_
-0002fd70: 7769 6474 6829 2c20 6c61 7965 723d 6c61  width), layer=la
-0002fd80: 7965 7229 290a 2020 2020 6966 2064 6972  yer)).    if dir
-0002fd90: 5f6c 6566 743a 0a20 2020 2020 2020 206e  _left:.        n
-0002fda0: 6577 7061 732e 636f 6e6e 6563 7428 6e65  ewpas.connect(ne
-0002fdb0: 7770 6173 2e70 6f72 7473 5b22 4522 5d2c  wpas.ports["E"],
-0002fdc0: 2075 7475 726e 2e70 6f72 7473 5b32 5d29   uturn.ports[2])
-0002fdd0: 0a20 2020 2020 2020 2064 6972 5f6c 6566  .        dir_lef
-0002fde0: 7420 3d20 4661 6c73 650a 2020 2020 656c  t = False.    el
-0002fdf0: 7365 3a0a 2020 2020 2020 2020 6e65 7770  se:.        newp
-0002fe00: 6173 2e63 6f6e 6e65 6374 286e 6577 7061  as.connect(newpa
-0002fe10: 732e 706f 7274 735b 2257 225d 2c20 7574  s.ports["W"], ut
-0002fe20: 7572 6e2e 706f 7274 735b 325d 290a 2020  urn.ports[2]).  
-0002fe30: 2020 2020 2020 6469 725f 6c65 6674 203d        dir_left =
-0002fe40: 2054 7275 650a 0a20 2020 2044 2e6d 6f76   True..    D.mov
-0002fe50: 6578 282d 442e 7829 0a20 2020 2069 6620  ex(-D.x).    if 
-0002fe60: 6e6f 7420 7877 696e 673a 0a20 2020 2020  not xwing:.     
-0002fe70: 2020 2062 656e 642e 6d6f 7665 7828 2d62     bend.movex(-b
-0002fe80: 656e 642e 706f 7274 735b 315d 2e78 290a  end.ports[1].x).
-0002fe90: 2020 2020 6966 2028 6670 6173 2e70 6f72      if (fpas.por
-0002fea0: 7473 5b22 5722 5d2e 7820 2d20 6265 6e64  ts["W"].x - bend
-0002feb0: 2e70 6f72 7473 5b32 5d2e 7829 203e 2030  .ports[2].x) > 0
-0002fec0: 3a0a 2020 2020 2020 2020 7465 6d70 6320  :.        tempc 
-0002fed0: 3d20 442e 6164 645f 7265 6628 0a20 2020  = D.add_ref(.   
-0002fee0: 2020 2020 2020 2020 2063 6f6d 7061 7373           compass
-0002fef0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002ff00: 2020 7369 7a65 3d28 6670 6173 2e70 6f72    size=(fpas.por
-0002ff10: 7473 5b22 5722 5d2e 7820 2d20 6265 6e64  ts["W"].x - bend
-0002ff20: 2e70 6f72 7473 5b32 5d2e 782c 2062 656e  .ports[2].x, ben
-0002ff30: 642e 706f 7274 735b 325d 2e77 6964 7468  d.ports[2].width
-0002ff40: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0002ff50: 2020 206c 6179 6572 3d6c 6179 6572 2c0a     layer=layer,.
-0002ff60: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0002ff70: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0002ff80: 7465 6d70 632e 636f 6e6e 6563 7428 2245  tempc.connect("E
-0002ff90: 222c 2066 7061 732e 706f 7274 735b 2257  ", fpas.ports["W
-0002ffa0: 225d 290a 2020 2020 442e 6d6f 7665 285b  "]).    D.move([
-0002ffb0: 2d44 2e78 2c20 2d44 2e79 6d69 6e20 2d20  -D.x, -D.ymin - 
-0002ffc0: 7769 7265 5f77 6964 7468 202a 2030 2e35  wire_width * 0.5
-0002ffd0: 5d29 0a20 2020 2044 2e61 6464 5f70 6f72  ]).    D.add_por
-0002ffe0: 7428 6e61 6d65 3d31 2c20 706f 7274 3d62  t(name=1, port=b
-0002fff0: 656e 642e 706f 7274 735b 315d 290a 2020  end.ports[1]).  
-00030000: 2020 6966 2064 6972 5f6c 6566 743a 0a20    if dir_left:. 
-00030010: 2020 2020 2020 2044 2e61 6464 5f70 6f72         D.add_por
-00030020: 7428 6e61 6d65 3d32 2c20 706f 7274 3d6e  t(name=2, port=n
-00030030: 6577 7061 732e 706f 7274 735b 2245 225d  ewpas.ports["E"]
-00030040: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-00030050: 2020 2020 442e 6164 645f 706f 7274 286e      D.add_port(n
-00030060: 616d 653d 322c 2070 6f72 743d 6e65 7770  ame=2, port=newp
-00030070: 6173 2e70 6f72 7473 5b22 5722 5d29 0a0a  as.ports["W"])..
-00030080: 2020 2020 446f 7574 203d 2044 6576 6963      Dout = Devic
-00030090: 6528 290a 2020 2020 4431 203d 2044 6f75  e().    D1 = Dou
-000300a0: 742e 6164 645f 7265 6628 4429 0a20 2020  t.add_ref(D).   
-000300b0: 2044 3220 3d20 446f 7574 2e61 6464 5f72   D2 = Dout.add_r
-000300c0: 6566 2863 6f70 7928 4429 2e72 6f74 6174  ef(copy(D).rotat
-000300d0: 6528 3138 3029 290a 2020 2020 7465 6d70  e(180)).    temp
-000300e0: 6320 3d20 446f 7574 2e61 6464 5f72 6566  c = Dout.add_ref
-000300f0: 280a 2020 2020 2020 2020 636f 6d70 6173  (.        compas
-00030100: 7328 0a20 2020 2020 2020 2020 2020 2073  s(.            s
-00030110: 697a 653d 2861 6273 2844 312e 706f 7274  ize=(abs(D1.port
-00030120: 735b 325d 2e78 202d 2044 322e 706f 7274  s[2].x - D2.port
-00030130: 735b 325d 2e78 292c 2044 312e 706f 7274  s[2].x), D1.port
-00030140: 735b 325d 2e77 6964 7468 292c 206c 6179  s[2].width), lay
-00030150: 6572 3d6c 6179 6572 0a20 2020 2020 2020  er=layer.       
-00030160: 2029 0a20 2020 2029 0a20 2020 2069 6620   ).    ).    if 
-00030170: 4431 2e70 6f72 7473 5b32 5d2e 7820 3e20  D1.ports[2].x > 
-00030180: 4432 2e70 6f72 7473 5b32 5d2e 783a 0a20  D2.ports[2].x:. 
-00030190: 2020 2020 2020 2074 656d 7063 2e63 6f6e         tempc.con
-000301a0: 6e65 6374 2822 4522 2c20 4431 2e70 6f72  nect("E", D1.por
-000301b0: 7473 5b32 5d29 0a20 2020 2065 6c73 653a  ts[2]).    else:
-000301c0: 0a20 2020 2020 2020 2074 656d 7063 2e63  .        tempc.c
-000301d0: 6f6e 6e65 6374 2822 5722 2c20 4431 2e70  onnect("W", D1.p
-000301e0: 6f72 7473 5b32 5d29 0a20 2020 2044 6f75  orts[2]).    Dou
-000301f0: 742e 6164 645f 706f 7274 286e 616d 653d  t.add_port(name=
-00030200: 312c 2070 6f72 743d 4431 2e70 6f72 7473  1, port=D1.ports
-00030210: 5b31 5d29 0a20 2020 2044 6f75 742e 6164  [1]).    Dout.ad
-00030220: 645f 706f 7274 286e 616d 653d 322c 2070  d_port(name=2, p
-00030230: 6f72 743d 4432 2e70 6f72 7473 5b31 5d29  ort=D2.ports[1])
-00030240: 0a20 2020 2072 6574 7572 6e20 446f 7574  .    return Dout
-00030250: 0a0a 0a64 6566 2079 7472 6f6e 5f72 6f75  ...def ytron_rou
-00030260: 6e64 280a 2020 2020 7268 6f3d 312c 0a20  nd(.    rho=1,. 
-00030270: 2020 2061 726d 5f6c 656e 6774 6873 3d28     arm_lengths=(
-00030280: 3530 302c 2033 3030 292c 0a20 2020 2073  500, 300),.    s
-00030290: 6f75 7263 655f 6c65 6e67 7468 3d35 3030  ource_length=500
-000302a0: 2c0a 2020 2020 6172 6d5f 7769 6474 6873  ,.    arm_widths
-000302b0: 3d28 3230 302c 2032 3030 292c 0a20 2020  =(200, 200),.   
-000302c0: 2074 6865 7461 3d32 2e35 2c0a 2020 2020   theta=2.5,.    
-000302d0: 7468 6574 615f 7265 736f 6c75 7469 6f6e  theta_resolution
-000302e0: 3d31 302c 0a20 2020 206c 6179 6572 3d30  =10,.    layer=0
-000302f0: 2c0a 293a 0a20 2020 2022 2222 5974 726f  ,.):.    """Ytro
-00030300: 6e20 7374 7275 6374 7572 6520 666f 7220  n structure for 
-00030310: 7375 7065 7263 6f6e 6475 6374 696e 6720  superconducting 
-00030320: 6e61 6e6f 7769 7265 730a 0a20 2020 204d  nanowires..    M
-00030330: 6343 6175 6768 616e 2c20 412e 204e 2e2c  cCaughan, A. N.,
-00030340: 2041 6265 6265 2c20 4e2e 2053 2e2c 205a   Abebe, N. S., Z
-00030350: 6861 6f2c 2051 2e2d 592e 2026 2042 6572  hao, Q.-Y. & Ber
-00030360: 6767 7265 6e2c 204b 2e20 4b2e 0a20 2020  ggren, K. K..   
-00030370: 2055 7369 6e67 2047 656f 6d65 7472 7920   Using Geometry 
-00030380: 546f 2053 656e 7365 2043 7572 7265 6e74  To Sense Current
-00030390: 2e20 4e61 6e6f 204c 6574 742e 2031 362c  . Nano Lett. 16,
-000303a0: 2037 3632 36e2 8093 3736 3331 2028 3230   7626...7631 (20
-000303b0: 3136 292e 0a20 2020 2068 7474 703a 2f2f  16)..    http://
-000303c0: 6478 2e64 6f69 2e6f 7267 2f31 302e 3130  dx.doi.org/10.10
-000303d0: 3231 2f61 6373 2e6e 616e 6f6c 6574 742e  21/acs.nanolett.
-000303e0: 3662 3033 3539 330a 0a20 2020 2050 6172  6b03593..    Par
-000303f0: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-00030400: 2d2d 2d2d 2d2d 0a20 2020 2072 686f 203a  ------.    rho :
-00030410: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
-00030420: 2020 2020 2020 5261 6469 7573 206f 6620        Radius of 
-00030430: 6375 7276 6174 7572 6520 6f66 2079 7472  curvature of ytr
-00030440: 6f6e 2069 6e74 6572 7365 6374 696f 6e20  on intersection 
-00030450: 706f 696e 740a 2020 2020 6172 6d5f 6c65  point.    arm_le
-00030460: 6e67 7468 7320 3a20 6172 7261 792d 6c69  ngths : array-li
-00030470: 6b65 5b32 5d20 6f66 2069 6e74 206f 7220  ke[2] of int or 
-00030480: 666c 6f61 740a 2020 2020 2020 2020 4c65  float.        Le
-00030490: 6e67 7468 7320 6f66 2074 6865 206c 6566  ngths of the lef
-000304a0: 7420 616e 6420 7269 6768 7420 6172 6d73  t and right arms
-000304b0: 206f 6620 7468 6520 7954 726f 6e2c 2072   of the yTron, r
-000304c0: 6573 7065 6374 6976 656c 792e 0a20 2020  espectively..   
-000304d0: 2073 6f75 7263 655f 6c65 6e67 7468 203a   source_length :
-000304e0: 2069 6e74 206f 7220 666c 6f61 740a 2020   int or float.  
-000304f0: 2020 2020 2020 4c65 6e67 7468 206f 6620        Length of 
-00030500: 7468 6520 736f 7572 6365 206f 6620 7468  the source of th
-00030510: 6520 7954 726f 6e2e 0a20 2020 2061 726d  e yTron..    arm
-00030520: 5f77 6964 7468 7320 3a20 6172 7261 792d  _widths : array-
-00030530: 6c69 6b65 5b32 5d20 6f66 2069 6e74 206f  like[2] of int o
-00030540: 7220 666c 6f61 740a 2020 2020 2020 2020  r float.        
-00030550: 5769 6474 6873 206f 6620 7468 6520 6c65  Widths of the le
-00030560: 6674 2061 6e64 2072 6967 6874 2061 726d  ft and right arm
-00030570: 7320 6f66 2074 6865 2079 5472 6f6e 2c20  s of the yTron, 
-00030580: 7265 7370 6563 7469 7665 6c79 2e0a 2020  respectively..  
-00030590: 2020 7468 6574 6120 3a20 696e 7420 6f72    theta : int or
-000305a0: 2066 6c6f 6174 0a20 2020 2020 2020 2041   float.        A
-000305b0: 6e67 6c65 2062 6574 7765 656e 2074 6865  ngle between the
-000305c0: 2074 776f 2079 5472 6f6e 2061 726d 732e   two yTron arms.
-000305d0: 0a20 2020 2074 6865 7461 5f72 6573 6f6c  .    theta_resol
-000305e0: 7574 696f 6e20 3a20 696e 7420 6f72 2066  ution : int or f
-000305f0: 6c6f 6174 0a20 2020 2020 2020 2041 6e67  loat.        Ang
-00030600: 6c65 2072 6573 6f6c 7574 696f 6e20 666f  le resolution fo
-00030610: 7220 6375 7276 6174 7572 6520 6f66 2079  r curvature of y
-00030620: 7472 6f6e 2069 6e74 6572 7365 6374 696f  tron intersectio
-00030630: 6e20 706f 696e 740a 2020 2020 6c61 7965  n point.    laye
-00030640: 7220 3a20 696e 742c 2061 7272 6179 2d6c  r : int, array-l
-00030650: 696b 655b 325d 2c20 6f72 2073 6574 0a20  ike[2], or set. 
-00030660: 2020 2020 2020 2053 7065 6369 6669 6320         Specific 
-00030670: 6c61 7965 7228 7329 2074 6f20 7075 7420  layer(s) to put 
-00030680: 706f 6c79 676f 6e20 6765 6f6d 6574 7279  polygon geometry
-00030690: 206f 6e2e 0a0a 2020 2020 5265 7475 726e   on...    Return
-000306a0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-000306b0: 2020 4420 3a20 4465 7669 6365 0a20 2020    D : Device.   
-000306c0: 2020 2020 2041 2044 6576 6963 6520 636f       A Device co
-000306d0: 6e74 6169 6e69 6e67 2061 2079 5472 6f6e  ntaining a yTron
-000306e0: 2067 656f 6d65 7472 792e 0a20 2020 2022   geometry..    "
-000306f0: 2222 0a20 2020 2023 203d 3d3d 3d3d 3d3d  "".    # =======
-00030700: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030710: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030720: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030730: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030740: 3d3d 3d0a 2020 2020 2320 2043 7265 6174  ===.    #  Creat
-00030750: 6520 7468 6520 6261 7369 6320 6765 6f6d  e the basic geom
-00030760: 6574 7279 0a20 2020 2023 203d 3d3d 3d3d  etry.    # =====
-00030770: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030780: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030790: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000307a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000307b0: 3d3d 3d3d 3d0a 2020 2020 7468 6574 6120  =====.    theta 
-000307c0: 3d20 7468 6574 6120 2a20 7069 202f 2031  = theta * pi / 1
-000307d0: 3830 0a20 2020 2074 6865 7461 5f72 6573  80.    theta_res
-000307e0: 6f6c 7574 696f 6e20 3d20 7468 6574 615f  olution = theta_
-000307f0: 7265 736f 6c75 7469 6f6e 202a 2070 6920  resolution * pi 
-00030800: 2f20 3138 300a 2020 2020 7468 6574 616c  / 180.    thetal
-00030810: 6973 7420 3d20 6e70 2e6c 696e 7370 6163  ist = np.linspac
-00030820: 6528 0a20 2020 2020 2020 202d 2870 6920  e(.        -(pi 
-00030830: 2d20 7468 6574 6129 2c20 2d74 6865 7461  - theta), -theta
-00030840: 2c20 696e 7428 2870 6920 2d20 3220 2a20  , int((pi - 2 * 
-00030850: 7468 6574 6129 202f 2074 6865 7461 5f72  theta) / theta_r
-00030860: 6573 6f6c 7574 696f 6e29 202b 2032 0a20  esolution) + 2. 
-00030870: 2020 2029 0a20 2020 2073 656d 6963 6972     ).    semicir
-00030880: 636c 655f 7820 3d20 7268 6f20 2a20 636f  cle_x = rho * co
-00030890: 7328 7468 6574 616c 6973 7429 0a20 2020  s(thetalist).   
-000308a0: 2073 656d 6963 6972 636c 655f 7920 3d20   semicircle_y = 
-000308b0: 7268 6f20 2a20 7369 6e28 7468 6574 616c  rho * sin(thetal
-000308c0: 6973 7429 202b 2072 686f 0a0a 2020 2020  ist) + rho..    
-000308d0: 2320 5265 7374 206f 6620 7954 726f 6e0a  # Rest of yTron.
-000308e0: 2020 2020 7863 203d 2072 686f 202a 2063      xc = rho * c
-000308f0: 6f73 2874 6865 7461 290a 2020 2020 7963  os(theta).    yc
-00030900: 203d 2072 686f 202a 2073 696e 2874 6865   = rho * sin(the
-00030910: 7461 290a 2020 2020 6172 6d5f 785f 6c65  ta).    arm_x_le
-00030920: 6674 203d 2061 726d 5f6c 656e 6774 6873  ft = arm_lengths
-00030930: 5b30 5d20 2a20 7369 6e28 7468 6574 6129  [0] * sin(theta)
-00030940: 0a20 2020 2061 726d 5f79 5f6c 6566 7420  .    arm_y_left 
-00030950: 3d20 6172 6d5f 6c65 6e67 7468 735b 305d  = arm_lengths[0]
-00030960: 202a 2063 6f73 2874 6865 7461 290a 2020   * cos(theta).  
-00030970: 2020 6172 6d5f 785f 7269 6768 7420 3d20    arm_x_right = 
-00030980: 6172 6d5f 6c65 6e67 7468 735b 315d 202a  arm_lengths[1] *
-00030990: 2073 696e 2874 6865 7461 290a 2020 2020   sin(theta).    
-000309a0: 6172 6d5f 795f 7269 6768 7420 3d20 6172  arm_y_right = ar
-000309b0: 6d5f 6c65 6e67 7468 735b 315d 202a 2063  m_lengths[1] * c
-000309c0: 6f73 2874 6865 7461 290a 0a20 2020 2023  os(theta)..    #
-000309d0: 2057 7269 7465 206f 7574 2078 2061 6e64   Write out x and
-000309e0: 2079 2063 6f6f 7264 7320 666f 7220 7954   y coords for yT
-000309f0: 726f 6e20 706f 6c79 676f 6e0a 2020 2020  ron polygon.    
-00030a00: 7870 7473 203d 2073 656d 6963 6972 636c  xpts = semicircl
-00030a10: 655f 782e 746f 6c69 7374 2829 202b 205b  e_x.tolist() + [
-00030a20: 0a20 2020 2020 2020 2078 6320 2b20 6172  .        xc + ar
-00030a30: 6d5f 785f 7269 6768 742c 0a20 2020 2020  m_x_right,.     
-00030a40: 2020 2078 6320 2b20 6172 6d5f 785f 7269     xc + arm_x_ri
-00030a50: 6768 7420 2b20 6172 6d5f 7769 6474 6873  ght + arm_widths
-00030a60: 5b31 5d2c 0a20 2020 2020 2020 2078 6320  [1],.        xc 
-00030a70: 2b20 6172 6d5f 7769 6474 6873 5b31 5d2c  + arm_widths[1],
-00030a80: 0a20 2020 2020 2020 2078 6320 2b20 6172  .        xc + ar
-00030a90: 6d5f 7769 6474 6873 5b31 5d2c 0a20 2020  m_widths[1],.   
-00030aa0: 2020 2020 2030 2c0a 2020 2020 2020 2020       0,.        
-00030ab0: 2d28 7863 202b 2061 726d 5f77 6964 7468  -(xc + arm_width
-00030ac0: 735b 305d 292c 0a20 2020 2020 2020 202d  s[0]),.        -
-00030ad0: 2878 6320 2b20 6172 6d5f 7769 6474 6873  (xc + arm_widths
-00030ae0: 5b30 5d29 2c0a 2020 2020 2020 2020 2d28  [0]),.        -(
-00030af0: 7863 202b 2061 726d 5f78 5f6c 6566 7420  xc + arm_x_left 
-00030b00: 2b20 6172 6d5f 7769 6474 6873 5b30 5d29  + arm_widths[0])
-00030b10: 2c0a 2020 2020 2020 2020 2d28 7863 202b  ,.        -(xc +
-00030b20: 2061 726d 5f78 5f6c 6566 7429 2c0a 2020   arm_x_left),.  
-00030b30: 2020 5d0a 2020 2020 7970 7473 203d 2073    ].    ypts = s
-00030b40: 656d 6963 6972 636c 655f 792e 746f 6c69  emicircle_y.toli
-00030b50: 7374 2829 202b 205b 0a20 2020 2020 2020  st() + [.       
-00030b60: 2079 6320 2b20 6172 6d5f 795f 7269 6768   yc + arm_y_righ
-00030b70: 742c 0a20 2020 2020 2020 2079 6320 2b20  t,.        yc + 
-00030b80: 6172 6d5f 795f 7269 6768 742c 0a20 2020  arm_y_right,.   
-00030b90: 2020 2020 2079 632c 0a20 2020 2020 2020       yc,.       
-00030ba0: 2079 6320 2d20 736f 7572 6365 5f6c 656e   yc - source_len
-00030bb0: 6774 682c 0a20 2020 2020 2020 2079 6320  gth,.        yc 
-00030bc0: 2d20 736f 7572 6365 5f6c 656e 6774 682c  - source_length,
-00030bd0: 0a20 2020 2020 2020 2079 6320 2d20 736f  .        yc - so
-00030be0: 7572 6365 5f6c 656e 6774 682c 0a20 2020  urce_length,.   
-00030bf0: 2020 2020 2079 632c 0a20 2020 2020 2020       yc,.       
-00030c00: 2079 6320 2b20 6172 6d5f 795f 6c65 6674   yc + arm_y_left
-00030c10: 2c0a 2020 2020 2020 2020 7963 202b 2061  ,.        yc + a
-00030c20: 726d 5f79 5f6c 6566 742c 0a20 2020 205d  rm_y_left,.    ]
-00030c30: 0a0a 2020 2020 2320 3d3d 3d3d 3d3d 3d3d  ..    # ========
-00030c40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030c50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030c60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030c70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030c80: 3d3d 0a20 2020 2023 2020 4372 6561 7465  ==.    #  Create
-00030c90: 2061 2062 6c61 6e6b 2064 6576 6963 652c   a blank device,
-00030ca0: 2061 6464 2074 6865 2067 656f 6d65 7472   add the geometr
-00030cb0: 792c 2061 6e64 2064 6566 696e 6520 7468  y, and define th
-00030cc0: 6520 706f 7274 730a 2020 2020 2320 3d3d  e ports.    # ==
-00030cd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030ce0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030cf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030d00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030d10: 3d3d 3d3d 3d3d 3d3d 0a20 2020 2044 203d  ========.    D =
-00030d20: 2044 6576 6963 6528 6e61 6d65 3d22 7974   Device(name="yt
-00030d30: 726f 6e22 290a 2020 2020 442e 6164 645f  ron").    D.add_
-00030d40: 706f 6c79 676f 6e28 5b78 7074 732c 2079  polygon([xpts, y
-00030d50: 7074 735d 2c20 6c61 7965 723d 6c61 7965  pts], layer=laye
-00030d60: 7229 0a20 2020 2044 2e61 6464 5f70 6f72  r).    D.add_por
-00030d70: 7428 0a20 2020 2020 2020 206e 616d 653d  t(.        name=
-00030d80: 226c 6566 7422 2c0a 2020 2020 2020 2020  "left",.        
-00030d90: 6d69 6470 6f69 6e74 3d5b 2d28 7863 202b  midpoint=[-(xc +
-00030da0: 2061 726d 5f78 5f6c 6566 7420 2b20 6172   arm_x_left + ar
-00030db0: 6d5f 7769 6474 6873 5b30 5d20 2f20 3229  m_widths[0] / 2)
-00030dc0: 2c20 7963 202b 2061 726d 5f79 5f6c 6566  , yc + arm_y_lef
-00030dd0: 745d 2c0a 2020 2020 2020 2020 7769 6474  t],.        widt
-00030de0: 683d 6172 6d5f 7769 6474 6873 5b30 5d2c  h=arm_widths[0],
-00030df0: 0a20 2020 2020 2020 206f 7269 656e 7461  .        orienta
-00030e00: 7469 6f6e 3d39 302c 0a20 2020 2029 0a20  tion=90,.    ). 
-00030e10: 2020 2044 2e61 6464 5f70 6f72 7428 0a20     D.add_port(. 
-00030e20: 2020 2020 2020 206e 616d 653d 2272 6967         name="rig
-00030e30: 6874 222c 0a20 2020 2020 2020 206d 6964  ht",.        mid
-00030e40: 706f 696e 743d 5b78 6320 2b20 6172 6d5f  point=[xc + arm_
-00030e50: 785f 7269 6768 7420 2b20 6172 6d5f 7769  x_right + arm_wi
-00030e60: 6474 6873 5b31 5d20 2f20 322c 2079 6320  dths[1] / 2, yc 
-00030e70: 2b20 6172 6d5f 795f 7269 6768 745d 2c0a  + arm_y_right],.
-00030e80: 2020 2020 2020 2020 7769 6474 683d 6172          width=ar
-00030e90: 6d5f 7769 6474 6873 5b31 5d2c 0a20 2020  m_widths[1],.   
-00030ea0: 2020 2020 206f 7269 656e 7461 7469 6f6e       orientation
-00030eb0: 3d39 302c 0a20 2020 2029 0a20 2020 2044  =90,.    ).    D
-00030ec0: 2e61 6464 5f70 6f72 7428 0a20 2020 2020  .add_port(.     
-00030ed0: 2020 206e 616d 653d 2273 6f75 7263 6522     name="source"
-00030ee0: 2c0a 2020 2020 2020 2020 6d69 6470 6f69  ,.        midpoi
-00030ef0: 6e74 3d5b 3020 2b20 2861 726d 5f77 6964  nt=[0 + (arm_wid
-00030f00: 7468 735b 315d 202d 2061 726d 5f77 6964  ths[1] - arm_wid
-00030f10: 7468 735b 305d 2920 2f20 322c 202d 736f  ths[0]) / 2, -so
-00030f20: 7572 6365 5f6c 656e 6774 6820 2b20 7963  urce_length + yc
-00030f30: 5d2c 0a20 2020 2020 2020 2077 6964 7468  ],.        width
-00030f40: 3d61 726d 5f77 6964 7468 735b 305d 202b  =arm_widths[0] +
-00030f50: 2061 726d 5f77 6964 7468 735b 315d 202b   arm_widths[1] +
-00030f60: 2032 202a 2078 632c 0a20 2020 2020 2020   2 * xc,.       
-00030f70: 206f 7269 656e 7461 7469 6f6e 3d2d 3930   orientation=-90
-00030f80: 2c0a 2020 2020 290a 0a20 2020 2023 203d  ,.    )..    # =
-00030f90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030fa0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030fb0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030fc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00030fd0: 3d3d 3d3d 3d3d 3d3d 3d0a 2020 2020 2320  =========.    # 
-00030fe0: 2052 6563 6f72 6420 616e 7920 7061 7261   Record any para
-00030ff0: 6d65 7465 7273 2079 6f75 206d 6179 2077  meters you may w
-00031000: 616e 7420 746f 2061 6363 6573 7320 6c61  ant to access la
-00031010: 7465 720a 2020 2020 2320 3d3d 3d3d 3d3d  ter.    # ======
-00031020: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00031030: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00031040: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00031050: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00031060: 3d3d 3d3d 0a20 2020 2044 2e69 6e66 6f5b  ====.    D.info[
-00031070: 2272 686f 225d 203d 2072 686f 0a20 2020  "rho"] = rho.   
-00031080: 2044 2e69 6e66 6f5b 226c 6566 745f 7769   D.info["left_wi
-00031090: 6474 6822 5d20 3d20 6172 6d5f 7769 6474  dth"] = arm_widt
-000310a0: 6873 5b30 5d0a 2020 2020 442e 696e 666f  hs[0].    D.info
-000310b0: 5b22 7269 6768 745f 7769 6474 6822 5d20  ["right_width"] 
-000310c0: 3d20 6172 6d5f 7769 6474 6873 5b31 5d0a  = arm_widths[1].
-000310d0: 2020 2020 442e 696e 666f 5b22 736f 7572      D.info["sour
-000310e0: 6365 5f77 6964 7468 225d 203d 2061 726d  ce_width"] = arm
-000310f0: 5f77 6964 7468 735b 305d 202b 2061 726d  _widths[0] + arm
-00031100: 5f77 6964 7468 735b 315d 202b 2032 202a  _widths[1] + 2 *
-00031110: 2078 630a 0a20 2020 2072 6574 7572 6e20   xc..    return 
-00031120: 440a 0a0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d  D...# ==========
-00031130: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00031140: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00031150: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00031160: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00031170: 3d3d 3d3d 0a23 2045 7861 6d70 6c65 2063  ====.# Example c
-00031180: 6f64 650a 2320 3d3d 3d3d 3d3d 3d3d 3d3d  ode.# ==========
-00031190: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002c920: 6e28 7769 6474 6820 3d20 312c 2070 6974  n(width = 1, pit
+0002c930: 6368 203d 2033 2c20 6c65 6e67 7468 203d  ch = 3, length =
+0002c940: 2033 302c 206e 756d 5f70 7473 203d 2032   30, num_pts = 2
+0002c950: 3029 0a23 2071 7569 636b 706c 6f74 2868  0).# quickplot(h
+0002c960: 6169 7270 696e 290a 0a0a 2320 7374 6570  airpin)...# step
+0002c970: 203d 206f 7074 696d 616c 5f73 7465 7028   = optimal_step(
+0002c980: 7374 6172 745f 7769 6474 6820 3d20 352c  start_width = 5,
+0002c990: 2065 6e64 5f77 6964 7468 203d 2031 2c20   end_width = 1, 
+0002c9a0: 6e75 6d5f 7074 7320 3d20 3830 2c20 7769  num_pts = 80, wi
+0002c9b0: 6474 685f 746f 6c20 3d20 3165 2d33 290a  dth_tol = 1e-3).
+0002c9c0: 2320 7175 6963 6b70 6c6f 7428 7374 6570  # quickplot(step
+0002c9d0: 290a 0a0a 2320 7475 726e 203d 206f 7074  )...# turn = opt
+0002c9e0: 696d 616c 5f39 3064 6567 2877 6964 7468  imal_90deg(width
+0002c9f0: 203d 2039 302c 206c 656e 6774 685f 6164   = 90, length_ad
+0002ca00: 6a75 7374 203d 2031 290a 2320 7175 6963  just = 1).# quic
+0002ca10: 6b70 6c6f 7428 7475 726e 290a 0a0a 2320  kplot(turn)...# 
+0002ca20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002ca30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002ca40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002ca50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002ca60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a23  ==============.#
+0002ca70: 0a23 2053 7570 6572 636f 6e64 7563 7469  .# Superconducti
+0002ca80: 6e67 2064 6576 6963 6573 0a23 0a23 203d  ng devices.#.# =
+0002ca90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002caa0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002cab0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002cac0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002cad0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a0a  =============...
+0002cae0: 4064 6576 6963 655f 6c72 755f 6361 6368  @device_lru_cach
+0002caf0: 650a 6465 6620 736e 7370 6428 0a20 2020  e.def snspd(.   
+0002cb00: 2077 6972 655f 7769 6474 683d 302e 322c   wire_width=0.2,
+0002cb10: 0a20 2020 2077 6972 655f 7069 7463 683d  .    wire_pitch=
+0002cb20: 302e 362c 0a20 2020 2073 697a 653d 2831  0.6,.    size=(1
+0002cb30: 302c 2038 292c 0a20 2020 206e 756d 5f73  0, 8),.    num_s
+0002cb40: 7175 6172 6573 3d4e 6f6e 652c 0a20 2020  quares=None,.   
+0002cb50: 2074 7572 6e5f 7261 7469 6f3d 342c 0a20   turn_ratio=4,. 
+0002cb60: 2020 2074 6572 6d69 6e61 6c73 5f73 616d     terminals_sam
+0002cb70: 655f 7369 6465 3d46 616c 7365 2c0a 2020  e_side=False,.  
+0002cb80: 2020 6c61 7965 723d 302c 0a29 3a0a 2020    layer=0,.):.  
+0002cb90: 2020 2222 2243 7265 6174 6573 2061 6e20    """Creates an 
+0002cba0: 6f70 7469 6d61 6c6c 792d 726f 756e 6465  optimally-rounde
+0002cbb0: 6420 534e 5350 442e 0a0a 2020 2020 5061  d SNSPD...    Pa
+0002cbc0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+0002cbd0: 2d2d 2d2d 2d2d 2d0a 2020 2020 7769 6474  -------.    widt
+0002cbe0: 6820 3a20 696e 7420 6f72 2066 6c6f 6174  h : int or float
+0002cbf0: 0a20 2020 2020 2020 2057 6964 7468 206f  .        Width o
+0002cc00: 6620 7468 6520 7769 7265 2e0a 2020 2020  f the wire..    
+0002cc10: 7069 7463 6820 3a20 696e 7420 6f72 2066  pitch : int or f
+0002cc20: 6c6f 6174 0a20 2020 2020 2020 2044 6973  loat.        Dis
+0002cc30: 7461 6e63 6520 6265 7477 6565 6e20 7477  tance between tw
+0002cc40: 6f20 6164 6a61 6365 6e74 2077 6972 6573  o adjacent wires
+0002cc50: 2e20 4d75 7374 2062 6520 6772 6561 7465  . Must be greate
+0002cc60: 7220 7468 616e 2060 7769 6474 6860 2e0a  r than `width`..
+0002cc70: 2020 2020 7369 7a65 203a 204e 6f6e 6520      size : None 
+0002cc80: 6f72 2061 7272 6179 2d6c 696b 655b 325d  or array-like[2]
+0002cc90: 206f 6620 696e 7420 6f72 2066 6c6f 6174   of int or float
+0002cca0: 0a20 2020 2020 2020 2028 7769 6474 682c  .        (width,
+0002ccb0: 2068 6569 6768 7429 206f 6620 7468 6520   height) of the 
+0002ccc0: 7265 6374 616e 676c 6520 666f 726d 6564  rectangle formed
+0002ccd0: 2062 7920 7468 6520 6f75 7465 7220 626f   by the outer bo
+0002cce0: 756e 6461 7279 206f 6620 7468 650a 2020  undary of the.  
+0002ccf0: 2020 2020 2020 534e 5350 442e 204d 7573        SNSPD. Mus
+0002cd00: 7420 6265 206e 6f6e 6520 6966 2060 6e75  t be none if `nu
+0002cd10: 6d5f 7371 7561 7265 7360 2069 7320 7370  m_squares` is sp
+0002cd20: 6563 6966 6965 642e 0a20 2020 206e 756d  ecified..    num
+0002cd30: 5f73 7175 6172 6573 203a 2069 6e74 206f  _squares : int o
+0002cd40: 7220 4e6f 6e65 0a20 2020 2020 2020 2054  r None.        T
+0002cd50: 6f74 616c 206e 756d 6265 7220 6f66 2073  otal number of s
+0002cd60: 7175 6172 6573 2069 6e73 6964 6520 7468  quares inside th
+0002cd70: 6520 534e 5350 4420 6c65 6e67 7468 2e20  e SNSPD length. 
+0002cd80: 4d75 7374 2062 6520 6e6f 6e65 2069 660a  Must be none if.
+0002cd90: 2020 2020 2020 2020 6073 697a 6560 2069          `size` i
+0002cda0: 7320 7370 6563 6966 6965 642e 0a20 2020  s specified..   
+0002cdb0: 2074 7572 6e5f 7261 7469 6f20 3a20 696e   turn_ratio : in
+0002cdc0: 7420 6f72 2066 6c6f 6174 0a20 2020 2020  t or float.     
+0002cdd0: 2020 2053 7065 6369 6669 6573 2068 6f77     Specifies how
+0002cde0: 206d 7563 6820 6f66 2074 6865 2053 4e53   much of the SNS
+0002cdf0: 5044 2077 6964 7468 2069 7320 6465 6469  PD width is dedi
+0002ce00: 6361 7465 6420 746f 2074 6865 2031 3830  cated to the 180
+0002ce10: 2064 6567 7265 650a 2020 2020 2020 2020   degree.        
+0002ce20: 7475 726e 2e20 4120 6074 7572 6e5f 7261  turn. A `turn_ra
+0002ce30: 7469 6f60 206f 6620 3130 2077 696c 6c20  tio` of 10 will 
+0002ce40: 7265 7375 6c74 2069 6e20 3230 2520 6f66  result in 20% of
+0002ce50: 2074 6865 2077 6964 7468 2062 6569 6e67   the width being
+0002ce60: 0a20 2020 2020 2020 2063 6f6d 7072 6973  .        compris
+0002ce70: 6564 206f 6620 7468 6520 7475 726e 2e0a  ed of the turn..
+0002ce80: 2020 2020 7465 726d 696e 616c 735f 7361      terminals_sa
+0002ce90: 6d65 5f73 6964 6520 3a20 626f 6f6c 0a20  me_side : bool. 
+0002cea0: 2020 2020 2020 2049 6620 5472 7565 2c20         If True, 
+0002ceb0: 626f 7468 2070 6f72 7473 2077 696c 6c20  both ports will 
+0002cec0: 6265 206c 6f63 6174 6564 206f 6e20 7468  be located on th
+0002ced0: 6520 7361 6d65 2073 6964 6520 6f66 2074  e same side of t
+0002cee0: 6865 2053 4e53 5044 2e0a 2020 2020 6c61  he SNSPD..    la
+0002cef0: 7965 7220 3a20 696e 742c 2061 7272 6179  yer : int, array
+0002cf00: 2d6c 696b 655b 325d 2c20 6f72 2073 6574  -like[2], or set
+0002cf10: 0a20 2020 2020 2020 2053 7065 6369 6669  .        Specifi
+0002cf20: 6320 6c61 7965 7228 7329 2074 6f20 7075  c layer(s) to pu
+0002cf30: 7420 706f 6c79 676f 6e20 6765 6f6d 6574  t polygon geomet
+0002cf40: 7279 206f 6e2e 0a0a 2020 2020 5265 7475  ry on...    Retu
+0002cf50: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+0002cf60: 2020 2020 4420 3a20 4465 7669 6365 0a20      D : Device. 
+0002cf70: 2020 2020 2020 2041 2044 6576 6963 6520         A Device 
+0002cf80: 636f 6e74 6169 6e69 6e67 2061 6e20 6f70  containing an op
+0002cf90: 7469 6d61 6c6c 792d 726f 756e 6465 6420  timally-rounded 
+0002cfa0: 534e 5350 442e 0a20 2020 2022 2222 0a20  SNSPD..    """. 
+0002cfb0: 2020 2023 2043 6f6e 7665 6e69 656e 6365     # Convenience
+0002cfc0: 2074 6573 7473 2074 6f20 6175 746f 2d73   tests to auto-s
+0002cfd0: 6861 7065 2074 6865 2073 697a 6520 6261  hape the size ba
+0002cfe0: 7365 640a 2020 2020 2320 6f6e 2074 6865  sed.    # on the
+0002cff0: 206e 756d 6265 7220 6f66 2073 7175 6172   number of squar
+0002d000: 6573 0a20 2020 2069 6620 6e75 6d5f 7371  es.    if num_sq
+0002d010: 7561 7265 7320 6973 206e 6f74 204e 6f6e  uares is not Non
+0002d020: 6520 616e 6420 280a 2020 2020 2020 2020  e and (.        
+0002d030: 2873 697a 6520 6973 204e 6f6e 6529 206f  (size is None) o
+0002d040: 7220 2828 7369 7a65 5b30 5d20 6973 204e  r ((size[0] is N
+0002d050: 6f6e 6529 2061 6e64 2028 7369 7a65 5b31  one) and (size[1
+0002d060: 5d29 2069 7320 4e6f 6e65 290a 2020 2020  ]) is None).    
+0002d070: 293a 0a20 2020 2020 2020 2078 7920 3d20  ):.        xy = 
+0002d080: 6e70 2e73 7172 7428 6e75 6d5f 7371 7561  np.sqrt(num_squa
+0002d090: 7265 7320 2a20 7769 7265 5f70 6974 6368  res * wire_pitch
+0002d0a0: 202a 2077 6972 655f 7769 6474 6829 0a20   * wire_width). 
+0002d0b0: 2020 2020 2020 2073 697a 6520 3d20 5b78         size = [x
+0002d0c0: 792c 2078 795d 0a20 2020 2020 2020 206e  y, xy].        n
+0002d0d0: 756d 5f73 7175 6172 6573 203d 204e 6f6e  um_squares = Non
+0002d0e0: 650a 2020 2020 6966 205b 7369 7a65 5b30  e.    if [size[0
+0002d0f0: 5d2c 2073 697a 655b 315d 2c20 6e75 6d5f  ], size[1], num_
+0002d100: 7371 7561 7265 735d 2e63 6f75 6e74 284e  squares].count(N
+0002d110: 6f6e 6529 2021 3d20 313a 0a20 2020 2020  one) != 1:.     
+0002d120: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+0002d130: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+0002d140: 2022 5b50 4849 444c 5d20 736e 7370 6428   "[PHIDL] snspd(
+0002d150: 2920 7265 7175 6972 6573 2074 6861 7420  ) requires that 
+0002d160: 6578 6163 746c 7920 4f4e 4520 7661 6c75  exactly ONE valu
+0002d170: 6520 6f66 2022 0a20 2020 2020 2020 2020  e of ".         
+0002d180: 2020 2022 7468 6520 6172 6775 6d65 6e74     "the argument
+0002d190: 7320 6060 6e75 6d5f 7371 7561 7265 7360  s ``num_squares`
+0002d1a0: 6020 616e 6420 6060 7369 7a65 6060 2062  ` and ``size`` b
+0002d1b0: 6520 4e6f 6e65 2022 0a20 2020 2020 2020  e None ".       
+0002d1c0: 2020 2020 2022 746f 2070 7265 7665 6e74       "to prevent
+0002d1d0: 206f 7665 7263 6f6e 7374 7261 696e 696e   overconstrainin
+0002d1e0: 672c 2066 6f72 2065 7861 6d70 6c65 3a5c  g, for example:\
+0002d1f0: 6e22 0a20 2020 2020 2020 2020 2020 2022  n".            "
+0002d200: 3e3e 3e20 736e 7370 6428 7369 7a65 203d  >>> snspd(size =
+0002d210: 2028 332c 204e 6f6e 6529 2c20 6e75 6d5f   (3, None), num_
+0002d220: 7371 7561 7265 7320 3d20 3230 3030 2922  squares = 2000)"
+0002d230: 0a20 2020 2020 2020 2029 0a20 2020 2069  .        ).    i
+0002d240: 6620 7369 7a65 5b30 5d20 6973 204e 6f6e  f size[0] is Non
+0002d250: 653a 0a20 2020 2020 2020 2079 7369 7a65  e:.        ysize
+0002d260: 203d 2073 697a 655b 315d 0a20 2020 2020   = size[1].     
+0002d270: 2020 2078 7369 7a65 203d 206e 756d 5f73     xsize = num_s
+0002d280: 7175 6172 6573 202a 2077 6972 655f 7069  quares * wire_pi
+0002d290: 7463 6820 2a20 7769 7265 5f77 6964 7468  tch * wire_width
+0002d2a0: 202f 2079 7369 7a65 0a20 2020 2065 6c69   / ysize.    eli
+0002d2b0: 6620 7369 7a65 5b31 5d20 6973 204e 6f6e  f size[1] is Non
+0002d2c0: 653a 0a20 2020 2020 2020 2078 7369 7a65  e:.        xsize
+0002d2d0: 203d 2073 697a 655b 305d 0a20 2020 2020   = size[0].     
+0002d2e0: 2020 2079 7369 7a65 203d 206e 756d 5f73     ysize = num_s
+0002d2f0: 7175 6172 6573 202a 2077 6972 655f 7069  quares * wire_pi
+0002d300: 7463 6820 2a20 7769 7265 5f77 6964 7468  tch * wire_width
+0002d310: 202f 2078 7369 7a65 0a20 2020 2065 6c73   / xsize.    els
+0002d320: 653a 0a20 2020 2020 2020 2078 7369 7a65  e:.        xsize
+0002d330: 203d 2073 697a 655b 305d 0a20 2020 2020   = size[0].     
+0002d340: 2020 2079 7369 7a65 203d 2073 697a 655b     ysize = size[
+0002d350: 315d 0a0a 2020 2020 6e75 6d5f 6d65 616e  1]..    num_mean
+0002d360: 6465 7273 203d 2069 6e74 286e 702e 6365  ders = int(np.ce
+0002d370: 696c 2879 7369 7a65 202f 2077 6972 655f  il(ysize / wire_
+0002d380: 7069 7463 6829 290a 0a20 2020 2044 203d  pitch))..    D =
+0002d390: 2044 6576 6963 6528 6e61 6d65 3d22 736e   Device(name="sn
+0002d3a0: 7370 6422 290a 2020 2020 6861 6972 7069  spd").    hairpi
+0002d3b0: 6e20 3d20 6f70 7469 6d61 6c5f 6861 6972  n = optimal_hair
+0002d3c0: 7069 6e28 0a20 2020 2020 2020 2077 6964  pin(.        wid
+0002d3d0: 7468 3d77 6972 655f 7769 6474 682c 0a20  th=wire_width,. 
+0002d3e0: 2020 2020 2020 2070 6974 6368 3d77 6972         pitch=wir
+0002d3f0: 655f 7069 7463 682c 0a20 2020 2020 2020  e_pitch,.       
+0002d400: 2074 7572 6e5f 7261 7469 6f3d 7475 726e   turn_ratio=turn
+0002d410: 5f72 6174 696f 2c0a 2020 2020 2020 2020  _ratio,.        
+0002d420: 6c65 6e67 7468 3d78 7369 7a65 202f 2032  length=xsize / 2
+0002d430: 2c0a 2020 2020 2020 2020 6e75 6d5f 7074  ,.        num_pt
+0002d440: 733d 3230 2c0a 2020 2020 2020 2020 6c61  s=20,.        la
+0002d450: 7965 723d 6c61 7965 722c 0a20 2020 2029  yer=layer,.    )
+0002d460: 0a0a 2020 2020 6966 2028 7465 726d 696e  ..    if (termin
+0002d470: 616c 735f 7361 6d65 5f73 6964 6520 6973  als_same_side is
+0002d480: 2046 616c 7365 2920 616e 6420 2828 6e75   False) and ((nu
+0002d490: 6d5f 6d65 616e 6465 7273 2025 2032 2920  m_meanders % 2) 
+0002d4a0: 3d3d 2030 293a 0a20 2020 2020 2020 206e  == 0):.        n
+0002d4b0: 756d 5f6d 6561 6e64 6572 7320 2b3d 2031  um_meanders += 1
+0002d4c0: 0a20 2020 2065 6c69 6620 2874 6572 6d69  .    elif (termi
+0002d4d0: 6e61 6c73 5f73 616d 655f 7369 6465 2069  nals_same_side i
+0002d4e0: 7320 5472 7565 2920 616e 6420 2828 6e75  s True) and ((nu
+0002d4f0: 6d5f 6d65 616e 6465 7273 2025 2032 2920  m_meanders % 2) 
+0002d500: 3d3d 2031 293a 0a20 2020 2020 2020 206e  == 1):.        n
+0002d510: 756d 5f6d 6561 6e64 6572 7320 2b3d 2031  um_meanders += 1
+0002d520: 0a0a 2020 2020 7374 6172 745f 6e77 203d  ..    start_nw =
+0002d530: 2044 2e61 6464 5f72 6566 2863 6f6d 7061   D.add_ref(compa
+0002d540: 7373 2873 697a 653d 5b78 7369 7a65 202f  ss(size=[xsize /
+0002d550: 2032 2c20 7769 7265 5f77 6964 7468 5d2c   2, wire_width],
+0002d560: 206c 6179 6572 3d6c 6179 6572 2929 0a0a   layer=layer))..
+0002d570: 2020 2020 6870 5f70 7265 7620 3d20 442e      hp_prev = D.
+0002d580: 6164 645f 7265 6628 6861 6972 7069 6e29  add_ref(hairpin)
+0002d590: 0a20 2020 2068 705f 7072 6576 2e63 6f6e  .    hp_prev.con
+0002d5a0: 6e65 6374 2831 2c20 7374 6172 745f 6e77  nect(1, start_nw
+0002d5b0: 2e70 6f72 7473 5b22 4522 5d29 0a20 2020  .ports["E"]).   
+0002d5c0: 2061 6c74 6572 6e61 7465 203d 2054 7275   alternate = Tru
+0002d5d0: 650a 2020 2020 666f 7220 6e20 696e 2072  e.    for n in r
+0002d5e0: 616e 6765 2832 2c20 6e75 6d5f 6d65 616e  ange(2, num_mean
+0002d5f0: 6465 7273 293a 0a20 2020 2020 2020 2068  ders):.        h
+0002d600: 7020 3d20 442e 6164 645f 7265 6628 6861  p = D.add_ref(ha
+0002d610: 6972 7069 6e29 0a20 2020 2020 2020 2069  irpin).        i
+0002d620: 6620 616c 7465 726e 6174 653a 0a20 2020  f alternate:.   
+0002d630: 2020 2020 2020 2020 2068 702e 636f 6e6e           hp.conn
+0002d640: 6563 7428 322c 2068 705f 7072 6576 2e70  ect(2, hp_prev.p
+0002d650: 6f72 7473 5b32 5d29 0a20 2020 2020 2020  orts[2]).       
+0002d660: 2020 2020 206c 6173 745f 706f 7274 203d       last_port =
+0002d670: 2068 702e 706f 7274 735b 315d 0a20 2020   hp.ports[1].   
+0002d680: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0002d690: 2020 2020 2020 2068 702e 636f 6e6e 6563         hp.connec
+0002d6a0: 7428 312c 2068 705f 7072 6576 2e70 6f72  t(1, hp_prev.por
+0002d6b0: 7473 5b31 5d29 0a20 2020 2020 2020 2020  ts[1]).         
+0002d6c0: 2020 206c 6173 745f 706f 7274 203d 2068     last_port = h
+0002d6d0: 702e 706f 7274 735b 325d 0a20 2020 2020  p.ports[2].     
+0002d6e0: 2020 2068 705f 7072 6576 203d 2068 700a     hp_prev = hp.
+0002d6f0: 2020 2020 2020 2020 616c 7465 726e 6174          alternat
+0002d700: 6520 3d20 6e6f 7420 616c 7465 726e 6174  e = not alternat
+0002d710: 650a 0a20 2020 2066 696e 6973 685f 7365  e..    finish_se
+0002d720: 203d 2044 2e61 6464 5f72 6566 2863 6f6d   = D.add_ref(com
+0002d730: 7061 7373 2873 697a 653d 5b78 7369 7a65  pass(size=[xsize
+0002d740: 202f 2032 2c20 7769 7265 5f77 6964 7468   / 2, wire_width
+0002d750: 5d2c 206c 6179 6572 3d6c 6179 6572 2929  ], layer=layer))
+0002d760: 0a20 2020 2066 696e 6973 685f 7365 2e63  .    finish_se.c
+0002d770: 6f6e 6e65 6374 2822 4522 2c20 6c61 7374  onnect("E", last
+0002d780: 5f70 6f72 7429 0a0a 2020 2020 442e 6164  _port)..    D.ad
+0002d790: 645f 706f 7274 2870 6f72 743d 7374 6172  d_port(port=star
+0002d7a0: 745f 6e77 2e70 6f72 7473 5b22 5722 5d2c  t_nw.ports["W"],
+0002d7b0: 206e 616d 653d 3129 0a20 2020 2044 2e61   name=1).    D.a
+0002d7c0: 6464 5f70 6f72 7428 706f 7274 3d66 696e  dd_port(port=fin
+0002d7d0: 6973 685f 7365 2e70 6f72 7473 5b22 5722  ish_se.ports["W"
+0002d7e0: 5d2c 206e 616d 653d 3229 0a0a 2020 2020  ], name=2)..    
+0002d7f0: 442e 696e 666f 5b22 6e75 6d5f 7371 7561  D.info["num_squa
+0002d800: 7265 7322 5d20 3d20 6e75 6d5f 6d65 616e  res"] = num_mean
+0002d810: 6465 7273 202a 2028 7873 697a 6520 2f20  ders * (xsize / 
+0002d820: 7769 7265 5f77 6964 7468 290a 2020 2020  wire_width).    
+0002d830: 442e 696e 666f 5b22 6172 6561 225d 203d  D.info["area"] =
+0002d840: 2078 7369 7a65 202a 2079 7369 7a65 0a20   xsize * ysize. 
+0002d850: 2020 2044 2e69 6e66 6f5b 2273 697a 6522     D.info["size"
+0002d860: 5d20 3d20 2878 7369 7a65 2c20 7973 697a  ] = (xsize, ysiz
+0002d870: 6529 0a0a 2020 2020 7265 7475 726e 2044  e)..    return D
+0002d880: 0a0a 0a64 6566 2073 6e73 7064 5f65 7870  ...def snspd_exp
+0002d890: 616e 6465 6428 0a20 2020 2077 6972 655f  anded(.    wire_
+0002d8a0: 7769 6474 683d 302e 322c 0a20 2020 2077  width=0.2,.    w
+0002d8b0: 6972 655f 7069 7463 683d 302e 362c 0a20  ire_pitch=0.6,. 
+0002d8c0: 2020 2073 697a 653d 2831 302c 2038 292c     size=(10, 8),
+0002d8d0: 0a20 2020 206e 756d 5f73 7175 6172 6573  .    num_squares
+0002d8e0: 3d4e 6f6e 652c 0a20 2020 2063 6f6e 6e65  =None,.    conne
+0002d8f0: 6374 6f72 5f77 6964 7468 3d31 2c0a 2020  ctor_width=1,.  
+0002d900: 2020 636f 6e6e 6563 746f 725f 7379 6d6d    connector_symm
+0002d910: 6574 7269 633d 4661 6c73 652c 0a20 2020  etric=False,.   
+0002d920: 2074 7572 6e5f 7261 7469 6f3d 342c 0a20   turn_ratio=4,. 
+0002d930: 2020 2074 6572 6d69 6e61 6c73 5f73 616d     terminals_sam
+0002d940: 655f 7369 6465 3d46 616c 7365 2c0a 2020  e_side=False,.  
+0002d950: 2020 6c61 7965 723d 302c 0a29 3a0a 2020    layer=0,.):.  
+0002d960: 2020 2222 2243 7265 6174 6573 2061 6e20    """Creates an 
+0002d970: 6f70 7469 6d61 6c6c 792d 726f 756e 6465  optimally-rounde
+0002d980: 6420 534e 5350 4420 7769 7468 2077 6972  d SNSPD with wir
+0002d990: 6573 2063 6f6d 696e 6720 6f75 7420 6f66  es coming out of
+0002d9a0: 2069 7420 7468 6174 0a20 2020 2065 7870   it that.    exp
+0002d9b0: 616e 642e 0a0a 2020 2020 5061 7261 6d65  and...    Parame
+0002d9c0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+0002d9d0: 2d2d 2d0a 2020 2020 7769 6474 6820 3a20  ---.    width : 
+0002d9e0: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
+0002d9f0: 2020 2020 2057 6964 7468 206f 6620 7468       Width of th
+0002da00: 6520 7769 7265 2e0a 2020 2020 7069 7463  e wire..    pitc
+0002da10: 6820 3a20 696e 7420 6f72 2066 6c6f 6174  h : int or float
+0002da20: 0a20 2020 2020 2020 2044 6973 7461 6e63  .        Distanc
+0002da30: 6520 6265 7477 6565 6e20 7477 6f20 6164  e between two ad
+0002da40: 6a61 6365 6e74 2077 6972 6573 2e20 4d75  jacent wires. Mu
+0002da50: 7374 2062 6520 6772 6561 7465 7220 7468  st be greater th
+0002da60: 616e 2060 7769 6474 6860 2e0a 2020 2020  an `width`..    
+0002da70: 7369 7a65 203a 204e 6f6e 6520 6f72 2061  size : None or a
+0002da80: 7272 6179 2d6c 696b 655b 325d 206f 6620  rray-like[2] of 
+0002da90: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
+0002daa0: 2020 2020 2028 7769 6474 682c 2068 6569       (width, hei
+0002dab0: 6768 7429 206f 6620 7468 6520 7265 6374  ght) of the rect
+0002dac0: 616e 676c 6520 666f 726d 6564 2062 7920  angle formed by 
+0002dad0: 7468 6520 6f75 7465 7220 626f 756e 6461  the outer bounda
+0002dae0: 7279 206f 6620 7468 650a 2020 2020 2020  ry of the.      
+0002daf0: 2020 534e 5350 442e 204d 7573 7420 6265    SNSPD. Must be
+0002db00: 206e 6f6e 6520 6966 2060 6e75 6d5f 7371   none if `num_sq
+0002db10: 7561 7265 7360 2069 7320 7370 6563 6966  uares` is specif
+0002db20: 6965 642e 0a20 2020 206e 756d 5f73 7175  ied..    num_squ
+0002db30: 6172 6573 203a 2069 6e74 206f 7220 4e6f  ares : int or No
+0002db40: 6e65 0a20 2020 2020 2020 2054 6f74 616c  ne.        Total
+0002db50: 206e 756d 6265 7220 6f66 2073 7175 6172   number of squar
+0002db60: 6573 2069 6e73 6964 6520 7468 6520 534e  es inside the SN
+0002db70: 5350 4420 6c65 6e67 7468 2e20 4d75 7374  SPD length. Must
+0002db80: 2062 6520 6e6f 6e65 2069 660a 2020 2020   be none if.    
+0002db90: 2020 2020 6073 697a 6560 2069 7320 7370      `size` is sp
+0002dba0: 6563 6966 6965 642e 0a20 2020 2063 6f6e  ecified..    con
+0002dbb0: 6e65 6374 6f72 5f77 6964 7468 203a 2069  nector_width : i
+0002dbc0: 6e74 206f 7220 666c 6f61 740a 2020 2020  nt or float.    
+0002dbd0: 2020 2020 5769 6474 6820 6f66 2074 6865      Width of the
+0002dbe0: 2063 6f6e 6e65 6374 6f72 732e 0a20 2020   connectors..   
+0002dbf0: 2063 6f6e 6e65 6374 6f72 5f73 796d 6d65   connector_symme
+0002dc00: 7472 6963 203a 2062 6f6f 6c0a 2020 2020  tric : bool.    
+0002dc10: 2020 2020 4966 2054 7275 652c 206d 6972      If True, mir
+0002dc20: 726f 7273 2074 6865 2063 6f6e 6e65 6374  rors the connect
+0002dc30: 6f72 7320 6163 726f 7373 2074 6865 6972  ors across their
+0002dc40: 2066 6c61 7420 6564 6765 2061 6e64 2061   flat edge and a
+0002dc50: 6464 7320 7468 656d 0a20 2020 2020 2020  dds them.       
+0002dc60: 2074 6f20 7468 6520 636f 6e6e 6563 746f   to the connecto
+0002dc70: 7220 6765 6f6d 6574 7279 2e0a 2020 2020  r geometry..    
+0002dc80: 7475 726e 5f72 6174 696f 203a 2069 6e74  turn_ratio : int
+0002dc90: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
+0002dca0: 2020 5370 6563 6966 6965 7320 686f 7720    Specifies how 
+0002dcb0: 6d75 6368 206f 6620 7468 6520 534e 5350  much of the SNSP
+0002dcc0: 4420 7769 6474 6820 6973 2064 6564 6963  D width is dedic
+0002dcd0: 6174 6564 2074 6f20 7468 6520 3138 3020  ated to the 180 
+0002dce0: 6465 6772 6565 0a20 2020 2020 2020 2074  degree.        t
+0002dcf0: 7572 6e2e 2041 2060 7475 726e 5f72 6174  urn. A `turn_rat
+0002dd00: 696f 6020 6f66 2031 3020 7769 6c6c 2072  io` of 10 will r
+0002dd10: 6573 756c 7420 696e 2032 3025 206f 6620  esult in 20% of 
+0002dd20: 7468 6520 7769 6474 6820 6265 696e 670a  the width being.
+0002dd30: 2020 2020 2020 2020 636f 6d70 7269 7365          comprise
+0002dd40: 6420 6f66 2074 6865 2074 7572 6e2e 0a20  d of the turn.. 
+0002dd50: 2020 2074 6572 6d69 6e61 6c73 5f73 616d     terminals_sam
+0002dd60: 655f 7369 6465 203a 2062 6f6f 6c0a 2020  e_side : bool.  
+0002dd70: 2020 2020 2020 4966 2054 7275 652c 2062        If True, b
+0002dd80: 6f74 6820 706f 7274 7320 7769 6c6c 2062  oth ports will b
+0002dd90: 6520 6c6f 6361 7465 6420 6f6e 2074 6865  e located on the
+0002dda0: 2073 616d 6520 7369 6465 206f 6620 7468   same side of th
+0002ddb0: 6520 534e 5350 442e 0a20 2020 206c 6179  e SNSPD..    lay
+0002ddc0: 6572 203a 2069 6e74 2c20 6172 7261 792d  er : int, array-
+0002ddd0: 6c69 6b65 5b32 5d2c 206f 7220 7365 740a  like[2], or set.
+0002dde0: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
+0002ddf0: 206c 6179 6572 2873 2920 746f 2070 7574   layer(s) to put
+0002de00: 2070 6f6c 7967 6f6e 2067 656f 6d65 7472   polygon geometr
+0002de10: 7920 6f6e 2e0a 0a20 2020 2052 6574 7572  y on...    Retur
+0002de20: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+0002de30: 2020 2044 203a 2044 6576 6963 650a 2020     D : Device.  
+0002de40: 2020 2020 2020 4120 4465 7669 6365 2063        A Device c
+0002de50: 6f6e 7461 696e 696e 6720 616e 206f 7074  ontaining an opt
+0002de60: 696d 616c 6c79 2d72 6f75 6e64 6564 2053  imally-rounded S
+0002de70: 4e53 5044 2077 6974 6820 6578 7061 6e64  NSPD with expand
+0002de80: 696e 6720 696e 7075 742f 0a20 2020 2020  ing input/.     
+0002de90: 2020 206f 7574 7075 7420 7769 7265 732e     output wires.
+0002dea0: 0a20 2020 2022 2222 0a20 2020 2044 203d  .    """.    D =
+0002deb0: 2044 6576 6963 6528 2273 6e73 7064 5f65   Device("snspd_e
+0002dec0: 7870 616e 6465 6422 290a 2020 2020 5320  xpanded").    S 
+0002ded0: 3d20 736e 7370 6428 0a20 2020 2020 2020  = snspd(.       
+0002dee0: 2077 6972 655f 7769 6474 683d 7769 7265   wire_width=wire
+0002def0: 5f77 6964 7468 2c0a 2020 2020 2020 2020  _width,.        
+0002df00: 7769 7265 5f70 6974 6368 3d77 6972 655f  wire_pitch=wire_
+0002df10: 7069 7463 682c 0a20 2020 2020 2020 2073  pitch,.        s
+0002df20: 697a 653d 7369 7a65 2c0a 2020 2020 2020  ize=size,.      
+0002df30: 2020 6e75 6d5f 7371 7561 7265 733d 6e75    num_squares=nu
+0002df40: 6d5f 7371 7561 7265 732c 0a20 2020 2020  m_squares,.     
+0002df50: 2020 2074 7572 6e5f 7261 7469 6f3d 7475     turn_ratio=tu
+0002df60: 726e 5f72 6174 696f 2c0a 2020 2020 2020  rn_ratio,.      
+0002df70: 2020 7465 726d 696e 616c 735f 7361 6d65    terminals_same
+0002df80: 5f73 6964 653d 7465 726d 696e 616c 735f  _side=terminals_
+0002df90: 7361 6d65 5f73 6964 652c 0a20 2020 2020  same_side,.     
+0002dfa0: 2020 206c 6179 6572 3d6c 6179 6572 2c0a     layer=layer,.
+0002dfb0: 2020 2020 290a 2020 2020 7320 3d20 442e      ).    s = D.
+0002dfc0: 6164 645f 7265 6628 5329 0a20 2020 2073  add_ref(S).    s
+0002dfd0: 7465 705f 6465 7669 6365 203d 206f 7074  tep_device = opt
+0002dfe0: 696d 616c 5f73 7465 7028 0a20 2020 2020  imal_step(.     
+0002dff0: 2020 2073 7461 7274 5f77 6964 7468 3d77     start_width=w
+0002e000: 6972 655f 7769 6474 682c 0a20 2020 2020  ire_width,.     
+0002e010: 2020 2065 6e64 5f77 6964 7468 3d63 6f6e     end_width=con
+0002e020: 6e65 6374 6f72 5f77 6964 7468 2c0a 2020  nector_width,.  
+0002e030: 2020 2020 2020 6e75 6d5f 7074 733d 3130        num_pts=10
+0002e040: 302c 0a20 2020 2020 2020 2061 6e74 6963  0,.        antic
+0002e050: 726f 7764 696e 675f 6661 6374 6f72 3d32  rowding_factor=2
+0002e060: 2c0a 2020 2020 2020 2020 7769 6474 685f  ,.        width_
+0002e070: 746f 6c3d 3165 2d33 2c0a 2020 2020 2020  tol=1e-3,.      
+0002e080: 2020 7379 6d6d 6574 7269 633d 636f 6e6e    symmetric=conn
+0002e090: 6563 746f 725f 7379 6d6d 6574 7269 632c  ector_symmetric,
+0002e0a0: 0a20 2020 2020 2020 206c 6179 6572 3d6c  .        layer=l
+0002e0b0: 6179 6572 2c0a 2020 2020 290a 2020 2020  ayer,.    ).    
+0002e0c0: 7374 6570 3120 3d20 442e 6164 645f 7265  step1 = D.add_re
+0002e0d0: 6628 7374 6570 5f64 6576 6963 6529 0a20  f(step_device). 
+0002e0e0: 2020 2073 7465 7032 203d 2044 2e61 6464     step2 = D.add
+0002e0f0: 5f72 6566 2873 7465 705f 6465 7669 6365  _ref(step_device
+0002e100: 290a 2020 2020 7374 6570 312e 636f 6e6e  ).    step1.conn
+0002e110: 6563 7428 706f 7274 3d31 2c20 6465 7374  ect(port=1, dest
+0002e120: 696e 6174 696f 6e3d 732e 706f 7274 735b  ination=s.ports[
+0002e130: 315d 290a 2020 2020 7374 6570 322e 636f  1]).    step2.co
+0002e140: 6e6e 6563 7428 706f 7274 3d31 2c20 6465  nnect(port=1, de
+0002e150: 7374 696e 6174 696f 6e3d 732e 706f 7274  stination=s.port
+0002e160: 735b 325d 290a 2020 2020 442e 6164 645f  s[2]).    D.add_
+0002e170: 706f 7274 286e 616d 653d 312c 2070 6f72  port(name=1, por
+0002e180: 743d 7374 6570 312e 706f 7274 735b 325d  t=step1.ports[2]
+0002e190: 290a 2020 2020 442e 6164 645f 706f 7274  ).    D.add_port
+0002e1a0: 286e 616d 653d 322c 2070 6f72 743d 7374  (name=2, port=st
+0002e1b0: 6570 322e 706f 7274 735b 325d 290a 0a20  ep2.ports[2]).. 
+0002e1c0: 2020 2044 2e69 6e66 6f20 3d20 532e 696e     D.info = S.in
+0002e1d0: 666f 0a20 2020 2053 2e69 6e66 6f20 3d20  fo.    S.info = 
+0002e1e0: 7b7d 0a0a 2020 2020 7265 7475 726e 2044  {}..    return D
+0002e1f0: 0a0a 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d  ...# ===========
+0002e200: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e210: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e220: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e230: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e240: 3d3d 3d0a 2320 4578 616d 706c 6520 636f  ===.# Example co
+0002e250: 6465 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d  de.# ===========
+0002e260: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e270: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e280: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e290: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e2a0: 3d3d 3d0a 0a23 2073 203d 2073 6e73 7064  ===..# s = snspd
+0002e2b0: 2877 6972 655f 7769 6474 6820 3d20 302e  (wire_width = 0.
+0002e2c0: 322c 2077 6972 655f 7069 7463 6820 3d20  2, wire_pitch = 
+0002e2d0: 302e 362c 2073 697a 6520 3d20 5b31 302c  0.6, size = [10,
+0002e2e0: 335d 2c20 7465 726d 696e 616c 735f 7361  3], terminals_sa
+0002e2f0: 6d65 5f73 6964 6520 3d20 5472 7565 290a  me_side = True).
+0002e300: 2320 7175 6963 6b70 6c6f 7428 7329 0a0a  # quickplot(s)..
+0002e310: 2320 7320 3d20 736e 7370 6428 7769 7265  # s = snspd(wire
+0002e320: 5f77 6964 7468 203d 2030 2e32 2c20 7769  _width = 0.2, wi
+0002e330: 7265 5f70 6974 6368 203d 2030 2e36 2c20  re_pitch = 0.6, 
+0002e340: 7369 7a65 203d 205b 3130 2c20 4e6f 6e65  size = [10, None
+0002e350: 5d2c 0a23 2020 2020 2020 2020 2020 6e75  ],.#          nu
+0002e360: 6d5f 7371 7561 7265 7320 3d20 3130 3030  m_squares = 1000
+0002e370: 2c20 7465 726d 696e 616c 735f 7361 6d65  , terminals_same
+0002e380: 5f73 6964 6520 3d20 5472 7565 290a 2320  _side = True).# 
+0002e390: 7175 6963 6b70 6c6f 7428 7329 0a0a 0a64  quickplot(s)...d
+0002e3a0: 6566 2073 6e73 7064 5f63 616e 6465 6c61  ef snspd_candela
+0002e3b0: 6272 6128 2020 2320 6e6f 7161 3a20 4339  bra(  # noqa: C9
+0002e3c0: 3031 0a20 2020 2077 6972 655f 7769 6474  01.    wire_widt
+0002e3d0: 683d 302e 3532 2c0a 2020 2020 7769 7265  h=0.52,.    wire
+0002e3e0: 5f70 6974 6368 3d30 2e35 362c 0a20 2020  _pitch=0.56,.   
+0002e3f0: 2068 6178 6973 3d39 302c 0a20 2020 2076   haxis=90,.    v
+0002e400: 6178 6973 3d35 302c 0a20 2020 2065 7175  axis=50,.    equ
+0002e410: 616c 697a 655f 7061 7468 5f6c 656e 6774  alize_path_lengt
+0002e420: 6873 3d46 616c 7365 2c0a 2020 2020 7877  hs=False,.    xw
+0002e430: 696e 673d 4661 6c73 652c 0a20 2020 206c  ing=False,.    l
+0002e440: 6179 6572 3d30 2c0a 293a 0a20 2020 2022  ayer=0,.):.    "
+0002e450: 2222 4372 6561 7465 7320 616e 206f 7074  ""Creates an opt
+0002e460: 696d 616c 6c79 2d72 6f75 6e64 6564 2053  imally-rounded S
+0002e470: 4e53 5044 2077 6974 6820 6c6f 7720 6375  NSPD with low cu
+0002e480: 7272 656e 7420 6372 6f77 6469 6e67 2061  rrent crowding a
+0002e490: 6e64 0a20 2020 2061 7262 7469 7472 6172  nd.    arbtitrar
+0002e4a0: 696c 792d 6869 6768 2066 696c 6c20 6661  ily-high fill fa
+0002e4b0: 6374 6f72 2061 7320 6465 7363 7269 6265  ctor as describe
+0002e4c0: 6420 6279 2052 6564 6479 2065 742e 2061  d by Reddy et. a
+0002e4d0: 6c2e 2c0a 2020 2020 4150 4c20 5068 6f74  l.,.    APL Phot
+0002e4e0: 6f6e 6963 7320 372c 2030 3531 3330 3220  onics 7, 051302 
+0002e4f0: 2832 3032 3229 2020 6874 7470 733a 2f2f  (2022)  https://
+0002e500: 646f 692e 6f72 672f 3130 2e31 3036 332f  doi.org/10.1063/
+0002e510: 352e 3030 3838 3030 370a 0a20 2020 2050  5.0088007..    P
+0002e520: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+0002e530: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2077 6972  --------.    wir
+0002e540: 655f 7769 6474 6820 3a20 696e 7420 6f72  e_width : int or
+0002e550: 2066 6c6f 6174 0a20 2020 2020 2020 2057   float.        W
+0002e560: 6964 7468 206f 6620 7468 6520 7769 7265  idth of the wire
+0002e570: 2e0a 2020 2020 7769 7265 5f70 6974 6368  ..    wire_pitch
+0002e580: 203a 2069 6e74 206f 7220 666c 6f61 740a   : int or float.
+0002e590: 2020 2020 2020 2020 4469 7374 616e 6365          Distance
+0002e5a0: 2062 6574 7765 656e 2074 776f 2061 646a   between two adj
+0002e5b0: 6163 656e 7420 7769 7265 732e 204d 7573  acent wires. Mus
+0002e5c0: 7420 6265 2067 7265 6174 6572 2074 6861  t be greater tha
+0002e5d0: 6e20 6077 6964 7468 602e 0a20 2020 2068  n `width`..    h
+0002e5e0: 6178 6973 203a 2069 6e74 206f 7220 666c  axis : int or fl
+0002e5f0: 6f61 740a 2020 2020 2020 2020 4c65 6e67  oat.        Leng
+0002e600: 7468 206f 6620 686f 7269 7a6f 6e74 616c  th of horizontal
+0002e610: 2064 6961 676f 6e61 6c20 6f66 2074 6865   diagonal of the
+0002e620: 2072 686f 6d62 6f69 6461 6c20 6163 7469   rhomboidal acti
+0002e630: 7665 2061 7265 612e 0a20 2020 2020 2020  ve area..       
+0002e640: 2054 6865 2070 6172 616d 6574 6572 2060   The parameter `
+0002e650: 6861 7869 7360 2069 7320 7072 696f 7269  haxis` is priori
+0002e660: 7469 7a65 6420 6f76 6572 2060 7661 7869  tized over `vaxi
+0002e670: 7360 2e0a 2020 2020 7661 7869 7320 3a20  s`..    vaxis : 
+0002e680: 696e 7420 6f72 2066 6c6f 6174 0a20 2020  int or float.   
+0002e690: 2020 2020 204c 656e 6774 6820 6f66 2076       Length of v
+0002e6a0: 6572 7469 6361 6c20 6469 6167 6f6e 616c  ertical diagonal
+0002e6b0: 206f 6620 7468 6520 7268 6f6d 626f 6964   of the rhomboid
+0002e6c0: 616c 2061 6374 6976 6520 6172 6561 2e0a  al active area..
+0002e6d0: 2020 2020 6571 7561 6c69 7a65 5f70 6174      equalize_pat
+0002e6e0: 685f 6c65 6e67 7468 7320 3a20 626f 6f6c  h_lengths : bool
+0002e6f0: 0a20 2020 2020 2020 2049 6620 5472 7565  .        If True
+0002e700: 2c20 6164 6473 2077 6972 6520 7365 676d  , adds wire segm
+0002e710: 656e 7473 2074 6f20 6861 6972 7069 6e20  ents to hairpin 
+0002e720: 6265 6e64 7320 746f 2065 7175 616c 697a  bends to equaliz
+0002e730: 6520 7061 7468 206c 656e 6774 6873 0a20  e path lengths. 
+0002e740: 2020 2020 2020 2066 726f 6d20 6365 6e74         from cent
+0002e750: 6572 2074 6f20 6365 6e74 6572 2066 6f72  er to center for
+0002e760: 2061 6c6c 2070 6172 616c 6c65 6c20 7769   all parallel wi
+0002e770: 7265 7320 696e 2061 6374 6976 6520 6172  res in active ar
+0002e780: 6561 2e0a 2020 2020 7877 696e 6720 3a20  ea..    xwing : 
+0002e790: 626f 6f6c 0a20 2020 2020 2020 2049 6620  bool.        If 
+0002e7a0: 5472 7565 2c20 7265 706c 6163 6573 2039  True, replaces 9
+0002e7b0: 302d 6465 6772 6565 2062 656e 6473 2077  0-degree bends w
+0002e7c0: 6974 6820 3133 352d 6465 6772 6565 2062  ith 135-degree b
+0002e7d0: 656e 6473 2e0a 2020 2020 6c61 7965 7220  ends..    layer 
+0002e7e0: 3a20 696e 740a 2020 2020 2020 2020 5370  : int.        Sp
+0002e7f0: 6563 6966 6963 206c 6179 6572 2074 6f20  ecific layer to 
+0002e800: 7075 7420 706f 6c79 676f 6e20 6765 6f6d  put polygon geom
+0002e810: 6574 7279 206f 6e2e 0a0a 2020 2020 5265  etry on...    Re
+0002e820: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+0002e830: 2d0a 2020 2020 4420 3a20 4465 7669 6365  -.    D : Device
+0002e840: 0a20 2020 2020 2020 2041 2044 6576 6963  .        A Devic
+0002e850: 6520 636f 6e74 6169 6e69 6e67 2061 6e20  e containing an 
+0002e860: 6f70 7469 6d61 6c6c 792d 726f 756e 6465  optimally-rounde
+0002e870: 6420 534e 5350 4420 7769 7468 206d 696e  d SNSPD with min
+0002e880: 696d 697a 6564 2063 7572 7265 6e74 0a20  imized current. 
+0002e890: 2020 2020 2020 2063 726f 7764 696e 6720         crowding 
+0002e8a0: 666f 7220 616e 7920 6669 6c6c 2066 6163  for any fill fac
+0002e8b0: 746f 722e 0a20 2020 2022 2222 0a0a 2020  tor..    """..  
+0002e8c0: 2020 6465 6620 6f66 665f 6178 6973 5f75    def off_axis_u
+0002e8d0: 7475 726e 280a 2020 2020 2020 2020 7769  turn(.        wi
+0002e8e0: 7265 5f77 6964 7468 3d30 2e35 322c 0a20  re_width=0.52,. 
+0002e8f0: 2020 2020 2020 2077 6972 655f 7069 7463         wire_pitc
+0002e900: 683d 302e 3536 2c0a 2020 2020 2020 2020  h=0.56,.        
+0002e910: 7066 6163 743d 3130 2e30 202f 2033 2c0a  pfact=10.0 / 3,.
+0002e920: 2020 2020 2020 2020 7368 6172 703d 4661          sharp=Fa
+0002e930: 6c73 652c 0a20 2020 2020 2020 2070 6164  lse,.        pad
+0002e940: 5f6c 656e 6774 683d 302c 0a20 2020 2020  _length=0,.     
+0002e950: 2020 206c 6179 6572 3d30 2c0a 2020 2020     layer=0,.    
+0002e960: 293a 0a20 2020 2020 2020 2022 2222 5265  ):.        """Re
+0002e970: 7475 726e 7320 7068 6964 6c20 6465 7669  turns phidl devi
+0002e980: 6365 206c 6f77 2d63 726f 7764 696e 6720  ce low-crowding 
+0002e990: 752d 7475 726e 2066 6f72 2063 616e 6465  u-turn for cande
+0002e9a0: 6c61 6272 6120 6d65 616e 6465 722e 2222  labra meander.""
+0002e9b0: 220a 2020 2020 2020 2020 6261 7263 203d  ".        barc =
+0002e9c0: 206f 7074 696d 616c 5f39 3064 6567 2877   optimal_90deg(w
+0002e9d0: 6964 7468 3d77 6972 655f 7769 6474 682c  idth=wire_width,
+0002e9e0: 206c 6179 6572 3d6c 6179 6572 290a 2020   layer=layer).  
+0002e9f0: 2020 2020 2020 6966 206e 6f74 2073 6861        if not sha
+0002ea00: 7270 3a0a 2020 2020 2020 2020 2020 2020  rp:.            
+0002ea10: 2320 466f 7220 6e6f 6e2d 726f 756e 6465  # For non-rounde
+0002ea20: 6420 6f75 7465 7220 7261 6469 690a 2020  d outer radii.  
+0002ea30: 2020 2020 2020 2020 2020 2320 4e6f 7420            # Not 
+0002ea40: 6675 6c6c 7920 696d 706c 656d 656e 7465  fully implemente
+0002ea50: 640a 2020 2020 2020 2020 2020 2020 706f  d.            po
+0002ea60: 7274 316d 7020 3d20 5b62 6172 632e 706f  rt1mp = [barc.po
+0002ea70: 7274 735b 315d 2e78 2c20 6261 7263 2e70  rts[1].x, barc.p
+0002ea80: 6f72 7473 5b31 5d2e 795d 0a20 2020 2020  orts[1].y].     
+0002ea90: 2020 2020 2020 2070 6f72 7431 6f72 203d         port1or =
+0002eaa0: 2062 6172 632e 706f 7274 735b 315d 2e6f   barc.ports[1].o
+0002eab0: 7269 656e 7461 7469 6f6e 0a20 2020 2020  rientation.     
+0002eac0: 2020 2020 2020 2070 6f72 7432 6d70 203d         port2mp =
+0002ead0: 205b 6261 7263 2e70 6f72 7473 5b32 5d2e   [barc.ports[2].
+0002eae0: 782c 2062 6172 632e 706f 7274 735b 325d  x, barc.ports[2]
+0002eaf0: 2e79 5d0a 2020 2020 2020 2020 2020 2020  .y].            
+0002eb00: 706f 7274 326f 7220 3d20 6261 7263 2e70  port2or = barc.p
+0002eb10: 6f72 7473 5b32 5d2e 6f72 6965 6e74 6174  orts[2].orientat
+0002eb20: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+0002eb30: 6261 7263 203d 2062 6f6f 6c65 616e 280a  barc = boolean(.
+0002eb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eb50: 413d 6261 7263 2c0a 2020 2020 2020 2020  A=barc,.        
+0002eb60: 2020 2020 2020 2020 423d 636f 7079 2862          B=copy(b
+0002eb70: 6172 6329 2e6d 6f76 6528 5b2d 7769 7265  arc).move([-wire
+0002eb80: 5f77 6964 7468 2c20 2d77 6972 655f 7769  _width, -wire_wi
+0002eb90: 6474 685d 292c 0a20 2020 2020 2020 2020  dth]),.         
+0002eba0: 2020 2020 2020 206f 7065 7261 7469 6f6e         operation
+0002ebb0: 3d22 6e6f 7422 2c0a 2020 2020 2020 2020  ="not",.        
+0002ebc0: 2020 2020 2020 2020 6c61 7965 723d 6c61          layer=la
+0002ebd0: 7965 722c 0a20 2020 2020 2020 2020 2020  yer,.           
+0002ebe0: 2029 0a20 2020 2020 2020 2020 2020 2062   ).            b
+0002ebf0: 6172 632e 6164 645f 706f 7274 280a 2020  arc.add_port(.  
+0002ec00: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+0002ec10: 6d65 3d31 2c20 6d69 6470 6f69 6e74 3d70  me=1, midpoint=p
+0002ec20: 6f72 7431 6d70 2c20 7769 6474 683d 7769  ort1mp, width=wi
+0002ec30: 7265 5f77 6964 7468 2c20 6f72 6965 6e74  re_width, orient
+0002ec40: 6174 696f 6e3d 706f 7274 316f 720a 2020  ation=port1or.  
+0002ec50: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0002ec60: 2020 2020 2020 2020 6261 7263 2e61 6464          barc.add
+0002ec70: 5f70 6f72 7428 0a20 2020 2020 2020 2020  _port(.         
+0002ec80: 2020 2020 2020 206e 616d 653d 322c 206d         name=2, m
+0002ec90: 6964 706f 696e 743d 706f 7274 326d 702c  idpoint=port2mp,
+0002eca0: 2077 6964 7468 3d77 6972 655f 7769 6474   width=wire_widt
+0002ecb0: 682c 206f 7269 656e 7461 7469 6f6e 3d70  h, orientation=p
+0002ecc0: 6f72 7432 6f72 0a20 2020 2020 2020 2020  ort2or.         
+0002ecd0: 2020 2029 0a20 2020 2020 2020 2070 696e     ).        pin
+0002ece0: 203d 206f 7074 696d 616c 5f68 6169 7270   = optimal_hairp
+0002ecf0: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
+0002ed00: 7769 6474 683d 7769 7265 5f77 6964 7468  width=wire_width
+0002ed10: 2c0a 2020 2020 2020 2020 2020 2020 7069  ,.            pi
+0002ed20: 7463 683d 7066 6163 7420 2a20 7769 7265  tch=pfact * wire
+0002ed30: 5f77 6964 7468 2c0a 2020 2020 2020 2020  _width,.        
+0002ed40: 2020 2020 6c65 6e67 7468 3d38 202a 2077      length=8 * w
+0002ed50: 6972 655f 7769 6474 682c 0a20 2020 2020  ire_width,.     
+0002ed60: 2020 2020 2020 206c 6179 6572 3d6c 6179         layer=lay
+0002ed70: 6572 2c0a 2020 2020 2020 2020 290a 2020  er,.        ).  
+0002ed80: 2020 2020 2020 7061 7320 3d20 636f 6d70        pas = comp
+0002ed90: 6173 7328 7369 7a65 3d28 7769 7265 5f77  ass(size=(wire_w
+0002eda0: 6964 7468 2c20 7769 7265 5f70 6974 6368  idth, wire_pitch
+0002edb0: 292c 206c 6179 6572 3d6c 6179 6572 290a  ), layer=layer).
+0002edc0: 2020 2020 2020 2020 4420 3d20 4465 7669          D = Devi
+0002edd0: 6365 2829 0a20 2020 2020 2020 2061 7263  ce().        arc
+0002ede0: 3120 3d20 442e 6164 645f 7265 6628 6261  1 = D.add_ref(ba
+0002edf0: 7263 290a 2020 2020 2020 2020 6172 6331  rc).        arc1
+0002ee00: 2e72 6f74 6174 6528 3930 290a 2020 2020  .rotate(90).    
+0002ee10: 2020 2020 7069 6e31 203d 2044 2e61 6464      pin1 = D.add
+0002ee20: 5f72 6566 2870 696e 290a 2020 2020 2020  _ref(pin).      
+0002ee30: 2020 7069 6e31 2e63 6f6e 6e65 6374 2831    pin1.connect(1
+0002ee40: 2c20 6172 6331 2e70 6f72 7473 5b32 5d29  , arc1.ports[2])
+0002ee50: 0a20 2020 2020 2020 2070 6173 3120 3d20  .        pas1 = 
+0002ee60: 442e 6164 645f 7265 6628 7061 7329 0a20  D.add_ref(pas). 
+0002ee70: 2020 2020 2020 2070 6173 312e 636f 6e6e         pas1.conn
+0002ee80: 6563 7428 7061 7331 2e70 6f72 7473 5b22  ect(pas1.ports["
+0002ee90: 4e22 5d2c 2070 696e 312e 706f 7274 735b  N"], pin1.ports[
+0002eea0: 325d 290a 2020 2020 2020 2020 6172 6332  2]).        arc2
+0002eeb0: 203d 2044 2e61 6464 5f72 6566 2862 6172   = D.add_ref(bar
+0002eec0: 6329 0a20 2020 2020 2020 2061 7263 322e  c).        arc2.
+0002eed0: 636f 6e6e 6563 7428 322c 2070 6173 312e  connect(2, pas1.
+0002eee0: 706f 7274 735b 2253 225d 290a 2020 2020  ports["S"]).    
+0002eef0: 2020 2020 6966 2070 6164 5f6c 656e 6774      if pad_lengt
+0002ef00: 6820 3e20 303a 0a20 2020 2020 2020 2020  h > 0:.         
+0002ef10: 2020 2070 696e 312e 6d6f 7665 7928 7061     pin1.movey(pa
+0002ef20: 645f 6c65 6e67 7468 202a 2030 2e35 290a  d_length * 0.5).
+0002ef30: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+0002ef40: 6320 3d20 442e 6164 645f 7265 6628 0a20  c = D.add_ref(. 
+0002ef50: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0002ef60: 6f6d 7061 7373 280a 2020 2020 2020 2020  ompass(.        
+0002ef70: 2020 2020 2020 2020 2020 2020 7369 7a65              size
+0002ef80: 3d28 7069 6e31 2e70 6f72 7473 5b31 5d2e  =(pin1.ports[1].
+0002ef90: 7769 6474 682c 2070 696e 312e 706f 7274  width, pin1.port
+0002efa0: 735b 315d 2e79 202d 2061 7263 312e 706f  s[1].y - arc1.po
+0002efb0: 7274 735b 325d 2e79 292c 0a20 2020 2020  rts[2].y),.     
+0002efc0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0002efd0: 6179 6572 3d6c 6179 6572 2c0a 2020 2020  ayer=layer,.    
+0002efe0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0002eff0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0002f000: 2020 2020 2020 2020 7465 6d70 632e 636f          tempc.co
+0002f010: 6e6e 6563 7428 224e 222c 2070 696e 312e  nnect("N", pin1.
+0002f020: 706f 7274 735b 315d 290a 2020 2020 2020  ports[1]).      
+0002f030: 2020 2020 2020 7465 6d70 6320 3d20 442e        tempc = D.
+0002f040: 6164 645f 7265 6628 0a20 2020 2020 2020  add_ref(.       
+0002f050: 2020 2020 2020 2020 2063 6f6d 7061 7373           compass
+0002f060: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002f070: 2020 2020 2020 7369 7a65 3d28 7069 6e31        size=(pin1
+0002f080: 2e70 6f72 7473 5b32 5d2e 7769 6474 682c  .ports[2].width,
+0002f090: 2070 696e 312e 706f 7274 735b 325d 2e79   pin1.ports[2].y
+0002f0a0: 202d 2070 6173 312e 706f 7274 735b 224e   - pas1.ports["N
+0002f0b0: 225d 2e79 292c 0a20 2020 2020 2020 2020  "].y),.         
+0002f0c0: 2020 2020 2020 2020 2020 206c 6179 6572             layer
+0002f0d0: 3d6c 6179 6572 2c0a 2020 2020 2020 2020  =layer,.        
+0002f0e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002f0f0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002f100: 2020 2020 7465 6d70 632e 636f 6e6e 6563      tempc.connec
+0002f110: 7428 224e 222c 2070 696e 312e 706f 7274  t("N", pin1.port
+0002f120: 735b 325d 290a 2020 2020 2020 2020 442e  s[2]).        D.
+0002f130: 6164 645f 706f 7274 280a 2020 2020 2020  add_port(.      
+0002f140: 2020 2020 2020 6e61 6d65 3d31 2c0a 2020        name=1,.  
+0002f150: 2020 2020 2020 2020 2020 6d69 6470 6f69            midpoi
+0002f160: 6e74 3d61 7263 312e 706f 7274 735b 315d  nt=arc1.ports[1]
+0002f170: 2e6d 6964 706f 696e 742c 0a20 2020 2020  .midpoint,.     
+0002f180: 2020 2020 2020 2077 6964 7468 3d77 6972         width=wir
+0002f190: 655f 7769 6474 682c 0a20 2020 2020 2020  e_width,.       
+0002f1a0: 2020 2020 206f 7269 656e 7461 7469 6f6e       orientation
+0002f1b0: 3d61 7263 312e 706f 7274 735b 315d 2e6f  =arc1.ports[1].o
+0002f1c0: 7269 656e 7461 7469 6f6e 2c0a 2020 2020  rientation,.    
+0002f1d0: 2020 2020 290a 2020 2020 2020 2020 442e      ).        D.
+0002f1e0: 6164 645f 706f 7274 280a 2020 2020 2020  add_port(.      
+0002f1f0: 2020 2020 2020 6e61 6d65 3d32 2c0a 2020        name=2,.  
+0002f200: 2020 2020 2020 2020 2020 6d69 6470 6f69            midpoi
+0002f210: 6e74 3d61 7263 322e 706f 7274 735b 315d  nt=arc2.ports[1]
+0002f220: 2e6d 6964 706f 696e 742c 0a20 2020 2020  .midpoint,.     
+0002f230: 2020 2020 2020 2077 6964 7468 3d77 6972         width=wir
+0002f240: 655f 7769 6474 682c 0a20 2020 2020 2020  e_width,.       
+0002f250: 2020 2020 206f 7269 656e 7461 7469 6f6e       orientation
+0002f260: 3d61 7263 322e 706f 7274 735b 315d 2e6f  =arc2.ports[1].o
+0002f270: 7269 656e 7461 7469 6f6e 2c0a 2020 2020  rientation,.    
+0002f280: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+0002f290: 7475 726e 2044 0a0a 2020 2020 6465 6620  turn D..    def 
+0002f2a0: 7877 696e 675f 7574 7572 6e28 0a20 2020  xwing_uturn(.   
+0002f2b0: 2020 2020 2077 6972 655f 7769 6474 683d       wire_width=
+0002f2c0: 302e 3532 2c20 7769 7265 5f70 6974 6368  0.52, wire_pitch
+0002f2d0: 3d30 2e35 362c 2070 6661 6374 3d31 302e  =0.56, pfact=10.
+0002f2e0: 3020 2f20 332c 2070 6164 5f6c 656e 6774  0 / 3, pad_lengt
+0002f2f0: 683d 302c 206c 6179 6572 3d30 0a20 2020  h=0, layer=0.   
+0002f300: 2029 3a0a 2020 2020 2020 2020 2222 2252   ):.        """R
+0002f310: 6574 7572 6e73 2070 6869 646c 2064 6576  eturns phidl dev
+0002f320: 6963 6520 6c6f 772d 6372 6f77 6469 6e67  ice low-crowding
+0002f330: 2075 2d74 7572 6e20 666f 7220 582d 7769   u-turn for X-wi
+0002f340: 6e67 206d 6561 6e64 6572 2e22 2222 0a20  ng meander.""". 
+0002f350: 2020 2020 2020 2062 6172 6320 3d20 6172         barc = ar
+0002f360: 6328 0a20 2020 2020 2020 2020 2020 2072  c(.            r
+0002f370: 6164 6975 733d 7769 7265 5f77 6964 7468  adius=wire_width
+0002f380: 202a 2033 2c20 7769 6474 683d 7769 7265   * 3, width=wire
+0002f390: 5f77 6964 7468 2c20 6c61 7965 723d 6c61  _width, layer=la
+0002f3a0: 7965 722c 2074 6865 7461 3d34 350a 2020  yer, theta=45.  
+0002f3b0: 2020 2020 2020 292e 726f 7461 7465 2831        ).rotate(1
+0002f3c0: 3830 290a 0a20 2020 2020 2020 2070 696e  80)..        pin
+0002f3d0: 203d 206f 7074 696d 616c 5f68 6169 7270   = optimal_hairp
+0002f3e0: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
+0002f3f0: 7769 6474 683d 7769 7265 5f77 6964 7468  width=wire_width
+0002f400: 2c0a 2020 2020 2020 2020 2020 2020 7069  ,.            pi
+0002f410: 7463 683d 7066 6163 7420 2a20 7769 7265  tch=pfact * wire
+0002f420: 5f77 6964 7468 2c0a 2020 2020 2020 2020  _width,.        
+0002f430: 2020 2020 6c65 6e67 7468 3d31 3520 2a20      length=15 * 
+0002f440: 7769 7265 5f77 6964 7468 2c0a 2020 2020  wire_width,.    
+0002f450: 2020 2020 2020 2020 6c61 7965 723d 6c61          layer=la
+0002f460: 7965 722c 0a20 2020 2020 2020 2029 0a0a  yer,.        )..
+0002f470: 2020 2020 2020 2020 7061 736c 656e 203d          paslen =
+0002f480: 2070 6661 6374 202a 2077 6972 655f 7769   pfact * wire_wi
+0002f490: 6474 6820 2d20 6e70 2e73 7172 7428 3229  dth - np.sqrt(2)
+0002f4a0: 202a 2077 6972 655f 7069 7463 680a 2020   * wire_pitch.  
+0002f4b0: 2020 2020 2020 7061 7320 3d20 636f 6d70        pas = comp
+0002f4c0: 6173 7328 7369 7a65 3d28 7769 7265 5f77  ass(size=(wire_w
+0002f4d0: 6964 7468 2c20 6162 7328 7061 736c 656e  idth, abs(paslen
+0002f4e0: 2929 2c20 6c61 7965 723d 6c61 7965 7229  )), layer=layer)
+0002f4f0: 0a20 2020 2020 2020 2044 7465 6d70 203d  .        Dtemp =
+0002f500: 2044 6576 6963 6528 290a 2020 2020 2020   Device().      
+0002f510: 2020 6172 6331 203d 2044 7465 6d70 2e61    arc1 = Dtemp.a
+0002f520: 6464 5f72 6566 2862 6172 6329 0a20 2020  dd_ref(barc).   
+0002f530: 2020 2020 2061 7263 312e 726f 7461 7465       arc1.rotate
+0002f540: 2839 3029 0a20 2020 2020 2020 2070 696e  (90).        pin
+0002f550: 3120 3d20 4474 656d 702e 6164 645f 7265  1 = Dtemp.add_re
+0002f560: 6628 7069 6e29 0a20 2020 2020 2020 2070  f(pin).        p
+0002f570: 6173 3120 3d20 4474 656d 702e 6164 645f  as1 = Dtemp.add_
+0002f580: 7265 6628 7061 7329 0a20 2020 2020 2020  ref(pas).       
+0002f590: 2061 7263 3220 3d20 4474 656d 702e 6164   arc2 = Dtemp.ad
+0002f5a0: 645f 7265 6628 6261 7263 290a 2020 2020  d_ref(barc).    
+0002f5b0: 2020 2020 6966 2070 6173 6c65 6e20 3e20      if paslen > 
+0002f5c0: 303a 0a20 2020 2020 2020 2020 2020 2070  0:.            p
+0002f5d0: 6173 312e 636f 6e6e 6563 7428 7061 7331  as1.connect(pas1
+0002f5e0: 2e70 6f72 7473 5b22 5322 5d2c 2061 7263  .ports["S"], arc
+0002f5f0: 312e 706f 7274 735b 325d 290a 2020 2020  1.ports[2]).    
+0002f600: 2020 2020 2020 2020 7069 6e31 2e63 6f6e          pin1.con
+0002f610: 6e65 6374 2831 2c20 7061 7331 2e70 6f72  nect(1, pas1.por
+0002f620: 7473 5b22 4e22 5d29 0a20 2020 2020 2020  ts["N"]).       
+0002f630: 2020 2020 2061 7263 322e 636f 6e6e 6563       arc2.connec
+0002f640: 7428 322c 2070 696e 312e 706f 7274 735b  t(2, pin1.ports[
+0002f650: 325d 290a 2020 2020 2020 2020 656c 7365  2]).        else
+0002f660: 3a0a 2020 2020 2020 2020 2020 2020 7069  :.            pi
+0002f670: 6e31 2e63 6f6e 6e65 6374 2831 2c20 6172  n1.connect(1, ar
+0002f680: 6331 2e70 6f72 7473 5b32 5d29 0a20 2020  c1.ports[2]).   
+0002f690: 2020 2020 2020 2020 2070 6173 312e 636f           pas1.co
+0002f6a0: 6e6e 6563 7428 224e 222c 2070 696e 312e  nnect("N", pin1.
+0002f6b0: 706f 7274 735b 325d 290a 2020 2020 2020  ports[2]).      
+0002f6c0: 2020 2020 2020 6172 6332 2e63 6f6e 6e65        arc2.conne
+0002f6d0: 6374 2832 2c20 7061 7331 2e70 6f72 7473  ct(2, pas1.ports
+0002f6e0: 5b22 5322 5d29 0a20 2020 2020 2020 2069  ["S"]).        i
+0002f6f0: 6620 7061 645f 6c65 6e67 7468 203e 2030  f pad_length > 0
+0002f700: 3a0a 2020 2020 2020 2020 2020 2020 7069  :.            pi
+0002f710: 6e31 2e6d 6f76 6528 5b70 6164 5f6c 656e  n1.move([pad_len
+0002f720: 6774 6820 2a20 302e 3520 2f20 6e70 2e73  gth * 0.5 / np.s
+0002f730: 7172 7428 3229 2c20 7061 645f 6c65 6e67  qrt(2), pad_leng
+0002f740: 7468 202a 2030 2e35 202f 206e 702e 7371  th * 0.5 / np.sq
+0002f750: 7274 2832 295d 290a 2020 2020 2020 2020  rt(2)]).        
+0002f760: 2020 2020 6966 2070 6173 6c65 6e20 3e20      if paslen > 
+0002f770: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0002f780: 2020 2069 6e64 7831 203d 2032 0a20 2020     indx1 = 2.   
+0002f790: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+0002f7a0: 7832 203d 2031 0a20 2020 2020 2020 2020  x2 = 1.         
+0002f7b0: 2020 2020 2020 206d 7961 7263 203d 2061         myarc = a
+0002f7c0: 7263 320a 2020 2020 2020 2020 2020 2020  rc2.            
+0002f7d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0002f7e0: 2020 2020 2020 696e 6478 3120 3d20 310a        indx1 = 1.
+0002f7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f800: 696e 6478 3220 3d20 320a 2020 2020 2020  indx2 = 2.      
+0002f810: 2020 2020 2020 2020 2020 6d79 6172 6320            myarc 
+0002f820: 3d20 6172 6331 0a20 2020 2020 2020 2020  = arc1.         
+0002f830: 2020 2063 6f6d 7064 6973 7420 3d20 6e70     compdist = np
+0002f840: 2e73 7172 7428 0a20 2020 2020 2020 2020  .sqrt(.         
+0002f850: 2020 2020 2020 206e 702e 7375 6d28 6e70         np.sum(np
+0002f860: 2e73 7175 6172 6528 7069 6e31 2e70 6f72  .square(pin1.por
+0002f870: 7473 5b69 6e64 7831 5d2e 6d69 6470 6f69  ts[indx1].midpoi
+0002f880: 6e74 202d 206d 7961 7263 2e70 6f72 7473  nt - myarc.ports
+0002f890: 5b32 5d2e 6d69 6470 6f69 6e74 2929 0a20  [2].midpoint)). 
+0002f8a0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0002f8b0: 2020 2020 2020 2020 2074 656d 7063 203d           tempc =
+0002f8c0: 2044 7465 6d70 2e61 6464 5f72 6566 280a   Dtemp.add_ref(.
+0002f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f8e0: 636f 6d70 6173 7328 7369 7a65 3d28 7069  compass(size=(pi
+0002f8f0: 6e31 2e70 6f72 7473 5b69 6e64 7831 5d2e  n1.ports[indx1].
+0002f900: 7769 6474 682c 2063 6f6d 7064 6973 7429  width, compdist)
+0002f910: 2c20 6c61 7965 723d 6c61 7965 7229 0a20  , layer=layer). 
+0002f920: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0002f930: 2020 2020 2020 2020 2074 656d 7063 2e63           tempc.c
+0002f940: 6f6e 6e65 6374 2822 4e22 2c20 7069 6e31  onnect("N", pin1
+0002f950: 2e70 6f72 7473 5b69 6e64 7831 5d29 0a20  .ports[indx1]). 
+0002f960: 2020 2020 2020 2020 2020 2063 6f6d 7064             compd
+0002f970: 6973 7420 3d20 6e70 2e73 7172 7428 0a20  ist = np.sqrt(. 
+0002f980: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0002f990: 702e 7375 6d28 6e70 2e73 7175 6172 6528  p.sum(np.square(
+0002f9a0: 7069 6e31 2e70 6f72 7473 5b69 6e64 7832  pin1.ports[indx2
+0002f9b0: 5d2e 6d69 6470 6f69 6e74 202d 2070 6173  ].midpoint - pas
+0002f9c0: 312e 706f 7274 735b 224e 225d 2e6d 6964  1.ports["N"].mid
+0002f9d0: 706f 696e 7429 290a 2020 2020 2020 2020  point)).        
+0002f9e0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0002f9f0: 2020 7465 6d70 6320 3d20 4474 656d 702e    tempc = Dtemp.
+0002fa00: 6164 645f 7265 6628 0a20 2020 2020 2020  add_ref(.       
+0002fa10: 2020 2020 2020 2020 2063 6f6d 7061 7373           compass
+0002fa20: 2873 697a 653d 2870 696e 312e 706f 7274  (size=(pin1.port
+0002fa30: 735b 696e 6478 325d 2e77 6964 7468 2c20  s[indx2].width, 
+0002fa40: 636f 6d70 6469 7374 292c 206c 6179 6572  compdist), layer
+0002fa50: 3d6c 6179 6572 290a 2020 2020 2020 2020  =layer).        
+0002fa60: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0002fa70: 2020 7465 6d70 632e 636f 6e6e 6563 7428    tempc.connect(
+0002fa80: 224e 222c 2070 696e 312e 706f 7274 735b  "N", pin1.ports[
+0002fa90: 696e 6478 325d 290a 0a20 2020 2020 2020  indx2])..       
+0002faa0: 2044 7465 6d70 2e61 6464 5f70 6f72 7428   Dtemp.add_port(
+0002fab0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0002fac0: 653d 312c 0a20 2020 2020 2020 2020 2020  e=1,.           
+0002fad0: 206d 6964 706f 696e 743d 6172 6331 2e70   midpoint=arc1.p
+0002fae0: 6f72 7473 5b31 5d2e 6d69 6470 6f69 6e74  orts[1].midpoint
+0002faf0: 2c0a 2020 2020 2020 2020 2020 2020 7769  ,.            wi
+0002fb00: 6474 683d 7769 7265 5f77 6964 7468 2c0a  dth=wire_width,.
+0002fb10: 2020 2020 2020 2020 2020 2020 6f72 6965              orie
+0002fb20: 6e74 6174 696f 6e3d 6172 6331 2e70 6f72  ntation=arc1.por
+0002fb30: 7473 5b31 5d2e 6f72 6965 6e74 6174 696f  ts[1].orientatio
+0002fb40: 6e2c 0a20 2020 2020 2020 2029 0a20 2020  n,.        ).   
+0002fb50: 2020 2020 2044 7465 6d70 2e61 6464 5f70       Dtemp.add_p
+0002fb60: 6f72 7428 0a20 2020 2020 2020 2020 2020  ort(.           
+0002fb70: 206e 616d 653d 322c 0a20 2020 2020 2020   name=2,.       
+0002fb80: 2020 2020 206d 6964 706f 696e 743d 6172       midpoint=ar
+0002fb90: 6332 2e70 6f72 7473 5b31 5d2e 6d69 6470  c2.ports[1].midp
+0002fba0: 6f69 6e74 2c0a 2020 2020 2020 2020 2020  oint,.          
+0002fbb0: 2020 7769 6474 683d 7769 7265 5f77 6964    width=wire_wid
+0002fbc0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+0002fbd0: 6f72 6965 6e74 6174 696f 6e3d 6172 6332  orientation=arc2
+0002fbe0: 2e70 6f72 7473 5b31 5d2e 6f72 6965 6e74  .ports[1].orient
+0002fbf0: 6174 696f 6e2c 0a20 2020 2020 2020 2029  ation,.        )
+0002fc00: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0002fc10: 2044 7465 6d70 0a0a 2020 2020 4420 3d20   Dtemp..    D = 
+0002fc20: 4465 7669 6365 286e 616d 653d 2273 6e73  Device(name="sns
+0002fc30: 7064 5f63 616e 6465 6c61 6272 6122 290a  pd_candelabra").
+0002fc40: 2020 2020 6966 2078 7769 6e67 3a0a 2020      if xwing:.  
+0002fc50: 2020 2020 2020 4474 656d 7020 3d20 7877        Dtemp = xw
+0002fc60: 696e 675f 7574 7572 6e28 7769 7265 5f77  ing_uturn(wire_w
+0002fc70: 6964 7468 3d77 6972 655f 7769 6474 682c  idth=wire_width,
+0002fc80: 2077 6972 655f 7069 7463 683d 7769 7265   wire_pitch=wire
+0002fc90: 5f70 6974 6368 2c20 6c61 7965 723d 6c61  _pitch, layer=la
+0002fca0: 7965 7229 0a20 2020 2065 6c73 653a 0a20  yer).    else:. 
+0002fcb0: 2020 2020 2020 2044 7465 6d70 203d 206f         Dtemp = o
+0002fcc0: 6666 5f61 7869 735f 7574 7572 6e28 0a20  ff_axis_uturn(. 
+0002fcd0: 2020 2020 2020 2020 2020 2077 6972 655f             wire_
+0002fce0: 7769 6474 683d 7769 7265 5f77 6964 7468  width=wire_width
+0002fcf0: 2c20 7769 7265 5f70 6974 6368 3d77 6972  , wire_pitch=wir
+0002fd00: 655f 7069 7463 682c 206c 6179 6572 3d6c  e_pitch, layer=l
+0002fd10: 6179 6572 0a20 2020 2020 2020 2029 0a20  ayer.        ). 
+0002fd20: 2020 2044 7465 6d70 5f6d 6972 726f 7265     Dtemp_mirrore
+0002fd30: 6420 3d20 6465 6570 636f 7079 2844 7465  d = deepcopy(Dte
+0002fd40: 6d70 292e 6d69 7272 6f72 285b 302c 2030  mp).mirror([0, 0
+0002fd50: 5d2c 205b 302c 2031 5d29 0a20 2020 2070  ], [0, 1]).    p
+0002fd60: 6164 6469 6e67 203d 2044 7465 6d70 2e78  adding = Dtemp.x
+0002fd70: 7369 7a65 0a20 2020 206d 6178 6c6c 203d  size.    maxll =
+0002fd80: 2068 6178 6973 202d 2032 202a 2070 6164   haxis - 2 * pad
+0002fd90: 6469 6e67 0a20 2020 2064 6c6c 203d 2061  ding.    dll = a
+0002fda0: 6273 2844 7465 6d70 2e70 6f72 7473 5b31  bs(Dtemp.ports[1
+0002fdb0: 5d2e 7820 2d20 4474 656d 702e 706f 7274  ].x - Dtemp.port
+0002fdc0: 735b 325d 2e78 2920 2b20 7769 7265 5f70  s[2].x) + wire_p
+0002fdd0: 6974 6368 0a20 2020 2068 616c 665f 6e75  itch.    half_nu
+0002fde0: 6d5f 6d65 616e 6465 7273 203d 2069 6e74  m_meanders = int
+0002fdf0: 286e 702e 6365 696c 2830 2e35 202a 2076  (np.ceil(0.5 * v
+0002fe00: 6178 6973 202f 2077 6972 655f 7069 7463  axis / wire_pitc
+0002fe10: 6829 2920 2b20 320a 0a20 2020 2069 6620  h)) + 2..    if 
+0002fe20: 7877 696e 673a 0a20 2020 2020 2020 2062  xwing:.        b
+0002fe30: 656e 6420 3d20 442e 6164 645f 7265 6628  end = D.add_ref(
+0002fe40: 0a20 2020 2020 2020 2020 2020 2061 7263  .            arc
+0002fe50: 2872 6164 6975 733d 7769 7265 5f77 6964  (radius=wire_wid
+0002fe60: 7468 202a 2033 2c20 7769 6474 683d 7769  th * 3, width=wi
+0002fe70: 7265 5f77 6964 7468 2c20 7468 6574 613d  re_width, theta=
+0002fe80: 3930 2c20 6c61 7965 723d 6c61 7965 7229  90, layer=layer)
+0002fe90: 0a20 2020 2020 2020 2029 2e72 6f74 6174  .        ).rotat
+0002fea0: 6528 3138 3029 0a20 2020 2065 6c73 653a  e(180).    else:
+0002feb0: 0a20 2020 2020 2020 2062 656e 6420 3d20  .        bend = 
+0002fec0: 442e 6164 645f 7265 6628 6f70 7469 6d61  D.add_ref(optima
+0002fed0: 6c5f 3930 6465 6728 7769 6474 683d 7769  l_90deg(width=wi
+0002fee0: 7265 5f77 6964 7468 2c20 6c61 7965 723d  re_width, layer=
+0002fef0: 6c61 7965 7229 290a 2020 2020 6966 2028  layer)).    if (
+0002ff00: 6d61 786c 6c20 2d20 646c 6c20 2a20 6861  maxll - dll * ha
+0002ff10: 6c66 5f6e 756d 5f6d 6561 6e64 6572 7329  lf_num_meanders)
+0002ff20: 203c 3d20 302e 303a 0a20 2020 2020 2020   <= 0.0:.       
+0002ff30: 2077 6869 6c65 2028 6d61 786c 6c20 2d20   while (maxll - 
+0002ff40: 646c 6c20 2a20 6861 6c66 5f6e 756d 5f6d  dll * half_num_m
+0002ff50: 6561 6e64 6572 7329 203c 3d20 302e 303a  eanders) <= 0.0:
+0002ff60: 0a20 2020 2020 2020 2020 2020 2068 616c  .            hal
+0002ff70: 665f 6e75 6d5f 6d65 616e 6465 7273 203d  f_num_meanders =
+0002ff80: 2068 616c 665f 6e75 6d5f 6d65 616e 6465   half_num_meande
+0002ff90: 7273 202d 2031 0a20 2020 2066 7061 7320  rs - 1.    fpas 
+0002ffa0: 3d20 442e 6164 645f 7265 6628 0a20 2020  = D.add_ref(.   
+0002ffb0: 2020 2020 2063 6f6d 7061 7373 2873 697a       compass(siz
+0002ffc0: 653d 2830 2e35 202a 2028 6d61 786c 6c20  e=(0.5 * (maxll 
+0002ffd0: 2d20 646c 6c20 2a20 6861 6c66 5f6e 756d  - dll * half_num
+0002ffe0: 5f6d 6561 6e64 6572 7329 2c20 7769 7265  _meanders), wire
+0002fff0: 5f77 6964 7468 292c 206c 6179 6572 3d6c  _width), layer=l
+00030000: 6179 6572 290a 2020 2020 290a 2020 2020  ayer).    ).    
+00030010: 442e 6d6f 7665 7828 2d62 656e 642e 706f  D.movex(-bend.po
+00030020: 7274 735b 315d 2e78 290a 2020 2020 6670  rts[1].x).    fp
+00030030: 6173 2e63 6f6e 6e65 6374 2866 7061 732e  as.connect(fpas.
+00030040: 706f 7274 735b 2257 225d 2c20 6265 6e64  ports["W"], bend
+00030050: 2e70 6f72 7473 5b32 5d29 0a20 2020 206c  .ports[2]).    l
+00030060: 6c20 3d20 442e 7873 697a 6520 2a20 3220  l = D.xsize * 2 
+00030070: 2d20 7769 7265 5f77 6964 7468 0a20 2020  - wire_width.   
+00030080: 2069 6620 6571 7561 6c69 7a65 5f70 6174   if equalize_pat
+00030090: 685f 6c65 6e67 7468 733a 0a20 2020 2020  h_lengths:.     
+000300a0: 2020 2069 6620 7877 696e 673a 0a20 2020     if xwing:.   
+000300b0: 2020 2020 2020 2020 2044 7465 6d70 203d           Dtemp =
+000300c0: 2078 7769 6e67 5f75 7475 726e 280a 2020   xwing_uturn(.  
+000300d0: 2020 2020 2020 2020 2020 2020 2020 7769                wi
+000300e0: 7265 5f77 6964 7468 3d77 6972 655f 7769  re_width=wire_wi
+000300f0: 6474 682c 0a20 2020 2020 2020 2020 2020  dth,.           
+00030100: 2020 2020 2077 6972 655f 7069 7463 683d       wire_pitch=
+00030110: 7769 7265 5f70 6974 6368 2c0a 2020 2020  wire_pitch,.    
+00030120: 2020 2020 2020 2020 2020 2020 7061 645f              pad_
+00030130: 6c65 6e67 7468 3d28 6d61 786c 6c20 2d20  length=(maxll - 
+00030140: 6c6c 202d 2064 6c6c 2920 2a20 6571 7561  ll - dll) * equa
+00030150: 6c69 7a65 5f70 6174 685f 6c65 6e67 7468  lize_path_length
+00030160: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00030170: 2020 206c 6179 6572 3d6c 6179 6572 2c0a     layer=layer,.
+00030180: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00030190: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000301a0: 2020 2020 2020 2020 4474 656d 7020 3d20          Dtemp = 
+000301b0: 6f66 665f 6178 6973 5f75 7475 726e 280a  off_axis_uturn(.
+000301c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000301d0: 7769 7265 5f77 6964 7468 3d77 6972 655f  wire_width=wire_
+000301e0: 7769 6474 682c 0a20 2020 2020 2020 2020  width,.         
+000301f0: 2020 2020 2020 2077 6972 655f 7069 7463         wire_pitc
+00030200: 683d 7769 7265 5f70 6974 6368 2c0a 2020  h=wire_pitch,.  
+00030210: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00030220: 645f 6c65 6e67 7468 3d28 6d61 786c 6c20  d_length=(maxll 
+00030230: 2d20 6c6c 202d 2064 6c6c 2920 2a20 6571  - ll - dll) * eq
+00030240: 7561 6c69 7a65 5f70 6174 685f 6c65 6e67  ualize_path_leng
+00030250: 7468 732c 0a20 2020 2020 2020 2020 2020  ths,.           
+00030260: 2020 2020 206c 6179 6572 3d6c 6179 6572       layer=layer
+00030270: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00030280: 2020 2020 7574 7572 6e20 3d20 442e 6164      uturn = D.ad
+00030290: 645f 7265 6628 4474 656d 7029 0a20 2020  d_ref(Dtemp).   
+000302a0: 2075 7475 726e 2e63 6f6e 6e65 6374 2831   uturn.connect(1
+000302b0: 2c20 6670 6173 2e70 6f72 7473 5b22 4522  , fpas.ports["E"
+000302c0: 5d29 0a20 2020 2064 6972 5f6c 6566 7420  ]).    dir_left 
+000302d0: 3d20 5472 7565 0a0a 2020 2020 7475 726e  = True..    turn
+000302e0: 5f70 6164 6469 6e67 203d 206d 6178 6c6c  _padding = maxll
+000302f0: 202d 206c 6c20 2d20 3220 2a20 646c 6c0a   - ll - 2 * dll.
+00030300: 0a20 2020 2077 6869 6c65 206c 6c20 3c20  .    while ll < 
+00030310: 6d61 786c 6c20 2d20 646c 6c3a 0a20 2020  maxll - dll:.   
+00030320: 2020 2020 206c 6c20 3d20 6c6c 202b 2064       ll = ll + d
+00030330: 6c6c 0a20 2020 2020 2020 2069 6620 6571  ll.        if eq
+00030340: 7561 6c69 7a65 5f70 6174 685f 6c65 6e67  ualize_path_leng
+00030350: 7468 733a 0a20 2020 2020 2020 2020 2020  ths:.           
+00030360: 2069 6620 7877 696e 673a 0a20 2020 2020   if xwing:.     
+00030370: 2020 2020 2020 2020 2020 2044 7465 6d70             Dtemp
+00030380: 203d 2078 7769 6e67 5f75 7475 726e 280a   = xwing_uturn(.
+00030390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000303a0: 2020 2020 7769 7265 5f77 6964 7468 3d77      wire_width=w
+000303b0: 6972 655f 7769 6474 682c 0a20 2020 2020  ire_width,.     
+000303c0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+000303d0: 6972 655f 7069 7463 683d 7769 7265 5f70  ire_pitch=wire_p
+000303e0: 6974 6368 2c0a 2020 2020 2020 2020 2020  itch,.          
+000303f0: 2020 2020 2020 2020 2020 7061 645f 6c65            pad_le
+00030400: 6e67 7468 3d74 7572 6e5f 7061 6464 696e  ngth=turn_paddin
+00030410: 6720 2a20 6571 7561 6c69 7a65 5f70 6174  g * equalize_pat
+00030420: 685f 6c65 6e67 7468 732c 0a20 2020 2020  h_lengths,.     
+00030430: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00030440: 6179 6572 3d6c 6179 6572 2c0a 2020 2020  ayer=layer,.    
+00030450: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00030460: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00030470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030480: 4474 656d 7020 3d20 6f66 665f 6178 6973  Dtemp = off_axis
+00030490: 5f75 7475 726e 280a 2020 2020 2020 2020  _uturn(.        
+000304a0: 2020 2020 2020 2020 2020 2020 7769 7265              wire
+000304b0: 5f77 6964 7468 3d77 6972 655f 7769 6474  _width=wire_widt
+000304c0: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
+000304d0: 2020 2020 2020 2077 6972 655f 7069 7463         wire_pitc
+000304e0: 683d 7769 7265 5f70 6974 6368 2c0a 2020  h=wire_pitch,.  
+000304f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030500: 2020 7061 645f 6c65 6e67 7468 3d74 7572    pad_length=tur
+00030510: 6e5f 7061 6464 696e 6720 2a20 6571 7561  n_padding * equa
+00030520: 6c69 7a65 5f70 6174 685f 6c65 6e67 7468  lize_path_length
+00030530: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00030540: 2020 2020 2020 206c 6179 6572 3d6c 6179         layer=lay
+00030550: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+00030560: 2020 2020 290a 2020 2020 2020 2020 7475      ).        tu
+00030570: 726e 5f70 6164 6469 6e67 203d 2074 7572  rn_padding = tur
+00030580: 6e5f 7061 6464 696e 6720 2d20 646c 6c0a  n_padding - dll.
+00030590: 2020 2020 2020 2020 6e65 7770 6173 203d          newpas =
+000305a0: 2044 2e61 6464 5f72 6566 2863 6f6d 7061   D.add_ref(compa
+000305b0: 7373 2873 697a 653d 286c 6c2c 2077 6972  ss(size=(ll, wir
+000305c0: 655f 7769 6474 6829 2c20 6c61 7965 723d  e_width), layer=
+000305d0: 6c61 7965 7229 290a 2020 2020 2020 2020  layer)).        
+000305e0: 6966 2064 6972 5f6c 6566 743a 0a20 2020  if dir_left:.   
+000305f0: 2020 2020 2020 2020 206e 6577 7061 732e           newpas.
+00030600: 636f 6e6e 6563 7428 6e65 7770 6173 2e70  connect(newpas.p
+00030610: 6f72 7473 5b22 4522 5d2c 2075 7475 726e  orts["E"], uturn
+00030620: 2e70 6f72 7473 5b32 5d29 0a20 2020 2020  .ports[2]).     
+00030630: 2020 2020 2020 2069 6620 6571 7561 6c69         if equali
+00030640: 7a65 5f70 6174 685f 6c65 6e67 7468 733a  ze_path_lengths:
+00030650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030660: 2075 7475 726e 203d 2044 2e61 6464 5f72   uturn = D.add_r
+00030670: 6566 2844 7465 6d70 2e6d 6972 726f 7228  ef(Dtemp.mirror(
+00030680: 5b30 2c20 305d 2c20 5b30 2c20 315d 2929  [0, 0], [0, 1]))
+00030690: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+000306a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000306b0: 2020 2075 7475 726e 203d 2044 2e61 6464     uturn = D.add
+000306c0: 5f72 6566 2844 7465 6d70 5f6d 6972 726f  _ref(Dtemp_mirro
+000306d0: 7265 6429 0a20 2020 2020 2020 2020 2020  red).           
+000306e0: 2075 7475 726e 2e63 6f6e 6e65 6374 2831   uturn.connect(1
+000306f0: 2c20 6e65 7770 6173 2e70 6f72 7473 5b22  , newpas.ports["
+00030700: 5722 5d29 0a20 2020 2020 2020 2020 2020  W"]).           
+00030710: 2064 6972 5f6c 6566 7420 3d20 4661 6c73   dir_left = Fals
+00030720: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
+00030730: 2020 2020 2020 2020 2020 2020 6e65 7770              newp
+00030740: 6173 2e63 6f6e 6e65 6374 286e 6577 7061  as.connect(newpa
+00030750: 732e 706f 7274 735b 2257 225d 2c20 7574  s.ports["W"], ut
+00030760: 7572 6e2e 706f 7274 735b 325d 290a 2020  urn.ports[2]).  
+00030770: 2020 2020 2020 2020 2020 7574 7572 6e20            uturn 
+00030780: 3d20 442e 6164 645f 7265 6628 4474 656d  = D.add_ref(Dtem
+00030790: 7029 0a20 2020 2020 2020 2020 2020 2075  p).            u
+000307a0: 7475 726e 2e63 6f6e 6e65 6374 2831 2c20  turn.connect(1, 
+000307b0: 6e65 7770 6173 2e70 6f72 7473 5b22 4522  newpas.ports["E"
+000307c0: 5d29 0a20 2020 2020 2020 2020 2020 2064  ]).            d
+000307d0: 6972 5f6c 6566 7420 3d20 5472 7565 0a0a  ir_left = True..
+000307e0: 2020 2020 6e65 7770 6173 203d 2044 2e61      newpas = D.a
+000307f0: 6464 5f72 6566 2863 6f6d 7061 7373 2873  dd_ref(compass(s
+00030800: 697a 653d 286c 6c20 2f20 322c 2077 6972  ize=(ll / 2, wir
+00030810: 655f 7769 6474 6829 2c20 6c61 7965 723d  e_width), layer=
+00030820: 6c61 7965 7229 290a 2020 2020 6966 2064  layer)).    if d
+00030830: 6972 5f6c 6566 743a 0a20 2020 2020 2020  ir_left:.       
+00030840: 206e 6577 7061 732e 636f 6e6e 6563 7428   newpas.connect(
+00030850: 6e65 7770 6173 2e70 6f72 7473 5b22 4522  newpas.ports["E"
+00030860: 5d2c 2075 7475 726e 2e70 6f72 7473 5b32  ], uturn.ports[2
+00030870: 5d29 0a20 2020 2020 2020 2064 6972 5f6c  ]).        dir_l
+00030880: 6566 7420 3d20 4661 6c73 650a 2020 2020  eft = False.    
+00030890: 656c 7365 3a0a 2020 2020 2020 2020 6e65  else:.        ne
+000308a0: 7770 6173 2e63 6f6e 6e65 6374 286e 6577  wpas.connect(new
+000308b0: 7061 732e 706f 7274 735b 2257 225d 2c20  pas.ports["W"], 
+000308c0: 7574 7572 6e2e 706f 7274 735b 325d 290a  uturn.ports[2]).
+000308d0: 2020 2020 2020 2020 6469 725f 6c65 6674          dir_left
+000308e0: 203d 2054 7275 650a 0a20 2020 2044 2e6d   = True..    D.m
+000308f0: 6f76 6578 282d 442e 7829 0a20 2020 2069  ovex(-D.x).    i
+00030900: 6620 6e6f 7420 7877 696e 673a 0a20 2020  f not xwing:.   
+00030910: 2020 2020 2062 656e 642e 6d6f 7665 7828       bend.movex(
+00030920: 2d62 656e 642e 706f 7274 735b 315d 2e78  -bend.ports[1].x
+00030930: 290a 2020 2020 6966 2028 6670 6173 2e70  ).    if (fpas.p
+00030940: 6f72 7473 5b22 5722 5d2e 7820 2d20 6265  orts["W"].x - be
+00030950: 6e64 2e70 6f72 7473 5b32 5d2e 7829 203e  nd.ports[2].x) >
+00030960: 2030 3a0a 2020 2020 2020 2020 7465 6d70   0:.        temp
+00030970: 6320 3d20 442e 6164 645f 7265 6628 0a20  c = D.add_ref(. 
+00030980: 2020 2020 2020 2020 2020 2063 6f6d 7061             compa
+00030990: 7373 280a 2020 2020 2020 2020 2020 2020  ss(.            
+000309a0: 2020 2020 7369 7a65 3d28 6670 6173 2e70      size=(fpas.p
+000309b0: 6f72 7473 5b22 5722 5d2e 7820 2d20 6265  orts["W"].x - be
+000309c0: 6e64 2e70 6f72 7473 5b32 5d2e 782c 2062  nd.ports[2].x, b
+000309d0: 656e 642e 706f 7274 735b 325d 2e77 6964  end.ports[2].wid
+000309e0: 7468 292c 0a20 2020 2020 2020 2020 2020  th),.           
+000309f0: 2020 2020 206c 6179 6572 3d6c 6179 6572       layer=layer
+00030a00: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00030a10: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00030a20: 2020 7465 6d70 632e 636f 6e6e 6563 7428    tempc.connect(
+00030a30: 2245 222c 2066 7061 732e 706f 7274 735b  "E", fpas.ports[
+00030a40: 2257 225d 290a 2020 2020 442e 6d6f 7665  "W"]).    D.move
+00030a50: 285b 2d44 2e78 2c20 2d44 2e79 6d69 6e20  ([-D.x, -D.ymin 
+00030a60: 2d20 7769 7265 5f77 6964 7468 202a 2030  - wire_width * 0
+00030a70: 2e35 5d29 0a20 2020 2044 2e61 6464 5f70  .5]).    D.add_p
+00030a80: 6f72 7428 6e61 6d65 3d31 2c20 706f 7274  ort(name=1, port
+00030a90: 3d62 656e 642e 706f 7274 735b 315d 290a  =bend.ports[1]).
+00030aa0: 2020 2020 6966 2064 6972 5f6c 6566 743a      if dir_left:
+00030ab0: 0a20 2020 2020 2020 2044 2e61 6464 5f70  .        D.add_p
+00030ac0: 6f72 7428 6e61 6d65 3d32 2c20 706f 7274  ort(name=2, port
+00030ad0: 3d6e 6577 7061 732e 706f 7274 735b 2245  =newpas.ports["E
+00030ae0: 225d 290a 2020 2020 656c 7365 3a0a 2020  "]).    else:.  
+00030af0: 2020 2020 2020 442e 6164 645f 706f 7274        D.add_port
+00030b00: 286e 616d 653d 322c 2070 6f72 743d 6e65  (name=2, port=ne
+00030b10: 7770 6173 2e70 6f72 7473 5b22 5722 5d29  wpas.ports["W"])
+00030b20: 0a0a 2020 2020 446f 7574 203d 2044 6576  ..    Dout = Dev
+00030b30: 6963 6528 290a 2020 2020 4431 203d 2044  ice().    D1 = D
+00030b40: 6f75 742e 6164 645f 7265 6628 4429 0a20  out.add_ref(D). 
+00030b50: 2020 2044 3220 3d20 446f 7574 2e61 6464     D2 = Dout.add
+00030b60: 5f72 6566 2863 6f70 7928 4429 2e72 6f74  _ref(copy(D).rot
+00030b70: 6174 6528 3138 3029 290a 2020 2020 7465  ate(180)).    te
+00030b80: 6d70 6320 3d20 446f 7574 2e61 6464 5f72  mpc = Dout.add_r
+00030b90: 6566 280a 2020 2020 2020 2020 636f 6d70  ef(.        comp
+00030ba0: 6173 7328 0a20 2020 2020 2020 2020 2020  ass(.           
+00030bb0: 2073 697a 653d 2861 6273 2844 312e 706f   size=(abs(D1.po
+00030bc0: 7274 735b 325d 2e78 202d 2044 322e 706f  rts[2].x - D2.po
+00030bd0: 7274 735b 325d 2e78 292c 2044 312e 706f  rts[2].x), D1.po
+00030be0: 7274 735b 325d 2e77 6964 7468 292c 206c  rts[2].width), l
+00030bf0: 6179 6572 3d6c 6179 6572 0a20 2020 2020  ayer=layer.     
+00030c00: 2020 2029 0a20 2020 2029 0a20 2020 2069     ).    ).    i
+00030c10: 6620 4431 2e70 6f72 7473 5b32 5d2e 7820  f D1.ports[2].x 
+00030c20: 3e20 4432 2e70 6f72 7473 5b32 5d2e 783a  > D2.ports[2].x:
+00030c30: 0a20 2020 2020 2020 2074 656d 7063 2e63  .        tempc.c
+00030c40: 6f6e 6e65 6374 2822 4522 2c20 4431 2e70  onnect("E", D1.p
+00030c50: 6f72 7473 5b32 5d29 0a20 2020 2065 6c73  orts[2]).    els
+00030c60: 653a 0a20 2020 2020 2020 2074 656d 7063  e:.        tempc
+00030c70: 2e63 6f6e 6e65 6374 2822 5722 2c20 4431  .connect("W", D1
+00030c80: 2e70 6f72 7473 5b32 5d29 0a20 2020 2044  .ports[2]).    D
+00030c90: 6f75 742e 6164 645f 706f 7274 286e 616d  out.add_port(nam
+00030ca0: 653d 312c 2070 6f72 743d 4431 2e70 6f72  e=1, port=D1.por
+00030cb0: 7473 5b31 5d29 0a20 2020 2044 6f75 742e  ts[1]).    Dout.
+00030cc0: 6164 645f 706f 7274 286e 616d 653d 322c  add_port(name=2,
+00030cd0: 2070 6f72 743d 4432 2e70 6f72 7473 5b31   port=D2.ports[1
+00030ce0: 5d29 0a20 2020 2072 6574 7572 6e20 446f  ]).    return Do
+00030cf0: 7574 0a0a 0a64 6566 2079 7472 6f6e 5f72  ut...def ytron_r
+00030d00: 6f75 6e64 280a 2020 2020 7268 6f3d 312c  ound(.    rho=1,
+00030d10: 0a20 2020 2061 726d 5f6c 656e 6774 6873  .    arm_lengths
+00030d20: 3d28 3530 302c 2033 3030 292c 0a20 2020  =(500, 300),.   
+00030d30: 2073 6f75 7263 655f 6c65 6e67 7468 3d35   source_length=5
+00030d40: 3030 2c0a 2020 2020 6172 6d5f 7769 6474  00,.    arm_widt
+00030d50: 6873 3d28 3230 302c 2032 3030 292c 0a20  hs=(200, 200),. 
+00030d60: 2020 2074 6865 7461 3d32 2e35 2c0a 2020     theta=2.5,.  
+00030d70: 2020 7468 6574 615f 7265 736f 6c75 7469    theta_resoluti
+00030d80: 6f6e 3d31 302c 0a20 2020 206c 6179 6572  on=10,.    layer
+00030d90: 3d30 2c0a 293a 0a20 2020 2022 2222 5974  =0,.):.    """Yt
+00030da0: 726f 6e20 7374 7275 6374 7572 6520 666f  ron structure fo
+00030db0: 7220 7375 7065 7263 6f6e 6475 6374 696e  r superconductin
+00030dc0: 6720 6e61 6e6f 7769 7265 730a 0a20 2020  g nanowires..   
+00030dd0: 204d 6343 6175 6768 616e 2c20 412e 204e   McCaughan, A. N
+00030de0: 2e2c 2041 6265 6265 2c20 4e2e 2053 2e2c  ., Abebe, N. S.,
+00030df0: 205a 6861 6f2c 2051 2e2d 592e 2026 2042   Zhao, Q.-Y. & B
+00030e00: 6572 6767 7265 6e2c 204b 2e20 4b2e 0a20  erggren, K. K.. 
+00030e10: 2020 2055 7369 6e67 2047 656f 6d65 7472     Using Geometr
+00030e20: 7920 546f 2053 656e 7365 2043 7572 7265  y To Sense Curre
+00030e30: 6e74 2e20 4e61 6e6f 204c 6574 742e 2031  nt. Nano Lett. 1
+00030e40: 362c 2037 3632 36e2 8093 3736 3331 2028  6, 7626...7631 (
+00030e50: 3230 3136 292e 0a20 2020 2068 7474 703a  2016)..    http:
+00030e60: 2f2f 6478 2e64 6f69 2e6f 7267 2f31 302e  //dx.doi.org/10.
+00030e70: 3130 3231 2f61 6373 2e6e 616e 6f6c 6574  1021/acs.nanolet
+00030e80: 742e 3662 3033 3539 330a 0a20 2020 2050  t.6b03593..    P
+00030e90: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+00030ea0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2072 686f  --------.    rho
+00030eb0: 203a 2069 6e74 206f 7220 666c 6f61 740a   : int or float.
+00030ec0: 2020 2020 2020 2020 5261 6469 7573 206f          Radius o
+00030ed0: 6620 6375 7276 6174 7572 6520 6f66 2079  f curvature of y
+00030ee0: 7472 6f6e 2069 6e74 6572 7365 6374 696f  tron intersectio
+00030ef0: 6e20 706f 696e 740a 2020 2020 6172 6d5f  n point.    arm_
+00030f00: 6c65 6e67 7468 7320 3a20 6172 7261 792d  lengths : array-
+00030f10: 6c69 6b65 5b32 5d20 6f66 2069 6e74 206f  like[2] of int o
+00030f20: 7220 666c 6f61 740a 2020 2020 2020 2020  r float.        
+00030f30: 4c65 6e67 7468 7320 6f66 2074 6865 206c  Lengths of the l
+00030f40: 6566 7420 616e 6420 7269 6768 7420 6172  eft and right ar
+00030f50: 6d73 206f 6620 7468 6520 7954 726f 6e2c  ms of the yTron,
+00030f60: 2072 6573 7065 6374 6976 656c 792e 0a20   respectively.. 
+00030f70: 2020 2073 6f75 7263 655f 6c65 6e67 7468     source_length
+00030f80: 203a 2069 6e74 206f 7220 666c 6f61 740a   : int or float.
+00030f90: 2020 2020 2020 2020 4c65 6e67 7468 206f          Length o
+00030fa0: 6620 7468 6520 736f 7572 6365 206f 6620  f the source of 
+00030fb0: 7468 6520 7954 726f 6e2e 0a20 2020 2061  the yTron..    a
+00030fc0: 726d 5f77 6964 7468 7320 3a20 6172 7261  rm_widths : arra
+00030fd0: 792d 6c69 6b65 5b32 5d20 6f66 2069 6e74  y-like[2] of int
+00030fe0: 206f 7220 666c 6f61 740a 2020 2020 2020   or float.      
+00030ff0: 2020 5769 6474 6873 206f 6620 7468 6520    Widths of the 
+00031000: 6c65 6674 2061 6e64 2072 6967 6874 2061  left and right a
+00031010: 726d 7320 6f66 2074 6865 2079 5472 6f6e  rms of the yTron
+00031020: 2c20 7265 7370 6563 7469 7665 6c79 2e0a  , respectively..
+00031030: 2020 2020 7468 6574 6120 3a20 696e 7420      theta : int 
+00031040: 6f72 2066 6c6f 6174 0a20 2020 2020 2020  or float.       
+00031050: 2041 6e67 6c65 2062 6574 7765 656e 2074   Angle between t
+00031060: 6865 2074 776f 2079 5472 6f6e 2061 726d  he two yTron arm
+00031070: 732e 0a20 2020 2074 6865 7461 5f72 6573  s..    theta_res
+00031080: 6f6c 7574 696f 6e20 3a20 696e 7420 6f72  olution : int or
+00031090: 2066 6c6f 6174 0a20 2020 2020 2020 2041   float.        A
+000310a0: 6e67 6c65 2072 6573 6f6c 7574 696f 6e20  ngle resolution 
+000310b0: 666f 7220 6375 7276 6174 7572 6520 6f66  for curvature of
+000310c0: 2079 7472 6f6e 2069 6e74 6572 7365 6374   ytron intersect
+000310d0: 696f 6e20 706f 696e 740a 2020 2020 6c61  ion point.    la
+000310e0: 7965 7220 3a20 696e 742c 2061 7272 6179  yer : int, array
+000310f0: 2d6c 696b 655b 325d 2c20 6f72 2073 6574  -like[2], or set
+00031100: 0a20 2020 2020 2020 2053 7065 6369 6669  .        Specifi
+00031110: 6320 6c61 7965 7228 7329 2074 6f20 7075  c layer(s) to pu
+00031120: 7420 706f 6c79 676f 6e20 6765 6f6d 6574  t polygon geomet
+00031130: 7279 206f 6e2e 0a0a 2020 2020 5265 7475  ry on...    Retu
+00031140: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+00031150: 2020 2020 4420 3a20 4465 7669 6365 0a20      D : Device. 
+00031160: 2020 2020 2020 2041 2044 6576 6963 6520         A Device 
+00031170: 636f 6e74 6169 6e69 6e67 2061 2079 5472  containing a yTr
+00031180: 6f6e 2067 656f 6d65 7472 792e 0a20 2020  on geometry..   
+00031190: 2022 2222 0a20 2020 2023 203d 3d3d 3d3d   """.    # =====
 000311a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 000311b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 000311c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000311d0: 3d3d 3d3d 0a0a 2320 7920 3d20 7974 726f  ====..# y = ytro
-000311e0: 6e5f 726f 756e 6428 7268 6f20 3d20 312c  n_round(rho = 1,
-000311f0: 2061 726d 5f6c 656e 6774 6873 203d 2028   arm_lengths = (
-00031200: 3530 302c 3330 3029 2c20 2073 6f75 7263  500,300),  sourc
-00031210: 655f 6c65 6e67 7468 203d 2035 3030 2c0a  e_length = 500,.
-00031220: 2320 6172 6d5f 7769 6474 6873 203d 2028  # arm_widths = (
-00031230: 3230 302c 2032 3030 292c 2074 6865 7461  200, 200), theta
-00031240: 203d 2032 2e35 2c20 7468 6574 615f 7265   = 2.5, theta_re
-00031250: 736f 6c75 7469 6f6e 203d 2031 302c 0a23  solution = 10,.#
-00031260: 206c 6179 6572 203d 2030 290a 2320 7175   layer = 0).# qu
-00031270: 6963 6b70 6c6f 7428 7929 0a0a 0a23 2025  ickplot(y)...# %
-00031280: 250a                                     %.
+000311d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000311e0: 3d3d 3d3d 3d0a 2020 2020 2320 2043 7265  =====.    #  Cre
+000311f0: 6174 6520 7468 6520 6261 7369 6320 6765  ate the basic ge
+00031200: 6f6d 6574 7279 0a20 2020 2023 203d 3d3d  ometry.    # ===
+00031210: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031220: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031230: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031240: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031250: 3d3d 3d3d 3d3d 3d0a 2020 2020 7468 6574  =======.    thet
+00031260: 6120 3d20 7468 6574 6120 2a20 7069 202f  a = theta * pi /
+00031270: 2031 3830 0a20 2020 2074 6865 7461 5f72   180.    theta_r
+00031280: 6573 6f6c 7574 696f 6e20 3d20 7468 6574  esolution = thet
+00031290: 615f 7265 736f 6c75 7469 6f6e 202a 2070  a_resolution * p
+000312a0: 6920 2f20 3138 300a 2020 2020 7468 6574  i / 180.    thet
+000312b0: 616c 6973 7420 3d20 6e70 2e6c 696e 7370  alist = np.linsp
+000312c0: 6163 6528 0a20 2020 2020 2020 202d 2870  ace(.        -(p
+000312d0: 6920 2d20 7468 6574 6129 2c20 2d74 6865  i - theta), -the
+000312e0: 7461 2c20 696e 7428 2870 6920 2d20 3220  ta, int((pi - 2 
+000312f0: 2a20 7468 6574 6129 202f 2074 6865 7461  * theta) / theta
+00031300: 5f72 6573 6f6c 7574 696f 6e29 202b 2032  _resolution) + 2
+00031310: 0a20 2020 2029 0a20 2020 2073 656d 6963  .    ).    semic
+00031320: 6972 636c 655f 7820 3d20 7268 6f20 2a20  ircle_x = rho * 
+00031330: 636f 7328 7468 6574 616c 6973 7429 0a20  cos(thetalist). 
+00031340: 2020 2073 656d 6963 6972 636c 655f 7920     semicircle_y 
+00031350: 3d20 7268 6f20 2a20 7369 6e28 7468 6574  = rho * sin(thet
+00031360: 616c 6973 7429 202b 2072 686f 0a0a 2020  alist) + rho..  
+00031370: 2020 2320 5265 7374 206f 6620 7954 726f    # Rest of yTro
+00031380: 6e0a 2020 2020 7863 203d 2072 686f 202a  n.    xc = rho *
+00031390: 2063 6f73 2874 6865 7461 290a 2020 2020   cos(theta).    
+000313a0: 7963 203d 2072 686f 202a 2073 696e 2874  yc = rho * sin(t
+000313b0: 6865 7461 290a 2020 2020 6172 6d5f 785f  heta).    arm_x_
+000313c0: 6c65 6674 203d 2061 726d 5f6c 656e 6774  left = arm_lengt
+000313d0: 6873 5b30 5d20 2a20 7369 6e28 7468 6574  hs[0] * sin(thet
+000313e0: 6129 0a20 2020 2061 726d 5f79 5f6c 6566  a).    arm_y_lef
+000313f0: 7420 3d20 6172 6d5f 6c65 6e67 7468 735b  t = arm_lengths[
+00031400: 305d 202a 2063 6f73 2874 6865 7461 290a  0] * cos(theta).
+00031410: 2020 2020 6172 6d5f 785f 7269 6768 7420      arm_x_right 
+00031420: 3d20 6172 6d5f 6c65 6e67 7468 735b 315d  = arm_lengths[1]
+00031430: 202a 2073 696e 2874 6865 7461 290a 2020   * sin(theta).  
+00031440: 2020 6172 6d5f 795f 7269 6768 7420 3d20    arm_y_right = 
+00031450: 6172 6d5f 6c65 6e67 7468 735b 315d 202a  arm_lengths[1] *
+00031460: 2063 6f73 2874 6865 7461 290a 0a20 2020   cos(theta)..   
+00031470: 2023 2057 7269 7465 206f 7574 2078 2061   # Write out x a
+00031480: 6e64 2079 2063 6f6f 7264 7320 666f 7220  nd y coords for 
+00031490: 7954 726f 6e20 706f 6c79 676f 6e0a 2020  yTron polygon.  
+000314a0: 2020 7870 7473 203d 2073 656d 6963 6972    xpts = semicir
+000314b0: 636c 655f 782e 746f 6c69 7374 2829 202b  cle_x.tolist() +
+000314c0: 205b 0a20 2020 2020 2020 2078 6320 2b20   [.        xc + 
+000314d0: 6172 6d5f 785f 7269 6768 742c 0a20 2020  arm_x_right,.   
+000314e0: 2020 2020 2078 6320 2b20 6172 6d5f 785f       xc + arm_x_
+000314f0: 7269 6768 7420 2b20 6172 6d5f 7769 6474  right + arm_widt
+00031500: 6873 5b31 5d2c 0a20 2020 2020 2020 2078  hs[1],.        x
+00031510: 6320 2b20 6172 6d5f 7769 6474 6873 5b31  c + arm_widths[1
+00031520: 5d2c 0a20 2020 2020 2020 2078 6320 2b20  ],.        xc + 
+00031530: 6172 6d5f 7769 6474 6873 5b31 5d2c 0a20  arm_widths[1],. 
+00031540: 2020 2020 2020 2030 2c0a 2020 2020 2020         0,.      
+00031550: 2020 2d28 7863 202b 2061 726d 5f77 6964    -(xc + arm_wid
+00031560: 7468 735b 305d 292c 0a20 2020 2020 2020  ths[0]),.       
+00031570: 202d 2878 6320 2b20 6172 6d5f 7769 6474   -(xc + arm_widt
+00031580: 6873 5b30 5d29 2c0a 2020 2020 2020 2020  hs[0]),.        
+00031590: 2d28 7863 202b 2061 726d 5f78 5f6c 6566  -(xc + arm_x_lef
+000315a0: 7420 2b20 6172 6d5f 7769 6474 6873 5b30  t + arm_widths[0
+000315b0: 5d29 2c0a 2020 2020 2020 2020 2d28 7863  ]),.        -(xc
+000315c0: 202b 2061 726d 5f78 5f6c 6566 7429 2c0a   + arm_x_left),.
+000315d0: 2020 2020 5d0a 2020 2020 7970 7473 203d      ].    ypts =
+000315e0: 2073 656d 6963 6972 636c 655f 792e 746f   semicircle_y.to
+000315f0: 6c69 7374 2829 202b 205b 0a20 2020 2020  list() + [.     
+00031600: 2020 2079 6320 2b20 6172 6d5f 795f 7269     yc + arm_y_ri
+00031610: 6768 742c 0a20 2020 2020 2020 2079 6320  ght,.        yc 
+00031620: 2b20 6172 6d5f 795f 7269 6768 742c 0a20  + arm_y_right,. 
+00031630: 2020 2020 2020 2079 632c 0a20 2020 2020         yc,.     
+00031640: 2020 2079 6320 2d20 736f 7572 6365 5f6c     yc - source_l
+00031650: 656e 6774 682c 0a20 2020 2020 2020 2079  ength,.        y
+00031660: 6320 2d20 736f 7572 6365 5f6c 656e 6774  c - source_lengt
+00031670: 682c 0a20 2020 2020 2020 2079 6320 2d20  h,.        yc - 
+00031680: 736f 7572 6365 5f6c 656e 6774 682c 0a20  source_length,. 
+00031690: 2020 2020 2020 2079 632c 0a20 2020 2020         yc,.     
+000316a0: 2020 2079 6320 2b20 6172 6d5f 795f 6c65     yc + arm_y_le
+000316b0: 6674 2c0a 2020 2020 2020 2020 7963 202b  ft,.        yc +
+000316c0: 2061 726d 5f79 5f6c 6566 742c 0a20 2020   arm_y_left,.   
+000316d0: 205d 0a0a 2020 2020 2320 3d3d 3d3d 3d3d   ]..    # ======
+000316e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000316f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031700: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031710: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031720: 3d3d 3d3d 0a20 2020 2023 2020 4372 6561  ====.    #  Crea
+00031730: 7465 2061 2062 6c61 6e6b 2064 6576 6963  te a blank devic
+00031740: 652c 2061 6464 2074 6865 2067 656f 6d65  e, add the geome
+00031750: 7472 792c 2061 6e64 2064 6566 696e 6520  try, and define 
+00031760: 7468 6520 706f 7274 730a 2020 2020 2320  the ports.    # 
+00031770: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031780: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031790: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000317a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000317b0: 3d3d 3d3d 3d3d 3d3d 3d3d 0a20 2020 2044  ==========.    D
+000317c0: 203d 2044 6576 6963 6528 6e61 6d65 3d22   = Device(name="
+000317d0: 7974 726f 6e22 290a 2020 2020 442e 6164  ytron").    D.ad
+000317e0: 645f 706f 6c79 676f 6e28 5b78 7074 732c  d_polygon([xpts,
+000317f0: 2079 7074 735d 2c20 6c61 7965 723d 6c61   ypts], layer=la
+00031800: 7965 7229 0a20 2020 2044 2e61 6464 5f70  yer).    D.add_p
+00031810: 6f72 7428 0a20 2020 2020 2020 206e 616d  ort(.        nam
+00031820: 653d 226c 6566 7422 2c0a 2020 2020 2020  e="left",.      
+00031830: 2020 6d69 6470 6f69 6e74 3d5b 2d28 7863    midpoint=[-(xc
+00031840: 202b 2061 726d 5f78 5f6c 6566 7420 2b20   + arm_x_left + 
+00031850: 6172 6d5f 7769 6474 6873 5b30 5d20 2f20  arm_widths[0] / 
+00031860: 3229 2c20 7963 202b 2061 726d 5f79 5f6c  2), yc + arm_y_l
+00031870: 6566 745d 2c0a 2020 2020 2020 2020 7769  eft],.        wi
+00031880: 6474 683d 6172 6d5f 7769 6474 6873 5b30  dth=arm_widths[0
+00031890: 5d2c 0a20 2020 2020 2020 206f 7269 656e  ],.        orien
+000318a0: 7461 7469 6f6e 3d39 302c 0a20 2020 2029  tation=90,.    )
+000318b0: 0a20 2020 2044 2e61 6464 5f70 6f72 7428  .    D.add_port(
+000318c0: 0a20 2020 2020 2020 206e 616d 653d 2272  .        name="r
+000318d0: 6967 6874 222c 0a20 2020 2020 2020 206d  ight",.        m
+000318e0: 6964 706f 696e 743d 5b78 6320 2b20 6172  idpoint=[xc + ar
+000318f0: 6d5f 785f 7269 6768 7420 2b20 6172 6d5f  m_x_right + arm_
+00031900: 7769 6474 6873 5b31 5d20 2f20 322c 2079  widths[1] / 2, y
+00031910: 6320 2b20 6172 6d5f 795f 7269 6768 745d  c + arm_y_right]
+00031920: 2c0a 2020 2020 2020 2020 7769 6474 683d  ,.        width=
+00031930: 6172 6d5f 7769 6474 6873 5b31 5d2c 0a20  arm_widths[1],. 
+00031940: 2020 2020 2020 206f 7269 656e 7461 7469         orientati
+00031950: 6f6e 3d39 302c 0a20 2020 2029 0a20 2020  on=90,.    ).   
+00031960: 2044 2e61 6464 5f70 6f72 7428 0a20 2020   D.add_port(.   
+00031970: 2020 2020 206e 616d 653d 2273 6f75 7263       name="sourc
+00031980: 6522 2c0a 2020 2020 2020 2020 6d69 6470  e",.        midp
+00031990: 6f69 6e74 3d5b 3020 2b20 2861 726d 5f77  oint=[0 + (arm_w
+000319a0: 6964 7468 735b 315d 202d 2061 726d 5f77  idths[1] - arm_w
+000319b0: 6964 7468 735b 305d 2920 2f20 322c 202d  idths[0]) / 2, -
+000319c0: 736f 7572 6365 5f6c 656e 6774 6820 2b20  source_length + 
+000319d0: 7963 5d2c 0a20 2020 2020 2020 2077 6964  yc],.        wid
+000319e0: 7468 3d61 726d 5f77 6964 7468 735b 305d  th=arm_widths[0]
+000319f0: 202b 2061 726d 5f77 6964 7468 735b 315d   + arm_widths[1]
+00031a00: 202b 2032 202a 2078 632c 0a20 2020 2020   + 2 * xc,.     
+00031a10: 2020 206f 7269 656e 7461 7469 6f6e 3d2d     orientation=-
+00031a20: 3930 2c0a 2020 2020 290a 0a20 2020 2023  90,.    )..    #
+00031a30: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
+00031a40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031a50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031a60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031a70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2020 2020  ===========.    
+00031a80: 2320 2052 6563 6f72 6420 616e 7920 7061  #  Record any pa
+00031a90: 7261 6d65 7465 7273 2079 6f75 206d 6179  rameters you may
+00031aa0: 2077 616e 7420 746f 2061 6363 6573 7320   want to access 
+00031ab0: 6c61 7465 720a 2020 2020 2320 3d3d 3d3d  later.    # ====
+00031ac0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031ad0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031ae0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031af0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031b00: 3d3d 3d3d 3d3d 0a20 2020 2044 2e69 6e66  ======.    D.inf
+00031b10: 6f5b 2272 686f 225d 203d 2072 686f 0a20  o["rho"] = rho. 
+00031b20: 2020 2044 2e69 6e66 6f5b 226c 6566 745f     D.info["left_
+00031b30: 7769 6474 6822 5d20 3d20 6172 6d5f 7769  width"] = arm_wi
+00031b40: 6474 6873 5b30 5d0a 2020 2020 442e 696e  dths[0].    D.in
+00031b50: 666f 5b22 7269 6768 745f 7769 6474 6822  fo["right_width"
+00031b60: 5d20 3d20 6172 6d5f 7769 6474 6873 5b31  ] = arm_widths[1
+00031b70: 5d0a 2020 2020 442e 696e 666f 5b22 736f  ].    D.info["so
+00031b80: 7572 6365 5f77 6964 7468 225d 203d 2061  urce_width"] = a
+00031b90: 726d 5f77 6964 7468 735b 305d 202b 2061  rm_widths[0] + a
+00031ba0: 726d 5f77 6964 7468 735b 315d 202b 2032  rm_widths[1] + 2
+00031bb0: 202a 2078 630a 0a20 2020 2072 6574 7572   * xc..    retur
+00031bc0: 6e20 440a 0a0a 2320 3d3d 3d3d 3d3d 3d3d  n D...# ========
+00031bd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031be0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031bf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031c00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031c10: 3d3d 3d3d 3d3d 0a23 2045 7861 6d70 6c65  ======.# Example
+00031c20: 2063 6f64 650a 2320 3d3d 3d3d 3d3d 3d3d   code.# ========
+00031c30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031c40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031c50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031c60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00031c70: 3d3d 3d3d 3d3d 0a0a 2320 7920 3d20 7974  ======..# y = yt
+00031c80: 726f 6e5f 726f 756e 6428 7268 6f20 3d20  ron_round(rho = 
+00031c90: 312c 2061 726d 5f6c 656e 6774 6873 203d  1, arm_lengths =
+00031ca0: 2028 3530 302c 3330 3029 2c20 2073 6f75   (500,300),  sou
+00031cb0: 7263 655f 6c65 6e67 7468 203d 2035 3030  rce_length = 500
+00031cc0: 2c0a 2320 6172 6d5f 7769 6474 6873 203d  ,.# arm_widths =
+00031cd0: 2028 3230 302c 2032 3030 292c 2074 6865   (200, 200), the
+00031ce0: 7461 203d 2032 2e35 2c20 7468 6574 615f  ta = 2.5, theta_
+00031cf0: 7265 736f 6c75 7469 6f6e 203d 2031 302c  resolution = 10,
+00031d00: 0a23 206c 6179 6572 203d 2030 290a 2320  .# layer = 0).# 
+00031d10: 7175 6963 6b70 6c6f 7428 7929 0a0a 0a23  quickplot(y)...#
+00031d20: 2025 250a                                 %%.
```

### Comparing `phidl-1.7.0/phidl/path.py` & `phidl-1.7.1/phidl/path.py`

 * *Files identical despite different names*

### Comparing `phidl-1.7.0/phidl/quickplotter.py` & `phidl-1.7.1/phidl/quickplotter.py`

 * *Files identical despite different names*

### Comparing `phidl-1.7.0/phidl/routing.py` & `phidl-1.7.1/phidl/routing.py`

 * *Files identical despite different names*

### Comparing `phidl-1.7.0/phidl/utilities.py` & `phidl-1.7.1/phidl/utilities.py`

 * *Files identical despite different names*

### Comparing `phidl-1.7.0/phidl.egg-info/PKG-INFO` & `phidl-1.7.1/README.md`

 * *Files 8% similar despite different names*

```diff
@@ -1,45 +1,34 @@
-Metadata-Version: 2.1
-Name: phidl
-Version: 1.7.0
-Summary: PHIDL
-Author: Adam McCaughan
-Author-email: amccaugh@gmail.com
-Description-Content-Type: text/markdown
-License-File: LICENSE
-
 [![pytest](https://github.com/amccaugh/phidl/actions/workflows/pytest.yml/badge.svg)](https://github.com/amccaugh/phidl/actions/workflows/pytest.yml)
 [![pre-commit](https://github.com/amccaugh/phidl/actions/workflows/pre-commit.yml/badge.svg)](https://github.com/amccaugh/phidl/actions/workflows/pre-commit.yml)
 
 # PHIDL
 GDS scripting for Python that's intuitive, fast, and powerful.
 
 - [**Installation / requirements**](#installation--requirements)
 - [**Tutorial + examples**](https://phidl.readthedocs.io/en/latest/tutorials.html) (or [try an interactive notebook](https://mybinder.org/v2/gh/amccaugh/phidl/master?filepath=phidl_tutorial_example.ipynb))
 - [**Geometry library + function documentation**](https://phidl.readthedocs.io/en/latest/geometry_reference.html)
-- [Changelog](https://github.com/amccaugh/phidl/blob/master/CHANGELOG.md) (latest update 1.7.0 on April 9, 2024)
--  New KLayout-based boolean/offset/outline functions!  These are under the name `pg.kl_boolean()`, `pg.kl_offset`, `pg.kl_outline()`, `pg.kl_invert()`.  They utilize the excellent KLayout tile processor, which allows breaking down & parallelizing these operations--in a nutshell, these operations should be much, much faster, and they also are more robust than the gdspy/clipper implementation.
--  To use these new functions, you must first `pip install klayout`
+- [Changelog](https://github.com/amccaugh/phidl/blob/master/CHANGELOG.md) (latest update 1.7.1 on April 26, 2024)
+  -  New KLayout-based boolean/offset/outline functions!  These are under the name `pg.kl_boolean()`, `pg.kl_offset`, `pg.kl_outline()`, `pg.kl_invert()`.  They utilize the excellent KLayout tile processor, which allows breaking down & parallelizing these operations--in a nutshell, these operations should be much, much faster, and they also are more robust than the gdspy/clipper implementation. To use these new functions, you must first `pip install klayout`
+  -  `Path.interpolate()` now allows easy placement of objects alongside a path (e.g. for placing vias)
 
 
 # Citation
 
 If you found PHIDL useful, please consider citing it in (just one!) of your publications -- we appreciate it greatly. ([BibTeX](https://raw.githubusercontent.com/amccaugh/phidl/master/CITATION.bib))
  - McCaughan, A. N., et. al. PHIDL: Python-based layout and geometry creation for nanolithography. *J. Vac. Sci. Technol. B* 39, 062601 (2021). http://dx.doi.org/10.1116/6.0001203
 
 # Gallery
 
 <img src="https://amccaugh.github.io/phidl/phidl1.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl2.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl3.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl4.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl5.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl6.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl7.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl8.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl9.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl10.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl11.png" width="30%"></img> <img src="https://amccaugh.github.io/phidl/phidl12.png" width="30%"></img>
 
 # Installation / requirements
 - Install or upgrade with `pip install -U phidl`
 - Python version >=3.6
-- If you are on Windows or Mac and don't already have `gdspy` installed, you will need a C++ compiler
-    - For Windows + Python 3, install ["Build Tools for Visual Studio"](https://visualstudio.microsoft.com/downloads/#build-tools-for-visual-studio-2019) (make sure to check the "C++ build tools" checkbox when installing)
-    - For Mac, install "Xcode" from the App Store, then run the command `xcode-select --install` in the terminal
+
 
 # About PHIDL
 
 *fiddle (verb) - /ˈfidl/ - to make minor manual movements, especially to adjust something*
 
 PHIDL is an open-source GDS-based CAD tool for Python that significantly extends the excellent [gdspy](https://github.com/heitzmann/gdspy).  The base installation includes a large library of simple shapes (e.g. rectangles, circles), photonic structures (e.g. sine curve waveguides), and superconducting nanowire shapes (e.g. single photon detectors) that are fully parameterized. It also has a built-in quick-plotting function based on matplotlib (or Qt) that allows you view the state of any GDS object, useful when scripting geometry-making functions. It also has a [__geometry library reference__](https://phidl.readthedocs.io/) and a set of [__very thorough tutorials__](https://phidl.readthedocs.io/en/latest/tutorials.html) that will walk you through the process of getting acquainted with PHIDL.
```

### Comparing `phidl-1.7.0/setup.py` & `phidl-1.7.1/setup.py`

 * *Files 0% similar despite different names*

```diff
@@ -15,15 +15,15 @@
 this_directory = path.abspath(path.dirname(__file__))
 with open(path.join(this_directory, "README.md"), encoding="utf-8") as f:
     long_description = f.read()
 
 
 setup(
     name="phidl",
-    version="1.7.0",
+    version="1.7.1",
     description="PHIDL",
     long_description=long_description,
     long_description_content_type="text/markdown",
     install_requires=install_requires,
     author="Adam McCaughan",
     author_email="amccaugh@gmail.com",
     packages=["phidl"],
```

### Comparing `phidl-1.7.0/tests/test_device.py` & `phidl-1.7.1/tests/test_device.py`

 * *Files identical despite different names*

### Comparing `phidl-1.7.0/tests/test_geometry.py` & `phidl-1.7.1/tests/test_geometry.py`

 * *Files 4% similar despite different names*

```diff
@@ -276,34 +276,40 @@
     assert h == "2590bd786348ab684616eecdfdbcc9735b156e18"
     h = Ddeepcopy.hash_geometry(precision=1e-4)
     assert h == "0313cd7e58aa265b44dd1ea10265d1088a2f1c6d"
 
 
 def test_write_and_import_gds():
     D = Device()
-    D.add_ref(pg.rectangle(size=[1.5, 2.7], layer=[3, 2]))
+    ref = D.add_ref(pg.rectangle(size=[1.5, 2.7], layer=[3, 2]))
+    ref.properties[0] = "start"
+    ref.properties[2**16 - 1] = "end"  # max allowed key (2 byte unsigned int)
     D.add_ref(pg.rectangle(size=[0.8, 2.5], layer=[9, 7]))
     D.add_array(
         pg.rectangle(size=[1, 2], layer=[4, 66]), rows=3, columns=2, spacing=[14, 7.5]
     )
     D.add_array(
         pg.rectangle(size=[1.5, 2.5], layer=[4, 67]),
         rows=1,
         columns=2,
         spacing=[14, 7.5],
     )
     D.add_polygon([[3, 4, 5], [6.7, 8.9, 10.15]], layer=[7, 8])
-    D.add_polygon([[3, 4, 5], [1.7, 8.9, 10.15]], layer=[7, 9])
+    poly = D.add_polygon([[3, 4, 5], [1.7, 8.9, 10.15]], layer=[7, 9])
+    poly.properties[0] = "start"
+    poly.properties[2**16 - 1] = "end"  # max allowed key (2 byte unsigned int)
     precision = 1e-4
     unit = 1e-6
     h1 = D.hash_geometry(precision=precision)
     D.write_gds("temp.gds", precision=unit * precision, unit=1e-6)
     Dimport = pg.import_gds("temp.gds", flatten=False)
     h2 = Dimport.hash_geometry(precision=precision)
     assert h1 == h2
+    assert Dimport.polygons[-1].properties == poly.properties
+    assert Dimport.references[0].properties == ref.properties
 
 
 def test_packer():
     np.random.seed(5)
     D_list = [
         pg.ellipse(radii=np.random.rand(2) * n + 2).move(np.random.rand(2) * 100 + 2)
         for n in range(50)
```

### Comparing `phidl-1.7.0/tests/test_path.py` & `phidl-1.7.1/tests/test_path.py`

 * *Files identical despite different names*

### Comparing `phidl-1.7.0/tests/test_routing.py` & `phidl-1.7.1/tests/test_routing.py`

 * *Files identical despite different names*

